{"version":3,"file":"chessboard.cjs.js","sources":["../src/constants/positions.js","../src/errors/messages.js","../src/errors/ChessboardError.js","../src/services/ValidationService.js","../src/core/ChessboardConfig.js","../src/components/Piece.js","../src/components/Square.js","../src/components/Move.js","../src/services/AnimationService.js","../src/services/BoardService.js","../src/services/CoordinateService.js","../src/utils/performance.js","../src/utils/cross-browser.js","../src/utils/logger.js","../src/services/EventService.js","../src/services/MoveService.js","../src/services/PieceService.js","../src/utils/chess.js","../src/services/PositionService.js","../src/core/Chessboard.js","../src/core/ChessboardFactory.js","../src/core/index.js","../src/utils/coordinates.js","../src/utils/validation.js","../src/utils/animations.js","../src/index.js"],"sourcesContent":["/**\n * Standard chess positions and FEN constants\n * @module constants/positions\n * @since 2.0.0\n */\n\n/**\n * Standard chess positions used throughout the application\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const STANDARD_POSITIONS = {\n    'start': 'start',\n    'default': 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',\n    'empty': '8/8/8/8/8/8/8/8 w - - 0 1'\n};\n\n/**\n * Default starting position FEN string\n * @type {string}\n * @readonly\n */\nexport const DEFAULT_STARTING_POSITION = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';\n\n/**\n * Chess piece types\n * @type {string[]}\n * @readonly\n */\nexport const PIECE_TYPES = ['p', 'r', 'n', 'b', 'q', 'k'];\n\n/**\n * Chess piece colors\n * @type {string[]}\n * @readonly\n */\nexport const PIECE_COLORS = ['w', 'b'];\n\n/**\n * Valid promotion pieces\n * @type {string[]}\n * @readonly\n */\nexport const PROMOTION_PIECES = ['q', 'r', 'b', 'n'];\n\n/**\n * Board coordinates letters\n * @type {string}\n * @readonly\n */\nexport const BOARD_LETTERS = 'abcdefgh';\n\n/**\n * Board size constants\n * @type {Object}\n * @readonly\n */\nexport const BOARD_SIZE = {\n    ROWS: 8,\n    COLS: 8,\n    TOTAL_SQUARES: 64\n};\n","/**\n * Error messages and error handling utilities\n * @module errors/messages\n * @since 2.0.0\n */\n\n/**\n * Error codes for categorizing different types of errors\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const ERROR_CODES = Object.freeze({\n    VALIDATION_ERROR: 'VALIDATION_ERROR',\n    CONFIG_ERROR: 'CONFIG_ERROR',\n    MOVE_ERROR: 'MOVE_ERROR',\n    DOM_ERROR: 'DOM_ERROR',\n    ANIMATION_ERROR: 'ANIMATION_ERROR',\n    PIECE_ERROR: 'PIECE_ERROR',\n    INITIALIZATION_ERROR: 'INITIALIZATION_ERROR',\n    POSITION_ERROR: 'POSITION_ERROR',\n    FEN_ERROR: 'FEN_ERROR',\n    SQUARE_ERROR: 'SQUARE_ERROR',\n    THEME_ERROR: 'THEME_ERROR',\n    NETWORK_ERROR: 'NETWORK_ERROR'\n});\n\n/**\n * Standardized error messages for the chessboard application\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const ERROR_MESSAGES = Object.freeze({\n    // Position and FEN related\n    invalid_position: 'Invalid position: ',\n    invalid_fen: 'Invalid FEN string: ',\n    position_load_failed: 'Failed to load position: ',\n    \n    // DOM and UI related\n    invalid_id_div: 'Board container not found: ',\n    invalid_value: 'Invalid value: ',\n    dom_operation_failed: 'DOM operation failed: ',\n    element_not_found: 'Element not found: ',\n    \n    // Piece related\n    invalid_piece: 'Invalid piece notation: ',\n    invalid_square: 'Invalid square notation: ',\n    invalid_piecesPath: 'Invalid pieces path: ',\n    piece_operation_failed: 'Piece operation failed: ',\n    \n    // Board configuration\n    invalid_orientation: 'Invalid orientation: ',\n    invalid_color: 'Invalid color: ',\n    invalid_mode: 'Invalid mode: ',\n    invalid_dropOffBoard: 'Invalid dropOffBoard setting: ',\n    invalid_size: 'Invalid size: ',\n    invalid_movableColors: 'Invalid movableColors setting: ',\n    \n    // Animation related\n    invalid_snapbackTime: 'Invalid snapbackTime: ',\n    invalid_snapbackAnimation: 'Invalid snapbackAnimation: ',\n    invalid_fadeTime: 'Invalid fadeTime: ',\n    invalid_fadeAnimation: 'Invalid fadeAnimation: ',\n    invalid_ratio: 'Invalid ratio: ',\n    invalid_animationStyle: 'Invalid animationStyle: ',\n    animation_failed: 'Animation failed: ',\n    \n    // Event handlers\n    invalid_onMove: 'Invalid onMove callback: ',\n    invalid_onMoveEnd: 'Invalid onMoveEnd callback: ',\n    invalid_onChange: 'Invalid onChange callback: ',\n    invalid_onDragStart: 'Invalid onDragStart callback: ',\n    invalid_onDragMove: 'Invalid onDragMove callback: ',\n    invalid_onDrop: 'Invalid onDrop callback: ',\n    invalid_onSnapbackEnd: 'Invalid onSnapbackEnd callback: ',\n    callback_execution_failed: 'Callback execution failed: ',\n    \n    // Visual styling\n    invalid_whiteSquare: 'Invalid whiteSquare color: ',\n    invalid_blackSquare: 'Invalid blackSquare color: ',\n    invalid_highlight: 'Invalid highlight color: ',\n    invalid_selectedSquareWhite: 'Invalid selectedSquareWhite color: ',\n    invalid_selectedSquareBlack: 'Invalid selectedSquareBlack color: ',\n    invalid_movedSquareWhite: 'Invalid movedSquareWhite color: ',\n    invalid_movedSquareBlack: 'Invalid movedSquareBlack color: ',\n    invalid_choiceSquare: 'Invalid choiceSquare color: ',\n    invalid_coverSquare: 'Invalid coverSquare color: ',\n    invalid_hintColor: 'Invalid hintColor: ',\n    \n    // Move related\n    invalid_move: 'Invalid move: ',\n    invalid_move_format: 'Invalid move format: ',\n    move_execution_failed: 'Move execution failed: ',\n    illegal_move: 'Illegal move: ',\n    square_no_piece: 'No piece found on square: ',\n    move_validation_failed: 'Move validation failed: ',\n    \n    // Game state\n    game_over: 'Game is over',\n    invalid_turn: 'Invalid turn: ',\n    position_validation_failed: 'Position validation failed: ',\n    \n    // Theme and assets\n    theme_load_failed: 'Theme loading failed: ',\n    asset_load_failed: 'Asset loading failed: ',\n    invalid_theme: 'Invalid theme: ',\n    \n    // Network and resources\n    network_error: 'Network error: ',\n    resource_not_found: 'Resource not found: ',\n    timeout_error: 'Operation timed out: ',\n    \n    // General errors\n    initialization_failed: 'Initialization failed: ',\n    operation_failed: 'Operation failed: ',\n    invalid_state: 'Invalid state: ',\n    memory_limit_exceeded: 'Memory limit exceeded',\n    performance_degraded: 'Performance degraded: '\n});\n\n/**\n * Error severity levels\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const ERROR_SEVERITY = Object.freeze({\n    LOW: 'LOW',\n    MEDIUM: 'MEDIUM',\n    HIGH: 'HIGH',\n    CRITICAL: 'CRITICAL'\n});\n\n/**\n * Maps error codes to their severity levels\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const ERROR_SEVERITY_MAP = Object.freeze({\n    [ERROR_CODES.VALIDATION_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.CONFIG_ERROR]: ERROR_SEVERITY.HIGH,\n    [ERROR_CODES.MOVE_ERROR]: ERROR_SEVERITY.LOW,\n    [ERROR_CODES.DOM_ERROR]: ERROR_SEVERITY.HIGH,\n    [ERROR_CODES.ANIMATION_ERROR]: ERROR_SEVERITY.LOW,\n    [ERROR_CODES.PIECE_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.INITIALIZATION_ERROR]: ERROR_SEVERITY.CRITICAL,\n    [ERROR_CODES.POSITION_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.FEN_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.SQUARE_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.THEME_ERROR]: ERROR_SEVERITY.LOW,\n    [ERROR_CODES.NETWORK_ERROR]: ERROR_SEVERITY.MEDIUM\n});\n\n/**\n * Utility function to get error severity\n * @param {string} errorCode - Error code\n * @returns {string} Error severity level\n */\nexport function getErrorSeverity(errorCode) {\n    return ERROR_SEVERITY_MAP[errorCode] || ERROR_SEVERITY.MEDIUM;\n}\n\n/**\n * Utility function to format error message\n * @param {string} messageKey - Message key from ERROR_MESSAGES\n * @param {string} [details] - Additional details\n * @returns {string} Formatted error message\n */\nexport function formatErrorMessage(messageKey, details = '') {\n    const message = ERROR_MESSAGES[messageKey];\n    if (!message) {\n        return `Unknown error: ${messageKey}${details ? ` - ${details}` : ''}`;\n    }\n    return `${message}${details}`;\n}\n\n/**\n * Utility function to create error context\n * @param {string} operation - Operation that failed\n * @param {Object} [data] - Additional context data\n * @returns {Object} Error context object\n */\nexport function createErrorContext(operation, data = {}) {\n    return {\n        operation,\n        timestamp: new Date().toISOString(),\n        userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'Unknown',\n        url: typeof window !== 'undefined' ? window.location.href : 'Unknown',\n        ...data\n    };\n}\n","/**\n * Custom error classes for better error handling\n * @module errors/ChessboardError\n * @since 2.0.0\n */\n\nimport { ERROR_CODES } from './messages.js';\n\n/**\n * Base error class for all chessboard-related errors\n * @class\n * @extends Error\n */\nexport class ChessboardError extends Error {\n    /**\n     * Creates a new ChessboardError instance\n     * @param {string} message - Error message\n     * @param {string} code - Error code from ERROR_CODES\n     * @param {Object} [context={}] - Additional context information\n     */\n    constructor(message, code, context = {}) {\n        super(message);\n        this.name = 'ChessboardError';\n        this.code = code;\n        this.context = context;\n        this.timestamp = new Date().toISOString();\n        \n        // Maintain stack trace for debugging\n        if (Error.captureStackTrace) {\n            Error.captureStackTrace(this, ChessboardError);\n        }\n    }\n}\n\n/**\n * Error thrown when validation fails\n * @class\n * @extends ChessboardError\n */\nexport class ValidationError extends ChessboardError {\n    /**\n     * Creates a new ValidationError instance\n     * @param {string} message - Error message\n     * @param {string} field - Field that failed validation\n     * @param {*} value - Value that failed validation\n     */\n    constructor(message, field, value) {\n        super(message, ERROR_CODES.VALIDATION_ERROR, { field, value });\n        this.name = 'ValidationError';\n        this.field = field;\n        this.value = value;\n    }\n}\n\n/**\n * Error thrown when configuration is invalid\n * @class\n * @extends ChessboardError\n */\nexport class ConfigurationError extends ChessboardError {\n    /**\n     * Creates a new ConfigurationError instance\n     * @param {string} message - Error message\n     * @param {string} configKey - Configuration key that is invalid\n     * @param {*} configValue - Configuration value that is invalid\n     */\n    constructor(message, configKey, configValue) {\n        super(message, ERROR_CODES.CONFIG_ERROR, { configKey, configValue });\n        this.name = 'ConfigurationError';\n        this.configKey = configKey;\n        this.configValue = configValue;\n    }\n}\n\n/**\n * Error thrown when a move is invalid or fails\n * @class\n * @extends ChessboardError\n */\nexport class MoveError extends ChessboardError {\n    /**\n     * Creates a new MoveError instance\n     * @param {string} message - Error message\n     * @param {string} from - Source square\n     * @param {string} to - Target square\n     * @param {string} [piece] - Piece being moved\n     */\n    constructor(message, from, to, piece) {\n        super(message, ERROR_CODES.MOVE_ERROR, { from, to, piece });\n        this.name = 'MoveError';\n        this.from = from;\n        this.to = to;\n        this.piece = piece;\n    }\n}\n\n/**\n * Error thrown when DOM operations fail\n * @class\n * @extends ChessboardError\n */\nexport class DOMError extends ChessboardError {\n    /**\n     * Creates a new DOMError instance\n     * @param {string} message - Error message\n     * @param {string} elementId - Element ID that caused the error\n     */\n    constructor(message, elementId) {\n        super(message, ERROR_CODES.DOM_ERROR, { elementId });\n        this.name = 'DOMError';\n        this.elementId = elementId;\n    }\n}\n\n/**\n * Error thrown when piece operations fail\n * @class\n * @extends ChessboardError\n */\nexport class PieceError extends ChessboardError {\n    /**\n     * Creates a new PieceError instance\n     * @param {string} message - Error message\n     * @param {string} pieceId - Piece ID that caused the error\n     * @param {string} [square] - Square where the error occurred\n     */\n    constructor(message, pieceId, square) {\n        super(message, ERROR_CODES.PIECE_ERROR, { pieceId, square });\n        this.name = 'PieceError';\n        this.pieceId = pieceId;\n        this.square = square;\n    }\n}\n","/**\n * Service for input validation and data sanitization\n * @module services/ValidationService\n * @since 2.0.0\n */\n\nimport { PIECE_TYPES, PIECE_COLORS } from '../constants/positions.js';\nimport { ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\n\n/**\n * Validation patterns compiled for performance\n * @constant\n * @type {Object}\n */\nconst VALIDATION_PATTERNS = Object.freeze({\n    square: /^[a-h][1-8]$/,\n    piece: /^[prnbqkPRNBQK][wb]$/,\n    fen: /^([rnbqkpRNBQKP1-8]+\\/){7}[rnbqkpRNBQKP1-8]+\\s[wb]\\s[KQkq-]+\\s[a-h1-8-]+\\s\\d+\\s\\d+$/,\n    move: /^[a-h][1-8][a-h][1-8][qrnb]?$/,\n    color: /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/\n});\n\n/**\n * Valid values for various configuration options\n * @constant\n * @type {Object}\n */\nconst VALID_VALUES = Object.freeze({\n    orientations: ['w', 'b', 'white', 'black'],\n    colors: ['w', 'b', 'white', 'black'],\n    movableColors: ['w', 'b', 'white', 'black', 'both', 'none'],\n    dropOffBoard: ['snapback', 'trash'],\n    easingTypes: ['linear', 'ease', 'ease-in', 'ease-out', 'ease-in-out'],\n    animationStyles: ['sequential', 'simultaneous'],\n    modes: ['normal', 'creative', 'analysis'],\n    promotionPieces: ['q', 'r', 'b', 'n', 'Q', 'R', 'B', 'N']\n});\n\n/**\n * Size constraints for validation\n * @constant\n * @type {Object}\n */\nconst SIZE_CONSTRAINTS = Object.freeze({\n    min: 50,\n    max: 2000,\n    maxTime: 10000,\n    maxDelay: 5000\n});\n\n/**\n * Service responsible for validating inputs and data\n * Implements caching for performance optimization\n * @class\n */\nexport class ValidationService {\n    /**\n     * Creates a new ValidationService instance\n     */\n    constructor() {\n        // Cache for validation results to improve performance\n        this._validationCache = new Map();\n        this._cacheMaxSize = 1000;\n        \n        // Compile patterns for reuse\n        this._patterns = VALIDATION_PATTERNS;\n        this._validValues = VALID_VALUES;\n        this._constraints = SIZE_CONSTRAINTS;\n    }\n\n    /**\n     * Validates a square identifier with caching\n     * @param {string} square - Square to validate (e.g., 'e4')\n     * @returns {boolean} True if valid\n     */\n    isValidSquare(square) {\n        const cacheKey = `square:${square}`;\n        \n        if (this._validationCache.has(cacheKey)) {\n            return this._validationCache.get(cacheKey);\n        }\n        \n        const isValid = typeof square === 'string' && \n                        square.length === 2 && \n                        this._patterns.square.test(square);\n        \n        this._cacheValidationResult(cacheKey, isValid);\n        return isValid;\n    }\n\n    /**\n     * Validates a piece identifier with enhanced format support\n     * @param {string} piece - Piece to validate (e.g., 'wK', 'bp')\n     * @returns {boolean} True if valid\n     */\n    isValidPiece(piece) {\n        if (typeof piece !== 'string' || piece.length !== 2) {\n            return false;\n        }\n        \n        const cacheKey = `piece:${piece}`;\n        \n        if (this._validationCache.has(cacheKey)) {\n            return this._validationCache.get(cacheKey);\n        }\n        \n        const [first, second] = piece.split('');\n        \n        // Check both formats: [type][color] and [color][type]\n        const format1 = PIECE_TYPES.includes(first.toLowerCase()) && \n                       PIECE_COLORS.includes(second);\n        const format2 = PIECE_COLORS.includes(first) && \n                       PIECE_TYPES.includes(second.toLowerCase());\n        \n        const isValid = format1 || format2;\n        this._cacheValidationResult(cacheKey, isValid);\n        return isValid;\n    }\n\n    /**\n     * Validates a FEN string with comprehensive checks\n     * @param {string} fen - FEN string to validate\n     * @returns {boolean} True if valid\n     */\n    isValidFen(fen) {\n        if (typeof fen !== 'string') {\n            return false;\n        }\n        \n        const cacheKey = `fen:${fen}`;\n        \n        if (this._validationCache.has(cacheKey)) {\n            return this._validationCache.get(cacheKey);\n        }\n        \n        // Basic pattern check\n        if (!this._patterns.fen.test(fen)) {\n            this._cacheValidationResult(cacheKey, false);\n            return false;\n        }\n        \n        // Additional FEN validation\n        const isValid = this._validateFenStructure(fen);\n        this._cacheValidationResult(cacheKey, isValid);\n        return isValid;\n    }\n\n    /**\n     * Validates FEN structure in detail\n     * @private\n     * @param {string} fen - FEN string to validate\n     * @returns {boolean} True if valid\n     */\n    _validateFenStructure(fen) {\n        const parts = fen.split(' ');\n        \n        if (parts.length !== 6) {\n            return false;\n        }\n        \n        // Validate piece placement\n        const ranks = parts[0].split('/');\n        if (ranks.length !== 8) {\n            return false;\n        }\n        \n        // Validate each rank\n        for (const rank of ranks) {\n            if (!this._validateRank(rank)) {\n                return false;\n            }\n        }\n        \n        // Validate active color\n        if (!['w', 'b'].includes(parts[1])) {\n            return false;\n        }\n        \n        // Validate castling rights\n        if (!/^[KQkq-]*$/.test(parts[2])) {\n            return false;\n        }\n        \n        // Validate en passant target\n        if (parts[3] !== '-' && !this.isValidSquare(parts[3])) {\n            return false;\n        }\n        \n        // Validate halfmove clock and fullmove number\n        const halfmove = parseInt(parts[4], 10);\n        const fullmove = parseInt(parts[5], 10);\n        \n        return !isNaN(halfmove) && !isNaN(fullmove) && \n               halfmove >= 0 && fullmove >= 1;\n    }\n\n    /**\n     * Validates a single rank in FEN notation\n     * @private\n     * @param {string} rank - Rank to validate\n     * @returns {boolean} True if valid\n     */\n    _validateRank(rank) {\n        let squares = 0;\n        \n        for (let i = 0; i < rank.length; i++) {\n            const char = rank[i];\n            \n            if (/[1-8]/.test(char)) {\n                squares += parseInt(char, 10);\n            } else if (/[prnbqkPRNBQK]/.test(char)) {\n                squares += 1;\n            } else {\n                return false;\n            }\n        }\n        \n        return squares === 8;\n    }\n\n    /**\n     * Validates a move string with comprehensive format support\n     * @param {string} move - Move string to validate (e.g., 'e2e4', 'e7e8q')\n     * @returns {boolean} True if valid\n     */\n    isValidMove(move) {\n        if (typeof move !== 'string') {\n            return false;\n        }\n        \n        const cacheKey = `move:${move}`;\n        \n        if (this._validationCache.has(cacheKey)) {\n            return this._validationCache.get(cacheKey);\n        }\n        \n        const isValid = this._validateMoveFormat(move);\n        this._cacheValidationResult(cacheKey, isValid);\n        return isValid;\n    }\n\n    /**\n     * Validates move format in detail\n     * @private\n     * @param {string} move - Move string to validate\n     * @returns {boolean} True if valid\n     */\n    _validateMoveFormat(move) {\n        if (move.length < 4 || move.length > 5) {\n            return false;\n        }\n        \n        const from = move.slice(0, 2);\n        const to = move.slice(2, 4);\n        const promotion = move.slice(4, 5);\n        \n        if (!this.isValidSquare(from) || !this.isValidSquare(to)) {\n            return false;\n        }\n        \n        if (promotion && !this._validValues.promotionPieces.includes(promotion)) {\n            return false;\n        }\n        \n        // Additional move validation (e.g., source and target different)\n        return from !== to;\n    }\n\n    /**\n     * Validates board orientation\n     * @param {string} orientation - Orientation to validate\n     * @returns {boolean} True if valid\n     */\n    isValidOrientation(orientation) {\n        return this._validValues.orientations.includes(orientation);\n    }\n\n    /**\n     * Validates a color value\n     * @param {string} color - Color to validate\n     * @returns {boolean} True if valid\n     */\n    isValidColor(color) {\n        return this._validValues.colors.includes(color);\n    }\n\n    /**\n     * Validates a size value with constraints\n     * @param {number|string} size - Size to validate\n     * @returns {boolean} True if valid\n     */\n    isValidSize(size) {\n        if (size === 'auto') {\n            return true;\n        }\n        \n        if (typeof size === 'number') {\n            return size >= this._constraints.min && size <= this._constraints.max;\n        }\n        \n        return false;\n    }\n\n    /**\n     * Validates a time value with constraints\n     * @param {number} time - Time value to validate\n     * @returns {boolean} True if valid\n     */\n    isValidTime(time) {\n        return typeof time === 'number' && \n               time >= 0 && \n               time <= this._constraints.maxTime;\n    }\n\n    /**\n     * Validates a callback function\n     * @param {Function} callback - Callback to validate\n     * @returns {boolean} True if valid\n     */\n    isValidCallback(callback) {\n        return typeof callback === 'function';\n    }\n\n    /**\n     * Validates a DOM element ID\n     * @param {string} id - Element ID to validate\n     * @returns {boolean} True if valid\n     */\n    isValidElementId(id) {\n        return typeof id === 'string' && \n               id.length > 0 && \n               id.length <= 100 && // Reasonable length limit\n               /^[a-zA-Z][\\w:-]*$/.test(id); // Valid HTML ID format\n    }\n\n    /**\n     * Validates movable colors configuration\n     * @param {string} colors - Colors value to validate\n     * @returns {boolean} True if valid\n     */\n    isValidMovableColors(colors) {\n        return this._validValues.movableColors.includes(colors);\n    }\n\n    /**\n     * Validates drop off board configuration\n     * @param {string} dropOff - Drop off board value to validate\n     * @returns {boolean} True if valid\n     */\n    isValidDropOffBoard(dropOff) {\n        return this._validValues.dropOffBoard.includes(dropOff);\n    }\n\n    /**\n     * Validates animation easing type\n     * @param {string} easing - Easing type to validate\n     * @returns {boolean} True if valid\n     */\n    isValidEasing(easing) {\n        return this._validValues.easingTypes.includes(easing);\n    }\n\n    /**\n     * Validates animation style\n     * @param {string} style - Animation style to validate\n     * @returns {boolean} True if valid\n     */\n    isValidAnimationStyle(style) {\n        return this._validValues.animationStyles.includes(style);\n    }\n\n    /**\n     * Validates CSS color format\n     * @param {string} color - Color string to validate\n     * @returns {boolean} True if valid\n     */\n    isValidCSSColor(color) {\n        if (typeof color !== 'string') {\n            return false;\n        }\n        \n        // Check for hex colors\n        if (this._patterns.color.test(color)) {\n            return true;\n        }\n        \n        // Check for named colors (basic set)\n        const namedColors = ['white', 'black', 'red', 'green', 'blue', 'yellow', 'cyan', 'magenta'];\n        if (namedColors.includes(color.toLowerCase())) {\n            return true;\n        }\n        \n        // Check for rgb/rgba format\n        if (/^rgb\\(\\s*\\d+\\s*,\\s*\\d+\\s*,\\s*\\d+\\s*\\)$/.test(color) ||\n            /^rgba\\(\\s*\\d+\\s*,\\s*\\d+\\s*,\\s*\\d+\\s*,\\s*[0-1](\\.\\d+)?\\s*\\)$/.test(color)) {\n            return true;\n        }\n        \n        return false;\n    }\n\n    /**\n     * Validates and sanitizes a square identifier\n     * @param {string} square - Square to validate\n     * @returns {string} Sanitized square\n     * @throws {ValidationError} If square is invalid\n     */\n    validateSquare(square) {\n        if (!this.isValidSquare(square)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_square + square, \n                'square', \n                square\n            );\n        }\n        return square.toLowerCase();\n    }\n\n    /**\n     * Validates and sanitizes a piece identifier\n     * @param {string} piece - Piece to validate\n     * @returns {string} Sanitized piece\n     * @throws {ValidationError} If piece is invalid\n     */\n    validatePiece(piece) {\n        if (!this.isValidPiece(piece)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_piece + piece, \n                'piece', \n                piece\n            );\n        }\n        return piece.toLowerCase();\n    }\n\n    /**\n     * Validates and sanitizes a FEN string\n     * @param {string} fen - FEN to validate\n     * @returns {string} Sanitized FEN\n     * @throws {ValidationError} If FEN is invalid\n     */\n    validateFen(fen) {\n        if (!this.isValidFen(fen)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_fen + fen, \n                'fen', \n                fen\n            );\n        }\n        return fen.trim();\n    }\n\n    /**\n     * Validates and sanitizes a move string\n     * @param {string} move - Move to validate\n     * @returns {string} Sanitized move\n     * @throws {ValidationError} If move is invalid\n     */\n    validateMove(move) {\n        if (!this.isValidMove(move)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_move + move, \n                'move', \n                move\n            );\n        }\n        return move.toLowerCase();\n    }\n\n    /**\n     * Validates and sanitizes orientation\n     * @param {string} orientation - Orientation to validate\n     * @returns {string} Sanitized orientation ('w' or 'b')\n     * @throws {ValidationError} If orientation is invalid\n     */\n    validateOrientation(orientation) {\n        if (!this.isValidOrientation(orientation)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_orientation + orientation, \n                'orientation', \n                orientation\n            );\n        }\n        \n        // Normalize to 'w' or 'b'\n        return orientation === 'white' ? 'w' : \n               orientation === 'black' ? 'b' : \n               orientation;\n    }\n\n    /**\n     * Validates and sanitizes color\n     * @param {string} color - Color to validate\n     * @returns {string} Sanitized color ('w' or 'b')\n     * @throws {ValidationError} If color is invalid\n     */\n    validateColor(color) {\n        if (!this.isValidColor(color)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_color + color, \n                'color', \n                color\n            );\n        }\n        \n        // Normalize to 'w' or 'b'\n        return color === 'white' ? 'w' : \n               color === 'black' ? 'b' : \n               color;\n    }\n\n    /**\n     * Validates and sanitizes size\n     * @param {number|string} size - Size to validate\n     * @returns {number|string} Sanitized size\n     * @throws {ValidationError} If size is invalid\n     */\n    validateSize(size) {\n        if (!this.isValidSize(size)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_size + size, \n                'size', \n                size\n            );\n        }\n        return size;\n    }\n\n    /**\n     * Validates configuration object with comprehensive checks\n     * @param {Object} config - Configuration to validate\n     * @returns {Object} Validated configuration\n     * @throws {ValidationError} If configuration is invalid\n     */\n    validateConfig(config) {\n        if (!config || typeof config !== 'object') {\n            throw new ValidationError(\n                'Configuration must be an object', \n                'config', \n                config\n            );\n        }\n        \n        const errors = [];\n        \n        // Validate required fields\n        if (!config.id && !config.id_div) {\n            errors.push('Configuration must include id or id_div');\n        }\n        \n        // Validate optional fields\n        if (config.orientation && !this.isValidOrientation(config.orientation)) {\n            errors.push(ERROR_MESSAGES.invalid_orientation + config.orientation);\n        }\n        \n        if (config.size && !this.isValidSize(config.size)) {\n            errors.push(ERROR_MESSAGES.invalid_size + config.size);\n        }\n        \n        if (config.movableColors && !this.isValidMovableColors(config.movableColors)) {\n            errors.push(ERROR_MESSAGES.invalid_color + config.movableColors);\n        }\n        \n        if (config.dropOffBoard && !this.isValidDropOffBoard(config.dropOffBoard)) {\n            errors.push(ERROR_MESSAGES.invalid_dropOffBoard + config.dropOffBoard);\n        }\n        \n        if (config.animationStyle && !this.isValidAnimationStyle(config.animationStyle)) {\n            errors.push(ERROR_MESSAGES.invalid_animationStyle + config.animationStyle);\n        }\n        \n        // Validate callbacks\n        const callbacks = ['onMove', 'onMoveEnd', 'onChange', 'onDragStart', 'onDragMove', 'onDrop', 'onSnapbackEnd'];\n        for (const callback of callbacks) {\n            if (config[callback] && !this.isValidCallback(config[callback])) {\n                errors.push(`Invalid ${callback} callback`);\n            }\n        }\n        \n        // Validate colors\n        const colorFields = ['whiteSquare', 'blackSquare', 'highlight', 'hintColor'];\n        for (const field of colorFields) {\n            if (config[field] && !this.isValidCSSColor(config[field])) {\n                errors.push(`Invalid ${field} color: ${config[field]}`);\n            }\n        }\n        \n        if (errors.length > 0) {\n            throw new ValidationError(\n                `Configuration validation failed: ${errors.join(', ')}`, \n                'config', \n                config\n            );\n        }\n        \n        return config;\n    }\n\n    /**\n     * Caches validation result for performance\n     * @private\n     * @param {string} key - Cache key\n     * @param {boolean} result - Validation result\n     */\n    _cacheValidationResult(key, result) {\n        if (this._validationCache.size >= this._cacheMaxSize) {\n            // Remove oldest entry\n            const firstKey = this._validationCache.keys().next().value;\n            this._validationCache.delete(firstKey);\n        }\n        \n        this._validationCache.set(key, result);\n    }\n\n    /**\n     * Clears the validation cache\n     */\n    clearCache() {\n        this._validationCache.clear();\n    }\n\n    /**\n     * Gets validation cache statistics\n     * @returns {Object} Cache statistics\n     */\n    getCacheStats() {\n        return {\n            size: this._validationCache.size,\n            maxSize: this._cacheMaxSize,\n            hitRate: this._cacheHits / (this._cacheHits + this._cacheMisses) || 0\n        };\n    }\n\n    /**\n     * Batch validates multiple values\n     * @param {Array} validations - Array of validation objects\n     * @returns {Array} Array of validation results\n     */\n    batchValidate(validations) {\n        return validations.map(validation => {\n            try {\n                const { type, value } = validation;\n                \n                switch (type) {\n                    case 'square':\n                        return { valid: this.isValidSquare(value), value };\n                    case 'piece':\n                        return { valid: this.isValidPiece(value), value };\n                    case 'fen':\n                        return { valid: this.isValidFen(value), value };\n                    case 'move':\n                        return { valid: this.isValidMove(value), value };\n                    default:\n                        return { valid: false, value, error: 'Unknown validation type' };\n                }\n            } catch (error) {\n                return { valid: false, value: validation.value, error: error.message };\n            }\n        });\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        this.clearCache();\n        this._validationCache = null;\n        this._patterns = null;\n        this._validValues = null;\n        this._constraints = null;\n    }\n}\n","/**\n * Configuration management for Chessboard.js\n * @module core/ChessboardConfig\n * @since 2.0.0\n */\n\nimport { ValidationService } from '../services/ValidationService.js';\nimport { ConfigurationError } from '../errors/ChessboardError.js';\n\n/**\n * Animation timing constants\n * @constant\n * @type {Object}\n */\nconst ANIMATION_TIMES = Object.freeze({\n    fast: 200,\n    slow: 600,\n    normal: 400,\n    verySlow: 1000,\n    veryFast: 100\n});\n\n/**\n * Boolean value mappings\n * @constant\n * @type {Object}\n */\nconst BOOLEAN_VALUES = Object.freeze({\n    true: true,\n    false: false,\n    none: false,\n    1: true,\n    0: false\n});\n\n/**\n * CSS transition functions\n * @constant\n * @type {Object}\n */\nconst TRANSITION_FUNCTIONS = Object.freeze({\n    ease: 'ease',\n    linear: 'linear',\n    'ease-in': 'ease-in',\n    'ease-out': 'ease-out',\n    'ease-in-out': 'ease-in-out',\n    none: null\n});\n\n/**\n * Default configuration values\n * @constant\n * @type {Object}\n */\nconst DEFAULT_CONFIG = Object.freeze({\n    id: 'board',\n    position: 'start',\n    orientation: 'w',\n    mode: 'normal',\n    size: 'auto',\n    draggable: true,\n    hints: true,\n    clickable: true,\n    movableColors: 'both',\n    moveHighlight: true,\n    overHighlight: true,\n    moveAnimation: 'ease',\n    moveTime: 'fast',\n    dropOffBoard: 'snapback',\n    snapbackTime: 'fast',\n    snapbackAnimation: 'ease',\n    dropCenterTime: 'veryFast',\n    dropCenterAnimation: 'ease',\n    fadeTime: 'fast',\n    fadeAnimation: 'ease',\n    ratio: 0.9,\n    piecesPath: '../assets/themes/default',\n    animationStyle: 'simultaneous',\n    simultaneousAnimationDelay: 100,\n    onMove: () => true,\n    onMoveEnd: () => true,\n    onChange: () => true,\n    onDragStart: () => true,\n    onDragMove: () => true,\n    onDrop: () => true,\n    onSnapbackEnd: () => true,\n    whiteSquare: '#f0d9b5',\n    blackSquare: '#b58863',\n    highlight: 'yellow',\n    selectedSquareWhite: '#ababaa',\n    selectedSquareBlack: '#ababaa',\n    movedSquareWhite: '#f1f1a0',\n    movedSquareBlack: '#e9e981',\n    choiceSquare: 'white',\n    coverSquare: 'black',\n    hintColor: '#ababaa'\n});\n\n/**\n * Configuration management class for Chessboard.js\n * Handles validation, normalization, and CSS property management\n * @class\n */\nclass ChessboardConfig {\n    /**\n     * Creates a new ChessboardConfig instance\n     * @param {Object} settings - User-provided configuration\n     * @throws {ConfigurationError} If configuration is invalid\n     */\n    constructor(settings = {}) {\n        // Initialize validation service\n        this._validationService = new ValidationService();\n\n        // Validate input\n        this._validateInput(settings);\n\n        // Merge with defaults\n        const config = this._mergeWithDefaults(settings);\n\n        // Process and validate configuration\n        this._processConfiguration(config);\n\n        // Set CSS properties\n        this._setCSSProperties(config);\n\n        // Configure mode-specific settings\n        this._configureModeSettings();\n    }\n\n    /**\n     * Validates input configuration\n     * @private\n     * @param {Object} settings - Input settings\n     * @throws {ConfigurationError} If input is invalid\n     */\n    _validateInput(settings) {\n        if (settings !== null && typeof settings !== 'object') {\n            throw new ConfigurationError('Settings must be an object', 'settings', settings);\n        }\n\n        // Validate using validation service\n        try {\n            this._validationService.validateConfig(settings);\n        } catch (error) {\n            throw new ConfigurationError(error.message, error.field, error.value);\n        }\n    }\n\n    /**\n     * Merges user settings with defaults\n     * @private\n     * @param {Object} settings - User settings\n     * @returns {Object} Merged configuration\n     */\n    _mergeWithDefaults(settings) {\n        return Object.assign({}, DEFAULT_CONFIG, settings);\n    }\n\n    /**\n     * Processes and validates configuration values\n     * @private\n     * @param {Object} config - Configuration object\n     */\n    _processConfiguration(config) {\n        // Basic properties\n        this.id_div = config.id;\n        this.position = config.position;\n        this.orientation = config.orientation;\n        this.mode = config.mode;\n        this.dropOffBoard = config.dropOffBoard;\n        this.size = config.size;\n        this.movableColors = config.movableColors;\n        this.piecesPath = config.piecesPath;\n\n        // Event handlers\n        this.onMove = this._validateCallback(config.onMove);\n        this.onMoveEnd = this._validateCallback(config.onMoveEnd);\n        this.onChange = this._validateCallback(config.onChange);\n        this.onDragStart = this._validateCallback(config.onDragStart);\n        this.onDragMove = this._validateCallback(config.onDragMove);\n        this.onDrop = this._validateCallback(config.onDrop);\n        this.onSnapbackEnd = this._validateCallback(config.onSnapbackEnd);\n\n        // Animation properties\n        this.moveAnimation = this._setTransitionFunction(config.moveAnimation);\n        this.snapbackAnimation = this._setTransitionFunction(config.snapbackAnimation);\n        this.dropCenterAnimation = this._setTransitionFunction(config.dropCenterAnimation);\n        this.fadeAnimation = this._setTransitionFunction(config.fadeAnimation);\n\n        // Boolean properties\n        this.hints = this._setBoolean(config.hints);\n        this.clickable = this._setBoolean(config.clickable);\n        this.draggable = this._setBoolean(config.draggable);\n        this.moveHighlight = this._setBoolean(config.moveHighlight);\n        this.overHighlight = this._setBoolean(config.overHighlight);\n\n        // Timing properties\n        this.moveTime = this._setTime(config.moveTime);\n        this.snapbackTime = this._setTime(config.snapbackTime);\n        this.dropCenterTime = this._setTime(config.dropCenterTime);\n        this.fadeTime = this._setTime(config.fadeTime);\n\n        // Animation style properties\n        this.animationStyle = this._validateAnimationStyle(config.animationStyle);\n        this.simultaneousAnimationDelay = this._validateDelay(config.simultaneousAnimationDelay);\n    }\n\n    /**\n     * Sets CSS custom properties\n     * @private\n     * @param {Object} config - Configuration object\n     */\n    _setCSSProperties(config) {\n        const cssProperties = {\n            pieceRatio: config.ratio,\n            whiteSquare: config.whiteSquare,\n            blackSquare: config.blackSquare,\n            highlightSquare: config.highlight,\n            selectedSquareWhite: config.selectedSquareWhite,\n            selectedSquareBlack: config.selectedSquareBlack,\n            movedSquareWhite: config.movedSquareWhite,\n            movedSquareBlack: config.movedSquareBlack,\n            choiceSquare: config.choiceSquare,\n            coverSquare: config.coverSquare,\n            hintColor: config.hintColor\n        };\n\n        Object.entries(cssProperties).forEach(([property, value]) => {\n            this._setCSSProperty(property, value);\n        });\n    }\n\n    /**\n     * Configures mode-specific settings\n     * @private\n     */\n    _configureModeSettings() {\n        switch (this.mode) {\n            case 'creative':\n                this.onlyLegalMoves = false;\n                this.hints = false;\n                break;\n            case 'normal':\n                this.onlyLegalMoves = true;\n                break;\n            default:\n                this.onlyLegalMoves = true;\n        }\n    }\n\n    /**\n     * Validates a callback function\n     * @private\n     * @param {Function} callback - Callback to validate\n     * @returns {Function} Validated callback\n     * @throws {ConfigurationError} If callback is invalid\n     */\n    _validateCallback(callback) {\n        if (!this._validationService.isValidCallback(callback)) {\n            throw new ConfigurationError('Callback must be a function', 'callback', callback);\n        }\n        return callback;\n    }\n\n    /**\n     * Validates animation style\n     * @private\n     * @param {string} style - Animation style\n     * @returns {string} Validated style\n     * @throws {ConfigurationError} If style is invalid\n     */\n    _validateAnimationStyle(style) {\n        if (!this._validationService.isValidAnimationStyle(style)) {\n            throw new ConfigurationError('Invalid animation style', 'animationStyle', style);\n        }\n        return style;\n    }\n\n    /**\n     * Validates animation delay\n     * @private\n     * @param {number} delay - Animation delay\n     * @returns {number} Validated delay\n     * @throws {ConfigurationError} If delay is invalid\n     */\n    _validateDelay(delay) {\n        if (typeof delay !== 'number' || delay < 0 || delay > 5000) {\n            throw new ConfigurationError('Invalid animation delay', 'simultaneousAnimationDelay', delay);\n        }\n        return delay;\n    }\n\n    /**\n     * Sets a CSS custom property\n     * @private\n     * @param {string} property - Property name\n     * @param {string} value - Property value\n     */\n    _setCSSProperty(property, value) {\n        try {\n            if (typeof document !== 'undefined' && document.documentElement) {\n                document.documentElement.style.setProperty(`--${property}`, value);\n            }\n        } catch (error) {\n            console.warn(`Failed to set CSS property ${property}:`, error.message);\n        }\n    }\n\n    /**\n     * Sets orientation with validation\n     * @param {string} orientation - Orientation value\n     * @returns {ChessboardConfig} This instance for chaining\n     * @throws {ConfigurationError} If orientation is invalid\n     */\n    setOrientation(orientation) {\n        const validatedOrientation = this._validationService.validateOrientation(orientation);\n        this.orientation = validatedOrientation;\n        return this;\n    }\n\n    /**\n     * Validates and sets time value\n     * @private\n     * @param {string|number} value - Time value\n     * @returns {number} Validated time value\n     * @throws {ConfigurationError} If time value is invalid\n     */\n    _setTime(value) {\n        if (typeof value === 'number') {\n            if (!this._validationService.isValidTime(value)) {\n                throw new ConfigurationError('Invalid time value', 'time', value);\n            }\n            return value;\n        }\n\n        if (typeof value === 'string' && value in ANIMATION_TIMES) {\n            return ANIMATION_TIMES[value];\n        }\n\n        throw new ConfigurationError('Invalid time value', 'time', value);\n    }\n\n    /**\n     * Validates and sets boolean value\n     * @private\n     * @param {*} value - Boolean value\n     * @returns {boolean} Validated boolean value\n     * @throws {ConfigurationError} If boolean value is invalid\n     */\n    _setBoolean(value) {\n        if (typeof value === 'boolean') {\n            return value;\n        }\n\n        if (value in BOOLEAN_VALUES) {\n            return BOOLEAN_VALUES[value];\n        }\n\n        throw new ConfigurationError('Invalid boolean value', 'boolean', value);\n    }\n\n    /**\n     * Validates and sets transition function\n     * @private\n     * @param {string|boolean|null} value - Transition function value\n     * @returns {string|null} Validated transition function\n     * @throws {ConfigurationError} If transition function is invalid\n     */\n    _setTransitionFunction(value) {\n        // Handle boolean values - true means use default 'ease', false/null means no animation\n        if (typeof value === 'boolean') {\n            return value ? TRANSITION_FUNCTIONS.ease : null;\n        }\n\n        // Handle string values\n        if (typeof value === 'string' && value in TRANSITION_FUNCTIONS) {\n            return TRANSITION_FUNCTIONS[value];\n        }\n\n        // Handle null/undefined\n        if (value === null || value === undefined) {\n            return null;\n        }\n\n        throw new ConfigurationError('Invalid transition function', 'transitionFunction', value);\n    }\n\n    /**\n     * Gets the current configuration as a plain object\n     * @returns {Object} Configuration object\n     */\n    toObject() {\n        return {\n            id_div: this.id_div,\n            position: this.position,\n            orientation: this.orientation,\n            mode: this.mode,\n            size: this.size,\n            draggable: this.draggable,\n            hints: this.hints,\n            clickable: this.clickable,\n            movableColors: this.movableColors,\n            moveHighlight: this.moveHighlight,\n            overHighlight: this.overHighlight,\n            moveAnimation: this.moveAnimation,\n            moveTime: this.moveTime,\n            dropOffBoard: this.dropOffBoard,\n            snapbackTime: this.snapbackTime,\n            snapbackAnimation: this.snapbackAnimation,\n            dropCenterTime: this.dropCenterTime,\n            dropCenterAnimation: this.dropCenterAnimation,\n            fadeTime: this.fadeTime,\n            fadeAnimation: this.fadeAnimation,\n            piecesPath: this.piecesPath,\n            animationStyle: this.animationStyle,\n            simultaneousAnimationDelay: this.simultaneousAnimationDelay,\n            onlyLegalMoves: this.onlyLegalMoves\n        };\n    }\n\n    /**\n     * Updates configuration with new values\n     * @param {Object} updates - Configuration updates\n     * @returns {ChessboardConfig} This instance for chaining\n     * @throws {ConfigurationError} If updates are invalid\n     */\n    update(updates) {\n        if (!updates || typeof updates !== 'object') {\n            throw new ConfigurationError('Updates must be an object', 'updates', updates);\n        }\n\n        // Validate updates\n        this._validationService.validateConfig(updates);\n\n        // Apply updates\n        const newConfig = Object.assign({}, this.toObject(), updates);\n\n        // Re-process configuration\n        this._processConfiguration(newConfig);\n        this._setCSSProperties(newConfig);\n        this._configureModeSettings();\n\n        return this;\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        if (this._validationService) {\n            this._validationService.destroy();\n            this._validationService = null;\n        }\n    }\n}\n\nexport { ChessboardConfig };\nexport default ChessboardConfig;","class Piece {\n  constructor(color, type, src, opacity = 1) {\n    this.color = color;\n    this.type = type;\n    this.id = this.getId();\n    this.src = src;\n    this.element = this.createElement(src, opacity);\n    console.debug(`[Piece] Constructed: ${this.id}`);\n    this.check();\n  }\n\n  getId() {\n    return this.type + this.color;\n  }\n\n  createElement(src, opacity = 1) {\n    const element = document.createElement('img');\n    element.classList.add('piece');\n    element.id = this.id;\n    element.src = src || this.src;\n    element.style.opacity = opacity;\n\n    // Ensure the image loads properly\n    element.onerror = () => {\n      console.warn('Failed to load piece image:', element.src);\n    };\n\n    return element;\n  }\n\n  visible() {\n    if (this.element) {\n      this.element.style.opacity = 1;\n      console.debug(`[Piece] visible: ${this.id}`);\n    }\n  }\n\n  invisible() {\n    if (this.element) {\n      this.element.style.opacity = 0;\n      console.debug(`[Piece] invisible: ${this.id}`);\n    }\n  }\n\n  /**\n   * Updates the piece image source\n   * @param {string} newSrc - New image source\n   */\n  updateSrc(newSrc) {\n    this.src = newSrc;\n    if (this.element) {\n      this.element.src = newSrc;\n    }\n  }\n\n  /**\n   * Transforms the piece to a new type with smooth animation\n   * @param {string} newType - New piece type\n   * @param {string} newSrc - New image source\n   * @param {number} [duration=200] - Animation duration in milliseconds\n   * @param {Function} [callback] - Callback when transformation is complete\n   */\n  transformTo(newType, newSrc, duration = 200, callback = null) {\n    if (!this.element) {\n      console.debug(`[Piece] transformTo: ${this.id} - element is null`);\n      if (callback) callback();\n      return;\n    }\n    const element = this.element;\n\n    // Add transformation class to disable all transitions temporarily\n    element.classList.add('transforming');\n\n    // Create a smooth scale animation for the transformation\n    const scaleDown = [\n      { transform: 'scale(1)', opacity: '1' },\n      { transform: 'scale(0.8)', opacity: '0.7' },\n    ];\n\n    const scaleUp = [\n      { transform: 'scale(0.8)', opacity: '0.7' },\n      { transform: 'scale(1)', opacity: '1' },\n    ];\n\n    const halfDuration = duration / 2;\n\n    // First animation: scale down\n    if (element.animate) {\n      const scaleDownAnimation = element.animate(scaleDown, {\n        duration: halfDuration,\n        easing: 'ease-in',\n        fill: 'forwards',\n      });\n\n      scaleDownAnimation.onfinish = () => {\n        if (!this.element) {\n          console.debug(`[Piece] transformTo.scaleDown.onfinish: ${this.id} - element is null`);\n          if (callback) callback();\n          return;\n        }\n        // Change the piece type and source at the smallest scale\n        this.type = newType;\n        this.id = this.getId();\n        this.src = newSrc;\n        element.src = newSrc;\n        element.id = this.id;\n\n        // Second animation: scale back up\n        const scaleUpAnimation = element.animate(scaleUp, {\n          duration: halfDuration,\n          easing: 'ease-out',\n          fill: 'forwards',\n        });\n\n        scaleUpAnimation.onfinish = () => {\n          if (!this.element) {\n            console.debug(`[Piece] transformTo.scaleUp.onfinish: ${this.id} - element is null`);\n            if (callback) callback();\n            return;\n          }\n          // Reset transform and remove transformation class\n          element.style.transform = '';\n          element.style.opacity = '';\n          element.classList.remove('transforming');\n\n          // Add a subtle bounce effect\n          element.classList.add('transform-complete');\n\n          // Remove bounce class after animation\n          setTimeout(() => {\n            if (!this.element) return;\n            element.classList.remove('transform-complete');\n          }, 400);\n\n          console.debug(`[Piece] transformTo complete: ${this.id}`);\n          if (callback) callback();\n        };\n      };\n    } else {\n      // Fallback for browsers without Web Animations API\n      element.style.transition = `transform ${halfDuration}ms ease-in, opacity ${halfDuration}ms ease-in`;\n      element.style.transform = 'scale(0.8)';\n      element.style.opacity = '0.7';\n\n      setTimeout(() => {\n        if (!this.element) {\n          console.debug(`[Piece] transformTo (fallback): ${this.id} - element is null`);\n          if (callback) callback();\n          return;\n        }\n        // Change the piece\n        this.type = newType;\n        this.id = this.getId();\n        this.src = newSrc;\n        element.src = newSrc;\n        element.id = this.id;\n\n        // Scale back up\n        element.style.transition = `transform ${halfDuration}ms ease-out, opacity ${halfDuration}ms ease-out`;\n        element.style.transform = 'scale(1)';\n        element.style.opacity = '1';\n\n        setTimeout(() => {\n          if (!this.element) {\n            console.debug(`[Piece] transformTo (fallback, cleanup): ${this.id} - element is null`);\n            if (callback) callback();\n            return;\n          }\n          // Clean up\n          element.style.transition = '';\n          element.style.transform = '';\n          element.style.opacity = '';\n          element.classList.remove('transforming');\n\n          // Add bounce effect\n          element.classList.add('transform-complete');\n          setTimeout(() => {\n            if (!this.element) return;\n            element.classList.remove('transform-complete');\n          }, 400);\n\n          console.debug(`[Piece] transformTo complete (fallback): ${this.id}`);\n          if (callback) callback();\n        }, halfDuration);\n      }, halfDuration);\n    }\n  }\n\n  fadeIn(duration, speed, transition_f, callback) {\n    const start = performance.now();\n    let opacity = 0;\n    const fade = () => {\n      if (!this.element) {\n        console.debug(`[Piece] fadeIn: ${this.id} - element is null`);\n        if (callback) { callback(); }\n        return;\n      }\n      const elapsed = performance.now() - start;\n      opacity = transition_f(elapsed, duration, speed);\n      this.element.style.opacity = opacity;\n      if (elapsed < duration) {\n        requestAnimationFrame(fade);\n      } else {\n        if (!this.element) {\n          console.debug(`[Piece] fadeIn: ${this.id} - element is null (end)`);\n          if (callback) { callback(); }\n          return;\n        }\n        this.element.style.opacity = 1;\n        console.debug(`[Piece] fadeIn complete: ${this.id}`);\n        if (callback) { callback(); }\n      }\n    };\n    fade();\n  }\n\n  fadeOut(duration, speed, transition_f, callback) {\n    const start = performance.now();\n    let opacity = 1;\n    const fade = () => {\n      if (!this.element) {\n        console.debug(`[Piece] fadeOut: ${this.id} - element is null`);\n        if (callback) { callback(); }\n        return;\n      }\n      const elapsed = performance.now() - start;\n      opacity = 1 - transition_f(elapsed, duration, speed);\n      this.element.style.opacity = opacity;\n      if (elapsed < duration) {\n        requestAnimationFrame(fade);\n      } else {\n        if (!this.element) {\n          console.debug(`[Piece] fadeOut: ${this.id} - element is null (end)`);\n          if (callback) { callback(); }\n          return;\n        }\n        this.element.style.opacity = 0;\n        console.debug(`[Piece] fadeOut complete: ${this.id}`);\n        if (callback) { callback(); }\n      }\n    };\n    fade();\n  }\n\n  setDrag(f) {\n    if (!this.element) {\n      console.debug(`[Piece] setDrag: ${this.id} - element is null`);\n      return;\n    }\n\n    // Remove any existing drag handlers first\n    if (this._dragHandler) {\n      this.element.removeEventListener('mousedown', this._dragHandler);\n    }\n\n    this.element.ondragstart = (e) => {\n      e.preventDefault();\n    };\n\n    // Use the drag function directly without timeout\n    this._dragHandler = f;\n    this.element.addEventListener('mousedown', this._dragHandler);\n    console.debug(`[Piece] setDrag: ${this.id}`);\n  }\n\n  destroy() {\n    console.debug(`[Piece] Destroy: ${this.id}`);\n\n    // Remove all event listeners\n    if (this.element) {\n      if (this._dragHandler) {\n        this.element.removeEventListener('mousedown', this._dragHandler);\n        this._dragHandler = null;\n      }\n\n      this.element.onmousedown = null;\n      this.element.ondragstart = null;\n\n      // Remove from DOM\n      if (this.element.parentNode) {\n        this.element.parentNode.removeChild(this.element);\n      }\n\n      // Clear references\n      this.element = null;\n    }\n  }\n\n  translate(to, duration, transition_f, speed, callback = null) {\n    if (!this.element) {\n      console.debug(`[Piece] translate: ${this.id} - element is null`);\n      if (callback) callback();\n      return;\n    }\n    const sourceRect = this.element.getBoundingClientRect();\n    const targetRect = to.getBoundingClientRect();\n    const x_start = sourceRect.left + sourceRect.width / 2;\n    const y_start = sourceRect.top + sourceRect.height / 2;\n    const x_end = targetRect.left + targetRect.width / 2;\n    const y_end = targetRect.top + targetRect.height / 2;\n    const dx = x_end - x_start;\n    const dy = y_end - y_start;\n\n    const keyframes = [\n      { transform: 'translate(0, 0)' },\n      { transform: `translate(${dx}px, ${dy}px)` },\n    ];\n\n    if (this.element.animate) {\n      const animation = this.element.animate(keyframes, {\n        duration,\n        easing: 'ease',\n        fill: 'none',\n      });\n\n      animation.onfinish = () => {\n        if (!this.element) {\n          console.debug(`[Piece] translate.onfinish: ${this.id} - element is null`);\n          if (callback) callback();\n          return;\n        }\n        if (callback) callback();\n        if (this.element) this.element.style = '';\n        console.debug(`[Piece] translate complete: ${this.id}`);\n      };\n    } else {\n      this.element.style.transition = `transform ${duration}ms ease`;\n      this.element.style.transform = `translate(${dx}px, ${dy}px)`;\n      if (callback) callback();\n      if (this.element) this.element.style = '';\n      console.debug(`[Piece] translate complete (no animate): ${this.id}`);\n    }\n  }\n\n  check() {\n    if (['p', 'r', 'n', 'b', 'q', 'k'].indexOf(this.type) === -1) {\n      throw new Error('Invalid piece type');\n    }\n\n    if (['w', 'b'].indexOf(this.color) === -1) {\n      throw new Error('Invalid piece color');\n    }\n  }\n}\n\nexport default Piece;\n","class Square {\n  constructor(row, col) {\n    this.row = row;\n    this.col = col;\n    this.id = this.getId();\n    this.element = this.createElement();\n    this.piece = null;\n  }\n\n  getPiece() {\n    return this.piece;\n  }\n\n  opposite() {\n    this.row = 9 - this.row;\n    this.col = 9 - this.col;\n    this.id = this.getId();\n    this.element = this.resetElement();\n  }\n\n  isWhite() {\n    return (this.row + this.col) % 2 === 0;\n  }\n\n  getId() {\n    const letters = 'abcdefgh';\n    const letter = letters[this.col - 1];\n    return letter + this.row;\n  }\n\n  resetElement() {\n    this.element.id = this.id;\n    this.element.className = '';\n    this.element.classList.add('square');\n    this.element.classList.add(this.isWhite() ? 'whiteSquare' : 'blackSquare');\n  }\n\n  createElement() {\n    const element = document.createElement('div');\n    element.id = this.id;\n    element.classList.add('square');\n    element.classList.add(this.isWhite() ? 'whiteSquare' : 'blackSquare');\n    return element;\n  }\n\n  getElement() {\n    return this.element;\n  }\n\n  getBoundingClientRect() {\n    return this.element.getBoundingClientRect();\n  }\n\n  removePiece(preserve = false) {\n    if (!this.piece) {\n      return null;\n    }\n    // Only destroy the piece if not preserving (i.e., not moving)\n    if (!preserve && typeof this.piece.destroy === 'function') {\n      this.piece.destroy();\n    }\n    this.piece = null;\n    return null;\n  }\n\n  /**\n   * Forcefully removes all pieces from this square\n   */\n  forceRemoveAllPieces() {\n    // Best practice: destroy the piece object if present\n    if (this.piece && typeof this.piece.destroy === 'function') {\n      this.piece.destroy();\n      this.piece = null;\n    }\n    // Remove any orphaned img.piece elements from the DOM\n    const pieceElements = this.element.querySelectorAll('img.piece');\n    pieceElements.forEach((element) => {\n      if (element.parentNode === this.element) {\n        this.element.removeChild(element);\n      }\n    });\n  }\n\n  /**\n   * Replaces the current piece with a new one efficiently\n   * @param {Piece} newPiece - The new piece to place\n   */\n  replacePiece(newPiece) {\n    // If there's an existing piece, remove it first\n    if (this.piece) {\n      this.removePiece();\n    }\n\n    // Add the new piece\n    this.putPiece(newPiece);\n\n    // Ensure the piece is properly displayed\n    newPiece.element.style.opacity = '1';\n  }\n\n  addEventListener(event, callback) {\n    this.element.addEventListener(event, callback);\n  }\n\n  putPiece(piece) {\n    // If there's already a piece, remove it first, but preserve if moving\n    if (this.piece) {\n      this.removePiece(true);\n    }\n    this.piece = piece;\n    if (piece && piece.element) {\n      this.element.appendChild(piece.element);\n    }\n  }\n\n  putHint(catchable) {\n    if (this.element.querySelector('.hint')) {\n      return;\n    }\n    const hint = document.createElement('div');\n    hint.classList.add('hint');\n    this.element.appendChild(hint);\n    if (catchable) {\n      hint.classList.add('catchable');\n    }\n  }\n\n  removeHint() {\n    const hint = this.element.querySelector('.hint');\n    if (hint) {\n      this.element.removeChild(hint);\n    }\n  }\n\n  select() {\n    this.element.classList.add(this.isWhite() ? 'selectedSquareWhite' : 'selectedSquareBlack');\n  }\n\n  deselect() {\n    this.element.classList.remove('selectedSquareWhite');\n    this.element.classList.remove('selectedSquareBlack');\n  }\n\n  moved() {\n    this.element.classList.add(this.isWhite() ? 'movedSquareWhite' : 'movedSquareBlack');\n  }\n\n  unmoved() {\n    this.element.classList.remove('movedSquareWhite');\n    this.element.classList.remove('movedSquareBlack');\n  }\n\n  highlight() {\n    this.element.classList.add('highlighted');\n  }\n\n  dehighlight() {\n    this.element.classList.remove('highlighted');\n  }\n\n  putCover(callback) {\n    const cover = document.createElement('div');\n    cover.classList.add('square');\n    cover.classList.add('cover');\n    this.element.appendChild(cover);\n    cover.addEventListener('click', (e) => {\n      e.stopPropagation();\n      callback();\n    });\n  }\n\n  removeCover() {\n    const cover = this.element.querySelector('.cover');\n    if (cover) {\n      this.element.removeChild(cover);\n    }\n  }\n\n  putPromotion(src, callback) {\n    const choice = document.createElement('div');\n    choice.classList.add('square');\n    choice.classList.add('choice');\n    this.element.appendChild(choice);\n    const img = document.createElement('img');\n    img.classList.add('piece');\n    img.classList.add('choicable');\n    img.src = src;\n    choice.appendChild(img);\n    choice.addEventListener('click', (e) => {\n      e.stopPropagation();\n      callback();\n    });\n  }\n\n  hasPromotion() {\n    return this.element.querySelector('.choice') !== null;\n  }\n\n  removePromotion() {\n    const choice = this.element.querySelector('.choice');\n    if (choice) {\n      choice.removeChild(choice.firstChild);\n      this.element.removeChild(choice);\n    }\n  }\n\n  destroy() {\n    // Remove all piece DOM nodes and clear reference\n    this.forceRemoveAllPieces();\n    this.element.remove();\n    this.piece = null;\n  }\n\n  hasPiece() {\n    return this.piece !== null;\n  }\n\n  getColor() {\n    return this.piece.getColor();\n  }\n\n  check() {\n    if (this.row < 1 || this.row > 8) {\n      throw new Error('Invalid square: row is out of bounds');\n    }\n    if (this.col < 1 || this.col > 8) {\n      throw new Error('Invalid square: col is out of bounds');\n    }\n  }\n}\n\nexport default Square;\n","import Piece from './Piece.js';\nimport Square from './Square.js';\n\nclass Move {\n  constructor(from, to, promotion = null, check = false) {\n    this.piece = from ? from.getPiece() : null;\n    this.from = from;\n    this.to = to;\n    this.promotion = promotion;\n\n    if (check) this.check();\n  }\n\n  hasPromotion() {\n    return this.promotion !== null;\n  }\n\n  setPromotion(promotion) {\n    this.promotion = promotion;\n  }\n\n  check() {\n    if (this.piece === null) return false;\n    if (!(this.piece instanceof Piece)) return false;\n    if (['q', 'r', 'b', 'n', null].indexOf(this.promotion) === -1) return false;\n    if (!(this.from instanceof Square)) return false;\n    if (!(this.to instanceof Square)) return false;\n    if (!this.to) return false;\n    if (!this.from) return false;\n    if (this.from === this.to) return false;\n    return true;\n  }\n\n  isLegal(game) {\n    const destinations = game.moves({ square: this.from.id, verbose: true }).map((move) => move.to);\n    return destinations.indexOf(this.to.id) !== -1;\n  }\n}\n\nexport default Move;\n","/**\n * Service for managing animations and transitions\n * @module services/AnimationService\n * @since 2.0.0\n */\n\n/**\n * Service responsible for coordinating animations and transitions\n * @class\n */\nexport class AnimationService {\n  /**\n   * Creates a new AnimationService instance\n   * @param {ChessboardConfig} config - Board configuration\n   */\n  constructor(config) {\n    this.config = config;\n    this.activeAnimations = new Map();\n    this.animationId = 0;\n  }\n\n  /**\n   * Creates a timing function for animations\n   * @param {string} [type='ease'] - Animation type\n   * @returns {Function} Timing function\n   */\n  createTimingFunction(type = 'ease') {\n    return (elapsed, duration) => {\n      const x = elapsed / duration;\n\n      switch (type) {\n        case 'linear':\n          return x;\n        case 'ease':\n          return x ** 2 * (3 - 2 * x);\n        case 'ease-in':\n          return x ** 2;\n        case 'ease-out':\n          return -1 * (x - 1) ** 2 + 1;\n        case 'ease-in-out':\n          return x < 0.5 ? 2 * x ** 2 : 4 * x - 2 * x ** 2 - 1;\n        default:\n          return x;\n      }\n    };\n  }\n\n  /**\n   * Animates an element with given properties\n   * @param {HTMLElement} element - Element to animate\n   * @param {Object} properties - Properties to animate\n   * @param {number} duration - Animation duration in milliseconds\n   * @param {string} [easing='ease'] - Easing function\n   * @param {Function} [callback] - Callback when animation completes\n   * @returns {number} Animation ID\n   */\n  animate(element, properties, duration, easing = 'ease', callback) {\n    const animationId = ++this.animationId;\n    const timingFunction = this.createTimingFunction(easing);\n    const startTime = performance.now();\n    const startValues = {};\n\n    // Store initial values\n    Object.keys(properties).forEach((prop) => {\n      startValues[prop] = this._getInitialValue(element, prop);\n    });\n\n    const animate = (currentTime) => {\n      const elapsed = currentTime - startTime;\n      const progress = Math.min(elapsed / duration, 1);\n      const easedProgress = timingFunction(elapsed, duration);\n\n      // Apply animated values\n      Object.keys(properties).forEach((prop) => {\n        const startValue = startValues[prop];\n        const endValue = properties[prop];\n        const currentValue = this._interpolateValue(startValue, endValue, easedProgress);\n        this._applyValue(element, prop, currentValue);\n      });\n\n      if (progress < 1 && this.activeAnimations.has(animationId)) {\n        requestAnimationFrame(animate);\n      } else {\n        this.activeAnimations.delete(animationId);\n        if (callback) callback();\n      }\n    };\n\n    this.activeAnimations.set(animationId, { element, animate, callback });\n    requestAnimationFrame(animate);\n\n    return animationId;\n  }\n\n  /**\n   * Cancels an animation\n   * @param {number} animationId - Animation ID to cancel\n   */\n  cancel(animationId) {\n    if (this.activeAnimations.has(animationId)) {\n      this.activeAnimations.delete(animationId);\n    }\n  }\n\n  /**\n   * Cancels all animations\n   */\n  cancelAll() {\n    this.activeAnimations.clear();\n  }\n\n  /**\n   * Gets initial value for a property\n   * @private\n   * @param {HTMLElement} element - Element\n   * @param {string} property - Property name\n   * @returns {number} Initial value\n   */\n  _getInitialValue(element, property) {\n    if (!element || !element.style) return 0;\n    switch (property) {\n      case 'opacity':\n        return parseFloat(getComputedStyle(element).opacity) || 1;\n      case 'left':\n        return parseFloat(element.style.left) || 0;\n      case 'top':\n        return parseFloat(element.style.top) || 0;\n      case 'scale':\n        return 1;\n      default:\n        return 0;\n    }\n  }\n\n  /**\n   * Interpolates between two values\n   * @private\n   * @param {number} start - Start value\n   * @param {number} end - End value\n   * @param {number} progress - Progress (0-1)\n   * @returns {number} Interpolated value\n   */\n  _interpolateValue(start, end, progress) {\n    return start + (end - start) * progress;\n  }\n\n  /**\n   * Applies animated value to element\n   * @private\n   * @param {HTMLElement} element - Element\n   * @param {string} property - Property name\n   * @param {number} value - Value to apply\n   */\n  _applyValue(element, property, value) {\n    if (!element || !element.style) return;\n    switch (property) {\n      case 'opacity':\n        element.style.opacity = value;\n        break;\n      case 'left':\n        element.style.left = `${value}px`;\n        break;\n      case 'top':\n        element.style.top = `${value}px`;\n        break;\n      case 'scale':\n        element.style.transform = `scale(${value})`;\n        break;\n      default:\n        element.style[property] = value;\n    }\n  }\n\n  /**\n   * Cleans up resources\n   */\n  destroy() {\n    this.cancelAll();\n  }\n}\n","/**\n * Service for managing board setup and DOM operations\n * @module services/BoardService\n * @since 2.0.0\n */\n\nimport { BOARD_SIZE } from '../constants/positions.js';\nimport { DOMError, ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\nimport Square from '../components/Square.js';\n\n/**\n * Service responsible for board DOM manipulation and setup\n * @class\n */\nexport class BoardService {\n  /**\n   * Creates a new BoardService instance\n   * @param {ChessboardConfig} config - Board configuration\n   */\n  constructor(config) {\n    this.config = config;\n    this.element = null;\n    this.squares = {};\n  }\n\n  /**\n   * Builds the board DOM element and attaches it to the configured container\n   * @throws {DOMError} When the container element cannot be found\n   */\n  buildBoard() {\n    console.log('BoardService.buildBoard: Looking for element with ID:', this.config.id_div);\n\n    this.element = document.getElementById(this.config.id_div);\n    if (!this.element) {\n      throw new DOMError(ERROR_MESSAGES.invalid_id_div + this.config.id_div, this.config.id_div);\n    }\n\n    this.resize(this.config.size);\n    this.element.className = 'board';\n  }\n\n  /**\n   * Creates all 64 squares and adds them to the board\n   * @param {Function} coordConverter - Function to convert row/col to real coordinates\n   */\n  buildSquares(coordConverter) {\n    for (let row = 0; row < BOARD_SIZE.ROWS; row++) {\n      for (let col = 0; col < BOARD_SIZE.COLS; col++) {\n        const [squareRow, squareCol] = coordConverter(row, col);\n        const square = new Square(squareRow, squareCol);\n\n        this.squares[square.getId()] = square;\n        this.element.appendChild(square.element);\n      }\n    }\n  }\n\n  /**\n   * Removes all squares from the board and cleans up their resources\n   * Best practice: always destroy JS objects and DOM nodes, and clear references.\n   */\n  removeSquares() {\n    for (const square of Object.values(this.squares)) {\n      // Always call destroy to remove DOM and clear piece reference\n      square.destroy();\n    }\n    this.squares = {};\n  }\n\n  /**\n   * Removes all content from the board element\n   * Best practice: clear DOM and force element to be re-fetched on next build.\n   */\n  removeBoard() {\n    if (this.element) {\n      this.element.innerHTML = '';\n      this.element = null;\n    }\n  }\n\n  /**\n   * Resizes the board to the specified size\n   * @param {number|string} value - Size in pixels or 'auto'\n   * @throws {ValidationError} When size value is invalid\n   */\n  resize(value) {\n    if (value === 'auto') {\n      const size = this._calculateAutoSize();\n      this.resize(size);\n    } else if (typeof value !== 'number') {\n      throw new ValidationError(ERROR_MESSAGES.invalid_value + value, 'size', value);\n    } else {\n      document.documentElement.style.setProperty('--dimBoard', `${value}px`);\n    }\n  }\n\n  /**\n   * Calculates the optimal size when 'auto' is specified\n   * @private\n   * @returns {number} Calculated size in pixels\n   */\n  _calculateAutoSize() {\n    if (!this.element) return 400; // Default fallback\n\n    const { offsetWidth, offsetHeight } = this.element;\n\n    if (offsetWidth === 0) {\n      return offsetHeight || 400;\n    } else if (offsetHeight === 0) {\n      return offsetWidth;\n    }\n    return Math.min(offsetWidth, offsetHeight);\n  }\n\n  /**\n   * Gets a square by its ID\n   * @param {string} squareId - Square identifier (e.g., 'e4')\n   * @returns {Square|null} The square or null if not found\n   */\n  getSquare(squareId) {\n    return this.squares[squareId] || null;\n  }\n\n  /**\n   * Gets all squares\n   * @returns {Object.<string, Square>} All squares indexed by ID\n   */\n  getAllSquares() {\n    return { ...this.squares };\n  }\n\n  /**\n   * Applies a method to all squares\n   * @param {string} methodName - Name of the method to call on each square\n   * @param {...*} args - Arguments to pass to the method\n   */\n  applyToAllSquares(methodName, ...args) {\n    for (const square of Object.values(this.squares)) {\n      if (typeof square[methodName] === 'function') {\n        square[methodName](...args);\n      }\n    }\n  }\n\n  /**\n   * Cleans up all resources\n   */\n  destroy() {\n    this.removeSquares();\n    this.removeBoard();\n    this.element = null;\n    this.squares = {};\n  }\n}\n","/**\n * Service for managing coordinate conversions and board orientation\n * @module services/CoordinateService\n * @since 2.0.0\n */\n\nimport { BOARD_LETTERS } from '../constants/positions.js';\nimport { ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\n\n/**\n * Service responsible for coordinate conversions and board orientation\n * @class\n */\nexport class CoordinateService {\n  /**\n   * Creates a new CoordinateService instance\n   * @param {ChessboardConfig} config - Board configuration\n   */\n  constructor(config) {\n    this.config = config;\n  }\n\n  /**\n   * Converts logical coordinates to real coordinates based on board orientation\n   * @param {number} row - Row index (0-7)\n   * @param {number} col - Column index (0-7)\n   * @returns {Array<number>} Real coordinates [row, col] (1-8)\n   */\n  realCoord(row, col) {\n    let realRow = row;\n    let realCol = col;\n\n    if (this.isWhiteOriented()) {\n      realRow = 7 - row;\n    } else {\n      realCol = 7 - col;\n    }\n\n    return [realRow + 1, realCol + 1];\n  }\n\n  /**\n   * Converts board coordinates to square ID\n   * @param {number} row - Row index (0-7)\n   * @param {number} col - Column index (0-7)\n   * @returns {string} Square ID (e.g., 'e4')\n   */\n  getSquareID(row, col) {\n    row = parseInt(row);\n    col = parseInt(col);\n\n    if (this.isWhiteOriented()) {\n      row = 8 - row;\n      col = col + 1;\n    } else {\n      row = row + 1;\n      col = 8 - col;\n    }\n\n    if (col < 1 || col > 8 || row < 1 || row > 8) {\n      throw new ValidationError(\n        `Invalid board coordinates: row=${row}, col=${col}`,\n        'coordinates',\n        { row, col }\n      );\n    }\n\n    const letter = BOARD_LETTERS[col - 1];\n    return letter + row;\n  }\n\n  /**\n   * Converts square ID to board coordinates\n   * @param {string} squareId - Square ID (e.g., 'e4')\n   * @returns {Array<number>} Board coordinates [row, col] (0-7)\n   */\n  getCoordinatesFromSquareID(squareId) {\n    if (typeof squareId !== 'string' || squareId.length !== 2) {\n      throw new ValidationError(ERROR_MESSAGES.invalid_square + squareId, 'squareId', squareId);\n    }\n\n    const letter = squareId[0];\n    const number = parseInt(squareId[1]);\n\n    const col = BOARD_LETTERS.indexOf(letter);\n    if (col === -1) {\n      throw new ValidationError(ERROR_MESSAGES.invalid_square + squareId, 'squareId', squareId);\n    }\n\n    if (number < 1 || number > 8) {\n      throw new ValidationError(ERROR_MESSAGES.invalid_square + squareId, 'squareId', squareId);\n    }\n\n    let row, boardCol;\n\n    if (this.isWhiteOriented()) {\n      row = 8 - number;\n      boardCol = col;\n    } else {\n      row = number - 1;\n      boardCol = 7 - col;\n    }\n\n    return [row, boardCol];\n  }\n\n  /**\n   * Converts pixel coordinates to square ID\n   * @param {number} x - X coordinate in pixels\n   * @param {number} y - Y coordinate in pixels\n   * @param {HTMLElement} boardElement - Board DOM element\n   * @returns {string|null} Square ID or null if outside board\n   */\n  pixelToSquareID(x, y, boardElement) {\n    if (!boardElement) return null;\n\n    const rect = boardElement.getBoundingClientRect();\n    const { width, height } = rect;\n\n    // Check if coordinates are within board bounds\n    if (x < 0 || x >= width || y < 0 || y >= height) {\n      return null;\n    }\n\n    const squareWidth = width / 8;\n    const squareHeight = height / 8;\n\n    const col = Math.floor(x / squareWidth);\n    const row = Math.floor(y / squareHeight);\n\n    try {\n      return this.getSquareID(row, col);\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Converts square ID to pixel coordinates\n   * @param {string} squareId - Square ID (e.g., 'e4')\n   * @param {HTMLElement} boardElement - Board DOM element\n   * @returns {Object|null} Pixel coordinates {x, y} or null if invalid\n   */\n  squareIDToPixel(squareId, boardElement) {\n    if (!boardElement) return null;\n\n    try {\n      const [row, col] = this.getCoordinatesFromSquareID(squareId);\n      const rect = boardElement.getBoundingClientRect();\n      const { width, height } = rect;\n\n      const squareWidth = width / 8;\n      const squareHeight = height / 8;\n\n      const x = col * squareWidth;\n      const y = row * squareHeight;\n\n      return { x, y };\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Gets the center pixel coordinates of a square\n   * @param {string} squareId - Square ID (e.g., 'e4')\n   * @param {HTMLElement} boardElement - Board DOM element\n   * @returns {Object|null} Center coordinates {x, y} or null if invalid\n   */\n  getSquareCenter(squareId, boardElement) {\n    const coords = this.squareIDToPixel(squareId, boardElement);\n    if (!coords) return null;\n\n    const rect = boardElement.getBoundingClientRect();\n    const squareWidth = rect.width / 8;\n    const squareHeight = rect.height / 8;\n\n    return {\n      x: coords.x + squareWidth / 2,\n      y: coords.y + squareHeight / 2,\n    };\n  }\n\n  /**\n   * Calculates the distance between two squares\n   * @param {string} fromSquare - Source square ID\n   * @param {string} toSquare - Target square ID\n   * @returns {number} Distance between squares\n   */\n  getSquareDistance(fromSquare, toSquare) {\n    try {\n      const [fromRow, fromCol] = this.getCoordinatesFromSquareID(fromSquare);\n      const [toRow, toCol] = this.getCoordinatesFromSquareID(toSquare);\n\n      const rowDiff = Math.abs(toRow - fromRow);\n      const colDiff = Math.abs(toCol - fromCol);\n\n      return Math.sqrt(rowDiff * rowDiff + colDiff * colDiff);\n    } catch {\n      return 0;\n    }\n  }\n\n  /**\n   * Checks if the board is oriented from white's perspective\n   * @returns {boolean} True if white-oriented\n   */\n  isWhiteOriented() {\n    return this.config.orientation === 'w';\n  }\n\n  /**\n   * Checks if the board is oriented from black's perspective\n   * @returns {boolean} True if black-oriented\n   */\n  isBlackOriented() {\n    return this.config.orientation === 'b';\n  }\n\n  /**\n   * Gets the current orientation\n   * @returns {string} Current orientation ('w' or 'b')\n   */\n  getOrientation() {\n    return this.config.orientation;\n  }\n\n  /**\n   * Sets the orientation\n   * @param {string} orientation - New orientation ('w', 'b', 'white', 'black')\n   */\n  setOrientation(orientation) {\n    // Normalize orientation\n    const normalizedOrientation =\n      orientation === 'white' ? 'w' : orientation === 'black' ? 'b' : orientation;\n\n    if (normalizedOrientation !== 'w' && normalizedOrientation !== 'b') {\n      throw new ValidationError(\n        `${ERROR_MESSAGES.invalid_orientation}${orientation}`,\n        'orientation',\n        orientation\n      );\n    }\n\n    this.config.orientation = normalizedOrientation;\n  }\n\n  /**\n   * Flips the board orientation\n   */\n  flipOrientation() {\n    this.config.orientation = this.isWhiteOriented() ? 'b' : 'w';\n  }\n\n  /**\n   * Gets all square IDs in order\n   * @returns {Array<string>} Array of all square IDs\n   */\n  getAllSquareIDs() {\n    const squares = [];\n\n    for (let row = 0; row < 8; row++) {\n      for (let col = 0; col < 8; col++) {\n        squares.push(this.getSquareID(row, col));\n      }\n    }\n\n    return squares;\n  }\n\n  /**\n   * Gets squares in a specific rank (row)\n   * @param {number} rank - Rank number (1-8)\n   * @returns {Array<string>} Array of square IDs in the rank\n   */\n  getSquaresByRank(rank) {\n    if (rank < 1 || rank > 8) {\n      throw new ValidationError(`Invalid rank: ${rank}`, 'rank', rank);\n    }\n\n    const squares = [];\n\n    for (let col = 0; col < 8; col++) {\n      const row = this.isWhiteOriented() ? 8 - rank : rank - 1;\n      squares.push(this.getSquareID(row, col));\n    }\n\n    return squares;\n  }\n\n  /**\n   * Gets squares in a specific file (column)\n   * @param {string} file - File letter (a-h)\n   * @returns {Array<string>} Array of square IDs in the file\n   */\n  getSquaresByFile(file) {\n    const col = BOARD_LETTERS.indexOf(file);\n    if (col === -1) {\n      throw new ValidationError(`Invalid file: ${file}`, 'file', file);\n    }\n\n    const squares = [];\n\n    for (let row = 0; row < 8; row++) {\n      squares.push(this.getSquareID(row, col));\n    }\n\n    return squares;\n  }\n}\n","/**\n * Performance utilities for smooth interactions and monitoring\n * @module utils/performance\n * @since 2.0.0\n */\n\n/**\n * Performance monitoring class for measuring and tracking performance metrics\n * @class\n */\nexport class PerformanceMonitor {\n    /**\n     * Creates a new PerformanceMonitor instance\n     */\n    constructor() {\n        this.metrics = new Map();\n        this.observers = new Map();\n        this.isEnabled = typeof performance !== 'undefined' && performance.mark;\n        \n        if (this.isEnabled) {\n            this._setupObservers();\n        }\n    }\n    \n    /**\n     * Sets up performance observers for automatic metrics collection\n     * @private\n     */\n    _setupObservers() {\n        try {\n            // Performance Observer for paint metrics\n            if (typeof PerformanceObserver !== 'undefined') {\n                const paintObserver = new PerformanceObserver((list) => {\n                    for (const entry of list.getEntries()) {\n                        this.recordMetric(entry.name, entry.startTime);\n                    }\n                });\n                \n                paintObserver.observe({ entryTypes: ['paint'] });\n                this.observers.set('paint', paintObserver);\n            }\n        } catch (error) {\n            console.warn('Performance observers not available:', error.message);\n        }\n    }\n    \n    /**\n     * Starts measuring performance for a given operation\n     * @param {string} name - Name of the operation\n     */\n    startMeasure(name) {\n        if (!this.isEnabled) return;\n        \n        try {\n            performance.mark(`${name}-start`);\n        } catch (error) {\n            console.warn(`Failed to start performance measure for ${name}:`, error.message);\n        }\n    }\n    \n    /**\n     * Ends measuring performance for a given operation\n     * @param {string} name - Name of the operation\n     * @returns {number} Duration in milliseconds\n     */\n    endMeasure(name) {\n        if (!this.isEnabled) return 0;\n        \n        try {\n            performance.mark(`${name}-end`);\n            const measure = performance.measure(name, `${name}-start`, `${name}-end`);\n            \n            this.recordMetric(name, measure.duration);\n            \n            // Clean up marks\n            performance.clearMarks(`${name}-start`);\n            performance.clearMarks(`${name}-end`);\n            performance.clearMeasures(name);\n            \n            return measure.duration;\n        } catch (error) {\n            console.warn(`Failed to end performance measure for ${name}:`, error.message);\n            return 0;\n        }\n    }\n    \n    /**\n     * Records a metric value\n     * @param {string} name - Metric name\n     * @param {number} value - Metric value\n     */\n    recordMetric(name, value) {\n        if (!this.metrics.has(name)) {\n            this.metrics.set(name, {\n                count: 0,\n                total: 0,\n                min: Infinity,\n                max: -Infinity,\n                values: []\n            });\n        }\n        \n        const metric = this.metrics.get(name);\n        metric.count++;\n        metric.total += value;\n        metric.min = Math.min(metric.min, value);\n        metric.max = Math.max(metric.max, value);\n        metric.values.push(value);\n        \n        // Keep only last 100 values to prevent memory leaks\n        if (metric.values.length > 100) {\n            metric.values.shift();\n        }\n    }\n    \n    /**\n     * Gets metrics summary\n     * @returns {Object} Metrics summary\n     */\n    getMetrics() {\n        const summary = {};\n        \n        for (const [name, metric] of this.metrics) {\n            summary[name] = {\n                count: metric.count,\n                average: metric.total / metric.count,\n                min: metric.min,\n                max: metric.max,\n                total: metric.total,\n                p95: this._calculatePercentile(metric.values, 95),\n                p99: this._calculatePercentile(metric.values, 99)\n            };\n        }\n        \n        return summary;\n    }\n    \n    /**\n     * Calculates percentile for a set of values\n     * @private\n     * @param {Array<number>} values - Array of values\n     * @param {number} percentile - Percentile to calculate (0-100)\n     * @returns {number} Percentile value\n     */\n    _calculatePercentile(values, percentile) {\n        if (values.length === 0) return 0;\n        \n        const sorted = [...values].sort((a, b) => a - b);\n        const index = Math.ceil((percentile / 100) * sorted.length) - 1;\n        return sorted[Math.max(0, index)];\n    }\n    \n    /**\n     * Clears all metrics\n     */\n    clearMetrics() {\n        this.metrics.clear();\n    }\n    \n    /**\n     * Destroys the performance monitor and cleans up resources\n     */\n    destroy() {\n        // Disconnect observers\n        for (const observer of this.observers.values()) {\n            if (observer && typeof observer.disconnect === 'function') {\n                observer.disconnect();\n            }\n        }\n        \n        this.observers.clear();\n        this.metrics.clear();\n    }\n}\n\n/**\n * Throttle function to limit how often a function can be called\n * @param {Function} func - Function to throttle\n * @param {number} limit - Time limit in milliseconds\n * @returns {Function} Throttled function\n */\nexport function throttle(func, limit) {\n    let inThrottle;\n    return function(...args) {\n        if (!inThrottle) {\n            func.apply(this, args);\n            inThrottle = true;\n            setTimeout(() => { inThrottle = false; }, limit);\n        }\n    };\n}\n\n/**\n * Debounce function to delay function execution\n * @param {Function} func - Function to debounce\n * @param {number} delay - Delay in milliseconds\n * @returns {Function} Debounced function\n */\nexport function debounce(func, delay) {\n    let timeoutId;\n    const debounced = function(...args) {\n        clearTimeout(timeoutId);\n        timeoutId = setTimeout(() => func.apply(debounced.context, args), delay);\n    };\n    return function(...args) {\n        debounced.context = this;\n        return debounced(...args);\n    };\n}\n\n/**\n * Request animation frame throttle for smooth animations\n * @param {Function} func - Function to throttle\n * @returns {Function} RAF throttled function\n */\nexport function rafThrottle(func) {\n    let isThrottled = false;\n    const throttled = function(...args) {\n        if (isThrottled) { return; }\n\n        isThrottled = true;\n        requestAnimationFrame(() => {\n            func.apply(throttled.context, args);\n            isThrottled = false;\n        });\n    };\n    return function(...args) {\n        throttled.context = this;\n        return throttled(...args);\n    };\n}\n\n/**\n * High performance transform utility with hardware acceleration\n * @param {HTMLElement} element - Element to transform\n * @param {number} x - X coordinate\n * @param {number} y - Y coordinate\n * @param {number} [scale=1] - Scale factor\n */\nexport function setTransform(element, x, y, scale = 1) {\n    if (!element || !element.style) return;\n    \n    // Use transform3d for hardware acceleration\n    element.style.transform = `translate3d(${x}px, ${y}px, 0) scale(${scale})`;\n    \n    // Promote to composite layer for better performance\n    element.style.willChange = 'transform';\n}\n\n/**\n * Reset element position efficiently\n * @param {HTMLElement} element - Element to reset\n */\nexport function resetTransform(element) {\n    if (!element || !element.style) return;\n    \n    element.style.transform = '';\n    element.style.left = '';\n    element.style.top = '';\n    element.style.willChange = '';\n}\n\n/**\n * Memory-efficient batch DOM operations\n * @param {Function} callback - Callback containing DOM operations\n * @returns {*} Result of the callback\n */\nexport function batchDOMOperations(callback) {\n    return new Promise((resolve) => {\n        requestAnimationFrame(() => {\n            const result = callback();\n            resolve(result);\n        });\n    });\n}\n\n/**\n * Optimized element visibility check\n * @param {HTMLElement} element - Element to check\n * @returns {boolean} True if element is visible\n */\nexport function isElementVisible(element) {\n    if (!element || !element.getBoundingClientRect) return false;\n    \n    const rect = element.getBoundingClientRect();\n    return (\n        rect.width > 0 &&\n        rect.height > 0 &&\n        rect.bottom > 0 &&\n        rect.right > 0 &&\n        rect.top < (window.innerHeight || document.documentElement.clientHeight) &&\n        rect.left < (window.innerWidth || document.documentElement.clientWidth)\n    );\n}\n\n/**\n * Memory usage tracking utility\n * @returns {Object} Memory usage information\n */\nexport function getMemoryUsage() {\n    if (typeof performance !== 'undefined' && performance.memory) {\n        return {\n            used: performance.memory.usedJSHeapSize,\n            total: performance.memory.totalJSHeapSize,\n            limit: performance.memory.jsHeapSizeLimit\n        };\n    }\n    \n    return {\n        used: 0,\n        total: 0,\n        limit: 0,\n        supported: false\n    };\n}\n","/**\n * Cross-browser utilities for consistent drag & drop behavior\n */\n\n/**\n * Detect browser type and version\n * @returns {Object} Browser information\n */\nexport function getBrowserInfo() {\n    const ua = navigator.userAgent;\n    const isChrome = ua.includes('Chrome') && !ua.includes('Edg');\n    const isFirefox = ua.includes('Firefox');\n    const isSafari = ua.includes('Safari') && !ua.includes('Chrome');\n    const isEdge = ua.includes('Edg');\n    \n    return {\n        isChrome,\n        isFirefox,\n        isSafari,\n        isEdge,\n        devicePixelRatio: window.devicePixelRatio || 1,\n        userAgent: ua\n    };\n}\n\n/**\n * Get accurate mouse coordinates accounting for browser differences\n * @param {MouseEvent} event - Mouse event\n * @returns {Object} Normalized coordinates\n */\nexport function getNormalizedCoordinates(event) {\n    const browserInfo = getBrowserInfo();\n    \n    // Base coordinates\n    let x = event.clientX;\n    let y = event.clientY;\n    \n    // Add scroll offset for absolute positioning\n    x += window.scrollX || window.pageXOffset || 0;\n    y += window.scrollY || window.pageYOffset || 0;\n    \n    // Chrome-specific adjustments if needed\n    if (browserInfo.isChrome) {\n        // Chrome sometimes has sub-pixel rendering differences\n        x = Math.round(x);\n        y = Math.round(y);\n    }\n    \n    return { x, y };\n}\n\n/**\n * Set element position using the most compatible method\n * @param {HTMLElement} element - Element to position\n * @param {number} x - X coordinate\n * @param {number} y - Y coordinate\n */\nexport function setElementPosition(element, x, y) {\n    // Ensure pixel-perfect positioning\n    element.style.left = `${Math.round(x)}px`;\n    element.style.top = `${Math.round(y)}px`;\n}\n\n/**\n * Calculate offset from center for drag positioning\n * @param {HTMLElement} element - Element being dragged\n * @param {number} mouseX - Mouse X coordinate\n * @param {number} mouseY - Mouse Y coordinate\n * @returns {Object} Position coordinates\n */\nexport function calculateDragPosition(element, mouseX, mouseY) {\n    const rect = element.getBoundingClientRect();\n    const halfWidth = rect.width / 2;\n    const halfHeight = rect.height / 2;\n    \n    return {\n        x: mouseX - halfWidth,\n        y: mouseY - halfHeight\n    };\n}\n\n/**\n * Enhanced mouse coordinate tracking for cross-browser compatibility\n */\nexport class MouseTracker {\n    constructor() {\n        this.lastKnownPosition = { x: 0, y: 0 };\n        this.browserInfo = getBrowserInfo();\n    }\n    \n    /**\n     * Update position from mouse event\n     * @param {MouseEvent} event - Mouse event\n     * @returns {Object} Normalized position\n     */\n    updatePosition(event) {\n        const coords = getNormalizedCoordinates(event);\n        this.lastKnownPosition = coords;\n        return coords;\n    }\n    \n    /**\n     * Get element position for dragging\n     * @param {HTMLElement} element - Element to position\n     * @param {MouseEvent} event - Mouse event\n     * @returns {Object} Position for the element\n     */\n    getDragPosition(element, event) {\n        const mousePos = this.updatePosition(event);\n        return calculateDragPosition(element, mousePos.x, mousePos.y);\n    }\n}\n\n/**\n * Browser-specific drag optimizations\n */\nexport const DragOptimizations = {\n    /**\n     * Apply browser-specific optimizations to an element\n     * @param {HTMLElement} element - Element to optimize\n     */\n    enableForDrag(element) {\n        const browserInfo = getBrowserInfo();\n        \n        // Base optimizations for all browsers\n        element.style.willChange = 'left, top';\n        element.style.pointerEvents = 'none'; // Prevent conflicts\n        \n        // Chrome-specific optimizations\n        if (browserInfo.isChrome) {\n            element.style.transform = 'translateZ(0)'; // Force hardware acceleration\n        }\n        \n        // Firefox-specific optimizations\n        if (browserInfo.isFirefox) {\n            element.style.backfaceVisibility = 'hidden';\n        }\n    },\n    \n    /**\n     * Clean up optimizations after drag\n     * @param {HTMLElement} element - Element to clean up\n     */\n    cleanupAfterDrag(element) {\n        element.style.willChange = 'auto';\n        element.style.pointerEvents = '';\n        element.style.transform = '';\n        element.style.backfaceVisibility = '';\n    }\n};\n","/**\n * Structured logging system for Chessboard.js\n * @module utils/logger\n * @since 2.0.0\n */\n\n/**\n * Log levels in order of severity\n * @constant\n * @type {Object}\n */\nconst LOG_LEVELS = Object.freeze({\n    DEBUG: 0,\n    INFO: 1,\n    WARN: 2,\n    ERROR: 3,\n    NONE: 4\n});\n\n/**\n * Default logger configuration\n * @constant\n * @type {Object}\n */\nconst DEFAULT_CONFIG = Object.freeze({\n    level: LOG_LEVELS.INFO,\n    enableColors: true,\n    enableTimestamp: true,\n    enableStackTrace: true,\n    maxLogSize: 1000,\n    enableConsole: true,\n    enableStorage: false,\n    storageKey: 'chessboard-logs'\n});\n\n/**\n * ANSI color codes for console output\n * @constant\n * @type {Object}\n */\nconst COLORS = Object.freeze({\n    DEBUG: '\\x1b[36m',    // Cyan\n    INFO: '\\x1b[32m',     // Green\n    WARN: '\\x1b[33m',     // Yellow\n    ERROR: '\\x1b[31m',    // Red\n    RESET: '\\x1b[0m'      // Reset\n});\n\n/**\n * Structured logger class with configurable output and filtering\n * @class\n */\nexport class Logger {\n    /**\n     * Creates a new Logger instance\n     * @param {Object} [config] - Logger configuration\n     * @param {string} [name] - Logger name/namespace\n     */\n    constructor(config = {}, name = 'Chessboard') {\n        this.config = { ...DEFAULT_CONFIG, ...config };\n        this.name = name;\n        this.logs = [];\n        this.startTime = Date.now();\n        \n        // Create bound methods for better performance\n        this.debug = this._createLogMethod('DEBUG');\n        this.info = this._createLogMethod('INFO');\n        this.warn = this._createLogMethod('WARN');\n        this.error = this._createLogMethod('ERROR');\n        \n        // Performance tracking\n        this.performances = new Map();\n        \n        // Initialize storage if enabled\n        if (this.config.enableStorage) {\n            this._initStorage();\n        }\n    }\n\n    /**\n     * Creates a log method for a specific level\n     * @private\n     * @param {string} level - Log level\n     * @returns {Function} Log method\n     */\n    _createLogMethod(level) {\n        return (message, data = {}, error = null) => {\n            this._log(level, message, data, error);\n        };\n    }\n\n    /**\n     * Core logging method\n     * @private\n     * @param {string} level - Log level\n     * @param {string} message - Log message\n     * @param {Object} data - Additional data\n     * @param {Error} error - Error object\n     */\n    _log(level, message, data, error) {\n        const levelNumber = LOG_LEVELS[level];\n        \n        // Filter by level\n        if (levelNumber < this.config.level) {\n            return;\n        }\n        \n        // Create log entry\n        const entry = this._createLogEntry(level, message, data, error);\n        \n        // Store log entry\n        this._storeLogEntry(entry);\n        \n        // Output to console\n        if (this.config.enableConsole) {\n            this._outputToConsole(entry);\n        }\n        \n        // Store in localStorage if enabled\n        if (this.config.enableStorage) {\n            this._storeInStorage(entry);\n        }\n    }\n\n    /**\n     * Creates a structured log entry\n     * @private\n     * @param {string} level - Log level\n     * @param {string} message - Log message\n     * @param {Object} data - Additional data\n     * @param {Error} error - Error object\n     * @returns {Object} Log entry\n     */\n    _createLogEntry(level, message, data, error) {\n        const entry = {\n            timestamp: new Date().toISOString(),\n            level,\n            logger: this.name,\n            message,\n            data: { ...data },\n            runtime: Date.now() - this.startTime\n        };\n        \n        // Add error details if provided\n        if (error) {\n            entry.error = {\n                name: error.name,\n                message: error.message,\n                stack: this.config.enableStackTrace ? error.stack : null\n            };\n        }\n        \n        // Add performance context if available\n        if (typeof performance !== 'undefined' && performance.memory) {\n            entry.memory = {\n                used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),\n                total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024)\n            };\n        }\n        \n        return entry;\n    }\n\n    /**\n     * Stores log entry in memory\n     * @private\n     * @param {Object} entry - Log entry\n     */\n    _storeLogEntry(entry) {\n        this.logs.push(entry);\n        \n        // Limit log size\n        if (this.logs.length > this.config.maxLogSize) {\n            this.logs.shift();\n        }\n    }\n\n    /**\n     * Outputs log entry to console\n     * @private\n     * @param {Object} entry - Log entry\n     */\n    _outputToConsole(entry) {\n        const color = this.config.enableColors ? COLORS[entry.level] : '';\n        const reset = this.config.enableColors ? COLORS.RESET : '';\n        const timestamp = this.config.enableTimestamp ? \n            `[${new Date(entry.timestamp).toLocaleTimeString()}] ` : '';\n        \n        const prefix = `${color}${timestamp}[${entry.logger}:${entry.level}]${reset}`;\n        const message = `${prefix} ${entry.message}`;\n        \n        // Choose console method based on level\n        const consoleMethod = this._getConsoleMethod(entry.level);\n        \n        if (Object.keys(entry.data).length > 0 || entry.error) {\n            consoleMethod(message, {\n                data: entry.data,\n                error: entry.error,\n                runtime: `${entry.runtime}ms`\n            });\n        } else {\n            consoleMethod(message);\n        }\n    }\n\n    /**\n     * Gets appropriate console method for log level\n     * @private\n     * @param {string} level - Log level\n     * @returns {Function} Console method\n     */\n    _getConsoleMethod(level) {\n        switch (level) {\n            case 'DEBUG':\n                return console.debug || console.log;\n            case 'INFO':\n                return console.info || console.log;\n            case 'WARN':\n                return console.warn || console.log;\n            case 'ERROR':\n                return console.error || console.log;\n            default:\n                return console.log;\n        }\n    }\n\n    /**\n     * Initializes localStorage for log storage\n     * @private\n     */\n    _initStorage() {\n        if (typeof localStorage === 'undefined') {\n            this.config.enableStorage = false;\n            return;\n        }\n        \n        try {\n            // Test localStorage availability\n            localStorage.setItem('test', 'test');\n            localStorage.removeItem('test');\n        } catch {\n            this.config.enableStorage = false;\n            console.warn('localStorage not available, disabling log storage');\n        }\n    }\n\n    /**\n     * Stores log entry in localStorage\n     * @private\n     * @param {Object} entry - Log entry\n     */\n    _storeInStorage(entry) {\n        if (!this.config.enableStorage) {\n            return;\n        }\n        \n        try {\n            const stored = JSON.parse(localStorage.getItem(this.config.storageKey) || '[]');\n            stored.push(entry);\n            \n            // Limit stored logs\n            if (stored.length > this.config.maxLogSize) {\n                stored.shift();\n            }\n            \n            localStorage.setItem(this.config.storageKey, JSON.stringify(stored));\n        } catch (error) {\n            console.warn('Failed to store log entry:', error);\n        }\n    }\n\n    /**\n     * Starts performance measurement\n     * @param {string} name - Performance measurement name\n     */\n    startPerformance(name) {\n        this.performances.set(name, {\n            start: performance.now(),\n            measurements: []\n        });\n        \n        this.debug(`Started performance measurement: ${name}`);\n    }\n\n    /**\n     * Ends performance measurement\n     * @param {string} name - Performance measurement name\n     * @returns {number} Duration in milliseconds\n     */\n    endPerformance(name) {\n        const perf = this.performances.get(name);\n        if (!perf) {\n            this.warn(`Performance measurement not found: ${name}`);\n            return 0;\n        }\n        \n        const duration = performance.now() - perf.start;\n        perf.measurements.push(duration);\n        \n        this.debug(`Performance measurement completed: ${name}`, {\n            duration: `${duration.toFixed(2)}ms`,\n            measurements: perf.measurements.length\n        });\n        \n        return duration;\n    }\n\n    /**\n     * Gets performance statistics\n     * @param {string} name - Performance measurement name\n     * @returns {Object} Performance statistics\n     */\n    getPerformanceStats(name) {\n        const perf = this.performances.get(name);\n        if (!perf || perf.measurements.length === 0) {\n            return null;\n        }\n        \n        const measurements = perf.measurements;\n        const total = measurements.reduce((sum, m) => sum + m, 0);\n        const avg = total / measurements.length;\n        const min = Math.min(...measurements);\n        const max = Math.max(...measurements);\n        \n        return {\n            name,\n            count: measurements.length,\n            total: total.toFixed(2),\n            average: avg.toFixed(2),\n            min: min.toFixed(2),\n            max: max.toFixed(2)\n        };\n    }\n\n    /**\n     * Creates a child logger with a specific namespace\n     * @param {string} namespace - Child logger namespace\n     * @returns {Logger} Child logger instance\n     */\n    child(namespace) {\n        return new Logger(this.config, `${this.name}:${namespace}`);\n    }\n\n    /**\n     * Sets log level\n     * @param {string} level - Log level\n     */\n    setLevel(level) {\n        if (LOG_LEVELS[level] !== undefined) {\n            this.config.level = LOG_LEVELS[level];\n        }\n    }\n\n    /**\n     * Gets current log level\n     * @returns {string} Current log level\n     */\n    getLevel() {\n        return Object.keys(LOG_LEVELS).find(key => LOG_LEVELS[key] === this.config.level);\n    }\n\n    /**\n     * Gets all stored logs\n     * @returns {Array} Array of log entries\n     */\n    getLogs() {\n        return [...this.logs];\n    }\n\n    /**\n     * Clears all stored logs\n     */\n    clearLogs() {\n        this.logs = [];\n        \n        if (this.config.enableStorage) {\n            try {\n                localStorage.removeItem(this.config.storageKey);\n            } catch (error) {\n                console.warn('Failed to clear stored logs:', error);\n            }\n        }\n    }\n\n    /**\n     * Exports logs as JSON\n     * @returns {string} JSON string of logs\n     */\n    exportLogs() {\n        return JSON.stringify(this.logs, null, 2);\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        this.clearLogs();\n        this.performances.clear();\n    }\n}\n\n/**\n * Default logger instance\n * @type {Logger}\n */\nexport const logger = new Logger();\n\n/**\n * Creates a logger with specific configuration\n * @param {Object} config - Logger configuration\n * @param {string} name - Logger name\n * @returns {Logger} Logger instance\n */\nexport function createLogger(config, name) {\n    return new Logger(config, name);\n}\n\n/**\n * Log levels enumeration\n * @type {Object}\n */\nexport { LOG_LEVELS };\n","/**\n * Service for managing events and user interactions\n * @module services/EventService\n * @since 2.0.0\n */\n\nimport { rafThrottle } from '../utils/performance.js';\nimport { DragOptimizations } from '../utils/cross-browser.js';\nimport Move from '../components/Move.js';\nimport Piece from '../components/Piece.js';\nimport { logger } from '../utils/logger.js';\n\n/**\n * Service responsible for event handling and user interactions\n * @class\n */\nexport class EventService {\n  /**\n   * Creates a new EventService instance\n   * @param {ChessboardConfig} config - Board configuration\n   * @param {BoardService} boardService - Board service instance\n   * @param {MoveService} moveService - Move service instance\n   * @param {CoordinateService} coordinateService - Coordinate service instance\n   * @param {Chessboard} chessboard - Chessboard instance\n   */\n  constructor(config, boardService, moveService, coordinateService, chessboard) {\n    this.config = config;\n    this.boardService = boardService;\n    this.moveService = moveService;\n    this.coordinateService = coordinateService;\n    this.chessboard = chessboard;\n\n    this.clicked = null;\n    this.isDragging = false;\n    this.isAnimating = false;\n    this.promoting = false;\n    this._isProcessingDrop = false;\n\n    this.eventListeners = new Map();\n  }\n\n  /**\n   * Adds event listeners to all squares\n   * @param {Function} onSquareClick - Callback for square clicks\n   * @param {Function} onPieceHover - Callback for piece hover\n   * @param {Function} onPieceLeave - Callback for piece leave\n   */\n  addListeners(onSquareClick, onPieceHover, onPieceLeave) {\n    // Remove existing listeners to avoid duplicates\n    this.removeListeners();\n\n    const squares = this.boardService.getAllSquares();\n\n    Object.values(squares).forEach((square) => {\n      this._addSquareListeners(square, onSquareClick, onPieceHover, onPieceLeave);\n    });\n  }\n\n  /**\n   * Adds event listeners to a specific square\n   * @private\n   * @param {Square} square - Square to add listeners to\n   * @param {Function} onSquareClick - Click callback\n   * @param {Function} onPieceHover - Hover callback\n   * @param {Function} onPieceLeave - Leave callback\n   */\n  _addSquareListeners(square, onSquareClick, onPieceHover, onPieceLeave) {\n    const listeners = [];\n\n    // Throttled hover handlers for performance\n    const throttledHover = rafThrottle(() => {\n      if (!this.clicked && this.config.hints) {\n        onPieceHover(square);\n      }\n    });\n\n    const throttledLeave = rafThrottle(() => {\n      if (!this.clicked && this.config.hints) {\n        onPieceLeave(square);\n      }\n    });\n\n    // Click handler\n    const handleClick = (e) => {\n      e.stopPropagation();\n      if (this.config.clickable && !this.isAnimating) {\n        // Cancel any pending drag operations on pieces in this square\n        if (square.piece && square.piece._dragTimeout) {\n          clearTimeout(square.piece._dragTimeout);\n          square.piece._dragTimeout = null;\n        }\n        onSquareClick(square);\n      }\n    };\n\n    // Add listeners\n    square.element.addEventListener('mouseover', throttledHover);\n    square.element.addEventListener('mouseout', throttledLeave);\n    square.element.addEventListener('click', handleClick);\n    square.element.addEventListener('touchstart', handleClick);\n\n    // Store listeners for cleanup\n    listeners.push(\n      { element: square.element, type: 'mouseover', handler: throttledHover },\n      { element: square.element, type: 'mouseout', handler: throttledLeave },\n      { element: square.element, type: 'click', handler: handleClick },\n      { element: square.element, type: 'touchstart', handler: handleClick }\n    );\n\n    this.eventListeners.set(square.id, listeners);\n  }\n\n  /**\n   * Creates a drag function for a piece\n   * @param {Square} square - Square containing the piece\n   * @param {Piece} piece - Piece to create drag function for\n   * @param {Function} onDragStart - Drag start callback\n   * @param {Function} onDragMove - Drag move callback\n   * @param {Function} onDrop - Drop callback\n   * @param {Function} onSnapback - Snapback callback\n   * @param {Function} onMove - Move execution callback\n   * @param {Function} onRemove - Remove piece callback\n   * @returns {Function} Drag event handler\n   */\n  createDragFunction(square, piece, onDragStart, onDragMove, onDrop, onSnapback, onMove, onRemove) {\n    console.log(\n      'Creating drag function for:',\n      square.id,\n      piece ? `${piece.color}${piece.type}` : 'null'\n    );\n\n    return (event) => {\n      event.preventDefault();\n\n      if (!this.config.draggable || !piece || this.isAnimating || this.isDragging) {\n        return;\n      }\n\n      // Set dragging state immediately\n      this.isDragging = true;\n\n      const originalFrom = square;\n      let isDragging = false;\n      const from = originalFrom;\n      let to = square;\n      let previousHighlight = null;\n\n      const img = piece.element;\n\n      if (!this.moveService.canMove(from)) {\n        return;\n      }\n\n      // Track initial position for drag threshold\n      const startX = event.clientX || (event.touches && event.touches[0]?.clientX) || 0;\n      const startY = event.clientY || (event.touches && event.touches[0]?.clientY) || 0;\n\n      const moveAt = (event) => {\n        const boardElement = this.boardService.element;\n        const squareSize = boardElement.offsetWidth / 8;\n\n        // Get mouse coordinates\n        let clientX, clientY;\n        if (event.touches && event.touches[0]) {\n          clientX = event.touches[0].clientX;\n          clientY = event.touches[0].clientY;\n        } else {\n          clientX = event.clientX;\n          clientY = event.clientY;\n        }\n\n        // Calculate position relative to board\n        const boardRect = boardElement.getBoundingClientRect();\n        const x = clientX - boardRect.left - squareSize / 2;\n        const y = clientY - boardRect.top - squareSize / 2;\n\n        img.style.left = `${x}px`;\n        img.style.top = `${y}px`;\n\n        return true;\n      };\n\n      const onMouseMove = (event) => {\n        const currentX = event.clientX || 0;\n        const currentY = event.clientY || 0;\n        const deltaX = Math.abs(currentX - startX);\n        const deltaY = Math.abs(currentY - startY);\n\n        // Start dragging if mouse moved enough\n        if (!isDragging && (deltaX > 3 || deltaY > 3)) {\n          isDragging = true;\n\n          // During drag, we don't need to manage clicked state\n          // The drag operation is independent of click state\n\n          // Visual feedback\n          if (this.config.clickable) {\n            from.select();\n            // Show hints would be handled by the main class\n          }\n\n          // Prepare piece for dragging\n          // First, preserve the current computed dimensions\n          const computedStyle = window.getComputedStyle(img);\n          const currentWidth = computedStyle.width;\n          const currentHeight = computedStyle.height;\n\n          img.style.position = 'absolute';\n          img.style.zIndex = '100';\n          img.classList.add('dragging');\n\n          // Explicitly set the dimensions to maintain size during drag\n          img.style.width = currentWidth;\n          img.style.height = currentHeight;\n\n          DragOptimizations.enableForDrag(img);\n\n          // Call drag start callback\n          if (!onDragStart(square, piece)) {\n            return;\n          }\n        }\n\n        if (!isDragging) return;\n\n        if (!moveAt(event)) return;\n\n        // Update target square\n        const boardElement = this.boardService.element;\n        const boardRect = boardElement.getBoundingClientRect();\n        const x = event.clientX - boardRect.left;\n        const y = event.clientY - boardRect.top;\n\n        let newTo = null;\n        if (x >= 0 && x <= boardRect.width && y >= 0 && y <= boardRect.height) {\n          const squareId = this.coordinateService.pixelToSquareID(x, y, boardElement);\n          newTo = squareId ? this.boardService.getSquare(squareId) : null;\n        }\n\n        to = newTo;\n        onDragMove(from, to, piece);\n\n        // Update visual feedback\n        if (to !== previousHighlight) {\n          to?.highlight();\n          previousHighlight?.dehighlight();\n          previousHighlight = to;\n        }\n      };\n\n      const onMouseUp = () => {\n        // Clean up visual feedback\n        previousHighlight?.dehighlight();\n\n        // CRITICAL FIX: Remove ALL event listeners immediately to prevent interference\n        document.removeEventListener('mousemove', onMouseMove);\n        window.removeEventListener('mouseup', onMouseUp);\n        img.removeEventListener('mouseup', onMouseUp);\n\n        // If this was just a click, don't interfere\n        if (!isDragging) {\n          return;\n        }\n\n        console.log('onMouseUp: Handling drag completion for piece at', originalFrom.id);\n\n        // Clean up drag state\n        img.style.zIndex = '20';\n        img.classList.remove('dragging');\n        img.style.willChange = 'auto';\n\n        // Clean up drag optimizations that might interfere with click\n        DragOptimizations.cleanupAfterDrag(img);\n\n        // Reset drag state immediately to allow subsequent clicks\n        this.isDragging = false;\n\n        // Ensure clicked state is clean before handling drop\n        // This prevents drag operations from interfering with subsequent clicks\n        this.clicked = null;\n\n        // Handle drop\n        const dropResult = onDrop(originalFrom, to, piece);\n        const isTrashDrop = !to && (this.config.dropOffBoard === 'trash' || dropResult === 'trash');\n\n        if (isTrashDrop) {\n          this._handleTrashDrop(originalFrom, onRemove);\n        } else if (!to) {\n          // Reset piece position instantly for snapback\n          img.style.position = '';\n          img.style.left = '';\n          img.style.top = '';\n          img.style.transform = '';\n          img.style.width = '';\n          img.style.height = '';\n\n          // Clean up drag optimizations\n          DragOptimizations.cleanupAfterDrag(img);\n\n          this._handleSnapback(originalFrom, piece, onSnapback);\n          this._cleanupAfterFailedMove(originalFrom);\n        } else {\n          // Handle drop like a click - simple and reliable\n          this._handleDrop(originalFrom, to, piece, onMove, onSnapback);\n        }\n      };\n\n      // Attach event listeners\n      window.addEventListener('mouseup', onMouseUp, { once: true });\n      document.addEventListener('mousemove', onMouseMove);\n      img.addEventListener('mouseup', onMouseUp, { once: true });\n    };\n  }\n\n  /**\n   * Handles trash drop (piece removal)\n   * @private\n   * @param {Square} fromSquare - Source square\n   * @param {Function} onRemove - Callback to remove piece\n   */\n  _handleTrashDrop(fromSquare, onRemove) {\n    // Clear visual states\n    this.boardService.applyToAllSquares('unmoved');\n    this.boardService.applyToAllSquares('removeHint');\n    fromSquare.deselect();\n\n    // Reset clicked state\n    this.clicked = null;\n\n    if (onRemove) {\n      onRemove(fromSquare.getId());\n    }\n\n    logger.debug('EventService: Trash drop executed, state cleaned up');\n  }\n\n  /**\n   * Handles snapback animation\n   * @private\n   * @param {Square} fromSquare - Source square\n   * @param {Piece} piece - Piece to snapback\n   * @param {Function} onSnapback - Snapback callback\n   */\n  _handleSnapback(fromSquare, piece, onSnapback) {\n    if (fromSquare && fromSquare.piece) {\n      if (onSnapback) {\n        onSnapback(fromSquare, piece);\n      }\n    }\n\n    // Always cleanup state after snapback\n    logger.debug('EventService: Snapback executed, cleaning up state');\n  }\n\n  /**\n   * Handles successful drop\n   * @private\n   * @param {Square} fromSquare - Source square\n   * @param {Square} toSquare - Target square\n   * @param {Piece} piece - Piece being dropped\n   * @param {Function} onMove - Move callback\n   * @param {Function} onSnapback - Snapback callback\n   */\n  _handleDrop(fromSquare, toSquare, piece, onMove, onSnapback) {\n    console.log('=== _handleDrop CALLED ===');\n    console.log('From:', fromSquare.id, 'To:', toSquare.id);\n    console.log('Piece:', piece ? `${piece.color}${piece.type}` : 'null');\n    console.log('Stack trace:', new Error().stack.split('\\n')[1]);\n    console.log('Caller:', new Error().stack.split('\\n')[2]);\n\n    // CRITICAL FIX: Prevent multiple simultaneous drop operations\n    if (this.isAnimating || this._isProcessingDrop) {\n      console.log('Drop ignored - already processing or animating');\n      return;\n    }\n\n    // Set processing flag to prevent interference\n    this._isProcessingDrop = true;\n\n    const cleanup = () => {\n      this._isProcessingDrop = false;\n    };\n\n    // The core issue is state management. A drop action should be atomic.\n    // It either succeeds or fails, and the state should be cleaned completely afterward.\n    // We should not be setting `this.clicked` here at all.\n\n    try {\n      // Check for promotion first, as it's a special case.\n      if (this.moveService.requiresPromotion(new Move(fromSquare, toSquare))) {\n        logger.debug('Drag move requires promotion:', fromSquare.id, '->', toSquare.id);\n\n        this.moveService.setupPromotion(\n          new Move(fromSquare, toSquare),\n          this.boardService.squares,\n          (selectedPromotion) => {\n            logger.debug('Drag promotion selected:', selectedPromotion);\n            this.boardService.applyToAllSquares('removePromotion');\n            this.boardService.applyToAllSquares('removeCover');\n\n            // Attempt the move with promotion.\n            const moveResult = onMove(fromSquare, toSquare, selectedPromotion, true);\n            if (moveResult) {\n              this._schedulePromotionPieceReplacement(toSquare, selectedPromotion);\n              this._cleanupAfterSuccessfulMove(fromSquare);\n            } else {\n              this._handleSnapback(fromSquare, piece, onSnapback);\n              this._cleanupAfterFailedMove(fromSquare);\n            }\n            cleanup();\n          },\n          () => {\n            logger.debug('Drag promotion cancelled');\n            this.boardService.applyToAllSquares('removePromotion');\n            this.boardService.applyToAllSquares('removeCover');\n            this._handleSnapback(fromSquare, piece, onSnapback);\n            this._cleanupAfterFailedMove(fromSquare);\n            cleanup();\n          }\n        );\n      } else {\n        // Regular move.\n        const moveSuccess = onMove(fromSquare, toSquare, null, true);\n\n        if (moveSuccess) {\n          this._cleanupAfterSuccessfulMove(fromSquare);\n        } else {\n          this._handleSnapback(fromSquare, piece, onSnapback);\n          this._cleanupAfterFailedMove(fromSquare);\n        }\n        cleanup();\n      }\n    } catch (error) {\n      console.error('Error in _handleDrop:', error);\n      cleanup();\n    }\n  }\n\n  /**\n   * Cleans up visual state after a SUCCESSFUL move\n   * @private\n   * @param {Square} fromSquare - Source square\n   */\n  _cleanupAfterSuccessfulMove(fromSquare) {\n    // Always reset interaction state after any successful move (drag or click)\n    this.clicked = null;\n    this.isDragging = false;\n\n    // Clear specific visual states related to the move\n    if (fromSquare) {\n      fromSquare.deselect();\n    }\n\n    // Clean up ALL visual elements after a successful move\n    // This includes removing old move highlights to keep the board clean\n    this.boardService.applyToAllSquares('removeHint');\n    this.boardService.applyToAllSquares('dehighlight');\n    this.boardService.applyToAllSquares('removePromotion');\n    this.boardService.applyToAllSquares('removeCover');\n\n    logger.debug('EventService: All visual state cleaned up after SUCCESSFUL move');\n  }\n\n  /**\n   * Cleans up visual state after a FAILED move (snapback, invalid move)\n   * @private\n   * @param {Square} fromSquare - Source square\n   */\n  _cleanupAfterFailedMove(fromSquare) {\n    // Reset interaction state but be more conservative with visual cleanup\n    this.clicked = null;\n    this.isDragging = false;\n\n    // Clean specific visual elements related to failed operation\n    this.boardService.applyToAllSquares('removePromotion');\n    this.boardService.applyToAllSquares('removeCover');\n    this.boardService.applyToAllSquares('removeHint');\n\n    // Only deselect the specific square that failed\n    if (fromSquare) {\n      fromSquare.deselect();\n    }\n\n    // Don't aggressively clear all highlights - preserve move history\n    // this.boardService.applyToAllSquares('dehighlight');\n\n    logger.debug('EventService: Conservative cleanup after FAILED move');\n  }\n\n  /**\n   * Animates piece to center of target square (visual only)\n   * @private\n   * @param {Piece} piece - Piece to animate\n   * @param {Square} targetSquare - Target square\n   * @param {Function} callback - Callback when animation completes\n   */\n  _animatePieceToCenter(piece, targetSquare, callback = null) {\n    if (!piece || !targetSquare) {\n      if (callback) callback();\n      return;\n    }\n\n    const duration = this.config.dropCenterTime;\n\n    // Get current position of piece element\n    const sourceRect = piece.element.getBoundingClientRect();\n    const targetRect = targetSquare.element.getBoundingClientRect();\n\n    const x_start = sourceRect.left + sourceRect.width / 2;\n    const y_start = sourceRect.top + sourceRect.height / 2;\n    const x_end = targetRect.left + targetRect.width / 2;\n    const y_end = targetRect.top + targetRect.height / 2;\n    const dx = x_end - x_start;\n    const dy = y_end - y_start;\n\n    if (Math.abs(dx) < 1 && Math.abs(dy) < 1) {\n      // Already centered, just reset styles\n      piece.element.style.position = '';\n      piece.element.style.left = '';\n      piece.element.style.top = '';\n      piece.element.style.transform = '';\n      piece.element.style.zIndex = '';\n      if (callback) callback();\n      return;\n    }\n\n    const keyframes = [\n      { transform: 'translate(0, 0)' },\n      { transform: `translate(${dx}px, ${dy}px)` },\n    ];\n\n    if (piece.element.animate) {\n      const animation = piece.element.animate(keyframes, {\n        duration,\n        easing: 'ease',\n        fill: 'none', // Don't keep the final position\n      });\n\n      animation.onfinish = () => {\n        // Defensive: check if element still exists\n        if (!piece.element) {\n          if (callback) callback();\n          return;\n        }\n        // Reset all drag-related styles to let default CSS handle positioning\n        piece.element.style.position = '';\n        piece.element.style.left = '';\n        piece.element.style.top = '';\n        piece.element.style.transform = '';\n        piece.element.style.zIndex = '';\n        piece.element.style.transition = '';\n\n        if (callback) callback();\n      };\n    } else {\n      // Fallback for browsers without Web Animations API\n      piece.element.style.transition = `transform ${duration}ms ease`;\n      piece.element.style.transform = `translate(${dx}px, ${dy}px)`;\n\n      setTimeout(() => {\n        // Defensive: check if element still exists\n        if (!piece.element) {\n          if (callback) callback();\n          return;\n        }\n        // After animation, reset ALL positioning styles and let CSS handle centering\n        piece.element.style.position = 'relative';\n        piece.element.style.left = '0';\n        piece.element.style.top = '0';\n        piece.element.style.transform = 'translate(-50%, -50%)';\n        piece.element.style.zIndex = '20';\n        piece.element.style.transition = 'none';\n\n        if (callback) callback();\n      }, duration);\n    }\n  }\n\n  /**\n   * Handles square click events\n   * @param {Square} square - Clicked square\n   * @param {Function} onMove - Move callback\n   * @param {Function} onSelect - Select callback\n   * @param {Function} onDeselect - Deselect callback\n   * @param {boolean} [animate=true] - Whether to animate the move\n   * @returns {boolean} True if move was successful\n   */\n  onClick(square, onMove, onSelect, onDeselect, animate = true) {\n    // Always ensure we're not in dragging state during click operations\n    this.isDragging = false;\n\n    // If we're animating, ignore the click to prevent state corruption\n    if (this.isAnimating) {\n      logger.debug('EventService.onClick: Ignoring click during animation');\n      return false;\n    }\n\n    logger.debug('=== EventService.onClick START ===');\n    logger.debug(\n      'EventService.onClick: square =',\n      square.id,\n      'clicked =',\n      this.clicked?.id || 'none',\n      'isAnimating =',\n      this.isAnimating\n    );\n    logger.debug(\n      'EventService.onClick: Square piece =',\n      square.piece ? `${square.piece.color}${square.piece.type}` : 'empty'\n    );\n    logger.debug(\n      'EventService.onClick: Clicked square piece =',\n      this.clicked?.piece\n        ? `${this.clicked.piece.color}${this.clicked.piece.type}`\n        : this.clicked\n          ? 'empty'\n          : 'none'\n    );\n\n    let from = this.clicked;\n    let promotion = null;\n\n    // Handle promotion state\n    if (this.promoting) {\n      if (this.promoting === 'none') {\n        from = null;\n      } else {\n        promotion = this.promoting;\n      }\n\n      this.promoting = false;\n      this.boardService.applyToAllSquares('removePromotion');\n      this.boardService.applyToAllSquares('removeCover');\n    }\n\n    // No source square selected\n    if (!from) {\n      logger.debug('EventService.onClick: No source square, checking if can move:', square.id);\n      if (this.moveService.canMove(square)) {\n        logger.debug('EventService.onClick: Can move! Setting clicked to:', square.id);\n        this.clicked = square;\n        if (this.config.clickable) {\n          // Ensure visual selection happens after state is set\n          onSelect(square);\n          logger.debug('EventService.onClick: Square selected visually:', square.id);\n        }\n        logger.debug('EventService.onClick: After setting, clicked =', this.clicked?.id || 'none');\n        return false;\n      }\n      logger.debug('EventService.onClick: Cannot move square:', square.id);\n      return false;\n    }\n\n    logger.debug('EventService.onClick: We have a source square:', from.id, 'target:', square.id);\n\n    // Clicking same square - deselect\n    if (this.clicked === square) {\n      onDeselect(square);\n      this.clicked = null;\n      return false;\n    }\n\n    // Check if move requires promotion\n    if (!promotion && this.moveService.requiresPromotion(new Move(from, square))) {\n      logger.debug('Move requires promotion:', from.id, '->', square.id);\n\n      // Set up promotion UI\n      this.moveService.setupPromotion(\n        new Move(from, square),\n        this.boardService.squares,\n        (selectedPromotion) => {\n          logger.debug('Promotion selected:', selectedPromotion);\n\n          // Clear promotion UI first\n          this.boardService.applyToAllSquares('removePromotion');\n          this.boardService.applyToAllSquares('removeCover');\n\n          // Execute the move with promotion\n          const moveResult = onMove(from, square, selectedPromotion, animate);\n\n          if (moveResult) {\n            // After a successful promotion move, we need to replace the piece\n            // after the drop animation completes\n            this._schedulePromotionPieceReplacement(square, selectedPromotion);\n\n            onDeselect(from);\n            this.clicked = null;\n          }\n        },\n        () => {\n          logger.debug('Promotion cancelled');\n\n          // Clear promotion UI on cancel\n          this.boardService.applyToAllSquares('removePromotion');\n          this.boardService.applyToAllSquares('removeCover');\n\n          onDeselect(from);\n          this.clicked = null;\n        }\n      );\n      return false;\n    }\n\n    // Attempt to make move\n    logger.debug('EventService.onClick: Attempting move from', from.id, 'to', square.id);\n    logger.debug('EventService.onClick: Current game state before move attempt');\n    const moveResult = onMove(from, square, promotion, animate);\n\n    if (moveResult) {\n      // Move successful\n      logger.debug('EventService.onClick: Move successful');\n      onDeselect(from);\n      this.clicked = null;\n      logger.debug('=== EventService.onClick END (move successful) ===');\n      return true;\n    }\n    // Move failed - deselect current and try to select new piece\n    logger.debug(\n      'EventService.onClick: Move failed from',\n      from.id,\n      'to',\n      square.id,\n      '- resetting state'\n    );\n\n    // Always deselect the current piece first\n    onDeselect(from);\n    this.clicked = null;\n    this.isDragging = false;\n\n    // Clear move-related visual states but preserve highlights\n    this.boardService.applyToAllSquares('removeHint');\n\n    // Now check if the target square has a piece we can move and select it\n    if (this.moveService.canMove(square)) {\n      logger.debug('EventService.onClick: Can select new piece at', square.id);\n\n      this.clicked = square;\n      if (this.config.clickable) {\n        onSelect(square);\n        logger.debug('EventService.onClick: New piece selected visually:', square.id);\n      }\n      logger.debug('EventService.onClick: New piece selected at', square.id);\n    } else {\n      logger.debug(\n        'EventService.onClick: Cannot select piece at',\n        square.id,\n        '- staying deselected'\n      );\n    }\n\n    logger.debug('=== EventService.onClick END (move failed) ===');\n    return false;\n  }\n\n  /**\n   * Schedules piece replacement after promotion animation\n   * @private\n   * @param {Square} square - Target square\n   * @param {string} promotionPiece - Piece to promote to\n   */\n  _schedulePromotionPieceReplacement(square, promotionPiece) {\n    // Mark that we're doing a promotion to prevent interference\n    this.chessboard._isPromoting = true;\n\n    // Use a more robust approach: poll for the piece to be present\n    this._waitForPieceAndReplace(square, promotionPiece, 0);\n  }\n\n  /**\n   * Waits for piece to be present and then replaces it\n   * @private\n   * @param {Square} square - Target square\n   * @param {string} promotionPiece - Piece to promote to\n   * @param {number} attempt - Current attempt number\n   */\n  _waitForPieceAndReplace(square, promotionPiece, attempt) {\n    const maxAttempts = 20; // Maximum 1 second of waiting (20 * 50ms)\n    const targetSquare = this.boardService.getSquare(square.id);\n\n    if (!targetSquare) {\n      logger.warn('Target square not found:', square.id);\n      this.chessboard._isPromoting = false;\n      return;\n    }\n\n    // Check if piece is present and ready\n    if (targetSquare.piece && targetSquare.piece.element) {\n      logger.debug('Piece found on', square.id, 'after', attempt, 'attempts');\n      this._replacePromotionPiece(square, promotionPiece);\n\n      // Allow normal updates again after transformation\n      setTimeout(() => {\n        this.chessboard._isPromoting = false;\n        logger.debug('Promotion protection ended');\n        // Force a board update to ensure everything is correctly synchronized\n        this.chessboard._updateBoardPieces(false);\n      }, 400); // Wait for transformation animation to complete\n\n      return;\n    }\n\n    // If piece not found and we haven't exceeded max attempts, try again\n    if (attempt < maxAttempts) {\n      setTimeout(() => {\n        this._waitForPieceAndReplace(square, promotionPiece, attempt + 1);\n      }, 50);\n    } else {\n      logger.warn('Failed to find piece for promotion after', maxAttempts, 'attempts');\n      this.chessboard._isPromoting = false;\n\n      // Force a board update to recover from the failed promotion\n      this.chessboard._updateBoardPieces(false);\n    }\n  }\n\n  /**\n   * Replaces the piece on the square with the promotion piece\n   * @private\n   * @param {Square} square - Target square\n   * @param {string} promotionPiece - Piece to promote to\n   */\n  _replacePromotionPiece(square, promotionPiece) {\n    logger.debug('Replacing piece on', square.id, 'with', promotionPiece);\n\n    // Get the target square from the board service\n    const targetSquare = this.boardService.getSquare(square.id);\n    if (!targetSquare) {\n      logger.debug('Target square not found:', square.id);\n      return;\n    }\n\n    // Get the game state to determine the correct piece color\n    const gameState = this.chessboard.positionService.getGame();\n    const gamePiece = gameState.get(targetSquare.id);\n\n    if (!gamePiece) {\n      logger.debug('No piece found in game state for', targetSquare.id);\n      return;\n    }\n\n    // Get the current piece on the square\n    const currentPiece = targetSquare.piece;\n\n    if (!currentPiece) {\n      logger.warn('No piece found on target square for promotion');\n\n      // Try to recover by creating a new piece\n      const pieceId = promotionPiece + gamePiece.color;\n      const piecePath = this.chessboard.pieceService.getPiecePath(pieceId);\n\n      const newPiece = new Piece(gamePiece.color, promotionPiece, piecePath);\n\n      // Place the new piece on the square\n      targetSquare.putPiece(newPiece);\n\n      // Set up drag functionality\n      const dragFunction = this.chessboard._createDragFunction.bind(this.chessboard);\n      newPiece.setDrag(dragFunction(targetSquare, newPiece));\n\n      logger.debug('Created new promotion piece:', pieceId, 'on', targetSquare.id);\n      return;\n    }\n\n    // Create the piece ID and get the path\n    const pieceId = promotionPiece + gamePiece.color;\n    const piecePath = this.chessboard.pieceService.getPiecePath(pieceId);\n\n    logger.debug('Transforming piece to:', pieceId, 'with path:', piecePath);\n\n    // Use the new smooth transformation animation\n    currentPiece.transformTo(\n      promotionPiece,\n      piecePath,\n      300, // Duration of the transformation animation\n      () => {\n        // After transformation, set up drag functionality\n        const dragFunction = this.chessboard._createDragFunction.bind(this.chessboard);\n        currentPiece.setDrag(dragFunction(targetSquare, currentPiece));\n\n        // Ensure hints are properly updated after promotion\n        if (this.config.hints && this.chessboard.moveService) {\n          setTimeout(() => {\n            this.chessboard.moveService.clearCache();\n          }, 100);\n        }\n\n        logger.debug('Successfully transformed piece on', targetSquare.id, 'to', pieceId);\n      }\n    );\n  }\n\n  /**\n   * Sets the clicked square\n   * @param {Square|null} square - Square to set as clicked\n   */\n  setClicked(square) {\n    this.clicked = square;\n  }\n\n  /**\n   * Gets the currently clicked square\n   * @returns {Square|null} Currently clicked square\n   */\n  getClicked() {\n    return this.clicked;\n  }\n\n  /**\n   * Sets the promotion state\n   * @param {string|boolean} promotion - Promotion piece type or false\n   */\n  setPromoting(promotion) {\n    this.promoting = promotion;\n  }\n\n  /**\n   * Gets the promotion state\n   * @returns {string|boolean} Current promotion state\n   */\n  getPromoting() {\n    return this.promoting;\n  }\n\n  /**\n   * Sets the animation state\n   * @param {boolean} isAnimating - Whether animations are in progress\n   */\n  setAnimating(isAnimating) {\n    this.isAnimating = isAnimating;\n  }\n\n  /**\n   * Gets the animation state\n   * @returns {boolean} Whether animations are in progress\n   */\n  getAnimating() {\n    return this.isAnimating;\n  }\n\n  /**\n   * Removes all existing event listeners\n   */\n  removeListeners() {\n    this.eventListeners.forEach((listeners) => {\n      listeners.forEach(({ element, type, handler }) => {\n        element.removeEventListener(type, handler);\n      });\n    });\n\n    this.eventListeners.clear();\n  }\n\n  /**\n   * Removes all event listeners\n   */\n  removeAllListeners() {\n    this.eventListeners.forEach((listeners) => {\n      listeners.forEach(({ element, type, handler }) => {\n        element.removeEventListener(type, handler);\n      });\n    });\n\n    this.eventListeners.clear();\n  }\n\n  /**\n   * Cleans up resources\n   */\n  destroy() {\n    this.removeAllListeners();\n    this.clicked = null;\n    this.promoting = false;\n    this.isAnimating = false;\n    this.isDragging = false;\n  }\n}\n","/**\n * Service for managing chess moves and move validation\n * @module services/MoveService\n * @since 2.0.0\n */\n\nimport Move from '../components/Move.js';\nimport { MoveError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\nimport { PROMOTION_PIECES } from '../constants/positions.js';\n\n/**\n * Service responsible for move management and validation\n * @class\n */\nexport class MoveService {\n  /**\n   * Creates a new MoveService instance\n   * @param {ChessboardConfig} config - Board configuration\n   * @param {PositionService} positionService - Position service instance\n   */\n  constructor(config, positionService) {\n    this.config = config;\n    this.positionService = positionService;\n    this._movesCache = new Map();\n    this._cacheTimeout = null;\n\n    // Add debouncing for promotion checks to prevent duplicates\n    this._lastPromotionCheck = null;\n    this._lastPromotionResult = null;\n    this._promotionCheckTimeout = null;\n\n    // Track recently processed moves to prevent duplicates\n    this._recentMoves = new Set();\n    this._recentMovesTimeout = null;\n  }\n\n  /**\n   * Checks if a piece on a square can move\n   * @param {Square} square - Square to check\n   * @returns {boolean} True if piece can move\n   */\n  canMove(square) {\n    if (!square.piece) return false;\n\n    const { movableColors, onlyLegalMoves } = this.config;\n\n    if (movableColors === 'none') return false;\n    if (movableColors === 'w' && square.piece.color === 'b') return false;\n    if (movableColors === 'b' && square.piece.color === 'w') return false;\n\n    if (!onlyLegalMoves) return true;\n\n    // Check if position service and game are available\n    if (!this.positionService || !this.positionService.getGame()) {\n      return false;\n    }\n\n    const game = this.positionService.getGame();\n    return square.piece.color === game.turn();\n  }\n\n  /**\n   * Converts various move formats to a Move instance\n   * @param {string|Move} move - Move in various formats\n   * @param {Object} squares - All board squares\n   * @returns {Move} Move instance\n   * @throws {MoveError} When move format is invalid\n   */\n  convertMove(move, squares) {\n    if (move instanceof Move) {\n      return move;\n    }\n\n    if (typeof move === 'string' && move.length >= 4) {\n      const fromId = move.slice(0, 2);\n      const toId = move.slice(2, 4);\n      const promotion = move.slice(4, 5) || null;\n\n      if (!squares[fromId] || !squares[toId]) {\n        throw new MoveError(ERROR_MESSAGES.invalid_move_format, fromId, toId);\n      }\n\n      return new Move(squares[fromId], squares[toId], promotion);\n    }\n\n    throw new MoveError(ERROR_MESSAGES.invalid_move_format, 'unknown', 'unknown');\n  }\n\n  /**\n   * Checks if a move is legal\n   * @param {Move} move - Move to check\n   * @returns {boolean} True if move is legal\n   */\n  isLegalMove(move) {\n    const legalMoves = this.getLegalMoves(move.from.id);\n\n    return legalMoves.some(\n      (legalMove) => legalMove.to === move.to.id && move.promotion === legalMove.promotion\n    );\n  }\n\n  /**\n   * Gets all legal moves for a square or the entire position\n   * @param {string} [from] - Square to get moves from (optional)\n   * @param {boolean} [verbose=true] - Whether to return verbose move objects\n   * @returns {Array} Array of legal moves\n   */\n  getLegalMoves(from = null, verbose = true) {\n    // Check if position service and game are available\n    if (!this.positionService || !this.positionService.getGame()) {\n      return [];\n    }\n\n    const game = this.positionService.getGame();\n\n    if (!game) return [];\n\n    const options = { verbose };\n    if (from) {\n      options.square = from;\n    }\n\n    return game.moves(options);\n  }\n\n  /**\n   * Gets legal moves with caching for performance\n   * @param {Square} square - Square to get moves from\n   * @returns {Array} Array of legal moves\n   */\n  getCachedLegalMoves(square) {\n    // Check if position service and game are available\n    if (!this.positionService || !this.positionService.getGame()) {\n      return [];\n    }\n\n    const game = this.positionService.getGame();\n    if (!game) return [];\n\n    const cacheKey = `${square.id}-${game.fen()}`;\n    let moves = this._movesCache.get(cacheKey);\n\n    if (!moves) {\n      moves = game.moves({ square: square.id, verbose: true });\n      this._movesCache.set(cacheKey, moves);\n\n      // Clear cache after a short delay to prevent memory buildup\n      if (this._cacheTimeout) {\n        clearTimeout(this._cacheTimeout);\n      }\n\n      this._cacheTimeout = setTimeout(() => {\n        this._movesCache.clear();\n      }, 1000);\n    }\n\n    return moves;\n  }\n\n  /**\n   * Executes a move on the game\n   * @param {Move} move - Move to execute\n   * @returns {Object|null} Move result from chess.js or null if invalid\n   */\n  executeMove(move) {\n    // Check if position service and game are available\n    if (!this.positionService || !this.positionService.getGame()) {\n      return null;\n    }\n\n    const game = this.positionService.getGame();\n    if (!game) return null;\n\n    const moveOptions = {\n      from: move.from.id,\n      to: move.to.id,\n    };\n\n    console.log('executeMove - move.promotion:', move.promotion);\n    console.log('executeMove - move.hasPromotion():', move.hasPromotion());\n\n    if (move.hasPromotion()) {\n      moveOptions.promotion = move.promotion;\n    }\n\n    console.log('executeMove - moveOptions:', moveOptions);\n\n    const result = game.move(moveOptions);\n    console.log('executeMove - result:', result);\n\n    // Check what's actually on the board after the move\n    if (result) {\n      const pieceOnDestination = game.get(move.to.id);\n      console.log('executeMove - piece on destination after move:', pieceOnDestination);\n    }\n\n    return result;\n  }\n\n  /**\n   * Checks if a move requires promotion\n   * @param {Move} move - Move to check\n   * @returns {boolean} True if promotion is required\n   */\n  requiresPromotion(move) {\n    const moveKey = `${move.from.id}->${move.to.id}`;\n    console.log('Checking if move requires promotion:', moveKey);\n\n    // Get detailed stack trace\n    const stack = new Error().stack.split('\\n');\n    console.log('Call stack:', stack[1]);\n    console.log('Caller:', stack[2]);\n    console.log('Caller 2:', stack[3]);\n    console.log('Caller 3:', stack[4]);\n\n    // Track recently processed moves to prevent processing the same move multiple times\n    const now = Date.now();\n    if (this._recentMoves.has(moveKey)) {\n      console.log('Move recently processed, skipping duplicate check');\n      return false; // Conservative: assume no promotion needed for duplicates\n    }\n\n    // Debounce identical promotion checks within 100ms\n    if (\n      this._lastPromotionCheck === moveKey &&\n      this._lastPromotionResult !== null &&\n      now - this._lastPromotionTime < 100\n    ) {\n      console.log('Using cached promotion result:', this._lastPromotionResult);\n      return this._lastPromotionResult;\n    }\n\n    // Add to recent moves set\n    this._recentMoves.add(moveKey);\n\n    const result = this._doRequiresPromotion(move);\n\n    // Cache the result\n    this._lastPromotionCheck = moveKey;\n    this._lastPromotionResult = result;\n    this._lastPromotionTime = now;\n\n    // Clear caches after delays\n    if (this._promotionCheckTimeout) {\n      clearTimeout(this._promotionCheckTimeout);\n    }\n    this._promotionCheckTimeout = setTimeout(() => {\n      this._lastPromotionCheck = null;\n      this._lastPromotionResult = null;\n    }, 500);\n\n    if (this._recentMovesTimeout) {\n      clearTimeout(this._recentMovesTimeout);\n    }\n    this._recentMovesTimeout = setTimeout(() => {\n      this._recentMoves.clear();\n    }, 1000); // Clear recent moves after 1 second\n\n    return result;\n  }\n\n  /**\n   * Internal promotion check logic\n   * @private\n   * @param {Move} move - Move to check\n   * @returns {boolean} True if promotion is required\n   */\n  _doRequiresPromotion(move) {\n    if (!this.config.onlyLegalMoves) {\n      console.log('Not in legal moves mode, no promotion required');\n      return false;\n    }\n\n    const game = this.positionService.getGame();\n    if (!game) {\n      console.log('No game instance available');\n      return false;\n    }\n\n    const piece = game.get(move.from.id);\n    if (!piece || piece.type !== 'p') {\n      console.log('Not a pawn move, no promotion required');\n      return false;\n    }\n\n    const targetRank = move.to.row;\n    if (targetRank !== 1 && targetRank !== 8) {\n      console.log('Not reaching promotion rank, no promotion required');\n      return false;\n    }\n\n    console.log('Pawn reaching promotion rank - promotion required');\n\n    // Additional validation: check if the pawn can actually reach this square\n    if (!this._isPawnMoveValid(move.from, move.to, piece.color)) {\n      console.log('Pawn move not valid, no promotion required');\n      return false;\n    }\n\n    // If we get here, it's a pawn move to the promotion rank\n    // Check if it's a legal move by using the game's moves() method\n    const legalMoves = game.moves({ square: move.from.id, verbose: true });\n    const matchingMove = legalMoves.find((m) => m.to === move.to.id);\n\n    if (!matchingMove) {\n      console.log('Move not in legal moves list, no promotion required');\n      return false;\n    }\n\n    // If the legal move has a promotion flag or is to a promotion rank, promotion is required\n    const requiresPromotion =\n      matchingMove.flags.includes('p') ||\n      (piece.color === 'w' && targetRank === 8) ||\n      (piece.color === 'b' && targetRank === 1);\n\n    console.log('Promotion required:', requiresPromotion);\n    return requiresPromotion;\n  }\n\n  /**\n   * Validates if a pawn move is theoretically possible\n   * @private\n   * @param {Square} from - Source square\n   * @param {Square} to - Target square\n   * @param {string} color - Pawn color ('w' or 'b')\n   * @returns {boolean} True if the move is valid for a pawn\n   */\n  _isPawnMoveValid(from, to, color) {\n    const fromRank = from.row;\n    const toRank = to.row;\n    const fromFile = from.col;\n    const toFile = to.col;\n\n    console.log(`Validating pawn move: ${from.id} -> ${to.id} (${color})`);\n    console.log(`Ranks: ${fromRank} -> ${toRank}, Files: ${fromFile} -> ${toFile}`);\n\n    // Direction of pawn movement\n    const direction = color === 'w' ? 1 : -1;\n    const rankDiff = toRank - fromRank;\n    const fileDiff = Math.abs(toFile - fromFile);\n\n    // Pawn can only move forward\n    if (rankDiff * direction <= 0) {\n      console.log('Invalid: Pawn cannot move backward or stay in place');\n      return false;\n    }\n\n    // Pawn can only move 1 rank at a time (except for double move from starting position)\n    if (Math.abs(rankDiff) > 2) {\n      console.log('Invalid: Pawn cannot move more than 2 ranks');\n      return false;\n    }\n\n    // If moving 2 ranks, must be from starting position\n    if (Math.abs(rankDiff) === 2) {\n      const startingRank = color === 'w' ? 2 : 7;\n      if (fromRank !== startingRank) {\n        console.log(`Invalid: Pawn cannot move 2 ranks from rank ${fromRank}`);\n        return false;\n      }\n    }\n\n    // Pawn can only move to adjacent files (diagonal capture) or same file (forward move)\n    if (fileDiff > 1) {\n      console.log('Invalid: Pawn cannot move more than 1 file');\n      return false;\n    }\n\n    console.log('Pawn move validation passed');\n    return true;\n  }\n\n  /**\n   * Handles promotion UI setup\n   * @param {Move} move - Move requiring promotion\n   * @param {Object} squares - All board squares\n   * @param {Function} onPromotionSelect - Callback when promotion piece is selected\n   * @param {Function} onPromotionCancel - Callback when promotion is cancelled\n   * @returns {boolean} True if promotion UI was set up\n   */\n  setupPromotion(move, squares, onPromotionSelect, onPromotionCancel) {\n    if (!this.requiresPromotion(move)) return false;\n\n    // Check if position service and game are available\n    if (!this.positionService || !this.positionService.getGame()) {\n      return false;\n    }\n\n    const game = this.positionService.getGame();\n    const piece = game.get(move.from.id);\n    const targetSquare = move.to;\n\n    // Clear any existing promotion UI\n    Object.values(squares).forEach((square) => {\n      square.removePromotion();\n      square.removeCover();\n    });\n\n    // Always show promotion choices in a column\n    this._showPromotionInColumn(targetSquare, piece, squares, onPromotionSelect, onPromotionCancel);\n\n    return true;\n  }\n\n  /**\n   * Shows promotion choices in a column\n   * @private\n   */\n  _showPromotionInColumn(targetSquare, piece, squares, onPromotionSelect, onPromotionCancel) {\n    console.log('Setting up promotion for', targetSquare.id, 'piece color:', piece.color);\n\n    // Set up promotion choices starting from border row\n    PROMOTION_PIECES.forEach((pieceType, index) => {\n      const choiceSquare = this._findPromotionSquare(targetSquare, index, squares);\n\n      if (choiceSquare) {\n        const pieceId = pieceType + piece.color;\n        const piecePath = this._getPiecePathForPromotion(pieceId);\n\n        console.log('Setting up promotion choice:', pieceType, 'on square:', choiceSquare.id);\n\n        choiceSquare.putPromotion(piecePath, () => {\n          console.log('Promotion choice selected:', pieceType);\n          onPromotionSelect(pieceType);\n        });\n      } else {\n        console.log('Could not find square for promotion choice:', pieceType, 'index:', index);\n      }\n    });\n\n    // Set up cover squares (for cancellation)\n    Object.values(squares).forEach((square) => {\n      if (!square.hasPromotion()) {\n        square.putCover(() => {\n          onPromotionCancel();\n        });\n      }\n    });\n\n    return true;\n  }\n\n  /**\n   * Finds the appropriate square for a promotion piece\n   * @private\n   * @param {Square} targetSquare - Target square of the promotion move\n   * @param {number} distance - Distance from target square\n   * @param {Object} squares - All board squares\n   * @returns {Square|null} Square for promotion piece or null\n   */\n  _findPromotionSquare(targetSquare, index, squares) {\n    const col = targetSquare.col;\n    const baseRow = targetSquare.row;\n\n    console.log(\n      'Looking for promotion square - target:',\n      targetSquare.id,\n      'index:',\n      index,\n      'col:',\n      col,\n      'baseRow:',\n      baseRow\n    );\n\n    // Calculate row based on index and promotion direction\n    // Start from the border row (1 or 8) and go inward\n    let row;\n    if (baseRow === 8) {\n      // White promotion: start from row 8 and go down\n      row = 8 - index;\n    } else if (baseRow === 1) {\n      // Black promotion: start from row 1 and go up\n      row = 1 + index;\n    } else {\n      console.log('Invalid promotion row:', baseRow);\n      return null;\n    }\n\n    console.log('Calculated row:', row);\n\n    // Ensure row is within bounds\n    if (row < 1 || row > 8) {\n      console.log('Row out of bounds:', row);\n      return null;\n    }\n\n    // Find square by row/col\n    for (const square of Object.values(squares)) {\n      if (square.col === col && square.row === row) {\n        console.log('Found promotion square:', square.id);\n        return square;\n      }\n    }\n\n    console.log('No square found for col:', col, 'row:', row);\n    return null;\n  }\n\n  /**\n   * Gets piece path for promotion UI\n   * @private\n   * @param {string} pieceId - Piece identifier\n   * @returns {string} Path to piece asset\n   */\n  _getPiecePathForPromotion(pieceId) {\n    // This would typically use the PieceService\n    // For now, we'll use a simple implementation\n    const { piecesPath } = this.config;\n\n    if (typeof piecesPath === 'string') {\n      return `${piecesPath}/${pieceId}.svg`;\n    }\n\n    // Fallback for other path types\n    return `assets/pieces/${pieceId}.svg`;\n  }\n\n  /**\n   * Parses a move string into a move object\n   * @param {string} moveString - Move string (e.g., 'e2e4', 'e7e8q')\n   * @returns {Object|null} Move object or null if invalid\n   */\n  parseMove(moveString) {\n    if (typeof moveString !== 'string' || moveString.length < 4 || moveString.length > 5) {\n      return null;\n    }\n\n    const from = moveString.slice(0, 2);\n    const to = moveString.slice(2, 4);\n    const promotion = moveString.slice(4, 5);\n\n    // Basic validation\n    if (!/^[a-h][1-8]$/.test(from) || !/^[a-h][1-8]$/.test(to)) {\n      return null;\n    }\n\n    if (promotion && !['q', 'r', 'b', 'n'].includes(promotion.toLowerCase())) {\n      return null;\n    }\n\n    return {\n      from,\n      to,\n      promotion: promotion || null,\n    };\n  }\n\n  /**\n   * Checks if a move is a castle move\n   * @param {Object} gameMove - Game move object from chess.js\n   * @returns {boolean} True if move is castle\n   */\n  isCastle(gameMove) {\n    return gameMove && (gameMove.isKingsideCastle() || gameMove.isQueensideCastle());\n  }\n\n  /**\n   * Gets the rook move for a castle move\n   * @param {Object} gameMove - Game move object from chess.js\n   * @returns {Object|null} Rook move object or null if not castle\n   */\n  getCastleRookMove(gameMove) {\n    if (!this.isCastle(gameMove)) {\n      return null;\n    }\n\n    const isKingSide = gameMove.isKingsideCastle();\n    const isWhite = gameMove.color === 'w';\n\n    if (isKingSide) {\n      // King side castle\n      if (isWhite) {\n        return { from: 'h1', to: 'f1' };\n      }\n      return { from: 'h8', to: 'f8' };\n    }\n    // Queen side castle\n    if (isWhite) {\n      return { from: 'a1', to: 'd1' };\n    }\n    return { from: 'a8', to: 'd8' };\n  }\n\n  /**\n   * Checks if a move is en passant\n   * @param {Object} gameMove - Game move object from chess.js\n   * @returns {boolean} True if move is en passant\n   */\n  isEnPassant(gameMove) {\n    return gameMove && gameMove.isEnPassant();\n  }\n\n  /**\n   * Gets the captured pawn square for en passant\n   * @param {Object} gameMove - Game move object from chess.js\n   * @returns {string|null} Square of captured pawn or null if not en passant\n   */\n  getEnPassantCapturedSquare(gameMove) {\n    if (!this.isEnPassant(gameMove)) {\n      return null;\n    }\n\n    const toSquare = gameMove.to;\n    const rank = parseInt(toSquare[1]);\n    const file = toSquare[0];\n\n    // The captured pawn is on the same file but different rank\n    if (gameMove.color === 'w') {\n      // White captures black pawn one rank below\n      return file + (rank - 1);\n    }\n    // Black captures white pawn one rank above\n    return file + (rank + 1);\n  }\n\n  /**\n   * Clears the moves cache\n   */\n  clearCache() {\n    this._movesCache.clear();\n    if (this._cacheTimeout) {\n      clearTimeout(this._cacheTimeout);\n      this._cacheTimeout = null;\n    }\n  }\n\n  /**\n   * Cleans up resources\n   */\n  destroy() {\n    this.clearCache();\n    this.positionService = null;\n  }\n}\n","/**\n * Service for managing chess pieces and their operations\n * @module services/PieceService\n * @since 2.0.0\n */\n\nimport Piece from '../components/Piece.js';\nimport { PieceError, ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\nimport { PIECE_TYPES, PIECE_COLORS } from '../constants/positions.js';\nimport { DragOptimizations } from '../utils/cross-browser.js';\n\n/**\n * Service responsible for piece management and operations\n * @class\n */\nexport class PieceService {\n  /**\n   * Creates a new PieceService instance\n   * @param {ChessboardConfig} config - Board configuration\n   */\n  constructor(config) {\n    this.config = config;\n  }\n\n  /**\n   * Gets the path to a piece asset\n   * @param {string} piece - Piece identifier (e.g., 'wK', 'bP')\n   * @returns {string} Path to piece asset\n   * @throws {ValidationError} When piecesPath configuration is invalid\n   */\n  getPiecePath(piece) {\n    const { piecesPath } = this.config;\n\n    if (typeof piecesPath === 'string') {\n      return `${piecesPath}/${piece}.svg`;\n    } else if (typeof piecesPath === 'object' && piecesPath !== null) {\n      return piecesPath[piece];\n    } else if (typeof piecesPath === 'function') {\n      return piecesPath(piece);\n    }\n    throw new ValidationError(ERROR_MESSAGES.invalid_piecesPath, 'piecesPath', piecesPath);\n  }\n\n  /**\n   * Converts various piece formats to a Piece instance\n   * @param {string|Piece} piece - Piece in various formats\n   * @returns {Piece} Piece instance\n   * @throws {PieceError} When piece format is invalid\n   */\n  convertPiece(piece) {\n    if (piece instanceof Piece) {\n      return piece;\n    }\n\n    if (typeof piece === 'string' && piece.length === 2) {\n      const [first, second] = piece.split('');\n      let type, color;\n\n      // Check format: [type][color] (e.g., 'pw')\n      if (PIECE_TYPES.includes(first.toLowerCase()) && PIECE_COLORS.includes(second)) {\n        type = first.toLowerCase();\n        color = second;\n      }\n      // Check format: [color][type] (e.g., 'wP')\n      else if (PIECE_COLORS.includes(first) && PIECE_TYPES.includes(second.toLowerCase())) {\n        color = first;\n        type = second.toLowerCase();\n      } else {\n        throw new PieceError(ERROR_MESSAGES.invalid_piece + piece, piece);\n      }\n\n      const piecePath = this.getPiecePath(type + color);\n      return new Piece(color, type, piecePath);\n    }\n\n    throw new PieceError(ERROR_MESSAGES.invalid_piece + piece, piece);\n  }\n\n  /**\n   * Adds a piece to a square with optional fade-in animation\n   * @param {Square} square - Target square\n   * @param {Piece} piece - Piece to add\n   * @param {boolean} [fade=true] - Whether to fade in the piece\n   * @param {Function} dragFunction - Function to handle drag events\n   * @param {Function} [callback] - Callback when animation completes\n   */\n  addPieceOnSquare(square, piece, fade = true, dragFunction, callback) {\n    console.debug(`[PieceService] addPieceOnSquare: ${piece.id} to ${square.id}`);\n    square.putPiece(piece);\n\n    if (dragFunction) {\n      piece.setDrag(dragFunction(square, piece));\n    }\n\n    if (fade && this.config.fadeTime > 0) {\n      piece.fadeIn(\n        this.config.fadeTime,\n        this.config.fadeAnimation,\n        this._getTransitionTimingFunction(),\n        callback\n      );\n    } else {\n      if (callback) callback();\n    }\n\n    piece.visible();\n  }\n\n  /**\n   * Removes a piece from a square with optional fade-out animation\n   * @param {Square} square - Source square\n   * @param {boolean} [fade=true] - Whether to fade out the piece\n   * @param {Function} [callback] - Callback when animation completes\n   * @returns {Piece} The removed piece\n   * @throws {PieceError} When square has no piece to remove\n   */\n  removePieceFromSquare(square, fade = true, callback) {\n    console.debug(`[PieceService] removePieceFromSquare: ${square.id}`);\n    square.check();\n\n    const piece = square.piece;\n    if (!piece) {\n      if (callback) callback();\n      throw new PieceError(ERROR_MESSAGES.square_no_piece, null, square.getId());\n    }\n\n    if (fade && this.config.fadeTime > 0) {\n      piece.fadeOut(\n        this.config.fadeTime,\n        this.config.fadeAnimation,\n        this._getTransitionTimingFunction(),\n        callback\n      );\n    } else {\n      if (callback) callback();\n    }\n\n    square.removePiece();\n    return piece;\n  }\n\n  /**\n   * Moves a piece to a new position with animation\n   * @param {Piece} piece - Piece to move\n   * @param {Square} targetSquare - Target square\n   * @param {number} duration - Animation duration\n   * @param {Function} [callback] - Callback function when animation completes\n   */\n  movePiece(piece, targetSquare, duration, callback) {\n    console.debug(`[PieceService] movePiece: ${piece.id} to ${targetSquare.id}`);\n    if (!piece) {\n      console.warn('PieceService.movePiece: piece is null, skipping animation');\n      if (callback) callback();\n      return;\n    }\n\n    piece.translate(\n      targetSquare,\n      duration,\n      this._getTransitionTimingFunction(),\n      this.config.moveAnimation,\n      callback\n    );\n  }\n\n  /**\n   * Handles piece translation with optional capture\n   * @param {Move} move - Move object containing from/to squares and piece\n   * @param {boolean} removeTarget - Whether to remove piece from target square\n   * @param {boolean} animate - Whether to animate the move\n   * @param {Function} [dragFunction] - Function to create drag handlers\n   * @param {Function} [callback] - Callback function when complete\n   */\n  translatePiece(move, removeTarget, animate, dragFunction = null, callback = null) {\n    console.debug(\n      `[PieceService] translatePiece: ${move.piece.id} from ${move.from.id} to ${move.to.id}`\n    );\n    if (!move.piece) {\n      console.warn('PieceService.translatePiece: move.piece is null, skipping translation');\n      if (callback) callback();\n      return;\n    }\n\n    if (removeTarget) {\n      // Deselect the captured piece before removing it\n      move.to.deselect();\n      this.removePieceFromSquare(move.to, false);\n    }\n\n    const changeSquareCallback = () => {\n      // Check if piece still exists and is on the source square\n      if (move.from.piece === move.piece) {\n        move.from.removePiece(true); // Preserve the piece when moving\n      }\n\n      // Only put piece if destination square doesn't already have it\n      if (move.to.piece !== move.piece) {\n        move.to.putPiece(move.piece);\n\n        // Re-attach drag handler if provided\n        if (dragFunction && this.config.draggable && move.piece.element) {\n          move.piece.setDrag(dragFunction(move.to, move.piece));\n        }\n      }\n\n      if (callback) callback();\n    };\n\n    // Check if piece is currently being dragged\n    const isDragging = move.piece.element.classList.contains('dragging');\n\n    if (isDragging) {\n      // If piece is being dragged, don't animate - just move it immediately\n      // The piece is already visually in the correct position from the drag\n      changeSquareCallback();\n    } else {\n      // Normal animation\n      const duration = animate ? this.config.moveTime : 0;\n      this.movePiece(move.piece, move.to, duration, changeSquareCallback);\n    }\n  }\n\n  /**\n   * Snaps a piece back to its original position\n   * @param {Square} square - Square containing the piece\n   * @param {boolean} [animate=true] - Whether to animate the snapback\n   */\n  snapbackPiece(square, animate = true) {\n    if (!square || !square.piece) {\n      return;\n    }\n    const piece = square.piece;\n    const duration = animate ? this.config.snapbackTime : 0;\n    console.debug(`[PieceService] snapbackPiece: ${piece.id} on ${square.id}`);\n    piece.translate(\n      square,\n      duration,\n      this._getTransitionTimingFunction(),\n      this.config.snapbackAnimation\n    );\n  }\n\n  /**\n   * Centers a piece in its square with animation (after successful drop)\n   * @param {Square} square - Square containing the piece to center\n   * @param {boolean} animate - Whether to animate the centering\n   */\n  centerPiece(square, animate = true) {\n    if (!square || !square.piece) {\n      return;\n    }\n    const piece = square.piece;\n    const duration = animate ? this.config.dropCenterTime : 0;\n    console.debug(`[PieceService] centerPiece: ${piece.id} on ${square.id}`);\n    piece.translate(\n      square,\n      duration,\n      this._getTransitionTimingFunction(),\n      this.config.dropCenterAnimation,\n      () => {\n        // After animation, reset all drag-related styles\n        if (!piece.element) return;\n        piece.element.style.position = '';\n        piece.element.style.left = '';\n        piece.element.style.top = '';\n        piece.element.style.transform = '';\n        piece.element.style.zIndex = '';\n        // Remove inline dimensions set during drag\n        piece.element.style.width = '';\n        piece.element.style.height = '';\n        // Remove dragging class\n        piece.element.classList.remove('dragging');\n\n        // Clean up drag optimizations that might interfere with click\n        DragOptimizations.cleanupAfterDrag(piece.element);\n      }\n    );\n  }\n\n  /**\n   * Gets the transition timing function for animations\n   * @private\n   * @returns {Function} Timing function\n   */\n  _getTransitionTimingFunction() {\n    return (elapsed, duration, type = 'ease') => {\n      const x = elapsed / duration;\n\n      switch (type) {\n        case 'linear':\n          return x;\n        case 'ease':\n          return x ** 2 * (3 - 2 * x);\n        case 'ease-in':\n          return x ** 2;\n        case 'ease-out':\n          return -1 * (x - 1) ** 2 + 1;\n        case 'ease-in-out':\n          return x < 0.5 ? 2 * x ** 2 : 4 * x - 2 * x ** 2 - 1;\n        default:\n          return x;\n      }\n    };\n  }\n\n  /**\n   * Cleans up resources\n   */\n  destroy() {\n    // Cleanup any cached pieces or references\n  }\n}\n","/**\n * @license\n * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met:\n *\n * 1. Redistributions of source code must retain the above copyright notice,\n *    this list of conditions and the following disclaimer.\n * 2. Redistributions in binary form must reproduce the above copyright notice,\n *    this list of conditions and the following disclaimer in the documentation\n *    and/or other materials provided with the distribution.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\n * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE\n * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\n * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n */\nexport const WHITE = 'w';\nexport const BLACK = 'b';\nexport const PAWN = 'p';\nexport const KNIGHT = 'n';\nexport const BISHOP = 'b';\nexport const ROOK = 'r';\nexport const QUEEN = 'q';\nexport const KING = 'k';\nexport const DEFAULT_POSITION = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';\nexport class Move {\n  color;\n  from;\n  to;\n  piece;\n  captured;\n  promotion;\n  /**\n   * @deprecated This field is deprecated and will be removed in version 2.0.0.\n   * Please use move descriptor functions instead: `isCapture`, `isPromotion`,\n   * `isEnPassant`, `isKingsideCastle`, `isQueensideCastle`, `isCastle`, and\n   * `isBigPawn`\n   */\n  flags;\n  san;\n  lan;\n  before;\n  after;\n  constructor(chess, internal) {\n    const { color, piece, from, to, flags, captured, promotion } = internal;\n    const fromAlgebraic = algebraic(from);\n    const toAlgebraic = algebraic(to);\n    this.color = color;\n    this.piece = piece;\n    this.from = fromAlgebraic;\n    this.to = toAlgebraic;\n    /*\n     * HACK: The chess['_method']() calls below invoke private methods in the\n     * Chess class to generate SAN and FEN. It's a bit of a hack, but makes the\n     * code cleaner elsewhere.\n     */\n    this.san = chess['_moveToSan'](internal, chess['_moves']({ legal: true }));\n    this.lan = fromAlgebraic + toAlgebraic;\n    this.before = chess.fen();\n    // Generate the FEN for the 'after' key\n    chess['_makeMove'](internal);\n    this.after = chess.fen();\n    chess['_undoMove']();\n    // Build the text representation of the move flags\n    this.flags = '';\n    for (const flag in BITS) {\n      if (BITS[flag] & flags) {\n        this.flags += FLAGS[flag];\n      }\n    }\n    if (captured) {\n      this.captured = captured;\n    }\n    if (promotion) {\n      this.promotion = promotion;\n      this.lan += promotion;\n    }\n  }\n  isCapture() {\n    return this.flags.indexOf(FLAGS['CAPTURE']) > -1;\n  }\n  isPromotion() {\n    return this.flags.indexOf(FLAGS['PROMOTION']) > -1;\n  }\n  isEnPassant() {\n    return this.flags.indexOf(FLAGS['EP_CAPTURE']) > -1;\n  }\n  isKingsideCastle() {\n    return this.flags.indexOf(FLAGS['KSIDE_CASTLE']) > -1;\n  }\n  isQueensideCastle() {\n    return this.flags.indexOf(FLAGS['QSIDE_CASTLE']) > -1;\n  }\n  isBigPawn() {\n    return this.flags.indexOf(FLAGS['BIG_PAWN']) > -1;\n  }\n}\nconst EMPTY = -1;\nconst FLAGS = {\n  NORMAL: 'n',\n  CAPTURE: 'c',\n  BIG_PAWN: 'b',\n  EP_CAPTURE: 'e',\n  PROMOTION: 'p',\n  KSIDE_CASTLE: 'k',\n  QSIDE_CASTLE: 'q',\n};\n// prettier-ignore\nexport const SQUARES = [\n    'a8', 'b8', 'c8', 'd8', 'e8', 'f8', 'g8', 'h8',\n    'a7', 'b7', 'c7', 'd7', 'e7', 'f7', 'g7', 'h7',\n    'a6', 'b6', 'c6', 'd6', 'e6', 'f6', 'g6', 'h6',\n    'a5', 'b5', 'c5', 'd5', 'e5', 'f5', 'g5', 'h5',\n    'a4', 'b4', 'c4', 'd4', 'e4', 'f4', 'g4', 'h4',\n    'a3', 'b3', 'c3', 'd3', 'e3', 'f3', 'g3', 'h3',\n    'a2', 'b2', 'c2', 'd2', 'e2', 'f2', 'g2', 'h2',\n    'a1', 'b1', 'c1', 'd1', 'e1', 'f1', 'g1', 'h1'\n];\nconst BITS = {\n  NORMAL: 1,\n  CAPTURE: 2,\n  BIG_PAWN: 4,\n  EP_CAPTURE: 8,\n  PROMOTION: 16,\n  KSIDE_CASTLE: 32,\n  QSIDE_CASTLE: 64,\n};\n/*\n * NOTES ABOUT 0x88 MOVE GENERATION ALGORITHM\n * ----------------------------------------------------------------------------\n * From https://github.com/jhlywa/chess.js/issues/230\n *\n * A lot of people are confused when they first see the internal representation\n * of chess.js. It uses the 0x88 Move Generation Algorithm which internally\n * stores the board as an 8x16 array. This is purely for efficiency but has a\n * couple of interesting benefits:\n *\n * 1. 0x88 offers a very inexpensive \"off the board\" check. Bitwise AND (&) any\n *    square with 0x88, if the result is non-zero then the square is off the\n *    board. For example, assuming a knight square A8 (0 in 0x88 notation),\n *    there are 8 possible directions in which the knight can move. These\n *    directions are relative to the 8x16 board and are stored in the\n *    PIECE_OFFSETS map. One possible move is A8 - 18 (up one square, and two\n *    squares to the left - which is off the board). 0 - 18 = -18 & 0x88 = 0x88\n *    (because of two-complement representation of -18). The non-zero result\n *    means the square is off the board and the move is illegal. Take the\n *    opposite move (from A8 to C7), 0 + 18 = 18 & 0x88 = 0. A result of zero\n *    means the square is on the board.\n *\n * 2. The relative distance (or difference) between two squares on a 8x16 board\n *    is unique and can be used to inexpensively determine if a piece on a\n *    square can attack any other arbitrary square. For example, let's see if a\n *    pawn on E7 can attack E2. The difference between E7 (20) - E2 (100) is\n *    -80. We add 119 to make the ATTACKS array index non-negative (because the\n *    worst case difference is A8 - H1 = -119). The ATTACKS array contains a\n *    bitmask of pieces that can attack from that distance and direction.\n *    ATTACKS[-80 + 119=39] gives us 24 or 0b11000 in binary. Look at the\n *    PIECE_MASKS map to determine the mask for a given piece type. In our pawn\n *    example, we would check to see if 24 & 0x1 is non-zero, which it is\n *    not. So, naturally, a pawn on E7 can't attack a piece on E2. However, a\n *    rook can since 24 & 0x8 is non-zero. The only thing left to check is that\n *    there are no blocking pieces between E7 and E2. That's where the RAYS\n *    array comes in. It provides an offset (in this case 16) to add to E7 (20)\n *    to check for blocking pieces. E7 (20) + 16 = E6 (36) + 16 = E5 (52) etc.\n */\n// prettier-ignore\n\nconst Ox88 = {\n    a8: 0, b8: 1, c8: 2, d8: 3, e8: 4, f8: 5, g8: 6, h8: 7,\n    a7: 16, b7: 17, c7: 18, d7: 19, e7: 20, f7: 21, g7: 22, h7: 23,\n    a6: 32, b6: 33, c6: 34, d6: 35, e6: 36, f6: 37, g6: 38, h6: 39,\n    a5: 48, b5: 49, c5: 50, d5: 51, e5: 52, f5: 53, g5: 54, h5: 55,\n    a4: 64, b4: 65, c4: 66, d4: 67, e4: 68, f4: 69, g4: 70, h4: 71,\n    a3: 80, b3: 81, c3: 82, d3: 83, e3: 84, f3: 85, g3: 86, h3: 87,\n    a2: 96, b2: 97, c2: 98, d2: 99, e2: 100, f2: 101, g2: 102, h2: 103,\n    a1: 112, b1: 113, c1: 114, d1: 115, e1: 116, f1: 117, g1: 118, h1: 119\n};\nconst PAWN_OFFSETS = {\n  b: [16, 32, 17, 15],\n  w: [-16, -32, -17, -15],\n};\nconst PIECE_OFFSETS = {\n  n: [-18, -33, -31, -14, 18, 33, 31, 14],\n  b: [-17, -15, 17, 15],\n  r: [-16, 1, 16, -1],\n  q: [-17, -16, -15, 1, 17, 16, 15, -1],\n  k: [-17, -16, -15, 1, 17, 16, 15, -1],\n};\n// prettier-ignore\nconst ATTACKS = [\n    20, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 20, 0,\n    0, 20, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 20, 0, 0,\n    0, 0, 20, 0, 0, 0, 0, 24, 0, 0, 0, 0, 20, 0, 0, 0,\n    0, 0, 0, 20, 0, 0, 0, 24, 0, 0, 0, 20, 0, 0, 0, 0,\n    0, 0, 0, 0, 20, 0, 0, 24, 0, 0, 20, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 20, 2, 24, 2, 20, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 2, 53, 56, 53, 2, 0, 0, 0, 0, 0, 0,\n    24, 24, 24, 24, 24, 24, 56, 0, 56, 24, 24, 24, 24, 24, 24, 0,\n    0, 0, 0, 0, 0, 2, 53, 56, 53, 2, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 20, 2, 24, 2, 20, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 20, 0, 0, 24, 0, 0, 20, 0, 0, 0, 0, 0,\n    0, 0, 0, 20, 0, 0, 0, 24, 0, 0, 0, 20, 0, 0, 0, 0,\n    0, 0, 20, 0, 0, 0, 0, 24, 0, 0, 0, 0, 20, 0, 0, 0,\n    0, 20, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 20, 0, 0,\n    20, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 20\n];\n// prettier-ignore\nconst RAYS = [\n    17, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 15, 0,\n    0, 17, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 15, 0, 0,\n    0, 0, 17, 0, 0, 0, 0, 16, 0, 0, 0, 0, 15, 0, 0, 0,\n    0, 0, 0, 17, 0, 0, 0, 16, 0, 0, 0, 15, 0, 0, 0, 0,\n    0, 0, 0, 0, 17, 0, 0, 16, 0, 0, 15, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 17, 0, 16, 0, 15, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 0, 17, 16, 15, 0, 0, 0, 0, 0, 0, 0,\n    1, 1, 1, 1, 1, 1, 1, 0, -1, -1, -1, -1, -1, -1, -1, 0,\n    0, 0, 0, 0, 0, 0, -15, -16, -17, 0, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, -15, 0, -16, 0, -17, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, -15, 0, 0, -16, 0, 0, -17, 0, 0, 0, 0, 0,\n    0, 0, 0, -15, 0, 0, 0, -16, 0, 0, 0, -17, 0, 0, 0, 0,\n    0, 0, -15, 0, 0, 0, 0, -16, 0, 0, 0, 0, -17, 0, 0, 0,\n    0, -15, 0, 0, 0, 0, 0, -16, 0, 0, 0, 0, 0, -17, 0, 0,\n    -15, 0, 0, 0, 0, 0, 0, -16, 0, 0, 0, 0, 0, 0, -17\n];\nconst PIECE_MASKS = { p: 0x1, n: 0x2, b: 0x4, r: 0x8, q: 0x10, k: 0x20 };\nconst SYMBOLS = 'pnbrqkPNBRQK';\nconst PROMOTIONS = [KNIGHT, BISHOP, ROOK, QUEEN];\nconst RANK_1 = 7;\nconst RANK_2 = 6;\n/*\n * const RANK_3 = 5\n * const RANK_4 = 4\n * const RANK_5 = 3\n * const RANK_6 = 2\n */\nconst RANK_7 = 1;\nconst RANK_8 = 0;\nconst SIDES = {\n  [KING]: BITS.KSIDE_CASTLE,\n  [QUEEN]: BITS.QSIDE_CASTLE,\n};\nconst ROOKS = {\n  w: [\n    { square: Ox88.a1, flag: BITS.QSIDE_CASTLE },\n    { square: Ox88.h1, flag: BITS.KSIDE_CASTLE },\n  ],\n  b: [\n    { square: Ox88.a8, flag: BITS.QSIDE_CASTLE },\n    { square: Ox88.h8, flag: BITS.KSIDE_CASTLE },\n  ],\n};\nconst SECOND_RANK = { b: RANK_7, w: RANK_2 };\nconst TERMINATION_MARKERS = ['1-0', '0-1', '1/2-1/2', '*'];\n// Extracts the zero-based rank of an 0x88 square.\nfunction rank(square) {\n  return square >> 4;\n}\n// Extracts the zero-based file of an 0x88 square.\nfunction file(square) {\n  return square & 0xf;\n}\nfunction isDigit(c) {\n  return '0123456789'.indexOf(c) !== -1;\n}\n// Converts a 0x88 square to algebraic notation.\nfunction algebraic(square) {\n  const f = file(square);\n  const r = rank(square);\n  return 'abcdefgh'.substring(f, f + 1) + '87654321'.substring(r, r + 1);\n}\nfunction swapColor(color) {\n  return color === WHITE ? BLACK : WHITE;\n}\nexport function validateFen(fen) {\n  // 1st criterion: 6 space-seperated fields?\n  const tokens = fen.split(/\\s+/);\n  if (tokens.length !== 6) {\n    return {\n      ok: false,\n      error: 'Invalid FEN: must contain six space-delimited fields',\n    };\n  }\n  // 2nd criterion: move number field is a integer value > 0?\n  const moveNumber = parseInt(tokens[5], 10);\n  if (isNaN(moveNumber) || moveNumber <= 0) {\n    return {\n      ok: false,\n      error: 'Invalid FEN: move number must be a positive integer',\n    };\n  }\n  // 3rd criterion: half move counter is an integer >= 0?\n  const halfMoves = parseInt(tokens[4], 10);\n  if (isNaN(halfMoves) || halfMoves < 0) {\n    return {\n      ok: false,\n      error: 'Invalid FEN: half move counter number must be a non-negative integer',\n    };\n  }\n  // 4th criterion: 4th field is a valid e.p.-string?\n  if (!/^(-|[abcdefgh][36])$/.test(tokens[3])) {\n    return { ok: false, error: 'Invalid FEN: en-passant square is invalid' };\n  }\n  // 5th criterion: 3th field is a valid castle-string?\n  if (/[^kKqQ-]/.test(tokens[2])) {\n    return { ok: false, error: 'Invalid FEN: castling availability is invalid' };\n  }\n  // 6th criterion: 2nd field is \"w\" (white) or \"b\" (black)?\n  if (!/^(w|b)$/.test(tokens[1])) {\n    return { ok: false, error: 'Invalid FEN: side-to-move is invalid' };\n  }\n  // 7th criterion: 1st field contains 8 rows?\n  const rows = tokens[0].split('/');\n  if (rows.length !== 8) {\n    return {\n      ok: false,\n      error: \"Invalid FEN: piece data does not contain 8 '/'-delimited rows\",\n    };\n  }\n  // 8th criterion: every row is valid?\n  for (let i = 0; i < rows.length; i++) {\n    // check for right sum of fields AND not two numbers in succession\n    let sumFields = 0;\n    let previousWasNumber = false;\n    for (let k = 0; k < rows[i].length; k++) {\n      if (isDigit(rows[i][k])) {\n        if (previousWasNumber) {\n          return {\n            ok: false,\n            error: 'Invalid FEN: piece data is invalid (consecutive number)',\n          };\n        }\n        sumFields += parseInt(rows[i][k], 10);\n        previousWasNumber = true;\n      } else {\n        if (!/^[prnbqkPRNBQK]$/.test(rows[i][k])) {\n          return {\n            ok: false,\n            error: 'Invalid FEN: piece data is invalid (invalid piece)',\n          };\n        }\n        sumFields += 1;\n        previousWasNumber = false;\n      }\n    }\n    if (sumFields !== 8) {\n      return {\n        ok: false,\n        error: 'Invalid FEN: piece data is invalid (too many squares in rank)',\n      };\n    }\n  }\n  // 9th criterion: is en-passant square legal?\n  if ((tokens[3][1] === '3' && tokens[1] === 'w') || (tokens[3][1] === '6' && tokens[1] === 'b')) {\n    return { ok: false, error: 'Invalid FEN: illegal en-passant square' };\n  }\n  // 10th criterion: does chess position contain exact two kings?\n  const kings = [\n    { color: 'white', regex: /K/g },\n    { color: 'black', regex: /k/g },\n  ];\n  for (const { color, regex } of kings) {\n    if (!regex.test(tokens[0])) {\n      return { ok: false, error: `Invalid FEN: missing ${color} king` };\n    }\n    if ((tokens[0].match(regex) || []).length > 1) {\n      return { ok: false, error: `Invalid FEN: too many ${color} kings` };\n    }\n  }\n  // 11th criterion: are any pawns on the first or eighth rows?\n  if (Array.from(rows[0] + rows[7]).some((char) => char.toUpperCase() === 'P')) {\n    return {\n      ok: false,\n      error: 'Invalid FEN: some pawns are on the edge rows',\n    };\n  }\n  return { ok: true };\n}\n// this function is used to uniquely identify ambiguous moves\nfunction getDisambiguator(move, moves) {\n  const from = move.from;\n  const to = move.to;\n  const piece = move.piece;\n  let ambiguities = 0;\n  let sameRank = 0;\n  let sameFile = 0;\n  for (let i = 0, len = moves.length; i < len; i++) {\n    const ambigFrom = moves[i].from;\n    const ambigTo = moves[i].to;\n    const ambigPiece = moves[i].piece;\n    /*\n     * if a move of the same piece type ends on the same to square, we'll need\n     * to add a disambiguator to the algebraic notation\n     */\n    if (piece === ambigPiece && from !== ambigFrom && to === ambigTo) {\n      ambiguities++;\n      if (rank(from) === rank(ambigFrom)) {\n        sameRank++;\n      }\n      if (file(from) === file(ambigFrom)) {\n        sameFile++;\n      }\n    }\n  }\n  if (ambiguities > 0) {\n    if (sameRank > 0 && sameFile > 0) {\n      /*\n       * if there exists a similar moving piece on the same rank and file as\n       * the move in question, use the square as the disambiguator\n       */\n      return algebraic(from);\n    } else if (sameFile > 0) {\n      /*\n       * if the moving piece rests on the same file, use the rank symbol as the\n       * disambiguator\n       */\n      return algebraic(from).charAt(1);\n    }\n\n    // else use the file symbol\n    return algebraic(from).charAt(0);\n  }\n  return '';\n}\nfunction addMove(moves, color, from, to, piece, captured = undefined, flags = BITS.NORMAL) {\n  const r = rank(to);\n  if (piece === PAWN && (r === RANK_1 || r === RANK_8)) {\n    for (let i = 0; i < PROMOTIONS.length; i++) {\n      const promotion = PROMOTIONS[i];\n      moves.push({\n        color,\n        from,\n        to,\n        piece,\n        captured,\n        promotion,\n        flags: flags | BITS.PROMOTION,\n      });\n    }\n  } else {\n    moves.push({\n      color,\n      from,\n      to,\n      piece,\n      captured,\n      flags,\n    });\n  }\n}\nfunction inferPieceType(san) {\n  let pieceType = san.charAt(0);\n  if (pieceType >= 'a' && pieceType <= 'h') {\n    const matches = san.match(/[a-h]\\d.*[a-h]\\d/);\n    if (matches) {\n      return undefined;\n    }\n    return PAWN;\n  }\n  pieceType = pieceType.toLowerCase();\n  if (pieceType === 'o') {\n    return KING;\n  }\n  return pieceType;\n}\n// parses all of the decorators out of a SAN string\nfunction strippedSan(move) {\n  return move.replace(/=/, '').replace(/[+#]?[?!]*$/, '');\n}\nfunction trimFen(fen) {\n  /*\n   * remove last two fields in FEN string as they're not needed when checking\n   * for repetition\n   */\n  return fen.split(' ').slice(0, 4).join(' ');\n}\nexport class Chess {\n  _board = new Array(128);\n  _turn = WHITE;\n  _header = {};\n  _kings = { w: EMPTY, b: EMPTY };\n  _epSquare = -1;\n  _halfMoves = 0;\n  _moveNumber = 0;\n  _history = [];\n  _comments = {};\n  _castling = { w: 0, b: 0 };\n  // tracks number of times a position has been seen for repetition checking\n  _positionCount = {};\n  constructor(fen = DEFAULT_POSITION) {\n    this.load(fen);\n  }\n  clear({ preserveHeaders = false } = {}) {\n    this._board = new Array(128);\n    this._kings = { w: EMPTY, b: EMPTY };\n    this._turn = WHITE;\n    this._castling = { w: 0, b: 0 };\n    this._epSquare = EMPTY;\n    this._halfMoves = 0;\n    this._moveNumber = 1;\n    this._history = [];\n    this._comments = {};\n    this._header = preserveHeaders ? this._header : {};\n    this._positionCount = {};\n    /*\n     * Delete the SetUp and FEN headers (if preserved), the board is empty and\n     * these headers don't make sense in this state. They'll get added later\n     * via .load() or .put()\n     */\n    delete this._header['SetUp'];\n    delete this._header['FEN'];\n  }\n  load(fen, { skipValidation = false, preserveHeaders = false } = {}) {\n    let tokens = fen.split(/\\s+/);\n    // append commonly omitted fen tokens\n    if (tokens.length >= 2 && tokens.length < 6) {\n      const adjustments = ['-', '-', '0', '1'];\n      fen = tokens.concat(adjustments.slice(-(6 - tokens.length))).join(' ');\n    }\n    tokens = fen.split(/\\s+/);\n    if (!skipValidation) {\n      const { ok, error } = validateFen(fen);\n      if (!ok) {\n        throw new Error(error);\n      }\n    }\n    const position = tokens[0];\n    let square = 0;\n    this.clear({ preserveHeaders });\n    for (let i = 0; i < position.length; i++) {\n      const piece = position.charAt(i);\n      if (piece === '/') {\n        square += 8;\n      } else if (isDigit(piece)) {\n        square += parseInt(piece, 10);\n      } else {\n        const color = piece < 'a' ? WHITE : BLACK;\n        this._put({ type: piece.toLowerCase(), color }, algebraic(square));\n        square++;\n      }\n    }\n    this._turn = tokens[1];\n    if (tokens[2].indexOf('K') > -1) {\n      this._castling.w |= BITS.KSIDE_CASTLE;\n    }\n    if (tokens[2].indexOf('Q') > -1) {\n      this._castling.w |= BITS.QSIDE_CASTLE;\n    }\n    if (tokens[2].indexOf('k') > -1) {\n      this._castling.b |= BITS.KSIDE_CASTLE;\n    }\n    if (tokens[2].indexOf('q') > -1) {\n      this._castling.b |= BITS.QSIDE_CASTLE;\n    }\n    this._epSquare = tokens[3] === '-' ? EMPTY : Ox88[tokens[3]];\n    this._halfMoves = parseInt(tokens[4], 10);\n    this._moveNumber = parseInt(tokens[5], 10);\n    this._updateSetup(fen);\n    this._incPositionCount(fen);\n  }\n  fen() {\n    let empty = 0;\n    let fen = '';\n    for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n      if (this._board[i]) {\n        if (empty > 0) {\n          fen += empty;\n          empty = 0;\n        }\n        const { color, type: piece } = this._board[i];\n        fen += color === WHITE ? piece.toUpperCase() : piece.toLowerCase();\n      } else {\n        empty++;\n      }\n      if ((i + 1) & 0x88) {\n        if (empty > 0) {\n          fen += empty;\n        }\n        if (i !== Ox88.h1) {\n          fen += '/';\n        }\n        empty = 0;\n        i += 8;\n      }\n    }\n    let castling = '';\n    if (this._castling[WHITE] & BITS.KSIDE_CASTLE) {\n      castling += 'K';\n    }\n    if (this._castling[WHITE] & BITS.QSIDE_CASTLE) {\n      castling += 'Q';\n    }\n    if (this._castling[BLACK] & BITS.KSIDE_CASTLE) {\n      castling += 'k';\n    }\n    if (this._castling[BLACK] & BITS.QSIDE_CASTLE) {\n      castling += 'q';\n    }\n    // do we have an empty castling flag?\n    castling = castling || '-';\n    let epSquare = '-';\n    /*\n     * only print the ep square if en passant is a valid move (pawn is present\n     * and ep capture is not pinned)\n     */\n    if (this._epSquare !== EMPTY) {\n      const bigPawnSquare = this._epSquare + (this._turn === WHITE ? 16 : -16);\n      const squares = [bigPawnSquare + 1, bigPawnSquare - 1];\n      for (const square of squares) {\n        // is the square off the board?\n        if (square & 0x88) {\n          continue;\n        }\n        const color = this._turn;\n        // is there a pawn that can capture the epSquare?\n        if (this._board[square]?.color === color && this._board[square]?.type === PAWN) {\n          // if the pawn makes an ep capture, does it leave it's king in check?\n          this._makeMove({\n            color,\n            from: square,\n            to: this._epSquare,\n            piece: PAWN,\n            captured: PAWN,\n            flags: BITS.EP_CAPTURE,\n          });\n          const isLegal = !this._isKingAttacked(color);\n          this._undoMove();\n          // if ep is legal, break and set the ep square in the FEN output\n          if (isLegal) {\n            epSquare = algebraic(this._epSquare);\n            break;\n          }\n        }\n      }\n    }\n    return [fen, this._turn, castling, epSquare, this._halfMoves, this._moveNumber].join(' ');\n  }\n  /*\n   * Called when the initial board setup is changed with put() or remove().\n   * modifies the SetUp and FEN properties of the header object. If the FEN\n   * is equal to the default position, the SetUp and FEN are deleted the setup\n   * is only updated if history.length is zero, ie moves haven't been made.\n   */\n  _updateSetup(fen) {\n    if (this._history.length > 0) return;\n    if (fen !== DEFAULT_POSITION) {\n      this._header['SetUp'] = '1';\n      this._header['FEN'] = fen;\n    } else {\n      delete this._header['SetUp'];\n      delete this._header['FEN'];\n    }\n  }\n  reset() {\n    this.load(DEFAULT_POSITION);\n  }\n  get(square) {\n    return this._board[Ox88[square]];\n  }\n  put({ type, color }, square) {\n    if (this._put({ type, color }, square)) {\n      this._updateCastlingRights();\n      this._updateEnPassantSquare();\n      this._updateSetup(this.fen());\n      return true;\n    }\n    return false;\n  }\n  _put({ type, color }, square) {\n    // check for piece\n    if (SYMBOLS.indexOf(type.toLowerCase()) === -1) {\n      return false;\n    }\n    // check for valid square\n    if (!(square in Ox88)) {\n      return false;\n    }\n    const sq = Ox88[square];\n    // don't let the user place more than one king\n    if (type === KING && !(this._kings[color] === EMPTY || this._kings[color] === sq)) {\n      return false;\n    }\n    const currentPieceOnSquare = this._board[sq];\n    // if one of the kings will be replaced by the piece from args, set the `_kings` respective entry to `EMPTY`\n    if (currentPieceOnSquare && currentPieceOnSquare.type === KING) {\n      this._kings[currentPieceOnSquare.color] = EMPTY;\n    }\n    this._board[sq] = { type, color };\n    if (type === KING) {\n      this._kings[color] = sq;\n    }\n    return true;\n  }\n  remove(square) {\n    const piece = this.get(square);\n    delete this._board[Ox88[square]];\n    if (piece && piece.type === KING) {\n      this._kings[piece.color] = EMPTY;\n    }\n    this._updateCastlingRights();\n    this._updateEnPassantSquare();\n    this._updateSetup(this.fen());\n    return piece;\n  }\n  _updateCastlingRights() {\n    const whiteKingInPlace =\n      this._board[Ox88.e1]?.type === KING && this._board[Ox88.e1]?.color === WHITE;\n    const blackKingInPlace =\n      this._board[Ox88.e8]?.type === KING && this._board[Ox88.e8]?.color === BLACK;\n    if (\n      !whiteKingInPlace ||\n      this._board[Ox88.a1]?.type !== ROOK ||\n      this._board[Ox88.a1]?.color !== WHITE\n    ) {\n      this._castling.w &= ~BITS.QSIDE_CASTLE;\n    }\n    if (\n      !whiteKingInPlace ||\n      this._board[Ox88.h1]?.type !== ROOK ||\n      this._board[Ox88.h1]?.color !== WHITE\n    ) {\n      this._castling.w &= ~BITS.KSIDE_CASTLE;\n    }\n    if (\n      !blackKingInPlace ||\n      this._board[Ox88.a8]?.type !== ROOK ||\n      this._board[Ox88.a8]?.color !== BLACK\n    ) {\n      this._castling.b &= ~BITS.QSIDE_CASTLE;\n    }\n    if (\n      !blackKingInPlace ||\n      this._board[Ox88.h8]?.type !== ROOK ||\n      this._board[Ox88.h8]?.color !== BLACK\n    ) {\n      this._castling.b &= ~BITS.KSIDE_CASTLE;\n    }\n  }\n  _updateEnPassantSquare() {\n    if (this._epSquare === EMPTY) {\n      return;\n    }\n    const startSquare = this._epSquare + (this._turn === WHITE ? -16 : 16);\n    const currentSquare = this._epSquare + (this._turn === WHITE ? 16 : -16);\n    const attackers = [currentSquare + 1, currentSquare - 1];\n    if (\n      this._board[startSquare] !== null ||\n      this._board[this._epSquare] !== null ||\n      this._board[currentSquare]?.color !== swapColor(this._turn) ||\n      this._board[currentSquare]?.type !== PAWN\n    ) {\n      this._epSquare = EMPTY;\n      return;\n    }\n    const canCapture = (square) =>\n      !(square & 0x88) &&\n      this._board[square]?.color === this._turn &&\n      this._board[square]?.type === PAWN;\n    if (!attackers.some(canCapture)) {\n      this._epSquare = EMPTY;\n    }\n  }\n  _attacked(color, square, verbose) {\n    const attackers = [];\n    for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n      // did we run off the end of the board\n      if (i & 0x88) {\n        i += 7;\n        continue;\n      }\n      // if empty square or wrong color\n      if (this._board[i] === undefined || this._board[i].color !== color) {\n        continue;\n      }\n      const piece = this._board[i];\n      const difference = i - square;\n      // skip - to/from square are the same\n      if (difference === 0) {\n        continue;\n      }\n      const index = difference + 119;\n      if (ATTACKS[index] & PIECE_MASKS[piece.type]) {\n        if (piece.type === PAWN) {\n          if (\n            (difference > 0 && piece.color === WHITE) ||\n            (difference <= 0 && piece.color === BLACK)\n          ) {\n            if (!verbose) {\n              return true;\n            }\n\n            attackers.push(algebraic(i));\n          }\n          continue;\n        }\n        // if the piece is a knight or a king\n        if (piece.type === 'n' || piece.type === 'k') {\n          if (!verbose) {\n            return true;\n          }\n\n          attackers.push(algebraic(i));\n          continue;\n        }\n        const offset = RAYS[index];\n        let j = i + offset;\n        let blocked = false;\n        while (j !== square) {\n          if (this._board[j] != null) {\n            blocked = true;\n            break;\n          }\n          j += offset;\n        }\n        if (!blocked) {\n          if (!verbose) {\n            return true;\n          }\n\n          attackers.push(algebraic(i));\n          continue;\n        }\n      }\n    }\n    if (verbose) {\n      return attackers;\n    }\n\n    return false;\n  }\n  attackers(square, attackedBy) {\n    if (!attackedBy) {\n      return this._attacked(this._turn, Ox88[square], true);\n    }\n\n    return this._attacked(attackedBy, Ox88[square], true);\n  }\n  _isKingAttacked(color) {\n    const square = this._kings[color];\n    return square === -1 ? false : this._attacked(swapColor(color), square);\n  }\n  isAttacked(square, attackedBy) {\n    return this._attacked(attackedBy, Ox88[square]);\n  }\n  isCheck() {\n    return this._isKingAttacked(this._turn);\n  }\n  inCheck() {\n    return this.isCheck();\n  }\n  isCheckmate() {\n    return this.isCheck() && this._moves().length === 0;\n  }\n  isStalemate() {\n    return !this.isCheck() && this._moves().length === 0;\n  }\n  isInsufficientMaterial() {\n    /*\n     * k.b. vs k.b. (of opposite colors) with mate in 1:\n     * 8/8/8/8/1b6/8/B1k5/K7 b - - 0 1\n     *\n     * k.b. vs k.n. with mate in 1:\n     * 8/8/8/8/1n6/8/B7/K1k5 b - - 2 1\n     */\n    const pieces = {\n      b: 0,\n      n: 0,\n      r: 0,\n      q: 0,\n      k: 0,\n      p: 0,\n    };\n    const bishops = [];\n    let numPieces = 0;\n    let squareColor = 0;\n    for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n      squareColor = (squareColor + 1) % 2;\n      if (i & 0x88) {\n        i += 7;\n        continue;\n      }\n      const piece = this._board[i];\n      if (piece) {\n        pieces[piece.type] = piece.type in pieces ? pieces[piece.type] + 1 : 1;\n        if (piece.type === BISHOP) {\n          bishops.push(squareColor);\n        }\n        numPieces++;\n      }\n    }\n    // k vs. k\n    if (numPieces === 2) {\n      return true;\n    } else if (\n      // k vs. kn .... or .... k vs. kb\n      numPieces === 3 &&\n      (pieces[BISHOP] === 1 || pieces[KNIGHT] === 1)\n    ) {\n      return true;\n    } else if (numPieces === pieces[BISHOP] + 2) {\n      // kb vs. kb where any number of bishops are all on the same color\n      let sum = 0;\n      const len = bishops.length;\n      for (let i = 0; i < len; i++) {\n        sum += bishops[i];\n      }\n      if (sum === 0 || sum === len) {\n        return true;\n      }\n    }\n    return false;\n  }\n  isThreefoldRepetition() {\n    return this._getPositionCount(this.fen()) >= 3;\n  }\n  isDrawByFiftyMoves() {\n    return this._halfMoves >= 100; // 50 moves per side = 100 half moves\n  }\n  isDraw() {\n    return (\n      this.isDrawByFiftyMoves() ||\n      this.isStalemate() ||\n      this.isInsufficientMaterial() ||\n      this.isThreefoldRepetition()\n    );\n  }\n  isGameOver() {\n    return this.isCheckmate() || this.isStalemate() || this.isDraw();\n  }\n  moves({ verbose = false, square = undefined, piece = undefined } = {}) {\n    const moves = this._moves({ square, piece });\n    if (verbose) {\n      return moves.map((move) => new Move(this, move));\n    }\n\n    return moves.map((move) => this._moveToSan(move, moves));\n  }\n  _moves({ legal = true, piece = undefined, square = undefined } = {}) {\n    const forSquare = square ? square.toLowerCase() : undefined;\n    const forPiece = piece?.toLowerCase();\n    const moves = [];\n    const us = this._turn;\n    const them = swapColor(us);\n    let firstSquare = Ox88.a8;\n    let lastSquare = Ox88.h1;\n    let singleSquare = false;\n    // are we generating moves for a single square?\n    if (forSquare) {\n      // illegal square, return empty moves\n      if (!(forSquare in Ox88)) {\n        return [];\n      }\n\n      firstSquare = lastSquare = Ox88[forSquare];\n      singleSquare = true;\n    }\n    for (let from = firstSquare; from <= lastSquare; from++) {\n      // did we run off the end of the board\n      if (from & 0x88) {\n        from += 7;\n        continue;\n      }\n      // empty square or opponent, skip\n      if (!this._board[from] || this._board[from].color === them) {\n        continue;\n      }\n      const { type } = this._board[from];\n      let to;\n      if (type === PAWN) {\n        if (forPiece && forPiece !== type) continue;\n        // single square, non-capturing\n        to = from + PAWN_OFFSETS[us][0];\n        if (!this._board[to]) {\n          addMove(moves, us, from, to, PAWN);\n          // double square\n          to = from + PAWN_OFFSETS[us][1];\n          if (SECOND_RANK[us] === rank(from) && !this._board[to]) {\n            addMove(moves, us, from, to, PAWN, undefined, BITS.BIG_PAWN);\n          }\n        }\n        // pawn captures\n        for (let j = 2; j < 4; j++) {\n          to = from + PAWN_OFFSETS[us][j];\n          if (to & 0x88) continue;\n          if (this._board[to]?.color === them) {\n            addMove(moves, us, from, to, PAWN, this._board[to].type, BITS.CAPTURE);\n          } else if (to === this._epSquare) {\n            addMove(moves, us, from, to, PAWN, PAWN, BITS.EP_CAPTURE);\n          }\n        }\n      } else {\n        if (forPiece && forPiece !== type) continue;\n        for (let j = 0, len = PIECE_OFFSETS[type].length; j < len; j++) {\n          const offset = PIECE_OFFSETS[type][j];\n          to = from;\n          while (true) {\n            to += offset;\n            if (to & 0x88) break;\n            if (!this._board[to]) {\n              addMove(moves, us, from, to, type);\n            } else {\n              // own color, stop loop\n              if (this._board[to].color === us) break;\n              addMove(moves, us, from, to, type, this._board[to].type, BITS.CAPTURE);\n              break;\n            }\n            /* break, if knight or king */\n            if (type === KNIGHT || type === KING) break;\n          }\n        }\n      }\n    }\n    /*\n     * check for castling if we're:\n     *   a) generating all moves, or\n     *   b) doing single square move generation on the king's square\n     */\n    if (forPiece === undefined || forPiece === KING) {\n      if (!singleSquare || lastSquare === this._kings[us]) {\n        // king-side castling\n        if (this._castling[us] & BITS.KSIDE_CASTLE) {\n          const castlingFrom = this._kings[us];\n          const castlingTo = castlingFrom + 2;\n          if (\n            !this._board[castlingFrom + 1] &&\n            !this._board[castlingTo] &&\n            !this._attacked(them, this._kings[us]) &&\n            !this._attacked(them, castlingFrom + 1) &&\n            !this._attacked(them, castlingTo)\n          ) {\n            addMove(moves, us, this._kings[us], castlingTo, KING, undefined, BITS.KSIDE_CASTLE);\n          }\n        }\n        // queen-side castling\n        if (this._castling[us] & BITS.QSIDE_CASTLE) {\n          const castlingFrom = this._kings[us];\n          const castlingTo = castlingFrom - 2;\n          if (\n            !this._board[castlingFrom - 1] &&\n            !this._board[castlingFrom - 2] &&\n            !this._board[castlingFrom - 3] &&\n            !this._attacked(them, this._kings[us]) &&\n            !this._attacked(them, castlingFrom - 1) &&\n            !this._attacked(them, castlingTo)\n          ) {\n            addMove(moves, us, this._kings[us], castlingTo, KING, undefined, BITS.QSIDE_CASTLE);\n          }\n        }\n      }\n    }\n    /*\n     * return all pseudo-legal moves (this includes moves that allow the king\n     * to be captured)\n     */\n    if (!legal || this._kings[us] === -1) {\n      return moves;\n    }\n    // filter out illegal moves\n    const legalMoves = [];\n    for (let i = 0, len = moves.length; i < len; i++) {\n      this._makeMove(moves[i]);\n      if (!this._isKingAttacked(us)) {\n        legalMoves.push(moves[i]);\n      }\n      this._undoMove();\n    }\n    return legalMoves;\n  }\n  move(move, { strict = false } = {}) {\n    /*\n     * The move function can be called with in the following parameters:\n     *\n     * .move('Nxb7')       <- argument is a case-sensitive SAN string\n     *\n     * .move({ from: 'h7', <- argument is a move object\n     *         to :'h8',\n     *         promotion: 'q' })\n     *\n     *\n     * An optional strict argument may be supplied to tell chess.js to\n     * strictly follow the SAN specification.\n     */\n    let moveObj = null;\n    if (typeof move === 'string') {\n      moveObj = this._moveFromSan(move, strict);\n    } else if (typeof move === 'object') {\n      const moves = this._moves();\n      // convert the pretty move object to an ugly move object\n      for (let i = 0, len = moves.length; i < len; i++) {\n        if (\n          move.from === algebraic(moves[i].from) &&\n          move.to === algebraic(moves[i].to) &&\n          (!('promotion' in moves[i]) || move.promotion === moves[i].promotion)\n        ) {\n          moveObj = moves[i];\n          break;\n        }\n      }\n    }\n    // failed to find move\n    if (!moveObj) {\n      if (typeof move === 'string') {\n        throw new Error(`Invalid move: ${move}`);\n      } else {\n        throw new Error(`Invalid move: ${JSON.stringify(move)}`);\n      }\n    }\n    /*\n     * need to make a copy of move because we can't generate SAN after the move\n     * is made\n     */\n    const prettyMove = new Move(this, moveObj);\n    this._makeMove(moveObj);\n    this._incPositionCount(prettyMove.after);\n    return prettyMove;\n  }\n  _push(move) {\n    this._history.push({\n      move,\n      kings: { b: this._kings.b, w: this._kings.w },\n      turn: this._turn,\n      castling: { b: this._castling.b, w: this._castling.w },\n      epSquare: this._epSquare,\n      halfMoves: this._halfMoves,\n      moveNumber: this._moveNumber,\n    });\n  }\n  _makeMove(move) {\n    const us = this._turn;\n    const them = swapColor(us);\n    this._push(move);\n    this._board[move.to] = this._board[move.from];\n    delete this._board[move.from];\n    // if ep capture, remove the captured pawn\n    if (move.flags & BITS.EP_CAPTURE) {\n      if (this._turn === BLACK) {\n        delete this._board[move.to - 16];\n      } else {\n        delete this._board[move.to + 16];\n      }\n    }\n    // if pawn promotion, replace with new piece\n    if (move.promotion) {\n      this._board[move.to] = { type: move.promotion, color: us };\n    }\n    // if we moved the king\n    if (this._board[move.to].type === KING) {\n      this._kings[us] = move.to;\n      // if we castled, move the rook next to the king\n      if (move.flags & BITS.KSIDE_CASTLE) {\n        const castlingTo = move.to - 1;\n        const castlingFrom = move.to + 1;\n        this._board[castlingTo] = this._board[castlingFrom];\n        delete this._board[castlingFrom];\n      } else if (move.flags & BITS.QSIDE_CASTLE) {\n        const castlingTo = move.to + 1;\n        const castlingFrom = move.to - 2;\n        this._board[castlingTo] = this._board[castlingFrom];\n        delete this._board[castlingFrom];\n      }\n      // turn off castling\n      this._castling[us] = 0;\n    }\n    // turn off castling if we move a rook\n    if (this._castling[us]) {\n      for (let i = 0, len = ROOKS[us].length; i < len; i++) {\n        if (move.from === ROOKS[us][i].square && this._castling[us] & ROOKS[us][i].flag) {\n          this._castling[us] ^= ROOKS[us][i].flag;\n          break;\n        }\n      }\n    }\n    // turn off castling if we capture a rook\n    if (this._castling[them]) {\n      for (let i = 0, len = ROOKS[them].length; i < len; i++) {\n        if (move.to === ROOKS[them][i].square && this._castling[them] & ROOKS[them][i].flag) {\n          this._castling[them] ^= ROOKS[them][i].flag;\n          break;\n        }\n      }\n    }\n    // if big pawn move, update the en passant square\n    if (move.flags & BITS.BIG_PAWN) {\n      if (us === BLACK) {\n        this._epSquare = move.to - 16;\n      } else {\n        this._epSquare = move.to + 16;\n      }\n    } else {\n      this._epSquare = EMPTY;\n    }\n    // reset the 50 move counter if a pawn is moved or a piece is captured\n    if (move.piece === PAWN) {\n      this._halfMoves = 0;\n    } else if (move.flags & (BITS.CAPTURE | BITS.EP_CAPTURE)) {\n      this._halfMoves = 0;\n    } else {\n      this._halfMoves++;\n    }\n    if (us === BLACK) {\n      this._moveNumber++;\n    }\n    this._turn = them;\n  }\n  undo() {\n    const move = this._undoMove();\n    if (move) {\n      const prettyMove = new Move(this, move);\n      this._decPositionCount(prettyMove.after);\n      return prettyMove;\n    }\n    return null;\n  }\n  _undoMove() {\n    const old = this._history.pop();\n    if (old === undefined) {\n      return null;\n    }\n    const move = old.move;\n    this._kings = old.kings;\n    this._turn = old.turn;\n    this._castling = old.castling;\n    this._epSquare = old.epSquare;\n    this._halfMoves = old.halfMoves;\n    this._moveNumber = old.moveNumber;\n    const us = this._turn;\n    const them = swapColor(us);\n    this._board[move.from] = this._board[move.to];\n    this._board[move.from].type = move.piece; // to undo any promotions\n    delete this._board[move.to];\n    if (move.captured) {\n      if (move.flags & BITS.EP_CAPTURE) {\n        // en passant capture\n        let index;\n        if (us === BLACK) {\n          index = move.to - 16;\n        } else {\n          index = move.to + 16;\n        }\n        this._board[index] = { type: PAWN, color: them };\n      } else {\n        // regular capture\n        this._board[move.to] = { type: move.captured, color: them };\n      }\n    }\n    if (move.flags & (BITS.KSIDE_CASTLE | BITS.QSIDE_CASTLE)) {\n      let castlingTo, castlingFrom;\n      if (move.flags & BITS.KSIDE_CASTLE) {\n        castlingTo = move.to + 1;\n        castlingFrom = move.to - 1;\n      } else {\n        castlingTo = move.to - 2;\n        castlingFrom = move.to + 1;\n      }\n      this._board[castlingTo] = this._board[castlingFrom];\n      delete this._board[castlingFrom];\n    }\n    return move;\n  }\n  pgn({ newline = '\\n', maxWidth = 0 } = {}) {\n    /*\n     * using the specification from http://www.chessclub.com/help/PGN-spec\n     * example for html usage: .pgn({ max_width: 72, newline_char: \"<br />\" })\n     */\n    const result = [];\n    let headerExists = false;\n    /* add the PGN header information */\n    for (const i in this._header) {\n      /*\n       * TODO: order of enumerated properties in header object is not\n       * guaranteed, see ECMA-262 spec (section 12.6.4)\n       */\n      result.push(`[${i} \"${this._header[i]}\"]${newline}`);\n      headerExists = true;\n    }\n    if (headerExists && this._history.length) {\n      result.push(newline);\n    }\n    const appendComment = (moveString) => {\n      const comment = this._comments[this.fen()];\n      if (typeof comment !== 'undefined') {\n        const delimiter = moveString.length > 0 ? ' ' : '';\n        moveString = `${moveString}${delimiter}{${comment}}`;\n      }\n      return moveString;\n    };\n    // pop all of history onto reversed_history\n    const reversedHistory = [];\n    while (this._history.length > 0) {\n      reversedHistory.push(this._undoMove());\n    }\n    const moves = [];\n    let moveString = '';\n    // special case of a commented starting position with no moves\n    if (reversedHistory.length === 0) {\n      moves.push(appendComment(''));\n    }\n    // build the list of moves.  a move_string looks like: \"3. e3 e6\"\n    while (reversedHistory.length > 0) {\n      moveString = appendComment(moveString);\n      const move = reversedHistory.pop();\n      // make TypeScript stop complaining about move being undefined\n      if (!move) {\n        break;\n      }\n      // if the position started with black to move, start PGN with #. ...\n      if (!this._history.length && move.color === 'b') {\n        const prefix = `${this._moveNumber}. ...`;\n        // is there a comment preceding the first move?\n        moveString = moveString ? `${moveString} ${prefix}` : prefix;\n      } else if (move.color === 'w') {\n        // store the previous generated move_string if we have one\n        if (moveString.length) {\n          moves.push(moveString);\n        }\n        moveString = `${this._moveNumber}.`;\n      }\n      moveString = `${moveString} ${this._moveToSan(move, this._moves({ legal: true }))}`;\n      this._makeMove(move);\n    }\n    // are there any other leftover moves?\n    if (moveString.length) {\n      moves.push(appendComment(moveString));\n    }\n    // is there a result?\n    if (typeof this._header.Result !== 'undefined') {\n      moves.push(this._header.Result);\n    }\n    /*\n     * history should be back to what it was before we started generating PGN,\n     * so join together moves\n     */\n    if (maxWidth === 0) {\n      return result.join('') + moves.join(' ');\n    }\n    // TODO (jah): huh?\n    const strip = function () {\n      if (result.length > 0 && result[result.length - 1] === ' ') {\n        result.pop();\n        return true;\n      }\n      return false;\n    };\n    // NB: this does not preserve comment whitespace.\n    const wrapComment = function (width, move) {\n      for (const token of move.split(' ')) {\n        if (!token) {\n          continue;\n        }\n        if (width + token.length > maxWidth) {\n          while (strip()) {\n            width--;\n          }\n          result.push(newline);\n          width = 0;\n        }\n        result.push(token);\n        width += token.length;\n        result.push(' ');\n        width++;\n      }\n      if (strip()) {\n        width--;\n      }\n      return width;\n    };\n    // wrap the PGN output at max_width\n    let currentWidth = 0;\n    for (let i = 0; i < moves.length; i++) {\n      if (currentWidth + moves[i].length > maxWidth) {\n        if (moves[i].includes('{')) {\n          currentWidth = wrapComment(currentWidth, moves[i]);\n          continue;\n        }\n      }\n      // if the current move will push past max_width\n      if (currentWidth + moves[i].length > maxWidth && i !== 0) {\n        // don't end the line with whitespace\n        if (result[result.length - 1] === ' ') {\n          result.pop();\n        }\n        result.push(newline);\n        currentWidth = 0;\n      } else if (i !== 0) {\n        result.push(' ');\n        currentWidth++;\n      }\n      result.push(moves[i]);\n      currentWidth += moves[i].length;\n    }\n    return result.join('');\n  }\n  /*\n   * @deprecated Use `setHeader` and `getHeaders` instead.\n   */\n  header(...args) {\n    for (let i = 0; i < args.length; i += 2) {\n      if (typeof args[i] === 'string' && typeof args[i + 1] === 'string') {\n        this._header[args[i]] = args[i + 1];\n      }\n    }\n    return this._header;\n  }\n  setHeader(key, value) {\n    this._header[key] = value;\n    return this._header;\n  }\n  removeHeader(key) {\n    if (key in this._header) {\n      delete this._header[key];\n      return true;\n    }\n    return false;\n  }\n  getHeaders() {\n    return this._header;\n  }\n  loadPgn(pgn, { strict = false, newlineChar = '\\r?\\n' } = {}) {\n    function mask(str) {\n      return str.replace(/\\\\/g, '\\\\');\n    }\n    function parsePgnHeader(header) {\n      const headerObj = {};\n      const headers = header.split(new RegExp(mask(newlineChar)));\n      let key = '';\n      let value = '';\n      for (let i = 0; i < headers.length; i++) {\n        const regex = /^\\s*\\[\\s*([A-Za-z]+)\\s*\"(.*)\"\\s*\\]\\s*$/;\n        key = headers[i].replace(regex, '$1');\n        value = headers[i].replace(regex, '$2');\n        if (key.trim().length > 0) {\n          headerObj[key] = value;\n        }\n      }\n      return headerObj;\n    }\n    // strip whitespace from head/tail of PGN block\n    pgn = pgn.trim();\n    /*\n     * RegExp to split header. Takes advantage of the fact that header and movetext\n     * will always have a blank line between them (ie, two newline_char's). Handles\n     * case where movetext is empty by matching newlineChar until end of string is\n     * matched - effectively trimming from the end extra newlineChar.\n     *\n     * With default newline_char, will equal:\n     * /^(\\[((?:\\r?\\n)|.)*\\])((?:\\s*\\r?\\n){2}|(?:\\s*\\r?\\n)*$)/\n     */\n    const headerRegex = new RegExp(\n      `^(\\\\[((?:${mask(newlineChar)})|.)*\\\\])` +\n        `((?:\\\\s*${mask(newlineChar)}){2}|(?:\\\\s*${mask(newlineChar)})*$)`\n    );\n    // If no header given, begin with moves.\n    const headerRegexResults = headerRegex.exec(pgn);\n    const headerString = headerRegexResults\n      ? headerRegexResults.length >= 2\n        ? headerRegexResults[1]\n        : ''\n      : '';\n    // Put the board in the starting position\n    this.reset();\n    // parse PGN header\n    const headers = parsePgnHeader(headerString);\n    let fen = '';\n    for (const key in headers) {\n      // check to see user is including fen (possibly with wrong tag case)\n      if (key.toLowerCase() === 'fen') {\n        fen = headers[key];\n      }\n      this.header(key, headers[key]);\n    }\n    /*\n     * the permissive parser should attempt to load a fen tag, even if it's the\n     * wrong case and doesn't include a corresponding [SetUp \"1\"] tag\n     */\n    if (!strict) {\n      if (fen) {\n        this.load(fen, { preserveHeaders: true });\n      }\n    } else {\n      /*\n       * strict parser - load the starting position indicated by [Setup '1']\n       * and [FEN position]\n       */\n      if (headers['SetUp'] === '1') {\n        if (!('FEN' in headers)) {\n          throw new Error('Invalid PGN: FEN tag must be supplied with SetUp tag');\n        }\n        // don't clear the headers when loading\n        this.load(headers['FEN'], { preserveHeaders: true });\n      }\n    }\n    /*\n     * NB: the regexes below that delete move numbers, recursive annotations,\n     * and numeric annotation glyphs may also match text in comments. To\n     * prevent this, we transform comments by hex-encoding them in place and\n     * decoding them again after the other tokens have been deleted.\n     *\n     * While the spec states that PGN files should be ASCII encoded, we use\n     * {en,de}codeURIComponent here to support arbitrary UTF8 as a convenience\n     * for modern users\n     */\n    function toHex(s) {\n      return Array.from(s)\n        .map((c) => {\n          /*\n           * encodeURI doesn't transform most ASCII characters, so we handle\n           * these ourselves\n           */\n          return c.charCodeAt(0) < 128\n            ? c.charCodeAt(0).toString(16)\n            : encodeURIComponent(c).replace(/%/g, '').toLowerCase();\n        })\n        .join('');\n    }\n    function fromHex(s) {\n      return s.length === 0 ? '' : decodeURIComponent(`%${(s.match(/.{1,2}/g) || []).join('%')}`);\n    }\n    const encodeComment = function (s) {\n      s = s.replace(new RegExp(mask(newlineChar), 'g'), ' ');\n      return `{${toHex(s.slice(1, s.length - 1))}}`;\n    };\n    const decodeComment = function (s) {\n      if (s.startsWith('{') && s.endsWith('}')) {\n        return fromHex(s.slice(1, s.length - 1));\n      }\n    };\n    // delete header to get the moves\n    let ms = pgn\n      .replace(headerString, '')\n      .replace(\n        // encode comments so they don't get deleted below\n        new RegExp(`({[^}]*})+?|;([^${mask(newlineChar)}]*)`, 'g'),\n        (_match, bracket, semicolon) => {\n          return bracket !== undefined\n            ? encodeComment(bracket)\n            : ` ${encodeComment(`{${semicolon.slice(1)}}`)}`;\n        }\n      )\n      .replace(new RegExp(mask(newlineChar), 'g'), ' ');\n    // delete recursive annotation variations\n    const ravRegex = /(\\([^()]+\\))+?/g;\n    while (ravRegex.test(ms)) {\n      ms = ms.replace(ravRegex, '');\n    }\n    // delete move numbers\n    ms = ms.replace(/\\d+\\.(\\.\\.)?/g, '');\n    // delete ... indicating black to move\n    ms = ms.replace(/\\.\\.\\./g, '');\n    /* delete numeric annotation glyphs */\n    ms = ms.replace(/\\$\\d+/g, '');\n    // trim and get array of moves\n    let moves = ms.trim().split(new RegExp(/\\s+/));\n    // delete empty entries\n    moves = moves.filter((move) => move !== '');\n    let result = '';\n    for (let halfMove = 0; halfMove < moves.length; halfMove++) {\n      const comment = decodeComment(moves[halfMove]);\n      if (comment !== undefined) {\n        this._comments[this.fen()] = comment;\n        continue;\n      }\n      const move = this._moveFromSan(moves[halfMove], strict);\n      // invalid move\n      if (move == null) {\n        // was the move an end of game marker\n        if (TERMINATION_MARKERS.indexOf(moves[halfMove]) > -1) {\n          result = moves[halfMove];\n        } else {\n          throw new Error(`Invalid move in PGN: ${moves[halfMove]}`);\n        }\n      } else {\n        // reset the end of game marker if making a valid move\n        result = '';\n        this._makeMove(move);\n        this._incPositionCount(this.fen());\n      }\n    }\n    /*\n     * Per section 8.2.6 of the PGN spec, the Result tag pair must match match\n     * the termination marker. Only do this when headers are present, but the\n     * result tag is missing\n     */\n    if (result && Object.keys(this._header).length && !this._header['Result']) {\n      this.header('Result', result);\n    }\n  }\n  /*\n   * Convert a move from 0x88 coordinates to Standard Algebraic Notation\n   * (SAN)\n   *\n   * @param {boolean} strict Use the strict SAN parser. It will throw errors\n   * on overly disambiguated moves (see below):\n   *\n   * r1bqkbnr/ppp2ppp/2n5/1B1pP3/4P3/8/PPPP2PP/RNBQK1NR b KQkq - 2 4\n   * 4. ... Nge7 is overly disambiguated because the knight on c6 is pinned\n   * 4. ... Ne7 is technically the valid SAN\n   */\n  _moveToSan(move, moves) {\n    let output = '';\n    if (move.flags & BITS.KSIDE_CASTLE) {\n      output = 'O-O';\n    } else if (move.flags & BITS.QSIDE_CASTLE) {\n      output = 'O-O-O';\n    } else {\n      if (move.piece !== PAWN) {\n        const disambiguator = getDisambiguator(move, moves);\n        output += move.piece.toUpperCase() + disambiguator;\n      }\n      if (move.flags & (BITS.CAPTURE | BITS.EP_CAPTURE)) {\n        if (move.piece === PAWN) {\n          output += algebraic(move.from)[0];\n        }\n        output += 'x';\n      }\n      output += algebraic(move.to);\n      if (move.promotion) {\n        output += `=${move.promotion.toUpperCase()}`;\n      }\n    }\n    this._makeMove(move);\n    if (this.isCheck()) {\n      if (this.isCheckmate()) {\n        output += '#';\n      } else {\n        output += '+';\n      }\n    }\n    this._undoMove();\n    return output;\n  }\n  // convert a move from Standard Algebraic Notation (SAN) to 0x88 coordinates\n  _moveFromSan(move, strict = false) {\n    // strip off any move decorations: e.g Nf3+?! becomes Nf3\n    const cleanMove = strippedSan(move);\n    let pieceType = inferPieceType(cleanMove);\n    let moves = this._moves({ legal: true, piece: pieceType });\n    // strict parser\n    for (let i = 0, len = moves.length; i < len; i++) {\n      if (cleanMove === strippedSan(this._moveToSan(moves[i], moves))) {\n        return moves[i];\n      }\n    }\n    // the strict parser failed\n    if (strict) {\n      return null;\n    }\n    let piece = undefined;\n    let matches = undefined;\n    let from = undefined;\n    let to = undefined;\n    let promotion = undefined;\n    /*\n     * The default permissive (non-strict) parser allows the user to parse\n     * non-standard chess notations. This parser is only run after the strict\n     * Standard Algebraic Notation (SAN) parser has failed.\n     *\n     * When running the permissive parser, we'll run a regex to grab the piece, the\n     * to/from square, and an optional promotion piece. This regex will\n     * parse common non-standard notation like: Pe2-e4, Rc1c4, Qf3xf7,\n     * f7f8q, b1c3\n     *\n     * NOTE: Some positions and moves may be ambiguous when using the permissive\n     * parser. For example, in this position: 6k1/8/8/B7/8/8/8/BN4K1 w - - 0 1,\n     * the move b1c3 may be interpreted as Nc3 or B1c3 (a disambiguated bishop\n     * move). In these cases, the permissive parser will default to the most\n     * basic interpretation (which is b1c3 parsing to Nc3).\n     */\n    let overlyDisambiguated = false;\n    matches = cleanMove.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);\n    if (matches) {\n      piece = matches[1];\n      from = matches[2];\n      to = matches[3];\n      promotion = matches[4];\n      if (from.length === 1) {\n        overlyDisambiguated = true;\n      }\n    } else {\n      /*\n       * The [a-h]?[1-8]? portion of the regex below handles moves that may be\n       * overly disambiguated (e.g. Nge7 is unnecessary and non-standard when\n       * there is one legal knight move to e7). In this case, the value of\n       * 'from' variable will be a rank or file, not a square.\n       */\n      matches = cleanMove.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/);\n      if (matches) {\n        piece = matches[1];\n        from = matches[2];\n        to = matches[3];\n        promotion = matches[4];\n        if (from.length === 1) {\n          overlyDisambiguated = true;\n        }\n      }\n    }\n    pieceType = inferPieceType(cleanMove);\n    moves = this._moves({\n      legal: true,\n      piece: piece ? piece : pieceType,\n    });\n    if (!to) {\n      return null;\n    }\n    for (let i = 0, len = moves.length; i < len; i++) {\n      if (!from) {\n        // if there is no from square, it could be just 'x' missing from a capture\n        if (cleanMove === strippedSan(this._moveToSan(moves[i], moves)).replace('x', '')) {\n          return moves[i];\n        }\n        // hand-compare move properties with the results from our permissive regex\n      } else if (\n        (!piece || piece.toLowerCase() === moves[i].piece) &&\n        Ox88[from] === moves[i].from &&\n        Ox88[to] === moves[i].to &&\n        (!promotion || promotion.toLowerCase() === moves[i].promotion)\n      ) {\n        return moves[i];\n      } else if (overlyDisambiguated) {\n        /*\n         * SPECIAL CASE: we parsed a move string that may have an unneeded\n         * rank/file disambiguator (e.g. Nge7).  The 'from' variable will\n         */\n        const square = algebraic(moves[i].from);\n        if (\n          (!piece || piece.toLowerCase() === moves[i].piece) &&\n          Ox88[to] === moves[i].to &&\n          (from === square[0] || from === square[1]) &&\n          (!promotion || promotion.toLowerCase() === moves[i].promotion)\n        ) {\n          return moves[i];\n        }\n      }\n    }\n    return null;\n  }\n  ascii() {\n    let s = '   +------------------------+\\n';\n    for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n      // display the rank\n      if (file(i) === 0) {\n        s += ` ${'87654321'[rank(i)]} |`;\n      }\n      if (this._board[i]) {\n        const piece = this._board[i].type;\n        const color = this._board[i].color;\n        const symbol = color === WHITE ? piece.toUpperCase() : piece.toLowerCase();\n        s += ` ${symbol} `;\n      } else {\n        s += ' . ';\n      }\n      if ((i + 1) & 0x88) {\n        s += '|\\n';\n        i += 8;\n      }\n    }\n    s += '   +------------------------+\\n';\n    s += '     a  b  c  d  e  f  g  h';\n    return s;\n  }\n  perft(depth) {\n    const moves = this._moves({ legal: false });\n    let nodes = 0;\n    const color = this._turn;\n    for (let i = 0, len = moves.length; i < len; i++) {\n      this._makeMove(moves[i]);\n      if (!this._isKingAttacked(color)) {\n        if (depth - 1 > 0) {\n          nodes += this.perft(depth - 1);\n        } else {\n          nodes++;\n        }\n      }\n      this._undoMove();\n    }\n    return nodes;\n  }\n  turn() {\n    return this._turn;\n  }\n  board() {\n    const output = [];\n    let row = [];\n    for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n      if (this._board[i] == null) {\n        row.push(null);\n      } else {\n        row.push({\n          square: algebraic(i),\n          type: this._board[i].type,\n          color: this._board[i].color,\n        });\n      }\n      if ((i + 1) & 0x88) {\n        output.push(row);\n        row = [];\n        i += 8;\n      }\n    }\n    return output;\n  }\n  squareColor(square) {\n    if (square in Ox88) {\n      const sq = Ox88[square];\n      return (rank(sq) + file(sq)) % 2 === 0 ? 'light' : 'dark';\n    }\n    return null;\n  }\n  history({ verbose = false } = {}) {\n    const reversedHistory = [];\n    const moveHistory = [];\n    while (this._history.length > 0) {\n      reversedHistory.push(this._undoMove());\n    }\n    while (true) {\n      const move = reversedHistory.pop();\n      if (!move) {\n        break;\n      }\n      if (verbose) {\n        moveHistory.push(new Move(this, move));\n      } else {\n        moveHistory.push(this._moveToSan(move, this._moves()));\n      }\n      this._makeMove(move);\n    }\n    return moveHistory;\n  }\n  /*\n   * Keeps track of position occurrence counts for the purpose of repetition\n   * checking. All three methods (`_inc`, `_dec`, and `_get`) trim the\n   * irrelevent information from the fen, initialising new positions, and\n   * removing old positions from the record if their counts are reduced to 0.\n   */\n  _getPositionCount(fen) {\n    const trimmedFen = trimFen(fen);\n    return this._positionCount[trimmedFen] || 0;\n  }\n  _incPositionCount(fen) {\n    const trimmedFen = trimFen(fen);\n    if (this._positionCount[trimmedFen] === undefined) {\n      this._positionCount[trimmedFen] = 0;\n    }\n    this._positionCount[trimmedFen] += 1;\n  }\n  _decPositionCount(fen) {\n    const trimmedFen = trimFen(fen);\n    if (this._positionCount[trimmedFen] === 1) {\n      delete this._positionCount[trimmedFen];\n    } else {\n      this._positionCount[trimmedFen] -= 1;\n    }\n  }\n  _pruneComments() {\n    const reversedHistory = [];\n    const currentComments = {};\n    const copyComment = (fen) => {\n      if (fen in this._comments) {\n        currentComments[fen] = this._comments[fen];\n      }\n    };\n    while (this._history.length > 0) {\n      reversedHistory.push(this._undoMove());\n    }\n    copyComment(this.fen());\n    while (true) {\n      const move = reversedHistory.pop();\n      if (!move) {\n        break;\n      }\n      this._makeMove(move);\n      copyComment(this.fen());\n    }\n    this._comments = currentComments;\n  }\n  getComment() {\n    return this._comments[this.fen()];\n  }\n  setComment(comment) {\n    this._comments[this.fen()] = comment.replace('{', '[').replace('}', ']');\n  }\n  /**\n   * @deprecated Renamed to `removeComment` for consistency\n   */\n  deleteComment() {\n    return this.removeComment();\n  }\n  removeComment() {\n    const comment = this._comments[this.fen()];\n    delete this._comments[this.fen()];\n    return comment;\n  }\n  getComments() {\n    this._pruneComments();\n    return Object.keys(this._comments).map((fen) => {\n      return { fen, comment: this._comments[fen] };\n    });\n  }\n  /**\n   * @deprecated Renamed to `removeComments` for consistency\n   */\n  deleteComments() {\n    return this.removeComments();\n  }\n  removeComments() {\n    this._pruneComments();\n    return Object.keys(this._comments).map((fen) => {\n      const comment = this._comments[fen];\n      delete this._comments[fen];\n      return { fen, comment };\n    });\n  }\n  setCastlingRights(color, rights) {\n    for (const side of [KING, QUEEN]) {\n      if (rights[side] !== undefined) {\n        if (rights[side]) {\n          this._castling[color] |= SIDES[side];\n        } else {\n          this._castling[color] &= ~SIDES[side];\n        }\n      }\n    }\n    this._updateCastlingRights();\n    const result = this.getCastlingRights(color);\n    return (\n      (rights[KING] === undefined || rights[KING] === result[KING]) &&\n      (rights[QUEEN] === undefined || rights[QUEEN] === result[QUEEN])\n    );\n  }\n  getCastlingRights(color) {\n    return {\n      [KING]: (this._castling[color] & SIDES[KING]) !== 0,\n      [QUEEN]: (this._castling[color] & SIDES[QUEEN]) !== 0,\n    };\n  }\n  moveNumber() {\n    return this._moveNumber;\n  }\n}\n//# sourceMappingURL=chess.js.map\n","/**\n * Service for managing chess positions and FEN conversion\n * @module services/PositionService\n * @since 2.0.0\n */\n\nimport { Chess, validateFen } from '../utils/chess.js';\nimport {\n  STANDARD_POSITIONS,\n  DEFAULT_STARTING_POSITION,\n  BOARD_LETTERS,\n} from '../constants/positions.js';\nimport { ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\n\n/**\n * Service responsible for position management and FEN operations\n * @class\n */\nexport class PositionService {\n  /**\n   * Creates a new PositionService instance\n   * @param {ChessboardConfig} config - Board configuration\n   */\n  constructor(config) {\n    this.config = config;\n    this.game = null;\n  }\n\n  /**\n   * Converts various position formats to FEN string\n   * @param {string|Object} position - Position in various formats\n   * @returns {string} FEN string representation\n   * @throws {ValidationError} When position format is invalid\n   */\n  convertFen(position) {\n    if (typeof position === 'string') {\n      return this._convertStringPosition(position);\n    } else if (typeof position === 'object' && position !== null) {\n      return this._convertObjectPosition(position);\n    }\n    throw new ValidationError(ERROR_MESSAGES.invalid_position + position, 'position', position);\n  }\n\n  /**\n   * Converts string position to FEN\n   * @private\n   * @param {string} position - String position\n   * @returns {string} FEN string\n   */\n  _convertStringPosition(position) {\n    if (position === 'start') {\n      return DEFAULT_STARTING_POSITION;\n    }\n\n    if (this.validateFen(position)) {\n      return position;\n    }\n\n    if (STANDARD_POSITIONS[position]) {\n      return STANDARD_POSITIONS[position];\n    }\n\n    throw new ValidationError(ERROR_MESSAGES.invalid_position + position, 'position', position);\n  }\n\n  /**\n   * Converts object position to FEN\n   * @private\n   * @param {Object} position - Object with square->piece mapping\n   * @returns {string} FEN string\n   */\n  _convertObjectPosition(position) {\n    const parts = [];\n\n    for (let row = 0; row < 8; row++) {\n      const rowParts = [];\n      let empty = 0;\n\n      for (let col = 0; col < 8; col++) {\n        const square = this._getSquareID(row, col);\n        const piece = position[square];\n\n        if (piece) {\n          if (empty > 0) {\n            rowParts.push(empty);\n            empty = 0;\n          }\n          // Convert piece notation: white pieces become uppercase, black remain lowercase\n          const fenPiece = piece[1] === 'w' ? piece[0].toUpperCase() : piece[0].toLowerCase();\n          rowParts.push(fenPiece);\n        } else {\n          empty++;\n        }\n      }\n\n      if (empty > 0) {\n        rowParts.push(empty);\n      }\n\n      parts.push(rowParts.join(''));\n    }\n\n    return `${parts.join('/')} w KQkq - 0 1`;\n  }\n\n  /**\n   * Sets up the game with the given position\n   * @param {string|Object} position - Position to set\n   * @param {Object} [options] - Additional options for game setup\n   */\n  setGame(position, options = {}) {\n    const fen = this.convertFen(position);\n\n    if (this.game) {\n      this.game.load(fen, options);\n    } else {\n      this.game = new Chess(fen);\n    }\n  }\n\n  /**\n   * Gets the current game instance\n   * @returns {Chess} Current chess.js game instance\n   */\n  getGame() {\n    return this.game;\n  }\n\n  /**\n   * Validates a FEN string\n   * @param {string} fen - FEN string to validate\n   * @returns {boolean} True if valid, false otherwise\n   */\n  validateFen(fen) {\n    return validateFen(fen);\n  }\n\n  /**\n   * Gets piece information for a specific square\n   * @param {string} squareId - Square identifier\n   * @returns {string|null} Piece ID or null if no piece\n   */\n  getGamePieceId(squareId) {\n    if (!this.game) return null;\n    const piece = this.game.get(squareId);\n    return piece ? piece.color + piece.type : null;\n  }\n\n  /**\n   * Checks if a specific piece is on a specific square\n   * @param {string} piece - Piece ID to check\n   * @param {string} square - Square to check\n   * @returns {boolean} True if piece is on square\n   */\n  isPiece(piece, square) {\n    return this.getGamePieceId(square) === piece;\n  }\n\n  /**\n   * Converts board coordinates to square ID\n   * @private\n   * @param {number} row - Row index (0-7)\n   * @param {number} col - Column index (0-7)\n   * @returns {string} Square ID (e.g., 'e4')\n   */\n  _getSquareID(row, col) {\n    row = parseInt(row);\n    col = parseInt(col);\n\n    if (this.config.orientation === 'w') {\n      row = 8 - row;\n      col = col + 1;\n    } else {\n      row = row + 1;\n      col = 8 - col;\n    }\n\n    const letter = BOARD_LETTERS[col - 1];\n    return letter + row;\n  }\n\n  /**\n   * Changes the turn in a FEN string\n   * @param {string} fen - Original FEN string\n   * @param {string} color - New turn color ('w' or 'b')\n   * @returns {string} Modified FEN string\n   */\n  changeFenTurn(fen, color) {\n    const parts = fen.split(' ');\n    parts[1] = color;\n    return parts.join(' ');\n  }\n\n  /**\n   * Gets the current position as an object\n   * @returns {Object} Position object with piece placements\n   */\n  getPosition() {\n    const position = {};\n    const game = this.getGame();\n\n    // Convert chess.js board to position object\n    const squares = [\n      'a1',\n      'b1',\n      'c1',\n      'd1',\n      'e1',\n      'f1',\n      'g1',\n      'h1',\n      'a2',\n      'b2',\n      'c2',\n      'd2',\n      'e2',\n      'f2',\n      'g2',\n      'h2',\n      'a3',\n      'b3',\n      'c3',\n      'd3',\n      'e3',\n      'f3',\n      'g3',\n      'h3',\n      'a4',\n      'b4',\n      'c4',\n      'd4',\n      'e4',\n      'f4',\n      'g4',\n      'h4',\n      'a5',\n      'b5',\n      'c5',\n      'd5',\n      'e5',\n      'f5',\n      'g5',\n      'h5',\n      'a6',\n      'b6',\n      'c6',\n      'd6',\n      'e6',\n      'f6',\n      'g6',\n      'h6',\n      'a7',\n      'b7',\n      'c7',\n      'd7',\n      'e7',\n      'f7',\n      'g7',\n      'h7',\n      'a8',\n      'b8',\n      'c8',\n      'd8',\n      'e8',\n      'f8',\n      'g8',\n      'h8',\n    ];\n\n    for (const square of squares) {\n      const piece = game.get(square);\n      if (piece) {\n        position[square] = piece.type + piece.color;\n      }\n    }\n\n    return position;\n  }\n\n  /**\n   * Toggles the turn in a FEN string\n   * @param {string} fen - Original FEN string\n   * @returns {string} Modified FEN string\n   */\n  changeFenColor(fen) {\n    const parts = fen.split(' ');\n    parts[1] = parts[1] === 'w' ? 'b' : 'w';\n    return parts.join(' ');\n  }\n\n  /**\n   * Cleans up resources\n   */\n  destroy() {\n    this.game = null;\n  }\n}\n","/**\n * Main Chessboard class - Orchestrates all services and components\n * @module core/Chessboard\n * @since 2.0.0\n */\n\nimport ChessboardConfig from './ChessboardConfig.js';\nimport Move from '../components/Move.js';\nimport {\n  AnimationService,\n  BoardService,\n  CoordinateService,\n  EventService,\n  MoveService,\n  PieceService,\n  PositionService,\n  ValidationService,\n} from '../services/index.js';\nimport { ChessboardError, ConfigurationError } from '../errors/ChessboardError.js';\nimport { PerformanceMonitor } from '../utils/performance.js';\n\n/**\n * Main Chessboard class responsible for coordinating all services\n * Implements the Facade pattern to provide a unified interface\n * @class\n */\nclass Chessboard {\n  /**\n   * Creates a new Chessboard instance\n   * @param {Object} config - Configuration object\n   * @throws {ConfigurationError} If configuration is invalid\n   */\n  constructor(config) {\n    try {\n      // Initialize performance monitoring\n      this._performanceMonitor = new PerformanceMonitor();\n      this._performanceMonitor.startMeasure('chessboard-initialization');\n\n      // Validate and initialize configuration\n      this._validateAndInitializeConfig(config);\n\n      // Initialize services\n      this._initializeServices();\n\n      // Initialize the board\n      this._initialize();\n\n      this._performanceMonitor.endMeasure('chessboard-initialization');\n    } catch (error) {\n      this._handleConstructorError(error);\n    }\n    this._undoneMoves = [];\n    this._updateBoardPieces(true, true); // Forza popolamento DOM subito\n  }\n\n  /**\n   * Validates and initializes configuration\n   * @private\n   * @param {Object} config - Raw configuration object\n   * @throws {ConfigurationError} If configuration is invalid\n   */\n  _validateAndInitializeConfig(config) {\n    if (!config || typeof config !== 'object') {\n      throw new ConfigurationError('Configuration must be an object', 'config', config);\n    }\n\n    this.config = new ChessboardConfig(config);\n\n    // Validate required configuration\n    if (!this.config.id_div) {\n      throw new ConfigurationError(\n        'Configuration must include id_div',\n        'id_div',\n        this.config.id_div\n      );\n    }\n  }\n\n  /**\n   * Handles constructor errors gracefully\n   * @private\n   * @param {Error} error - Error that occurred during construction\n   */\n  _handleConstructorError(error) {\n    console.error('Chessboard initialization failed:', error);\n\n    // Clean up any partially initialized resources\n    this._cleanup();\n\n    // Re-throw with additional context\n    if (error instanceof ChessboardError) {\n      throw error;\n    } else {\n      throw new ChessboardError('Failed to initialize chessboard', 'INITIALIZATION_ERROR', {\n        originalError: error.message,\n        stack: error.stack,\n      });\n    }\n  }\n\n  /**\n   * Cleans up any partially initialized resources (safe to call multiple times)\n   * @private\n   */\n  _cleanup() {\n    // Remove event listeners if present\n    if (this.eventService && typeof this.eventService.removeListeners === 'function') {\n      this.eventService.removeListeners();\n    }\n    // Clear timeouts\n    if (this._updateTimeout) {\n      clearTimeout(this._updateTimeout);\n      this._updateTimeout = null;\n    }\n    // Null all services\n    this.validationService = null;\n    this.coordinateService = null;\n    this.positionService = null;\n    this.boardService = null;\n    this.pieceService = null;\n    this.animationService = null;\n    this.moveService = null;\n    this.eventService = null;\n  }\n\n  /**\n   * Initializes all services\n   * @private\n   */\n  _initializeServices() {\n    // Core services\n    this.validationService = new ValidationService();\n    this.coordinateService = new CoordinateService(this.config);\n    this.positionService = new PositionService(this.config);\n    this.boardService = new BoardService(this.config);\n    this.pieceService = new PieceService(this.config);\n    this.animationService = new AnimationService(this.config);\n    this.moveService = new MoveService(this.config, this.positionService);\n    this.eventService = new EventService(\n      this.config,\n      this.boardService,\n      this.moveService,\n      this.coordinateService,\n      this\n    );\n\n    // State management\n    this._updateTimeout = null;\n    this._isAnimating = false;\n\n    // Bind methods to preserve context\n    this._boundUpdateBoardPieces = this._updateBoardPieces.bind(this);\n    this._boundOnSquareClick = this._onSquareClick.bind(this);\n    this._boundOnPieceHover = this._onPieceHover.bind(this);\n    this._boundOnPieceLeave = this._onPieceLeave.bind(this);\n  }\n\n  /**\n   * Initializes the board\n   * @private\n   */\n  _initialize() {\n    this._initParams();\n    this._setGame(this.config.position);\n    this._buildBoard();\n    this._buildSquares();\n    this._addListeners();\n    this._updateBoardPieces(true, true); // Initial position load\n  }\n\n  /**\n   * Initializes parameters and state\n   * @private\n   */\n  _initParams() {\n    // Reset state\n    this.eventService.setClicked(null);\n    this.eventService.setPromoting(false);\n    this.eventService.setAnimating(false);\n  }\n\n  /**\n   * Sets up the game with initial position\n   * @private\n   * @param {string|Object} position - Initial position\n   */\n  _setGame(position) {\n    this.positionService.setGame(position);\n  }\n\n  /**\n   * Builds the board DOM structure\n   * @private\n   * Best practice: always remove squares (destroy JS/DOM) before clearing the board container.\n   */\n  _buildBoard() {\n    // Debug: _buildBoard called\n    if (this._isUndoRedo) {\n      // Skip _buildBoard for undo/redo\n      return;\n    }\n    // Forza la pulizia completa del contenitore board (DOM)\n    const boardContainer = document.getElementById(this.config.id_div);\n    if (boardContainer) boardContainer.innerHTML = '';\n    // Force remove all pieces from all squares (no animation, best practice)\n    if (this.boardService && this.boardService.squares) {\n      Object.values(this.boardService.squares).forEach(\n        (sq) => sq && sq.forceRemoveAllPieces && sq.forceRemoveAllPieces()\n      );\n    }\n    if (this.boardService && this.boardService.removeSquares) this.boardService.removeSquares();\n    if (this.boardService && this.boardService.removeBoard) this.boardService.removeBoard();\n    this.boardService.buildBoard();\n  }\n\n  /**\n   * Builds all squares on the board\n   * @private\n   */\n  _buildSquares() {\n    // Debug: _buildSquares called\n    if (this._isUndoRedo) {\n      // Skip _buildSquares for undo/redo\n      return;\n    }\n    if (this.boardService && this.boardService.removeSquares) {\n      this.boardService.removeSquares();\n    }\n    this.boardService.buildSquares((row, col) => {\n      return this.coordinateService.realCoord(row, col);\n    });\n  }\n\n  /**\n   * Adds event listeners to squares\n   * @private\n   */\n  _addListeners() {\n    this.eventService.addListeners(\n      this._boundOnSquareClick,\n      this._boundOnPieceHover,\n      this._boundOnPieceLeave\n    );\n  }\n\n  /**\n   * Handles square click events\n   * @private\n   * @param {Square} square - Clicked square\n   * @param {boolean} [animate=true] - Whether to animate\n   * @param {boolean} [dragged=false] - Whether triggered by drag\n   * @returns {boolean} True if successful\n   */\n  _onSquareClick(square, animate = true, dragged = false) {\n    return this.eventService.onClick(\n      square,\n      this._onMove.bind(this),\n      this._onSelect.bind(this),\n      this._onDeselect.bind(this),\n      animate,\n      dragged\n    );\n  }\n\n  /**\n   * Handles piece hover events\n   * @private\n   * @param {Square} square - Hovered square\n   */\n  _onPieceHover(square) {\n    if (this.config.hints && !this.eventService.getClicked()) {\n      // Only show hints if no square is selected\n      this._hintMoves(square);\n    }\n  }\n\n  /**\n   * Handles piece leave events\n   * @private\n   * @param {Square} square - Left square\n   */\n  _onPieceLeave(square) {\n    if (this.config.hints && !this.eventService.getClicked()) {\n      // Only remove hints if no square is selected\n      this._dehintMoves(square);\n    }\n  }\n\n  /**\n   * Handles move execution\n   * @private\n   * @param {Square} fromSquare - Source square\n   * @param {Square} toSquare - Target square\n   * @param {string} [promotion] - Promotion piece\n   * @param {boolean} [animate=true] - Whether to animate\n   * @returns {boolean} True if move was successful\n   */\n  _onMove(fromSquare, toSquare, promotion = null, animate = true) {\n    const move = new Move(fromSquare, toSquare, promotion);\n\n    // 1. Validate the move\n    if (\n      !move.check() ||\n      (this.config.onlyLegalMoves && !move.isLegal(this.positionService.getGame()))\n    ) {\n      this._clearVisualState(); // Always clear state on invalid move\n      return false;\n    }\n\n    // 2. Check for promotion (if not already provided)\n    if (!move.hasPromotion() && this._requiresPromotion(move)) {\n      // Promotion is required but not provided, let the promotion handler take over.\n      // Do not execute the move here.\n      return false;\n    }\n\n    // 3. Execute the move\n    // The onMove callback is for the user to approve the move, not to execute it.\n    if (this.config.onMove(move)) {\n      this._executeMove(move, animate);\n      return true;\n    }\n\n    // 4. If user rejects the move, clear state\n    this._clearVisualState();\n    return false;\n  }\n\n  /**\n   * Handles square selection\n   * @private\n   * @param {Square} square - Selected square\n   */\n  _onSelect(square) {\n    if (this.config.clickable) {\n      square.select();\n      this._hintMoves(square);\n    }\n  }\n\n  /**\n   * Handles square deselection\n   * @private\n   */\n  _onDeselect() {\n    this._clearVisualState();\n  }\n\n  /**\n   * Shows legal move hints for a square\n   * @private\n   * @param {Square} square - Square to show hints for\n   */\n  _hintMoves(square) {\n    if (!this.moveService.canMove(square)) return;\n\n    // Clear existing hints first\n    this.boardService.applyToAllSquares('removeHint');\n\n    const moves = this.moveService.getCachedLegalMoves(square);\n\n    for (const move of moves) {\n      if (move.to && move.to.length === 2) {\n        const targetSquare = this.boardService.getSquare(move.to);\n        if (targetSquare) {\n          const hasEnemyPiece =\n            targetSquare.piece &&\n            targetSquare.piece.color !== this.positionService.getGame().turn();\n          targetSquare.putHint(hasEnemyPiece);\n        }\n      }\n    }\n  }\n\n  /**\n   * Removes legal move hints for a square\n   * @private\n   * @param {Square} square - Square to remove hints for\n   */\n  _dehintMoves(square) {\n    const moves = this.moveService.getCachedLegalMoves(square);\n\n    for (const move of moves) {\n      if (move.to && move.to.length === 2) {\n        const targetSquare = this.boardService.getSquare(move.to);\n        if (targetSquare) {\n          targetSquare.removeHint();\n        }\n      }\n    }\n  }\n\n  /**\n   * Checks if a move requires promotion\n   * @private\n   * @param {Move} move - Move to check\n   * @returns {boolean} True if promotion is required\n   */\n  _requiresPromotion(move) {\n    return this.moveService.requiresPromotion(move);\n  }\n\n  /**\n   * Executes a move\n   * @private\n   * @param {Move} move - Move to execute\n   * @param {boolean} [animate=true] - Whether to animate\n   */\n  _executeMove(move, animate = true) {\n    // Always clear visual state before executing a move to prevent artifacts\n    this._clearVisualState();\n\n    const game = this.positionService.getGame();\n    if (!game) {\n      throw new ChessboardError('Game not initialized', 'GAME_ERROR');\n    }\n\n    // Execute the move on the game engine\n    const gameMove = this.moveService.executeMove(move);\n    if (!gameMove) {\n      // This should not happen if validation passed, but as a safeguard:\n      console.error('Move execution failed unexpectedly for move:', move);\n      this._updateBoardPieces(false); // Sync board with game state\n      return;\n    }\n\n    // Clear previous move highlights\n    this.boardService.applyToAllSquares('unmoved');\n\n    // Mark squares as moved for styling\n    move.from.moved();\n    move.to.moved();\n\n    // Handle animations and special moves (castle, en-passant)\n    const isCastle = this.moveService.isCastle(gameMove);\n    const isEnPassant = this.moveService.isEnPassant(gameMove);\n\n    if (animate && move.from.piece) {\n      this.pieceService.translatePiece(\n        move,\n        !!move.to.piece, // was there a capture?\n        animate,\n        this._createDragFunction.bind(this),\n        () => {\n          // After the main piece animation completes...\n          if (isCastle) {\n            this._handleSpecialMoveAnimation(gameMove);\n          } else if (isEnPassant) {\n            this._handleSpecialMoveAnimation(gameMove);\n          }\n          // Notify user that the move is fully complete\n          this.config.onMoveEnd(gameMove);\n          // A final sync to ensure board is perfect\n          this._updateBoardPieces(false);\n        }\n      );\n\n      // For simultaneous castle, animate the rook alongside the king\n      if (isCastle && this.config.animationStyle === 'simultaneous') {\n        setTimeout(() => {\n          this._handleCastleMove(gameMove, true);\n        }, this.config.simultaneousAnimationDelay);\n      }\n    } else {\n      // If not animating, handle special moves immediately and update the board\n      if (isCastle) {\n        this._handleSpecialMove(gameMove);\n      } else if (isEnPassant) {\n        this._handleSpecialMove(gameMove);\n      }\n      this._updateBoardPieces(false);\n      this.config.onMoveEnd(gameMove);\n    }\n  }\n\n  /**\n   * Handles special moves (castle, en passant) without animation\n   * @private\n   * @param {Object} gameMove - Game move object\n   */\n  _handleSpecialMove(gameMove) {\n    if (this.moveService.isCastle(gameMove)) {\n      this._handleCastleMove(gameMove, false);\n    } else if (this.moveService.isEnPassant(gameMove)) {\n      this._handleEnPassantMove(gameMove, false);\n    }\n  }\n\n  /**\n   * Handles special moves (castle, en passant) with animation\n   * @private\n   * @param {Object} gameMove - Game move object\n   */\n  _handleSpecialMoveAnimation(gameMove) {\n    if (this.moveService.isCastle(gameMove)) {\n      this._handleCastleMove(gameMove, true);\n    } else if (this.moveService.isEnPassant(gameMove)) {\n      this._handleEnPassantMove(gameMove, true);\n    }\n  }\n\n  /**\n   * Handles castle move by moving the rook\n   * @private\n   * @param {Object} gameMove - Game move object\n   * @param {boolean} animate - Whether to animate\n   */\n  _handleCastleMove(gameMove, animate) {\n    const rookMove = this.moveService.getCastleRookMove(gameMove);\n    if (!rookMove) return;\n\n    const rookFromSquare = this.boardService.getSquare(rookMove.from);\n    const rookToSquare = this.boardService.getSquare(rookMove.to);\n\n    if (!rookFromSquare || !rookToSquare || !rookFromSquare.piece) {\n      console.warn('Castle rook move failed - squares or piece not found');\n      return;\n    }\n\n    if (animate) {\n      // Always use translatePiece for smooth sliding animation\n      const rookPiece = rookFromSquare.piece;\n      this.pieceService.translatePiece(\n        { from: rookFromSquare, to: rookToSquare, piece: rookPiece },\n        false, // No capture for rook in castle\n        animate,\n        this._createDragFunction.bind(this),\n        () => {\n          // After rook animation, update board state\n          this._updateBoardPieces(false);\n        }\n      );\n    } else {\n      // Just update the board state\n      this._updateBoardPieces(false);\n    }\n  }\n\n  /**\n   * Handles en passant move by removing the captured pawn\n   * @private\n   * @param {Object} gameMove - Game move object\n   * @param {boolean} animate - Whether to animate\n   */\n  _handleEnPassantMove(gameMove, animate) {\n    const capturedSquare = this.moveService.getEnPassantCapturedSquare(gameMove);\n    if (!capturedSquare) return;\n\n    const capturedSquareObj = this.boardService.getSquare(capturedSquare);\n    if (!capturedSquareObj || !capturedSquareObj.piece) {\n      console.warn('En passant captured square not found or empty');\n      return;\n    }\n\n    if (animate) {\n      // Animate the captured pawn removal\n      this.pieceService.removePieceFromSquare(capturedSquareObj, true);\n      // Update board state after animation\n      setTimeout(() => {\n        this._updateBoardPieces(false);\n      }, this.config.moveTime);\n    } else {\n      // Just update the board state\n      this._updateBoardPieces(false);\n    }\n  }\n\n  /**\n   * Updates board pieces to match game state\n   * @private\n   * @param {boolean} [animation=false] - Whether to animate\n   * @param {boolean} [isPositionLoad=false] - Whether this is a position load\n   */\n  _updateBoardPieces(animation = false, isPositionLoad = false) {\n    // Check if services are available\n    if (!this.positionService || !this.moveService || !this.eventService) {\n      return;\n    }\n\n    // Clear any pending update\n    if (this._updateTimeout) {\n      clearTimeout(this._updateTimeout);\n      this._updateTimeout = null;\n    }\n\n    // Clear moves cache\n    this.moveService.clearCache();\n\n    // Add small delay for click-to-move to avoid lag\n    if (animation && !this.eventService.getClicked()) {\n      this._updateTimeout = setTimeout(() => {\n        this._doUpdateBoardPieces(animation, isPositionLoad);\n        this._updateTimeout = null;\n\n        // Ensure hints are available for the next turn\n        this._ensureHintsAvailable();\n      }, 10);\n    } else {\n      this._doUpdateBoardPieces(animation, isPositionLoad);\n\n      // Ensure hints are available for the next turn\n      this._ensureHintsAvailable();\n    }\n  }\n\n  /**\n   * Ensures hints are available for the current turn\n   * @private\n   */\n  _ensureHintsAvailable() {\n    if (!this.config.hints) return;\n\n    // Small delay to ensure the board state is fully updated\n    setTimeout(() => {\n      // Clear any existing hints\n      this.boardService.applyToAllSquares('removeHint');\n\n      // The hints will be shown when the user hovers over pieces\n      // This just ensures the cache is ready\n      this.moveService.clearCache();\n    }, 50);\n  }\n\n  /**\n   * Updates board pieces after a delayed move\n   * @private\n   */\n  _updateBoardPiecesDelayed() {\n    this._updateBoardPieces(false);\n  }\n\n  /**\n   * Performs the actual board update\n   * @private\n   * @param {boolean} [animation=false] - Whether to animate\n   * @param {boolean} [isPositionLoad=false] - Whether this is a position load (affects delay)\n   */\n  _doUpdateBoardPieces(animation = false, isPositionLoad = false) {\n    // Skip update if we're in the middle of a promotion\n    if (this._isPromoting) {\n      return;\n    }\n\n    // Check if services are available\n    if (!this.positionService || !this.positionService.getGame()) {\n      return;\n    }\n\n    const squares = this.boardService.getAllSquares();\n    const gameStateBefore = this.positionService.getGame().fen();\n\n    // Determine which animation style to use\n    const useSimultaneous = this.config.animationStyle === 'simultaneous';\n\n    if (useSimultaneous) {\n      this._doSimultaneousUpdate(squares, gameStateBefore, isPositionLoad);\n    } else {\n      this._doSequentialUpdate(squares, gameStateBefore, animation);\n    }\n  }\n\n  /**\n   * Performs sequential piece updates (original behavior)\n   * @private\n   * @param {Object} squares - All squares\n   * @param {string} gameStateBefore - Game state before update\n   * @param {boolean} animation - Whether to animate\n   */\n  _doSequentialUpdate(squares, gameStateBefore, animation) {\n    // Mappa: squareId -> expectedPieceId\n    const expectedMap = {};\n    Object.values(squares).forEach((square) => {\n      expectedMap[square.id] = this.positionService.getGamePieceId(square.id);\n    });\n\n    Object.values(squares).forEach((square) => {\n      const expectedPieceId = expectedMap[square.id];\n      const currentPiece = square.piece;\n      const currentPieceId = currentPiece ? currentPiece.getId() : null;\n\n      // Se il pezzo attuale e quello atteso sono identici, non fare nulla\n      if (currentPieceId === expectedPieceId) {\n        return;\n      }\n\n      // Se c' un pezzo attuale ma non  quello atteso, rimuovilo\n      if (currentPiece && currentPieceId !== expectedPieceId) {\n        this.pieceService.removePieceFromSquare(square, animation);\n      }\n\n      // Se c' un pezzo atteso ma non  quello attuale, aggiungilo\n      if (expectedPieceId && currentPieceId !== expectedPieceId) {\n        const newPiece = this.pieceService.convertPiece(expectedPieceId);\n        this.pieceService.addPieceOnSquare(\n          square,\n          newPiece,\n          animation,\n          this._createDragFunction.bind(this)\n        );\n      }\n    });\n\n    this._addListeners();\n    const gameStateAfter = this.positionService.getGame().fen();\n    if (gameStateBefore !== gameStateAfter) {\n      this.config.onChange(gameStateAfter);\n    }\n  }\n\n  /**\n   * Performs simultaneous piece updates\n   * @private\n   * @param {Object} squares - All squares\n   * @param {string} gameStateBefore - Game state before update\n   * @param {boolean} [isPositionLoad=false] - Whether this is a position load\n   */\n  _doSimultaneousUpdate(squares, gameStateBefore, isPositionLoad = false) {\n    // Matching greedy per distanza minima, robusto\n    const currentMap = {};\n    const expectedMap = {};\n\n    Object.values(squares).forEach((square) => {\n      const currentPiece = square.piece;\n      const expectedPieceId = this.positionService.getGamePieceId(square.id);\n      if (currentPiece) {\n        // Normalizza la chiave come 'color+type' lowercase\n        const key = (currentPiece.color + currentPiece.type).toLowerCase();\n        if (!currentMap[key]) currentMap[key] = [];\n        currentMap[key].push({ square, id: square.id });\n      }\n      if (expectedPieceId) {\n        // Normalizza la chiave come 'color+type' lowercase\n        const key = expectedPieceId.toLowerCase();\n        if (!expectedMap[key]) expectedMap[key] = [];\n        expectedMap[key].push({ square, id: square.id });\n      }\n    });\n\n    let animationsCompleted = 0;\n    let totalAnimations = 0;\n    const animationDelay = isPositionLoad ? 0 : this.config.simultaneousAnimationDelay;\n    let animationIndex = 0;\n\n    Object.keys(expectedMap).forEach((key) => {\n      totalAnimations += Math.max((currentMap[key] || []).length, expectedMap[key].length);\n    });\n\n    if (totalAnimations === 0) {\n      this._addListeners();\n      const gameStateAfter = this.positionService.getGame().fen();\n      if (gameStateBefore !== gameStateAfter) {\n        this.config.onChange(gameStateAfter);\n      }\n      return;\n    }\n\n    const onAnimationComplete = () => {\n      animationsCompleted++;\n      if (animationsCompleted === totalAnimations) {\n        this._addListeners();\n        const gameStateAfter = this.positionService.getGame().fen();\n        if (gameStateBefore !== gameStateAfter) {\n          this.config.onChange(gameStateAfter);\n        }\n      }\n    };\n\n    Object.keys(expectedMap).forEach((key) => {\n      const fromList = (currentMap[key] || []).slice();\n      const toList = expectedMap[key].slice();\n\n      // 1. Costruisci matrice delle distanze\n      const distances = [];\n      for (let i = 0; i < fromList.length; i++) {\n        distances[i] = [];\n        for (let j = 0; j < toList.length; j++) {\n          distances[i][j] =\n            Math.abs(fromList[i].square.row - toList[j].square.row) +\n            Math.abs(fromList[i].square.col - toList[j].square.col);\n        }\n      }\n\n      // 2. Matching greedy: abbina i pi vicini\n      const fromMatched = new Array(fromList.length).fill(false);\n      const toMatched = new Array(toList.length).fill(false);\n      const moves = [];\n\n      while (true) {\n        let minDist = Infinity,\n          minI = -1,\n          minJ = -1;\n        for (let i = 0; i < fromList.length; i++) {\n          if (fromMatched[i]) continue;\n          for (let j = 0; j < toList.length; j++) {\n            if (toMatched[j]) continue;\n            if (distances[i][j] < minDist) {\n              minDist = distances[i][j];\n              minI = i;\n              minJ = j;\n            }\n          }\n        }\n        if (minI === -1 || minJ === -1) break;\n        // Se la posizione  la stessa, non fare nulla (pezzo unchanged)\n        if (fromList[minI].square === toList[minJ].square) {\n          fromMatched[minI] = true;\n          toMatched[minJ] = true;\n          continue;\n        }\n        // Altrimenti, sposta il pezzo\n        moves.push({\n          from: fromList[minI].square,\n          to: toList[minJ].square,\n          piece: fromList[minI].square.piece,\n        });\n        fromMatched[minI] = true;\n        toMatched[minJ] = true;\n      }\n\n      // 3. Rimuovi i pezzi non abbinati (presenti solo in fromList)\n      for (let i = 0; i < fromList.length; i++) {\n        if (!fromMatched[i]) {\n          setTimeout(() => {\n            this.pieceService.removePieceFromSquare(fromList[i].square, true, onAnimationComplete);\n          }, animationIndex * animationDelay);\n          animationIndex++;\n        }\n      }\n\n      // 4. Aggiungi i pezzi non abbinati (presenti solo in toList)\n      for (let j = 0; j < toList.length; j++) {\n        if (!toMatched[j]) {\n          setTimeout(() => {\n            const newPiece = this.pieceService.convertPiece(key);\n            this.pieceService.addPieceOnSquare(\n              toList[j].square,\n              newPiece,\n              true,\n              this._createDragFunction.bind(this),\n              onAnimationComplete\n            );\n          }, animationIndex * animationDelay);\n          animationIndex++;\n        }\n      }\n\n      // 5. Anima i movimenti\n      moves.forEach((move) => {\n        setTimeout(() => {\n          this.pieceService.translatePiece(\n            move,\n            false,\n            true,\n            this._createDragFunction.bind(this),\n            onAnimationComplete\n          );\n        }, animationIndex * animationDelay);\n        animationIndex++;\n      });\n    });\n  }\n\n  /**\n   * Analyzes position changes to determine optimal animation strategy\n   * @private\n   * @param {Object} squares - All squares\n   * @returns {Object} Analysis of changes\n   */\n  _analyzePositionChanges(squares) {\n    const currentPieces = new Map();\n    const expectedPieces = new Map();\n\n    // Map current and expected piece positions\n    Object.values(squares).forEach((square) => {\n      const currentPiece = square.piece;\n      const expectedPieceId = this.positionService.getGamePieceId(square.id);\n\n      if (currentPiece) {\n        currentPieces.set(square.id, currentPiece.getId());\n      }\n\n      if (expectedPieceId) {\n        expectedPieces.set(square.id, expectedPieceId);\n      }\n    });\n\n    // Identify different types of changes\n    const moves = []; // Pieces that can slide to new positions\n    const removes = []; // Pieces that need to be removed\n    const adds = []; // Pieces that need to be added\n    const unchanged = []; // Pieces that stay in place\n\n    // First pass: identify pieces that don't need to move (same piece type on same square)\n    const processedSquares = new Set();\n\n    currentPieces.forEach((currentPieceId, square) => {\n      const expectedPieceId = expectedPieces.get(square);\n\n      if (currentPieceId === expectedPieceId) {\n        // Same piece type on same square - no movement needed\n        unchanged.push({\n          piece: currentPieceId,\n          square,\n        });\n        processedSquares.add(square);\n      }\n    });\n\n    // Second pass: handle pieces that need to move or be removed\n    currentPieces.forEach((currentPieceId, fromSquare) => {\n      if (processedSquares.has(fromSquare)) {\n        return; // Already processed as unchanged\n      }\n\n      // Try to find a destination for this piece\n      const availableDestination = Array.from(expectedPieces.entries()).find(\n        ([toSquare, expectedId]) => expectedId === currentPieceId && !processedSquares.has(toSquare)\n      );\n\n      if (availableDestination) {\n        const [toSquare] = availableDestination;\n        moves.push({\n          piece: currentPieceId,\n          from: fromSquare,\n          to: toSquare,\n          fromSquare: squares[fromSquare],\n          toSquare: squares[toSquare],\n        });\n        processedSquares.add(toSquare);\n      } else {\n        // This piece needs to be removed\n        removes.push({\n          piece: currentPieceId,\n          square: fromSquare,\n          squareObj: squares[fromSquare],\n        });\n      }\n    });\n\n    // Third pass: handle pieces that need to be added\n    expectedPieces.forEach((expectedPieceId, toSquare) => {\n      if (!processedSquares.has(toSquare)) {\n        adds.push({\n          piece: expectedPieceId,\n          square: toSquare,\n          squareObj: squares[toSquare],\n        });\n      }\n    });\n\n    return {\n      moves,\n      removes,\n      adds,\n      unchanged,\n      totalChanges: moves.length + removes.length + adds.length,\n    };\n  }\n\n  /**\n   * Executes simultaneous changes based on analysis\n   * @private\n   * @param {Object} changeAnalysis - Analysis of changes\n   * @param {string} gameStateBefore - Game state before update\n   * @param {boolean} [isPositionLoad=false] - Whether this is a position load\n   */\n  _executeSimultaneousChanges(changeAnalysis, gameStateBefore, isPositionLoad = false) {\n    const { moves, removes, adds } = changeAnalysis;\n\n    let animationsCompleted = 0;\n    const totalAnimations = moves.length + removes.length + adds.length;\n\n    // If no animations are needed, complete immediately\n    if (totalAnimations === 0) {\n      this._addListeners();\n\n      // Trigger change event if position changed\n      const gameStateAfter = this.positionService.getGame().fen();\n      if (gameStateBefore !== gameStateAfter) {\n        this.config.onChange(gameStateAfter);\n      }\n      return;\n    }\n\n    const onAnimationComplete = () => {\n      animationsCompleted++;\n      if (animationsCompleted === totalAnimations) {\n        this._addListeners();\n\n        // Trigger change event if position changed\n        const gameStateAfter = this.positionService.getGame().fen();\n        if (gameStateBefore !== gameStateAfter) {\n          this.config.onChange(gameStateAfter);\n        }\n      }\n    };\n\n    // Determine delay: 0 for position loads, configured delay for normal moves\n    const animationDelay = isPositionLoad ? 0 : this.config.simultaneousAnimationDelay;\n\n    let animationIndex = 0;\n\n    // Process moves (pieces sliding to new positions)\n    moves.forEach((move) => {\n      const delay = animationIndex * animationDelay;\n\n      setTimeout(() => {\n        this._animatePieceMove(move, onAnimationComplete);\n      }, delay);\n\n      animationIndex++;\n    });\n\n    // Process removes (pieces disappearing)\n    removes.forEach((remove) => {\n      const delay = animationIndex * animationDelay;\n\n      setTimeout(() => {\n        this._animatePieceRemoval(remove, onAnimationComplete);\n      }, delay);\n\n      animationIndex++;\n    });\n\n    // Process adds (pieces appearing)\n    adds.forEach((add) => {\n      const delay = animationIndex * animationDelay;\n\n      setTimeout(() => {\n        this._animatePieceAddition(add, onAnimationComplete);\n      }, delay);\n\n      animationIndex++;\n    });\n  }\n\n  /**\n   * Animates a piece moving from one square to another\n   * @private\n   * @param {Object} move - Move information\n   * @param {Function} onComplete - Callback when animation completes\n   */\n  _animatePieceMove(move, onComplete) {\n    const { fromSquare, toSquare } = move;\n    const piece = fromSquare.piece;\n\n    if (!piece) {\n      console.warn(`No piece found on ${move.from} for move animation`);\n      onComplete();\n      return;\n    }\n\n    // Use translatePiece for smooth sliding animation\n    this.pieceService.translatePiece(\n      { from: fromSquare, to: toSquare, piece },\n      false, // Assume no capture for now\n      true, // Always animate\n      this._createDragFunction.bind(this),\n      onComplete\n    );\n  }\n\n  /**\n   * Animates a piece being removed\n   * @private\n   * @param {Object} remove - Remove information\n   * @param {Function} onComplete - Callback when animation completes\n   */\n  _animatePieceRemoval(remove, onComplete) {\n    this.pieceService.removePieceFromSquare(remove.squareObj, true, onComplete);\n  }\n\n  /**\n   * Animates a piece being added\n   * @private\n   * @param {Object} add - Add information\n   * @param {Function} onComplete - Callback when animation completes\n   */\n  _animatePieceAddition(add, onComplete) {\n    const newPiece = this.pieceService.convertPiece(add.piece);\n    this.pieceService.addPieceOnSquare(\n      add.squareObj,\n      newPiece,\n      true,\n      this._createDragFunction.bind(this),\n      onComplete\n    );\n  }\n\n  /**\n   * Creates a drag function for a piece\n   * @private\n   * @param {Square} square - Square containing the piece\n   * @param {Piece} piece - Piece to create drag function for\n   * @returns {Function} Drag function\n   */\n  _createDragFunction(square, piece) {\n    return this.eventService.createDragFunction(\n      square,\n      piece,\n      this.config.onDragStart,\n      this.config.onDragMove,\n      this.config.onDrop,\n      this._onSnapback.bind(this),\n      this._onMove.bind(this),\n      this._onRemove.bind(this)\n    );\n  }\n\n  /**\n   * Handles snapback animation\n   * @private\n   * @param {Square} square - Square containing the piece\n   * @param {Piece} piece - Piece to snapback\n   */\n  _onSnapback(square, piece) {\n    this.pieceService.snapbackPiece(square, this.config.snapbackAnimation);\n    this.config.onSnapbackEnd(square, piece);\n  }\n\n  /**\n   * Handles piece removal\n   * @private\n   * @param {Square} square - Square containing the piece to remove\n   */\n  _onRemove(square) {\n    this.pieceService.removePieceFromSquare(square, true);\n    this.positionService.getGame().remove(square.id);\n    this._updateBoardPieces(true);\n  }\n\n  /**\n   * Clears all visual state (selections, hints, highlights)\n   * @private\n   */\n  _clearVisualState() {\n    this.boardService.applyToAllSquares('deselect');\n    this.boardService.applyToAllSquares('removeHint');\n    this.boardService.applyToAllSquares('dehighlight');\n    this.eventService.setClicked(null);\n  }\n\n  // -------------------\n  // Public API Methods (Refactored)\n  // -------------------\n\n  // --- POSITION & STATE ---\n  /**\n   * Get the current position as FEN\n   * @returns {string}\n   */\n  getPosition() {\n    return this.fen();\n  }\n  /**\n   * Set the board position (FEN or object)\n   * @param {string|Object} position\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   * @returns {boolean}\n   */\n  setPosition(position, opts = {}) {\n    const animate = opts.animate !== undefined ? opts.animate : true;\n    // Remove highlights and selections\n    if (this.boardService && this.boardService.applyToAllSquares) {\n      this.boardService.applyToAllSquares('removeHint');\n      this.boardService.applyToAllSquares('deselect');\n      this.boardService.applyToAllSquares('unmoved');\n    }\n    if (this.positionService && this.positionService.setGame) {\n      this.positionService.setGame(position);\n    }\n    if (this._updateBoardPieces) {\n      this._updateBoardPieces(animate, true);\n    }\n    return true;\n  }\n  /**\n   * Reset the board to the starting position\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   * @returns {boolean}\n   */\n  reset(opts = {}) {\n    const animate = opts.animate !== undefined ? opts.animate : true;\n    // Use the default starting position from config or fallback\n    const startPosition = this.config && this.config.position ? this.config.position : 'start';\n    this._updateBoardPieces(animate);\n    return this.setPosition(startPosition, { animate });\n  }\n  /**\n   * Clear the board\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   * @returns {boolean}\n   */\n  clear(opts = {}) {\n    const animate = opts.animate !== undefined ? opts.animate : true;\n    if (!this.positionService || !this.positionService.getGame()) {\n      return false;\n    }\n    if (this._clearVisualState) this._clearVisualState();\n    this.positionService.getGame().clear();\n    if (this._updateBoardPieces) {\n      this._updateBoardPieces(animate, true);\n    }\n    return true;\n  }\n\n  // --- MOVE MANAGEMENT ---\n  /**\n   * Undo last move\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   * @returns {boolean}\n   */\n  undoMove(opts = {}) {\n    const undone = this.positionService.getGame().undo();\n    if (undone) {\n      this._undoneMoves.push(undone);\n      this._updateBoardPieces(opts.animate !== false);\n      return undone;\n    }\n    return null;\n  }\n  /**\n   * Redo last undone move\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   * @returns {boolean}\n   */\n  redoMove(opts = {}) {\n    if (this._undoneMoves && this._undoneMoves.length > 0) {\n      const move = this._undoneMoves.pop();\n      const moveObj = { from: move.from, to: move.to };\n      if (move.promotion) moveObj.promotion = move.promotion;\n      const result = this.positionService.getGame().move(moveObj);\n      this._updateBoardPieces(opts.animate !== false);\n      return result;\n    }\n    return false;\n  }\n  /**\n   * Get legal moves for a square\n   * @param {string} square\n   * @returns {Array}\n   */\n  getLegalMoves(square) {\n    return this.legalMoves(square);\n  }\n\n  // --- PIECE MANAGEMENT ---\n  /**\n   * Get the piece at a square\n   * @param {string} square\n   * @returns {string|null}\n   */\n  getPiece(square) {\n    // Restituisce sempre 'wq' (colore prima, tipo dopo, lowercase) o null\n    const sq = this.boardService.getSquare(square);\n    if (!sq) return null;\n    const piece = sq.piece;\n    if (!piece) return null;\n    return (piece.color + piece.type).toLowerCase();\n  }\n  /**\n   * Put a piece on a square\n   * @param {string} piece\n   * @param {string} square\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   * @returns {boolean}\n   */\n  putPiece(piece, square, opts = {}) {\n    const animate = opts.animate !== undefined ? opts.animate : true;\n    let pieceStr = piece;\n    if (typeof piece === 'object' && piece.type && piece.color) {\n      pieceStr = (piece.color + piece.type).toLowerCase();\n    } else if (typeof piece === 'string' && piece.length === 2) {\n      // Accetta sia 'wq' che 'qw', normalizza a 'wq'\n      const a = piece[0].toLowerCase();\n      const b = piece[1].toLowerCase();\n      const types = 'kqrbnp';\n      const colors = 'wb';\n      if (types.includes(a) && colors.includes(b)) {\n        pieceStr = b + a;\n      } else if (colors.includes(a) && types.includes(b)) {\n        pieceStr = a + b;\n      } else {\n        throw new Error(`[putPiece] Invalid piece: ${piece}`);\n      }\n    }\n    const validSquare = this.validationService.isValidSquare(square);\n    const validPiece = this.validationService.isValidPiece(pieceStr);\n    if (!validSquare) throw new Error(`[putPiece] Invalid square: ${square}`);\n    if (!validPiece) throw new Error(`[putPiece] Invalid piece: ${pieceStr}`);\n    if (!this.positionService || !this.positionService.getGame()) {\n      throw new Error('[putPiece] No positionService or game');\n    }\n    const pieceObj = this.pieceService.convertPiece(pieceStr);\n    const squareObj = this.boardService.getSquare(square);\n    if (!squareObj) throw new Error(`[putPiece] Square not found: ${square}`);\n    squareObj.piece = pieceObj;\n    const chessJsPiece = { type: pieceObj.type, color: pieceObj.color };\n    const game = this.positionService.getGame();\n    const result = game.put(chessJsPiece, square);\n    if (!result) throw new Error(`[putPiece] Game.put failed for ${pieceStr} on ${square}`);\n    this._updateBoardPieces(animate);\n    return true;\n  }\n  /**\n   * Remove a piece from a square\n   * @param {string} square\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   * @returns {string|null}\n   */\n  removePiece(square, opts = {}) {\n    const animate = opts.animate !== undefined ? opts.animate : true;\n    if (!this.validationService.isValidSquare(square)) {\n      throw new Error(`[removePiece] Invalid square: ${square}`);\n    }\n    const squareObj = this.boardService.getSquare(square);\n    if (!squareObj) return true;\n    if (!squareObj.piece) return true;\n    squareObj.piece = null;\n    const game = this.positionService.getGame();\n    game.remove(square);\n    this._updateBoardPieces(animate);\n    return true;\n  }\n\n  // --- BOARD CONTROL ---\n  /**\n   * Flip the board orientation\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   */\n  flipBoard(opts = {}) {\n    if (this.coordinateService && this.coordinateService.flipOrientation) {\n      this.coordinateService.flipOrientation();\n    }\n    if (this._buildBoard) this._buildBoard();\n    if (this._buildSquares) this._buildSquares();\n    if (this._addListeners) this._addListeners();\n    if (this._updateBoardPieces) this._updateBoardPieces(opts.animate !== false);\n  }\n  /**\n   * Set the board orientation\n   * @param {'w'|'b'} color\n   * @param {Object} [opts]\n   * @param {boolean} [opts.animate=true]\n   */\n  setOrientation(color, opts = {}) {\n    if (this.validationService.isValidOrientation(color)) {\n      this.coordinateService.setOrientation(color);\n      if (this._buildBoard) this._buildBoard();\n      if (this._buildSquares) this._buildSquares();\n      if (this._addListeners) this._addListeners();\n      if (this._updateBoardPieces) this._updateBoardPieces(opts.animate !== false);\n    }\n    return this.coordinateService.getOrientation();\n  }\n  /**\n   * Get the current orientation\n   * @returns {'w'|'b'}\n   */\n  getOrientation() {\n    return this.orientation();\n  }\n  /**\n   * Resize the board\n   * @param {number|string} size\n   */\n  resizeBoard(size) {\n    if (size === 'auto') {\n      this.config.size = 'auto';\n      document.documentElement.style.setProperty('--dimBoard', 'auto');\n      this._updateBoardPieces(false);\n      return true;\n    }\n    if (typeof size !== 'number' || size < 50 || size > 3000) {\n      throw new Error(`[resizeBoard] Invalid size: ${size}`);\n    }\n    this.config.size = size;\n    document.documentElement.style.setProperty('--dimBoard', `${size}px`);\n    this._updateBoardPieces(false);\n    return true;\n  }\n\n  // --- HIGHLIGHTING & UI ---\n  /**\n   * Highlight a square\n   * @param {string} square\n   * @param {Object} [opts]\n   */\n  highlight(square, opts = {}) {\n    if (!this.validationService.isValidSquare(square)) return;\n    if (this.boardService && this.boardService.highlightSquare) {\n      this.boardService.highlightSquare(square, opts);\n    } else if (this.eventService && this.eventService.highlightSquare) {\n      this.eventService.highlightSquare(square, opts);\n    }\n  }\n  /**\n   * Remove highlight from a square\n   * @param {string} square\n   * @param {Object} [opts]\n   */\n  dehighlight(square, opts = {}) {\n    if (!this.validationService.isValidSquare(square)) return;\n    if (this.boardService && this.boardService.dehighlightSquare) {\n      this.boardService.dehighlightSquare(square, opts);\n    } else if (this.eventService && this.eventService.dehighlightSquare) {\n      this.eventService.dehighlightSquare(square, opts);\n    }\n  }\n\n  // --- GAME INFO ---\n  /**\n   * Get FEN string\n   * @returns {string}\n   */\n  fen() {\n    // Avoid recursion: call the underlying game object's fen()\n    const game = this.positionService.getGame();\n    if (!game || typeof game.fen !== 'function') return '';\n    return game.fen();\n  }\n  /**\n   * Get current turn\n   * @returns {'w'|'b'}\n   */\n  turn() {\n    return this.positionService.getGame().turn();\n  }\n  /**\n   * Is the game over?\n   * @returns {boolean}\n   */\n  isGameOver() {\n    const game = this.positionService.getGame();\n    if (!game) return false;\n    if (game.isGameOver) return game.isGameOver();\n    // Fallback: checkmate or draw\n    if (game.isCheckmate && game.isCheckmate()) return true;\n    if (game.isDraw && game.isDraw()) return true;\n    return false;\n  }\n  /**\n   * Is it checkmate?\n   * @returns {boolean}\n   */\n  isCheckmate() {\n    const game = this.positionService.getGame();\n    if (!game) return false;\n    return game.isCheckmate ? game.isCheckmate() : false;\n  }\n  /**\n   * Is it draw?\n   * @returns {boolean}\n   */\n  isDraw() {\n    const game = this.positionService.getGame();\n    if (!game) return false;\n    return game.isDraw ? game.isDraw() : false;\n  }\n  /**\n   * Get move history\n   * @returns {Array}\n   */\n  getHistory() {\n    const game = this.positionService.getGame();\n    if (!game) return [];\n    return game.history ? game.history() : [];\n  }\n\n  // --- LIFECYCLE ---\n  /**\n   * Destroy the board and cleanup all resources\n   */\n  destroyBoard() {\n    // Remove all event listeners\n    if (this.eventService && typeof this.eventService.removeListeners === 'function') {\n      this.eventService.removeListeners();\n    }\n\n    // Clear all timeouts\n    if (this._updateTimeout) {\n      clearTimeout(this._updateTimeout);\n      this._updateTimeout = null;\n    }\n\n    // Clear the DOM\n    const boardContainer = document.getElementById(this.config.id_div);\n    if (boardContainer) {\n      boardContainer.innerHTML = '';\n    }\n\n    // Remove all pieces from squares\n    if (this.boardService && this.boardService.squares) {\n      Object.values(this.boardService.squares).forEach((sq) => {\n        if (sq && sq.forceRemoveAllPieces) {\n          sq.forceRemoveAllPieces();\n        }\n      });\n    }\n\n    // Clean up board service\n    if (this.boardService) {\n      if (this.boardService.removeSquares) this.boardService.removeSquares();\n      if (this.boardService.removeBoard) this.boardService.removeBoard();\n    }\n\n    // Null all services for garbage collection\n    this.validationService = null;\n    this.coordinateService = null;\n    this.positionService = null;\n    this.boardService = null;\n    this.pieceService = null;\n    this.animationService = null;\n    this.moveService = null;\n    this.eventService = null;\n\n    // Clear performance monitor\n    this._performanceMonitor = null;\n\n    // Clear state\n    this._undoneMoves = null;\n    this._boundUpdateBoardPieces = null;\n    this._boundOnSquareClick = null;\n    this._boundOnPieceHover = null;\n    this._boundOnPieceLeave = null;\n  }\n  /**\n   * Rebuild the board\n   */\n  rebuild() {\n    this._initialize();\n  }\n\n  // --- CONFIGURATION ---\n  /**\n   * Get current config\n   * @returns {Object}\n   */\n  getConfig() {\n    return this.config;\n  }\n  /**\n   * Set new config\n   * @param {Object} newConfig\n   */\n  updateConfig(newConfig) {\n    if (this.config && typeof this.config.update === 'function') {\n      this.config.update(newConfig);\n    }\n    if (newConfig.size !== undefined) {\n      this.resizeBoard(newConfig.size);\n    }\n    if (newConfig.orientation !== undefined) {\n      this.setOrientation(newConfig.orientation);\n    }\n  }\n\n  // --- ALIASES/DEPRECATED ---\n  /**\n   * Alias for move (deprecated)\n   */\n  move(move, animate = true) {\n    // On any new move, clear the redo stack\n    this._undoneMoves = [];\n    return this.movePiece(move, { animate });\n  }\n  /**\n   * Alias for clear (deprecated)\n   */\n  clearBoard(animate = true) {\n    this._updateBoardPieces(animate);\n    return this.clear({ animate });\n  }\n  /**\n   * Alias for reset (deprecated)\n   */\n  start(animate = true) {\n    this._updateBoardPieces(animate);\n    return this.reset({ animate });\n  }\n\n  /**\n   * Alias for flipBoard (for backward compatibility)\n   */\n  flip(opts = {}) {\n    this._updateBoardPieces(opts.animate !== false);\n    return this.flipBoard(opts);\n  }\n\n  /**\n   * Gets or sets the current position\n   * @param {string|Object} [newPosition] - New position (optional)\n   * @param {boolean} [animate=true] - Whether to animate\n   * @returns {Object|void} Position object if getter, void if setter\n   */\n  getOrSetPosition(newPosition, animate = true) {\n    if (newPosition === undefined) {\n      return this.positionService.getPosition();\n    }\n    this.load(newPosition, {}, animate);\n  }\n\n  /**\n   * Undoes the last move\n   * @param {boolean} [animate=true] - Whether to animate\n   * @returns {boolean} True if undo was successful\n   */\n  undo(animate = true) {\n    const undone = this.positionService.getGame().undo();\n    if (undone) {\n      this._undoneMoves.push(undone);\n      this._updateBoardPieces(animate);\n      return undone;\n    }\n    return null;\n  }\n\n  /**\n   * Redoes the last undone move\n   * @param {boolean} [animate=true] - Whether to animate\n   * @returns {boolean} True if redo was successful\n   */\n  redo(animate = true) {\n    if (this._undoneMoves && this._undoneMoves.length > 0) {\n      const move = this._undoneMoves.pop();\n      const moveObj = { from: move.from, to: move.to };\n      if (move.promotion) moveObj.promotion = move.promotion;\n      const result = this.positionService.getGame().move(moveObj);\n      this._updateBoardPieces(animate);\n      return result;\n    }\n    return false;\n  }\n\n  /**\n   * Gets the game history\n   * @returns {Array} Array of moves\n   */\n  history() {\n    return this.positionService.getGame().history();\n  }\n\n  /**\n   * Gets the current game state\n   * @returns {Object} Game state object\n   */\n  game() {\n    return this.positionService.getGame();\n  }\n\n  /**\n   * Gets or sets the orientation\n   * @param {string} [orientation] - New orientation\n   * @returns {string} Current orientation\n   */\n  orientation(orientation) {\n    if (orientation === undefined) {\n      return this.coordinateService.getOrientation();\n    }\n\n    if (this.validationService.isValidOrientation(orientation)) {\n      this.coordinateService.setOrientation(orientation);\n      this.flip();\n    }\n\n    return this.coordinateService.getOrientation();\n  }\n\n  /**\n   * Gets or sets the size\n   * @param {number|string} [size] - New size\n   * @returns {number|string} Current size\n   */\n  size(size) {\n    if (size === undefined) {\n      return this.config.size;\n    }\n\n    if (this.validationService.isValidSize(size)) {\n      this.config.size = size;\n      this.resize(size);\n    }\n\n    return this.config.size;\n  }\n\n  /**\n   * Gets legal moves for a square\n   * @param {string} square - Square to get moves for\n   * @returns {Array} Array of legal moves\n   */\n  legalMoves(square) {\n    const squareObj = this.boardService.getSquare(square);\n    if (!squareObj) return [];\n\n    return this.moveService.getCachedLegalMoves(squareObj);\n  }\n\n  /**\n   * Checks if a move is legal\n   * @param {string|Object} move - Move to check\n   * @returns {boolean} True if move is legal\n   */\n  isLegal(move) {\n    const moveObj = typeof move === 'string' ? this.moveService.parseMove(move) : move;\n    if (!moveObj) return false;\n\n    const fromSquare = this.boardService.getSquare(moveObj.from);\n    const toSquare = this.boardService.getSquare(moveObj.to);\n\n    if (!fromSquare || !toSquare) return false;\n\n    const moveInstance = new Move(fromSquare, toSquare, moveObj.promotion);\n    return moveInstance.isLegal(this.positionService.getGame());\n  }\n\n  /**\n   * Checks if the current player is in check\n   * @returns {boolean} True if in check\n   */\n  inCheck() {\n    return this.positionService.getGame().inCheck();\n  }\n\n  /**\n   * Checks if the current player is in checkmate\n   * @returns {boolean} True if in checkmate\n   */\n  inCheckmate() {\n    return this.positionService.getGame().isCheckmate();\n  }\n\n  /**\n   * Checks if the game is in stalemate\n   * @returns {boolean} True if in stalemate\n   */\n  inStalemate() {\n    return this.positionService.getGame().isStalemate();\n  }\n\n  /**\n   * Checks if the game is drawn\n   * @returns {boolean} True if drawn\n   */\n  inDraw() {\n    return this.positionService.getGame().isDraw();\n  }\n\n  /**\n   * Checks if position is threefold repetition\n   * @returns {boolean} True if threefold repetition\n   */\n  inThreefoldRepetition() {\n    return this.positionService.getGame().isThreefoldRepetition();\n  }\n\n  /**\n   * Gets the PGN representation of the game\n   * @returns {string} PGN string\n   */\n  pgn() {\n    return this.positionService.getGame().pgn();\n  }\n\n  /**\n   * Loads a PGN string\n   * @param {string} pgn - PGN string to load\n   * @param {boolean} [animate=true] - Whether to animate\n   * @returns {boolean} True if loaded successfully\n   */\n  loadPgn(pgn, animate = true) {\n    try {\n      const success = this.positionService.getGame().loadPgn(pgn);\n      if (success) {\n        this._updateBoardPieces(animate, true); // Position load\n      }\n      return success;\n    } catch (error) {\n      console.error('Error loading PGN:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Gets configuration options (alias for getConfig)\n   * @returns {Object} Configuration object\n   */\n  getConfigOptions() {\n    return this.config && typeof this.config.getConfig === 'function'\n      ? this.config.getConfig()\n      : this.config;\n  }\n\n  /**\n   * Updates configuration options (alias for updateConfig)\n   * @param {Object} newConfig - New configuration options\n   */\n  setConfigOptions(newConfig) {\n    this.updateConfig(newConfig);\n  }\n\n  /**\n   * Gets or sets the animation style\n   * @param {string} [style] - New animation style ('sequential' or 'simultaneous')\n   * @returns {string} Current animation style\n   */\n  animationStyle(style) {\n    if (style === undefined) {\n      return this.config.animationStyle;\n    }\n\n    if (this.validationService.isValidAnimationStyle(style)) {\n      this.config.animationStyle = style;\n    }\n\n    return this.config.animationStyle;\n  }\n\n  /**\n   * Gets or sets the simultaneous animation delay\n   * @param {number} [delay] - New delay in milliseconds\n   * @returns {number} Current delay\n   */\n  simultaneousAnimationDelay(delay) {\n    if (delay === undefined) {\n      return this.config.simultaneousAnimationDelay;\n    }\n\n    if (typeof delay === 'number' && delay >= 0) {\n      this.config.simultaneousAnimationDelay = delay;\n    }\n\n    return this.config.simultaneousAnimationDelay;\n  }\n\n  // Additional API methods would be added here following the same pattern\n  // This is a good starting point for the refactored architecture\n\n  // Ensure all public API methods from README are present and routed\n  insert(square, piece) {\n    return this.putPiece(piece, square);\n  }\n  get(square) {\n    return this.getPiece(square);\n  }\n  /**\n   * Legacy position method - use getPosition/setPosition instead\n   * @deprecated\n   */\n  position(positionArg, colorOrAnimate) {\n    if (positionArg === undefined) {\n      return this.positionService.getPosition();\n    }\n    if (typeof colorOrAnimate === 'string' && (colorOrAnimate === 'w' || colorOrAnimate === 'b')) {\n      this.setOrientation(colorOrAnimate);\n    }\n    return this.setPosition(positionArg, { animate: colorOrAnimate !== false });\n  }\n  // Legacy aliases (using arrow functions to avoid duplicate method names)\n  destroy() {\n    return this.destroyBoard();\n  }\n  build() {\n    return this._initialize();\n  }\n  resize(value) {\n    return this.resizeBoard(value);\n  }\n  piece(square) {\n    return this.getPiece(square);\n  }\n  ascii() {\n    return this.positionService.getGame().ascii();\n  }\n  board() {\n    return this.positionService.getGame().board();\n  }\n  getCastlingRights(color) {\n    return this.positionService.getGame().getCastlingRights(color);\n  }\n  getComment() {\n    return this.positionService.getGame().getComment();\n  }\n  getComments() {\n    return this.positionService.getGame().getComments();\n  }\n  lastMove() {\n    return this.positionService.getGame().lastMove();\n  }\n  moveNumber() {\n    return this.positionService.getGame().moveNumber();\n  }\n  moves(options = {}) {\n    return this.positionService.getGame().moves(options);\n  }\n  squareColor(squareId) {\n    return this.boardService.getSquare(squareId).isWhite() ? 'light' : 'dark';\n  }\n  isDrawByFiftyMoves() {\n    return this.positionService.getGame().isDrawByFiftyMoves();\n  }\n  isInsufficientMaterial() {\n    return this.positionService.getGame().isInsufficientMaterial();\n  }\n  isStalemate() {\n    return this.positionService.getGame().isStalemate();\n  }\n  isThreefoldRepetition() {\n    return this.positionService.getGame().isThreefoldRepetition();\n  }\n  load(fen, options = {}, animation = true) {\n    return this.setPosition(fen, { ...options, animate: animation });\n  }\n  put(pieceId, squareId, animation = true) {\n    console.debug('[put] called with:', { pieceId, squareId, animation });\n    let pieceObj = null;\n    // Helper to normalize string like 'wQ', 'Qw', 'Wq', 'qw', etc.\n    function parsePieceString(str) {\n      if (typeof str !== 'string' || str.length !== 2) return null;\n      const a = str[0].toLowerCase();\n      const b = str[1].toLowerCase();\n      const types = 'kqrbnp';\n      const colors = 'wb';\n      if (types.includes(a) && colors.includes(b)) {\n        return { type: a, color: b };\n      } else if (colors.includes(a) && types.includes(b)) {\n        return { type: b, color: a };\n      }\n      return null;\n    }\n    if (typeof pieceId === 'string') {\n      pieceObj = parsePieceString(pieceId);\n      console.debug('[put] parsed piece string:', pieceObj);\n      if (!pieceObj) {\n        console.error(`[put] Invalid piece string: '${pieceId}'. Use e.g. 'wQ', 'Qw', 'bK', 'kb'`);\n        return false;\n      }\n    } else if (typeof pieceId === 'object' && pieceId.type && pieceId.color) {\n      const type = String(pieceId.type).toLowerCase();\n      const color = String(pieceId.color).toLowerCase();\n      if ('kqrbnp'.includes(type) && 'wb'.includes(color)) {\n        pieceObj = { type, color };\n        console.debug('[put] normalized piece object:', pieceObj);\n      } else {\n        console.error(\n          `[put] Invalid piece object: {type: '${pieceId.type}', color: '${pieceId.color}'}`\n        );\n        return false;\n      }\n    } else {\n      console.error('[put] Invalid pieceId:', pieceId);\n      return false;\n    }\n    if (typeof squareId !== 'string' || squareId.length !== 2) {\n      console.error('[put] Invalid squareId:', squareId);\n      return false;\n    }\n    // Call the internal putPiece method\n    const result = this.putPiece(pieceObj, squareId, { animate: animation });\n    console.debug('[put] putPiece result:', result);\n    return result;\n  }\n  remove(squareId, animation = true) {\n    return this.removePiece(squareId, { animate: animation });\n  }\n  removeComment() {\n    return this.positionService.getGame().removeComment();\n  }\n  removeComments() {\n    return this.positionService.getGame().removeComments();\n  }\n  removeHeader(field) {\n    return this.positionService.getGame().removeHeader(field);\n  }\n  setCastlingRights(color, rights) {\n    return this.positionService.getGame().setCastlingRights(color, rights);\n  }\n  setComment(comment) {\n    return this.positionService.getGame().setComment(comment);\n  }\n  setHeader(key, value) {\n    return this.positionService.getGame().setHeader(key, value);\n  }\n  validateFen(fen) {\n    return this.positionService.getGame().validateFen(fen);\n  }\n\n  // Implementazioni reali per highlight/dehighlight\n  highlightSquare(square) {\n    return this.boardService.highlight(square);\n  }\n  dehighlightSquare(square) {\n    return this.boardService.dehighlight(square);\n  }\n  forceSync() {\n    this._updateBoardPieces(true, true);\n  }\n}\n\nexport { Chessboard };\nexport default Chessboard;\n","/**\n * Chessboard factory for creating and managing chessboard instances\n * @module core/ChessboardFactory\n * @since 2.0.0\n */\n\nimport { Chessboard } from './Chessboard.js';\nimport { ValidationService } from '../services/ValidationService.js';\nimport { ConfigurationError } from '../errors/ChessboardError.js';\nimport { logger } from '../utils/logger.js';\nimport { PerformanceMonitor } from '../utils/performance.js';\n\n/**\n * Factory class for creating and managing chessboard instances\n * Implements the Factory pattern with instance management\n * @class\n */\nexport class ChessboardFactory {\n  /**\n   * Creates a new ChessboardFactory instance\n   */\n  constructor() {\n    this.instances = new Map();\n    this.validationService = new ValidationService();\n    this.performanceMonitor = new PerformanceMonitor();\n    this.logger = logger.child('ChessboardFactory');\n\n    // Default configuration templates\n    this.templates = new Map();\n    this._initializeDefaultTemplates();\n  }\n\n  /**\n   * Initializes default configuration templates\n   * @private\n   */\n  _initializeDefaultTemplates() {\n    // Basic template\n    this.templates.set('basic', {\n      size: 400,\n      draggable: true,\n      hints: true,\n      clickable: true,\n      moveHighlight: true,\n      animationStyle: 'simultaneous',\n    });\n\n    // Tournament template\n    this.templates.set('tournament', {\n      size: 500,\n      draggable: false,\n      hints: false,\n      clickable: true,\n      moveHighlight: true,\n      onlyLegalMoves: true,\n      animationStyle: 'sequential',\n    });\n\n    // Analysis template\n    this.templates.set('analysis', {\n      size: 600,\n      draggable: true,\n      hints: true,\n      clickable: true,\n      moveHighlight: true,\n      mode: 'analysis',\n      animationStyle: 'simultaneous',\n    });\n\n    // Puzzle template\n    this.templates.set('puzzle', {\n      size: 450,\n      draggable: true,\n      hints: true,\n      clickable: true,\n      moveHighlight: true,\n      onlyLegalMoves: true,\n      animationStyle: 'sequential',\n    });\n\n    // Demo template\n    this.templates.set('demo', {\n      size: 'auto',\n      draggable: false,\n      hints: false,\n      clickable: false,\n      moveHighlight: true,\n      animationStyle: 'simultaneous',\n    });\n  }\n\n  /**\n   * Creates a new chessboard instance\n   * @param {string} containerId - Container element ID\n   * @param {Object} [config={}] - Configuration options\n   * @param {string} [template] - Template name to use\n   * @returns {Chessboard} Chessboard instance\n   * @throws {ConfigurationError} If configuration is invalid\n   */\n  create(containerId, config = {}, template = null) {\n    this.performanceMonitor.startMeasure('chessboard-creation');\n\n    try {\n      // Validate container ID\n      if (!containerId || typeof containerId !== 'string') {\n        throw new ConfigurationError(\n          'Container ID must be a non-empty string',\n          'containerId',\n          containerId\n        );\n      }\n\n      // Check if container exists\n      const container = document.getElementById(containerId);\n      if (!container) {\n        throw new ConfigurationError(\n          `Container element not found: ${containerId}`,\n          'containerId',\n          containerId\n        );\n      }\n\n      // Merge configuration with template if specified\n      let finalConfig = { ...config };\n      if (template) {\n        const templateConfig = this.templates.get(template);\n        if (!templateConfig) {\n          this.logger.warn(`Template \"${template}\" not found, using default configuration`);\n        } else {\n          finalConfig = { ...templateConfig, ...config };\n          this.logger.info(`Using template \"${template}\" for chessboard creation`);\n        }\n      }\n\n      // Set container ID\n      finalConfig.id = containerId;\n\n      // Validate configuration\n      this.validationService.validateConfig(finalConfig);\n\n      // Create chessboard instance\n      const chessboard = new Chessboard(finalConfig);\n\n      // Store instance for management\n      this.instances.set(containerId, {\n        instance: chessboard,\n        config: finalConfig,\n        template,\n        createdAt: new Date(),\n        container,\n      });\n\n      this.performanceMonitor.endMeasure('chessboard-creation');\n      this.logger.info(`Created chessboard instance for container: ${containerId}`, {\n        template,\n        configKeys: Object.keys(finalConfig),\n      });\n\n      return chessboard;\n    } catch (error) {\n      this.performanceMonitor.endMeasure('chessboard-creation');\n      this.logger.error('Failed to create chessboard instance', { containerId, error });\n      throw error;\n    }\n  }\n\n  /**\n   * Creates a chessboard using a predefined template\n   * @param {string} containerId - Container element ID\n   * @param {string} templateName - Template name\n   * @param {Object} [overrides={}] - Configuration overrides\n   * @returns {Chessboard} Chessboard instance\n   */\n  createFromTemplate(containerId, templateName, overrides = {}) {\n    return this.create(containerId, overrides, templateName);\n  }\n\n  /**\n   * Gets an existing chessboard instance\n   * @param {string} containerId - Container element ID\n   * @returns {Chessboard|null} Chessboard instance or null if not found\n   */\n  getInstance(containerId) {\n    const instance = this.instances.get(containerId);\n    return instance ? instance.instance : null;\n  }\n\n  /**\n   * Gets information about an instance\n   * @param {string} containerId - Container element ID\n   * @returns {Object|null} Instance information or null if not found\n   */\n  getInstanceInfo(containerId) {\n    const instance = this.instances.get(containerId);\n    if (!instance) {\n      return null;\n    }\n\n    return {\n      containerId,\n      template: instance.template,\n      createdAt: instance.createdAt,\n      config: { ...instance.config },\n    };\n  }\n\n  /**\n   * Destroys a chessboard instance\n   * @param {string} containerId - Container element ID\n   * @returns {boolean} True if instance was destroyed, false if not found\n   */\n  destroy(containerId) {\n    const instance = this.instances.get(containerId);\n    if (!instance) {\n      this.logger.warn(`Instance not found for destruction: ${containerId}`);\n      return false;\n    }\n\n    try {\n      // Destroy the chessboard instance\n      instance.instance.destroy();\n\n      // Remove from instances map\n      this.instances.delete(containerId);\n\n      this.logger.info(`Destroyed chessboard instance: ${containerId}`);\n      return true;\n    } catch (error) {\n      this.logger.error(`Failed to destroy chessboard instance: ${containerId}`, { error });\n      return false;\n    }\n  }\n\n  /**\n   * Destroys all chessboard instances\n   */\n  destroyAll() {\n    const containerIds = Array.from(this.instances.keys());\n    let destroyed = 0;\n\n    for (const containerId of containerIds) {\n      if (this.destroy(containerId)) {\n        destroyed++;\n      }\n    }\n\n    this.logger.info(`Destroyed ${destroyed} chessboard instances`);\n  }\n\n  /**\n   * Lists all active chessboard instances\n   * @returns {Array} Array of instance information\n   */\n  listInstances() {\n    return Array.from(this.instances.keys()).map((containerId) =>\n      this.getInstanceInfo(containerId)\n    );\n  }\n\n  /**\n   * Registers a new configuration template\n   * @param {string} name - Template name\n   * @param {Object} config - Template configuration\n   * @throws {ConfigurationError} If template name or config is invalid\n   */\n  registerTemplate(name, config) {\n    if (!name || typeof name !== 'string') {\n      throw new ConfigurationError('Template name must be a non-empty string', 'name', name);\n    }\n\n    if (!config || typeof config !== 'object') {\n      throw new ConfigurationError('Template configuration must be an object', 'config', config);\n    }\n\n    // Validate template configuration\n    this.validationService.validateConfig(config);\n\n    this.templates.set(name, { ...config });\n    this.logger.info(`Registered template: ${name}`, { configKeys: Object.keys(config) });\n  }\n\n  /**\n   * Removes a configuration template\n   * @param {string} name - Template name\n   * @returns {boolean} True if template was removed, false if not found\n   */\n  removeTemplate(name) {\n    const removed = this.templates.delete(name);\n    if (removed) {\n      this.logger.info(`Removed template: ${name}`);\n    }\n    return removed;\n  }\n\n  /**\n   * Gets a configuration template\n   * @param {string} name - Template name\n   * @returns {Object|null} Template configuration or null if not found\n   */\n  getTemplate(name) {\n    const template = this.templates.get(name);\n    return template ? { ...template } : null;\n  }\n\n  /**\n   * Lists all available templates\n   * @returns {Array} Array of template names\n   */\n  listTemplates() {\n    return Array.from(this.templates.keys());\n  }\n\n  /**\n   * Creates multiple chessboard instances from a configuration array\n   * @param {Array} configurations - Array of configuration objects\n   * @returns {Array} Array of created chessboard instances\n   */\n  createMultiple(configurations) {\n    const instances = [];\n    const errors = [];\n\n    for (const config of configurations) {\n      try {\n        const { containerId, template, ...options } = config;\n        const instance = this.create(containerId, options, template);\n        instances.push({ containerId, instance, success: true });\n      } catch (error) {\n        errors.push({ containerId: config.containerId, error, success: false });\n        this.logger.error(`Failed to create instance for ${config.containerId}`, { error });\n      }\n    }\n\n    if (errors.length > 0) {\n      this.logger.warn(\n        `Failed to create ${errors.length} out of ${configurations.length} instances`\n      );\n    }\n\n    return { instances, errors };\n  }\n\n  /**\n   * Gets factory statistics\n   * @returns {Object} Factory statistics\n   */\n  getStats() {\n    const stats = {\n      activeInstances: this.instances.size,\n      availableTemplates: this.templates.size,\n      performance: this.performanceMonitor.getMetrics(),\n      validation: this.validationService.getCacheStats(),\n    };\n\n    return stats;\n  }\n\n  /**\n   * Cleans up factory resources\n   */\n  cleanup() {\n    this.destroyAll();\n    this.validationService.destroy();\n    this.performanceMonitor.destroy();\n    this.templates.clear();\n  }\n}\n\n/**\n * Default factory instance\n * @type {ChessboardFactory}\n */\nexport const chessboardFactory = new ChessboardFactory();\n\n/**\n * Convenience method to create a chessboard instance\n * @param {string} containerId - Container element ID\n * @param {Object} [config={}] - Configuration options\n * @param {string} [template] - Template name to use\n * @returns {Chessboard} Chessboard instance\n */\nexport function createChessboard(containerId, config = {}, template = null) {\n  return chessboardFactory.create(containerId, config, template);\n}\n\n/**\n * Convenience method to create a chessboard from template\n * @param {string} containerId - Container element ID\n * @param {string} templateName - Template name\n * @param {Object} [overrides={}] - Configuration overrides\n * @returns {Chessboard} Chessboard instance\n */\nexport function createChessboardFromTemplate(containerId, templateName, overrides = {}) {\n  return chessboardFactory.createFromTemplate(containerId, templateName, overrides);\n}\n","/**\n * Chessboard.js - A beautiful, customizable chessboard widget\n * Entry point for the core library\n * @module core\n * @since 2.0.0\n */\n\nimport ChessboardClass from './Chessboard.js';\nimport ChessboardConfig from './ChessboardConfig.js';\nimport {\n    ChessboardFactory,\n    chessboardFactory,\n    createChessboard,\n    createChessboardFromTemplate\n} from './ChessboardFactory.js';\nimport { logger } from '../utils/logger.js';\n\n/**\n * Main Chessboard factory function for backward compatibility\n * Supports both legacy and modern calling conventions\n * @param {string|Object} containerElm - Container element ID or configuration object\n * @param {Object} [config={}] - Configuration options (when first param is string)\n * @returns {ChessboardClass} Chessboard instance\n */\nfunction Chessboard(containerElm, config = {}) {\n    const factoryLogger = logger.child('ChessboardFactory');\n\n    try {\n        // If first parameter is an object, treat it as config\n        if (typeof containerElm === 'object' && containerElm !== null) {\n            factoryLogger.debug('Creating chessboard with config object');\n            return new ChessboardClass(containerElm);\n        }\n\n        // Otherwise, treat first parameter as element ID\n        if (typeof containerElm === 'string') {\n            factoryLogger.debug('Creating chessboard with element ID', { elementId: containerElm });\n            const fullConfig = { ...config, id: containerElm };\n            return new ChessboardClass(fullConfig);\n        }\n\n        throw new Error('Invalid parameters: first parameter must be string or object');\n    } catch (error) {\n        factoryLogger.error('Failed to create chessboard instance', { error });\n        throw error;\n    }\n}\n\n/**\n * Wrapper class that handles both calling conventions\n * Provides enhanced error handling and logging\n * @class\n * @extends ChessboardClass\n */\nclass ChessboardWrapper extends ChessboardClass {\n    /**\n     * Creates a new ChessboardWrapper instance\n     * @param {string|Object} containerElm - Container element ID or configuration object\n     * @param {Object} [config={}] - Configuration options\n     */\n    constructor(containerElm, config = {}) {\n        const instanceLogger = logger.child('ChessboardWrapper');\n\n        try {\n            // If first parameter is an object, treat it as config\n            if (typeof containerElm === 'object' && containerElm !== null) {\n                instanceLogger.debug('Initializing with config object');\n                super(containerElm);\n            } else if (typeof containerElm === 'string') {\n                // Otherwise, treat first parameter as element ID\n                instanceLogger.debug('Initializing with element ID', { elementId: containerElm });\n                const fullConfig = { ...config, id: containerElm };\n                super(fullConfig);\n            } else {\n                throw new Error('Invalid constructor parameters');\n            }\n        } catch (error) {\n            instanceLogger.error('Failed to initialize ChessboardWrapper', { error });\n            throw error;\n        }\n    }\n}\n\n/**\n * Refactored Chessboard API - see Chessboard.js for full method docs\n * @typedef {import('./Chessboard.js').Chessboard} Chessboard\n */\n\n// --- STATIC/FACTORY METHODS ---\n/**\n * Create a new Chessboard instance\n * @param {string|Object} containerElm\n * @param {Object} [config]\n * @returns {Chessboard}\n */\nChessboard.create = createChessboard;\n/**\n * Create a Chessboard from a template\n * @param {string|Object} containerElm\n * @param {string} templateName\n * @param {Object} [config]\n * @returns {Chessboard}\n */\nChessboard.fromTemplate = createChessboardFromTemplate;\nChessboard.factory = chessboardFactory;\n\n// --- INSTANCE MANAGEMENT ---\nChessboard.getInstance = (containerId) => chessboardFactory.getInstance(containerId);\nChessboard.destroyInstance = (containerId) => chessboardFactory.destroy(containerId);\nChessboard.destroyAll = () => chessboardFactory.destroyAll();\nChessboard.listInstances = () => chessboardFactory.listInstances();\n\n// --- TEMPLATE MANAGEMENT ---\nChessboard.registerTemplate = (name, config) => chessboardFactory.registerTemplate(name, config);\nChessboard.removeTemplate = (name) => chessboardFactory.removeTemplate(name);\nChessboard.getTemplate = (name) => chessboardFactory.getTemplate(name);\nChessboard.listTemplates = () => chessboardFactory.listTemplates();\n\n// --- STATS & DEBUG ---\nChessboard.getStats = () => chessboardFactory.getStats();\n\n// --- DEPRECATED/LEGACY ALIASES ---\n/**\n * @deprecated Use Chessboard.create instead\n */\nChessboard.Class = ChessboardWrapper;\nChessboard.Chessboard = ChessboardWrapper;\nChessboard.Config = ChessboardConfig;\nChessboard.Factory = ChessboardFactory;\n\n// --- EXPORTS ---\nexport {\n    Chessboard,\n    ChessboardConfig,\n    ChessboardFactory,\n    chessboardFactory,\n    createChessboard,\n    createChessboardFromTemplate\n};\n\nexport default Chessboard;\n","/**\n * Coordinate utilities for Chessboard.js\n */\n\n/**\n * Convert algebraic notation to array coordinates\n * @param {string} square - Square in algebraic notation (e.g., 'a1', 'h8')\n * @returns {Object} Object with row and col properties\n */\nexport function algebraicToCoords(square) {\n  const file = square.charCodeAt(0) - 97; // 'a' = 0, 'b' = 1, etc.\n  const rank = parseInt(square[1]) - 1;    // '1' = 0, '2' = 1, etc.\n  \n  return { row: 7 - rank, col: file };\n}\n\n/**\n * Convert array coordinates to algebraic notation\n * @param {number} row - Row index (0-7)\n * @param {number} col - Column index (0-7)\n * @returns {string} Square in algebraic notation\n */\nexport function coordsToAlgebraic(row, col) {\n  const file = String.fromCharCode(97 + col); // 0 = 'a', 1 = 'b', etc.\n  const rank = (8 - row).toString();          // 0 = '8', 1 = '7', etc.\n  \n  return file + rank;\n}\n\n/**\n * Get the color of a square\n * @param {string} square - Square in algebraic notation\n * @returns {string} 'light' or 'dark'\n */\nexport function getSquareColor(square) {\n  const { row, col } = algebraicToCoords(square);\n  return (row + col) % 2 === 0 ? 'dark' : 'light';\n}\n\n/**\n * Check if coordinates are valid\n * @param {number} row - Row index\n * @param {number} col - Column index\n * @returns {boolean} True if coordinates are valid\n */\nexport function isValidCoords(row, col) {\n  return row >= 0 && row <= 7 && col >= 0 && col <= 7;\n}\n\n/**\n * Check if algebraic notation is valid\n * @param {string} square - Square in algebraic notation\n * @returns {boolean} True if square notation is valid\n */\nexport function isValidSquare(square) {\n  if (typeof square !== 'string' || square.length !== 2) return false;\n  \n  const file = square[0];\n  const rank = square[1];\n  \n  return file >= 'a' && file <= 'h' && rank >= '1' && rank <= '8';\n}\n","/**\n * Validation utilities for Chessboard.js\n * @module utils/validation\n * @since 2.0.0\n */\n\n// Import and re-export from coordinates utility\nimport { isValidSquare as validateSquare } from './coordinates.js';\nexport { validateSquare as isValidSquare };\n\n// Local alias for internal use\nconst isValidSquare = validateSquare;\n\n/**\n * Validation cache for performance optimization\n * @type {Map}\n */\nconst validationCache = new Map();\nconst CACHE_MAX_SIZE = 1000;\n\n/**\n * Caches validation result\n * @param {string} key - Cache key\n * @param {boolean} result - Validation result\n */\nfunction cacheResult(key, result) {\n    if (validationCache.size >= CACHE_MAX_SIZE) {\n        const firstKey = validationCache.keys().next().value;\n        validationCache.delete(firstKey);\n    }\n    validationCache.set(key, result);\n}\n\n/**\n * Validate piece notation with caching\n * @param {string} piece - Piece notation (e.g., 'wP', 'bK')\n * @returns {boolean} True if piece notation is valid\n */\nexport function isValidPiece(piece) {\n    if (typeof piece !== 'string' || piece.length !== 2) {\n        return false;\n    }\n    \n    const cacheKey = `piece:${piece}`;\n    if (validationCache.has(cacheKey)) {\n        return validationCache.get(cacheKey);\n    }\n    \n    const color = piece[0];\n    const type = piece[1];\n    \n    const isValid = ['w', 'b'].includes(color) && \n                   ['P', 'R', 'N', 'B', 'Q', 'K'].includes(type);\n    \n    cacheResult(cacheKey, isValid);\n    return isValid;\n}\n\n/**\n * Validate position object with comprehensive checks\n * @param {Object} position - Position object with square-piece mappings\n * @returns {boolean} True if position is valid\n */\nexport function isValidPosition(position) {\n    if (typeof position !== 'object' || position === null) {\n        return false;\n    }\n    \n    // Check for circular references\n    try {\n        JSON.stringify(position);\n    } catch {\n        return false;\n    }\n    \n    // Validate each square-piece mapping\n    for (const [square, piece] of Object.entries(position)) {\n        if (!isValidSquare(square) || !isValidPiece(piece)) {\n            return false;\n        }\n    }\n    \n    // Optional: Check for chess-specific rules\n    return isValidChessPosition(position);\n}\n\n/**\n * Validates chess-specific position rules\n * @param {Object} position - Position object\n * @returns {boolean} True if position follows chess rules\n */\nfunction isValidChessPosition(position) {\n    const pieces = Object.values(position);\n    \n    // Count kings\n    const whiteKings = pieces.filter(p => p === 'wK').length;\n    const blackKings = pieces.filter(p => p === 'bK').length;\n    \n    // Must have exactly one king of each color\n    if (whiteKings !== 1 || blackKings !== 1) {\n        return false;\n    }\n    \n    // Count pawns (max 8 per side)\n    const whitePawns = pieces.filter(p => p === 'wP').length;\n    const blackPawns = pieces.filter(p => p === 'bP').length;\n    \n    if (whitePawns > 8 || blackPawns > 8) {\n        return false;\n    }\n    \n    // Check pawn placement (not on first or last rank)\n    for (const [square, piece] of Object.entries(position)) {\n        if (piece === 'wP' || piece === 'bP') {\n            const rank = square[1];\n            if (rank === '1' || rank === '8') {\n                return false;\n            }\n        }\n    }\n    \n    return true;\n}\n\n/**\n * Validate FEN string format with comprehensive checks\n * @param {string} fen - FEN string\n * @returns {Object} Validation result with success and error properties\n */\nexport function validateFenFormat(fen) {\n    if (typeof fen !== 'string') {\n        return { success: false, error: 'FEN must be a string' };\n    }\n    \n    const cacheKey = `fen:${fen}`;\n    if (validationCache.has(cacheKey)) {\n        return validationCache.get(cacheKey);\n    }\n    \n    const parts = fen.trim().split(' ');\n    if (parts.length !== 6) {\n        const result = { success: false, error: 'FEN must have 6 parts separated by spaces' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate piece placement\n    const ranks = parts[0].split('/');\n    if (ranks.length !== 8) {\n        const result = { success: false, error: 'Piece placement must have 8 ranks' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate each rank\n    for (let i = 0; i < ranks.length; i++) {\n        const rankResult = validateRank(ranks[i]);\n        if (!rankResult.success) {\n            const result = { success: false, error: `Invalid rank ${i + 1}: ${rankResult.error}` };\n            cacheResult(cacheKey, result);\n            return result;\n        }\n    }\n    \n    // Validate active color\n    if (!['w', 'b'].includes(parts[1])) {\n        const result = { success: false, error: 'Active color must be \"w\" or \"b\"' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate castling availability\n    if (!/^[KQkq-]*$/.test(parts[2])) {\n        const result = { success: false, error: 'Invalid castling availability' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate en passant target square\n    if (parts[3] !== '-' && !isValidSquare(parts[3])) {\n        const result = { success: false, error: 'Invalid en passant target square' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate halfmove clock\n    const halfmove = parseInt(parts[4], 10);\n    if (isNaN(halfmove) || halfmove < 0) {\n        const result = { success: false, error: 'Invalid halfmove clock' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate fullmove number\n    const fullmove = parseInt(parts[5], 10);\n    if (isNaN(fullmove) || fullmove < 1) {\n        const result = { success: false, error: 'Invalid fullmove number' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    const result = { success: true };\n    cacheResult(cacheKey, result);\n    return result;\n}\n\n/**\n * Validates a single rank in FEN notation\n * @param {string} rank - Rank string\n * @returns {Object} Validation result\n */\nfunction validateRank(rank) {\n    if (typeof rank !== 'string') {\n        return { success: false, error: 'Rank must be a string' };\n    }\n    \n    let squareCount = 0;\n    \n    for (let i = 0; i < rank.length; i++) {\n        const char = rank[i];\n        \n        if (/[1-8]/.test(char)) {\n            squareCount += parseInt(char, 10);\n        } else if (/[prnbqkPRNBQK]/.test(char)) {\n            squareCount += 1;\n        } else {\n            return { success: false, error: `Invalid character \"${char}\" in rank` };\n        }\n    }\n    \n    if (squareCount !== 8) {\n        return { success: false, error: `Rank must represent exactly 8 squares, got ${squareCount}` };\n    }\n    \n    return { success: true };\n}\n\n/**\n * Validate move notation in various formats\n * @param {string} move - Move string (e.g., 'e2e4', 'Nf3', 'O-O')\n * @returns {Object} Validation result\n */\nexport function validateMove(move) {\n    if (typeof move !== 'string') {\n        return { success: false, error: 'Move must be a string' };\n    }\n    \n    const trimmed = move.trim();\n    if (trimmed.length === 0) {\n        return { success: false, error: 'Move cannot be empty' };\n    }\n    \n    // Check for castling\n    if (trimmed === 'O-O' || trimmed === 'O-O-O') {\n        return { success: true, type: 'castling' };\n    }\n    \n    // Check for coordinate notation (e.g., e2e4, e7e8q)\n    if (/^[a-h][1-8][a-h][1-8][qrnbQRNB]?$/.test(trimmed)) {\n        return { success: true, type: 'coordinate' };\n    }\n    \n    // Check for algebraic notation (e.g., Nf3, Qxd5, e4)\n    if (/^[PRNBQK]?[a-h]?[1-8]?x?[a-h][1-8](\\+|#)?$/.test(trimmed)) {\n        return { success: true, type: 'algebraic' };\n    }\n    \n    return { success: false, error: 'Invalid move format' };\n}\n\n/**\n * Validate configuration object with detailed error reporting\n * @param {Object} config - Configuration object\n * @returns {Object} Validation result with success and errors array\n */\nexport function validateConfig(config) {\n    const errors = [];\n    \n    if (!config || typeof config !== 'object') {\n        return { success: false, errors: ['Configuration must be an object'] };\n    }\n    \n    // Required fields\n    if (!config.id && !config.id_div) {\n        errors.push('Configuration must include \"id\" or \"id_div\"');\n    }\n    \n    // Optional field validation\n    if (config.orientation && !['white', 'black', 'w', 'b'].includes(config.orientation)) {\n        errors.push('Invalid orientation. Must be \"white\", \"black\", \"w\", or \"b\"');\n    }\n    \n    if (config.position && config.position !== 'start' && typeof config.position !== 'object') {\n        errors.push('Invalid position. Must be \"start\" or a position object');\n    }\n    \n    if (config.position && typeof config.position === 'object' && !isValidPosition(config.position)) {\n        errors.push('Invalid position object format');\n    }\n    \n    if (config.size && !isValidSize(config.size)) {\n        errors.push('Invalid size. Must be \"auto\", a positive number, or a valid CSS size');\n    }\n    \n    if (config.movableColors && !['white', 'black', 'w', 'b', 'both', 'none'].includes(config.movableColors)) {\n        errors.push('Invalid movableColors. Must be \"white\", \"black\", \"w\", \"b\", \"both\", or \"none\"');\n    }\n    \n    if (config.dropOffBoard && !['snapback', 'trash'].includes(config.dropOffBoard)) {\n        errors.push('Invalid dropOffBoard. Must be \"snapback\" or \"trash\"');\n    }\n    \n    // Validate callback functions\n    const callbacks = ['onMove', 'onMoveEnd', 'onChange', 'onDragStart', 'onDragMove', 'onDrop', 'onSnapbackEnd'];\n    for (const callback of callbacks) {\n        if (config[callback] && typeof config[callback] !== 'function') {\n            errors.push(`Invalid ${callback}. Must be a function`);\n        }\n    }\n    \n    // Validate color values\n    const colorFields = ['whiteSquare', 'blackSquare', 'highlight', 'hintColor'];\n    for (const field of colorFields) {\n        if (config[field] && !isValidColor(config[field])) {\n            errors.push(`Invalid ${field}. Must be a valid CSS color`);\n        }\n    }\n    \n    // Validate animation settings\n    if (config.moveAnimation && !isValidEasing(config.moveAnimation)) {\n        errors.push('Invalid moveAnimation. Must be a valid easing function');\n    }\n    \n    if (config.animationStyle && !['sequential', 'simultaneous'].includes(config.animationStyle)) {\n        errors.push('Invalid animationStyle. Must be \"sequential\" or \"simultaneous\"');\n    }\n    \n    return {\n        success: errors.length === 0,\n        errors\n    };\n}\n\n/**\n * Validates size value\n * @param {number|string} size - Size value\n * @returns {boolean} True if valid\n */\nfunction isValidSize(size) {\n    if (size === 'auto') {\n        return true;\n    }\n    \n    if (typeof size === 'number') {\n        return size > 0 && size <= 5000; // Reasonable upper limit\n    }\n    \n    if (typeof size === 'string') {\n        // Check for CSS size values\n        return /^\\d+(px|em|rem|%|vh|vw)$/.test(size);\n    }\n    \n    return false;\n}\n\n/**\n * Validates CSS color value\n * @param {string} color - Color value\n * @returns {boolean} True if valid\n */\nfunction isValidColor(color) {\n    if (typeof color !== 'string') {\n        return false;\n    }\n    \n    // Hex colors\n    if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color)) {\n        return true;\n    }\n    \n    // RGB/RGBA\n    if (/^rgba?\\(\\s*\\d+\\s*,\\s*\\d+\\s*,\\s*\\d+\\s*(,\\s*[0-1](\\.\\d+)?)?\\s*\\)$/.test(color)) {\n        return true;\n    }\n    \n    // HSL/HSLA\n    if (/^hsla?\\(\\s*\\d+\\s*,\\s*\\d+%\\s*,\\s*\\d+%\\s*(,\\s*[0-1](\\.\\d+)?)?\\s*\\)$/.test(color)) {\n        return true;\n    }\n    \n    // Named colors (basic set)\n    const namedColors = [\n        'white', 'black', 'red', 'green', 'blue', 'yellow', 'cyan', 'magenta',\n        'transparent', 'gray', 'grey', 'brown', 'orange', 'purple', 'pink'\n    ];\n    \n    return namedColors.includes(color.toLowerCase());\n}\n\n/**\n * Validates easing function\n * @param {string} easing - Easing function name\n * @returns {boolean} True if valid\n */\nfunction isValidEasing(easing) {\n    const validEasing = [\n        'linear', 'ease', 'ease-in', 'ease-out', 'ease-in-out',\n        'cubic-bezier'\n    ];\n    \n    return validEasing.includes(easing) || \n           /^cubic-bezier\\(\\s*[\\d.-]+\\s*,\\s*[\\d.-]+\\s*,\\s*[\\d.-]+\\s*,\\s*[\\d.-]+\\s*\\)$/.test(easing);\n}\n\n/**\n * Batch validates multiple items\n * @param {Array} items - Array of validation items\n * @returns {Array} Array of validation results\n */\nexport function batchValidate(items) {\n    return items.map(item => {\n        const { type, value } = item;\n        \n        switch (type) {\n            case 'piece':\n                return { ...item, valid: isValidPiece(value) };\n            case 'square':\n                return { ...item, valid: isValidSquare(value) };\n            case 'position':\n                return { ...item, valid: isValidPosition(value) };\n            case 'fen': {\n                const fenResult = validateFenFormat(value);\n                return { ...item, valid: fenResult.success, error: fenResult.error };\n            }\n            case 'move': {\n                const moveResult = validateMove(value);\n                return { ...item, valid: moveResult.success, error: moveResult.error };\n            }\n            case 'config': {\n                const configResult = validateConfig(value);\n                return { ...item, valid: configResult.success, errors: configResult.errors };\n            }\n            default:\n                return { ...item, valid: false, error: 'Unknown validation type' };\n        }\n    });\n}\n\n/**\n * Clears validation cache\n */\nexport function clearValidationCache() {\n    validationCache.clear();\n}\n\n/**\n * Gets validation cache statistics\n * @returns {Object} Cache statistics\n */\nexport function getValidationCacheStats() {\n    return {\n        size: validationCache.size,\n        maxSize: CACHE_MAX_SIZE\n    };\n}\n","/**\n * Animation utilities for Chessboard.js\n */\n\n/**\n * Get the CSS transition duration in milliseconds\n * @param {string|number} time - Time value ('fast', 'slow', or number in ms)\n * @returns {number} Duration in milliseconds\n */\nexport function parseTime(time) {\n  if (typeof time === 'number') return time;\n  \n  switch (time) {\n    case 'fast': return 150;\n    case 'slow': return 500;\n    default: return 200;\n  }\n}\n\n/**\n * Get the CSS transition function\n * @param {string} animation - Animation type ('ease', 'linear', etc.)\n * @returns {string} CSS transition function\n */\nexport function parseAnimation(animation) {\n  const validAnimations = ['ease', 'ease-in', 'ease-out', 'ease-in-out', 'linear'];\n  return validAnimations.includes(animation) ? animation : 'ease';\n}\n\n/**\n * Create a promise that resolves after animation completion\n * @param {number} duration - Duration in milliseconds\n * @returns {Promise} Promise that resolves after the duration\n */\nexport function animationPromise(duration) {\n  return new Promise(resolve => setTimeout(resolve, duration));\n}\n","/**\n * Chessboard.js - A beautiful, customizable chessboard widget\n * Main entry point for the library\n * \n * @version 2.2.1\n * @author alepot55\n * @license ISC\n */\n\n// Core components\nexport { \n    Chessboard, \n    ChessboardConfig, \n    ChessboardFactory,\n    chessboardFactory,\n    createChessboard,\n    createChessboardFromTemplate \n} from './core/index.js';\n\n// Component exports\nexport { default as Square } from './components/Square.js';\nexport { default as Piece } from './components/Piece.js';\nexport { default as Move } from './components/Move.js';\n\n// Service exports for advanced usage\nexport { \n    AnimationService,\n    BoardService,\n    CoordinateService,\n    EventService,\n    MoveService,\n    PieceService,\n    PositionService,\n    ValidationService\n} from './services/index.js';\n\n// Constants exports\nexport * from './constants/index.js';\n\n// Error handling exports\nexport { \n    ChessboardError, \n    ValidationError, \n    ConfigurationError,\n    MoveError,\n    DOMError,\n    PieceError\n} from './errors/index.js';\n\n// Utility exports\nexport { Chess, validateFen } from './utils/chess.js';\nexport { \n    PerformanceMonitor,\n    throttle,\n    debounce,\n    rafThrottle,\n    setTransform,\n    resetTransform,\n    batchDOMOperations,\n    isElementVisible,\n    getMemoryUsage\n} from './utils/performance.js';\nexport * from './utils/coordinates.js';\nexport { \n    isValidPiece,\n    isValidPosition,\n    validateFenFormat,\n    validateMove,\n    validateConfig,\n    batchValidate,\n    clearValidationCache,\n    getValidationCacheStats\n} from './utils/validation.js';\nexport * from './utils/animations.js';\n\n// Logging system exports\nexport { \n    Logger,\n    logger,\n    createLogger,\n    LOG_LEVELS\n} from './utils/logger.js';\n\n// Default export for IIFE compatibility\nimport { Chessboard as ChessboardClass } from './core/index.js';\nexport default ChessboardClass;\n\n// Version information\nexport const version = '2.2.1';\nexport const build = process.env.BUILD_NUMBER || 'dev';\nexport const buildDate = process.env.BUILD_DATE || new Date().toISOString();\n\n// Library information\nexport const info = {\n    name: 'Chessboard.js',\n    version,\n    build,\n    buildDate,\n    author: 'alepot55',\n    license: 'ISC',\n    repository: 'https://github.com/alepot55/Chessboardjs',\n    homepage: 'https://chessboardjs.com'\n};\n"],"names":["STANDARD_POSITIONS","DEFAULT_STARTING_POSITION","PIECE_TYPES","PIECE_COLORS","PROMOTION_PIECES","BOARD_LETTERS","BOARD_SIZE","ERROR_CODES","ERROR_MESSAGES","ERROR_SEVERITY","ChessboardError","message","code","context","ValidationError","field","value","ConfigurationError","configKey","configValue","MoveError","from","to","piece","DOMError","elementId","PieceError","pieceId","square","VALIDATION_PATTERNS","VALID_VALUES","SIZE_CONSTRAINTS","ValidationService","cacheKey","isValid","first","second","format1","format2","fen","parts","ranks","rank","halfmove","fullmove","squares","char","move","promotion","orientation","color","size","time","callback","id","colors","dropOff","easing","style","config","errors","callbacks","colorFields","key","result","firstKey","validations","validation","type","error","ANIMATION_TIMES","BOOLEAN_VALUES","TRANSITION_FUNCTIONS","DEFAULT_CONFIG","ChessboardConfig","settings","cssProperties","property","delay","validatedOrientation","updates","newConfig","Piece","src","opacity","element","newSrc","newType","duration","scaleDown","scaleUp","halfDuration","scaleDownAnimation","scaleUpAnimation","speed","transition_f","start","fade","elapsed","f","e","sourceRect","targetRect","x_start","y_start","x_end","y_end","dx","dy","keyframes","animation","Square","row","col","preserve","newPiece","event","catchable","hint","cover","choice","img","Move$1","check","game","AnimationService","x","properties","animationId","timingFunction","startTime","startValues","prop","animate","currentTime","progress","easedProgress","startValue","endValue","currentValue","end","BoardService","coordConverter","squareRow","squareCol","offsetWidth","offsetHeight","squareId","methodName","args","CoordinateService","realRow","realCol","letter","number","boardCol","y","boardElement","rect","width","height","squareWidth","squareHeight","coords","fromSquare","toSquare","fromRow","fromCol","toRow","toCol","rowDiff","colDiff","normalizedOrientation","file","PerformanceMonitor","paintObserver","list","entry","name","measure","metric","summary","values","percentile","sorted","a","b","index","observer","throttle","func","limit","inThrottle","debounce","timeoutId","debounced","rafThrottle","isThrottled","throttled","setTransform","scale","resetTransform","batchDOMOperations","resolve","isElementVisible","getMemoryUsage","getBrowserInfo","ua","isChrome","isFirefox","isSafari","isEdge","DragOptimizations","browserInfo","LOG_LEVELS","COLORS","Logger","level","data","reset","timestamp","consoleMethod","stored","perf","measurements","total","sum","m","avg","min","max","namespace","logger","createLogger","EventService","boardService","moveService","coordinateService","chessboard","onSquareClick","onPieceHover","onPieceLeave","listeners","throttledHover","throttledLeave","handleClick","onDragStart","onDragMove","onDrop","onSnapback","onMove","onRemove","originalFrom","isDragging","previousHighlight","startX","_a","startY","_b","moveAt","squareSize","clientX","clientY","boardRect","onMouseMove","currentX","currentY","deltaX","deltaY","computedStyle","currentWidth","currentHeight","newTo","onMouseUp","dropResult","cleanup","Move","selectedPromotion","targetSquare","onSelect","onDeselect","_c","promotionPiece","attempt","gamePiece","currentPiece","piecePath","dragFunction","isAnimating","handler","MoveService","positionService","movableColors","onlyLegalMoves","fromId","toId","legalMove","verbose","options","moves","moveOptions","pieceOnDestination","moveKey","stack","now","targetRank","matchingMove","requiresPromotion","fromRank","toRank","fromFile","toFile","direction","rankDiff","fileDiff","onPromotionSelect","onPromotionCancel","pieceType","choiceSquare","baseRow","piecesPath","moveString","gameMove","isKingSide","isWhite","PieceService","removeTarget","changeSquareCallback","WHITE","BLACK","PAWN","KNIGHT","BISHOP","ROOK","QUEEN","KING","DEFAULT_POSITION","chess","internal","__publicField","flags","captured","fromAlgebraic","algebraic","toAlgebraic","flag","BITS","FLAGS","EMPTY","Ox88","PAWN_OFFSETS","PIECE_OFFSETS","ATTACKS","RAYS","PIECE_MASKS","SYMBOLS","PROMOTIONS","RANK_1","RANK_2","RANK_7","RANK_8","SIDES","ROOKS","SECOND_RANK","TERMINATION_MARKERS","isDigit","c","r","swapColor","validateFen","tokens","moveNumber","halfMoves","rows","i","sumFields","previousWasNumber","k","kings","regex","getDisambiguator","ambiguities","sameRank","sameFile","len","ambigFrom","ambigTo","ambigPiece","addMove","inferPieceType","san","strippedSan","trimFen","Chess","preserveHeaders","skipValidation","adjustments","ok","position","empty","castling","epSquare","bigPawnSquare","isLegal","sq","currentPieceOnSquare","whiteKingInPlace","blackKingInPlace","_d","_e","_f","_g","_h","_i","_j","_k","_l","startSquare","currentSquare","attackers","canCapture","difference","offset","j","blocked","attackedBy","pieces","bishops","numPieces","squareColor","legal","forSquare","forPiece","us","them","firstSquare","lastSquare","singleSquare","castlingFrom","castlingTo","legalMoves","strict","moveObj","prettyMove","old","newline","maxWidth","headerExists","appendComment","comment","delimiter","reversedHistory","prefix","strip","wrapComment","token","pgn","newlineChar","mask","str","parsePgnHeader","header","headerObj","headers","headerRegexResults","headerString","toHex","s","fromHex","encodeComment","decodeComment","ms","_match","bracket","semicolon","ravRegex","halfMove","output","disambiguator","cleanMove","matches","overlyDisambiguated","symbol","depth","nodes","moveHistory","trimmedFen","currentComments","copyComment","rights","side","PositionService","rowParts","fenPiece","Chessboard$1","boardContainer","dragged","hasEnemyPiece","isCastle","isEnPassant","rookMove","rookFromSquare","rookToSquare","rookPiece","capturedSquare","capturedSquareObj","isPositionLoad","gameStateBefore","expectedMap","expectedPieceId","currentPieceId","gameStateAfter","currentMap","animationsCompleted","totalAnimations","animationDelay","animationIndex","onAnimationComplete","fromList","toList","distances","fromMatched","toMatched","minDist","minI","minJ","currentPieces","expectedPieces","removes","adds","unchanged","processedSquares","availableDestination","expectedId","changeAnalysis","remove","add","onComplete","opts","startPosition","undone","pieceStr","types","validSquare","validPiece","pieceObj","squareObj","chessJsPiece","newPosition","success","positionArg","colorOrAnimate","parsePieceString","ChessboardFactory","containerId","template","container","finalConfig","templateConfig","Chessboard","templateName","overrides","instance","containerIds","destroyed","removed","configurations","instances","chessboardFactory","createChessboard","createChessboardFromTemplate","containerElm","factoryLogger","ChessboardClass","fullConfig","ChessboardWrapper","instanceLogger","algebraicToCoords","coordsToAlgebraic","getSquareColor","isValidCoords","isValidSquare","validateSquare","validationCache","CACHE_MAX_SIZE","cacheResult","isValidPiece","isValidPosition","isValidChessPosition","whiteKings","p","blackKings","whitePawns","blackPawns","validateFenFormat","rankResult","validateRank","squareCount","validateMove","trimmed","validateConfig","isValidSize","isValidColor","isValidEasing","batchValidate","items","item","fenResult","moveResult","configResult","clearValidationCache","getValidationCacheStats","parseTime","parseAnimation","animationPromise","version","build","buildDate","info"],"mappings":"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EAChD,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,GAAI,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,GAAI,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,EAAG,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,EAC3D,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,GAAI,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,GAAI,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAChD,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAChD,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAChD,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,EAChD,EAEMC,GAAO,CACT,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAChD,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAChD,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAChD,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG,EAAG,GAAI,EAAG,EAAG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"}