var Chessboard=function(d){"use strict";var wi=Object.defineProperty;var Ei=(d,x,X)=>x in d?wi(d,x,{enumerable:!0,configurable:!0,writable:!0,value:X}):d[x]=X;var w=(d,x,X)=>Ei(d,typeof x!="symbol"?x+"":x,X);const x={start:"start",default:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",empty:"8/8/8/8/8/8/8/8 w - - 0 1"},X="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",ce=["p","r","n","b","q","k"],he=["w","b"],it=["q","r","b","n"],le="abcdefgh",Ge={ROWS:8,COLS:8,TOTAL_SQUARES:64},R=Object.freeze({VALIDATION_ERROR:"VALIDATION_ERROR",CONFIG_ERROR:"CONFIG_ERROR",MOVE_ERROR:"MOVE_ERROR",DOM_ERROR:"DOM_ERROR",ANIMATION_ERROR:"ANIMATION_ERROR",PIECE_ERROR:"PIECE_ERROR",INITIALIZATION_ERROR:"INITIALIZATION_ERROR",POSITION_ERROR:"POSITION_ERROR",FEN_ERROR:"FEN_ERROR",SQUARE_ERROR:"SQUARE_ERROR",THEME_ERROR:"THEME_ERROR",NETWORK_ERROR:"NETWORK_ERROR"}),E=Object.freeze({invalid_position:"Invalid position: ",invalid_fen:"Invalid FEN string: ",position_load_failed:"Failed to load position: ",invalid_id_div:"Board container not found: ",invalid_value:"Invalid value: ",dom_operation_failed:"DOM operation failed: ",element_not_found:"Element not found: ",invalid_piece:"Invalid piece notation: ",invalid_square:"Invalid square notation: ",invalid_piecesPath:"Invalid pieces path: ",piece_operation_failed:"Piece operation failed: ",invalid_orientation:"Invalid orientation: ",invalid_color:"Invalid color: ",invalid_mode:"Invalid mode: ",invalid_dropOffBoard:"Invalid dropOffBoard setting: ",invalid_size:"Invalid size: ",invalid_movableColors:"Invalid movableColors setting: ",invalid_snapbackTime:"Invalid snapbackTime: ",invalid_snapbackAnimation:"Invalid snapbackAnimation: ",invalid_fadeTime:"Invalid fadeTime: ",invalid_fadeAnimation:"Invalid fadeAnimation: ",invalid_ratio:"Invalid ratio: ",invalid_animationStyle:"Invalid animationStyle: ",animation_failed:"Animation failed: ",invalid_onMove:"Invalid onMove callback: ",invalid_onMoveEnd:"Invalid onMoveEnd callback: ",invalid_onChange:"Invalid onChange callback: ",invalid_onDragStart:"Invalid onDragStart callback: ",invalid_onDragMove:"Invalid onDragMove callback: ",invalid_onDrop:"Invalid onDrop callback: ",invalid_onSnapbackEnd:"Invalid onSnapbackEnd callback: ",callback_execution_failed:"Callback execution failed: ",invalid_whiteSquare:"Invalid whiteSquare color: ",invalid_blackSquare:"Invalid blackSquare color: ",invalid_highlight:"Invalid highlight color: ",invalid_selectedSquareWhite:"Invalid selectedSquareWhite color: ",invalid_selectedSquareBlack:"Invalid selectedSquareBlack color: ",invalid_movedSquareWhite:"Invalid movedSquareWhite color: ",invalid_movedSquareBlack:"Invalid movedSquareBlack color: ",invalid_choiceSquare:"Invalid choiceSquare color: ",invalid_coverSquare:"Invalid coverSquare color: ",invalid_hintColor:"Invalid hintColor: ",invalid_move:"Invalid move: ",invalid_move_format:"Invalid move format: ",move_execution_failed:"Move execution failed: ",illegal_move:"Illegal move: ",square_no_piece:"No piece found on square: ",move_validation_failed:"Move validation failed: ",game_over:"Game is over",invalid_turn:"Invalid turn: ",position_validation_failed:"Position validation failed: ",theme_load_failed:"Theme loading failed: ",asset_load_failed:"Asset loading failed: ",invalid_theme:"Invalid theme: ",network_error:"Network error: ",resource_not_found:"Resource not found: ",timeout_error:"Operation timed out: ",initialization_failed:"Initialization failed: ",operation_failed:"Operation failed: ",invalid_state:"Invalid state: ",memory_limit_exceeded:"Memory limit exceeded",performance_degraded:"Performance degraded: "}),$=Object.freeze({LOW:"LOW",MEDIUM:"MEDIUM",HIGH:"HIGH",CRITICAL:"CRITICAL"});Object.freeze({[R.VALIDATION_ERROR]:$.MEDIUM,[R.CONFIG_ERROR]:$.HIGH,[R.MOVE_ERROR]:$.LOW,[R.DOM_ERROR]:$.HIGH,[R.ANIMATION_ERROR]:$.LOW,[R.PIECE_ERROR]:$.MEDIUM,[R.INITIALIZATION_ERROR]:$.CRITICAL,[R.POSITION_ERROR]:$.MEDIUM,[R.FEN_ERROR]:$.MEDIUM,[R.SQUARE_ERROR]:$.MEDIUM,[R.THEME_ERROR]:$.LOW,[R.NETWORK_ERROR]:$.MEDIUM});class j extends Error{constructor(e,t,i={}){super(e),this.name="ChessboardError",this.code=t,this.context=i,this.timestamp=new Date().toISOString(),Error.captureStackTrace&&Error.captureStackTrace(this,j)}}class M extends j{constructor(e,t,i){super(e,R.VALIDATION_ERROR,{field:t,value:i}),this.name="ValidationError",this.field=t,this.value=i}}class O extends j{constructor(e,t,i){super(e,R.CONFIG_ERROR,{configKey:t,configValue:i}),this.name="ConfigurationError",this.configKey=t,this.configValue=i}}class xe extends j{constructor(e,t,i,s){super(e,R.MOVE_ERROR,{from:t,to:i,piece:s}),this.name="MoveError",this.from=t,this.to=i,this.piece=s}}class st extends j{constructor(e,t){super(e,R.DOM_ERROR,{elementId:t}),this.name="DOMError",this.elementId=t}}class ye extends j{constructor(e,t,i){super(e,R.PIECE_ERROR,{pieceId:t,square:i}),this.name="PieceError",this.pieceId=t,this.square=i}}const Dt=Object.freeze({square:/^[a-h][1-8]$/,piece:/^[prnbqkPRNBQK][wb]$/,fen:/^([rnbqkpRNBQKP1-8]+\/){7}[rnbqkpRNBQKP1-8]+\s[wb]\s[KQkq-]+\s[a-h1-8-]+\s\d+\s\d+$/,move:/^[a-h][1-8][a-h][1-8][qrnb]?$/,color:/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/}),qt=Object.freeze({orientations:["w","b","white","black"],colors:["w","b","white","black"],movableColors:["w","b","white","black","both","none"],dropOffBoard:["snapback","trash"],easingTypes:["linear","ease","ease-in","ease-out","ease-in-out"],animationStyles:["sequential","simultaneous"],modes:["normal","creative","analysis"],promotionPieces:["q","r","b","n","Q","R","B","N"]}),Lt=Object.freeze({min:50,max:2e3,maxTime:1e4,maxDelay:5e3});class we{constructor(){this._validationCache=new Map,this._cacheMaxSize=1e3,this._patterns=Dt,this._validValues=qt,this._constraints=Lt}isValidSquare(e){const t=`square:${e}`;if(this._validationCache.has(t))return this._validationCache.get(t);const i=typeof e=="string"&&e.length===2&&this._patterns.square.test(e);return this._cacheValidationResult(t,i),i}isValidPiece(e){if(typeof e!="string"||e.length!==2)return!1;const t=`piece:${e}`;if(this._validationCache.has(t))return this._validationCache.get(t);const[i,s]=e.split(""),n=ce.includes(i.toLowerCase())&&he.includes(s),r=he.includes(i)&&ce.includes(s.toLowerCase()),o=n||r;return this._cacheValidationResult(t,o),o}isValidFen(e){if(typeof e!="string")return!1;const t=`fen:${e}`;if(this._validationCache.has(t))return this._validationCache.get(t);if(!this._patterns.fen.test(e))return this._cacheValidationResult(t,!1),!1;const i=this._validateFenStructure(e);return this._cacheValidationResult(t,i),i}_validateFenStructure(e){const t=e.split(" ");if(t.length!==6)return!1;const i=t[0].split("/");if(i.length!==8)return!1;for(const r of i)if(!this._validateRank(r))return!1;if(!["w","b"].includes(t[1])||!/^[KQkq-]*$/.test(t[2])||t[3]!=="-"&&!this.isValidSquare(t[3]))return!1;const s=parseInt(t[4],10),n=parseInt(t[5],10);return!isNaN(s)&&!isNaN(n)&&s>=0&&n>=1}_validateRank(e){let t=0;for(let i=0;i<e.length;i++){const s=e[i];if(/[1-8]/.test(s))t+=parseInt(s,10);else if(/[prnbqkPRNBQK]/.test(s))t+=1;else return!1}return t===8}isValidMove(e){if(typeof e!="string")return!1;const t=`move:${e}`;if(this._validationCache.has(t))return this._validationCache.get(t);const i=this._validateMoveFormat(e);return this._cacheValidationResult(t,i),i}_validateMoveFormat(e){if(e.length<4||e.length>5)return!1;const t=e.slice(0,2),i=e.slice(2,4),s=e.slice(4,5);return!this.isValidSquare(t)||!this.isValidSquare(i)||s&&!this._validValues.promotionPieces.includes(s)?!1:t!==i}isValidOrientation(e){return this._validValues.orientations.includes(e)}isValidColor(e){return this._validValues.colors.includes(e)}isValidSize(e){return e==="auto"?!0:typeof e=="number"?e>=this._constraints.min&&e<=this._constraints.max:!1}isValidTime(e){return typeof e=="number"&&e>=0&&e<=this._constraints.maxTime}isValidCallback(e){return typeof e=="function"}isValidElementId(e){return typeof e=="string"&&e.length>0&&e.length<=100&&/^[a-zA-Z][\w:-]*$/.test(e)}isValidMovableColors(e){return this._validValues.movableColors.includes(e)}isValidDropOffBoard(e){return this._validValues.dropOffBoard.includes(e)}isValidEasing(e){return this._validValues.easingTypes.includes(e)}isValidAnimationStyle(e){return this._validValues.animationStyles.includes(e)}isValidCSSColor(e){return typeof e!="string"?!1:!!(this._patterns.color.test(e)||["white","black","red","green","blue","yellow","cyan","magenta"].includes(e.toLowerCase())||/^rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)$/.test(e)||/^rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*[0-1](\.\d+)?\s*\)$/.test(e))}validateSquare(e){if(!this.isValidSquare(e))throw new M(E.invalid_square+e,"square",e);return e.toLowerCase()}validatePiece(e){if(!this.isValidPiece(e))throw new M(E.invalid_piece+e,"piece",e);return e.toLowerCase()}validateFen(e){if(!this.isValidFen(e))throw new M(E.invalid_fen+e,"fen",e);return e.trim()}validateMove(e){if(!this.isValidMove(e))throw new M(E.invalid_move+e,"move",e);return e.toLowerCase()}validateOrientation(e){if(!this.isValidOrientation(e))throw new M(E.invalid_orientation+e,"orientation",e);return e==="white"?"w":e==="black"?"b":e}validateColor(e){if(!this.isValidColor(e))throw new M(E.invalid_color+e,"color",e);return e==="white"?"w":e==="black"?"b":e}validateSize(e){if(!this.isValidSize(e))throw new M(E.invalid_size+e,"size",e);return e}validateConfig(e){if(!e||typeof e!="object")throw new M("Configuration must be an object","config",e);const t=[];!e.id&&!e.id_div&&t.push("Configuration must include id or id_div"),e.orientation&&!this.isValidOrientation(e.orientation)&&t.push(E.invalid_orientation+e.orientation),e.size&&!this.isValidSize(e.size)&&t.push(E.invalid_size+e.size),e.movableColors&&!this.isValidMovableColors(e.movableColors)&&t.push(E.invalid_color+e.movableColors),e.dropOffBoard&&!this.isValidDropOffBoard(e.dropOffBoard)&&t.push(E.invalid_dropOffBoard+e.dropOffBoard),e.animationStyle&&!this.isValidAnimationStyle(e.animationStyle)&&t.push(E.invalid_animationStyle+e.animationStyle);const i=["onMove","onMoveEnd","onChange","onDragStart","onDragMove","onDrop","onSnapbackEnd"];for(const n of i)e[n]&&!this.isValidCallback(e[n])&&t.push(`Invalid ${n} callback`);const s=["whiteSquare","blackSquare","highlight","hintColor"];for(const n of s)e[n]&&!this.isValidCSSColor(e[n])&&t.push(`Invalid ${n} color: ${e[n]}`);if(t.length>0)throw new M(`Configuration validation failed: ${t.join(", ")}`,"config",e);return e}_cacheValidationResult(e,t){if(this._validationCache.size>=this._cacheMaxSize){const i=this._validationCache.keys().next().value;this._validationCache.delete(i)}this._validationCache.set(e,t)}clearCache(){this._validationCache.clear()}getCacheStats(){return{size:this._validationCache.size,maxSize:this._cacheMaxSize,hitRate:this._cacheHits/(this._cacheHits+this._cacheMisses)||0}}batchValidate(e){return e.map(t=>{try{const{type:i,value:s}=t;switch(i){case"square":return{valid:this.isValidSquare(s),value:s};case"piece":return{valid:this.isValidPiece(s),value:s};case"fen":return{valid:this.isValidFen(s),value:s};case"move":return{valid:this.isValidMove(s),value:s};default:return{valid:!1,value:s,error:"Unknown validation type"}}}catch(i){return{valid:!1,value:t.value,error:i.message}}})}destroy(){this.clearCache(),this._validationCache=null,this._patterns=null,this._validValues=null,this._constraints=null}}const nt=Object.freeze({fast:200,slow:600,normal:400,verySlow:1e3,veryFast:100}),rt=Object.freeze({true:!0,false:!1,none:!1,1:!0,0:!1}),je=Object.freeze({ease:"ease",linear:"linear","ease-in":"ease-in","ease-out":"ease-out","ease-in-out":"ease-in-out",none:null}),Nt=Object.freeze({id:"board",position:"start",orientation:"w",mode:"normal",size:"auto",draggable:!0,hints:!0,clickable:!0,movableColors:"both",moveHighlight:!0,overHighlight:!0,moveAnimation:"ease",moveTime:"fast",dropOffBoard:"snapback",snapbackTime:"fast",snapbackAnimation:"ease",dropCenterTime:"veryFast",dropCenterAnimation:"ease",fadeTime:"fast",fadeAnimation:"ease",ratio:.9,piecesPath:"../assets/themes/default",animationStyle:"simultaneous",simultaneousAnimationDelay:100,onMove:()=>!0,onMoveEnd:()=>!0,onChange:()=>!0,onDragStart:()=>!0,onDragMove:()=>!0,onDrop:()=>!0,onSnapbackEnd:()=>!0,whiteSquare:"#f0d9b5",blackSquare:"#b58863",highlight:"yellow",selectedSquareWhite:"#ababaa",selectedSquareBlack:"#ababaa",movedSquareWhite:"#f1f1a0",movedSquareBlack:"#e9e981",choiceSquare:"white",coverSquare:"black",hintColor:"#ababaa"});class Ve{constructor(e={}){this._validationService=new we,this._validateInput(e);const t=this._mergeWithDefaults(e);this._processConfiguration(t),this._setCSSProperties(t),this._configureModeSettings()}_validateInput(e){if(e!==null&&typeof e!="object")throw new O("Settings must be an object","settings",e);try{this._validationService.validateConfig(e)}catch(t){throw new O(t.message,t.field,t.value)}}_mergeWithDefaults(e){return Object.assign({},Nt,e)}_processConfiguration(e){this.id_div=e.id,this.position=e.position,this.orientation=e.orientation,this.mode=e.mode,this.dropOffBoard=e.dropOffBoard,this.size=e.size,this.movableColors=e.movableColors,this.piecesPath=e.piecesPath,this.onMove=this._validateCallback(e.onMove),this.onMoveEnd=this._validateCallback(e.onMoveEnd),this.onChange=this._validateCallback(e.onChange),this.onDragStart=this._validateCallback(e.onDragStart),this.onDragMove=this._validateCallback(e.onDragMove),this.onDrop=this._validateCallback(e.onDrop),this.onSnapbackEnd=this._validateCallback(e.onSnapbackEnd),this.moveAnimation=this._setTransitionFunction(e.moveAnimation),this.snapbackAnimation=this._setTransitionFunction(e.snapbackAnimation),this.dropCenterAnimation=this._setTransitionFunction(e.dropCenterAnimation),this.fadeAnimation=this._setTransitionFunction(e.fadeAnimation),this.hints=this._setBoolean(e.hints),this.clickable=this._setBoolean(e.clickable),this.draggable=this._setBoolean(e.draggable),this.moveHighlight=this._setBoolean(e.moveHighlight),this.overHighlight=this._setBoolean(e.overHighlight),this.moveTime=this._setTime(e.moveTime),this.snapbackTime=this._setTime(e.snapbackTime),this.dropCenterTime=this._setTime(e.dropCenterTime),this.fadeTime=this._setTime(e.fadeTime),this.animationStyle=this._validateAnimationStyle(e.animationStyle),this.simultaneousAnimationDelay=this._validateDelay(e.simultaneousAnimationDelay)}_setCSSProperties(e){const t={pieceRatio:e.ratio,whiteSquare:e.whiteSquare,blackSquare:e.blackSquare,highlightSquare:e.highlight,selectedSquareWhite:e.selectedSquareWhite,selectedSquareBlack:e.selectedSquareBlack,movedSquareWhite:e.movedSquareWhite,movedSquareBlack:e.movedSquareBlack,choiceSquare:e.choiceSquare,coverSquare:e.coverSquare,hintColor:e.hintColor};Object.entries(t).forEach(([i,s])=>{this._setCSSProperty(i,s)})}_configureModeSettings(){switch(this.mode){case"creative":this.onlyLegalMoves=!1,this.hints=!1;break;case"normal":this.onlyLegalMoves=!0;break;default:this.onlyLegalMoves=!0}}_validateCallback(e){if(!this._validationService.isValidCallback(e))throw new O("Callback must be a function","callback",e);return e}_validateAnimationStyle(e){if(!this._validationService.isValidAnimationStyle(e))throw new O("Invalid animation style","animationStyle",e);return e}_validateDelay(e){if(typeof e!="number"||e<0||e>5e3)throw new O("Invalid animation delay","simultaneousAnimationDelay",e);return e}_setCSSProperty(e,t){try{typeof document<"u"&&document.documentElement&&document.documentElement.style.setProperty(`--${e}`,t)}catch(i){console.warn(`Failed to set CSS property ${e}:`,i.message)}}setOrientation(e){const t=this._validationService.validateOrientation(e);return this.orientation=t,this}_setTime(e){if(typeof e=="number"){if(!this._validationService.isValidTime(e))throw new O("Invalid time value","time",e);return e}if(typeof e=="string"&&e in nt)return nt[e];throw new O("Invalid time value","time",e)}_setBoolean(e){if(typeof e=="boolean")return e;if(e in rt)return rt[e];throw new O("Invalid boolean value","boolean",e)}_setTransitionFunction(e){if(typeof e=="boolean")return e?je.ease:null;if(typeof e=="string"&&e in je)return je[e];if(e==null)return null;throw new O("Invalid transition function","transitionFunction",e)}toObject(){return{id_div:this.id_div,position:this.position,orientation:this.orientation,mode:this.mode,size:this.size,draggable:this.draggable,hints:this.hints,clickable:this.clickable,movableColors:this.movableColors,moveHighlight:this.moveHighlight,overHighlight:this.overHighlight,moveAnimation:this.moveAnimation,moveTime:this.moveTime,dropOffBoard:this.dropOffBoard,snapbackTime:this.snapbackTime,snapbackAnimation:this.snapbackAnimation,dropCenterTime:this.dropCenterTime,dropCenterAnimation:this.dropCenterAnimation,fadeTime:this.fadeTime,fadeAnimation:this.fadeAnimation,piecesPath:this.piecesPath,animationStyle:this.animationStyle,simultaneousAnimationDelay:this.simultaneousAnimationDelay,onlyLegalMoves:this.onlyLegalMoves}}update(e){if(!e||typeof e!="object")throw new O("Updates must be an object","updates",e);this._validationService.validateConfig(e);const t=Object.assign({},this.toObject(),e);return this._processConfiguration(t),this._setCSSProperties(t),this._configureModeSettings(),this}destroy(){this._validationService&&(this._validationService.destroy(),this._validationService=null)}}class Ee{constructor(e,t,i,s=1){this.color=e,this.type=t,this.id=this.getId(),this.src=i,this.element=this.createElement(i,s),this._currentAnimation=null,this.check()}getId(){return this.type+this.color}createElement(e,t=1){const i=document.createElement("img");return i.classList.add("piece"),i.id=this.id,i.src=e||this.src,i.style.opacity=t,i.draggable=!1,i.onerror=()=>{console.warn("Failed to load piece image:",i.src)},i}visible(){this.element&&(this.element.style.opacity=1)}invisible(){this.element&&(this.element.style.opacity=0)}updateSrc(e){this.src=e,this.element&&(this.element.src=e)}transformTo(e,t,i=200,s=null){if(!this.element){s&&s();return}const n=this.element;n.classList.add("transforming");const r=i/2,o=n.animate([{transform:"scale(1)",opacity:1},{transform:"scale(0.7)",opacity:.5}],{duration:r,easing:"ease-in",fill:"forwards"});o.onfinish=()=>{if(!this.element){s&&s();return}this.type=e,this.id=this.getId(),this.src=t,n.src=t,n.id=this.id;const c=n.animate([{transform:"scale(0.7)",opacity:.5},{transform:"scale(1)",opacity:1}],{duration:r,easing:"ease-out",fill:"forwards"});c.onfinish=()=>{if(!this.element){s&&s();return}o.cancel(),c.cancel(),n.style.transform="",n.style.opacity="",n.classList.remove("transforming"),s&&s()}}}fadeIn(e,t,i,s){if(!this.element){s&&s();return}const n=performance.now(),r=()=>{if(!this.element){s&&s();return}const o=performance.now()-n,c=Math.min(o/e,1);this.element.style.opacity=c,c<1?requestAnimationFrame(r):(this.element.style.opacity=1,s&&s())};r()}fadeOut(e,t,i,s){if(!this.element){s&&s();return}const n=performance.now(),r=()=>{if(!this.element){s&&s();return}const o=performance.now()-n,c=Math.min(o/e,1);this.element.style.opacity=1-c,c<1?requestAnimationFrame(r):(this.element.style.opacity=0,s&&s())};r()}setDrag(e){this.element&&(this._dragHandler&&(this.element.removeEventListener("mousedown",this._dragHandler),this.element.removeEventListener("touchstart",this._dragHandler)),this.element.ondragstart=t=>t.preventDefault(),this._dragHandler=e,this.element.addEventListener("mousedown",this._dragHandler),this.element.addEventListener("touchstart",this._dragHandler,{passive:!1}))}destroy(){this._currentAnimation&&(this._currentAnimation.cancel(),this._currentAnimation=null),this.element&&(this._dragHandler&&(this.element.removeEventListener("mousedown",this._dragHandler),this.element.removeEventListener("touchstart",this._dragHandler),this._dragHandler=null),this.element.onmousedown=null,this.element.ondragstart=null,this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null)}translate(e,t,i,s,n=null){if(!this.element||!e){n&&n();return}if(this._currentAnimation&&(this._currentAnimation.cancel(),this._currentAnimation=null),t<=0){n&&n();return}const r=this.element.getBoundingClientRect(),o=e.element?e.element.getBoundingClientRect():e.getBoundingClientRect(),c=o.left+o.width/2-(r.left+r.width/2),h=o.top+o.height/2-(r.top+r.height/2);if(Math.abs(c)<1&&Math.abs(h)<1){n&&n();return}const l=this.element.animate([{transform:"translate(0, 0)"},{transform:`translate(${c}px, ${h}px)`}],{duration:t,easing:"cubic-bezier(0.25, 0.1, 0.25, 1)",fill:"forwards"});this._currentAnimation=l,l.onfinish=()=>{if(!this.element){n&&n();return}n&&n(),requestAnimationFrame(()=>{this._currentAnimation===l&&(l.cancel(),this._currentAnimation=null),this.element&&(this.element.style.transform="")})},l.oncancel=()=>{this._currentAnimation===l&&(this._currentAnimation=null)}}check(){if(!["p","r","n","b","q","k"].includes(this.type))throw new Error(`Invalid piece type: ${this.type}`);if(!["w","b"].includes(this.color))throw new Error(`Invalid piece color: ${this.color}`)}}class Pe{constructor(e,t){this.row=e,this.col=t,this.id=this.getId(),this.element=this.createElement(),this.piece=null}getPiece(){return this.piece}opposite(){this.row=9-this.row,this.col=9-this.col,this.id=this.getId(),this.element=this.resetElement()}isWhite(){return(this.row+this.col)%2===0}getId(){return"abcdefgh"[this.col-1]+this.row}resetElement(){this.element.id=this.id,this.element.className="",this.element.classList.add("square"),this.element.classList.add(this.isWhite()?"whiteSquare":"blackSquare")}createElement(){const e=document.createElement("div");return e.id=this.id,e.classList.add("square"),e.classList.add(this.isWhite()?"whiteSquare":"blackSquare"),e}getElement(){return this.element}getBoundingClientRect(){return this.element.getBoundingClientRect()}removePiece(e=!1){return this.piece&&(!e&&typeof this.piece.destroy=="function"&&this.piece.destroy(),this.piece=null),null}forceRemoveAllPieces(){this.piece&&typeof this.piece.destroy=="function"&&(this.piece.destroy(),this.piece=null),this.element.querySelectorAll("img.piece").forEach(t=>{t.parentNode===this.element&&this.element.removeChild(t)})}replacePiece(e){this.piece&&this.removePiece(),this.putPiece(e),e.element.style.opacity="1"}addEventListener(e,t){this.element.addEventListener(e,t)}putPiece(e){this.piece&&this.removePiece(!0),this.piece=e,e&&e.element&&this.element.appendChild(e.element)}putHint(e){if(this.element.querySelector(".hint"))return;const t=document.createElement("div");t.classList.add("hint"),this.element.appendChild(t),e&&t.classList.add("catchable")}removeHint(){const e=this.element.querySelector(".hint");e&&this.element.removeChild(e)}select(){this.element.classList.add(this.isWhite()?"selectedSquareWhite":"selectedSquareBlack")}deselect(){this.element.classList.remove("selectedSquareWhite"),this.element.classList.remove("selectedSquareBlack")}moved(){this.element.classList.add(this.isWhite()?"movedSquareWhite":"movedSquareBlack")}unmoved(){this.element.classList.remove("movedSquareWhite"),this.element.classList.remove("movedSquareBlack")}highlight(){this.element.classList.add("highlighted")}dehighlight(){this.element.classList.remove("highlighted")}putCover(e){const t=document.createElement("div");t.classList.add("square"),t.classList.add("cover"),this.element.appendChild(t),t.addEventListener("click",i=>{i.stopPropagation(),e()})}removeCover(){const e=this.element.querySelector(".cover");e&&this.element.removeChild(e)}putPromotion(e,t){const i=document.createElement("div");i.classList.add("square"),i.classList.add("choice"),this.element.appendChild(i);const s=document.createElement("img");s.classList.add("piece"),s.classList.add("choicable"),s.src=e,i.appendChild(s),i.addEventListener("click",n=>{n.stopPropagation(),t()})}hasPromotion(){return this.element.querySelector(".choice")!==null}removePromotion(){const e=this.element.querySelector(".choice");e&&(e.removeChild(e.firstChild),this.element.removeChild(e))}destroy(){this.forceRemoveAllPieces(),this.element.remove(),this.piece=null}hasPiece(){return this.piece!==null}getColor(){return this.piece.getColor()}check(){if(this.row<1||this.row>8)throw new Error("Invalid square: row is out of bounds");if(this.col<1||this.col>8)throw new Error("Invalid square: col is out of bounds")}}let W=class{constructor(e,t,i=null,s=!1){this.piece=e?e.getPiece():null,this.from=e,this.to=t,this.promotion=i,s&&this.check()}hasPromotion(){return this.promotion!==null}setPromotion(e){this.promotion=e}check(){return!(this.piece===null||!(this.piece instanceof Ee)||["q","r","b","n",null].indexOf(this.promotion)===-1||!(this.from instanceof Pe)||!(this.to instanceof Pe)||!this.to||!this.from||this.from===this.to)}isLegal(e){return e.moves({square:this.from.id,verbose:!0}).map(i=>i.to).indexOf(this.to.id)!==-1}};class ot{constructor(e){this.config=e,this.activeAnimations=new Map,this.animationId=0}createTimingFunction(e="ease"){return(t,i)=>{const s=t/i;switch(e){case"linear":return s;case"ease":return s**2*(3-2*s);case"ease-in":return s**2;case"ease-out":return-1*(s-1)**2+1;case"ease-in-out":return s<.5?2*s**2:4*s-2*s**2-1;default:return s}}}animate(e,t,i,s="ease",n){const r=++this.animationId,o=this.createTimingFunction(s),c=performance.now(),h={};Object.keys(t).forEach(f=>{h[f]=this._getInitialValue(e,f)});const l=f=>{const u=f-c,p=Math.min(u/i,1),m=o(u,i);Object.keys(t).forEach(v=>{const S=h[v],P=t[v],y=this._interpolateValue(S,P,m);this._applyValue(e,v,y)}),p<1&&this.activeAnimations.has(r)?requestAnimationFrame(l):(this.activeAnimations.delete(r),n&&n())};return this.activeAnimations.set(r,{element:e,animate:l,callback:n}),requestAnimationFrame(l),r}cancel(e){this.activeAnimations.has(e)&&this.activeAnimations.delete(e)}cancelAll(){this.activeAnimations.clear()}_getInitialValue(e,t){if(!e||!e.style)return 0;switch(t){case"opacity":return parseFloat(getComputedStyle(e).opacity)||1;case"left":return parseFloat(e.style.left)||0;case"top":return parseFloat(e.style.top)||0;case"scale":return 1;default:return 0}}_interpolateValue(e,t,i){return e+(t-e)*i}_applyValue(e,t,i){if(!(!e||!e.style))switch(t){case"opacity":e.style.opacity=i;break;case"left":e.style.left=`${i}px`;break;case"top":e.style.top=`${i}px`;break;case"scale":e.style.transform=`scale(${i})`;break;default:e.style[t]=i}}destroy(){this.cancelAll()}}class at{constructor(e){this.config=e,this.element=null,this.squares={}}buildBoard(){if(this.element=document.getElementById(this.config.id_div),!this.element)throw new st(E.invalid_id_div+this.config.id_div,this.config.id_div);this.resize(this.config.size),this.element.className="board"}buildSquares(e){for(let t=0;t<Ge.ROWS;t++)for(let i=0;i<Ge.COLS;i++){const[s,n]=e(t,i),r=new Pe(s,n);this.squares[r.getId()]=r,this.element.appendChild(r.element)}}removeSquares(){for(const e of Object.values(this.squares))e.destroy();this.squares={}}removeBoard(){this.element&&(this.element.innerHTML="",this.element=null)}resize(e){if(e==="auto"){const t=this._calculateAutoSize();this.resize(t)}else{if(typeof e!="number")throw new M(E.invalid_value+e,"size",e);document.documentElement.style.setProperty("--dimBoard",`${e}px`)}}_calculateAutoSize(){if(!this.element)return 400;const{offsetWidth:e,offsetHeight:t}=this.element;return e===0?t||400:t===0?e:Math.min(e,t)}getSquare(e){return this.squares[e]||null}getAllSquares(){return{...this.squares}}applyToAllSquares(e,...t){for(const i of Object.values(this.squares))typeof i[e]=="function"&&i[e](...t)}destroy(){this.removeSquares(),this.removeBoard(),this.element=null,this.squares={}}}class ct{constructor(e){this.config=e}realCoord(e,t){let i=e,s=t;return this.isWhiteOriented()?i=7-e:s=7-t,[i+1,s+1]}getSquareID(e,t){if(e=parseInt(e),t=parseInt(t),this.isWhiteOriented()?(e=8-e,t=t+1):(e=e+1,t=8-t),t<1||t>8||e<1||e>8)throw new M(`Invalid board coordinates: row=${e}, col=${t}`,"coordinates",{row:e,col:t});return le[t-1]+e}getCoordinatesFromSquareID(e){if(typeof e!="string"||e.length!==2)throw new M(E.invalid_square+e,"squareId",e);const t=e[0],i=parseInt(e[1]),s=le.indexOf(t);if(s===-1)throw new M(E.invalid_square+e,"squareId",e);if(i<1||i>8)throw new M(E.invalid_square+e,"squareId",e);let n,r;return this.isWhiteOriented()?(n=8-i,r=s):(n=i-1,r=7-s),[n,r]}pixelToSquareID(e,t,i){if(!i)return null;const s=i.getBoundingClientRect(),{width:n,height:r}=s;if(e<0||e>=n||t<0||t>=r)return null;const o=n/8,c=r/8,h=Math.floor(e/o),l=Math.floor(t/c);try{return this.getSquareID(l,h)}catch{return null}}squareIDToPixel(e,t){if(!t)return null;try{const[i,s]=this.getCoordinatesFromSquareID(e),n=t.getBoundingClientRect(),{width:r,height:o}=n,c=r/8,h=o/8,l=s*c,f=i*h;return{x:l,y:f}}catch{return null}}getSquareCenter(e,t){const i=this.squareIDToPixel(e,t);if(!i)return null;const s=t.getBoundingClientRect(),n=s.width/8,r=s.height/8;return{x:i.x+n/2,y:i.y+r/2}}getSquareDistance(e,t){try{const[i,s]=this.getCoordinatesFromSquareID(e),[n,r]=this.getCoordinatesFromSquareID(t),o=Math.abs(n-i),c=Math.abs(r-s);return Math.sqrt(o*o+c*c)}catch{return 0}}isWhiteOriented(){return this.config.orientation==="w"}isBlackOriented(){return this.config.orientation==="b"}getOrientation(){return this.config.orientation}setOrientation(e){const t=e==="white"?"w":e==="black"?"b":e;if(t!=="w"&&t!=="b")throw new M(`${E.invalid_orientation}${e}`,"orientation",e);this.config.orientation=t}flipOrientation(){this.config.orientation=this.isWhiteOriented()?"b":"w"}getAllSquareIDs(){const e=[];for(let t=0;t<8;t++)for(let i=0;i<8;i++)e.push(this.getSquareID(t,i));return e}getSquaresByRank(e){if(e<1||e>8)throw new M(`Invalid rank: ${e}`,"rank",e);const t=[];for(let i=0;i<8;i++){const s=this.isWhiteOriented()?8-e:e-1;t.push(this.getSquareID(s,i))}return t}getSquaresByFile(e){const t=le.indexOf(e);if(t===-1)throw new M(`Invalid file: ${e}`,"file",e);const i=[];for(let s=0;s<8;s++)i.push(this.getSquareID(s,t));return i}}function Bt(){const a=navigator.userAgent,e=a.includes("Chrome")&&!a.includes("Edg"),t=a.includes("Firefox"),i=a.includes("Safari")&&!a.includes("Chrome"),s=a.includes("Edg");return{isChrome:e,isFirefox:t,isSafari:i,isEdge:s,devicePixelRatio:window.devicePixelRatio||1,userAgent:a}}const ue={enableForDrag(a){const e=Bt();a.style.willChange="left, top",a.style.pointerEvents="none",e.isChrome&&(a.style.transform="translateZ(0)"),e.isFirefox&&(a.style.backfaceVisibility="hidden")},cleanupAfterDrag(a){a.style.willChange="auto",a.style.pointerEvents="",a.style.transform="",a.style.backfaceVisibility=""}};class ht{constructor(e,t,i,s,n){this.config=e,this.boardService=t,this.moveService=i,this.coordinateService=s,this.chessboard=n,this.selectedSquare=null,this.isDragging=!1,this.isProcessing=!1,this.eventListeners=new Map}addListeners(e,t,i){this.removeListeners();const s=this.boardService.getAllSquares();Object.values(s).forEach(n=>{this._addSquareListeners(n,e,t,i)})}_addSquareListeners(e,t,i,s){const n=[],r=()=>{!this.selectedSquare&&this.config.hints&&e.piece&&i(e)},o=()=>{!this.selectedSquare&&this.config.hints&&s(e)},c=h=>{h.stopPropagation(),this.config.clickable&&!this.isProcessing&&!this.isDragging&&t(e)};e.element.addEventListener("mouseenter",r),e.element.addEventListener("mouseleave",o),e.element.addEventListener("click",c),n.push({element:e.element,type:"mouseenter",handler:r},{element:e.element,type:"mouseleave",handler:o},{element:e.element,type:"click",handler:c}),this.eventListeners.set(e.id,n)}createDragFunction(e,t,i,s,n,r,o,c){return h=>{var g,C,I,B;if(h.preventDefault(),h.stopPropagation(),!this.config.draggable||!t||this.isProcessing||this.isDragging||!this.moveService.canMove(e))return;const l=t.element,f=h.clientX||((C=(g=h.touches)==null?void 0:g[0])==null?void 0:C.clientX)||0,u=h.clientY||((B=(I=h.touches)==null?void 0:I[0])==null?void 0:B.clientY)||0;let p=!1,m=null,v=null;const S=(G,H)=>{const Z=this.boardService.element,K=Z.getBoundingClientRect(),ve=K.width/8,$e=G-K.left-ve/2,Fe=H-K.top-ve/2;l.style.left=`${$e}px`,l.style.top=`${Fe}px`;const _e=G-K.left,be=H-K.top;if(_e>=0&&_e<=K.width&&be>=0&&be<=K.height){const Se=this.coordinateService.pixelToSquareID(_e,be,Z);m=Se?this.boardService.getSquare(Se):null}else m=null;m!==v&&(v==null||v.dehighlight(),m==null||m.highlight(),v=m)},P=G=>{var K,ve,$e,Fe;const H=G.clientX||((ve=(K=G.touches)==null?void 0:K[0])==null?void 0:ve.clientX)||0,Z=G.clientY||((Fe=($e=G.touches)==null?void 0:$e[0])==null?void 0:Fe.clientY)||0;if(!p){const _e=Math.abs(H-f),be=Math.abs(Z-u);if(_e>3||be>3){p=!0,this.isDragging=!0,e.select();const Se=window.getComputedStyle(l);l.style.position="absolute",l.style.zIndex="100",l.style.width=Se.width,l.style.height=Se.height,l.classList.add("dragging"),ue.enableForDrag(l),i(e,t)}}p&&(S(H,Z),s(e,m,t))},y=()=>{if(document.removeEventListener("mousemove",P),document.removeEventListener("touchmove",P),window.removeEventListener("mouseup",y),window.removeEventListener("touchend",y),v==null||v.dehighlight(),!p){this.isDragging=!1;return}this.isDragging=!1;const G=n(e,m,t);if(!m){l.classList.remove("dragging"),l.style.zIndex="",l.style.willChange="auto",ue.cleanupAfterDrag(l),this.config.dropOffBoard==="trash"||G==="trash"?(this._resetPiecePosition(l),c(e)):(this._resetPiecePosition(l),r(e,t)),e.deselect(),this.boardService.applyToAllSquares("removeHint");return}this._handleMove(e,m,t,o,r)};document.addEventListener("mousemove",P),document.addEventListener("touchmove",P,{passive:!1}),window.addEventListener("mouseup",y),window.addEventListener("touchend",y)}}_resetPiecePosition(e){e&&(e.style.position="",e.style.left="",e.style.top="",e.style.transform="",e.style.width="",e.style.height="",e.style.zIndex="",e.classList.remove("dragging"),ue.cleanupAfterDrag(e))}_handleMove(e,t,i,s,n){if(this.isProcessing)return;this.isProcessing=!0;const r=()=>{this.isProcessing=!1,this.selectedSquare=null,e.deselect(),this.boardService.applyToAllSquares("removeHint")},o=new W(e,t);if(this.moveService.requiresPromotion(o)){this._handlePromotion(e,t,i,s,n,r);return}s(e,t,null,!0)||(this._resetPiecePosition(i.element),n(e,i)),r()}_handlePromotion(e,t,i,s,n,r){i&&i.element&&this._resetPiecePosition(i.element),this.moveService.setupPromotion(new W(e,t),this.boardService.squares,o=>{this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover"),s(e,t,o,!0)||n(e,i),r()},()=>{this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover"),n(e,i),r()})}onClick(e,t,i,s,n=!0){if(this.isProcessing||this.isDragging)return!1;if(!this.selectedSquare)return this.moveService.canMove(e)&&(this.selectedSquare=e,i(e)),!1;if(this.selectedSquare===e)return s(e),this.selectedSquare=null,!1;const r=this.selectedSquare,o=new W(r,e);return this.moveService.requiresPromotion(o)?(this._handlePromotion(r,e,r.piece,t,()=>{},()=>{s(r),this.selectedSquare=null}),!1):t(r,e,null,n)?(s(r),this.selectedSquare=null,!0):(s(r),this.selectedSquare=null,this.boardService.applyToAllSquares("removeHint"),this.moveService.canMove(e)&&(this.selectedSquare=e,i(e)),!1)}setClicked(e){this.selectedSquare=e}getClicked(){return this.selectedSquare}setPromoting(e){}getPromoting(){return!1}setAnimating(e){}getAnimating(){return this.isProcessing}removeListeners(){this.eventListeners.forEach(e=>{e.forEach(({element:t,type:i,handler:s})=>{t.removeEventListener(i,s)})}),this.eventListeners.clear()}removeAllListeners(){this.removeListeners()}destroy(){this.removeAllListeners(),this.selectedSquare=null,this.isDragging=!1,this.isProcessing=!1}}class lt{constructor(e,t){this.config=e,this.positionService=t,this._movesCache=new Map,this._cacheTimeout=null}canMove(e){if(!e.piece)return!1;const{movableColors:t,onlyLegalMoves:i}=this.config;if(t==="none"||t==="w"&&e.piece.color==="b"||t==="b"&&e.piece.color==="w")return!1;if(!i)return!0;if(!this.positionService||!this.positionService.getGame())return!1;const s=this.positionService.getGame();return e.piece.color===s.turn()}convertMove(e,t){if(e instanceof W)return e;if(typeof e=="string"&&e.length>=4){const i=e.slice(0,2),s=e.slice(2,4),n=e.slice(4,5)||null;if(!t[i]||!t[s])throw new xe(E.invalid_move_format,i,s);return new W(t[i],t[s],n)}throw new xe(E.invalid_move_format,"unknown","unknown")}isLegalMove(e){return this.getLegalMoves(e.from.id).some(i=>i.to===e.to.id&&e.promotion===i.promotion)}getLegalMoves(e=null,t=!0){if(!this.positionService||!this.positionService.getGame())return[];const i=this.positionService.getGame();if(!i)return[];const s={verbose:t};return e&&(s.square=e),i.moves(s)}getCachedLegalMoves(e){if(!this.positionService||!this.positionService.getGame())return[];const t=this.positionService.getGame();if(!t)return[];const i=`${e.id}-${t.fen()}`;let s=this._movesCache.get(i);return s||(s=t.moves({square:e.id,verbose:!0}),this._movesCache.set(i,s),this._cacheTimeout&&clearTimeout(this._cacheTimeout),this._cacheTimeout=setTimeout(()=>{this._movesCache.clear()},1e3)),s}executeMove(e){if(!this.positionService||!this.positionService.getGame())return null;const t=this.positionService.getGame();if(!t)return null;const i={from:e.from.id,to:e.to.id};return e.hasPromotion()&&(i.promotion=e.promotion),t.move(i)}requiresPromotion(e){var o;if(!this.config.onlyLegalMoves)return!1;const t=(o=this.positionService)==null?void 0:o.getGame();if(!t)return!1;const i=t.get(e.from.id);if(!i||i.type!=="p")return!1;const s=e.to.row;return i.color==="w"&&s!==8||i.color==="b"&&s!==1?!1:!!t.moves({square:e.from.id,verbose:!0}).find(c=>c.to===e.to.id)}setupPromotion(e,t,i,s){var c;const n=(c=this.positionService)==null?void 0:c.getGame();if(!n)return!1;const r=n.get(e.from.id);if(!r)return!1;const o=e.to;return Object.values(t).forEach(h=>{h.removePromotion(),h.removeCover()}),this._showPromotionInColumn(o,r,t,i,s),!0}_showPromotionInColumn(e,t,i,s,n){return it.forEach((r,o)=>{const c=this._findPromotionSquare(e,o,i);if(c){const h=r+t.color,l=this._getPiecePathForPromotion(h);c.putPromotion(l,()=>{s(r)})}}),Object.values(i).forEach(r=>{r.hasPromotion()||r.putCover(()=>{n()})}),!0}_findPromotionSquare(e,t,i){const s=e.col,n=e.row;let r;if(n===8)r=8-t;else if(n===1)r=1+t;else return null;if(r<1||r>8)return null;for(const o of Object.values(i))if(o.col===s&&o.row===r)return o;return null}_getPiecePathForPromotion(e){const{piecesPath:t}=this.config;return typeof t=="string"?`${t}/${e}.svg`:`assets/pieces/${e}.svg`}parseMove(e){if(typeof e!="string"||e.length<4||e.length>5)return null;const t=e.slice(0,2),i=e.slice(2,4),s=e.slice(4,5);return!/^[a-h][1-8]$/.test(t)||!/^[a-h][1-8]$/.test(i)||s&&!["q","r","b","n"].includes(s.toLowerCase())?null:{from:t,to:i,promotion:s||null}}isCastle(e){return e&&(e.isKingsideCastle()||e.isQueensideCastle())}getCastleRookMove(e){if(!this.isCastle(e))return null;const t=e.isKingsideCastle(),i=e.color==="w";return t?i?{from:"h1",to:"f1"}:{from:"h8",to:"f8"}:i?{from:"a1",to:"d1"}:{from:"a8",to:"d8"}}isEnPassant(e){return e&&e.isEnPassant()}getEnPassantCapturedSquare(e){if(!this.isEnPassant(e))return null;const t=e.to,i=parseInt(t[1]),s=t[0];return e.color==="w"?s+(i-1):s+(i+1)}clearCache(){this._movesCache.clear(),this._cacheTimeout&&(clearTimeout(this._cacheTimeout),this._cacheTimeout=null)}destroy(){this.clearCache(),this.positionService=null}}class ut{constructor(e){this.config=e}getPiecePath(e){const{piecesPath:t}=this.config;if(typeof t=="string")return`${t}/${e}.svg`;if(typeof t=="object"&&t!==null)return t[e];if(typeof t=="function")return t(e);throw new M(E.invalid_piecesPath,"piecesPath",t)}convertPiece(e){if(e instanceof Ee)return e;if(typeof e=="string"&&e.length===2){const[t,i]=e.split("");let s,n;if(ce.includes(t.toLowerCase())&&he.includes(i))s=t.toLowerCase(),n=i;else if(he.includes(t)&&ce.includes(i.toLowerCase()))n=t,s=i.toLowerCase();else throw new ye(E.invalid_piece+e,e);const r=this.getPiecePath(s+n);return new Ee(n,s,r)}throw new ye(E.invalid_piece+e,e)}addPieceOnSquare(e,t,i=!0,s,n){e.putPiece(t),s&&t.setDrag(s(e,t)),i&&this.config.fadeTime>0?t.fadeIn(this.config.fadeTime,this.config.fadeAnimation,this._getTransitionTimingFunction(),n):n&&n(),t.visible()}removePieceFromSquare(e,t=!0,i){e.check();const s=e.piece;if(!s)throw i&&i(),new ye(E.square_no_piece,null,e.getId());return t&&this.config.fadeTime>0?s.fadeOut(this.config.fadeTime,this.config.fadeAnimation,this._getTransitionTimingFunction(),i):i&&i(),e.removePiece(),s}movePiece(e,t,i,s){if(!e){s&&s();return}e.translate(t,i,this._getTransitionTimingFunction(),this.config.moveAnimation,s)}translatePiece(e,t,i,s=null,n=null){if(!e.piece){n&&n();return}t&&(e.to.deselect(),this.removePieceFromSquare(e.to,!1));const r=()=>{e.from.piece===e.piece&&e.from.removePiece(!0),e.to.piece!==e.piece&&(e.to.putPiece(e.piece),s&&this.config.draggable&&e.piece.element&&e.piece.setDrag(s(e.to,e.piece))),n&&n()};if(e.piece.element&&e.piece.element.classList.contains("dragging")){if(r(),e.piece.element){const c=e.piece.element;c.style.position="",c.style.left="",c.style.top="",c.style.transform="",c.style.zIndex="",c.style.width="",c.style.height="",c.classList.remove("dragging"),ue.cleanupAfterDrag(c)}}else{const c=i?this.config.moveTime:0;this.movePiece(e.piece,e.to,c,r)}}snapbackPiece(e,t=!0){if(!e||!e.piece)return;const i=e.piece,s=t?this.config.snapbackTime:0;i.translate(e,s,this._getTransitionTimingFunction(),this.config.snapbackAnimation)}centerPiece(e,t=!0){if(!e||!e.piece)return;const i=e.piece,s=t?this.config.dropCenterTime:0;i.translate(e,s,this._getTransitionTimingFunction(),this.config.dropCenterAnimation,()=>{i.element&&(i.element.style.position="",i.element.style.left="",i.element.style.top="",i.element.style.transform="",i.element.style.zIndex="",i.element.style.width="",i.element.style.height="",i.element.classList.remove("dragging"),ue.cleanupAfterDrag(i.element))})}_getTransitionTimingFunction(){return(e,t,i="ease")=>{const s=e/t;switch(i){case"linear":return s;case"ease":return s**2*(3-2*s);case"ease-in":return s**2;case"ease-out":return-1*(s-1)**2+1;case"ease-in-out":return s<.5?2*s**2:4*s-2*s**2-1;default:return s}}}destroy(){}}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const D="w",F="b",T="p",ze="n",Ce="b",de="r",Q="q",k="k",Ue="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class Me{constructor(e,t){w(this,"color");w(this,"from");w(this,"to");w(this,"piece");w(this,"captured");w(this,"promotion");w(this,"flags");w(this,"san");w(this,"lan");w(this,"before");w(this,"after");const{color:i,piece:s,from:n,to:r,flags:o,captured:c,promotion:h}=t,l=q(n),f=q(r);this.color=i,this.piece=s,this.from=l,this.to=f,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=l+f,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="";for(const u in b)b[u]&o&&(this.flags+=ee[u]);c&&(this.captured=c),h&&(this.promotion=h,this.lan+=h)}isCapture(){return this.flags.indexOf(ee.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(ee.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(ee.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(ee.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(ee.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(ee.BIG_PAWN)>-1}}const L=-1,ee={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},b={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},_={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},He={b:[16,32,17,15],w:[-16,-32,-17,-15]},dt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},$t=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Ft=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Gt={p:1,n:2,b:4,r:8,q:16,k:32},xt="pnbrqkPNBRQK",ft=[ze,Ce,de,Q],jt=7,Vt=6,zt=1,Ut=0,ke={[k]:b.KSIDE_CASTLE,[Q]:b.QSIDE_CASTLE},Y={w:[{square:_.a1,flag:b.QSIDE_CASTLE},{square:_.h1,flag:b.KSIDE_CASTLE}],b:[{square:_.a8,flag:b.QSIDE_CASTLE},{square:_.h8,flag:b.KSIDE_CASTLE}]},Ht={b:zt,w:Vt},Kt=["1-0","0-1","1/2-1/2","*"];function te(a){return a>>4}function fe(a){return a&15}function mt(a){return"0123456789".indexOf(a)!==-1}function q(a){const e=fe(a),t=te(a);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function me(a){return a===D?F:D}function Ke(a){const e=a.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const i=parseInt(e[4],10);if(isNaN(i)||i<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const s=e[0].split("/");if(s.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let r=0;r<s.length;r++){let o=0,c=!1;for(let h=0;h<s[r].length;h++)if(mt(s[r][h])){if(c)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(s[r][h],10),c=!0}else{if(!/^[prnbqkPRNBQK]$/.test(s[r][h]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,c=!1}if(o!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]==="3"&&e[1]==="w"||e[3][1]==="6"&&e[1]==="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:r,regex:o}of n){if(!o.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${r} king`};if((e[0].match(o)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${r} kings`}}return Array.from(s[0]+s[7]).some(r=>r.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Wt(a,e){const t=a.from,i=a.to,s=a.piece;let n=0,r=0,o=0;for(let c=0,h=e.length;c<h;c++){const l=e[c].from,f=e[c].to,u=e[c].piece;s===u&&t!==l&&i===f&&(n++,te(t)===te(l)&&r++,fe(t)===fe(l)&&o++)}return n>0?r>0&&o>0?q(t):o>0?q(t).charAt(1):q(t).charAt(0):""}function J(a,e,t,i,s,n=void 0,r=b.NORMAL){const o=te(i);if(s===T&&(o===jt||o===Ut))for(let c=0;c<ft.length;c++){const h=ft[c];a.push({color:e,from:t,to:i,piece:s,captured:n,promotion:h,flags:r|b.PROMOTION})}else a.push({color:e,from:t,to:i,piece:s,captured:n,flags:r})}function gt(a){let e=a.charAt(0);return e>="a"&&e<="h"?a.match(/[a-h]\d.*[a-h]\d/)?void 0:T:(e=e.toLowerCase(),e==="o"?k:e)}function We(a){return a.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function Qe(a){return a.split(" ").slice(0,4).join(" ")}class pt{constructor(e=Ue){w(this,"_board",new Array(128));w(this,"_turn",D);w(this,"_header",{});w(this,"_kings",{w:L,b:L});w(this,"_epSquare",-1);w(this,"_halfMoves",0);w(this,"_moveNumber",0);w(this,"_history",[]);w(this,"_comments",{});w(this,"_castling",{w:0,b:0});w(this,"_positionCount",{});this.load(e)}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:L,b:L},this._turn=D,this._castling={w:0,b:0},this._epSquare=L,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},this._positionCount={},delete this._header.SetUp,delete this._header.FEN}load(e,{skipValidation:t=!1,preserveHeaders:i=!1}={}){let s=e.split(/\s+/);if(s.length>=2&&s.length<6){const o=["-","-","0","1"];e=s.concat(o.slice(-(6-s.length))).join(" ")}if(s=e.split(/\s+/),!t){const{ok:o,error:c}=Ke(e);if(!o)throw new Error(c)}const n=s[0];let r=0;this.clear({preserveHeaders:i});for(let o=0;o<n.length;o++){const c=n.charAt(o);if(c==="/")r+=8;else if(mt(c))r+=parseInt(c,10);else{const h=c<"a"?D:F;this._put({type:c.toLowerCase(),color:h},q(r)),r++}}this._turn=s[1],s[2].indexOf("K")>-1&&(this._castling.w|=b.KSIDE_CASTLE),s[2].indexOf("Q")>-1&&(this._castling.w|=b.QSIDE_CASTLE),s[2].indexOf("k")>-1&&(this._castling.b|=b.KSIDE_CASTLE),s[2].indexOf("q")>-1&&(this._castling.b|=b.QSIDE_CASTLE),this._epSquare=s[3]==="-"?L:_[s[3]],this._halfMoves=parseInt(s[4],10),this._moveNumber=parseInt(s[5],10),this._updateSetup(e),this._incPositionCount(e)}fen(){var n,r;let e=0,t="";for(let o=_.a8;o<=_.h1;o++){if(this._board[o]){e>0&&(t+=e,e=0);const{color:c,type:h}=this._board[o];t+=c===D?h.toUpperCase():h.toLowerCase()}else e++;o+1&136&&(e>0&&(t+=e),o!==_.h1&&(t+="/"),e=0,o+=8)}let i="";this._castling[D]&b.KSIDE_CASTLE&&(i+="K"),this._castling[D]&b.QSIDE_CASTLE&&(i+="Q"),this._castling[F]&b.KSIDE_CASTLE&&(i+="k"),this._castling[F]&b.QSIDE_CASTLE&&(i+="q"),i=i||"-";let s="-";if(this._epSquare!==L){const o=this._epSquare+(this._turn===D?16:-16),c=[o+1,o-1];for(const h of c){if(h&136)continue;const l=this._turn;if(((n=this._board[h])==null?void 0:n.color)===l&&((r=this._board[h])==null?void 0:r.type)===T){this._makeMove({color:l,from:h,to:this._epSquare,piece:T,captured:T,flags:b.EP_CAPTURE});const f=!this._isKingAttacked(l);if(this._undoMove(),f){s=q(this._epSquare);break}}}}return[t,this._turn,i,s,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==Ue?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(Ue)}get(e){return this._board[_[e]]}put({type:e,color:t},i){return this._put({type:e,color:t},i)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:e,color:t},i){if(xt.indexOf(e.toLowerCase())===-1||!(i in _))return!1;const s=_[i];if(e===k&&!(this._kings[t]===L||this._kings[t]===s))return!1;const n=this._board[s];return n&&n.type===k&&(this._kings[n.color]=L),this._board[s]={type:e,color:t},e===k&&(this._kings[t]=s),!0}remove(e){const t=this.get(e);return delete this._board[_[e]],t&&t.type===k&&(this._kings[t.color]=L),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){var i,s,n,r,o,c,h,l,f,u,p,m;const e=((i=this._board[_.e1])==null?void 0:i.type)===k&&((s=this._board[_.e1])==null?void 0:s.color)===D,t=((n=this._board[_.e8])==null?void 0:n.type)===k&&((r=this._board[_.e8])==null?void 0:r.color)===F;(!e||((o=this._board[_.a1])==null?void 0:o.type)!==de||((c=this._board[_.a1])==null?void 0:c.color)!==D)&&(this._castling.w&=-65),(!e||((h=this._board[_.h1])==null?void 0:h.type)!==de||((l=this._board[_.h1])==null?void 0:l.color)!==D)&&(this._castling.w&=-33),(!t||((f=this._board[_.a8])==null?void 0:f.type)!==de||((u=this._board[_.a8])==null?void 0:u.color)!==F)&&(this._castling.b&=-65),(!t||((p=this._board[_.h8])==null?void 0:p.type)!==de||((m=this._board[_.h8])==null?void 0:m.color)!==F)&&(this._castling.b&=-33)}_updateEnPassantSquare(){var n,r;if(this._epSquare===L)return;const e=this._epSquare+(this._turn===D?-16:16),t=this._epSquare+(this._turn===D?16:-16),i=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||((n=this._board[t])==null?void 0:n.color)!==me(this._turn)||((r=this._board[t])==null?void 0:r.type)!==T){this._epSquare=L;return}const s=o=>{var c,h;return!(o&136)&&((c=this._board[o])==null?void 0:c.color)===this._turn&&((h=this._board[o])==null?void 0:h.type)===T};i.some(s)||(this._epSquare=L)}_attacked(e,t,i){const s=[];for(let n=_.a8;n<=_.h1;n++){if(n&136){n+=7;continue}if(this._board[n]===void 0||this._board[n].color!==e)continue;const r=this._board[n],o=n-t;if(o===0)continue;const c=o+119;if($t[c]&Gt[r.type]){if(r.type===T){if(o>0&&r.color===D||o<=0&&r.color===F){if(!i)return!0;s.push(q(n))}continue}if(r.type==="n"||r.type==="k"){if(!i)return!0;s.push(q(n));continue}const h=Ft[c];let l=n+h,f=!1;for(;l!==t;){if(this._board[l]!=null){f=!0;break}l+=h}if(!f){if(!i)return!0;s.push(q(n));continue}}}return i?s:!1}attackers(e,t){return t?this._attacked(t,_[e],!0):this._attacked(this._turn,_[e],!0)}_isKingAttacked(e){const t=this._kings[e];return t===-1?!1:this._attacked(me(e),t)}isAttacked(e,t){return this._attacked(t,_[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let i=0,s=0;for(let n=_.a8;n<=_.h1;n++){if(s=(s+1)%2,n&136){n+=7;continue}const r=this._board[n];r&&(e[r.type]=r.type in e?e[r.type]+1:1,r.type===Ce&&t.push(s),i++)}if(i===2)return!0;if(i===3&&(e[Ce]===1||e[ze]===1))return!0;if(i===e[Ce]+2){let n=0;const r=t.length;for(let o=0;o<r;o++)n+=t[o];if(n===0||n===r)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:i=void 0}={}){const s=this._moves({square:t,piece:i});return e?s.map(n=>new Me(this,n)):s.map(n=>this._moveToSan(n,s))}_moves({legal:e=!0,piece:t=void 0,square:i=void 0}={}){var p;const s=i?i.toLowerCase():void 0,n=t==null?void 0:t.toLowerCase(),r=[],o=this._turn,c=me(o);let h=_.a8,l=_.h1,f=!1;if(s){if(!(s in _))return[];h=l=_[s],f=!0}for(let m=h;m<=l;m++){if(m&136){m+=7;continue}if(!this._board[m]||this._board[m].color===c)continue;const{type:v}=this._board[m];let S;if(v===T){if(n&&n!==v)continue;S=m+He[o][0],this._board[S]||(J(r,o,m,S,T),S=m+He[o][1],Ht[o]===te(m)&&!this._board[S]&&J(r,o,m,S,T,void 0,b.BIG_PAWN));for(let P=2;P<4;P++)S=m+He[o][P],!(S&136)&&(((p=this._board[S])==null?void 0:p.color)===c?J(r,o,m,S,T,this._board[S].type,b.CAPTURE):S===this._epSquare&&J(r,o,m,S,T,T,b.EP_CAPTURE))}else{if(n&&n!==v)continue;for(let P=0,y=dt[v].length;P<y;P++){const g=dt[v][P];for(S=m;S+=g,!(S&136);){if(!this._board[S])J(r,o,m,S,v);else{if(this._board[S].color===o)break;J(r,o,m,S,v,this._board[S].type,b.CAPTURE);break}if(v===ze||v===k)break}}}}if((n===void 0||n===k)&&(!f||l===this._kings[o])){if(this._castling[o]&b.KSIDE_CASTLE){const m=this._kings[o],v=m+2;!this._board[m+1]&&!this._board[v]&&!this._attacked(c,this._kings[o])&&!this._attacked(c,m+1)&&!this._attacked(c,v)&&J(r,o,this._kings[o],v,k,void 0,b.KSIDE_CASTLE)}if(this._castling[o]&b.QSIDE_CASTLE){const m=this._kings[o],v=m-2;!this._board[m-1]&&!this._board[m-2]&&!this._board[m-3]&&!this._attacked(c,this._kings[o])&&!this._attacked(c,m-1)&&!this._attacked(c,v)&&J(r,o,this._kings[o],v,k,void 0,b.QSIDE_CASTLE)}}if(!e||this._kings[o]===-1)return r;const u=[];for(let m=0,v=r.length;m<v;m++)this._makeMove(r[m]),this._isKingAttacked(o)||u.push(r[m]),this._undoMove();return u}move(e,{strict:t=!1}={}){let i=null;if(typeof e=="string")i=this._moveFromSan(e,t);else if(typeof e=="object"){const n=this._moves();for(let r=0,o=n.length;r<o;r++)if(e.from===q(n[r].from)&&e.to===q(n[r].to)&&(!("promotion"in n[r])||e.promotion===n[r].promotion)){i=n[r];break}}if(!i)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);const s=new Me(this,i);return this._makeMove(i),this._incPositionCount(s.after),s}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){const t=this._turn,i=me(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&b.EP_CAPTURE&&(this._turn===F?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===k){if(this._kings[t]=e.to,e.flags&b.KSIDE_CASTLE){const s=e.to-1,n=e.to+1;this._board[s]=this._board[n],delete this._board[n]}else if(e.flags&b.QSIDE_CASTLE){const s=e.to+1,n=e.to-2;this._board[s]=this._board[n],delete this._board[n]}this._castling[t]=0}if(this._castling[t]){for(let s=0,n=Y[t].length;s<n;s++)if(e.from===Y[t][s].square&&this._castling[t]&Y[t][s].flag){this._castling[t]^=Y[t][s].flag;break}}if(this._castling[i]){for(let s=0,n=Y[i].length;s<n;s++)if(e.to===Y[i][s].square&&this._castling[i]&Y[i][s].flag){this._castling[i]^=Y[i][s].flag;break}}e.flags&b.BIG_PAWN?t===F?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=L,e.piece===T?this._halfMoves=0:e.flags&(b.CAPTURE|b.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===F&&this._moveNumber++,this._turn=i}undo(){const e=this._undoMove();if(e){const t=new Me(this,e);return this._decPositionCount(t.after),t}return null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;const i=this._turn,s=me(i);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&b.EP_CAPTURE){let n;i===F?n=t.to-16:n=t.to+16,this._board[n]={type:T,color:s}}else this._board[t.to]={type:t.captured,color:s};if(t.flags&(b.KSIDE_CASTLE|b.QSIDE_CASTLE)){let n,r;t.flags&b.KSIDE_CASTLE?(n=t.to+1,r=t.to-1):(n=t.to-2,r=t.to+1),this._board[n]=this._board[r],delete this._board[r]}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){const i=[];let s=!1;for(const u in this._header)i.push(`[${u} "${this._header[u]}"]${e}`),s=!0;s&&this._history.length&&i.push(e);const n=u=>{const p=this._comments[this.fen()];if(typeof p<"u"){const m=u.length>0?" ":"";u=`${u}${m}{${p}}`}return u},r=[];for(;this._history.length>0;)r.push(this._undoMove());const o=[];let c="";for(r.length===0&&o.push(n(""));r.length>0;){c=n(c);const u=r.pop();if(!u)break;if(!this._history.length&&u.color==="b"){const p=`${this._moveNumber}. ...`;c=c?`${c} ${p}`:p}else u.color==="w"&&(c.length&&o.push(c),c=`${this._moveNumber}.`);c=`${c} ${this._moveToSan(u,this._moves({legal:!0}))}`,this._makeMove(u)}if(c.length&&o.push(n(c)),typeof this._header.Result<"u"&&o.push(this._header.Result),t===0)return i.join("")+o.join(" ");const h=function(){return i.length>0&&i[i.length-1]===" "?(i.pop(),!0):!1},l=function(u,p){for(const m of p.split(" "))if(m){if(u+m.length>t){for(;h();)u--;i.push(e),u=0}i.push(m),u+=m.length,i.push(" "),u++}return h()&&u--,u};let f=0;for(let u=0;u<o.length;u++){if(f+o[u].length>t&&o[u].includes("{")){f=l(f,o[u]);continue}f+o[u].length>t&&u!==0?(i[i.length-1]===" "&&i.pop(),i.push(e),f=0):u!==0&&(i.push(" "),f++),i.push(o[u]),f+=o[u].length}return i.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t,this._header}removeHeader(e){return e in this._header?(delete this._header[e],!0):!1}getHeaders(){return this._header}loadPgn(e,{strict:t=!1,newlineChar:i=`\r?
`}={}){function s(g){return g.replace(/\\/g,"\\")}function n(g){const C={},I=g.split(new RegExp(s(i)));let B="",G="";for(let H=0;H<I.length;H++){const Z=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;B=I[H].replace(Z,"$1"),G=I[H].replace(Z,"$2"),B.trim().length>0&&(C[B]=G)}return C}e=e.trim();const o=new RegExp(`^(\\[((?:${s(i)})|.)*\\])((?:\\s*${s(i)}){2}|(?:\\s*${s(i)})*$)`).exec(e),c=o&&o.length>=2?o[1]:"";this.reset();const h=n(c);let l="";for(const g in h)g.toLowerCase()==="fen"&&(l=h[g]),this.header(g,h[g]);if(!t)l&&this.load(l,{preserveHeaders:!0});else if(h.SetUp==="1"){if(!("FEN"in h))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(h.FEN,{preserveHeaders:!0})}function f(g){return Array.from(g).map(C=>C.charCodeAt(0)<128?C.charCodeAt(0).toString(16):encodeURIComponent(C).replace(/%/g,"").toLowerCase()).join("")}function u(g){return g.length===0?"":decodeURIComponent(`%${(g.match(/.{1,2}/g)||[]).join("%")}`)}const p=function(g){return g=g.replace(new RegExp(s(i),"g")," "),`{${f(g.slice(1,g.length-1))}}`},m=function(g){if(g.startsWith("{")&&g.endsWith("}"))return u(g.slice(1,g.length-1))};let v=e.replace(c,"").replace(new RegExp(`({[^}]*})+?|;([^${s(i)}]*)`,"g"),(g,C,I)=>C!==void 0?p(C):` ${p(`{${I.slice(1)}}`)}`).replace(new RegExp(s(i),"g")," ");const S=/(\([^()]+\))+?/g;for(;S.test(v);)v=v.replace(S,"");v=v.replace(/\d+\.(\.\.)?/g,""),v=v.replace(/\.\.\./g,""),v=v.replace(/\$\d+/g,"");let P=v.trim().split(new RegExp(/\s+/));P=P.filter(g=>g!=="");let y="";for(let g=0;g<P.length;g++){const C=m(P[g]);if(C!==void 0){this._comments[this.fen()]=C;continue}const I=this._moveFromSan(P[g],t);if(I==null)if(Kt.indexOf(P[g])>-1)y=P[g];else throw new Error(`Invalid move in PGN: ${P[g]}`);else y="",this._makeMove(I),this._incPositionCount(this.fen())}y&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",y)}_moveToSan(e,t){let i="";if(e.flags&b.KSIDE_CASTLE)i="O-O";else if(e.flags&b.QSIDE_CASTLE)i="O-O-O";else{if(e.piece!==T){const s=Wt(e,t);i+=e.piece.toUpperCase()+s}e.flags&(b.CAPTURE|b.EP_CAPTURE)&&(e.piece===T&&(i+=q(e.from)[0]),i+="x"),i+=q(e.to),e.promotion&&(i+=`=${e.promotion.toUpperCase()}`)}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?i+="#":i+="+"),this._undoMove(),i}_moveFromSan(e,t=!1){const i=We(e);let s=gt(i),n=this._moves({legal:!0,piece:s});for(let u=0,p=n.length;u<p;u++)if(i===We(this._moveToSan(n[u],n)))return n[u];if(t)return null;let r,o,c,h,l,f=!1;if(o=i.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(r=o[1],c=o[2],h=o[3],l=o[4],c.length===1&&(f=!0)):(o=i.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(r=o[1],c=o[2],h=o[3],l=o[4],c.length===1&&(f=!0))),s=gt(i),n=this._moves({legal:!0,piece:r||s}),!h)return null;for(let u=0,p=n.length;u<p;u++)if(c){if((!r||r.toLowerCase()===n[u].piece)&&_[c]===n[u].from&&_[h]===n[u].to&&(!l||l.toLowerCase()===n[u].promotion))return n[u];if(f){const m=q(n[u].from);if((!r||r.toLowerCase()===n[u].piece)&&_[h]===n[u].to&&(c===m[0]||c===m[1])&&(!l||l.toLowerCase()===n[u].promotion))return n[u]}}else if(i===We(this._moveToSan(n[u],n)).replace("x",""))return n[u];return null}ascii(){let e=`   +------------------------+
`;for(let t=_.a8;t<=_.h1;t++){if(fe(t)===0&&(e+=` ${"87654321"[te(t)]} |`),this._board[t]){const i=this._board[t].type,n=this._board[t].color===D?i.toUpperCase():i.toLowerCase();e+=` ${n} `}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let i=0;const s=this._turn;for(let n=0,r=t.length;n<r;n++)this._makeMove(t[n]),this._isKingAttacked(s)||(e-1>0?i+=this.perft(e-1):i++),this._undoMove();return i}turn(){return this._turn}board(){const e=[];let t=[];for(let i=_.a8;i<=_.h1;i++)this._board[i]==null?t.push(null):t.push({square:q(i),type:this._board[i].type,color:this._board[i].color}),i+1&136&&(e.push(t),t=[],i+=8);return e}squareColor(e){if(e in _){const t=_[e];return(te(t)+fe(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],i=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const s=t.pop();if(!s)break;e?i.push(new Me(this,s)):i.push(this._moveToSan(s,this._moves())),this._makeMove(s)}return i}_getPositionCount(e){const t=Qe(e);return this._positionCount[t]||0}_incPositionCount(e){const t=Qe(e);this._positionCount[t]===void 0&&(this._positionCount[t]=0),this._positionCount[t]+=1}_decPositionCount(e){const t=Qe(e);this._positionCount[t]===1?delete this._positionCount[t]:this._positionCount[t]-=1}_pruneComments(){const e=[],t={},i=s=>{s in this._comments&&(t[s]=this._comments[s])};for(;this._history.length>0;)e.push(this._undoMove());for(i(this.fen());;){const s=e.pop();if(!s)break;this._makeMove(s),i(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(const s of[k,Q])t[s]!==void 0&&(t[s]?this._castling[e]|=ke[s]:this._castling[e]&=~ke[s]);this._updateCastlingRights();const i=this.getCastlingRights(e);return(t[k]===void 0||t[k]===i[k])&&(t[Q]===void 0||t[Q]===i[Q])}getCastlingRights(e){return{[k]:(this._castling[e]&ke[k])!==0,[Q]:(this._castling[e]&ke[Q])!==0}}moveNumber(){return this._moveNumber}}class vt{constructor(e){this.config=e,this.game=null}convertFen(e){if(typeof e=="string")return this._convertStringPosition(e);if(typeof e=="object"&&e!==null)return this._convertObjectPosition(e);throw new M(E.invalid_position+e,"position",e)}_convertStringPosition(e){if(e==="start")return X;if(this.validateFen(e))return e;if(x[e])return x[e];throw new M(E.invalid_position+e,"position",e)}_convertObjectPosition(e){const t=[];for(let i=0;i<8;i++){const s=[];let n=0;for(let r=0;r<8;r++){const o=this._getSquareID(i,r),c=e[o];if(c){n>0&&(s.push(n),n=0);const h=c[1]==="w"?c[0].toUpperCase():c[0].toLowerCase();s.push(h)}else n++}n>0&&s.push(n),t.push(s.join(""))}return`${t.join("/")} w KQkq - 0 1`}setGame(e,t={}){const i=this.convertFen(e);this.game?this.game.load(i,t):this.game=new pt(i)}getGame(){return this.game}validateFen(e){return Ke(e)}getGamePieceId(e){if(!this.game)return null;const t=this.game.get(e);return t?t.color+t.type:null}isPiece(e,t){return this.getGamePieceId(t)===e}_getSquareID(e,t){return e=parseInt(e),t=parseInt(t),this.config.orientation==="w"?(e=8-e,t=t+1):(e=e+1,t=8-t),le[t-1]+e}changeFenTurn(e,t){const i=e.split(" ");return i[1]=t,i.join(" ")}getPosition(){const e={},t=this.getGame(),i=["a1","b1","c1","d1","e1","f1","g1","h1","a2","b2","c2","d2","e2","f2","g2","h2","a3","b3","c3","d3","e3","f3","g3","h3","a4","b4","c4","d4","e4","f4","g4","h4","a5","b5","c5","d5","e5","f5","g5","h5","a6","b6","c6","d6","e6","f6","g6","h6","a7","b7","c7","d7","e7","f7","g7","h7","a8","b8","c8","d8","e8","f8","g8","h8"];for(const s of i){const n=t.get(s);n&&(e[s]=n.type+n.color)}return e}changeFenColor(e){const t=e.split(" ");return t[1]=t[1]==="w"?"b":"w",t.join(" ")}destroy(){this.game=null}}class Ye{constructor(){this.metrics=new Map,this.observers=new Map,this.isEnabled=typeof performance<"u"&&performance.mark,this.isEnabled&&this._setupObservers()}_setupObservers(){try{if(typeof PerformanceObserver<"u"){const e=new PerformanceObserver(t=>{for(const i of t.getEntries())this.recordMetric(i.name,i.startTime)});e.observe({entryTypes:["paint"]}),this.observers.set("paint",e)}}catch(e){console.warn("Performance observers not available:",e.message)}}startMeasure(e){if(this.isEnabled)try{performance.mark(`${e}-start`)}catch(t){console.warn(`Failed to start performance measure for ${e}:`,t.message)}}endMeasure(e){if(!this.isEnabled)return 0;try{performance.mark(`${e}-end`);const t=performance.measure(e,`${e}-start`,`${e}-end`);return this.recordMetric(e,t.duration),performance.clearMarks(`${e}-start`),performance.clearMarks(`${e}-end`),performance.clearMeasures(e),t.duration}catch(t){return console.warn(`Failed to end performance measure for ${e}:`,t.message),0}}recordMetric(e,t){this.metrics.has(e)||this.metrics.set(e,{count:0,total:0,min:1/0,max:-1/0,values:[]});const i=this.metrics.get(e);i.count++,i.total+=t,i.min=Math.min(i.min,t),i.max=Math.max(i.max,t),i.values.push(t),i.values.length>100&&i.values.shift()}getMetrics(){const e={};for(const[t,i]of this.metrics)e[t]={count:i.count,average:i.total/i.count,min:i.min,max:i.max,total:i.total,p95:this._calculatePercentile(i.values,95),p99:this._calculatePercentile(i.values,99)};return e}_calculatePercentile(e,t){if(e.length===0)return 0;const i=[...e].sort((n,r)=>n-r),s=Math.ceil(t/100*i.length)-1;return i[Math.max(0,s)]}clearMetrics(){this.metrics.clear()}destroy(){for(const e of this.observers.values())e&&typeof e.disconnect=="function"&&e.disconnect();this.observers.clear(),this.metrics.clear()}}function Qt(a,e){let t;return function(...i){t||(a.apply(this,i),t=!0,setTimeout(()=>{t=!1},e))}}function Yt(a,e){let t;const i=function(...s){clearTimeout(t),t=setTimeout(()=>a.apply(i.context,s),e)};return function(...s){return i.context=this,i(...s)}}function Jt(a){let e=!1;const t=function(...i){e||(e=!0,requestAnimationFrame(()=>{a.apply(t.context,i),e=!1}))};return function(...i){return t.context=this,t(...i)}}function Zt(a,e,t,i=1){!a||!a.style||(a.style.transform=`translate3d(${e}px, ${t}px, 0) scale(${i})`,a.style.willChange="transform")}function Xt(a){!a||!a.style||(a.style.transform="",a.style.left="",a.style.top="",a.style.willChange="")}function ei(a){return new Promise(e=>{requestAnimationFrame(()=>{const t=a();e(t)})})}function ti(a){if(!a||!a.getBoundingClientRect)return!1;const e=a.getBoundingClientRect();return e.width>0&&e.height>0&&e.bottom>0&&e.right>0&&e.top<(window.innerHeight||document.documentElement.clientHeight)&&e.left<(window.innerWidth||document.documentElement.clientWidth)}function ii(){return typeof performance<"u"&&performance.memory?{used:performance.memory.usedJSHeapSize,total:performance.memory.totalJSHeapSize,limit:performance.memory.jsHeapSizeLimit}:{used:0,total:0,limit:0,supported:!1}}class ne{constructor(e,t={}){if(new.target===ne)throw new Error("BaseMode is abstract and cannot be instantiated directly");this.chessboard=e,this.config={name:"base",enforceRules:!0,allowFreeMovement:!1,allowPieceCreation:!1,allowPieceRemoval:!1,trackTurns:!0,detectGameEnd:!0,...t},this.isActive=!1,this.moveHistory=[],this.listeners=new Map}getName(){return this.config.name}start(){this.isActive=!0,this.moveHistory=[],this._emit("modeStart",{mode:this.getName()}),this.config.onModeStart&&this.config.onModeStart(this)}stop(){this.isActive=!1,this._emit("modeEnd",{mode:this.getName()}),this.config.onModeEnd&&this.config.onModeEnd(this)}canMove(e,t,i={}){return this.isActive?this.config.allowFreeMovement?!0:this._validateMove(e,t,i):!1}executeMove(e,t,i={}){if(!this.canMove(e,t,i))return!1;const s={from:e,to:t,timestamp:Date.now(),...i};return this.moveHistory.push(s),this._emit("move",s),this.config.onMove&&this.config.onMove(s),this.config.trackTurns&&this.config.onTurnChange&&this.config.onTurnChange(this.getCurrentTurn()),!0}canCreatePiece(){return this.isActive&&this.config.allowPieceCreation}canRemovePiece(){return this.isActive&&this.config.allowPieceRemoval}getCurrentTurn(){return this.config.trackTurns?this.chessboard.turn?this.chessboard.turn():"w":null}isGameOver(){return this.config.detectGameEnd&&this.chessboard.isGameOver?this.chessboard.isGameOver():!1}getGameResult(){var t,i,s,n,r,o;if(!this.isGameOver())return null;const e={isOver:!0,isCheckmate:((i=(t=this.chessboard).isCheckmate)==null?void 0:i.call(t))||!1,isStalemate:((n=(s=this.chessboard).isStalemate)==null?void 0:n.call(s))||!1,isDraw:((o=(r=this.chessboard).isDraw)==null?void 0:o.call(r))||!1,winner:null};return e.isCheckmate&&(e.winner=this.getCurrentTurn()==="w"?"b":"w"),e}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const i=this.listeners.get(e),s=i.indexOf(t);s>-1&&i.splice(s,1)}_emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(i=>{try{i(t)}catch(s){console.error(`Error in mode event listener for ${e}:`,s)}})}_validateMove(e,t){if(!this.chessboard.positionService)return!1;const i=this.chessboard.positionService.getGame();return i?i.moves({square:e,verbose:!0}).some(n=>n.to===t):!1}getStats(){return{mode:this.getName(),isActive:this.isActive,movesPlayed:this.moveHistory.length,currentTurn:this.getCurrentTurn(),isGameOver:this.isGameOver()}}reset(){this.moveHistory=[],this._emit("reset",{mode:this.getName()})}serialize(){return{name:this.getName(),config:this.config,isActive:this.isActive,moveHistory:this.moveHistory}}restore(e){e.moveHistory&&(this.moveHistory=e.moveHistory),e.isActive&&this.start()}}const Ne=class Ne extends ne{constructor(e,t={}){super(e,{name:"creative",enforceRules:!1,allowFreeMovement:!0,allowPieceCreation:!0,allowPieceRemoval:!0,trackTurns:!1,detectGameEnd:!1,showPiecePalette:!0,allowIllegalPositions:!0,availablePieces:Ne.DEFAULT_PIECES,...t}),this.selectedPiece=null,this.savedPositions=new Map,this.clipboard=null,this.undoStack=[],this.redoStack=[]}start(){super.start(),this._saveState(),this._setupInteractions(),this._emit("creativeStart",{availablePieces:this.config.availablePieces})}stop(){this._cleanupInteractions(),super.stop()}_setupInteractions(){this._originalDraggable=this.chessboard.config.draggable,this.chessboard.config&&(this.chessboard.config.draggable=!0)}_cleanupInteractions(){this._originalDraggable!==void 0&&this.chessboard.config&&(this.chessboard.config.draggable=this._originalDraggable)}selectPiece(e){if(!this.config.availablePieces.includes(e)){console.warn(`[CreativeMode] Piece ${e} not available`);return}this.selectedPiece=e,this._emit("pieceSelected",{piece:e})}deselectPiece(){this.selectedPiece=null,this._emit("pieceDeselected",{})}getSelectedPiece(){return this.selectedPiece}addPiece(e,t){if(!this.isActive)return!1;this._saveState();try{return this.chessboard.getPiece(t)&&this.chessboard.removePiece(t),this.chessboard.putPiece(e,t),this.chessboard.forceSync(),this._emit("pieceAdded",{piece:e,square:t}),this.config.onPieceAdded&&this.config.onPieceAdded({piece:e,square:t}),!0}catch(i){return console.error("[CreativeMode] Error adding piece:",i),this.undo(),!1}}removePiece(e){if(!this.isActive)return null;const t=this.chessboard.getPiece(e);if(!t)return null;this._saveState();try{return this.chessboard.removePiece(e),this.chessboard.forceSync(),this._emit("pieceRemoved",{piece:t,square:e}),this.config.onPieceRemoved&&this.config.onPieceRemoved({piece:t,square:e}),t}catch(i){return console.error("[CreativeMode] Error removing piece:",i),this.undo(),null}}movePiece(e,t){if(!this.isActive)return!1;const i=this.chessboard.getPiece(e);if(!i)return!1;this._saveState();try{return this.chessboard.removePiece(e),this.chessboard.putPiece(i,t),this.chessboard.forceSync(),this._emit("pieceMoved",{piece:i,from:e,to:t}),!0}catch(s){return console.error("[CreativeMode] Error moving piece:",s),this.undo(),!1}}copyPiece(e,t){if(!this.isActive)return!1;const i=this.chessboard.getPiece(e);return i?this.addPiece(i,t):!1}copyToClipboard(e){this.clipboard=this.chessboard.getPiece(e),this._emit("clipboardUpdated",{piece:this.clipboard})}pasteFromClipboard(e){return this.clipboard?this.addPiece(this.clipboard,e):!1}clearBoard(){this.isActive&&(this._saveState(),this.chessboard.clear({animate:!1}),this.chessboard.forceSync(),this._emit("boardCleared",{}))}setupStartingPosition(){this.isActive&&(this._saveState(),this.chessboard.reset({animate:!1}),this.chessboard.forceSync(),this._emit("positionReset",{}))}setPosition(e){if(!this.isActive)return!1;this._saveState();try{return this.chessboard.setPosition(e),this.chessboard.forceSync(),this._emit("positionSet",{fen:e}),!0}catch(t){return console.error("[CreativeMode] Error setting position:",t),this.undo(),!1}}savePosition(e){const t=this.chessboard.fen();return this.savedPositions.set(e,t),this._emit("positionSaved",{name:e,fen:t}),this.config.onPositionSaved&&this.config.onPositionSaved({name:e,fen:t}),t}loadPosition(e){const t=this.savedPositions.get(e);return t?this.setPosition(t):(console.warn(`[CreativeMode] Position "${e}" not found`),!1)}getSavedPositions(){return Array.from(this.savedPositions.keys())}deletePosition(e){return this.savedPositions.delete(e)}undo(){if(this.undoStack.length===0)return!1;this.redoStack.push(this.chessboard.fen());const e=this.undoStack.pop();return this.chessboard.setPosition(e),this.chessboard.forceSync(),this._emit("undo",{fen:e}),!0}redo(){if(this.redoStack.length===0)return!1;this.undoStack.push(this.chessboard.fen());const e=this.redoStack.pop();return this.chessboard.setPosition(e),this.chessboard.forceSync(),this._emit("redo",{fen:e}),!0}_saveState(){this.undoStack.push(this.chessboard.fen()),this.redoStack=[]}validatePosition(){const e=this.chessboard.fen(),t=e.split(" ")[0],i=[];let s=0,n=0,r=0,o=0;for(const h of t)h==="K"&&s++,h==="k"&&n++;const c=t.split("/");return c[0].includes("P")&&o++,c[7].includes("p")&&r++,s!==1&&i.push(`White has ${s} kings (should be 1)`),n!==1&&i.push(`Black has ${n} kings (should be 1)`),r>0&&i.push("White pawns on 1st rank"),o>0&&i.push("Black pawns on 8th rank"),{isValid:i.length===0,issues:i,fen:e}}exportPosition(e="fen"){switch(e){case"fen":return this.chessboard.fen();case"json":return JSON.stringify({fen:this.chessboard.fen(),savedPositions:Object.fromEntries(this.savedPositions)});default:return this.chessboard.fen()}}importPosition(e,t="fen"){try{switch(t){case"fen":return this.setPosition(e);case"json":{const i=JSON.parse(e);return i.fen&&this.setPosition(i.fen),i.savedPositions&&Object.entries(i.savedPositions).forEach(([s,n])=>{this.savedPositions.set(s,n)}),!0}default:return this.setPosition(e)}}catch(i){return console.error("[CreativeMode] Error importing position:",i),!1}}getStats(){return{...super.getStats(),selectedPiece:this.selectedPiece,savedPositionsCount:this.savedPositions.size,undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length,clipboardPiece:this.clipboard,validation:this.validatePosition()}}reset(){super.reset(),this.selectedPiece=null,this.clipboard=null,this.undoStack=[],this.redoStack=[]}serialize(){return{...super.serialize(),selectedPiece:this.selectedPiece,savedPositions:Object.fromEntries(this.savedPositions),clipboard:this.clipboard,undoStack:this.undoStack,redoStack:this.redoStack}}restore(e){super.restore(e),e.selectedPiece&&(this.selectedPiece=e.selectedPiece),e.savedPositions&&(this.savedPositions=new Map(Object.entries(e.savedPositions))),e.clipboard&&(this.clipboard=e.clipboard),e.undoStack&&(this.undoStack=e.undoStack),e.redoStack&&(this.redoStack=e.redoStack)}};w(Ne,"DEFAULT_PIECES",["wk","wq","wr","wb","wn","wp","bk","bq","br","bb","bn","bp"]);let Te=Ne;class _t extends ne{constructor(e,t={}){super(e,{name:"pvp",enforceRules:!0,allowFreeMovement:!1,allowPieceCreation:!1,allowPieceRemoval:!1,trackTurns:!0,detectGameEnd:!0,timeControl:null,allowTakeback:!0,allowDrawOffer:!0,showLegalMoves:!0,showLastMove:!0,showCheck:!0,...t}),this.players={w:{name:"White",timeRemaining:null,connected:!0},b:{name:"Black",timeRemaining:null,connected:!0}},this.gameStartTime=null,this.lastMoveTime=null,this.timerInterval=null,this.pendingDrawOffer=null,this.pendingTakeback=null,this.moveNotations=[]}start(){super.start(),this.gameStartTime=Date.now(),this.lastMoveTime=this.gameStartTime,this.config.timeControl&&(this.players.w.timeRemaining=this.config.timeControl.initial,this.players.b.timeRemaining=this.config.timeControl.initial,this._startTimer()),this._emit("gameStart",{players:this.players,timeControl:this.config.timeControl})}stop(){this._stopTimer(),super.stop()}setPlayerName(e,t){this.players[e]&&(this.players[e].name=t,this._emit("playerUpdated",{color:e,name:t}))}getPlayer(e){return this.players[e]}executeMove(e,t,i={}){if(!this.isActive)return!1;const s=this.chessboard.getPiece(e);if(!s)return!1;const n=s[0],r=this.getCurrentTurn();if(n!==r)return this._emit("invalidMove",{reason:"Not your turn",from:e,to:t}),!1;if(!this.canMove(e,t,i))return this._emit("invalidMove",{reason:"Illegal move",from:e,to:t}),!1;const o=this._getMoveNotation(e,t);if(!this.chessboard.movePiece(`${e}${t}${i.promotion||""}`))return this._emit("invalidMove",{reason:"Move failed",from:e,to:t}),!1;this.config.timeControl&&this._updatePlayerTime(r);const h={from:e,to:t,piece:s,notation:o,timestamp:Date.now(),...i};return this.moveHistory.push(h),this.moveNotations.push(o),this.pendingDrawOffer=null,this.pendingTakeback=null,this._emit("move",h),this.config.onMove&&this.config.onMove(h),this._checkGameEnd(),this.config.onTurnChange&&this.config.onTurnChange(this.getCurrentTurn()),!0}_getMoveNotation(e,t){var r;const i=(r=this.chessboard.positionService)==null?void 0:r.getGame();if(!i)return`${e}-${t}`;const n=i.moves({verbose:!0}).find(o=>o.from===e&&o.to===t);return n?n.san:`${e}-${t}`}_startTimer(){this.timerInterval||(this.timerInterval=setInterval(()=>{const e=this.getCurrentTurn();e&&this.players[e]&&(this.players[e].timeRemaining-=1,this._emit("timerUpdate",{color:e,timeRemaining:this.players[e].timeRemaining}),this.players[e].timeRemaining<=0&&this._handleTimeout(e))},1e3))}_stopTimer(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null)}_updatePlayerTime(e){this.config.timeControl&&(this.players[e].timeRemaining+=this.config.timeControl.increment,this._emit("timerUpdate",{color:e,timeRemaining:this.players[e].timeRemaining}))}_handleTimeout(e){this._stopTimer();const t=e==="w"?"b":"w";this._emit("gameEnd",{result:"timeout",winner:t,loser:e,reason:`${this.players[e].name} ran out of time`}),this.config.onGameEnd&&this.config.onGameEnd({result:"timeout",winner:t}),this.stop()}_checkGameEnd(){var n,r,o,c,h,l;const e=(n=this.chessboard.positionService)==null?void 0:n.getGame();if(!e)return;let t=null,i=null,s="";(r=e.isCheckmate)!=null&&r.call(e)?(i=this.getCurrentTurn()==="w"?"b":"w",t="checkmate",s=`Checkmate! ${this.players[i].name} wins`):(o=e.isStalemate)!=null&&o.call(e)?(t="stalemate",s="Stalemate - Draw"):(c=e.isThreefoldRepetition)!=null&&c.call(e)?(t="repetition",s="Draw by threefold repetition"):(h=e.isInsufficientMaterial)!=null&&h.call(e)?(t="insufficient",s="Draw by insufficient material"):(l=e.isDraw)!=null&&l.call(e)&&(t="draw",s="Draw"),t&&(this._stopTimer(),this._emit("gameEnd",{result:t,winner:i,reason:s}),this.config.onGameEnd&&this.config.onGameEnd({result:t,winner:i,reason:s}))}offerDraw(e){return!this.isActive||!this.config.allowDrawOffer?!1:(this.pendingDrawOffer=e,this._emit("drawOffered",{offerer:e}),this.config.onDrawOffer&&this.config.onDrawOffer({offerer:e}),!0)}acceptDraw(){return this.pendingDrawOffer?(this._stopTimer(),this._emit("gameEnd",{result:"agreement",winner:null,reason:"Draw by agreement"}),this.config.onGameEnd&&this.config.onGameEnd({result:"agreement",winner:null}),this.stop(),!0):!1}declineDraw(){if(!this.pendingDrawOffer)return;const e=this.pendingDrawOffer;this.pendingDrawOffer=null,this._emit("drawDeclined",{offerer:e})}requestTakeback(e){return!this.isActive||!this.config.allowTakeback||this.moveHistory.length===0?!1:(this.pendingTakeback=e,this._emit("takebackRequested",{requester:e}),this.config.onTakebackRequest&&this.config.onTakebackRequest({requester:e}),!0)}acceptTakeback(){if(!this.pendingTakeback)return!1;this.chessboard.undoMove(),this.chessboard.forceSync();const e=this.moveHistory.pop();return this.moveNotations.pop(),this.pendingTakeback=null,this._emit("takebackAccepted",{move:e}),!0}declineTakeback(){if(!this.pendingTakeback)return;const e=this.pendingTakeback;this.pendingTakeback=null,this._emit("takebackDeclined",{requester:e})}resign(e){if(!this.isActive)return;this._stopTimer();const t=e==="w"?"b":"w";this._emit("gameEnd",{result:"resignation",winner:t,reason:`${this.players[e].name} resigned`}),this.config.onGameEnd&&this.config.onGameEnd({result:"resignation",winner:t}),this.stop()}getPGN(){const e=[];for(let t=0;t<this.moveNotations.length;t+=2){const i=Math.floor(t/2)+1,s=this.moveNotations[t],n=this.moveNotations[t+1]||"";e.push(`${i}. ${s} ${n}`)}return e.join(" ")}getFormattedTime(e){var n;const t=(n=this.players[e])==null?void 0:n.timeRemaining;if(t==null)return"--:--";const i=Math.floor(t/60),s=t%60;return`${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}getLegalMoves(e){var s;const t=(s=this.chessboard.positionService)==null?void 0:s.getGame();return t?t.moves({square:e,verbose:!0}).map(n=>n.to):[]}isInCheck(){var t,i;const e=(t=this.chessboard.positionService)==null?void 0:t.getGame();return((i=e==null?void 0:e.isCheck)==null?void 0:i.call(e))||!1}getStats(){return{...super.getStats(),players:this.players,moveNotations:this.moveNotations,pgn:this.getPGN(),isInCheck:this.isInCheck(),pendingDrawOffer:this.pendingDrawOffer,pendingTakeback:this.pendingTakeback,gameDuration:this.gameStartTime?Date.now()-this.gameStartTime:0}}reset(){super.reset(),this._stopTimer(),this.moveNotations=[],this.pendingDrawOffer=null,this.pendingTakeback=null,this.config.timeControl&&(this.players.w.timeRemaining=this.config.timeControl.initial,this.players.b.timeRemaining=this.config.timeControl.initial)}serialize(){return{...super.serialize(),players:this.players,moveNotations:this.moveNotations,pendingDrawOffer:this.pendingDrawOffer,pendingTakeback:this.pendingTakeback,gameStartTime:this.gameStartTime}}restore(e){super.restore(e),e.players&&(this.players=e.players),e.moveNotations&&(this.moveNotations=e.moveNotations),e.pendingDrawOffer&&(this.pendingDrawOffer=e.pendingDrawOffer),e.pendingTakeback&&(this.pendingTakeback=e.pendingTakeback),e.gameStartTime&&(this.gameStartTime=e.gameStartTime)}}const ge={p:100,n:320,b:330,r:500,q:900,k:2e4},si={p:[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],n:[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],b:[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,10,10,5,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],r:[[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]],q:[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,5,5,5,5,5,0,-10],[-10,0,5,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],k:[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]]},ni={rnbqkbnr_pppppppp_8_8_8_8_PPPPPPPP_RNBQKBNR:["e2e4","d2d4","c2c4","g1f3"],rnbqkbnr_pppppppp_8_8_4P3_8_PPPP1PPP_RNBQKBNR:["e7e5","c7c5","e7e6","c7c6"],rnbqkbnr_pppppppp_8_8_3P4_8_PPP1PPPP_RNBQKBNR:["d7d5","g8f6","e7e6"]};class Ae{constructor(e,t={}){this.game=e,this.config={difficulty:5,maxDepth:4,maxTime:5e3,useOpeningBook:!0,randomizeEquivalent:!0,strategy:"alphabeta",...t},this._adjustDifficulty(),this.nodesSearched=0,this.startTime=0}_adjustDifficulty(){const e=Math.max(1,Math.min(10,this.config.difficulty));this.config.maxDepth=Math.ceil(e/2),this.mistakeProbability=Math.max(0,(5-e)*.1)}setDifficulty(e){this.config.difficulty=e,this._adjustDifficulty()}getBestMove(){this.nodesSearched=0,this.startTime=Date.now();const e=this.game.moves({verbose:!0});if(e.length===0)return null;if(this.config.useOpeningBook&&this.game.history().length<10){const i=this._getBookMove();if(i)return i}if(this.mistakeProbability>0&&Math.random()<this.mistakeProbability)return this._getRandomMove(e);let t;switch(this.config.strategy){case"random":t=this._getRandomMove(e);break;case"minimax":t=this._minimaxRoot(e);break;case"alphabeta":default:t=this._alphabetaRoot(e);break}return t}_getBookMove(){const e=this.game.fen().split(" ")[0].replace(/\//g,"_"),t=ni[e];if(t&&t.length>0){const i=t[Math.floor(Math.random()*t.length)],s=i.substring(0,2),n=i.substring(2,4),r=i.length>4?i[4]:void 0;return{from:s,to:n,promotion:r}}return null}_getRandomMove(e){const t=Math.floor(Math.random()*e.length),i=e[t];return{from:i.from,to:i.to,promotion:i.promotion}}_minimaxRoot(e){let t=null,i=-1/0;const s=this.game.turn()==="w";for(const n of e){this.game.move(n);const r=this._minimax(this.config.maxDepth-1,!s);this.game.undo(),(r>i||r===i&&Math.random()<.3)&&(i=r,t=n)}return t?{from:t.from,to:t.to,promotion:t.promotion}:null}_minimax(e,t){if(this.nodesSearched++,e===0||this.game.isGameOver())return this._evaluate();const i=this.game.moves({verbose:!0});if(t){let n=-1/0;for(const r of i){this.game.move(r);const o=this._minimax(e-1,!1);this.game.undo(),n=Math.max(n,o)}return n}let s=1/0;for(const n of i){this.game.move(n);const r=this._minimax(e-1,!0);this.game.undo(),s=Math.min(s,r)}return s}_alphabetaRoot(e){let t=null,i=-1/0,s=-1/0;const n=1/0,r=this.game.turn()==="w",o=this._sortMoves(e);for(const c of o){this.game.move(c);const h=-this._alphabeta(this.config.maxDepth-1,-n,-s,!r);if(this.game.undo(),(h>i||h===i&&this.config.randomizeEquivalent&&Math.random()<.3)&&(i=h,t=c),s=Math.max(s,h),Date.now()-this.startTime>this.config.maxTime)break}return t?{from:t.from,to:t.to,promotion:t.promotion}:null}_alphabeta(e,t,i,s){if(this.nodesSearched++,Date.now()-this.startTime>this.config.maxTime)return this._evaluate()*(s?1:-1);if(e===0)return this._quiesce(t,i,s);if(this.game.isGameOver())return this.game.isCheckmate()?-1/0+(this.config.maxDepth-e):0;const n=this._sortMoves(this.game.moves({verbose:!0}));for(const r of n){this.game.move(r);const o=-this._alphabeta(e-1,-i,-t,!s);if(this.game.undo(),o>=i)return i;t=Math.max(t,o)}return t}_quiesce(e,t,i){const s=this._evaluate()*(i?1:-1);if(s>=t)return t;s>e&&(e=s);const n=this.game.moves({verbose:!0}).filter(r=>r.captured);for(const r of n){this.game.move(r);const o=-this._quiesce(-t,-e,!i);if(this.game.undo(),o>=t)return t;e=Math.max(e,o)}return e}_sortMoves(e){return e.sort((t,i)=>{var s,n,r,o;if(t.captured&&!i.captured)return-1;if(!t.captured&&i.captured)return 1;if(t.captured&&i.captured){const c=ge[t.captured]-ge[t.piece];return ge[i.captured]-ge[i.piece]-c}return t.promotion&&!i.promotion?-1:!t.promotion&&i.promotion?1:(s=t.san)!=null&&s.includes("+")&&!((n=i.san)!=null&&n.includes("+"))?-1:!((r=t.san)!=null&&r.includes("+"))&&((o=i.san)!=null&&o.includes("+"))?1:0})}_evaluate(){const e=this.game.board();let t=0;for(let s=0;s<8;s++)for(let n=0;n<8;n++){const r=e[s][n];if(!r)continue;const o=ge[r.type]||0,c=this._getPositionValue(r.type,s,n,r.color),h=o+c;t+=r.color==="w"?h:-h}const i=this._evaluateMobility();return t+=i,t}_getPositionValue(e,t,i,s){const n=si[e];if(!n)return 0;const r=s==="w"?t:7-t;return n[r][i]}_evaluateMobility(){const e=this.game.turn(),t=this.game.moves().length;return e==="w"?t*10:-t*10}getStats(){return{nodesSearched:this.nodesSearched,timeElapsed:Date.now()-this.startTime,depth:this.config.maxDepth,difficulty:this.config.difficulty}}}const oe=class oe extends ne{constructor(e,t={}){super(e,{name:"vsBot",enforceRules:!0,allowFreeMovement:!1,allowPieceCreation:!1,allowPieceRemoval:!1,trackTurns:!0,detectGameEnd:!0,playerColor:"w",botDifficulty:5,botThinkingTime:1e3,showBotThinking:!0,allowHints:!0,allowTakeback:!0,autoMove:!0,...t}),this.ai=null,this.engine=t.engine||null,this.botColor=this.config.playerColor==="w"?"b":"w",this.isThinking=!1,this.thinkingTimeout=null,this.hintsUsed=0,this.lastBotMove=null,this.useExternalEngine=!!t.engine}start(){super.start(),this._initializeAI(),this._emit("gameStart",{playerColor:this.config.playerColor,botColor:this.botColor,difficulty:this.config.botDifficulty,difficultyName:oe.DIFFICULTY_NAMES[this.config.botDifficulty]}),this.botColor==="w"&&this.config.autoMove&&this._scheduleBotMove()}stop(){this._cancelBotMove(),super.stop()}_initializeAI(){var t;const e=(t=this.chessboard.positionService)==null?void 0:t.getGame();if(!e){console.error("[VsBotMode] Cannot initialize AI: no game instance");return}this.ai=new Ae(e,{difficulty:this.config.botDifficulty})}setDifficulty(e){this.config.botDifficulty=Math.max(1,Math.min(10,e)),this.ai&&this.ai.setDifficulty(this.config.botDifficulty),this._emit("difficultyChanged",{difficulty:this.config.botDifficulty,difficultyName:oe.DIFFICULTY_NAMES[this.config.botDifficulty]})}getDifficultyName(){return oe.DIFFICULTY_NAMES[this.config.botDifficulty]||"Unknown"}setPlayerColor(e){this.config.playerColor=e,this.botColor=e==="w"?"b":"w",this._emit("playerColorChanged",{playerColor:e,botColor:this.botColor})}setEngine(e,t={}){var i;this.engine=e,this.useExternalEngine=!!e,this.config.engineDepth=t.depth||this.config.engineDepth||20,this.config.engineMoveTime=t.moveTime||this.config.engineMoveTime||1e3,e&&e.on("info",s=>{this._emit("engineInfo",s),this.config.onEngineInfo&&this.config.onEngineInfo(s)}),this._emit("engineChanged",{engine:((i=e==null?void 0:e.getInfo)==null?void 0:i.call(e))||null,useExternalEngine:this.useExternalEngine})}removeEngine(){this.engine=null,this.useExternalEngine=!1,this._emit("engineChanged",{engine:null,useExternalEngine:!1})}isUsingExternalEngine(){return this.useExternalEngine&&this.engine!==null}isPlayerTurn(){return this.getCurrentTurn()===this.config.playerColor}isBotTurn(){return this.getCurrentTurn()===this.botColor}executeMove(e,t,i={}){if(!this.isActive)return!1;if(!this.isPlayerTurn())return this._emit("invalidMove",{reason:"It's the bot's turn",from:e,to:t}),!1;if(!this.canMove(e,t,i))return this._emit("invalidMove",{reason:"Illegal move",from:e,to:t}),!1;const s=`${e}${t}${i.promotion||""}`;if(!this.chessboard.movePiece(s))return this._emit("invalidMove",{reason:"Move failed",from:e,to:t}),!1;const r={from:e,to:t,player:"human",timestamp:Date.now(),...i};return this.moveHistory.push(r),this._emit("move",r),this.config.onMove&&this.config.onMove(r),this._checkGameEnd()||this.config.autoMove&&this._scheduleBotMove(),!0}_scheduleBotMove(){if(this.isThinking)return;this.isThinking=!0,this._emit("botThinking",{thinking:!0}),this.config.onBotThinking&&this.config.onBotThinking(!0);const e=Math.max(this.config.botThinkingTime,Math.random()*500+500);this.thinkingTimeout=setTimeout(()=>{this._makeBotMove()},e)}_cancelBotMove(){this.thinkingTimeout&&(clearTimeout(this.thinkingTimeout),this.thinkingTimeout=null),this.isThinking=!1}async _makeBotMove(){var n,r,o;if(this.isThinking=!1,!this.isActive){this._emit("botThinking",{thinking:!1});return}let e=null,t=null;if(this.useExternalEngine&&this.engine)try{e=await this._getEngineBestMove(),t={source:"external",engine:((o=(r=(n=this.engine).getInfo)==null?void 0:r.call(n))==null?void 0:o.name)||"unknown"}}catch(c){console.warn("[VsBotMode] External engine failed, falling back to AI:",c),this.ai&&(e=this.ai.getBestMove(),t={source:"builtin",...this.ai.getStats()})}else this.ai&&(e=this.ai.getBestMove(),t={source:"builtin",...this.ai.getStats()});if(!e){this._emit("botThinking",{thinking:!1}),this._checkGameEnd();return}const i=`${e.from}${e.to}${e.promotion||""}`;if(this.chessboard.movePiece(i)){const c={...e,player:"bot",timestamp:Date.now(),stats:t};this.moveHistory.push(c),this.lastBotMove=c,this._emit("botMove",c),this.config.onBotMove&&this.config.onBotMove(c),this._checkGameEnd()}this._emit("botThinking",{thinking:!1}),this.config.onBotThinking&&this.config.onBotThinking(!1)}async _getEngineBestMove(){if(!this.engine||!this.engine.ready())throw new Error("Engine not ready");const e=this.chessboard.fen();await this.engine.setPosition(e);const t=await this.engine.go({depth:this.config.engineDepth||20,moveTime:this.config.engineMoveTime||1e3});if(!(t!=null&&t.bestMove))return null;const i=t.bestMove;return{from:i.substring(0,2),to:i.substring(2,4),promotion:i.length>4?i[4]:void 0,score:t.score,depth:t.depth,pv:t.pv}}triggerBotMove(){this.isBotTurn()&&this._scheduleBotMove()}async getHint(){var t;if(!this.config.allowHints||!this.isPlayerTurn())return null;let e=null;if(this.useExternalEngine&&this.engine&&this.engine.ready())try{const i=this.chessboard.fen();await this.engine.setPosition(i);const s=await this.engine.go({depth:Math.min(this.config.engineDepth||20,15),moveTime:500});if(s!=null&&s.bestMove){const n=s.bestMove;e={from:n.substring(0,2),to:n.substring(2,4),promotion:n.length>4?n[4]:void 0,score:s.score,source:"engine"}}}catch(i){console.warn("[VsBotMode] Engine hint failed:",i)}if(!e){const i=(t=this.chessboard.positionService)==null?void 0:t.getGame();if(!i)return null;e=new Ae(i,{difficulty:8}).getBestMove(),e&&(e.source="builtin")}return e&&(this.hintsUsed++,this._emit("hintUsed",{hint:e,totalHints:this.hintsUsed})),e}requestTakeback(){if(!this.config.allowTakeback||this.moveHistory.length<2||this.isThinking)return!1;this.chessboard.undoMove(),this.chessboard.undoMove(),this.chessboard.forceSync();const e=this.moveHistory.pop(),t=this.moveHistory.pop();return this._emit("takeback",{playerMove:t,botMove:e}),!0}resign(){this.isActive&&(this._cancelBotMove(),this._emit("gameEnd",{result:"resignation",winner:this.botColor,reason:"Player resigned"}),this.config.onGameEnd&&this.config.onGameEnd({result:"resignation",winner:this.botColor}),this.stop())}_checkGameEnd(){var n,r,o,c,h,l;const e=(n=this.chessboard.positionService)==null?void 0:n.getGame();if(!e)return!1;let t=null,i=null,s="";if((r=e.isCheckmate)!=null&&r.call(e)?(i=this.getCurrentTurn()==="w"?"b":"w",t="checkmate",s=`Checkmate! ${i===this.config.playerColor?"Player":"Bot"} wins`):(o=e.isStalemate)!=null&&o.call(e)?(t="stalemate",s="Stalemate - Draw"):(c=e.isThreefoldRepetition)!=null&&c.call(e)?(t="repetition",s="Draw by threefold repetition"):(h=e.isInsufficientMaterial)!=null&&h.call(e)?(t="insufficient",s="Draw by insufficient material"):(l=e.isDraw)!=null&&l.call(e)&&(t="draw",s="Draw"),t){this._cancelBotMove();const f=i===this.config.playerColor;return this._emit("gameEnd",{result:t,winner:i,reason:s,isPlayerWin:f}),this.config.onGameEnd&&this.config.onGameEnd({result:t,winner:i,reason:s,isPlayerWin:f}),!0}return!1}async analyzePosition(){var r,o;const e=(r=this.chessboard.positionService)==null?void 0:r.getGame();if(!e)return null;let t=null,i=null,s="builtin";if(this.useExternalEngine&&this.engine&&this.engine.ready())try{const c=this.chessboard.fen();await this.engine.setPosition(c);const h=await this.engine.go({depth:this.config.engineDepth||20,moveTime:this.config.engineMoveTime||2e3});if(h!=null&&h.bestMove){const l=h.bestMove;t={from:l.substring(0,2),to:l.substring(2,4),promotion:l.length>4?l[4]:void 0},i={score:h.score,depth:h.depth,nodes:h.nodes,nps:h.nps,pv:h.pv,time:h.time},s="engine"}}catch(c){console.warn("[VsBotMode] Engine analysis failed:",c)}if(!t&&this.ai){const c=new Ae(e,{difficulty:10});t=c.getBestMove(),i=c.getStats()}const n=e.moves({verbose:!0});return{bestMove:t,legalMoves:n.length,isCheck:((o=e.isCheck)==null?void 0:o.call(e))||!1,turn:e.turn(),stats:i,source:s}}getStats(){var e,t,i,s,n;return{...super.getStats(),playerColor:this.config.playerColor,botColor:this.botColor,difficulty:this.config.botDifficulty,difficultyName:this.getDifficultyName(),hintsUsed:this.hintsUsed,isThinking:this.isThinking,lastBotMove:this.lastBotMove,aiStats:((e=this.ai)==null?void 0:e.getStats())||null,useExternalEngine:this.useExternalEngine,engineInfo:((i=(t=this.engine)==null?void 0:t.getInfo)==null?void 0:i.call(t))||null,engineReady:((n=(s=this.engine)==null?void 0:s.ready)==null?void 0:n.call(s))||!1}}reset(){super.reset(),this._cancelBotMove(),this.hintsUsed=0,this.lastBotMove=null,this._initializeAI()}serialize(){return{...super.serialize(),playerColor:this.config.playerColor,botColor:this.botColor,botDifficulty:this.config.botDifficulty,hintsUsed:this.hintsUsed,lastBotMove:this.lastBotMove}}restore(e){super.restore(e),e.playerColor&&(this.config.playerColor=e.playerColor),e.botColor&&(this.botColor=e.botColor),e.botDifficulty&&this.setDifficulty(e.botDifficulty),e.hintsUsed&&(this.hintsUsed=e.hintsUsed),e.lastBotMove&&(this.lastBotMove=e.lastBotMove)}};w(oe,"DIFFICULTY_NAMES",{1:"Beginner",2:"Easy",3:"Easy+",4:"Medium-",5:"Medium",6:"Medium+",7:"Hard-",8:"Hard",9:"Expert",10:"Master"});let Ie=oe;const Be=class Be{constructor(e){this.chessboard=e,this.currentMode=null,this.modes=new Map,this.listeners=new Map,this._initializeDefaultModes()}_initializeDefaultModes(){Object.entries(Be.MODES).forEach(([e,t])=>{this.registerMode(e,t)})}registerMode(e,t,i={}){this.modes.set(e,{ModeClass:t,defaultConfig:i,instance:null})}getMode(e,t={}){const i=this.modes.get(e);if(!i)return console.error(`[ModeManager] Unknown mode: ${e}`),null;if(!i.instance){const s={...i.defaultConfig,...t};i.instance=new i.ModeClass(this.chessboard,s)}return i.instance}setMode(e,t={}){this.currentMode&&(this.currentMode.stop(),this._emit("modeChanged",{from:this.currentMode.getName(),to:e}));const i=this.getMode(e,t);return i?(this.currentMode=i,i.start(),this._emit("modeActivated",{mode:e,config:i.config}),i):null}getCurrentMode(){return this.currentMode}getCurrentModeName(){return this.currentMode?this.currentMode.getName():null}isModeActive(e){return this.currentMode&&this.currentMode.getName()===e}getAvailableModes(){return Array.from(this.modes.keys())}canMove(e,t,i={}){return this.currentMode?this.currentMode.canMove(e,t,i):!0}executeMove(e,t,i={}){return this.currentMode?this.currentMode.executeMove(e,t,i):!1}canCreatePiece(){return this.currentMode?this.currentMode.canCreatePiece():!1}canRemovePiece(){return this.currentMode?this.currentMode.canRemovePiece():!1}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const i=this.listeners.get(e),s=i.indexOf(t);s>-1&&i.splice(s,1)}_emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(i=>{try{i(t)}catch(s){console.error(`[ModeManager] Error in event listener for ${e}:`,s)}})}reset(){this.currentMode&&this.currentMode.reset()}stop(){this.currentMode&&(this.currentMode.stop(),this.currentMode=null)}destroy(){this.stop(),this.modes.clear(),this.listeners.clear()}getStats(){return this.currentMode?this.currentMode.getStats():null}serialize(){return{currentMode:this.currentMode?this.currentMode.serialize():null,availableModes:this.getAvailableModes()}}};w(Be,"MODES",{creative:Te,pvp:_t,vsBot:Ie});let Re=Be,Oe=class{constructor(e){try{this._performanceMonitor=new Ye,this._performanceMonitor.startMeasure("chessboard-initialization"),this._validateAndInitializeConfig(e),this._initializeServices(),this._initialize(),this._performanceMonitor.endMeasure("chessboard-initialization")}catch(t){this._handleConstructorError(t)}this._undoneMoves=[],this._doUpdateBoardPieces(!1,!0)}_validateAndInitializeConfig(e){if(!e||typeof e!="object")throw new O("Configuration must be an object","config",e);if(this.config=new Ve(e),!this.config.id_div)throw new O("Configuration must include id_div","id_div",this.config.id_div)}_handleConstructorError(e){throw console.error("Chessboard initialization failed:",e),this._cleanup(),e instanceof j?e:new j("Failed to initialize chessboard","INITIALIZATION_ERROR",{originalError:e.message,stack:e.stack})}_cleanup(){this.eventService&&typeof this.eventService.removeListeners=="function"&&this.eventService.removeListeners(),this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null),this.validationService=null,this.coordinateService=null,this.positionService=null,this.boardService=null,this.pieceService=null,this.animationService=null,this.moveService=null,this.eventService=null}_initializeServices(){this.validationService=new we,this.coordinateService=new ct(this.config),this.positionService=new vt(this.config),this.boardService=new at(this.config),this.pieceService=new ut(this.config),this.animationService=new ot(this.config),this.moveService=new lt(this.config,this.positionService),this.eventService=new ht(this.config,this.boardService,this.moveService,this.coordinateService,this),this._updateTimeout=null,this._isAnimating=!1,this.modeManager=new Re(this),this._boundUpdateBoardPieces=this._updateBoardPieces.bind(this),this._boundOnSquareClick=this._onSquareClick.bind(this),this._boundOnPieceHover=this._onPieceHover.bind(this),this._boundOnPieceLeave=this._onPieceLeave.bind(this)}_initialize(){this._initParams(),this._setGame(this.config.position),this._buildBoard(),this._buildSquares(),this._addListeners(),this._doUpdateBoardPieces(!1,!0)}_initParams(){this.eventService.setClicked(null),this.eventService.setPromoting(!1),this.eventService.setAnimating(!1)}_setGame(e){this.positionService.setGame(e)}_buildBoard(){if(this._isUndoRedo)return;const e=document.getElementById(this.config.id_div);e&&(e.innerHTML=""),this.boardService&&this.boardService.squares&&Object.values(this.boardService.squares).forEach(t=>t&&t.forceRemoveAllPieces&&t.forceRemoveAllPieces()),this.boardService&&this.boardService.removeSquares&&this.boardService.removeSquares(),this.boardService&&this.boardService.removeBoard&&this.boardService.removeBoard(),this.boardService.buildBoard()}_buildSquares(){this._isUndoRedo||(this.boardService&&this.boardService.removeSquares&&this.boardService.removeSquares(),this.boardService.buildSquares((e,t)=>this.coordinateService.realCoord(e,t)))}_addListeners(){this.eventService.addListeners(this._boundOnSquareClick,this._boundOnPieceHover,this._boundOnPieceLeave)}_onSquareClick(e,t=!0,i=!1){return this.eventService.onClick(e,this._onMove.bind(this),this._onSelect.bind(this),this._onDeselect.bind(this),t,i)}_onPieceHover(e){this.config.hints&&!this.eventService.getClicked()&&this._hintMoves(e)}_onPieceLeave(e){this.config.hints&&!this.eventService.getClicked()&&this._dehintMoves(e)}_onMove(e,t,i=null,s=!0){const n=new W(e,t,i);return!n.check()||this.config.onlyLegalMoves&&!n.isLegal(this.positionService.getGame())?(this._clearVisualState(),!1):!n.hasPromotion()&&this._requiresPromotion(n)?!1:this.config.onMove(n)?(this._executeMove(n,s),!0):(this._clearVisualState(),!1)}_onSelect(e){this.config.clickable&&(e.select(),this._hintMoves(e))}_onDeselect(){this._clearVisualState()}_hintMoves(e){if(!this.moveService.canMove(e))return;this.boardService.applyToAllSquares("removeHint");const t=this.moveService.getCachedLegalMoves(e);for(const i of t)if(i.to&&i.to.length===2){const s=this.boardService.getSquare(i.to);if(s){const n=s.piece&&s.piece.color!==this.positionService.getGame().turn();s.putHint(n)}}}_dehintMoves(e){const t=this.moveService.getCachedLegalMoves(e);for(const i of t)if(i.to&&i.to.length===2){const s=this.boardService.getSquare(i.to);s&&s.removeHint()}}_requiresPromotion(e){return this.moveService.requiresPromotion(e)}_executeMove(e,t=!0){if(this._clearVisualState(),!this.positionService.getGame())throw new j("Game not initialized","GAME_ERROR");const s=this.moveService.executeMove(e);if(!s){console.error("Move execution failed unexpectedly for move:",e),this._updateBoardPieces(!1);return}this.boardService.applyToAllSquares("unmoved"),e.from.moved(),e.to.moved();const n=this.moveService.isCastle(s),r=this.moveService.isEnPassant(s);if(t&&e.from.piece)if(n){let o=!1,c=!1;const h=()=>{o&&c&&(this._updateBoardPieces(!1),this.config.onMoveEnd(s))};this.pieceService.translatePiece(e,!!e.to.piece,t,this._createDragFunction.bind(this),()=>{o=!0,h()}),this._handleCastleMove(s,!0,!1,()=>{c=!0,h()})}else r?this.pieceService.translatePiece(e,!1,t,this._createDragFunction.bind(this),()=>{this._handleEnPassantMove(s,!0),this.config.onMoveEnd(s),this._updateBoardPieces(!1)}):this.pieceService.translatePiece(e,!!e.to.piece,t,this._createDragFunction.bind(this),()=>{this.config.onMoveEnd(s),this._updateBoardPieces(!1)});else n?this._handleSpecialMove(s):r&&this._handleSpecialMove(s),this._updateBoardPieces(!1),this.config.onMoveEnd(s)}_handleSpecialMove(e){this.moveService.isCastle(e)?this._handleCastleMove(e,!1):this.moveService.isEnPassant(e)&&this._handleEnPassantMove(e,!1)}_handleSpecialMoveAnimation(e){this.moveService.isCastle(e)?this._handleCastleMove(e,!0):this.moveService.isEnPassant(e)&&this._handleEnPassantMove(e,!0)}_handleCastleMove(e,t,i=!0,s=null){const n=this.moveService.getCastleRookMove(e);if(!n){s&&s();return}const r=this.boardService.getSquare(n.from),o=this.boardService.getSquare(n.to);if(!r||!o){s&&s();return}const c=r.piece;if(!c){i&&this._updateBoardPieces(!1),s&&s();return}t?this.pieceService.translatePiece({from:r,to:o,piece:c},!1,!0,this._createDragFunction.bind(this),()=>{i&&this._updateBoardPieces(!1),s&&s()}):(i&&this._updateBoardPieces(!1),s&&s())}_handleEnPassantMove(e,t){const i=this.moveService.getEnPassantCapturedSquare(e);if(!i)return;const s=this.boardService.getSquare(i);if(!s||!s.piece){console.warn("En passant captured square not found or empty");return}t?(this.pieceService.removePieceFromSquare(s,!0),setTimeout(()=>{this._updateBoardPieces(!1)},this.config.moveTime)):this._updateBoardPieces(!1)}_updateBoardPieces(e=!1,t=!1){!this.positionService||!this.moveService||!this.eventService||(this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null),this.moveService.clearCache(),e&&!this.eventService.getClicked()?this._updateTimeout=setTimeout(()=>{this._doUpdateBoardPieces(e,t),this._updateTimeout=null,this._ensureHintsAvailable()},10):(this._doUpdateBoardPieces(e,t),this._ensureHintsAvailable()))}_ensureHintsAvailable(){this.config.hints&&setTimeout(()=>{this.boardService.applyToAllSquares("removeHint"),this.moveService.clearCache()},50)}_updateBoardPiecesDelayed(){this._updateBoardPieces(!1)}_doUpdateBoardPieces(e=!1,t=!1){if(this._isPromoting||!this.positionService||!this.positionService.getGame())return;const i=this.boardService.getAllSquares(),s=this.positionService.getGame().fen();if(t){this._doSequentialUpdate(i,s,!1);return}this.config.animationStyle==="simultaneous"?this._doSimultaneousUpdate(i,s,t):this._doSequentialUpdate(i,s,e)}_doSequentialUpdate(e,t,i){const s={};Object.values(e).forEach(r=>{s[r.id]=this.positionService.getGamePieceId(r.id)}),Object.values(e).forEach(r=>{const o=s[r.id],c=r.piece,h=c?c.getId():null;if(h!==o&&(c&&h!==o&&this.pieceService.removePieceFromSquare(r,i),o&&h!==o)){const l=this.pieceService.convertPiece(o);this.pieceService.addPieceOnSquare(r,l,i,this._createDragFunction.bind(this))}}),this._addListeners();const n=this.positionService.getGame().fen();t!==n&&this.config.onChange(n)}_doSimultaneousUpdate(e,t,i=!1){const s={},n={};Object.values(e).forEach(f=>{const u=f.piece,p=this.positionService.getGamePieceId(f.id);if(u){const m=(u.color+u.type).toLowerCase();s[m]||(s[m]=[]),s[m].push({square:f,id:f.id})}if(p){const m=p.toLowerCase();n[m]||(n[m]=[]),n[m].push({square:f,id:f.id})}});let r=0,o=0;const c=i?0:this.config.simultaneousAnimationDelay;let h=0;if(Object.keys(n).forEach(f=>{o+=Math.max((s[f]||[]).length,n[f].length)}),o===0){this._addListeners();const f=this.positionService.getGame().fen();t!==f&&this.config.onChange(f);return}const l=()=>{if(r++,r===o){this._addListeners();const f=this.positionService.getGame().fen();t!==f&&this.config.onChange(f)}};Object.keys(n).forEach(f=>{const u=(s[f]||[]).slice(),p=n[f].slice(),m=[];for(let y=0;y<u.length;y++){m[y]=[];for(let g=0;g<p.length;g++)m[y][g]=Math.abs(u[y].square.row-p[g].square.row)+Math.abs(u[y].square.col-p[g].square.col)}const v=new Array(u.length).fill(!1),S=new Array(p.length).fill(!1),P=[];for(;;){let y=1/0,g=-1,C=-1;for(let I=0;I<u.length;I++)if(!v[I])for(let B=0;B<p.length;B++)S[B]||m[I][B]<y&&(y=m[I][B],g=I,C=B);if(g===-1||C===-1)break;if(u[g].square===p[C].square){v[g]=!0,S[C]=!0;continue}P.push({from:u[g].square,to:p[C].square,piece:u[g].square.piece}),v[g]=!0,S[C]=!0}for(let y=0;y<u.length;y++)v[y]||(setTimeout(()=>{this.pieceService.removePieceFromSquare(u[y].square,!0,l)},h*c),h++);for(let y=0;y<p.length;y++)S[y]||(setTimeout(()=>{const g=this.pieceService.convertPiece(f);this.pieceService.addPieceOnSquare(p[y].square,g,!0,this._createDragFunction.bind(this),l)},h*c),h++);P.forEach(y=>{setTimeout(()=>{this.pieceService.translatePiece(y,!1,!0,this._createDragFunction.bind(this),l)},h*c),h++})})}_analyzePositionChanges(e){const t=new Map,i=new Map;Object.values(e).forEach(h=>{const l=h.piece,f=this.positionService.getGamePieceId(h.id);l&&t.set(h.id,l.getId()),f&&i.set(h.id,f)});const s=[],n=[],r=[],o=[],c=new Set;return t.forEach((h,l)=>{const f=i.get(l);h===f&&(o.push({piece:h,square:l}),c.add(l))}),t.forEach((h,l)=>{if(c.has(l))return;const f=Array.from(i.entries()).find(([u,p])=>p===h&&!c.has(u));if(f){const[u]=f;s.push({piece:h,from:l,to:u,fromSquare:e[l],toSquare:e[u]}),c.add(u)}else n.push({piece:h,square:l,squareObj:e[l]})}),i.forEach((h,l)=>{c.has(l)||r.push({piece:h,square:l,squareObj:e[l]})}),{moves:s,removes:n,adds:r,unchanged:o,totalChanges:s.length+n.length+r.length}}_executeSimultaneousChanges(e,t,i=!1){const{moves:s,removes:n,adds:r}=e;let o=0;const c=s.length+n.length+r.length;if(c===0){this._addListeners();const u=this.positionService.getGame().fen();t!==u&&this.config.onChange(u);return}const h=()=>{if(o++,o===c){this._addListeners();const u=this.positionService.getGame().fen();t!==u&&this.config.onChange(u)}},l=i?0:this.config.simultaneousAnimationDelay;let f=0;s.forEach(u=>{const p=f*l;setTimeout(()=>{this._animatePieceMove(u,h)},p),f++}),n.forEach(u=>{const p=f*l;setTimeout(()=>{this._animatePieceRemoval(u,h)},p),f++}),r.forEach(u=>{const p=f*l;setTimeout(()=>{this._animatePieceAddition(u,h)},p),f++})}_animatePieceMove(e,t){const{fromSquare:i,toSquare:s}=e,n=i.piece;if(!n){console.warn(`No piece found on ${e.from} for move animation`),t();return}this.pieceService.translatePiece({from:i,to:s,piece:n},!1,!0,this._createDragFunction.bind(this),t)}_animatePieceRemoval(e,t){this.pieceService.removePieceFromSquare(e.squareObj,!0,t)}_animatePieceAddition(e,t){const i=this.pieceService.convertPiece(e.piece);this.pieceService.addPieceOnSquare(e.squareObj,i,!0,this._createDragFunction.bind(this),t)}_createDragFunction(e,t){return this.eventService.createDragFunction(e,t,this.config.onDragStart,this.config.onDragMove,this.config.onDrop,this._onSnapback.bind(this),this._onMove.bind(this),this._onRemove.bind(this))}_onSnapback(e,t){this.pieceService.snapbackPiece(e,this.config.snapbackAnimation),this.config.onSnapbackEnd(e,t)}_onRemove(e){this.pieceService.removePieceFromSquare(e,!0),this.positionService.getGame().remove(e.id),this._updateBoardPieces(!0)}_clearVisualState(){this.boardService.applyToAllSquares("deselect"),this.boardService.applyToAllSquares("removeHint"),this.boardService.applyToAllSquares("dehighlight"),this.eventService.setClicked(null)}getPosition(){return this.fen()}setPosition(e,t={}){const i=t.animate!==void 0?t.animate:!0;return this.boardService&&this.boardService.applyToAllSquares&&(this.boardService.applyToAllSquares("removeHint"),this.boardService.applyToAllSquares("deselect"),this.boardService.applyToAllSquares("unmoved")),this.positionService&&this.positionService.setGame&&this.positionService.setGame(e),this._updateBoardPieces&&this._updateBoardPieces(i,!0),!0}reset(e={}){const t=e.animate!==void 0?e.animate:!0,i=this.config&&this.config.position?this.config.position:"start";return this._updateBoardPieces(t),this.setPosition(i,{animate:t})}clear(e={}){const t=e.animate!==void 0?e.animate:!0;return!this.positionService||!this.positionService.getGame()?!1:(this._clearVisualState&&this._clearVisualState(),this.positionService.getGame().clear(),this._updateBoardPieces&&this._updateBoardPieces(t,!0),!0)}undoMove(e={}){const t=this.positionService.getGame().undo();return t?(this._undoneMoves.push(t),this._updateBoardPieces(e.animate!==!1),t):null}redoMove(e={}){if(this._undoneMoves&&this._undoneMoves.length>0){const t=this._undoneMoves.pop(),i={from:t.from,to:t.to};t.promotion&&(i.promotion=t.promotion);const s=this.positionService.getGame().move(i);return this._updateBoardPieces(e.animate!==!1),s}return!1}getLegalMoves(e){return this.legalMoves(e)}getPiece(e){const t=this.boardService.getSquare(e);if(!t)return null;const i=t.piece;return i?(i.color+i.type).toLowerCase():null}putPiece(e,t,i={}){const s=i.animate!==void 0?i.animate:!0;let n=e;if(typeof e=="object"&&e.type&&e.color)n=(e.color+e.type).toLowerCase();else if(typeof e=="string"&&e.length===2){const p=e[0].toLowerCase(),m=e[1].toLowerCase(),v="kqrbnp",S="wb";if(v.includes(p)&&S.includes(m))n=m+p;else if(S.includes(p)&&v.includes(m))n=p+m;else throw new Error(`[putPiece] Invalid piece: ${e}`)}const r=this.validationService.isValidSquare(t),o=this.validationService.isValidPiece(n);if(!r)throw new Error(`[putPiece] Invalid square: ${t}`);if(!o)throw new Error(`[putPiece] Invalid piece: ${n}`);if(!this.positionService||!this.positionService.getGame())throw new Error("[putPiece] No positionService or game");const c=this.pieceService.convertPiece(n),h=this.boardService.getSquare(t);if(!h)throw new Error(`[putPiece] Square not found: ${t}`);h.piece=c;const l={type:c.type,color:c.color};if(!this.positionService.getGame().put(l,t))throw new Error(`[putPiece] Game.put failed for ${n} on ${t}`);return this._updateBoardPieces(s),!0}removePiece(e,t={}){const i=t.animate!==void 0?t.animate:!0;if(!this.validationService.isValidSquare(e))throw new Error(`[removePiece] Invalid square: ${e}`);const s=this.boardService.getSquare(e);return!s||!s.piece||(s.piece=null,this.positionService.getGame().remove(e),this._updateBoardPieces(i)),!0}flipBoard(e={}){this.coordinateService&&this.coordinateService.flipOrientation&&this.coordinateService.flipOrientation(),this._buildBoard&&this._buildBoard(),this._buildSquares&&this._buildSquares(),this._addListeners&&this._addListeners(),this._updateBoardPieces&&this._updateBoardPieces(!1,!0)}setOrientation(e,t={}){return this.validationService.isValidOrientation(e)&&(this.coordinateService.setOrientation(e),this._buildBoard&&this._buildBoard(),this._buildSquares&&this._buildSquares(),this._addListeners&&this._addListeners(),this._updateBoardPieces&&this._updateBoardPieces(t.animate!==!1)),this.coordinateService.getOrientation()}getOrientation(){return this.orientation()}resizeBoard(e){if(e==="auto")return this.config.size="auto",document.documentElement.style.setProperty("--dimBoard","auto"),this._updateBoardPieces(!1),!0;if(typeof e!="number"||e<50||e>3e3)throw new Error(`[resizeBoard] Invalid size: ${e}`);return this.config.size=e,document.documentElement.style.setProperty("--dimBoard",`${e}px`),this._updateBoardPieces(!1),!0}highlight(e){if(!this.validationService.isValidSquare(e))return;const t=this.boardService.getSquare(e);t&&typeof t.highlight=="function"&&t.highlight()}dehighlight(e){if(!this.validationService.isValidSquare(e))return;const t=this.boardService.getSquare(e);t&&typeof t.dehighlight=="function"&&t.dehighlight()}fen(){const e=this.positionService.getGame();return!e||typeof e.fen!="function"?"":e.fen()}turn(){return this.positionService.getGame().turn()}isGameOver(){const e=this.positionService.getGame();return e?e.isGameOver?e.isGameOver():!!(e.isCheckmate&&e.isCheckmate()||e.isDraw&&e.isDraw()):!1}isCheckmate(){const e=this.positionService.getGame();return e&&e.isCheckmate?e.isCheckmate():!1}isDraw(){const e=this.positionService.getGame();return e&&e.isDraw?e.isDraw():!1}getHistory(){const e=this.positionService.getGame();return e?e.history?e.history():[]:[]}destroyBoard(){this.eventService&&typeof this.eventService.removeListeners=="function"&&this.eventService.removeListeners(),this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null);const e=document.getElementById(this.config.id_div);e&&(e.innerHTML=""),this.boardService&&this.boardService.squares&&Object.values(this.boardService.squares).forEach(t=>{t&&t.forceRemoveAllPieces&&t.forceRemoveAllPieces()}),this.boardService&&(this.boardService.removeSquares&&this.boardService.removeSquares(),this.boardService.removeBoard&&this.boardService.removeBoard()),this.modeManager&&(this.modeManager.destroy(),this.modeManager=null),this.validationService=null,this.coordinateService=null,this.positionService=null,this.boardService=null,this.pieceService=null,this.animationService=null,this.moveService=null,this.eventService=null,this._performanceMonitor=null,this._undoneMoves=null,this._boundUpdateBoardPieces=null,this._boundOnSquareClick=null,this._boundOnPieceHover=null,this._boundOnPieceLeave=null}rebuild(){this._initialize()}getConfig(){return this.config}updateConfig(e){this.config&&typeof this.config.update=="function"&&this.config.update(e),e.size!==void 0&&this.resizeBoard(e.size),e.orientation!==void 0&&this.setOrientation(e.orientation)}movePiece(e,t={}){const i=t.animate!==void 0?t.animate:!0;if(typeof e!="string"||e.length<4)return console.error("[movePiece] Invalid move format:",e),!1;const s=e.substring(0,2),n=e.substring(2,4),r=e.length>4?e[4].toLowerCase():null,o=this.boardService.getSquare(s),c=this.boardService.getSquare(n);return!o||!c?(console.error("[movePiece] Invalid squares:",s,n),!1):(this._undoneMoves=[],this._onMove(o,c,r,i))}forceSync(){this._updateBoardPieces(!1)}setMode(e,t={}){return this.modeManager.setMode(e,t)}getMode(){return this.modeManager.getCurrentMode()}getCurrentMode(){return this.getMode()}getModeName(){return this.modeManager.getCurrentModeName()}getAvailableModes(){return this.modeManager.getAvailableModes()}stopMode(){this.modeManager.stop()}isModeActive(e){return this.modeManager.isModeActive(e)}startCreativeMode(e={}){return this.setMode("creative",e)}startPvPMode(e={}){return this.setMode("pvp",e)}startVsBotMode(e={}){return this.setMode("vsBot",e)}getModeStats(){return this.modeManager.getStats()}move(e,t=!0){return this.movePiece(e,{animate:t})}clearBoard(e=!0){return this._updateBoardPieces(e),this.clear({animate:e})}start(e=!0){return this._updateBoardPieces(e),this.reset({animate:e})}flip(e={}){return this._updateBoardPieces(e.animate!==!1),this.flipBoard(e)}getOrSetPosition(e,t=!0){if(e===void 0)return this.positionService.getPosition();this.load(e,{},t)}undo(e=!0){const t=this.positionService.getGame().undo();return t?(this._undoneMoves.push(t),this._updateBoardPieces(e),t):null}redo(e=!0){if(this._undoneMoves&&this._undoneMoves.length>0){const t=this._undoneMoves.pop(),i={from:t.from,to:t.to};t.promotion&&(i.promotion=t.promotion);const s=this.positionService.getGame().move(i);return this._updateBoardPieces(e),s}return!1}history(){return this.positionService.getGame().history()}game(){return this.positionService.getGame()}orientation(e){return e===void 0?this.coordinateService.getOrientation():(this.validationService.isValidOrientation(e)&&(this.coordinateService.setOrientation(e),this.flip()),this.coordinateService.getOrientation())}size(e){return e===void 0?this.config.size:(this.validationService.isValidSize(e)&&(this.config.size=e,this.resize(e)),this.config.size)}legalMoves(e){const t=this.boardService.getSquare(e);return t?this.moveService.getCachedLegalMoves(t):[]}isLegal(e){const t=typeof e=="string"?this.moveService.parseMove(e):e;if(!t)return!1;const i=this.boardService.getSquare(t.from),s=this.boardService.getSquare(t.to);return!i||!s?!1:new W(i,s,t.promotion).isLegal(this.positionService.getGame())}inCheck(){return this.positionService.getGame().inCheck()}inCheckmate(){return this.positionService.getGame().isCheckmate()}inStalemate(){return this.positionService.getGame().isStalemate()}inDraw(){return this.positionService.getGame().isDraw()}inThreefoldRepetition(){return this.positionService.getGame().isThreefoldRepetition()}pgn(){return this.positionService.getGame().pgn()}loadPgn(e,t=!0){try{const i=this.positionService.getGame().loadPgn(e);return i&&this._updateBoardPieces(t,!0),i}catch(i){return console.error("Error loading PGN:",i),!1}}getConfigOptions(){return this.config&&typeof this.config.getConfig=="function"?this.config.getConfig():this.config}setConfigOptions(e){this.updateConfig(e)}animationStyle(e){return e===void 0?this.config.animationStyle:(this.validationService.isValidAnimationStyle(e)&&(this.config.animationStyle=e),this.config.animationStyle)}simultaneousAnimationDelay(e){return e===void 0?this.config.simultaneousAnimationDelay:(typeof e=="number"&&e>=0&&(this.config.simultaneousAnimationDelay=e),this.config.simultaneousAnimationDelay)}insert(e,t){return this.putPiece(t,e)}get(e){return this.getPiece(e)}position(e,t){return e===void 0?this.positionService.getPosition():(typeof t=="string"&&(t==="w"||t==="b")&&this.setOrientation(t),this.setPosition(e,{animate:t!==!1}))}destroy(){return this.destroyBoard()}build(){return this._initialize()}resize(e){return this.resizeBoard(e)}piece(e){return this.getPiece(e)}ascii(){return this.positionService.getGame().ascii()}board(){return this.positionService.getGame().board()}getCastlingRights(e){return this.positionService.getGame().getCastlingRights(e)}getComment(){return this.positionService.getGame().getComment()}getComments(){return this.positionService.getGame().getComments()}lastMove(){return this.positionService.getGame().lastMove()}moveNumber(){return this.positionService.getGame().moveNumber()}moves(e={}){return this.positionService.getGame().moves(e)}squareColor(e){return this.boardService.getSquare(e).isWhite()?"light":"dark"}isDrawByFiftyMoves(){return this.positionService.getGame().isDrawByFiftyMoves()}isInsufficientMaterial(){return this.positionService.getGame().isInsufficientMaterial()}isStalemate(){return this.positionService.getGame().isStalemate()}isThreefoldRepetition(){return this.positionService.getGame().isThreefoldRepetition()}load(e,t={},i=!0){return this.setPosition(e,{...t,animate:i})}put(e,t,i=!0){let s=null;function n(o){if(typeof o!="string"||o.length!==2)return null;const c=o[0].toLowerCase(),h=o[1].toLowerCase(),l="kqrbnp",f="wb";return l.includes(c)&&f.includes(h)?{type:c,color:h}:f.includes(c)&&l.includes(h)?{type:h,color:c}:null}if(typeof e=="string"){if(s=n(e),!s)return console.error(`[put] Invalid piece string: '${e}'. Use e.g. 'wQ', 'Qw', 'bK', 'kb'`),!1}else if(typeof e=="object"&&e.type&&e.color){const o=String(e.type).toLowerCase(),c=String(e.color).toLowerCase();if("kqrbnp".includes(o)&&"wb".includes(c))s={type:o,color:c};else return console.error(`[put] Invalid piece object: {type: '${e.type}', color: '${e.color}'}`),!1}else return console.error("[put] Invalid pieceId:",e),!1;return typeof t!="string"||t.length!==2?(console.error("[put] Invalid squareId:",t),!1):this.putPiece(s,t,{animate:i})}remove(e,t=!0){return this.removePiece(e,{animate:t})}removeComment(){return this.positionService.getGame().removeComment()}removeComments(){return this.positionService.getGame().removeComments()}removeHeader(e){return this.positionService.getGame().removeHeader(e)}setCastlingRights(e,t){return this.positionService.getGame().setCastlingRights(e,t)}setComment(e){return this.positionService.getGame().setComment(e)}setHeader(e,t){return this.positionService.getGame().setHeader(e,t)}validateFen(e){return this.positionService.getGame().validateFen(e)}highlightSquare(e){return this.highlight(e)}dehighlightSquare(e){return this.dehighlight(e)}};const ie=Object.freeze({DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4}),ri=Object.freeze({level:ie.INFO,enableColors:!0,enableTimestamp:!0,enableStackTrace:!0,maxLogSize:1e3,enableConsole:!0,enableStorage:!1,storageKey:"chessboard-logs"}),bt=Object.freeze({DEBUG:"\x1B[36m",INFO:"\x1B[32m",WARN:"\x1B[33m",ERROR:"\x1B[31m",RESET:"\x1B[0m"});class pe{constructor(e={},t="Chessboard"){this.config={...ri,...e},this.name=t,this.logs=[],this.startTime=Date.now(),this.debug=this._createLogMethod("DEBUG"),this.info=this._createLogMethod("INFO"),this.warn=this._createLogMethod("WARN"),this.error=this._createLogMethod("ERROR"),this.performances=new Map,this.config.enableStorage&&this._initStorage()}_createLogMethod(e){return(t,i={},s=null)=>{this._log(e,t,i,s)}}_log(e,t,i,s){if(ie[e]<this.config.level)return;const r=this._createLogEntry(e,t,i,s);this._storeLogEntry(r),this.config.enableConsole&&this._outputToConsole(r),this.config.enableStorage&&this._storeInStorage(r)}_createLogEntry(e,t,i,s){const n={timestamp:new Date().toISOString(),level:e,logger:this.name,message:t,data:{...i},runtime:Date.now()-this.startTime};return s&&(n.error={name:s.name,message:s.message,stack:this.config.enableStackTrace?s.stack:null}),typeof performance<"u"&&performance.memory&&(n.memory={used:Math.round(performance.memory.usedJSHeapSize/1024/1024),total:Math.round(performance.memory.totalJSHeapSize/1024/1024)}),n}_storeLogEntry(e){this.logs.push(e),this.logs.length>this.config.maxLogSize&&this.logs.shift()}_outputToConsole(e){const t=this.config.enableColors?bt[e.level]:"",i=this.config.enableColors?bt.RESET:"",s=this.config.enableTimestamp?`[${new Date(e.timestamp).toLocaleTimeString()}] `:"",r=`${`${t}${s}[${e.logger}:${e.level}]${i}`} ${e.message}`,o=this._getConsoleMethod(e.level);Object.keys(e.data).length>0||e.error?o(r,{data:e.data,error:e.error,runtime:`${e.runtime}ms`}):o(r)}_getConsoleMethod(e){switch(e){case"DEBUG":return console.debug||console.log;case"INFO":return console.info||console.log;case"WARN":return console.warn||console.log;case"ERROR":return console.error||console.log;default:return console.log}}_initStorage(){if(typeof localStorage>"u"){this.config.enableStorage=!1;return}try{localStorage.setItem("test","test"),localStorage.removeItem("test")}catch{this.config.enableStorage=!1,console.warn("localStorage not available, disabling log storage")}}_storeInStorage(e){if(this.config.enableStorage)try{const t=JSON.parse(localStorage.getItem(this.config.storageKey)||"[]");t.push(e),t.length>this.config.maxLogSize&&t.shift(),localStorage.setItem(this.config.storageKey,JSON.stringify(t))}catch(t){console.warn("Failed to store log entry:",t)}}startPerformance(e){this.performances.set(e,{start:performance.now(),measurements:[]}),this.debug(`Started performance measurement: ${e}`)}endPerformance(e){const t=this.performances.get(e);if(!t)return this.warn(`Performance measurement not found: ${e}`),0;const i=performance.now()-t.start;return t.measurements.push(i),this.debug(`Performance measurement completed: ${e}`,{duration:`${i.toFixed(2)}ms`,measurements:t.measurements.length}),i}getPerformanceStats(e){const t=this.performances.get(e);if(!t||t.measurements.length===0)return null;const i=t.measurements,s=i.reduce((c,h)=>c+h,0),n=s/i.length,r=Math.min(...i),o=Math.max(...i);return{name:e,count:i.length,total:s.toFixed(2),average:n.toFixed(2),min:r.toFixed(2),max:o.toFixed(2)}}child(e){return new pe(this.config,`${this.name}:${e}`)}setLevel(e){ie[e]!==void 0&&(this.config.level=ie[e])}getLevel(){return Object.keys(ie).find(e=>ie[e]===this.config.level)}getLogs(){return[...this.logs]}clearLogs(){if(this.logs=[],this.config.enableStorage)try{localStorage.removeItem(this.config.storageKey)}catch(e){console.warn("Failed to clear stored logs:",e)}}exportLogs(){return JSON.stringify(this.logs,null,2)}destroy(){this.clearLogs(),this.performances.clear()}}const De=new pe;function oi(a,e){return new pe(a,e)}class Je{constructor(){this.instances=new Map,this.validationService=new we,this.performanceMonitor=new Ye,this.logger=De.child("ChessboardFactory"),this.templates=new Map,this._initializeDefaultTemplates()}_initializeDefaultTemplates(){this.templates.set("basic",{size:400,draggable:!0,hints:!0,clickable:!0,moveHighlight:!0,animationStyle:"simultaneous"}),this.templates.set("tournament",{size:500,draggable:!1,hints:!1,clickable:!0,moveHighlight:!0,onlyLegalMoves:!0,animationStyle:"sequential"}),this.templates.set("analysis",{size:600,draggable:!0,hints:!0,clickable:!0,moveHighlight:!0,mode:"analysis",animationStyle:"simultaneous"}),this.templates.set("puzzle",{size:450,draggable:!0,hints:!0,clickable:!0,moveHighlight:!0,onlyLegalMoves:!0,animationStyle:"sequential"}),this.templates.set("demo",{size:"auto",draggable:!1,hints:!1,clickable:!1,moveHighlight:!0,animationStyle:"simultaneous"})}create(e,t={},i=null){this.performanceMonitor.startMeasure("chessboard-creation");try{if(!e||typeof e!="string")throw new O("Container ID must be a non-empty string","containerId",e);const s=document.getElementById(e);if(!s)throw new O(`Container element not found: ${e}`,"containerId",e);let n={...t};if(i){const o=this.templates.get(i);o?(n={...o,...t},this.logger.info(`Using template "${i}" for chessboard creation`)):this.logger.warn(`Template "${i}" not found, using default configuration`)}n.id=e,this.validationService.validateConfig(n);const r=new Oe(n);return this.instances.set(e,{instance:r,config:n,template:i,createdAt:new Date,container:s}),this.performanceMonitor.endMeasure("chessboard-creation"),this.logger.info(`Created chessboard instance for container: ${e}`,{template:i,configKeys:Object.keys(n)}),r}catch(s){throw this.performanceMonitor.endMeasure("chessboard-creation"),this.logger.error("Failed to create chessboard instance",{containerId:e,error:s}),s}}createFromTemplate(e,t,i={}){return this.create(e,i,t)}getInstance(e){const t=this.instances.get(e);return t?t.instance:null}getInstanceInfo(e){const t=this.instances.get(e);return t?{containerId:e,template:t.template,createdAt:t.createdAt,config:{...t.config}}:null}destroy(e){const t=this.instances.get(e);if(!t)return this.logger.warn(`Instance not found for destruction: ${e}`),!1;try{return t.instance.destroy(),this.instances.delete(e),this.logger.info(`Destroyed chessboard instance: ${e}`),!0}catch(i){return this.logger.error(`Failed to destroy chessboard instance: ${e}`,{error:i}),!1}}destroyAll(){const e=Array.from(this.instances.keys());let t=0;for(const i of e)this.destroy(i)&&t++;this.logger.info(`Destroyed ${t} chessboard instances`)}listInstances(){return Array.from(this.instances.keys()).map(e=>this.getInstanceInfo(e))}registerTemplate(e,t){if(!e||typeof e!="string")throw new O("Template name must be a non-empty string","name",e);if(!t||typeof t!="object")throw new O("Template configuration must be an object","config",t);this.validationService.validateConfig(t),this.templates.set(e,{...t}),this.logger.info(`Registered template: ${e}`,{configKeys:Object.keys(t)})}removeTemplate(e){const t=this.templates.delete(e);return t&&this.logger.info(`Removed template: ${e}`),t}getTemplate(e){const t=this.templates.get(e);return t?{...t}:null}listTemplates(){return Array.from(this.templates.keys())}createMultiple(e){const t=[],i=[];for(const s of e)try{const{containerId:n,template:r,...o}=s,c=this.create(n,o,r);t.push({containerId:n,instance:c,success:!0})}catch(n){i.push({containerId:s.containerId,error:n,success:!1}),this.logger.error(`Failed to create instance for ${s.containerId}`,{error:n})}return i.length>0&&this.logger.warn(`Failed to create ${i.length} out of ${e.length} instances`),{instances:t,errors:i}}getStats(){return{activeInstances:this.instances.size,availableTemplates:this.templates.size,performance:this.performanceMonitor.getMetrics(),validation:this.validationService.getCacheStats()}}cleanup(){this.destroyAll(),this.validationService.destroy(),this.performanceMonitor.destroy(),this.templates.clear()}}const N=new Je;function St(a,e={},t=null){return N.create(a,e,t)}function yt(a,e,t={}){return N.createFromTemplate(a,e,t)}function A(a,e={}){const t=De.child("ChessboardFactory");try{if(typeof a=="object"&&a!==null)return t.debug("Creating chessboard with config object"),new Oe(a);if(typeof a=="string"){t.debug("Creating chessboard with element ID",{elementId:a});const i={...e,id:a};return new Oe(i)}throw new Error("Invalid parameters: first parameter must be string or object")}catch(i){throw t.error("Failed to create chessboard instance",{error:i}),i}}class wt extends Oe{constructor(e,t={}){const i=De.child("ChessboardWrapper");try{if(typeof e=="object"&&e!==null)i.debug("Initializing with config object"),super(e);else if(typeof e=="string"){i.debug("Initializing with element ID",{elementId:e});const s={...t,id:e};super(s)}else throw new Error("Invalid constructor parameters")}catch(s){throw i.error("Failed to initialize ChessboardWrapper",{error:s}),s}}}A.create=St,A.fromTemplate=yt,A.factory=N,A.getInstance=a=>N.getInstance(a),A.destroyInstance=a=>N.destroy(a),A.destroyAll=()=>N.destroyAll(),A.listInstances=()=>N.listInstances(),A.registerTemplate=(a,e)=>N.registerTemplate(a,e),A.removeTemplate=a=>N.removeTemplate(a),A.getTemplate=a=>N.getTemplate(a),A.listTemplates=()=>N.listTemplates(),A.getStats=()=>N.getStats(),A.Class=wt,A.Chessboard=wt,A.Config=Ve,A.Factory=Je;function Et(a){const e=a.charCodeAt(0)-97;return{row:7-(parseInt(a[1])-1),col:e}}function ai(a,e){const t=String.fromCharCode(97+e),i=(8-a).toString();return t+i}function ci(a){const{row:e,col:t}=Et(a);return(e+t)%2===0?"dark":"light"}function hi(a,e){return a>=0&&a<=7&&e>=0&&e<=7}function Pt(a){if(typeof a!="string"||a.length!==2)return!1;const e=a[0],t=a[1];return e>="a"&&e<="h"&&t>="1"&&t<="8"}const Ze=Pt,V=new Map,Ct=1e3;function z(a,e){if(V.size>=Ct){const t=V.keys().next().value;V.delete(t)}V.set(a,e)}function Xe(a){if(typeof a!="string"||a.length!==2)return!1;const e=`piece:${a}`;if(V.has(e))return V.get(e);const t=a[0],i=a[1],s=["w","b"].includes(t)&&["P","R","N","B","Q","K"].includes(i);return z(e,s),s}function et(a){if(typeof a!="object"||a===null)return!1;try{JSON.stringify(a)}catch{return!1}for(const[e,t]of Object.entries(a))if(!Ze(e)||!Xe(t))return!1;return li(a)}function li(a){const e=Object.values(a),t=e.filter(r=>r==="wK").length,i=e.filter(r=>r==="bK").length;if(t!==1||i!==1)return!1;const s=e.filter(r=>r==="wP").length,n=e.filter(r=>r==="bP").length;if(s>8||n>8)return!1;for(const[r,o]of Object.entries(a))if(o==="wP"||o==="bP"){const c=r[1];if(c==="1"||c==="8")return!1}return!0}function Mt(a){if(typeof a!="string")return{success:!1,error:"FEN must be a string"};const e=`fen:${a}`;if(V.has(e))return V.get(e);const t=a.trim().split(" ");if(t.length!==6){const o={success:!1,error:"FEN must have 6 parts separated by spaces"};return z(e,o),o}const i=t[0].split("/");if(i.length!==8){const o={success:!1,error:"Piece placement must have 8 ranks"};return z(e,o),o}for(let o=0;o<i.length;o++){const c=ui(i[o]);if(!c.success){const h={success:!1,error:`Invalid rank ${o+1}: ${c.error}`};return z(e,h),h}}if(!["w","b"].includes(t[1])){const o={success:!1,error:'Active color must be "w" or "b"'};return z(e,o),o}if(!/^[KQkq-]*$/.test(t[2])){const o={success:!1,error:"Invalid castling availability"};return z(e,o),o}if(t[3]!=="-"&&!Ze(t[3])){const o={success:!1,error:"Invalid en passant target square"};return z(e,o),o}const s=parseInt(t[4],10);if(isNaN(s)||s<0){const o={success:!1,error:"Invalid halfmove clock"};return z(e,o),o}const n=parseInt(t[5],10);if(isNaN(n)||n<1){const o={success:!1,error:"Invalid fullmove number"};return z(e,o),o}const r={success:!0};return z(e,r),r}function ui(a){if(typeof a!="string")return{success:!1,error:"Rank must be a string"};let e=0;for(let t=0;t<a.length;t++){const i=a[t];if(/[1-8]/.test(i))e+=parseInt(i,10);else if(/[prnbqkPRNBQK]/.test(i))e+=1;else return{success:!1,error:`Invalid character "${i}" in rank`}}return e!==8?{success:!1,error:`Rank must represent exactly 8 squares, got ${e}`}:{success:!0}}function kt(a){if(typeof a!="string")return{success:!1,error:"Move must be a string"};const e=a.trim();return e.length===0?{success:!1,error:"Move cannot be empty"}:e==="O-O"||e==="O-O-O"?{success:!0,type:"castling"}:/^[a-h][1-8][a-h][1-8][qrnbQRNB]?$/.test(e)?{success:!0,type:"coordinate"}:/^[PRNBQK]?[a-h]?[1-8]?x?[a-h][1-8](\+|#)?$/.test(e)?{success:!0,type:"algebraic"}:{success:!1,error:"Invalid move format"}}function Tt(a){const e=[];if(!a||typeof a!="object")return{success:!1,errors:["Configuration must be an object"]};!a.id&&!a.id_div&&e.push('Configuration must include "id" or "id_div"'),a.orientation&&!["white","black","w","b"].includes(a.orientation)&&e.push('Invalid orientation. Must be "white", "black", "w", or "b"'),a.position&&a.position!=="start"&&typeof a.position!="object"&&e.push('Invalid position. Must be "start" or a position object'),a.position&&typeof a.position=="object"&&!et(a.position)&&e.push("Invalid position object format"),a.size&&!di(a.size)&&e.push('Invalid size. Must be "auto", a positive number, or a valid CSS size'),a.movableColors&&!["white","black","w","b","both","none"].includes(a.movableColors)&&e.push('Invalid movableColors. Must be "white", "black", "w", "b", "both", or "none"'),a.dropOffBoard&&!["snapback","trash"].includes(a.dropOffBoard)&&e.push('Invalid dropOffBoard. Must be "snapback" or "trash"');const t=["onMove","onMoveEnd","onChange","onDragStart","onDragMove","onDrop","onSnapbackEnd"];for(const s of t)a[s]&&typeof a[s]!="function"&&e.push(`Invalid ${s}. Must be a function`);const i=["whiteSquare","blackSquare","highlight","hintColor"];for(const s of i)a[s]&&!fi(a[s])&&e.push(`Invalid ${s}. Must be a valid CSS color`);return a.moveAnimation&&!mi(a.moveAnimation)&&e.push("Invalid moveAnimation. Must be a valid easing function"),a.animationStyle&&!["sequential","simultaneous"].includes(a.animationStyle)&&e.push('Invalid animationStyle. Must be "sequential" or "simultaneous"'),{success:e.length===0,errors:e}}function di(a){return a==="auto"?!0:typeof a=="number"?a>0&&a<=5e3:typeof a=="string"?/^\d+(px|em|rem|%|vh|vw)$/.test(a):!1}function fi(a){return typeof a!="string"?!1:/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(a)||/^rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*(,\s*[0-1](\.\d+)?)?\s*\)$/.test(a)||/^hsla?\(\s*\d+\s*,\s*\d+%\s*,\s*\d+%\s*(,\s*[0-1](\.\d+)?)?\s*\)$/.test(a)?!0:["white","black","red","green","blue","yellow","cyan","magenta","transparent","gray","grey","brown","orange","purple","pink"].includes(a.toLowerCase())}function mi(a){return["linear","ease","ease-in","ease-out","ease-in-out","cubic-bezier"].includes(a)||/^cubic-bezier\(\s*[\d.-]+\s*,\s*[\d.-]+\s*,\s*[\d.-]+\s*,\s*[\d.-]+\s*\)$/.test(a)}function gi(a){return a.map(e=>{const{type:t,value:i}=e;switch(t){case"piece":return{...e,valid:Xe(i)};case"square":return{...e,valid:Ze(i)};case"position":return{...e,valid:et(i)};case"fen":{const s=Mt(i);return{...e,valid:s.success,error:s.error}}case"move":{const s=kt(i);return{...e,valid:s.success,error:s.error}}case"config":{const s=Tt(i);return{...e,valid:s.success,errors:s.errors}}default:return{...e,valid:!1,error:"Unknown validation type"}}})}function pi(){V.clear()}function vi(){return{size:V.size,maxSize:Ct}}function _i(a){if(typeof a=="number")return a;switch(a){case"fast":return 150;case"slow":return 500;default:return 200}}function bi(a){return["ease","ease-in","ease-out","ease-in-out","linear"].includes(a)?a:"ease"}function Si(a){return new Promise(e=>setTimeout(e,a))}class re{constructor(e={}){if(new.target===re)throw new Error("BaseEngine is abstract and cannot be instantiated directly");this.config={depth:20,moveTime:1e3,threads:1,hashSize:16,useNNUE:!0,...e},this.isReady=!1,this.isSearching=!1,this.info=null,this.listeners=new Map,this.currentAnalysis=null}async init(){throw new Error("init() must be implemented by subclass")}async quit(){throw new Error("quit() must be implemented by subclass")}ready(){return this.isReady}async setPosition(e="startpos",t=[]){throw new Error("setPosition() must be implemented by subclass")}async go(e={}){throw new Error("go() must be implemented by subclass")}async stop(){throw new Error("stop() must be implemented by subclass")}async setOption(e,t){throw new Error("setOption() must be implemented by subclass")}getInfo(){return this.info}async getBestMove(e,t={}){return await this.setPosition(e),(await this.go({depth:t.depth||this.config.depth,moveTime:t.moveTime||this.config.moveTime,...t})).bestMove}async analyze(e,t={}){return await this.setPosition(e),this.go({depth:t.depth||this.config.depth,...t})}async startInfiniteAnalysis(e){await this.setPosition(e),this.go({infinite:!0})}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){if(!this.listeners.has(e))return;const i=this.listeners.get(e),s=i.indexOf(t);s>-1&&i.splice(s,1)}_emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(i=>{try{i(t)}catch(s){console.error(`Error in engine event listener for ${e}:`,s)}})}_parseInfo(e){const t={},i=e.split(" ");let s=0;for(;s<i.length;){switch(i[s]){case"depth":t.depth=parseInt(i[++s],10);break;case"seldepth":t.seldepth=parseInt(i[++s],10);break;case"multipv":t.multipv=parseInt(i[++s],10);break;case"score":i[s+1]==="cp"?(t.score=parseInt(i[s+2],10),t.isMate=!1,s+=2):i[s+1]==="mate"&&(t.score=parseInt(i[s+2],10),t.isMate=!0,s+=2);break;case"nodes":t.nodes=parseInt(i[++s],10);break;case"nps":t.nps=parseInt(i[++s],10);break;case"time":t.time=parseInt(i[++s],10);break;case"pv":t.pv=i.slice(s+1),s=i.length;break;case"hashfull":t.hashfull=parseInt(i[++s],10);break;case"tbhits":t.tbhits=parseInt(i[++s],10);break;case"currmove":t.currmove=i[++s];break;case"currmovenumber":t.currmovenumber=parseInt(i[++s],10);break}s++}return t}_parseBestMove(e){const t=e.split(" "),i={bestMove:t[1]||null,ponder:null},s=t.indexOf("ponder");return s!==-1&&t[s+1]&&(i.ponder=t[s+1]),i}parseUCIMove(e){return!e||e.length<4?null:{from:e.slice(0,2),to:e.slice(2,4),promotion:e.length>4?e[4]:null}}}const ae=class ae extends re{constructor(e={}){super({threads:1,hashSize:16,useNNUE:!0,...e}),this.worker=null,this.messageQueue=[],this.pendingCommand=null,this.wasmPath=e.wasmPath||null,this.nnuePath=e.nnuePath||null}static supportsThreads(){try{return typeof SharedArrayBuffer<"u"}catch{return!1}}static supportsWasm(){try{return typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function"}catch{return!1}}async init(){if(this.isReady)return!0;if(!ae.supportsWasm())throw new Error("WebAssembly is not supported in this environment");try{const e=this.wasmPath||ae.CDN_URLS.stockfish16;return this.worker=new Worker(e),this.worker.onmessage=t=>this._handleMessage(t.data),this.worker.onerror=t=>this._handleError(t),await this._sendAndWait("uci","uciok"),await this._configureEngine(),await this._sendAndWait("isready","readyok"),this.isReady=!0,this._emit("ready",this.info),!0}catch(e){throw this._emit("error",e),e}}async initFromInstance(e){if(this.isReady)return!0;try{if(e instanceof Worker)this.worker=e,this.worker.onmessage=t=>this._handleMessage(t.data),this.worker.onerror=t=>this._handleError(t);else if(typeof e.postMessage=="function")this.worker=e,typeof e.addMessageListener=="function"&&e.addMessageListener(t=>this._handleMessage(t));else throw new Error("Invalid Stockfish instance");return await this._sendAndWait("uci","uciok"),await this._configureEngine(),await this._sendAndWait("isready","readyok"),this.isReady=!0,this._emit("ready",this.info),!0}catch(t){throw this._emit("error",t),t}}async _configureEngine(){ae.supportsThreads()&&this.config.threads>1&&await this._send(`setoption name Threads value ${this.config.threads}`),await this._send(`setoption name Hash value ${this.config.hashSize}`),this.config.useNNUE&&(await this._send("setoption name Use NNUE value true"),this.nnuePath&&await this._send(`setoption name EvalFile value ${this.nnuePath}`))}async quit(){if(this.worker){try{this._send("quit"),this.worker.terminate()}catch{}this.worker=null,this.isReady=!1,this.isSearching=!1,this._emit("quit")}}async setPosition(e="startpos",t=[]){if(!this.isReady)throw new Error("Engine not ready");let i;e==="startpos"?i="position startpos":i=`position fen ${e}`,t.length>0&&(i+=` moves ${t.join(" ")}`),await this._send(i)}async go(e={}){if(!this.isReady)throw new Error("Engine not ready");this.isSearching&&await this.stop(),this.isSearching=!0,this.currentAnalysis={bestMove:null,ponder:null,score:0,isMate:!1,depth:0,nodes:0,time:0,pv:[],nps:0};let t="go";return e.infinite?t+=" infinite":(e.depth&&(t+=` depth ${e.depth}`),e.moveTime&&(t+=` movetime ${e.moveTime}`),e.wtime&&(t+=` wtime ${e.wtime}`),e.btime&&(t+=` btime ${e.btime}`),e.winc&&(t+=` winc ${e.winc}`),e.binc&&(t+=` binc ${e.binc}`),e.movestogo&&(t+=` movestogo ${e.movestogo}`),e.nodes&&(t+=` nodes ${e.nodes}`),e.mate&&(t+=` mate ${e.mate}`)),e.infinite?(this._send(t),this.currentAnalysis):new Promise((i,s)=>{const n=setTimeout(()=>{this.isSearching=!1,s(new Error("Search timeout"))},(e.moveTime||this.config.moveTime)+3e4),r=o=>{o.bestMove&&(clearTimeout(n),this.off("bestmove",r),this.isSearching=!1,i({...this.currentAnalysis,...o}))};this.on("bestmove",r),this._send(t)})}async stop(){if(this.isSearching)return new Promise(e=>{const t=()=>{this.off("bestmove",t),this.isSearching=!1,e()},i=setTimeout(()=>{this.off("bestmove",t),this.isSearching=!1,e()},1e3);this.on("bestmove",()=>{clearTimeout(i),t()}),this._send("stop")})}async setOption(e,t){if(!this.isReady)throw new Error("Engine not ready");await this._send(`setoption name ${e} value ${t}`),await this._sendAndWait("isready","readyok")}async eval(){if(!this.isReady)throw new Error("Engine not ready");return new Promise(e=>{let t="";const i=s=>{typeof s=="string"&&(t+=`${s}
`)};this.on("message",i),setTimeout(()=>{this.off("message",i),e(this._parseEval(t))},100),this._send("eval")})}_send(e){this.worker&&(this._emit("command",e),this.worker.postMessage(e))}_sendAndWait(e,t){return new Promise((i,s)=>{const n=setTimeout(()=>{s(new Error(`Timeout waiting for ${t}`))},1e4),r=o=>{typeof o=="string"&&o.includes(t)&&(clearTimeout(n),this.off("message",r),i())};this.on("message",r),this._send(e)})}_handleMessage(e){if(typeof e=="string")if(this._emit("message",e),e.startsWith("id "))this._parseId(e);else if(e.startsWith("info ")){const t=this._parseInfo(e.slice(5));this._updateAnalysis(t),this._emit("info",t)}else if(e.startsWith("bestmove ")){const t=this._parseBestMove(e);this._emit("bestmove",t)}else e.startsWith("option ")&&this._parseOption(e)}_handleError(e){this._emit("error",e)}_parseId(e){if(this.info||(this.info={name:"",author:"",version:"",options:[]}),e.startsWith("id name ")){this.info.name=e.slice(8);const t=this.info.name.match(/(\d+(?:\.\d+)*)/);t&&(this.info.version=t[1])}else e.startsWith("id author ")&&(this.info.author=e.slice(10))}_parseOption(e){this.info||(this.info={name:"",author:"",version:"",options:[]});const t=e.match(/option name ([^ ]+)/);t&&this.info.options.push(t[1])}_updateAnalysis(e){this.currentAnalysis&&(e.depth!==void 0&&(this.currentAnalysis.depth=e.depth),e.score!==void 0&&(this.currentAnalysis.score=e.score,this.currentAnalysis.isMate=e.isMate||!1),e.nodes!==void 0&&(this.currentAnalysis.nodes=e.nodes),e.time!==void 0&&(this.currentAnalysis.time=e.time),e.nps!==void 0&&(this.currentAnalysis.nps=e.nps),e.pv!==void 0&&(this.currentAnalysis.pv=e.pv))}_parseEval(e){const t=e.split(`
`),i={raw:e};for(const s of t)if(s.includes("Final evaluation")){const n=s.match(/([-+]?\d+\.?\d*)/);n&&(i.evaluation=parseFloat(n[1]))}return i}getCurrentAnalysis(){return this.currentAnalysis}async newGame(){if(!this.isReady)throw new Error("Engine not ready");await this._send("ucinewgame"),await this._sendAndWait("isready","readyok")}};w(ae,"CDN_URLS",{stockfish16:"https://cdn.jsdelivr.net/npm/stockfish.js@16/stockfish.js",stockfish15:"https://cdn.jsdelivr.net/npm/stockfish.js@15/stockfish.js",stockfish14:"https://cdn.jsdelivr.net/npm/stockfish@14/stockfish.js",unpkg:"https://unpkg.com/stockfish.js/stockfish.js"});let qe=ae;class At extends re{constructor(e){if(!e.url&&e.transport!=="custom")throw new Error("URL is required for UCI engine connection");super(e),this.transport=e.transport||"websocket",this.url=e.url,this.customSend=e.customSend,this.customReceive=e.customReceive,this.reconnectAttempts=e.reconnectAttempts||3,this.reconnectDelay=e.reconnectDelay||1e3,this.connection=null,this.messageBuffer="",this.pendingPromises=[]}async init(){if(this.isReady)return!0;try{return await this._connect(),await this._sendAndWait("uci","uciok"),await this._configureEngine(),await this._sendAndWait("isready","readyok"),this.isReady=!0,this._emit("ready",this.info),!0}catch(e){throw this._emit("error",e),e}}async _connect(){switch(this.transport){case"websocket":await this._connectWebSocket();break;case"http":this.connection={type:"http"};break;case"custom":this.customReceive&&this.customReceive(e=>this._handleMessage(e)),this.connection={type:"custom"};break;default:throw new Error(`Unknown transport: ${this.transport}`)}}_connectWebSocket(){return new Promise((e,t)=>{let i=0;const s=()=>{try{this.connection=new WebSocket(this.url),this.connection.onopen=()=>{this._emit("connected"),e()},this.connection.onmessage=n=>{this._handleMessage(n.data)},this.connection.onerror=n=>{this._emit("error",n)},this.connection.onclose=()=>{this._emit("disconnected"),this.isReady=!1,i<this.reconnectAttempts&&(i++,setTimeout(s,this.reconnectDelay*i))}}catch(n){i<this.reconnectAttempts?(i++,setTimeout(s,this.reconnectDelay*i)):t(n)}};s()})}async quit(){if(this.connection){try{await this._send("quit"),this.transport==="websocket"&&this.connection instanceof WebSocket&&this.connection.close()}catch{}this.connection=null,this.isReady=!1,this.isSearching=!1,this._emit("quit")}}async setPosition(e="startpos",t=[]){if(!this.isReady)throw new Error("Engine not ready");let i;e==="startpos"?i="position startpos":i=`position fen ${e}`,t.length>0&&(i+=` moves ${t.join(" ")}`),await this._send(i)}async go(e={}){if(!this.isReady)throw new Error("Engine not ready");this.isSearching&&await this.stop(),this.isSearching=!0,this.currentAnalysis={bestMove:null,ponder:null,score:0,isMate:!1,depth:0,nodes:0,time:0,pv:[],nps:0};let t="go";return e.infinite?(t+=" infinite",this._send(t),this.currentAnalysis):(e.depth&&(t+=` depth ${e.depth}`),e.moveTime&&(t+=` movetime ${e.moveTime}`),e.wtime&&(t+=` wtime ${e.wtime}`),e.btime&&(t+=` btime ${e.btime}`),e.winc&&(t+=` winc ${e.winc}`),e.binc&&(t+=` binc ${e.binc}`),new Promise((i,s)=>{const n=setTimeout(()=>{this.isSearching=!1,s(new Error("Search timeout"))},(e.moveTime||this.config.moveTime)+3e4),r=o=>{o.bestMove&&(clearTimeout(n),this.off("bestmove",r),this.isSearching=!1,i({...this.currentAnalysis,...o}))};this.on("bestmove",r),this._send(t)}))}async stop(){if(this.isSearching)return new Promise(e=>{const t=setTimeout(()=>{this.isSearching=!1,e()},1e3),i=()=>{clearTimeout(t),this.off("bestmove",i),this.isSearching=!1,e()};this.on("bestmove",i),this._send("stop")})}async setOption(e,t){if(!this.isReady)throw new Error("Engine not ready");await this._send(`setoption name ${e} value ${t}`),await this._sendAndWait("isready","readyok")}async _configureEngine(){this.config.threads>1&&await this._send(`setoption name Threads value ${this.config.threads}`),await this._send(`setoption name Hash value ${this.config.hashSize}`)}async _send(e){switch(this._emit("command",e),this.transport){case"websocket":this.connection&&this.connection.readyState===WebSocket.OPEN&&this.connection.send(e);break;case"http":await this._sendHttp(e);break;case"custom":this.customSend&&await this.customSend(e);break}}async _sendHttp(e){const i=await(await fetch(this.url,{method:"POST",headers:{"Content-Type":"text/plain"},body:e})).text(),s=i.split(`
`);for(const n of s)n.trim()&&this._handleMessage(n);return i}_sendAndWait(e,t){return new Promise((i,s)=>{const n=setTimeout(()=>{s(new Error(`Timeout waiting for ${t}`))},1e4),r=o=>{typeof o=="string"&&o.includes(t)&&(clearTimeout(n),this.off("message",r),i())};this.on("message",r),this._send(e)})}_handleMessage(e){if(typeof e!="string")return;this.messageBuffer+=e;const t=this.messageBuffer.split(`
`);this.messageBuffer=t.pop()||"";for(const i of t){const s=i.trim();if(s)if(this._emit("message",s),s.startsWith("id "))this._parseId(s);else if(s.startsWith("info ")){const n=this._parseInfo(s.slice(5));this._updateAnalysis(n),this._emit("info",n)}else if(s.startsWith("bestmove ")){const n=this._parseBestMove(s);this._emit("bestmove",n)}else s.startsWith("option ")&&this._parseOption(s)}}_parseId(e){this.info||(this.info={name:"",author:"",version:"",options:[]}),e.startsWith("id name ")?this.info.name=e.slice(8):e.startsWith("id author ")&&(this.info.author=e.slice(10))}_parseOption(e){this.info||(this.info={name:"",author:"",version:"",options:[]});const t=e.match(/option name ([^ ]+)/);t&&this.info.options.push(t[1])}_updateAnalysis(e){this.currentAnalysis&&(e.depth!==void 0&&(this.currentAnalysis.depth=e.depth),e.score!==void 0&&(this.currentAnalysis.score=e.score,this.currentAnalysis.isMate=e.isMate||!1),e.nodes!==void 0&&(this.currentAnalysis.nodes=e.nodes),e.time!==void 0&&(this.currentAnalysis.time=e.time),e.nps!==void 0&&(this.currentAnalysis.nps=e.nps),e.pv!==void 0&&(this.currentAnalysis.pv=e.pv))}isConnected(){return this.connection?this.transport==="websocket"?this.connection.readyState===WebSocket.OPEN:!0:!1}async newGame(){if(!this.isReady)throw new Error("Engine not ready");await this._send("ucinewgame"),await this._sendAndWait("isready","readyok")}}const se=class se extends re{constructor(e={}){super({depth:40,multiPv:1,useTablebase:!0,...e}),this.provider=e.provider||"lichess",this.apiKey=e.apiKey||null,this.apiUrl=e.apiUrl||null,this.multiPv=e.multiPv||1,this.useTablebase=e.useTablebase!==!1,this.currentFen=null,this.cachedAnalysis=new Map}async init(){if(this.isReady)return!0;try{return await this._testConnection(),this.info={name:`Cloud Engine (${this.provider})`,author:this.provider,version:"1.0",options:["multiPv","useTablebase"]},this.isReady=!0,this._emit("ready",this.info),!0}catch(e){throw this._emit("error",e),e}}async _testConnection(){var t,i;const e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";try{await this._fetchAnalysis(e)}catch(s){if((t=s.message)!=null&&t.includes("network")||(i=s.message)!=null&&i.includes("fetch"))throw new Error(`Failed to connect to ${this.provider} API`)}}async quit(){this.isReady=!1,this.cachedAnalysis.clear(),this._emit("quit")}async setPosition(e="startpos",t=[]){e==="startpos"?this.currentFen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1":this.currentFen=e}async go(e={}){if(!this.isReady)throw new Error("Engine not ready");if(!this.currentFen)throw new Error("Position not set");this.isSearching=!0;try{const t=`${this.currentFen}-${e.multiPv||this.multiPv}`;if(this.cachedAnalysis.has(t)){const s=this.cachedAnalysis.get(t);return this.isSearching=!1,s}const i=await this._fetchAnalysis(this.currentFen,e);if(this.cachedAnalysis.set(t,i),this.cachedAnalysis.size>1e3){const s=this.cachedAnalysis.keys().next().value;this.cachedAnalysis.delete(s)}return this.isSearching=!1,this._emit("bestmove",{bestMove:i.bestMove,ponder:i.ponder}),i}catch(t){throw this.isSearching=!1,t}}async stop(){this.isSearching=!1}async setOption(e,t){switch(e.toLowerCase()){case"multipv":this.multiPv=parseInt(t,10);break;case"usetablebase":this.useTablebase=t===!0||t==="true";break;default:this.config[e]=t}}async _fetchAnalysis(e,t={}){switch(this.provider){case"lichess":return this._fetchLichessAnalysis(e,t);case"chesscom":return this._fetchChesscomAnalysis(e,t);case"custom":return this._fetchCustomAnalysis(e,t);default:throw new Error(`Unknown provider: ${this.provider}`)}}async _fetchLichessAnalysis(e,t={}){const i=t.multiPv||this.multiPv,s=new URL(se.PROVIDERS.lichess.analysis);s.searchParams.set("fen",e),s.searchParams.set("multiPv",i.toString());const n={};this.apiKey&&(n.Authorization=`Bearer ${this.apiKey}`);const r=await fetch(s.toString(),{headers:n});if(!r.ok){if(r.status===404)return this._createEmptyAnalysis();throw new Error(`Lichess API error: ${r.status}`)}const o=await r.json();return this._parseLichessResponse(o)}_parseLichessResponse(e){if(!e.pvs||e.pvs.length===0)return this._createEmptyAnalysis();const t=e.pvs[0],i=t.moves?t.moves.split(" "):[];return{bestMove:i[0]||null,ponder:i[1]||null,score:t.cp!==void 0?t.cp:t.mate!==void 0?t.mate*1e4:0,isMate:t.mate!==void 0,depth:e.depth||0,nodes:e.knodes?e.knodes*1e3:0,time:0,pv:i,nps:0,multiPv:e.pvs.map(s=>({moves:s.moves?s.moves.split(" "):[],score:s.cp!==void 0?s.cp:s.mate!==void 0?s.mate*1e4:0,isMate:s.mate!==void 0}))}}async _fetchChesscomAnalysis(e,t={}){const i=new URL(se.PROVIDERS.chesscom.analysis);i.searchParams.set("fen",e);const s=await fetch(i.toString());if(!s.ok)return this._createEmptyAnalysis();const n=await s.json();return this._parseChesscomResponse(n)}_parseChesscomResponse(e){return e.bestMove?{bestMove:e.bestMove,ponder:e.ponder||null,score:e.score||0,isMate:e.isMate||!1,depth:e.depth||0,nodes:e.nodes||0,time:0,pv:e.pv||[e.bestMove],nps:0}:this._createEmptyAnalysis()}async _fetchCustomAnalysis(e,t={}){if(!this.apiUrl)throw new Error("Custom API URL not configured");const i=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",...this.apiKey?{Authorization:`Bearer ${this.apiKey}`}:{}},body:JSON.stringify({fen:e,options:t})});if(!i.ok)throw new Error(`Custom API error: ${i.status}`);const s=await i.json();return{bestMove:s.bestMove||null,ponder:s.ponder||null,score:s.score||0,isMate:s.isMate||!1,depth:s.depth||0,nodes:s.nodes||0,time:s.time||0,pv:s.pv||[],nps:s.nps||0}}_createEmptyAnalysis(){return{bestMove:null,ponder:null,score:0,isMate:!1,depth:0,nodes:0,time:0,pv:[],nps:0}}async probeTablebase(e){var n,r,o;if(this.provider!=="lichess")throw new Error("Tablebase probe only available with Lichess provider");const t=new URL(se.PROVIDERS.lichess.tablebase);t.searchParams.set("fen",e);const i=await fetch(t.toString());if(!i.ok)return null;const s=await i.json();return{category:s.category,dtz:s.dtz,dtm:s.dtm,bestMove:((r=(n=s.moves)==null?void 0:n[0])==null?void 0:r.uci)||null,moves:(o=s.moves)==null?void 0:o.map(c=>({uci:c.uci,san:c.san,category:c.category,dtz:c.dtz}))}}async getOpeningData(e,t={}){var r;if(this.provider!=="lichess")throw new Error("Opening explorer only available with Lichess provider");const i=new URL(se.PROVIDERS.lichess.opening);i.searchParams.set("fen",e),t.speeds&&i.searchParams.set("speeds",t.speeds.join(",")),t.ratings&&i.searchParams.set("ratings",t.ratings.join(","));const s=await fetch(i.toString());if(!s.ok)return{moves:[],games:0};const n=await s.json();return{moves:(r=n.moves)==null?void 0:r.map(o=>({uci:o.uci,san:o.san,games:o.white+o.draws+o.black,white:o.white,draws:o.draws,black:o.black,averageRating:o.averageRating})),games:n.white+n.draws+n.black,opening:n.opening}}clearCache(){this.cachedAnalysis.clear()}getCacheStats(){return{size:this.cachedAnalysis.size,maxSize:1e3}}};w(se,"PROVIDERS",{lichess:{analysis:"https://lichess.org/api/cloud-eval",tablebase:"https://tablebase.lichess.ovh/standard",opening:"https://explorer.lichess.ovh/lichess"},chesscom:{analysis:"https://api.chess.com/pub/analysis"}});let Le=se;const U=class U{constructor(e,t={}){this.chessboard=e,this.config={defaultEngine:"stockfish",autoInit:!0,...t},this.engines=new Map,this.currentEngine=null,this.currentEngineName=null,this.listeners=new Map}async loadEngine(e,t={}){if(U.PRESETS[e]){const i=U.PRESETS[e];return this._createEngine(e,i.type,{...i.config,...t})}if(U.ENGINE_TYPES[e])return this._createEngine(e,e,t);throw new Error(`Unknown engine: ${e}`)}async _createEngine(e,t,i){const s=U.ENGINE_TYPES[t];if(!s)throw new Error(`Unknown engine type: ${t}`);const n=new s(i);return n.on("ready",r=>this._emit("engineReady",{name:e,info:r})),n.on("bestmove",r=>this._emit("bestmove",{name:e,...r})),n.on("info",r=>this._emit("info",{name:e,...r})),n.on("error",r=>this._emit("error",{name:e,error:r})),this.config.autoInit&&await n.init(),this.engines.set(e,n),this.currentEngine||(this.currentEngine=n,this.currentEngineName=e),this._emit("engineLoaded",{name:e,engine:n}),n}getEngine(e){return e?this.engines.get(e)||null:this.currentEngine}setCurrentEngine(e){const t=this.engines.get(e);if(!t)throw new Error(`Engine not loaded: ${e}`);return this.currentEngine=t,this.currentEngineName=e,this._emit("engineChanged",{name:e,engine:t}),t}async unloadEngine(e){const t=this.engines.get(e);if(t){if(await t.quit(),this.engines.delete(e),this.currentEngineName===e){const i=Array.from(this.engines.keys());i.length>0?this.setCurrentEngine(i[0]):(this.currentEngine=null,this.currentEngineName=null)}this._emit("engineUnloaded",{name:e})}}async unloadAll(){const e=Array.from(this.engines.keys());await Promise.all(e.map(t=>this.unloadEngine(t)))}async getBestMove(e={}){this._ensureEngine();const t=this.chessboard.fen();return await this.currentEngine.setPosition(t),this.currentEngine.getBestMove(e)}async analyze(e={}){this._ensureEngine();const t=this.chessboard.fen();return this.currentEngine.analyze(t,e)}async analyzePosition(e,t={}){return this._ensureEngine(),this.currentEngine.analyze(e,t)}async stopAnalysis(){this.currentEngine&&await this.currentEngine.stop()}async setOption(e,t,i){const s=i?this.engines.get(i):this.currentEngine;if(!s)throw new Error("No engine available");await s.setOption(e,t)}_ensureEngine(){if(!this.currentEngine)throw new Error("No engine loaded. Call loadEngine() first.");if(!this.currentEngine.ready())throw new Error("Engine not ready. Wait for initialization.")}getLoadedEngines(){return Array.from(this.engines.keys())}getCurrentEngineName(){return this.currentEngineName}isLoaded(e){return this.engines.has(e)}static getPresets(){return Object.keys(U.PRESETS)}static getEngineTypes(){return Object.keys(U.ENGINE_TYPES)}on(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),this}off(e,t){if(this.listeners.has(e)){const i=this.listeners.get(e),s=i.indexOf(t);s>-1&&i.splice(s,1)}return this}_emit(e,t){this.listeners.has(e)&&this.listeners.get(e).forEach(i=>{try{i(t)}catch(s){console.error(`Error in ${e} listener:`,s)}})}async destroy(){await this.unloadAll(),this.listeners.clear()}};w(U,"ENGINE_TYPES",{stockfish:qe,uci:At,cloud:Le}),w(U,"PRESETS",{stockfish:{type:"stockfish",config:{depth:20}},"stockfish-lite":{type:"stockfish",config:{depth:12,threads:1,hash:8}},"stockfish-strong":{type:"stockfish",config:{depth:25,threads:4,hash:128}},lichess:{type:"cloud",config:{provider:"lichess"}},"lichess-tablebase":{type:"cloud",config:{provider:"lichess",useTablebase:!0}}});let tt=U;/**
 * Chessboard.js - A beautiful, customizable chessboard widget
 * Main entry point for the library
 *
 * @version 3.2.0
 * @author alepot55
 * @license ISC
 */const It="3.2.0",Rt="dev",Ot=new Date().toISOString(),yi={name:"Chessboard.js",version:It,build:Rt,buildDate:Ot,author:"alepot55",license:"ISC",repository:"https://github.com/alepot55/Chessboardjs",homepage:"https://chessboardjs.com"};return d.AnimationService=ot,d.BOARD_LETTERS=le,d.BOARD_SIZE=Ge,d.BaseEngine=re,d.BaseMode=ne,d.BoardService=at,d.Chess=pt,d.ChessAI=Ae,d.Chessboard=A,d.ChessboardConfig=Ve,d.ChessboardError=j,d.ChessboardFactory=Je,d.CloudEngine=Le,d.ConfigurationError=O,d.CoordinateService=ct,d.CreativeMode=Te,d.DEFAULT_STARTING_POSITION=X,d.DOMError=st,d.EngineManager=tt,d.EventService=ht,d.LOG_LEVELS=ie,d.Logger=pe,d.ModeManager=Re,d.Move=W,d.MoveError=xe,d.MoveService=lt,d.PIECE_COLORS=he,d.PIECE_TYPES=ce,d.PROMOTION_PIECES=it,d.PerformanceMonitor=Ye,d.Piece=Ee,d.PieceError=ye,d.PieceService=ut,d.PositionService=vt,d.PvPMode=_t,d.STANDARD_POSITIONS=x,d.Square=Pe,d.StockfishEngine=qe,d.UCIEngine=At,d.ValidationError=M,d.ValidationService=we,d.VsBotMode=Ie,d.algebraicToCoords=Et,d.animationPromise=Si,d.batchDOMOperations=ei,d.batchValidate=gi,d.build=Rt,d.buildDate=Ot,d.chessboardFactory=N,d.clearValidationCache=pi,d.coordsToAlgebraic=ai,d.createChessboard=St,d.createChessboardFromTemplate=yt,d.createLogger=oi,d.debounce=Yt,d.default=A,d.getMemoryUsage=ii,d.getSquareColor=ci,d.getValidationCacheStats=vi,d.info=yi,d.isElementVisible=ti,d.isValidCoords=hi,d.isValidPiece=Xe,d.isValidPosition=et,d.isValidSquare=Pt,d.logger=De,d.parseAnimation=bi,d.parseTime=_i,d.rafThrottle=Jt,d.resetTransform=Xt,d.setTransform=Zt,d.throttle=Qt,d.validateConfig=Tt,d.validateFen=Ke,d.validateFenFormat=Mt,d.validateMove=kt,d.version=It,Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),d}({});
//# sourceMappingURL=chessboard.iife.js.map
