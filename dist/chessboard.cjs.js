"use strict";var pt=Object.defineProperty;var vt=(a,e,t)=>e in a?pt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var E=(a,e,t)=>vt(a,typeof e!="symbol"?e+"":e,t);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const Te={start:"start",default:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",empty:"8/8/8/8/8/8/8/8 w - - 0 1"},He="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",le=["p","r","n","b","q","k"],ce=["w","b"],Ke=["q","r","b","n"],ae="abcdefgh",Ie={ROWS:8,COLS:8,TOTAL_SQUARES:64},M=Object.freeze({VALIDATION_ERROR:"VALIDATION_ERROR",CONFIG_ERROR:"CONFIG_ERROR",MOVE_ERROR:"MOVE_ERROR",DOM_ERROR:"DOM_ERROR",ANIMATION_ERROR:"ANIMATION_ERROR",PIECE_ERROR:"PIECE_ERROR",INITIALIZATION_ERROR:"INITIALIZATION_ERROR",POSITION_ERROR:"POSITION_ERROR",FEN_ERROR:"FEN_ERROR",SQUARE_ERROR:"SQUARE_ERROR",THEME_ERROR:"THEME_ERROR",NETWORK_ERROR:"NETWORK_ERROR"}),C=Object.freeze({invalid_position:"Invalid position: ",invalid_fen:"Invalid FEN string: ",position_load_failed:"Failed to load position: ",invalid_id_div:"Board container not found: ",invalid_value:"Invalid value: ",dom_operation_failed:"DOM operation failed: ",element_not_found:"Element not found: ",invalid_piece:"Invalid piece notation: ",invalid_square:"Invalid square notation: ",invalid_piecesPath:"Invalid pieces path: ",piece_operation_failed:"Piece operation failed: ",invalid_orientation:"Invalid orientation: ",invalid_color:"Invalid color: ",invalid_mode:"Invalid mode: ",invalid_dropOffBoard:"Invalid dropOffBoard setting: ",invalid_size:"Invalid size: ",invalid_movableColors:"Invalid movableColors setting: ",invalid_snapbackTime:"Invalid snapbackTime: ",invalid_snapbackAnimation:"Invalid snapbackAnimation: ",invalid_fadeTime:"Invalid fadeTime: ",invalid_fadeAnimation:"Invalid fadeAnimation: ",invalid_ratio:"Invalid ratio: ",invalid_animationStyle:"Invalid animationStyle: ",animation_failed:"Animation failed: ",invalid_onMove:"Invalid onMove callback: ",invalid_onMoveEnd:"Invalid onMoveEnd callback: ",invalid_onChange:"Invalid onChange callback: ",invalid_onDragStart:"Invalid onDragStart callback: ",invalid_onDragMove:"Invalid onDragMove callback: ",invalid_onDrop:"Invalid onDrop callback: ",invalid_onSnapbackEnd:"Invalid onSnapbackEnd callback: ",callback_execution_failed:"Callback execution failed: ",invalid_whiteSquare:"Invalid whiteSquare color: ",invalid_blackSquare:"Invalid blackSquare color: ",invalid_highlight:"Invalid highlight color: ",invalid_selectedSquareWhite:"Invalid selectedSquareWhite color: ",invalid_selectedSquareBlack:"Invalid selectedSquareBlack color: ",invalid_movedSquareWhite:"Invalid movedSquareWhite color: ",invalid_movedSquareBlack:"Invalid movedSquareBlack color: ",invalid_choiceSquare:"Invalid choiceSquare color: ",invalid_coverSquare:"Invalid coverSquare color: ",invalid_hintColor:"Invalid hintColor: ",invalid_move:"Invalid move: ",invalid_move_format:"Invalid move format: ",move_execution_failed:"Move execution failed: ",illegal_move:"Illegal move: ",square_no_piece:"No piece found on square: ",move_validation_failed:"Move validation failed: ",game_over:"Game is over",invalid_turn:"Invalid turn: ",position_validation_failed:"Position validation failed: ",theme_load_failed:"Theme loading failed: ",asset_load_failed:"Asset loading failed: ",invalid_theme:"Invalid theme: ",network_error:"Network error: ",resource_not_found:"Resource not found: ",timeout_error:"Operation timed out: ",initialization_failed:"Initialization failed: ",operation_failed:"Operation failed: ",invalid_state:"Invalid state: ",memory_limit_exceeded:"Memory limit exceeded",performance_degraded:"Performance degraded: "}),x=Object.freeze({LOW:"LOW",MEDIUM:"MEDIUM",HIGH:"HIGH",CRITICAL:"CRITICAL"});Object.freeze({[M.VALIDATION_ERROR]:x.MEDIUM,[M.CONFIG_ERROR]:x.HIGH,[M.MOVE_ERROR]:x.LOW,[M.DOM_ERROR]:x.HIGH,[M.ANIMATION_ERROR]:x.LOW,[M.PIECE_ERROR]:x.MEDIUM,[M.INITIALIZATION_ERROR]:x.CRITICAL,[M.POSITION_ERROR]:x.MEDIUM,[M.FEN_ERROR]:x.MEDIUM,[M.SQUARE_ERROR]:x.MEDIUM,[M.THEME_ERROR]:x.LOW,[M.NETWORK_ERROR]:x.MEDIUM});class V extends Error{constructor(e,t,i={}){super(e),this.name="ChessboardError",this.code=t,this.context=i,this.timestamp=new Date().toISOString(),Error.captureStackTrace&&Error.captureStackTrace(this,V)}}class k extends V{constructor(e,t,i){super(e,M.VALIDATION_ERROR,{field:t,value:i}),this.name="ValidationError",this.field=t,this.value=i}}class q extends V{constructor(e,t,i){super(e,M.CONFIG_ERROR,{configKey:t,configValue:i}),this.name="ConfigurationError",this.configKey=t,this.configValue=i}}class Re extends V{constructor(e,t,i,s){super(e,M.MOVE_ERROR,{from:t,to:i,piece:s}),this.name="MoveError",this.from=t,this.to=i,this.piece=s}}class Ue extends V{constructor(e,t){super(e,M.DOM_ERROR,{elementId:t}),this.name="DOMError",this.elementId=t}}class ge extends V{constructor(e,t,i){super(e,M.PIECE_ERROR,{pieceId:t,square:i}),this.name="PieceError",this.pieceId=t,this.square=i}}const _t=Object.freeze({square:/^[a-h][1-8]$/,piece:/^[prnbqkPRNBQK][wb]$/,fen:/^([rnbqkpRNBQKP1-8]+\/){7}[rnbqkpRNBQKP1-8]+\s[wb]\s[KQkq-]+\s[a-h1-8-]+\s\d+\s\d+$/,move:/^[a-h][1-8][a-h][1-8][qrnb]?$/,color:/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/}),St=Object.freeze({orientations:["w","b","white","black"],colors:["w","b","white","black"],movableColors:["w","b","white","black","both","none"],dropOffBoard:["snapback","trash"],easingTypes:["linear","ease","ease-in","ease-out","ease-in-out"],animationStyles:["sequential","simultaneous"],modes:["normal","creative","analysis"],promotionPieces:["q","r","b","n","Q","R","B","N"]}),bt=Object.freeze({min:50,max:2e3,maxTime:1e4,maxDelay:5e3});class be{constructor(){this._validationCache=new Map,this._cacheMaxSize=1e3,this._patterns=_t,this._validValues=St,this._constraints=bt}isValidSquare(e){const t=`square:${e}`;if(this._validationCache.has(t))return this._validationCache.get(t);const i=typeof e=="string"&&e.length===2&&this._patterns.square.test(e);return this._cacheValidationResult(t,i),i}isValidPiece(e){if(typeof e!="string"||e.length!==2)return!1;const t=`piece:${e}`;if(this._validationCache.has(t))return this._validationCache.get(t);const[i,s]=e.split(""),n=le.includes(i.toLowerCase())&&ce.includes(s),r=ce.includes(i)&&le.includes(s.toLowerCase()),o=n||r;return this._cacheValidationResult(t,o),o}isValidFen(e){if(typeof e!="string")return!1;const t=`fen:${e}`;if(this._validationCache.has(t))return this._validationCache.get(t);if(!this._patterns.fen.test(e))return this._cacheValidationResult(t,!1),!1;const i=this._validateFenStructure(e);return this._cacheValidationResult(t,i),i}_validateFenStructure(e){const t=e.split(" ");if(t.length!==6)return!1;const i=t[0].split("/");if(i.length!==8)return!1;for(const r of i)if(!this._validateRank(r))return!1;if(!["w","b"].includes(t[1])||!/^[KQkq-]*$/.test(t[2])||t[3]!=="-"&&!this.isValidSquare(t[3]))return!1;const s=parseInt(t[4],10),n=parseInt(t[5],10);return!isNaN(s)&&!isNaN(n)&&s>=0&&n>=1}_validateRank(e){let t=0;for(let i=0;i<e.length;i++){const s=e[i];if(/[1-8]/.test(s))t+=parseInt(s,10);else if(/[prnbqkPRNBQK]/.test(s))t+=1;else return!1}return t===8}isValidMove(e){if(typeof e!="string")return!1;const t=`move:${e}`;if(this._validationCache.has(t))return this._validationCache.get(t);const i=this._validateMoveFormat(e);return this._cacheValidationResult(t,i),i}_validateMoveFormat(e){if(e.length<4||e.length>5)return!1;const t=e.slice(0,2),i=e.slice(2,4),s=e.slice(4,5);return!this.isValidSquare(t)||!this.isValidSquare(i)||s&&!this._validValues.promotionPieces.includes(s)?!1:t!==i}isValidOrientation(e){return this._validValues.orientations.includes(e)}isValidColor(e){return this._validValues.colors.includes(e)}isValidSize(e){return e==="auto"?!0:typeof e=="number"?e>=this._constraints.min&&e<=this._constraints.max:!1}isValidTime(e){return typeof e=="number"&&e>=0&&e<=this._constraints.maxTime}isValidCallback(e){return typeof e=="function"}isValidElementId(e){return typeof e=="string"&&e.length>0&&e.length<=100&&/^[a-zA-Z][\w:-]*$/.test(e)}isValidMovableColors(e){return this._validValues.movableColors.includes(e)}isValidDropOffBoard(e){return this._validValues.dropOffBoard.includes(e)}isValidEasing(e){return this._validValues.easingTypes.includes(e)}isValidAnimationStyle(e){return this._validValues.animationStyles.includes(e)}isValidCSSColor(e){return typeof e!="string"?!1:!!(this._patterns.color.test(e)||["white","black","red","green","blue","yellow","cyan","magenta"].includes(e.toLowerCase())||/^rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)$/.test(e)||/^rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*[0-1](\.\d+)?\s*\)$/.test(e))}validateSquare(e){if(!this.isValidSquare(e))throw new k(C.invalid_square+e,"square",e);return e.toLowerCase()}validatePiece(e){if(!this.isValidPiece(e))throw new k(C.invalid_piece+e,"piece",e);return e.toLowerCase()}validateFen(e){if(!this.isValidFen(e))throw new k(C.invalid_fen+e,"fen",e);return e.trim()}validateMove(e){if(!this.isValidMove(e))throw new k(C.invalid_move+e,"move",e);return e.toLowerCase()}validateOrientation(e){if(!this.isValidOrientation(e))throw new k(C.invalid_orientation+e,"orientation",e);return e==="white"?"w":e==="black"?"b":e}validateColor(e){if(!this.isValidColor(e))throw new k(C.invalid_color+e,"color",e);return e==="white"?"w":e==="black"?"b":e}validateSize(e){if(!this.isValidSize(e))throw new k(C.invalid_size+e,"size",e);return e}validateConfig(e){if(!e||typeof e!="object")throw new k("Configuration must be an object","config",e);const t=[];!e.id&&!e.id_div&&t.push("Configuration must include id or id_div"),e.orientation&&!this.isValidOrientation(e.orientation)&&t.push(C.invalid_orientation+e.orientation),e.size&&!this.isValidSize(e.size)&&t.push(C.invalid_size+e.size),e.movableColors&&!this.isValidMovableColors(e.movableColors)&&t.push(C.invalid_color+e.movableColors),e.dropOffBoard&&!this.isValidDropOffBoard(e.dropOffBoard)&&t.push(C.invalid_dropOffBoard+e.dropOffBoard),e.animationStyle&&!this.isValidAnimationStyle(e.animationStyle)&&t.push(C.invalid_animationStyle+e.animationStyle);const i=["onMove","onMoveEnd","onChange","onDragStart","onDragMove","onDrop","onSnapbackEnd"];for(const n of i)e[n]&&!this.isValidCallback(e[n])&&t.push(`Invalid ${n} callback`);const s=["whiteSquare","blackSquare","highlight","hintColor"];for(const n of s)e[n]&&!this.isValidCSSColor(e[n])&&t.push(`Invalid ${n} color: ${e[n]}`);if(t.length>0)throw new k(`Configuration validation failed: ${t.join(", ")}`,"config",e);return e}_cacheValidationResult(e,t){if(this._validationCache.size>=this._cacheMaxSize){const i=this._validationCache.keys().next().value;this._validationCache.delete(i)}this._validationCache.set(e,t)}clearCache(){this._validationCache.clear()}getCacheStats(){return{size:this._validationCache.size,maxSize:this._cacheMaxSize,hitRate:this._cacheHits/(this._cacheHits+this._cacheMisses)||0}}batchValidate(e){return e.map(t=>{try{const{type:i,value:s}=t;switch(i){case"square":return{valid:this.isValidSquare(s),value:s};case"piece":return{valid:this.isValidPiece(s),value:s};case"fen":return{valid:this.isValidFen(s),value:s};case"move":return{valid:this.isValidMove(s),value:s};default:return{valid:!1,value:s,error:"Unknown validation type"}}}catch(i){return{valid:!1,value:t.value,error:i.message}}})}destroy(){this.clearCache(),this._validationCache=null,this._patterns=null,this._validValues=null,this._constraints=null}}const xe=Object.freeze({fast:200,slow:600,normal:400,verySlow:1e3,veryFast:100}),Be=Object.freeze({true:!0,false:!1,none:!1,1:!0,0:!1}),Ce=Object.freeze({ease:"ease",linear:"linear","ease-in":"ease-in","ease-out":"ease-out","ease-in-out":"ease-in-out",none:null}),yt=Object.freeze({id:"board",position:"start",orientation:"w",mode:"normal",size:"auto",draggable:!0,hints:!0,clickable:!0,movableColors:"both",moveHighlight:!0,overHighlight:!0,moveAnimation:"ease",moveTime:"fast",dropOffBoard:"snapback",snapbackTime:"fast",snapbackAnimation:"ease",dropCenterTime:"veryFast",dropCenterAnimation:"ease",fadeTime:"fast",fadeAnimation:"ease",ratio:.9,piecesPath:"../assets/themes/default",animationStyle:"simultaneous",simultaneousAnimationDelay:100,onMove:()=>!0,onMoveEnd:()=>!0,onChange:()=>!0,onDragStart:()=>!0,onDragMove:()=>!0,onDrop:()=>!0,onSnapbackEnd:()=>!0,whiteSquare:"#f0d9b5",blackSquare:"#b58863",highlight:"yellow",selectedSquareWhite:"#ababaa",selectedSquareBlack:"#ababaa",movedSquareWhite:"#f1f1a0",movedSquareBlack:"#e9e981",choiceSquare:"white",coverSquare:"black",hintColor:"#ababaa"});class Me{constructor(e={}){this._validationService=new be,this._validateInput(e);const t=this._mergeWithDefaults(e);this._processConfiguration(t),this._setCSSProperties(t),this._configureModeSettings()}_validateInput(e){if(e!==null&&typeof e!="object")throw new q("Settings must be an object","settings",e);try{this._validationService.validateConfig(e)}catch(t){throw new q(t.message,t.field,t.value)}}_mergeWithDefaults(e){return Object.assign({},yt,e)}_processConfiguration(e){this.id_div=e.id,this.position=e.position,this.orientation=e.orientation,this.mode=e.mode,this.dropOffBoard=e.dropOffBoard,this.size=e.size,this.movableColors=e.movableColors,this.piecesPath=e.piecesPath,this.onMove=this._validateCallback(e.onMove),this.onMoveEnd=this._validateCallback(e.onMoveEnd),this.onChange=this._validateCallback(e.onChange),this.onDragStart=this._validateCallback(e.onDragStart),this.onDragMove=this._validateCallback(e.onDragMove),this.onDrop=this._validateCallback(e.onDrop),this.onSnapbackEnd=this._validateCallback(e.onSnapbackEnd),this.moveAnimation=this._setTransitionFunction(e.moveAnimation),this.snapbackAnimation=this._setTransitionFunction(e.snapbackAnimation),this.dropCenterAnimation=this._setTransitionFunction(e.dropCenterAnimation),this.fadeAnimation=this._setTransitionFunction(e.fadeAnimation),this.hints=this._setBoolean(e.hints),this.clickable=this._setBoolean(e.clickable),this.draggable=this._setBoolean(e.draggable),this.moveHighlight=this._setBoolean(e.moveHighlight),this.overHighlight=this._setBoolean(e.overHighlight),this.moveTime=this._setTime(e.moveTime),this.snapbackTime=this._setTime(e.snapbackTime),this.dropCenterTime=this._setTime(e.dropCenterTime),this.fadeTime=this._setTime(e.fadeTime),this.animationStyle=this._validateAnimationStyle(e.animationStyle),this.simultaneousAnimationDelay=this._validateDelay(e.simultaneousAnimationDelay)}_setCSSProperties(e){const t={pieceRatio:e.ratio,whiteSquare:e.whiteSquare,blackSquare:e.blackSquare,highlightSquare:e.highlight,selectedSquareWhite:e.selectedSquareWhite,selectedSquareBlack:e.selectedSquareBlack,movedSquareWhite:e.movedSquareWhite,movedSquareBlack:e.movedSquareBlack,choiceSquare:e.choiceSquare,coverSquare:e.coverSquare,hintColor:e.hintColor};Object.entries(t).forEach(([i,s])=>{this._setCSSProperty(i,s)})}_configureModeSettings(){switch(this.mode){case"creative":this.onlyLegalMoves=!1,this.hints=!1;break;case"normal":this.onlyLegalMoves=!0;break;default:this.onlyLegalMoves=!0}}_validateCallback(e){if(!this._validationService.isValidCallback(e))throw new q("Callback must be a function","callback",e);return e}_validateAnimationStyle(e){if(!this._validationService.isValidAnimationStyle(e))throw new q("Invalid animation style","animationStyle",e);return e}_validateDelay(e){if(typeof e!="number"||e<0||e>5e3)throw new q("Invalid animation delay","simultaneousAnimationDelay",e);return e}_setCSSProperty(e,t){try{typeof document<"u"&&document.documentElement&&document.documentElement.style.setProperty(`--${e}`,t)}catch(i){console.warn(`Failed to set CSS property ${e}:`,i.message)}}setOrientation(e){const t=this._validationService.validateOrientation(e);return this.orientation=t,this}_setTime(e){if(typeof e=="number"){if(!this._validationService.isValidTime(e))throw new q("Invalid time value","time",e);return e}if(typeof e=="string"&&e in xe)return xe[e];throw new q("Invalid time value","time",e)}_setBoolean(e){if(typeof e=="boolean")return e;if(e in Be)return Be[e];throw new q("Invalid boolean value","boolean",e)}_setTransitionFunction(e){if(typeof e=="boolean")return e?Ce.ease:null;if(typeof e=="string"&&e in Ce)return Ce[e];if(e==null)return null;throw new q("Invalid transition function","transitionFunction",e)}toObject(){return{id_div:this.id_div,position:this.position,orientation:this.orientation,mode:this.mode,size:this.size,draggable:this.draggable,hints:this.hints,clickable:this.clickable,movableColors:this.movableColors,moveHighlight:this.moveHighlight,overHighlight:this.overHighlight,moveAnimation:this.moveAnimation,moveTime:this.moveTime,dropOffBoard:this.dropOffBoard,snapbackTime:this.snapbackTime,snapbackAnimation:this.snapbackAnimation,dropCenterTime:this.dropCenterTime,dropCenterAnimation:this.dropCenterAnimation,fadeTime:this.fadeTime,fadeAnimation:this.fadeAnimation,piecesPath:this.piecesPath,animationStyle:this.animationStyle,simultaneousAnimationDelay:this.simultaneousAnimationDelay,onlyLegalMoves:this.onlyLegalMoves}}update(e){if(!e||typeof e!="object")throw new q("Updates must be an object","updates",e);this._validationService.validateConfig(e);const t=Object.assign({},this.toObject(),e);return this._processConfiguration(t),this._setCSSProperties(t),this._configureModeSettings(),this}destroy(){this._validationService&&(this._validationService.destroy(),this._validationService=null)}}class he{constructor(e,t,i,s=1){this.color=e,this.type=t,this.id=this.getId(),this.src=i,this.element=this.createElement(i,s),console.debug(`[Piece] Constructed: ${this.id}`),this.check()}getId(){return this.type+this.color}createElement(e,t=1){const i=document.createElement("img");return i.classList.add("piece"),i.id=this.id,i.src=e||this.src,i.style.opacity=t,i.onerror=()=>{console.warn("Failed to load piece image:",i.src)},i}visible(){this.element&&(this.element.style.opacity=1,console.debug(`[Piece] visible: ${this.id}`))}invisible(){this.element&&(this.element.style.opacity=0,console.debug(`[Piece] invisible: ${this.id}`))}updateSrc(e){this.src=e,this.element&&(this.element.src=e)}transformTo(e,t,i=200,s=null){if(!this.element){console.debug(`[Piece] transformTo: ${this.id} - element is null`),s&&s();return}const n=this.element;n.src,n.classList.add("transforming");const r=[{transform:"scale(1)",opacity:"1"},{transform:"scale(0.8)",opacity:"0.7"}],o=[{transform:"scale(0.8)",opacity:"0.7"},{transform:"scale(1)",opacity:"1"}],l=i/2;if(n.animate){const c=n.animate(r,{duration:l,easing:"ease-in",fill:"forwards"});c.onfinish=()=>{if(!this.element){console.debug(`[Piece] transformTo.scaleDown.onfinish: ${this.id} - element is null`),s&&s();return}this.type=e,this.id=this.getId(),this.src=t,n.src=t,n.id=this.id;const u=n.animate(o,{duration:l,easing:"ease-out",fill:"forwards"});u.onfinish=()=>{if(!this.element){console.debug(`[Piece] transformTo.scaleUp.onfinish: ${this.id} - element is null`),s&&s();return}n.style.transform="",n.style.opacity="",n.classList.remove("transforming"),n.classList.add("transform-complete"),setTimeout(()=>{this.element&&n.classList.remove("transform-complete")},400),console.debug(`[Piece] transformTo complete: ${this.id}`),s&&s()}}}else n.style.transition=`transform ${l}ms ease-in, opacity ${l}ms ease-in`,n.style.transform="scale(0.8)",n.style.opacity="0.7",setTimeout(()=>{if(!this.element){console.debug(`[Piece] transformTo (fallback): ${this.id} - element is null`),s&&s();return}this.type=e,this.id=this.getId(),this.src=t,n.src=t,n.id=this.id,n.style.transition=`transform ${l}ms ease-out, opacity ${l}ms ease-out`,n.style.transform="scale(1)",n.style.opacity="1",setTimeout(()=>{if(!this.element){console.debug(`[Piece] transformTo (fallback, cleanup): ${this.id} - element is null`),s&&s();return}n.style.transition="",n.style.transform="",n.style.opacity="",n.classList.remove("transforming"),n.classList.add("transform-complete"),setTimeout(()=>{this.element&&n.classList.remove("transform-complete")},400),console.debug(`[Piece] transformTo complete (fallback): ${this.id}`),s&&s()},l)},l)}fadeIn(e,t,i,s){const n=performance.now();let r=0;const o=this,l=function(){if(!o.element){console.debug(`[Piece] fadeIn: ${o.id} - element is null`),s&&s();return}const c=performance.now()-n;if(r=i(c,e,t),o.element.style.opacity=r,c<e)requestAnimationFrame(l);else{if(!o.element){console.debug(`[Piece] fadeIn: ${o.id} - element is null (end)`),s&&s();return}o.element.style.opacity=1,console.debug(`[Piece] fadeIn complete: ${o.id}`),s&&s()}};l()}fadeOut(e,t,i,s){const n=performance.now();let r=1;const o=this,l=function(){if(!o.element){console.debug(`[Piece] fadeOut: ${o.id} - element is null`),s&&s();return}const c=performance.now()-n;if(r=1-i(c,e,t),o.element.style.opacity=r,c<e)requestAnimationFrame(l);else{if(!o.element){console.debug(`[Piece] fadeOut: ${o.id} - element is null (end)`),s&&s();return}o.element.style.opacity=0,console.debug(`[Piece] fadeOut complete: ${o.id}`),s&&s()}};l()}setDrag(e){if(!this.element){console.debug(`[Piece] setDrag: ${this.id} - element is null`);return}this._dragHandler&&this.element.removeEventListener("mousedown",this._dragHandler),this.element.ondragstart=t=>{t.preventDefault()},this._dragHandler=e,this.element.addEventListener("mousedown",this._dragHandler),console.debug(`[Piece] setDrag: ${this.id}`)}destroy(){console.debug(`[Piece] Destroy: ${this.id}`),this.element&&(this._dragHandler&&(this.element.removeEventListener("mousedown",this._dragHandler),this._dragHandler=null),this.element.onmousedown=null,this.element.ondragstart=null,this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null)}translate(e,t,i,s,n=null){if(!this.element){console.debug(`[Piece] translate: ${this.id} - element is null`),n&&n();return}const r=this.element.getBoundingClientRect(),o=e.getBoundingClientRect(),l=r.left+r.width/2,c=r.top+r.height/2,u=o.left+o.width/2,d=o.top+o.height/2,h=u-l,m=d-c,f=[{transform:"translate(0, 0)"},{transform:`translate(${h}px, ${m}px)`}];if(this.element.animate){const g=this.element.animate(f,{duration:t,easing:"ease",fill:"none"});g.onfinish=()=>{if(!this.element){console.debug(`[Piece] translate.onfinish: ${this.id} - element is null`),n&&n();return}n&&n(),this.element&&(this.element.style=""),console.debug(`[Piece] translate complete: ${this.id}`)}}else this.element.style.transition=`transform ${t}ms ease`,this.element.style.transform=`translate(${h}px, ${m}px)`,n&&n(),this.element&&(this.element.style=""),console.debug(`[Piece] translate complete (no animate): ${this.id}`)}check(){if(["p","r","n","b","q","k"].indexOf(this.type)===-1)throw new Error("Invalid piece type");if(["w","b"].indexOf(this.color)===-1)throw new Error("Invalid piece color")}}class _e{constructor(e,t){this.row=e,this.col=t,this.id=this.getId(),this.element=this.createElement(),this.piece=null}getPiece(){return this.piece}opposite(){this.row=9-this.row,this.col=9-this.col,this.id=this.getId(),this.element=this.resetElement()}isWhite(){return(this.row+this.col)%2===0}getId(){return"abcdefgh"[this.col-1]+this.row}resetElement(){this.element.id=this.id,this.element.className="",this.element.classList.add("square"),this.element.classList.add(this.isWhite()?"whiteSquare":"blackSquare")}createElement(){const e=document.createElement("div");return e.id=this.id,e.classList.add("square"),e.classList.add(this.isWhite()?"whiteSquare":"blackSquare"),e}getElement(){return this.element}getBoundingClientRect(){return this.element.getBoundingClientRect()}removePiece(e=!1){return this.piece&&(!e&&typeof this.piece.destroy=="function"&&this.piece.destroy(),this.piece=null),null}forceRemoveAllPieces(){this.piece&&typeof this.piece.destroy=="function"&&(this.piece.destroy(),this.piece=null),this.element.querySelectorAll("img.piece").forEach(t=>{t.parentNode===this.element&&this.element.removeChild(t)})}replacePiece(e){this.piece&&this.removePiece(),this.putPiece(e),e.element.style.opacity="1"}addEventListener(e,t){this.element.addEventListener(e,t)}putPiece(e){this.piece&&this.removePiece(!0),this.piece=e,e&&e.element&&this.element.appendChild(e.element)}putHint(e){if(this.element.querySelector(".hint"))return;const t=document.createElement("div");t.classList.add("hint"),this.element.appendChild(t),e&&t.classList.add("catchable")}removeHint(){const e=this.element.querySelector(".hint");e&&this.element.removeChild(e)}select(){this.element.classList.add(this.isWhite()?"selectedSquareWhite":"selectedSquareBlack")}deselect(){this.element.classList.remove("selectedSquareWhite"),this.element.classList.remove("selectedSquareBlack")}moved(){this.element.classList.add(this.isWhite()?"movedSquareWhite":"movedSquareBlack")}unmoved(){this.element.classList.remove("movedSquareWhite"),this.element.classList.remove("movedSquareBlack")}highlight(){this.element.classList.add("highlighted")}dehighlight(){this.element.classList.remove("highlighted")}putCover(e){const t=document.createElement("div");t.classList.add("square"),t.classList.add("cover"),this.element.appendChild(t),t.addEventListener("click",i=>{i.stopPropagation(),e()})}removeCover(){const e=this.element.querySelector(".cover");e&&this.element.removeChild(e)}putPromotion(e,t){const i=document.createElement("div");i.classList.add("square"),i.classList.add("choice"),this.element.appendChild(i);const s=document.createElement("img");s.classList.add("piece"),s.classList.add("choicable"),s.src=e,i.appendChild(s),i.addEventListener("click",n=>{n.stopPropagation(),t()})}hasPromotion(){return this.element.querySelector(".choice")!==null}removePromotion(){const e=this.element.querySelector(".choice");e&&(e.removeChild(e.firstChild),this.element.removeChild(e))}destroy(){this.forceRemoveAllPieces(),this.element.remove(),this.piece=null}hasPiece(){return this.piece!==null}getColor(){return this.piece.getColor()}check(){if(this.row<1||this.row>8)throw new Error("Invalid square: row is out of bounds");if(this.col<1||this.col>8)throw new Error("Invalid square: col is out of bounds")}}let H=class{constructor(e,t,i=null,s=!1){this.piece=e?e.getPiece():null,this.from=e,this.to=t,this.promotion=i,s&&this.check()}hasPromotion(){return this.promotion!==null}setPromotion(e){this.promotion=e}check(){return!(this.piece===null||!(this.piece instanceof he)||["q","r","b","n",null].indexOf(this.promotion)===-1||!(this.from instanceof _e)||!(this.to instanceof _e)||!this.to||!this.from||this.from===this.to)}isLegal(e){return e.moves({square:this.from.id,verbose:!0}).map(i=>i.to).indexOf(this.to.id)!==-1}};class We{constructor(e){this.config=e,this.activeAnimations=new Map,this.animationId=0}createTimingFunction(e="ease"){return(t,i)=>{const s=t/i;switch(e){case"linear":return s;case"ease":return s**2*(3-2*s);case"ease-in":return s**2;case"ease-out":return-1*(s-1)**2+1;case"ease-in-out":return s<.5?2*s**2:4*s-2*s**2-1;default:return s}}}animate(e,t,i,s="ease",n){const r=++this.animationId,o=this.createTimingFunction(s),l=performance.now(),c={};Object.keys(t).forEach(d=>{c[d]=this._getInitialValue(e,d)});const u=d=>{const h=d-l,m=Math.min(h/i,1),f=o(h,i);Object.keys(t).forEach(g=>{const b=c[g],w=t[g],y=this._interpolateValue(b,w,f);this._applyValue(e,g,y)}),m<1&&this.activeAnimations.has(r)?requestAnimationFrame(u):(this.activeAnimations.delete(r),n&&n())};return this.activeAnimations.set(r,{element:e,animate:u,callback:n}),requestAnimationFrame(u),r}cancel(e){this.activeAnimations.has(e)&&this.activeAnimations.delete(e)}cancelAll(){this.activeAnimations.clear()}_getInitialValue(e,t){if(!e||!e.style)return 0;switch(t){case"opacity":return parseFloat(getComputedStyle(e).opacity)||1;case"left":return parseFloat(e.style.left)||0;case"top":return parseFloat(e.style.top)||0;case"scale":return 1;default:return 0}}_interpolateValue(e,t,i){return e+(t-e)*i}_applyValue(e,t,i){if(!(!e||!e.style))switch(t){case"opacity":e.style.opacity=i;break;case"left":e.style.left=`${i}px`;break;case"top":e.style.top=`${i}px`;break;case"scale":e.style.transform=`scale(${i})`;break;default:e.style[t]=i}}destroy(){this.cancelAll()}}class Qe{constructor(e){this.config=e,this.element=null,this.squares={}}buildBoard(){if(console.log("BoardService.buildBoard: Looking for element with ID:",this.config.id_div),this.element=document.getElementById(this.config.id_div),!this.element)throw new Ue(C.invalid_id_div+this.config.id_div,this.config.id_div);this.resize(this.config.size),this.element.className="board"}buildSquares(e){for(let t=0;t<Ie.ROWS;t++)for(let i=0;i<Ie.COLS;i++){const[s,n]=e(t,i),r=new _e(s,n);this.squares[r.getId()]=r,this.element.appendChild(r.element)}}removeSquares(){for(const e of Object.values(this.squares))e.destroy();this.squares={}}removeBoard(){this.element&&(this.element.innerHTML="",this.element=null)}resize(e){if(e==="auto"){const t=this._calculateAutoSize();this.resize(t)}else{if(typeof e!="number")throw new k(C.invalid_value+e,"size",e);document.documentElement.style.setProperty("--dimBoard",`${e}px`)}}_calculateAutoSize(){if(!this.element)return 400;const{offsetWidth:e,offsetHeight:t}=this.element;return e===0?t||400:t===0?e:Math.min(e,t)}getSquare(e){return this.squares[e]||null}getAllSquares(){return{...this.squares}}applyToAllSquares(e,...t){for(const i of Object.values(this.squares))typeof i[e]=="function"&&i[e](...t)}destroy(){this.removeSquares(),this.removeBoard(),this.element=null,this.squares={}}}class Ye{constructor(e){this.config=e}realCoord(e,t){let i=e,s=t;return this.isWhiteOriented()?i=7-e:s=7-t,[i+1,s+1]}getSquareID(e,t){if(e=parseInt(e),t=parseInt(t),this.isWhiteOriented()?(e=8-e,t=t+1):(e=e+1,t=8-t),t<1||t>8||e<1||e>8)throw new k(`Invalid board coordinates: row=${e}, col=${t}`,"coordinates",{row:e,col:t});return ae[t-1]+e}getCoordinatesFromSquareID(e){if(typeof e!="string"||e.length!==2)throw new k(C.invalid_square+e,"squareId",e);const t=e[0],i=parseInt(e[1]),s=ae.indexOf(t);if(s===-1)throw new k(C.invalid_square+e,"squareId",e);if(i<1||i>8)throw new k(C.invalid_square+e,"squareId",e);let n,r;return this.isWhiteOriented()?(n=8-i,r=s):(n=i-1,r=7-s),[n,r]}pixelToSquareID(e,t,i){if(!i)return null;const s=i.getBoundingClientRect(),{width:n,height:r}=s;if(e<0||e>=n||t<0||t>=r)return null;const o=n/8,l=r/8,c=Math.floor(e/o),u=Math.floor(t/l);try{return this.getSquareID(u,c)}catch{return null}}squareIDToPixel(e,t){if(!t)return null;try{const[i,s]=this.getCoordinatesFromSquareID(e),n=t.getBoundingClientRect(),{width:r,height:o}=n,l=r/8,c=o/8,u=s*l,d=i*c;return{x:u,y:d}}catch{return null}}getSquareCenter(e,t){const i=this.squareIDToPixel(e,t);if(!i)return null;const s=t.getBoundingClientRect(),n=s.width/8,r=s.height/8;return{x:i.x+n/2,y:i.y+r/2}}getSquareDistance(e,t){try{const[i,s]=this.getCoordinatesFromSquareID(e),[n,r]=this.getCoordinatesFromSquareID(t),o=Math.abs(n-i),l=Math.abs(r-s);return Math.sqrt(o*o+l*l)}catch{return 0}}isWhiteOriented(){return this.config.orientation==="w"}isBlackOriented(){return this.config.orientation==="b"}getOrientation(){return this.config.orientation}setOrientation(e){const t=e==="white"?"w":e==="black"?"b":e;if(t!=="w"&&t!=="b")throw new k(`${C.invalid_orientation}${e}`,"orientation",e);this.config.orientation=t}flipOrientation(){this.config.orientation=this.isWhiteOriented()?"b":"w"}getAllSquareIDs(){const e=[];for(let t=0;t<8;t++)for(let i=0;i<8;i++)e.push(this.getSquareID(t,i));return e}getSquaresByRank(e){if(e<1||e>8)throw new k(`Invalid rank: ${e}`,"rank",e);const t=[];for(let i=0;i<8;i++){const s=this.isWhiteOriented()?8-e:e-1;t.push(this.getSquareID(s,i))}return t}getSquaresByFile(e){const t=ae.indexOf(e);if(t===-1)throw new k(`Invalid file: ${e}`,"file",e);const i=[];for(let s=0;s<8;s++)i.push(this.getSquareID(s,t));return i}}class qe{constructor(){this.metrics=new Map,this.observers=new Map,this.isEnabled=typeof performance<"u"&&performance.mark,this.isEnabled&&this._setupObservers()}_setupObservers(){try{if(typeof PerformanceObserver<"u"){const e=new PerformanceObserver(t=>{for(const i of t.getEntries())this.recordMetric(i.name,i.startTime)});e.observe({entryTypes:["paint"]}),this.observers.set("paint",e)}}catch(e){console.warn("Performance observers not available:",e.message)}}startMeasure(e){if(this.isEnabled)try{performance.mark(`${e}-start`)}catch(t){console.warn(`Failed to start performance measure for ${e}:`,t.message)}}endMeasure(e){if(!this.isEnabled)return 0;try{performance.mark(`${e}-end`);const t=performance.measure(e,`${e}-start`,`${e}-end`);return this.recordMetric(e,t.duration),performance.clearMarks(`${e}-start`),performance.clearMarks(`${e}-end`),performance.clearMeasures(e),t.duration}catch(t){return console.warn(`Failed to end performance measure for ${e}:`,t.message),0}}recordMetric(e,t){this.metrics.has(e)||this.metrics.set(e,{count:0,total:0,min:1/0,max:-1/0,values:[]});const i=this.metrics.get(e);i.count++,i.total+=t,i.min=Math.min(i.min,t),i.max=Math.max(i.max,t),i.values.push(t),i.values.length>100&&i.values.shift()}getMetrics(){const e={};for(const[t,i]of this.metrics)e[t]={count:i.count,average:i.total/i.count,min:i.min,max:i.max,total:i.total,p95:this._calculatePercentile(i.values,95),p99:this._calculatePercentile(i.values,99)};return e}_calculatePercentile(e,t){if(e.length===0)return 0;const i=[...e].sort((n,r)=>n-r),s=Math.ceil(t/100*i.length)-1;return i[Math.max(0,s)]}clearMetrics(){this.metrics.clear()}destroy(){for(const e of this.observers.values())e&&typeof e.disconnect=="function"&&e.disconnect();this.observers.clear(),this.metrics.clear()}}function Ct(a,e){let t;return function(...i){const s=this;t||(a.apply(s,i),t=!0,setTimeout(()=>t=!1,e))}}function Pt(a,e){let t;return function(...i){const s=this;clearTimeout(t),t=setTimeout(()=>a.apply(s,i),e)}}function Oe(a){let e=!1;return function(...t){if(e)return;const i=this;e=!0,requestAnimationFrame(()=>{a.apply(i,t),e=!1})}}function wt(a,e,t,i=1){!a||!a.style||(a.style.transform=`translate3d(${e}px, ${t}px, 0) scale(${i})`,a.style.willChange="transform")}function Et(a){!a||!a.style||(a.style.transform="",a.style.left="",a.style.top="",a.style.willChange="")}function kt(a){return new Promise(e=>{requestAnimationFrame(()=>{const t=a();e(t)})})}function Tt(a){if(!a||!a.getBoundingClientRect)return!1;const e=a.getBoundingClientRect();return e.width>0&&e.height>0&&e.bottom>0&&e.right>0&&e.top<(window.innerHeight||document.documentElement.clientHeight)&&e.left<(window.innerWidth||document.documentElement.clientWidth)}function It(){return typeof performance<"u"&&performance.memory?{used:performance.memory.usedJSHeapSize,total:performance.memory.totalJSHeapSize,limit:performance.memory.jsHeapSizeLimit}:{used:0,total:0,limit:0,supported:!1}}function Rt(){const a=navigator.userAgent,e=a.includes("Chrome")&&!a.includes("Edg"),t=a.includes("Firefox"),i=a.includes("Safari")&&!a.includes("Chrome"),s=a.includes("Edg");return{isChrome:e,isFirefox:t,isSafari:i,isEdge:s,devicePixelRatio:window.devicePixelRatio||1,userAgent:a}}const pe={enableForDrag(a){const e=Rt();a.style.willChange="left, top",a.style.pointerEvents="none",e.isChrome&&(a.style.transform="translateZ(0)"),e.isFirefox&&(a.style.backfaceVisibility="hidden")},cleanupAfterDrag(a){a.style.willChange="auto",a.style.pointerEvents="",a.style.transform="",a.style.backfaceVisibility=""}},J=Object.freeze({DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4}),Ot=Object.freeze({level:J.INFO,enableColors:!0,enableTimestamp:!0,enableStackTrace:!0,maxLogSize:1e3,enableConsole:!0,enableStorage:!1,storageKey:"chessboard-logs"}),Ve=Object.freeze({DEBUG:"\x1B[36m",INFO:"\x1B[32m",WARN:"\x1B[33m",ERROR:"\x1B[31m",RESET:"\x1B[0m"});class de{constructor(e={},t="Chessboard"){this.config={...Ot,...e},this.name=t,this.logs=[],this.startTime=Date.now(),this.debug=this._createLogMethod("DEBUG"),this.info=this._createLogMethod("INFO"),this.warn=this._createLogMethod("WARN"),this.error=this._createLogMethod("ERROR"),this.performances=new Map,this.config.enableStorage&&this._initStorage()}_createLogMethod(e){return(t,i={},s=null)=>{this._log(e,t,i,s)}}_log(e,t,i,s){if(J[e]<this.config.level)return;const r=this._createLogEntry(e,t,i,s);this._storeLogEntry(r),this.config.enableConsole&&this._outputToConsole(r),this.config.enableStorage&&this._storeInStorage(r)}_createLogEntry(e,t,i,s){const n={timestamp:new Date().toISOString(),level:e,logger:this.name,message:t,data:{...i},runtime:Date.now()-this.startTime};return s&&(n.error={name:s.name,message:s.message,stack:this.config.enableStackTrace?s.stack:null}),typeof performance<"u"&&performance.memory&&(n.memory={used:Math.round(performance.memory.usedJSHeapSize/1024/1024),total:Math.round(performance.memory.totalJSHeapSize/1024/1024)}),n}_storeLogEntry(e){this.logs.push(e),this.logs.length>this.config.maxLogSize&&this.logs.shift()}_outputToConsole(e){const t=this.config.enableColors?Ve[e.level]:"",i=this.config.enableColors?Ve.RESET:"",s=this.config.enableTimestamp?`[${new Date(e.timestamp).toLocaleTimeString()}] `:"",r=`${`${t}${s}[${e.logger}:${e.level}]${i}`} ${e.message}`,o=this._getConsoleMethod(e.level);Object.keys(e.data).length>0||e.error?o(r,{data:e.data,error:e.error,runtime:`${e.runtime}ms`}):o(r)}_getConsoleMethod(e){switch(e){case"DEBUG":return console.debug||console.log;case"INFO":return console.info||console.log;case"WARN":return console.warn||console.log;case"ERROR":return console.error||console.log;default:return console.log}}_initStorage(){if(typeof localStorage>"u"){this.config.enableStorage=!1;return}try{localStorage.setItem("test","test"),localStorage.removeItem("test")}catch{this.config.enableStorage=!1,console.warn("localStorage not available, disabling log storage")}}_storeInStorage(e){if(this.config.enableStorage)try{const t=JSON.parse(localStorage.getItem(this.config.storageKey)||"[]");t.push(e),t.length>this.config.maxLogSize&&t.shift(),localStorage.setItem(this.config.storageKey,JSON.stringify(t))}catch(t){console.warn("Failed to store log entry:",t)}}startPerformance(e){this.performances.set(e,{start:performance.now(),measurements:[]}),this.debug(`Started performance measurement: ${e}`)}endPerformance(e){const t=this.performances.get(e);if(!t)return this.warn(`Performance measurement not found: ${e}`),0;const i=performance.now()-t.start;return t.measurements.push(i),this.debug(`Performance measurement completed: ${e}`,{duration:`${i.toFixed(2)}ms`,measurements:t.measurements.length}),i}getPerformanceStats(e){const t=this.performances.get(e);if(!t||t.measurements.length===0)return null;const i=t.measurements,s=i.reduce((l,c)=>l+c,0),n=s/i.length,r=Math.min(...i),o=Math.max(...i);return{name:e,count:i.length,total:s.toFixed(2),average:n.toFixed(2),min:r.toFixed(2),max:o.toFixed(2)}}child(e){return new de(this.config,`${this.name}:${e}`)}setLevel(e){J[e]!==void 0&&(this.config.level=J[e])}getLevel(){return Object.keys(J).find(e=>J[e]===this.config.level)}getLogs(){return[...this.logs]}clearLogs(){if(this.logs=[],this.config.enableStorage)try{localStorage.removeItem(this.config.storageKey)}catch(e){console.warn("Failed to clear stored logs:",e)}}exportLogs(){return JSON.stringify(this.logs,null,2)}destroy(){this.clearLogs(),this.performances.clear()}}const v=new de;function At(a,e){return new de(a,e)}class Je{constructor(e,t,i,s,n){this.config=e,this.boardService=t,this.moveService=i,this.coordinateService=s,this.chessboard=n,this.clicked=null,this.isDragging=!1,this.isAnimating=!1,this.promoting=!1,this._isProcessingDrop=!1,this.eventListeners=new Map}addListeners(e,t,i){this.removeListeners();const s=this.boardService.getAllSquares();Object.values(s).forEach(n=>{this._addSquareListeners(n,e,t,i)})}_addSquareListeners(e,t,i,s){const n=[],r=Oe(c=>{!this.clicked&&this.config.hints&&i(e)}),o=Oe(c=>{!this.clicked&&this.config.hints&&s(e)}),l=c=>{c.stopPropagation(),this.config.clickable&&!this.isAnimating&&(e.piece&&e.piece._dragTimeout&&(clearTimeout(e.piece._dragTimeout),e.piece._dragTimeout=null),t(e))};e.element.addEventListener("mouseover",r),e.element.addEventListener("mouseout",o),e.element.addEventListener("click",l),e.element.addEventListener("touchstart",l),n.push({element:e.element,type:"mouseover",handler:r},{element:e.element,type:"mouseout",handler:o},{element:e.element,type:"click",handler:l},{element:e.element,type:"touchstart",handler:l}),this.eventListeners.set(e.id,n)}createDragFunction(e,t,i,s,n,r,o,l){return console.log("Creating drag function for:",e.id,t?`${t.color}${t.type}`:"null"),c=>{var I,F;if(c.preventDefault(),!this.config.draggable||!t||this.isAnimating||this.isDragging)return;this.isDragging=!0;const u=e;let d=!1;const h=u;let m=e,f=null;const g=t.element;if(!this.moveService.canMove(h))return;const b=c.clientX||c.touches&&((I=c.touches[0])==null?void 0:I.clientX)||0,w=c.clientY||c.touches&&((F=c.touches[0])==null?void 0:F.clientY)||0,y=A=>{const G=this.boardService.element,Q=G.offsetWidth/8;let ee,te;A.touches&&A.touches[0]?(ee=A.touches[0].clientX,te=A.touches[0].clientY):(ee=A.clientX,te=A.clientY);const ie=G.getBoundingClientRect(),Z=ee-ie.left-Q/2,se=te-ie.top-Q/2;return g.style.left=`${Z}px`,g.style.top=`${se}px`,!0},p=A=>{const G=A.clientX||0,Q=A.clientY||0,ee=Math.abs(G-b),te=Math.abs(Q-w);if(!d&&(ee>3||te>3)){d=!0,this.config.clickable&&h.select();const ne=window.getComputedStyle(g),mt=ne.width,gt=ne.height;if(g.style.position="absolute",g.style.zIndex="100",g.classList.add("dragging"),g.style.width=mt,g.style.height=gt,pe.enableForDrag(g),!i(e,t))return}if(!d)return;y(A);const ie=this.boardService.element,Z=ie.getBoundingClientRect(),se=A.clientX-Z.left,ye=A.clientY-Z.top;let Ne=null;if(se>=0&&se<=Z.width&&ye>=0&&ye<=Z.height){const ne=this.coordinateService.pixelToSquareID(se,ye,ie);Ne=ne?this.boardService.getSquare(ne):null}m=Ne,s(h,m,t),m!==f&&(m==null||m.highlight(),f==null||f.dehighlight(),f=m)},P=()=>{if(f==null||f.dehighlight(),document.removeEventListener("mousemove",p),window.removeEventListener("mouseup",P),g.removeEventListener("mouseup",P),!d)return;console.log("onMouseUp: Handling drag completion for piece at",u.id),g.style.zIndex="20",g.classList.remove("dragging"),g.style.willChange="auto",pe.cleanupAfterDrag(g),this.isDragging=!1,this.clicked,this.clicked=null;const A=n(u,m,t);!m&&(this.config.dropOffBoard==="trash"||A==="trash")?this._handleTrashDrop(u,l):m?this._handleDrop(u,m,t,o,r):(g.style.position="",g.style.left="",g.style.top="",g.style.transform="",g.style.width="",g.style.height="",pe.cleanupAfterDrag(g),this._handleSnapback(u,t,r),this._cleanupAfterFailedMove(u))};window.addEventListener("mouseup",P,{once:!0}),document.addEventListener("mousemove",p),g.addEventListener("mouseup",P,{once:!0})}}_handleTrashDrop(e,t){this.boardService.applyToAllSquares("unmoved"),this.boardService.applyToAllSquares("removeHint"),e.deselect(),this.clicked=null,t&&t(e.getId()),v.debug("EventService: Trash drop executed, state cleaned up")}_handleSnapback(e,t,i){e&&e.piece&&i&&i(e,t),v.debug("EventService: Snapback executed, cleaning up state")}_handleDrop(e,t,i,s,n){if(console.log("=== _handleDrop CALLED ==="),console.log("From:",e.id,"To:",t.id),console.log("Piece:",i?`${i.color}${i.type}`:"null"),console.log("Stack trace:",new Error().stack.split(`
`)[1]),console.log("Caller:",new Error().stack.split(`
`)[2]),this.isAnimating||this._isProcessingDrop){console.log("Drop ignored - already processing or animating");return}this._isProcessingDrop=!0;const r=()=>{this._isProcessingDrop=!1};try{this.moveService.requiresPromotion(new H(e,t))?(v.debug("Drag move requires promotion:",e.id,"->",t.id),this.moveService.setupPromotion(new H(e,t),this.boardService.squares,o=>{v.debug("Drag promotion selected:",o),this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover"),s(e,t,o,!0)?(this._schedulePromotionPieceReplacement(t,o),this._cleanupAfterSuccessfulMove(e)):(this._handleSnapback(e,i,n),this._cleanupAfterFailedMove(e)),r()},()=>{v.debug("Drag promotion cancelled"),this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover"),this._handleSnapback(e,i,n),this._cleanupAfterFailedMove(e),r()})):(s(e,t,null,!0)?this._cleanupAfterSuccessfulMove(e):(this._handleSnapback(e,i,n),this._cleanupAfterFailedMove(e)),r())}catch(o){console.error("Error in _handleDrop:",o),r()}}_cleanupAfterSuccessfulMove(e){this.clicked=null,this.isDragging=!1,e&&e.deselect(),this.boardService.applyToAllSquares("removeHint"),this.boardService.applyToAllSquares("dehighlight"),this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover"),v.debug("EventService: All visual state cleaned up after SUCCESSFUL move")}_cleanupAfterFailedMove(e){this.clicked=null,this.isDragging=!1,this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover"),this.boardService.applyToAllSquares("removeHint"),e&&e.deselect(),v.debug("EventService: Conservative cleanup after FAILED move")}_animatePieceToCenter(e,t,i=null){if(!e||!t){i&&i();return}const s=this.config.dropCenterTime,n=e.element.getBoundingClientRect(),r=t.element.getBoundingClientRect(),o=n.left+n.width/2,l=n.top+n.height/2,c=r.left+r.width/2,u=r.top+r.height/2,d=c-o,h=u-l;if(Math.abs(d)<1&&Math.abs(h)<1){e.element.style.position="",e.element.style.left="",e.element.style.top="",e.element.style.transform="",e.element.style.zIndex="",i&&i();return}const m=[{transform:"translate(0, 0)"},{transform:`translate(${d}px, ${h}px)`}];if(e.element.animate){const f=e.element.animate(m,{duration:s,easing:"ease",fill:"none"});f.onfinish=()=>{if(!e.element){i&&i();return}e.element.style.position="",e.element.style.left="",e.element.style.top="",e.element.style.transform="",e.element.style.zIndex="",e.element.style.transition="",i&&i()}}else e.element.style.transition=`transform ${s}ms ease`,e.element.style.transform=`translate(${d}px, ${h}px)`,setTimeout(()=>{if(!e.element){i&&i();return}e.element.style.position="relative",e.element.style.left="0",e.element.style.top="0",e.element.style.transform="translate(-50%, -50%)",e.element.style.zIndex="20",e.element.style.transition="none",i&&i()},s)}onClick(e,t,i,s,n=!0,r=!1){var u,d,h;if(this.isDragging=!1,this.isAnimating)return v.debug("EventService.onClick: Ignoring click during animation"),!1;v.debug("=== EventService.onClick START ==="),v.debug("EventService.onClick: square =",e.id,"clicked =",((u=this.clicked)==null?void 0:u.id)||"none","isAnimating =",this.isAnimating),v.debug("EventService.onClick: Square piece =",e.piece?`${e.piece.color}${e.piece.type}`:"empty"),v.debug("EventService.onClick: Clicked square piece =",(d=this.clicked)!=null&&d.piece?`${this.clicked.piece.color}${this.clicked.piece.type}`:this.clicked?"empty":"none");let o=this.clicked,l=null;return this.promoting&&(this.promoting==="none"?o=null:l=this.promoting,this.promoting=!1,this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover")),o?(v.debug("EventService.onClick: We have a source square:",o.id,"target:",e.id),this.clicked===e?(s(e),this.clicked=null,!1):!l&&this.moveService.requiresPromotion(new H(o,e))?(v.debug("Move requires promotion:",o.id,"->",e.id),this.moveService.setupPromotion(new H(o,e),this.boardService.squares,m=>{v.debug("Promotion selected:",m),this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover"),t(o,e,m,n)&&(this._schedulePromotionPieceReplacement(e,m),s(o),this.clicked=null)},()=>{v.debug("Promotion cancelled"),this.boardService.applyToAllSquares("removePromotion"),this.boardService.applyToAllSquares("removeCover"),s(o),this.clicked=null}),!1):(v.debug("EventService.onClick: Attempting move from",o.id,"to",e.id),v.debug("EventService.onClick: Current game state before move attempt"),t(o,e,l,n)?(v.debug("EventService.onClick: Move successful"),s(o),this.clicked=null,v.debug("=== EventService.onClick END (move successful) ==="),!0):(v.debug("EventService.onClick: Move failed from",o.id,"to",e.id,"- resetting state"),s(o),this.clicked=null,this.isDragging=!1,this.boardService.applyToAllSquares("removeHint"),this.moveService.canMove(e)?(v.debug("EventService.onClick: Can select new piece at",e.id),this.clicked=e,this.config.clickable&&(i(e),v.debug("EventService.onClick: New piece selected visually:",e.id)),v.debug("EventService.onClick: New piece selected at",e.id)):v.debug("EventService.onClick: Cannot select piece at",e.id,"- staying deselected"),v.debug("=== EventService.onClick END (move failed) ==="),!1))):(v.debug("EventService.onClick: No source square, checking if can move:",e.id),this.moveService.canMove(e)?(v.debug("EventService.onClick: Can move! Setting clicked to:",e.id),this.clicked=e,this.config.clickable&&(i(e),v.debug("EventService.onClick: Square selected visually:",e.id)),v.debug("EventService.onClick: After setting, clicked =",((h=this.clicked)==null?void 0:h.id)||"none"),!1):(v.debug("EventService.onClick: Cannot move square:",e.id),!1))}_schedulePromotionPieceReplacement(e,t){this.chessboard._isPromoting=!0,this._waitForPieceAndReplace(e,t,0)}_waitForPieceAndReplace(e,t,i){const n=this.boardService.getSquare(e.id);if(!n){v.warn("Target square not found:",e.id),this.chessboard._isPromoting=!1;return}if(n.piece&&n.piece.element){v.debug("Piece found on",e.id,"after",i,"attempts"),this._replacePromotionPiece(e,t),setTimeout(()=>{this.chessboard._isPromoting=!1,v.debug("Promotion protection ended"),this.chessboard._updateBoardPieces(!1)},400);return}i<20?setTimeout(()=>{this._waitForPieceAndReplace(e,t,i+1)},50):(v.warn("Failed to find piece for promotion after",20,"attempts"),this.chessboard._isPromoting=!1,this.chessboard._updateBoardPieces(!1))}_replacePromotionPiece(e,t){v.debug("Replacing piece on",e.id,"with",t);const i=this.boardService.getSquare(e.id);if(!i){v.debug("Target square not found:",e.id);return}const n=this.chessboard.positionService.getGame().get(i.id);if(!n){v.debug("No piece found in game state for",i.id);return}const r=i.piece;if(!r){v.warn("No piece found on target square for promotion");const c=t+n.color,u=this.chessboard.pieceService.getPiecePath(c),d=new he(n.color,t,u);i.putPiece(d);const h=this.chessboard._createDragFunction.bind(this.chessboard);d.setDrag(h(i,d)),v.debug("Created new promotion piece:",c,"on",i.id);return}const o=t+n.color,l=this.chessboard.pieceService.getPiecePath(o);v.debug("Transforming piece to:",o,"with path:",l),r.transformTo(t,l,300,()=>{const c=this.chessboard._createDragFunction.bind(this.chessboard);r.setDrag(c(i,r)),this.config.hints&&this.chessboard.moveService&&setTimeout(()=>{this.chessboard.moveService.clearCache()},100),v.debug("Successfully transformed piece on",i.id,"to",o)})}setClicked(e){this.clicked=e}getClicked(){return this.clicked}setPromoting(e){this.promoting=e}getPromoting(){return this.promoting}setAnimating(e){this.isAnimating=e}getAnimating(){return this.isAnimating}removeListeners(){this.eventListeners.forEach((e,t)=>{e.forEach(({element:i,type:s,handler:n})=>{i.removeEventListener(s,n)})}),this.eventListeners.clear()}removeAllListeners(){this.eventListeners.forEach((e,t)=>{e.forEach(({element:i,type:s,handler:n})=>{i.removeEventListener(s,n)})}),this.eventListeners.clear()}destroy(){this.removeAllListeners(),this.clicked=null,this.promoting=!1,this.isAnimating=!1,this.isDragging=!1}}class Xe{constructor(e,t){this.config=e,this.positionService=t,this._movesCache=new Map,this._cacheTimeout=null,this._lastPromotionCheck=null,this._lastPromotionResult=null,this._promotionCheckTimeout=null,this._recentMoves=new Set,this._recentMovesTimeout=null}canMove(e){if(!e.piece)return!1;const{movableColors:t,onlyLegalMoves:i}=this.config;if(t==="none"||t==="w"&&e.piece.color==="b"||t==="b"&&e.piece.color==="w")return!1;if(!i)return!0;if(!this.positionService||!this.positionService.getGame())return!1;const s=this.positionService.getGame();return e.piece.color===s.turn()}convertMove(e,t){if(e instanceof H)return e;if(typeof e=="string"&&e.length>=4){const i=e.slice(0,2),s=e.slice(2,4),n=e.slice(4,5)||null;if(!t[i]||!t[s])throw new Re(C.invalid_move_format,i,s);return new H(t[i],t[s],n)}throw new Re(C.invalid_move_format,"unknown","unknown")}isLegalMove(e){return this.getLegalMoves(e.from.id).some(i=>i.to===e.to.id&&e.promotion===i.promotion)}getLegalMoves(e=null,t=!0){if(!this.positionService||!this.positionService.getGame())return[];const i=this.positionService.getGame();if(!i)return[];const s={verbose:t};return e&&(s.square=e),i.moves(s)}getCachedLegalMoves(e){if(!this.positionService||!this.positionService.getGame())return[];const t=this.positionService.getGame();if(!t)return[];const i=`${e.id}-${t.fen()}`;let s=this._movesCache.get(i);return s||(s=t.moves({square:e.id,verbose:!0}),this._movesCache.set(i,s),this._cacheTimeout&&clearTimeout(this._cacheTimeout),this._cacheTimeout=setTimeout(()=>{this._movesCache.clear()},1e3)),s}executeMove(e){if(!this.positionService||!this.positionService.getGame())return null;const t=this.positionService.getGame();if(!t)return null;const i={from:e.from.id,to:e.to.id};console.log("executeMove - move.promotion:",e.promotion),console.log("executeMove - move.hasPromotion():",e.hasPromotion()),e.hasPromotion()&&(i.promotion=e.promotion),console.log("executeMove - moveOptions:",i);const s=t.move(i);if(console.log("executeMove - result:",s),s){const n=t.get(e.to.id);console.log("executeMove - piece on destination after move:",n)}return s}requiresPromotion(e){const t=`${e.from.id}->${e.to.id}`;console.log("Checking if move requires promotion:",t);const i=new Error().stack.split(`
`);console.log("Call stack:",i[1]),console.log("Caller:",i[2]),console.log("Caller 2:",i[3]),console.log("Caller 3:",i[4]);const s=Date.now();if(this._recentMoves.has(t))return console.log("Move recently processed, skipping duplicate check"),!1;if(this._lastPromotionCheck===t&&this._lastPromotionResult!==null&&s-this._lastPromotionTime<100)return console.log("Using cached promotion result:",this._lastPromotionResult),this._lastPromotionResult;this._recentMoves.add(t);const n=this._doRequiresPromotion(e);return this._lastPromotionCheck=t,this._lastPromotionResult=n,this._lastPromotionTime=s,this._promotionCheckTimeout&&clearTimeout(this._promotionCheckTimeout),this._promotionCheckTimeout=setTimeout(()=>{this._lastPromotionCheck=null,this._lastPromotionResult=null},500),this._recentMovesTimeout&&clearTimeout(this._recentMovesTimeout),this._recentMovesTimeout=setTimeout(()=>{this._recentMoves.clear()},1e3),n}_doRequiresPromotion(e){if(!this.config.onlyLegalMoves)return console.log("Not in legal moves mode, no promotion required"),!1;const t=this.positionService.getGame();if(!t)return console.log("No game instance available"),!1;const i=t.get(e.from.id);if(!i||i.type!=="p")return console.log("Not a pawn move, no promotion required"),!1;const s=e.to.row;if(s!==1&&s!==8)return console.log("Not reaching promotion rank, no promotion required"),!1;if(console.log("Pawn reaching promotion rank - promotion required"),!this._isPawnMoveValid(e.from,e.to,i.color))return console.log("Pawn move not valid, no promotion required"),!1;const r=t.moves({square:e.from.id,verbose:!0}).find(l=>l.to===e.to.id);if(!r)return console.log("Move not in legal moves list, no promotion required"),!1;const o=r.flags.includes("p")||i.color==="w"&&s===8||i.color==="b"&&s===1;return console.log("Promotion required:",o),o}_isPawnMoveValid(e,t,i){const s=e.row,n=t.row,r=e.col,o=t.col;console.log(`Validating pawn move: ${e.id} -> ${t.id} (${i})`),console.log(`Ranks: ${s} -> ${n}, Files: ${r} -> ${o}`);const l=i==="w"?1:-1,c=n-s,u=Math.abs(o-r);return c*l<=0?(console.log("Invalid: Pawn cannot move backward or stay in place"),!1):Math.abs(c)>2?(console.log("Invalid: Pawn cannot move more than 2 ranks"),!1):Math.abs(c)===2&&s!==(i==="w"?2:7)?(console.log(`Invalid: Pawn cannot move 2 ranks from rank ${s}`),!1):u>1?(console.log("Invalid: Pawn cannot move more than 1 file"),!1):(console.log("Pawn move validation passed"),!0)}setupPromotion(e,t,i,s){if(!this.requiresPromotion(e)||!this.positionService||!this.positionService.getGame())return!1;const r=this.positionService.getGame().get(e.from.id),o=e.to;return Object.values(t).forEach(l=>{l.removePromotion(),l.removeCover()}),this._showPromotionInColumn(o,r,t,i,s),!0}_showPromotionInColumn(e,t,i,s,n){return console.log("Setting up promotion for",e.id,"piece color:",t.color),Ke.forEach((r,o)=>{const l=this._findPromotionSquare(e,o,i);if(l){const c=r+t.color,u=this._getPiecePathForPromotion(c);console.log("Setting up promotion choice:",r,"on square:",l.id),l.putPromotion(u,()=>{console.log("Promotion choice selected:",r),s(r)})}else console.log("Could not find square for promotion choice:",r,"index:",o)}),Object.values(i).forEach(r=>{r.hasPromotion()||r.putCover(()=>{n()})}),!0}_findPromotionSquare(e,t,i){const s=e.col,n=e.row;console.log("Looking for promotion square - target:",e.id,"index:",t,"col:",s,"baseRow:",n);let r;if(n===8)r=8-t;else if(n===1)r=1+t;else return console.log("Invalid promotion row:",n),null;if(console.log("Calculated row:",r),r<1||r>8)return console.log("Row out of bounds:",r),null;for(const o of Object.values(i))if(o.col===s&&o.row===r)return console.log("Found promotion square:",o.id),o;return console.log("No square found for col:",s,"row:",r),null}_getPiecePathForPromotion(e){const{piecesPath:t}=this.config;return typeof t=="string"?`${t}/${e}.svg`:`assets/pieces/${e}.svg`}parseMove(e){if(typeof e!="string"||e.length<4||e.length>5)return null;const t=e.slice(0,2),i=e.slice(2,4),s=e.slice(4,5);return!/^[a-h][1-8]$/.test(t)||!/^[a-h][1-8]$/.test(i)||s&&!["q","r","b","n"].includes(s.toLowerCase())?null:{from:t,to:i,promotion:s||null}}isCastle(e){return e&&(e.isKingsideCastle()||e.isQueensideCastle())}getCastleRookMove(e){if(!this.isCastle(e))return null;const t=e.isKingsideCastle(),i=e.color==="w";return t?i?{from:"h1",to:"f1"}:{from:"h8",to:"f8"}:i?{from:"a1",to:"d1"}:{from:"a8",to:"d8"}}isEnPassant(e){return e&&e.isEnPassant()}getEnPassantCapturedSquare(e){if(!this.isEnPassant(e))return null;const t=e.to,i=parseInt(t[1]),s=t[0];return e.color==="w"?s+(i-1):s+(i+1)}clearCache(){this._movesCache.clear(),this._cacheTimeout&&(clearTimeout(this._cacheTimeout),this._cacheTimeout=null)}destroy(){this.clearCache(),this.positionService=null}}class Ze{constructor(e){this.config=e}getPiecePath(e){const{piecesPath:t}=this.config;if(typeof t=="string")return`${t}/${e}.svg`;if(typeof t=="object"&&t!==null)return t[e];if(typeof t=="function")return t(e);throw new k(C.invalid_piecesPath,"piecesPath",t)}convertPiece(e){if(e instanceof he)return e;if(typeof e=="string"&&e.length===2){const[t,i]=e.split("");let s,n;if(le.includes(t.toLowerCase())&&ce.includes(i))s=t.toLowerCase(),n=i;else if(ce.includes(t)&&le.includes(i.toLowerCase()))n=t,s=i.toLowerCase();else throw new ge(C.invalid_piece+e,e);const r=this.getPiecePath(s+n);return new he(n,s,r)}throw new ge(C.invalid_piece+e,e)}addPieceOnSquare(e,t,i=!0,s,n){console.debug(`[PieceService] addPieceOnSquare: ${t.id} to ${e.id}`),e.putPiece(t),s&&t.setDrag(s(e,t)),i&&this.config.fadeTime>0?t.fadeIn(this.config.fadeTime,this.config.fadeAnimation,this._getTransitionTimingFunction(),n):n&&n(),t.visible()}removePieceFromSquare(e,t=!0,i){console.debug(`[PieceService] removePieceFromSquare: ${e.id}`),e.check();const s=e.piece;if(!s)throw i&&i(),new ge(C.square_no_piece,null,e.getId());return t&&this.config.fadeTime>0?s.fadeOut(this.config.fadeTime,this.config.fadeAnimation,this._getTransitionTimingFunction(),i):i&&i(),e.removePiece(),s}movePiece(e,t,i,s){if(console.debug(`[PieceService] movePiece: ${e.id} to ${t.id}`),!e){console.warn("PieceService.movePiece: piece is null, skipping animation"),s&&s();return}e.translate(t,i,this._getTransitionTimingFunction(),this.config.moveAnimation,s)}translatePiece(e,t,i,s=null,n=null){if(console.debug(`[PieceService] translatePiece: ${e.piece.id} from ${e.from.id} to ${e.to.id}`),!e.piece){console.warn("PieceService.translatePiece: move.piece is null, skipping translation"),n&&n();return}t&&(e.to.deselect(),this.removePieceFromSquare(e.to,!1));const r=()=>{e.from.piece===e.piece&&e.from.removePiece(!0),e.to.piece!==e.piece&&(e.to.putPiece(e.piece),s&&this.config.draggable&&e.piece.element&&e.piece.setDrag(s(e.to,e.piece))),n&&n()};if(e.piece.element.classList.contains("dragging"))r();else{const l=i?this.config.moveTime:0;this.movePiece(e.piece,e.to,l,r)}}snapbackPiece(e,t=!0){if(!e||!e.piece)return;const i=e.piece,s=t?this.config.snapbackTime:0;console.debug(`[PieceService] snapbackPiece: ${i.id} on ${e.id}`),i.translate(e,s,this._getTransitionTimingFunction(),this.config.snapbackAnimation)}centerPiece(e,t=!0){if(!e||!e.piece)return;const i=e.piece,s=t?this.config.dropCenterTime:0;console.debug(`[PieceService] centerPiece: ${i.id} on ${e.id}`),i.translate(e,s,this._getTransitionTimingFunction(),this.config.dropCenterAnimation,()=>{i.element&&(i.element.style.position="",i.element.style.left="",i.element.style.top="",i.element.style.transform="",i.element.style.zIndex="",i.element.style.width="",i.element.style.height="",i.element.classList.remove("dragging"),pe.cleanupAfterDrag(i.element))})}_getTransitionTimingFunction(){return(e,t,i="ease")=>{const s=e/t;switch(i){case"linear":return s;case"ease":return s**2*(3-2*s);case"ease-in":return s**2;case"ease-out":return-1*(s-1)**2+1;case"ease-in-out":return s<.5?2*s**2:4*s-2*s**2-1;default:return s}}}destroy(){}}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const L="w",B="b",R="p",Ae="n",ve="b",re="r",W="q",T="k",Pe="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class fe{constructor(e,t){E(this,"color");E(this,"from");E(this,"to");E(this,"piece");E(this,"captured");E(this,"promotion");E(this,"flags");E(this,"san");E(this,"lan");E(this,"before");E(this,"after");const{color:i,piece:s,from:n,to:r,flags:o,captured:l,promotion:c}=t,u=D(n),d=D(r);this.color=i,this.piece=s,this.from=u,this.to=d,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=u+d,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="";for(const h in S)S[h]&o&&(this.flags+=Y[h]);l&&(this.captured=l),c&&(this.promotion=c,this.lan+=c)}isCapture(){return this.flags.indexOf(Y.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(Y.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(Y.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(Y.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(Y.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(Y.BIG_PAWN)>-1}}const $=-1,Y={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},S={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},_={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},we={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ge={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Mt=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],qt=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Lt={p:1,n:2,b:4,r:8,q:16,k:32},Dt="pnbrqkPNBRQK",je=[Ae,ve,re,W],$t=7,Ft=6,Nt=1,xt=0,me={[T]:S.KSIDE_CASTLE,[W]:S.QSIDE_CASTLE},K={w:[{square:_.a1,flag:S.QSIDE_CASTLE},{square:_.h1,flag:S.KSIDE_CASTLE}],b:[{square:_.a8,flag:S.QSIDE_CASTLE},{square:_.h8,flag:S.KSIDE_CASTLE}]},Bt={b:Nt,w:Ft},Vt=["1-0","0-1","1/2-1/2","*"];function X(a){return a>>4}function ue(a){return a&15}function et(a){return"0123456789".indexOf(a)!==-1}function D(a){const e=ue(a),t=X(a);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function oe(a){return a===L?B:L}function Le(a){const e=a.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const i=parseInt(e[4],10);if(isNaN(i)||i<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const s=e[0].split("/");if(s.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let r=0;r<s.length;r++){let o=0,l=!1;for(let c=0;c<s[r].length;c++)if(et(s[r][c])){if(l)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(s[r][c],10),l=!0}else{if(!/^[prnbqkPRNBQK]$/.test(s[r][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,l=!1}if(o!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:r,regex:o}of n){if(!o.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${r} king`};if((e[0].match(o)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${r} kings`}}return Array.from(s[0]+s[7]).some(r=>r.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Gt(a,e){const t=a.from,i=a.to,s=a.piece;let n=0,r=0,o=0;for(let l=0,c=e.length;l<c;l++){const u=e[l].from,d=e[l].to,h=e[l].piece;s===h&&t!==u&&i===d&&(n++,X(t)===X(u)&&r++,ue(t)===ue(u)&&o++)}return n>0?r>0&&o>0?D(t):o>0?D(t).charAt(1):D(t).charAt(0):""}function U(a,e,t,i,s,n=void 0,r=S.NORMAL){const o=X(i);if(s===R&&(o===$t||o===xt))for(let l=0;l<je.length;l++){const c=je[l];a.push({color:e,from:t,to:i,piece:s,captured:n,promotion:c,flags:r|S.PROMOTION})}else a.push({color:e,from:t,to:i,piece:s,captured:n,flags:r})}function ze(a){let e=a.charAt(0);return e>="a"&&e<="h"?a.match(/[a-h]\d.*[a-h]\d/)?void 0:R:(e=e.toLowerCase(),e==="o"?T:e)}function Ee(a){return a.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function ke(a){return a.split(" ").slice(0,4).join(" ")}class tt{constructor(e=Pe){E(this,"_board",new Array(128));E(this,"_turn",L);E(this,"_header",{});E(this,"_kings",{w:$,b:$});E(this,"_epSquare",-1);E(this,"_halfMoves",0);E(this,"_moveNumber",0);E(this,"_history",[]);E(this,"_comments",{});E(this,"_castling",{w:0,b:0});E(this,"_positionCount",{});this.load(e)}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:$,b:$},this._turn=L,this._castling={w:0,b:0},this._epSquare=$,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{},this._positionCount={},delete this._header.SetUp,delete this._header.FEN}load(e,{skipValidation:t=!1,preserveHeaders:i=!1}={}){let s=e.split(/\s+/);if(s.length>=2&&s.length<6){const o=["-","-","0","1"];e=s.concat(o.slice(-(6-s.length))).join(" ")}if(s=e.split(/\s+/),!t){const{ok:o,error:l}=Le(e);if(!o)throw new Error(l)}const n=s[0];let r=0;this.clear({preserveHeaders:i});for(let o=0;o<n.length;o++){const l=n.charAt(o);if(l==="/")r+=8;else if(et(l))r+=parseInt(l,10);else{const c=l<"a"?L:B;this._put({type:l.toLowerCase(),color:c},D(r)),r++}}this._turn=s[1],s[2].indexOf("K")>-1&&(this._castling.w|=S.KSIDE_CASTLE),s[2].indexOf("Q")>-1&&(this._castling.w|=S.QSIDE_CASTLE),s[2].indexOf("k")>-1&&(this._castling.b|=S.KSIDE_CASTLE),s[2].indexOf("q")>-1&&(this._castling.b|=S.QSIDE_CASTLE),this._epSquare=s[3]==="-"?$:_[s[3]],this._halfMoves=parseInt(s[4],10),this._moveNumber=parseInt(s[5],10),this._updateSetup(e),this._incPositionCount(e)}fen(){var n,r;let e=0,t="";for(let o=_.a8;o<=_.h1;o++){if(this._board[o]){e>0&&(t+=e,e=0);const{color:l,type:c}=this._board[o];t+=l===L?c.toUpperCase():c.toLowerCase()}else e++;o+1&136&&(e>0&&(t+=e),o!==_.h1&&(t+="/"),e=0,o+=8)}let i="";this._castling[L]&S.KSIDE_CASTLE&&(i+="K"),this._castling[L]&S.QSIDE_CASTLE&&(i+="Q"),this._castling[B]&S.KSIDE_CASTLE&&(i+="k"),this._castling[B]&S.QSIDE_CASTLE&&(i+="q"),i=i||"-";let s="-";if(this._epSquare!==$){const o=this._epSquare+(this._turn===L?16:-16),l=[o+1,o-1];for(const c of l){if(c&136)continue;const u=this._turn;if(((n=this._board[c])==null?void 0:n.color)===u&&((r=this._board[c])==null?void 0:r.type)===R){this._makeMove({color:u,from:c,to:this._epSquare,piece:R,captured:R,flags:S.EP_CAPTURE});const d=!this._isKingAttacked(u);if(this._undoMove(),d){s=D(this._epSquare);break}}}}return[t,this._turn,i,s,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==Pe?(this._header.SetUp="1",this._header.FEN=e):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(Pe)}get(e){return this._board[_[e]]}put({type:e,color:t},i){return this._put({type:e,color:t},i)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:e,color:t},i){if(Dt.indexOf(e.toLowerCase())===-1||!(i in _))return!1;const s=_[i];if(e==T&&!(this._kings[t]==$||this._kings[t]==s))return!1;const n=this._board[s];return n&&n.type===T&&(this._kings[n.color]=$),this._board[s]={type:e,color:t},e===T&&(this._kings[t]=s),!0}remove(e){const t=this.get(e);return delete this._board[_[e]],t&&t.type===T&&(this._kings[t.color]=$),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){var i,s,n,r,o,l,c,u,d,h,m,f;const e=((i=this._board[_.e1])==null?void 0:i.type)===T&&((s=this._board[_.e1])==null?void 0:s.color)===L,t=((n=this._board[_.e8])==null?void 0:n.type)===T&&((r=this._board[_.e8])==null?void 0:r.color)===B;(!e||((o=this._board[_.a1])==null?void 0:o.type)!==re||((l=this._board[_.a1])==null?void 0:l.color)!==L)&&(this._castling.w&=-65),(!e||((c=this._board[_.h1])==null?void 0:c.type)!==re||((u=this._board[_.h1])==null?void 0:u.color)!==L)&&(this._castling.w&=-33),(!t||((d=this._board[_.a8])==null?void 0:d.type)!==re||((h=this._board[_.a8])==null?void 0:h.color)!==B)&&(this._castling.b&=-65),(!t||((m=this._board[_.h8])==null?void 0:m.type)!==re||((f=this._board[_.h8])==null?void 0:f.color)!==B)&&(this._castling.b&=-33)}_updateEnPassantSquare(){var n,r;if(this._epSquare===$)return;const e=this._epSquare+(this._turn===L?-16:16),t=this._epSquare+(this._turn===L?16:-16),i=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||((n=this._board[t])==null?void 0:n.color)!==oe(this._turn)||((r=this._board[t])==null?void 0:r.type)!==R){this._epSquare=$;return}const s=o=>{var l,c;return!(o&136)&&((l=this._board[o])==null?void 0:l.color)===this._turn&&((c=this._board[o])==null?void 0:c.type)===R};i.some(s)||(this._epSquare=$)}_attacked(e,t,i){const s=[];for(let n=_.a8;n<=_.h1;n++){if(n&136){n+=7;continue}if(this._board[n]===void 0||this._board[n].color!==e)continue;const r=this._board[n],o=n-t;if(o===0)continue;const l=o+119;if(Mt[l]&Lt[r.type]){if(r.type===R){if(o>0&&r.color===L||o<=0&&r.color===B){if(!i)return!0;s.push(D(n))}continue}if(r.type==="n"||r.type==="k"){if(!i)return!0;s.push(D(n));continue}const c=qt[l];let u=n+c,d=!1;for(;u!==t;){if(this._board[u]!=null){d=!0;break}u+=c}if(!d){if(!i)return!0;s.push(D(n));continue}}}return i?s:!1}attackers(e,t){return t?this._attacked(t,_[e],!0):this._attacked(this._turn,_[e],!0)}_isKingAttacked(e){const t=this._kings[e];return t===-1?!1:this._attacked(oe(e),t)}isAttacked(e,t){return this._attacked(t,_[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let i=0,s=0;for(let n=_.a8;n<=_.h1;n++){if(s=(s+1)%2,n&136){n+=7;continue}const r=this._board[n];r&&(e[r.type]=r.type in e?e[r.type]+1:1,r.type===ve&&t.push(s),i++)}if(i===2)return!0;if(i===3&&(e[ve]===1||e[Ae]===1))return!0;if(i===e[ve]+2){let n=0;const r=t.length;for(let o=0;o<r;o++)n+=t[o];if(n===0||n===r)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:i=void 0}={}){const s=this._moves({square:t,piece:i});return e?s.map(n=>new fe(this,n)):s.map(n=>this._moveToSan(n,s))}_moves({legal:e=!0,piece:t=void 0,square:i=void 0}={}){var m;const s=i?i.toLowerCase():void 0,n=t==null?void 0:t.toLowerCase(),r=[],o=this._turn,l=oe(o);let c=_.a8,u=_.h1,d=!1;if(s){if(!(s in _))return[];c=u=_[s],d=!0}for(let f=c;f<=u;f++){if(f&136){f+=7;continue}if(!this._board[f]||this._board[f].color===l)continue;const{type:g}=this._board[f];let b;if(g===R){if(n&&n!==g)continue;b=f+we[o][0],this._board[b]||(U(r,o,f,b,R),b=f+we[o][1],Bt[o]===X(f)&&!this._board[b]&&U(r,o,f,b,R,void 0,S.BIG_PAWN));for(let w=2;w<4;w++)b=f+we[o][w],!(b&136)&&(((m=this._board[b])==null?void 0:m.color)===l?U(r,o,f,b,R,this._board[b].type,S.CAPTURE):b===this._epSquare&&U(r,o,f,b,R,R,S.EP_CAPTURE))}else{if(n&&n!==g)continue;for(let w=0,y=Ge[g].length;w<y;w++){const p=Ge[g][w];for(b=f;b+=p,!(b&136);){if(!this._board[b])U(r,o,f,b,g);else{if(this._board[b].color===o)break;U(r,o,f,b,g,this._board[b].type,S.CAPTURE);break}if(g===Ae||g===T)break}}}}if((n===void 0||n===T)&&(!d||u===this._kings[o])){if(this._castling[o]&S.KSIDE_CASTLE){const f=this._kings[o],g=f+2;!this._board[f+1]&&!this._board[g]&&!this._attacked(l,this._kings[o])&&!this._attacked(l,f+1)&&!this._attacked(l,g)&&U(r,o,this._kings[o],g,T,void 0,S.KSIDE_CASTLE)}if(this._castling[o]&S.QSIDE_CASTLE){const f=this._kings[o],g=f-2;!this._board[f-1]&&!this._board[f-2]&&!this._board[f-3]&&!this._attacked(l,this._kings[o])&&!this._attacked(l,f-1)&&!this._attacked(l,g)&&U(r,o,this._kings[o],g,T,void 0,S.QSIDE_CASTLE)}}if(!e||this._kings[o]===-1)return r;const h=[];for(let f=0,g=r.length;f<g;f++)this._makeMove(r[f]),this._isKingAttacked(o)||h.push(r[f]),this._undoMove();return h}move(e,{strict:t=!1}={}){let i=null;if(typeof e=="string")i=this._moveFromSan(e,t);else if(typeof e=="object"){const n=this._moves();for(let r=0,o=n.length;r<o;r++)if(e.from===D(n[r].from)&&e.to===D(n[r].to)&&(!("promotion"in n[r])||e.promotion===n[r].promotion)){i=n[r];break}}if(!i)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);const s=new fe(this,i);return this._makeMove(i),this._incPositionCount(s.after),s}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){const t=this._turn,i=oe(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&S.EP_CAPTURE&&(this._turn===B?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===T){if(this._kings[t]=e.to,e.flags&S.KSIDE_CASTLE){const s=e.to-1,n=e.to+1;this._board[s]=this._board[n],delete this._board[n]}else if(e.flags&S.QSIDE_CASTLE){const s=e.to+1,n=e.to-2;this._board[s]=this._board[n],delete this._board[n]}this._castling[t]=0}if(this._castling[t]){for(let s=0,n=K[t].length;s<n;s++)if(e.from===K[t][s].square&&this._castling[t]&K[t][s].flag){this._castling[t]^=K[t][s].flag;break}}if(this._castling[i]){for(let s=0,n=K[i].length;s<n;s++)if(e.to===K[i][s].square&&this._castling[i]&K[i][s].flag){this._castling[i]^=K[i][s].flag;break}}e.flags&S.BIG_PAWN?t===B?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=$,e.piece===R?this._halfMoves=0:e.flags&(S.CAPTURE|S.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===B&&this._moveNumber++,this._turn=i}undo(){const e=this._undoMove();if(e){const t=new fe(this,e);return this._decPositionCount(t.after),t}return null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;const i=this._turn,s=oe(i);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&S.EP_CAPTURE){let n;i===B?n=t.to-16:n=t.to+16,this._board[n]={type:R,color:s}}else this._board[t.to]={type:t.captured,color:s};if(t.flags&(S.KSIDE_CASTLE|S.QSIDE_CASTLE)){let n,r;t.flags&S.KSIDE_CASTLE?(n=t.to+1,r=t.to-1):(n=t.to-2,r=t.to+1),this._board[n]=this._board[r],delete this._board[r]}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){const i=[];let s=!1;for(const h in this._header)i.push(`[${h} "${this._header[h]}"]${e}`),s=!0;s&&this._history.length&&i.push(e);const n=h=>{const m=this._comments[this.fen()];if(typeof m<"u"){const f=h.length>0?" ":"";h=`${h}${f}{${m}}`}return h},r=[];for(;this._history.length>0;)r.push(this._undoMove());const o=[];let l="";for(r.length===0&&o.push(n(""));r.length>0;){l=n(l);const h=r.pop();if(!h)break;if(!this._history.length&&h.color==="b"){const m=`${this._moveNumber}. ...`;l=l?`${l} ${m}`:m}else h.color==="w"&&(l.length&&o.push(l),l=`${this._moveNumber}.`);l=`${l} ${this._moveToSan(h,this._moves({legal:!0}))}`,this._makeMove(h)}if(l.length&&o.push(n(l)),typeof this._header.Result<"u"&&o.push(this._header.Result),t===0)return i.join("")+o.join(" ");const c=function(){return i.length>0&&i[i.length-1]===" "?(i.pop(),!0):!1},u=function(h,m){for(const f of m.split(" "))if(f){if(h+f.length>t){for(;c();)h--;i.push(e),h=0}i.push(f),h+=f.length,i.push(" "),h++}return c()&&h--,h};let d=0;for(let h=0;h<o.length;h++){if(d+o[h].length>t&&o[h].includes("{")){d=u(d,o[h]);continue}d+o[h].length>t&&h!==0?(i[i.length-1]===" "&&i.pop(),i.push(e),d=0):h!==0&&(i.push(" "),d++),i.push(o[h]),d+=o[h].length}return i.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t,this._header}removeHeader(e){return e in this._header?(delete this._header[e],!0):!1}getHeaders(){return this._header}loadPgn(e,{strict:t=!1,newlineChar:i=`\r?
`}={}){function s(p){return p.replace(/\\/g,"\\")}function n(p){const P={},I=p.split(new RegExp(s(i)));let F="",A="";for(let G=0;G<I.length;G++){const Q=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;F=I[G].replace(Q,"$1"),A=I[G].replace(Q,"$2"),F.trim().length>0&&(P[F]=A)}return P}e=e.trim();const o=new RegExp(`^(\\[((?:${s(i)})|.)*\\])((?:\\s*${s(i)}){2}|(?:\\s*${s(i)})*$)`).exec(e),l=o&&o.length>=2?o[1]:"";this.reset();const c=n(l);let u="";for(const p in c)p.toLowerCase()==="fen"&&(u=c[p]),this.header(p,c[p]);if(!t)u&&this.load(u,{preserveHeaders:!0});else if(c.SetUp==="1"){if(!("FEN"in c))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(c.FEN,{preserveHeaders:!0})}function d(p){return Array.from(p).map(P=>P.charCodeAt(0)<128?P.charCodeAt(0).toString(16):encodeURIComponent(P).replace(/%/g,"").toLowerCase()).join("")}function h(p){return p.length==0?"":decodeURIComponent(`%${(p.match(/.{1,2}/g)||[]).join("%")}`)}const m=function(p){return p=p.replace(new RegExp(s(i),"g")," "),`{${d(p.slice(1,p.length-1))}}`},f=function(p){if(p.startsWith("{")&&p.endsWith("}"))return h(p.slice(1,p.length-1))};let g=e.replace(l,"").replace(new RegExp(`({[^}]*})+?|;([^${s(i)}]*)`,"g"),(p,P,I)=>P!==void 0?m(P):` ${m(`{${I.slice(1)}}`)}`).replace(new RegExp(s(i),"g")," ");const b=/(\([^()]+\))+?/g;for(;b.test(g);)g=g.replace(b,"");g=g.replace(/\d+\.(\.\.)?/g,""),g=g.replace(/\.\.\./g,""),g=g.replace(/\$\d+/g,"");let w=g.trim().split(new RegExp(/\s+/));w=w.filter(p=>p!=="");let y="";for(let p=0;p<w.length;p++){const P=f(w[p]);if(P!==void 0){this._comments[this.fen()]=P;continue}const I=this._moveFromSan(w[p],t);if(I==null)if(Vt.indexOf(w[p])>-1)y=w[p];else throw new Error(`Invalid move in PGN: ${w[p]}`);else y="",this._makeMove(I),this._incPositionCount(this.fen())}y&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",y)}_moveToSan(e,t){let i="";if(e.flags&S.KSIDE_CASTLE)i="O-O";else if(e.flags&S.QSIDE_CASTLE)i="O-O-O";else{if(e.piece!==R){const s=Gt(e,t);i+=e.piece.toUpperCase()+s}e.flags&(S.CAPTURE|S.EP_CAPTURE)&&(e.piece===R&&(i+=D(e.from)[0]),i+="x"),i+=D(e.to),e.promotion&&(i+=`=${e.promotion.toUpperCase()}`)}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?i+="#":i+="+"),this._undoMove(),i}_moveFromSan(e,t=!1){const i=Ee(e);let s=ze(i),n=this._moves({legal:!0,piece:s});for(let h=0,m=n.length;h<m;h++)if(i===Ee(this._moveToSan(n[h],n)))return n[h];if(t)return null;let r,o,l,c,u,d=!1;if(o=i.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),o?(r=o[1],l=o[2],c=o[3],u=o[4],l.length==1&&(d=!0)):(o=i.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),o&&(r=o[1],l=o[2],c=o[3],u=o[4],l.length==1&&(d=!0))),s=ze(i),n=this._moves({legal:!0,piece:r||s}),!c)return null;for(let h=0,m=n.length;h<m;h++)if(l){if((!r||r.toLowerCase()==n[h].piece)&&_[l]==n[h].from&&_[c]==n[h].to&&(!u||u.toLowerCase()==n[h].promotion))return n[h];if(d){const f=D(n[h].from);if((!r||r.toLowerCase()==n[h].piece)&&_[c]==n[h].to&&(l==f[0]||l==f[1])&&(!u||u.toLowerCase()==n[h].promotion))return n[h]}}else if(i===Ee(this._moveToSan(n[h],n)).replace("x",""))return n[h];return null}ascii(){let e=`   +------------------------+
`;for(let t=_.a8;t<=_.h1;t++){if(ue(t)===0&&(e+=` ${"87654321"[X(t)]} |`),this._board[t]){const i=this._board[t].type,n=this._board[t].color===L?i.toUpperCase():i.toLowerCase();e+=` ${n} `}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let i=0;const s=this._turn;for(let n=0,r=t.length;n<r;n++)this._makeMove(t[n]),this._isKingAttacked(s)||(e-1>0?i+=this.perft(e-1):i++),this._undoMove();return i}turn(){return this._turn}board(){const e=[];let t=[];for(let i=_.a8;i<=_.h1;i++)this._board[i]==null?t.push(null):t.push({square:D(i),type:this._board[i].type,color:this._board[i].color}),i+1&136&&(e.push(t),t=[],i+=8);return e}squareColor(e){if(e in _){const t=_[e];return(X(t)+ue(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],i=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const s=t.pop();if(!s)break;e?i.push(new fe(this,s)):i.push(this._moveToSan(s,this._moves())),this._makeMove(s)}return i}_getPositionCount(e){const t=ke(e);return this._positionCount[t]||0}_incPositionCount(e){const t=ke(e);this._positionCount[t]===void 0&&(this._positionCount[t]=0),this._positionCount[t]+=1}_decPositionCount(e){const t=ke(e);this._positionCount[t]===1?delete this._positionCount[t]:this._positionCount[t]-=1}_pruneComments(){const e=[],t={},i=s=>{s in this._comments&&(t[s]=this._comments[s])};for(;this._history.length>0;)e.push(this._undoMove());for(i(this.fen());;){const s=e.pop();if(!s)break;this._makeMove(s),i(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(const s of[T,W])t[s]!==void 0&&(t[s]?this._castling[e]|=me[s]:this._castling[e]&=~me[s]);this._updateCastlingRights();const i=this.getCastlingRights(e);return(t[T]===void 0||t[T]===i[T])&&(t[W]===void 0||t[W]===i[W])}getCastlingRights(e){return{[T]:(this._castling[e]&me[T])!==0,[W]:(this._castling[e]&me[W])!==0}}moveNumber(){return this._moveNumber}}class it{constructor(e){this.config=e,this.game=null}convertFen(e){if(typeof e=="string")return this._convertStringPosition(e);if(typeof e=="object"&&e!==null)return this._convertObjectPosition(e);throw new k(C.invalid_position+e,"position",e)}_convertStringPosition(e){if(e==="start")return He;if(this.validateFen(e))return e;if(Te[e])return Te[e];throw new k(C.invalid_position+e,"position",e)}_convertObjectPosition(e){const t=[];for(let i=0;i<8;i++){const s=[];let n=0;for(let r=0;r<8;r++){const o=this._getSquareID(i,r),l=e[o];if(l){n>0&&(s.push(n),n=0);const c=l[1]==="w"?l[0].toUpperCase():l[0].toLowerCase();s.push(c)}else n++}n>0&&s.push(n),t.push(s.join(""))}return`${t.join("/")} w KQkq - 0 1`}setGame(e,t={}){const i=this.convertFen(e);this.game?this.game.load(i,t):this.game=new tt(i)}getGame(){return this.game}validateFen(e){return Le(e)}getGamePieceId(e){if(!this.game)return null;const t=this.game.get(e);return t?t.color+t.type:null}isPiece(e,t){return this.getGamePieceId(t)===e}_getSquareID(e,t){return e=parseInt(e),t=parseInt(t),this.config.orientation==="w"?(e=8-e,t=t+1):(e=e+1,t=8-t),ae[t-1]+e}changeFenTurn(e,t){const i=e.split(" ");return i[1]=t,i.join(" ")}getPosition(){const e={},t=this.getGame(),i=["a1","b1","c1","d1","e1","f1","g1","h1","a2","b2","c2","d2","e2","f2","g2","h2","a3","b3","c3","d3","e3","f3","g3","h3","a4","b4","c4","d4","e4","f4","g4","h4","a5","b5","c5","d5","e5","f5","g5","h5","a6","b6","c6","d6","e6","f6","g6","h6","a7","b7","c7","d7","e7","f7","g7","h7","a8","b8","c8","d8","e8","f8","g8","h8"];for(const s of i){const n=t.get(s);n&&(e[s]=n.type+n.color)}return e}changeFenColor(e){const t=e.split(" ");return t[1]=t[1]==="w"?"b":"w",t.join(" ")}destroy(){this.game=null}}let Se=class{constructor(e){try{this._performanceMonitor=new qe,this._performanceMonitor.startMeasure("chessboard-initialization"),this._validateAndInitializeConfig(e),this._initializeServices(),this._initialize(),this._performanceMonitor.endMeasure("chessboard-initialization")}catch(t){this._handleConstructorError(t)}this._undoneMoves=[],this._updateBoardPieces(!0,!0)}_validateAndInitializeConfig(e){if(!e||typeof e!="object")throw new q("Configuration must be an object","config",e);if(this.config=new Me(e),!this.config.id_div)throw new q("Configuration must include id_div","id_div",this.config.id_div)}_handleConstructorError(e){throw console.error("Chessboard initialization failed:",e),this._cleanup(),e instanceof V?e:new V("Failed to initialize chessboard","INITIALIZATION_ERROR",{originalError:e.message,stack:e.stack})}_cleanup(){this.eventService&&typeof this.eventService.removeListeners=="function"&&this.eventService.removeListeners(),this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null),this.validationService=null,this.coordinateService=null,this.positionService=null,this.boardService=null,this.pieceService=null,this.animationService=null,this.moveService=null,this.eventService=null}_initializeServices(){this.validationService=new be,this.coordinateService=new Ye(this.config),this.positionService=new it(this.config),this.boardService=new Qe(this.config),this.pieceService=new Ze(this.config),this.animationService=new We(this.config),this.moveService=new Xe(this.config,this.positionService),this.eventService=new Je(this.config,this.boardService,this.moveService,this.coordinateService,this),this._updateTimeout=null,this._isAnimating=!1,this._boundUpdateBoardPieces=this._updateBoardPieces.bind(this),this._boundOnSquareClick=this._onSquareClick.bind(this),this._boundOnPieceHover=this._onPieceHover.bind(this),this._boundOnPieceLeave=this._onPieceLeave.bind(this)}_initialize(){this._initParams(),this._setGame(this.config.position),this._buildBoard(),this._buildSquares(),this._addListeners(),this._updateBoardPieces(!0,!0)}_initParams(){this.eventService.setClicked(null),this.eventService.setPromoting(!1),this.eventService.setAnimating(!1)}_setGame(e){this.positionService.setGame(e)}_buildBoard(){if(this._isUndoRedo)return;const e=document.getElementById(this.config.id_div);e&&(e.innerHTML=""),this.boardService&&this.boardService.squares&&Object.values(this.boardService.squares).forEach(t=>t&&t.forceRemoveAllPieces&&t.forceRemoveAllPieces()),this.boardService&&this.boardService.removeSquares&&this.boardService.removeSquares(),this.boardService&&this.boardService.removeBoard&&this.boardService.removeBoard(),this.boardService.buildBoard()}_buildSquares(){this._isUndoRedo||(this.boardService&&this.boardService.removeSquares&&this.boardService.removeSquares(),this.boardService.buildSquares((e,t)=>this.coordinateService.realCoord(e,t)))}_addListeners(){this.eventService.addListeners(this._boundOnSquareClick,this._boundOnPieceHover,this._boundOnPieceLeave)}_onSquareClick(e,t=!0,i=!1){return this.eventService.onClick(e,this._onMove.bind(this),this._onSelect.bind(this),this._onDeselect.bind(this),t,i)}_onPieceHover(e){this.config.hints&&!this.eventService.getClicked()&&this._hintMoves(e)}_onPieceLeave(e){this.config.hints&&!this.eventService.getClicked()&&this._dehintMoves(e)}_onMove(e,t,i=null,s=!0){const n=new H(e,t,i);return!n.check()||this.config.onlyLegalMoves&&!n.isLegal(this.positionService.getGame())?(this._clearVisualState(),!1):!n.hasPromotion()&&this._requiresPromotion(n)?!1:this.config.onMove(n)?(this._executeMove(n,s),!0):(this._clearVisualState(),!1)}_onSelect(e){this.config.clickable&&(e.select(),this._hintMoves(e))}_onDeselect(e){this._clearVisualState()}_hintMoves(e){if(!this.moveService.canMove(e))return;this.boardService.applyToAllSquares("removeHint");const t=this.moveService.getCachedLegalMoves(e);for(const i of t)if(i.to&&i.to.length===2){const s=this.boardService.getSquare(i.to);if(s){const n=s.piece&&s.piece.color!==this.positionService.getGame().turn();s.putHint(n)}}}_dehintMoves(e){const t=this.moveService.getCachedLegalMoves(e);for(const i of t)if(i.to&&i.to.length===2){const s=this.boardService.getSquare(i.to);s&&s.removeHint()}}_requiresPromotion(e){return this.moveService.requiresPromotion(e)}_executeMove(e,t=!0){if(this._clearVisualState(),!this.positionService.getGame())throw new V("Game not initialized","GAME_ERROR");const s=this.moveService.executeMove(e);if(!s){console.error("Move execution failed unexpectedly for move:",e),this._updateBoardPieces(!1);return}this.boardService.applyToAllSquares("unmoved"),e.from.moved(),e.to.moved();const n=this.moveService.isCastle(s),r=this.moveService.isEnPassant(s);t&&e.from.piece?(this.pieceService.translatePiece(e,!!e.to.piece,t,this._createDragFunction.bind(this),()=>{n?this._handleSpecialMoveAnimation(s):r&&this._handleSpecialMoveAnimation(s),this.config.onMoveEnd(s),this._updateBoardPieces(!1)}),n&&this.config.animationStyle==="simultaneous"&&setTimeout(()=>{this._handleCastleMove(s,!0)},this.config.simultaneousAnimationDelay)):(n?this._handleSpecialMove(s):r&&this._handleSpecialMove(s),this._updateBoardPieces(!1),this.config.onMoveEnd(s))}_handleSpecialMove(e){this.moveService.isCastle(e)?this._handleCastleMove(e,!1):this.moveService.isEnPassant(e)&&this._handleEnPassantMove(e,!1)}_handleSpecialMoveAnimation(e){this.moveService.isCastle(e)?this._handleCastleMove(e,!0):this.moveService.isEnPassant(e)&&this._handleEnPassantMove(e,!0)}_handleCastleMove(e,t){const i=this.moveService.getCastleRookMove(e);if(!i)return;const s=this.boardService.getSquare(i.from),n=this.boardService.getSquare(i.to);if(!s||!n||!s.piece){console.warn("Castle rook move failed - squares or piece not found");return}if(t){const r=s.piece;this.pieceService.translatePiece({from:s,to:n,piece:r},!1,t,this._createDragFunction.bind(this),()=>{this._updateBoardPieces(!1)})}else this._updateBoardPieces(!1)}_handleEnPassantMove(e,t){const i=this.moveService.getEnPassantCapturedSquare(e);if(!i)return;const s=this.boardService.getSquare(i);if(!s||!s.piece){console.warn("En passant captured square not found or empty");return}t?(this.pieceService.removePieceFromSquare(s,!0),setTimeout(()=>{this._updateBoardPieces(!1)},this.config.moveTime)):this._updateBoardPieces(!1)}_updateBoardPieces(e=!1,t=!1){!this.positionService||!this.moveService||!this.eventService||(this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null),this.moveService.clearCache(),e&&!this.eventService.getClicked()?this._updateTimeout=setTimeout(()=>{this._doUpdateBoardPieces(e,t),this._updateTimeout=null,this._ensureHintsAvailable()},10):(this._doUpdateBoardPieces(e,t),this._ensureHintsAvailable()))}_ensureHintsAvailable(){this.config.hints&&setTimeout(()=>{this.boardService.applyToAllSquares("removeHint"),this.moveService.clearCache()},50)}_updateBoardPiecesDelayed(){this._updateBoardPieces(!1)}_doUpdateBoardPieces(e=!1,t=!1){if(this._isPromoting||!this.positionService||!this.positionService.getGame())return;const i=this.boardService.getAllSquares(),s=this.positionService.getGame().fen();this.config.animationStyle==="simultaneous"?this._doSimultaneousUpdate(i,s,t):this._doSequentialUpdate(i,s,e)}_doSequentialUpdate(e,t,i){const s={};Object.values(e).forEach(r=>{s[r.id]=this.positionService.getGamePieceId(r.id)}),Object.values(e).forEach(r=>{const o=s[r.id],l=r.piece,c=l?l.getId():null;if(c!==o&&(l&&c!==o&&this.pieceService.removePieceFromSquare(r,i),o&&c!==o)){const u=this.pieceService.convertPiece(o);this.pieceService.addPieceOnSquare(r,u,i,this._createDragFunction.bind(this))}}),this._addListeners();const n=this.positionService.getGame().fen();t!==n&&this.config.onChange(n)}_doSimultaneousUpdate(e,t,i=!1){const s={},n={};Object.values(e).forEach(d=>{const h=d.piece,m=this.positionService.getGamePieceId(d.id);if(h){const f=(h.color+h.type).toLowerCase();s[f]||(s[f]=[]),s[f].push({square:d,id:d.id})}if(m){const f=m.toLowerCase();n[f]||(n[f]=[]),n[f].push({square:d,id:d.id})}});let r=0,o=0;const l=i?0:this.config.simultaneousAnimationDelay;let c=0;if(Object.keys(n).forEach(d=>{o+=Math.max((s[d]||[]).length,n[d].length)}),o===0){this._addListeners();const d=this.positionService.getGame().fen();t!==d&&this.config.onChange(d);return}const u=()=>{if(r++,r===o){this._addListeners();const d=this.positionService.getGame().fen();t!==d&&this.config.onChange(d)}};Object.keys(n).forEach(d=>{const h=(s[d]||[]).slice(),m=n[d].slice(),f=[];for(let y=0;y<h.length;y++){f[y]=[];for(let p=0;p<m.length;p++)f[y][p]=Math.abs(h[y].square.row-m[p].square.row)+Math.abs(h[y].square.col-m[p].square.col)}const g=new Array(h.length).fill(!1),b=new Array(m.length).fill(!1),w=[];for(;;){let y=1/0,p=-1,P=-1;for(let I=0;I<h.length;I++)if(!g[I])for(let F=0;F<m.length;F++)b[F]||f[I][F]<y&&(y=f[I][F],p=I,P=F);if(p===-1||P===-1)break;if(h[p].square===m[P].square){g[p]=!0,b[P]=!0;continue}w.push({from:h[p].square,to:m[P].square,piece:h[p].square.piece}),g[p]=!0,b[P]=!0}for(let y=0;y<h.length;y++)g[y]||(setTimeout(()=>{this.pieceService.removePieceFromSquare(h[y].square,!0,u)},c*l),c++);for(let y=0;y<m.length;y++)b[y]||(setTimeout(()=>{const p=this.pieceService.convertPiece(d);this.pieceService.addPieceOnSquare(m[y].square,p,!0,this._createDragFunction.bind(this),u)},c*l),c++);w.forEach(y=>{setTimeout(()=>{this.pieceService.translatePiece(y,!1,!0,this._createDragFunction.bind(this),u)},c*l),c++})})}_analyzePositionChanges(e){const t=new Map,i=new Map;Object.values(e).forEach(c=>{const u=c.piece,d=this.positionService.getGamePieceId(c.id);u&&t.set(c.id,u.getId()),d&&i.set(c.id,d)});const s=[],n=[],r=[],o=[],l=new Set;return t.forEach((c,u)=>{const d=i.get(u);c===d&&(o.push({piece:c,square:u}),l.add(u))}),t.forEach((c,u)=>{if(l.has(u))return;const d=Array.from(i.entries()).find(([h,m])=>m===c&&!l.has(h));if(d){const[h,m]=d;s.push({piece:c,from:u,to:h,fromSquare:e[u],toSquare:e[h]}),l.add(h)}else n.push({piece:c,square:u,squareObj:e[u]})}),i.forEach((c,u)=>{l.has(u)||r.push({piece:c,square:u,squareObj:e[u]})}),{moves:s,removes:n,adds:r,unchanged:o,totalChanges:s.length+n.length+r.length}}_executeSimultaneousChanges(e,t,i=!1){const{moves:s,removes:n,adds:r}=e;let o=0;const l=s.length+n.length+r.length;if(l===0){this._addListeners();const h=this.positionService.getGame().fen();t!==h&&this.config.onChange(h);return}const c=()=>{if(o++,o===l){this._addListeners();const h=this.positionService.getGame().fen();t!==h&&this.config.onChange(h)}},u=i?0:this.config.simultaneousAnimationDelay;let d=0;s.forEach(h=>{const m=d*u;setTimeout(()=>{this._animatePieceMove(h,c)},m),d++}),n.forEach(h=>{const m=d*u;setTimeout(()=>{this._animatePieceRemoval(h,c)},m),d++}),r.forEach(h=>{const m=d*u;setTimeout(()=>{this._animatePieceAddition(h,c)},m),d++})}_animatePieceMove(e,t){const{fromSquare:i,toSquare:s}=e,n=i.piece;if(!n){console.warn(`No piece found on ${e.from} for move animation`),t();return}this.pieceService.translatePiece({from:i,to:s,piece:n},!1,!0,this._createDragFunction.bind(this),t)}_animatePieceRemoval(e,t){this.pieceService.removePieceFromSquare(e.squareObj,!0,t)}_animatePieceAddition(e,t){const i=this.pieceService.convertPiece(e.piece);this.pieceService.addPieceOnSquare(e.squareObj,i,!0,this._createDragFunction.bind(this),t)}_createDragFunction(e,t){return this.eventService.createDragFunction(e,t,this.config.onDragStart,this.config.onDragMove,this.config.onDrop,this._onSnapback.bind(this),this._onMove.bind(this),this._onRemove.bind(this))}_onSnapback(e,t){this.pieceService.snapbackPiece(e,this.config.snapbackAnimation),this.config.onSnapbackEnd(e,t)}_onRemove(e){this.pieceService.removePieceFromSquare(e,!0),this.positionService.getGame().remove(e.id),this._updateBoardPieces(!0)}_clearVisualState(){this.boardService.applyToAllSquares("deselect"),this.boardService.applyToAllSquares("removeHint"),this.boardService.applyToAllSquares("dehighlight"),this.eventService.setClicked(null)}getPosition(){return this.fen()}setPosition(e,t={}){const i=t.animate!==void 0?t.animate:!0;return this.boardService&&this.boardService.applyToAllSquares&&(this.boardService.applyToAllSquares("removeHint"),this.boardService.applyToAllSquares("deselect"),this.boardService.applyToAllSquares("unmoved")),this.positionService&&this.positionService.setGame&&this.positionService.setGame(e),this._updateBoardPieces&&this._updateBoardPieces(i,!0),!0}reset(e={}){const t=e.animate!==void 0?e.animate:!0,i=this.config&&this.config.position?this.config.position:"start";return this._updateBoardPieces(t),this.setPosition(i,{animate:t})}clear(e={}){const t=e.animate!==void 0?e.animate:!0;return!this.positionService||!this.positionService.getGame()?!1:(this._clearVisualState&&this._clearVisualState(),this.positionService.getGame().clear(),this._updateBoardPieces&&this._updateBoardPieces(t,!0),!0)}undoMove(e={}){const t=this.positionService.getGame().undo();return t?(this._undoneMoves.push(t),this._updateBoardPieces(e.animate!==!1),t):null}redoMove(e={}){if(this._undoneMoves&&this._undoneMoves.length>0){const t=this._undoneMoves.pop(),i={from:t.from,to:t.to};t.promotion&&(i.promotion=t.promotion);const s=this.positionService.getGame().move(i);return this._updateBoardPieces(e.animate!==!1),s}return!1}getLegalMoves(e){return this.legalMoves(e)}getPiece(e){const t=this.boardService.getSquare(e);if(!t)return null;const i=t.piece;return i?(i.color+i.type).toLowerCase():null}putPiece(e,t,i={}){const s=i.animate!==void 0?i.animate:!0;let n=e;if(typeof e=="object"&&e.type&&e.color)n=(e.color+e.type).toLowerCase();else if(typeof e=="string"&&e.length===2){const m=e[0].toLowerCase(),f=e[1].toLowerCase(),g="kqrbnp",b="wb";if(g.includes(m)&&b.includes(f))n=f+m;else if(b.includes(m)&&g.includes(f))n=m+f;else throw new Error(`[putPiece] Invalid piece: ${e}`)}const r=this.validationService.isValidSquare(t),o=this.validationService.isValidPiece(n);if(!r)throw new Error(`[putPiece] Invalid square: ${t}`);if(!o)throw new Error(`[putPiece] Invalid piece: ${n}`);if(!this.positionService||!this.positionService.getGame())throw new Error("[putPiece] No positionService or game");const l=this.pieceService.convertPiece(n),c=this.boardService.getSquare(t);if(!c)throw new Error(`[putPiece] Square not found: ${t}`);c.piece=l;const u={type:l.type,color:l.color};if(!this.positionService.getGame().put(u,t))throw new Error(`[putPiece] Game.put failed for ${n} on ${t}`);return this._updateBoardPieces(s),!0}removePiece(e,t={}){const i=t.animate!==void 0?t.animate:!0;if(!this.validationService.isValidSquare(e))throw new Error(`[removePiece] Invalid square: ${e}`);const s=this.boardService.getSquare(e);return!s||!s.piece||(s.piece=null,this.positionService.getGame().remove(e),this._updateBoardPieces(i)),!0}flipBoard(e={}){this.coordinateService&&this.coordinateService.flipOrientation&&this.coordinateService.flipOrientation(),this._buildBoard&&this._buildBoard(),this._buildSquares&&this._buildSquares(),this._addListeners&&this._addListeners(),this._updateBoardPieces&&this._updateBoardPieces(e.animate!==!1)}setOrientation(e,t={}){return this.validationService.isValidOrientation(e)&&(this.coordinateService.setOrientation(e),this._buildBoard&&this._buildBoard(),this._buildSquares&&this._buildSquares(),this._addListeners&&this._addListeners(),this._updateBoardPieces&&this._updateBoardPieces(t.animate!==!1)),this.coordinateService.getOrientation()}getOrientation(){return this.orientation()}resizeBoard(e){if(e==="auto")return this.config.size="auto",document.documentElement.style.setProperty("--dimBoard","auto"),this._updateBoardPieces(!1),!0;if(typeof e!="number"||e<50||e>3e3)throw new Error(`[resizeBoard] Invalid size: ${e}`);return this.config.size=e,document.documentElement.style.setProperty("--dimBoard",`${e}px`),this._updateBoardPieces(!1),!0}highlight(e,t={}){this.validationService.isValidSquare(e)&&(this.boardService&&this.boardService.highlightSquare?this.boardService.highlightSquare(e,t):this.eventService&&this.eventService.highlightSquare&&this.eventService.highlightSquare(e,t))}dehighlight(e,t={}){this.validationService.isValidSquare(e)&&(this.boardService&&this.boardService.dehighlightSquare?this.boardService.dehighlightSquare(e,t):this.eventService&&this.eventService.dehighlightSquare&&this.eventService.dehighlightSquare(e,t))}fen(){const e=this.positionService.getGame();return!e||typeof e.fen!="function"?"":e.fen()}turn(){return this.positionService.getGame().turn()}isGameOver(){const e=this.positionService.getGame();return e?e.isGameOver?e.isGameOver():!!(e.isCheckmate&&e.isCheckmate()||e.isDraw&&e.isDraw()):!1}isCheckmate(){const e=this.positionService.getGame();return e&&e.isCheckmate?e.isCheckmate():!1}isDraw(){const e=this.positionService.getGame();return e&&e.isDraw?e.isDraw():!1}getHistory(){const e=this.positionService.getGame();return e?e.history?e.history():[]:[]}destroyBoard(){this.eventService&&typeof this.eventService.removeListeners=="function"&&this.eventService.removeListeners(),this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=null);const e=document.getElementById(this.config.id_div);e&&(e.innerHTML=""),this.boardService&&this.boardService.squares&&Object.values(this.boardService.squares).forEach(t=>{t&&t.forceRemoveAllPieces&&t.forceRemoveAllPieces()}),this.boardService&&(this.boardService.removeSquares&&this.boardService.removeSquares(),this.boardService.removeBoard&&this.boardService.removeBoard()),this.validationService=null,this.coordinateService=null,this.positionService=null,this.boardService=null,this.pieceService=null,this.animationService=null,this.moveService=null,this.eventService=null,this._performanceMonitor=null,this._undoneMoves=null,this._boundUpdateBoardPieces=null,this._boundOnSquareClick=null,this._boundOnPieceHover=null,this._boundOnPieceLeave=null}rebuild(){this._initialize()}getConfig(){return this.config}updateConfig(e){this.config&&typeof this.config.update=="function"&&this.config.update(e),e.size!==void 0&&this.resizeBoard(e.size),e.orientation!==void 0&&this.setOrientation(e.orientation)}move(e,t=!0){return this._undoneMoves=[],this.movePiece(e,{animate:t})}clearBoard(e=!0){return this._updateBoardPieces(e),this.clear({animate:e})}start(e=!0){return this._updateBoardPieces(e),this.reset({animate:e})}flip(e={}){return this._updateBoardPieces(e.animate!==!1),this.flipBoard(e)}getOrSetPosition(e,t=!0){if(e===void 0)return this.positionService.getPosition();this.load(e,{},t)}undo(e=!0){const t=this.positionService.getGame().undo();return t?(this._undoneMoves.push(t),this._updateBoardPieces(e),t):null}redo(e=!0){if(this._undoneMoves&&this._undoneMoves.length>0){const t=this._undoneMoves.pop(),i={from:t.from,to:t.to};t.promotion&&(i.promotion=t.promotion);const s=this.positionService.getGame().move(i);return this._updateBoardPieces(e),s}return!1}history(){return this.positionService.getGame().history()}game(){return this.positionService.getGame()}orientation(e){return e===void 0?this.coordinateService.getOrientation():(this.validationService.isValidOrientation(e)&&(this.coordinateService.setOrientation(e),this.flip()),this.coordinateService.getOrientation())}size(e){return e===void 0?this.config.size:(this.validationService.isValidSize(e)&&(this.config.size=e,this.resize(e)),this.config.size)}legalMoves(e){const t=this.boardService.getSquare(e);return t?this.moveService.getCachedLegalMoves(t):[]}isLegal(e){const t=typeof e=="string"?this.moveService.parseMove(e):e;if(!t)return!1;const i=this.boardService.getSquare(t.from),s=this.boardService.getSquare(t.to);return!i||!s?!1:new H(i,s,t.promotion).isLegal(this.positionService.getGame())}inCheck(){return this.positionService.getGame().inCheck()}inCheckmate(){return this.positionService.getGame().isCheckmate()}inStalemate(){return this.positionService.getGame().isStalemate()}inDraw(){return this.positionService.getGame().isDraw()}inThreefoldRepetition(){return this.positionService.getGame().isThreefoldRepetition()}pgn(){return this.positionService.getGame().pgn()}loadPgn(e,t=!0){try{const i=this.positionService.getGame().loadPgn(e);return i&&this._updateBoardPieces(t,!0),i}catch(i){return console.error("Error loading PGN:",i),!1}}getConfigOptions(){return this.config&&typeof this.config.getConfig=="function"?this.config.getConfig():this.config}setConfigOptions(e){this.updateConfig(e)}animationStyle(e){return e===void 0?this.config.animationStyle:(this.validationService.isValidAnimationStyle(e)&&(this.config.animationStyle=e),this.config.animationStyle)}simultaneousAnimationDelay(e){return e===void 0?this.config.simultaneousAnimationDelay:(typeof e=="number"&&e>=0&&(this.config.simultaneousAnimationDelay=e),this.config.simultaneousAnimationDelay)}insert(e,t){return this.putPiece(t,e)}get(e){return this.getPiece(e)}position(e,t){return e===void 0?this.positionService.getPosition():(typeof t=="string"&&(t==="w"||t==="b")&&this.setOrientation(t),this.setPosition(e,{animate:t!==!1}))}destroy(){return this.destroyBoard()}build(){return this._initialize()}resize(e){return this.resizeBoard(e)}piece(e){return this.getPiece(e)}ascii(){return this.positionService.getGame().ascii()}board(){return this.positionService.getGame().board()}getCastlingRights(e){return this.positionService.getGame().getCastlingRights(e)}getComment(){return this.positionService.getGame().getComment()}getComments(){return this.positionService.getGame().getComments()}lastMove(){return this.positionService.getGame().lastMove()}moveNumber(){return this.positionService.getGame().moveNumber()}moves(e={}){return this.positionService.getGame().moves(e)}squareColor(e){return this.boardService.getSquare(e).isWhite()?"light":"dark"}isDrawByFiftyMoves(){return this.positionService.getGame().isDrawByFiftyMoves()}isInsufficientMaterial(){return this.positionService.getGame().isInsufficientMaterial()}isStalemate(){return this.positionService.getGame().isStalemate()}isThreefoldRepetition(){return this.positionService.getGame().isThreefoldRepetition()}load(e,t={},i=!0){return this.setPosition(e,{...t,animate:i})}put(e,t,i=!0){console.debug("[put] called with:",{pieceId:e,squareId:t,animation:i});let s=null;function n(o){if(typeof o!="string"||o.length!==2)return null;const l=o[0].toLowerCase(),c=o[1].toLowerCase(),u="kqrbnp",d="wb";return u.includes(l)&&d.includes(c)?{type:l,color:c}:d.includes(l)&&u.includes(c)?{type:c,color:l}:null}if(typeof e=="string"){if(s=n(e),console.debug("[put] parsed piece string:",s),!s)return console.error(`[put] Invalid piece string: '${e}'. Use e.g. 'wQ', 'Qw', 'bK', 'kb'`),!1}else if(typeof e=="object"&&e.type&&e.color){const o=String(e.type).toLowerCase(),l=String(e.color).toLowerCase();if("kqrbnp".includes(o)&&"wb".includes(l))s={type:o,color:l},console.debug("[put] normalized piece object:",s);else return console.error(`[put] Invalid piece object: {type: '${e.type}', color: '${e.color}'}`),!1}else return console.error("[put] Invalid pieceId:",e),!1;if(typeof t!="string"||t.length!==2)return console.error("[put] Invalid squareId:",t),!1;const r=this.putPiece(s,t,{animate:i});return console.debug("[put] putPiece result:",r),r}remove(e,t=!0){return this.removePiece(e,{animate:t})}removeComment(){return this.positionService.getGame().removeComment()}removeComments(){return this.positionService.getGame().removeComments()}removeHeader(e){return this.positionService.getGame().removeHeader(e)}setCastlingRights(e,t){return this.positionService.getGame().setCastlingRights(e,t)}setComment(e){return this.positionService.getGame().setComment(e)}setHeader(e,t){return this.positionService.getGame().setHeader(e,t)}validateFen(e){return this.positionService.getGame().validateFen(e)}highlightSquare(e){return this.boardService.highlight(e)}dehighlightSquare(e){return this.boardService.dehighlight(e)}forceSync(){this._updateBoardPieces(!0,!0)}};class De{constructor(){this.instances=new Map,this.validationService=new be,this.performanceMonitor=new qe,this.logger=v.child("ChessboardFactory"),this.templates=new Map,this._initializeDefaultTemplates()}_initializeDefaultTemplates(){this.templates.set("basic",{size:400,draggable:!0,hints:!0,clickable:!0,moveHighlight:!0,animationStyle:"simultaneous"}),this.templates.set("tournament",{size:500,draggable:!1,hints:!1,clickable:!0,moveHighlight:!0,onlyLegalMoves:!0,animationStyle:"sequential"}),this.templates.set("analysis",{size:600,draggable:!0,hints:!0,clickable:!0,moveHighlight:!0,mode:"analysis",animationStyle:"simultaneous"}),this.templates.set("puzzle",{size:450,draggable:!0,hints:!0,clickable:!0,moveHighlight:!0,onlyLegalMoves:!0,animationStyle:"sequential"}),this.templates.set("demo",{size:"auto",draggable:!1,hints:!1,clickable:!1,moveHighlight:!0,animationStyle:"simultaneous"})}create(e,t={},i=null){this.performanceMonitor.startMeasure("chessboard-creation");try{if(!e||typeof e!="string")throw new q("Container ID must be a non-empty string","containerId",e);const s=document.getElementById(e);if(!s)throw new q(`Container element not found: ${e}`,"containerId",e);let n={...t};if(i){const o=this.templates.get(i);o?(n={...o,...t},this.logger.info(`Using template "${i}" for chessboard creation`)):this.logger.warn(`Template "${i}" not found, using default configuration`)}n.id=e,this.validationService.validateConfig(n);const r=new Se(n);return this.instances.set(e,{instance:r,config:n,template:i,createdAt:new Date,container:s}),this.performanceMonitor.endMeasure("chessboard-creation"),this.logger.info(`Created chessboard instance for container: ${e}`,{template:i,configKeys:Object.keys(n)}),r}catch(s){throw this.performanceMonitor.endMeasure("chessboard-creation"),this.logger.error("Failed to create chessboard instance",{containerId:e,error:s}),s}}createFromTemplate(e,t,i={}){return this.create(e,i,t)}getInstance(e){const t=this.instances.get(e);return t?t.instance:null}getInstanceInfo(e){const t=this.instances.get(e);return t?{containerId:e,template:t.template,createdAt:t.createdAt,config:{...t.config}}:null}destroy(e){const t=this.instances.get(e);if(!t)return this.logger.warn(`Instance not found for destruction: ${e}`),!1;try{return t.instance.destroy(),this.instances.delete(e),this.logger.info(`Destroyed chessboard instance: ${e}`),!0}catch(i){return this.logger.error(`Failed to destroy chessboard instance: ${e}`,{error:i}),!1}}destroyAll(){const e=Array.from(this.instances.keys());let t=0;for(const i of e)this.destroy(i)&&t++;this.logger.info(`Destroyed ${t} chessboard instances`)}listInstances(){return Array.from(this.instances.keys()).map(e=>this.getInstanceInfo(e))}registerTemplate(e,t){if(!e||typeof e!="string")throw new q("Template name must be a non-empty string","name",e);if(!t||typeof t!="object")throw new q("Template configuration must be an object","config",t);this.validationService.validateConfig(t),this.templates.set(e,{...t}),this.logger.info(`Registered template: ${e}`,{configKeys:Object.keys(t)})}removeTemplate(e){const t=this.templates.delete(e);return t&&this.logger.info(`Removed template: ${e}`),t}getTemplate(e){const t=this.templates.get(e);return t?{...t}:null}listTemplates(){return Array.from(this.templates.keys())}createMultiple(e){const t=[],i=[];for(const s of e)try{const{containerId:n,template:r,...o}=s,l=this.create(n,o,r);t.push({containerId:n,instance:l,success:!0})}catch(n){i.push({containerId:s.containerId,error:n,success:!1}),this.logger.error(`Failed to create instance for ${s.containerId}`,{error:n})}return i.length>0&&this.logger.warn(`Failed to create ${i.length} out of ${e.length} instances`),{instances:t,errors:i}}getStats(){return{activeInstances:this.instances.size,availableTemplates:this.templates.size,performance:this.performanceMonitor.getMetrics(),validation:this.validationService.getCacheStats()}}cleanup(){this.destroyAll(),this.validationService.destroy(),this.performanceMonitor.destroy(),this.templates.clear()}}const N=new De;function st(a,e={},t=null){return N.create(a,e,t)}function nt(a,e,t={}){return N.createFromTemplate(a,e,t)}function O(a,e={}){const t=v.child("ChessboardFactory");try{if(typeof a=="object"&&a!==null)return t.debug("Creating chessboard with config object"),new Se(a);if(typeof a=="string"){t.debug("Creating chessboard with element ID",{elementId:a});const i={...e,id:a};return new Se(i)}throw new Error("Invalid parameters: first parameter must be string or object")}catch(i){throw t.error("Failed to create chessboard instance",{error:i}),i}}class ot extends Se{constructor(e,t={}){const i=v.child("ChessboardWrapper");try{if(typeof e=="object"&&e!==null)i.debug("Initializing with config object"),super(e);else if(typeof e=="string"){i.debug("Initializing with element ID",{elementId:e});const s={...t,id:e};super(s)}else throw new Error("Invalid constructor parameters")}catch(s){throw i.error("Failed to initialize ChessboardWrapper",{error:s}),s}}}O.create=st;O.fromTemplate=nt;O.factory=N;O.getInstance=a=>N.getInstance(a);O.destroyInstance=a=>N.destroy(a);O.destroyAll=()=>N.destroyAll();O.listInstances=()=>N.listInstances();O.registerTemplate=(a,e)=>N.registerTemplate(a,e);O.removeTemplate=a=>N.removeTemplate(a);O.getTemplate=a=>N.getTemplate(a);O.listTemplates=()=>N.listTemplates();O.getStats=()=>N.getStats();O.Class=ot;O.Chessboard=ot;O.Config=Me;O.Factory=De;function rt(a){const e=a.charCodeAt(0)-97;return{row:7-(parseInt(a[1])-1),col:e}}function jt(a,e){const t=String.fromCharCode(97+e),i=(8-a).toString();return t+i}function zt(a){const{row:e,col:t}=rt(a);return(e+t)%2===0?"dark":"light"}function Ht(a,e){return a>=0&&a<=7&&e>=0&&e<=7}function Kt(a){if(typeof a!="string"||a.length!==2)return!1;const e=a[0],t=a[1];return e>="a"&&e<="h"&&t>="1"&&t<="8"}const z=new Map,at=1e3;function j(a,e){if(z.size>=at){const t=z.keys().next().value;z.delete(t)}z.set(a,e)}function $e(a){if(typeof a!="string"||a.length!==2)return!1;const e=`piece:${a}`;if(z.has(e))return z.get(e);const t=a[0],i=a[1],s=["w","b"].includes(t)&&["P","R","N","B","Q","K"].includes(i);return j(e,s),s}function Fe(a){if(typeof a!="object"||a===null)return!1;try{JSON.stringify(a)}catch{return!1}for(const[e,t]of Object.entries(a))if(!isValidSquare(e)||!$e(t))return!1;return Ut(a)}function Ut(a){const e=Object.values(a),t=e.filter(r=>r==="wK").length,i=e.filter(r=>r==="bK").length;if(t!==1||i!==1)return!1;const s=e.filter(r=>r==="wP").length,n=e.filter(r=>r==="bP").length;if(s>8||n>8)return!1;for(const[r,o]of Object.entries(a))if(o==="wP"||o==="bP"){const l=r[1];if(l==="1"||l==="8")return!1}return!0}function lt(a){if(typeof a!="string")return{success:!1,error:"FEN must be a string"};const e=`fen:${a}`;if(z.has(e))return z.get(e);const t=a.trim().split(" ");if(t.length!==6){const o={success:!1,error:"FEN must have 6 parts separated by spaces"};return j(e,o),o}const i=t[0].split("/");if(i.length!==8){const o={success:!1,error:"Piece placement must have 8 ranks"};return j(e,o),o}for(let o=0;o<i.length;o++){const l=Wt(i[o]);if(!l.success){const c={success:!1,error:`Invalid rank ${o+1}: ${l.error}`};return j(e,c),c}}if(!["w","b"].includes(t[1])){const o={success:!1,error:'Active color must be "w" or "b"'};return j(e,o),o}if(!/^[KQkq-]*$/.test(t[2])){const o={success:!1,error:"Invalid castling availability"};return j(e,o),o}if(t[3]!=="-"&&!isValidSquare(t[3])){const o={success:!1,error:"Invalid en passant target square"};return j(e,o),o}const s=parseInt(t[4],10);if(isNaN(s)||s<0){const o={success:!1,error:"Invalid halfmove clock"};return j(e,o),o}const n=parseInt(t[5],10);if(isNaN(n)||n<1){const o={success:!1,error:"Invalid fullmove number"};return j(e,o),o}const r={success:!0};return j(e,r),r}function Wt(a){if(typeof a!="string")return{success:!1,error:"Rank must be a string"};let e=0;for(let t=0;t<a.length;t++){const i=a[t];if(/[1-8]/.test(i))e+=parseInt(i,10);else if(/[prnbqkPRNBQK]/.test(i))e+=1;else return{success:!1,error:`Invalid character "${i}" in rank`}}return e!==8?{success:!1,error:`Rank must represent exactly 8 squares, got ${e}`}:{success:!0}}function ct(a){if(typeof a!="string")return{success:!1,error:"Move must be a string"};const e=a.trim();return e.length===0?{success:!1,error:"Move cannot be empty"}:e==="O-O"||e==="O-O-O"?{success:!0,type:"castling"}:/^[a-h][1-8][a-h][1-8][qrnbQRNB]?$/.test(e)?{success:!0,type:"coordinate"}:/^[PRNBQK]?[a-h]?[1-8]?x?[a-h][1-8](\+|#)?$/.test(e)?{success:!0,type:"algebraic"}:{success:!1,error:"Invalid move format"}}function ht(a){const e=[];if(!a||typeof a!="object")return{success:!1,errors:["Configuration must be an object"]};!a.id&&!a.id_div&&e.push('Configuration must include "id" or "id_div"'),a.orientation&&!["white","black","w","b"].includes(a.orientation)&&e.push('Invalid orientation. Must be "white", "black", "w", or "b"'),a.position&&a.position!=="start"&&typeof a.position!="object"&&e.push('Invalid position. Must be "start" or a position object'),a.position&&typeof a.position=="object"&&!Fe(a.position)&&e.push("Invalid position object format"),a.size&&!Qt(a.size)&&e.push('Invalid size. Must be "auto", a positive number, or a valid CSS size'),a.movableColors&&!["white","black","w","b","both","none"].includes(a.movableColors)&&e.push('Invalid movableColors. Must be "white", "black", "w", "b", "both", or "none"'),a.dropOffBoard&&!["snapback","trash"].includes(a.dropOffBoard)&&e.push('Invalid dropOffBoard. Must be "snapback" or "trash"');const t=["onMove","onMoveEnd","onChange","onDragStart","onDragMove","onDrop","onSnapbackEnd"];for(const s of t)a[s]&&typeof a[s]!="function"&&e.push(`Invalid ${s}. Must be a function`);const i=["whiteSquare","blackSquare","highlight","hintColor"];for(const s of i)a[s]&&!Yt(a[s])&&e.push(`Invalid ${s}. Must be a valid CSS color`);return a.moveAnimation&&!Jt(a.moveAnimation)&&e.push("Invalid moveAnimation. Must be a valid easing function"),a.animationStyle&&!["sequential","simultaneous"].includes(a.animationStyle)&&e.push('Invalid animationStyle. Must be "sequential" or "simultaneous"'),{success:e.length===0,errors:e}}function Qt(a){return a==="auto"?!0:typeof a=="number"?a>0&&a<=5e3:typeof a=="string"?/^\d+(px|em|rem|%|vh|vw)$/.test(a):!1}function Yt(a){return typeof a!="string"?!1:/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(a)||/^rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*(,\s*[0-1](\.\d+)?)?\s*\)$/.test(a)||/^hsla?\(\s*\d+\s*,\s*\d+%\s*,\s*\d+%\s*(,\s*[0-1](\.\d+)?)?\s*\)$/.test(a)?!0:["white","black","red","green","blue","yellow","cyan","magenta","transparent","gray","grey","brown","orange","purple","pink"].includes(a.toLowerCase())}function Jt(a){return["linear","ease","ease-in","ease-out","ease-in-out","cubic-bezier"].includes(a)||/^cubic-bezier\(\s*[\d.-]+\s*,\s*[\d.-]+\s*,\s*[\d.-]+\s*,\s*[\d.-]+\s*\)$/.test(a)}function Xt(a){return a.map(e=>{const{type:t,value:i}=e;switch(t){case"piece":return{...e,valid:$e(i)};case"square":return{...e,valid:isValidSquare(i)};case"position":return{...e,valid:Fe(i)};case"fen":const s=lt(i);return{...e,valid:s.success,error:s.error};case"move":const n=ct(i);return{...e,valid:n.success,error:n.error};case"config":const r=ht(i);return{...e,valid:r.success,errors:r.errors};default:return{...e,valid:!1,error:"Unknown validation type"}}})}function Zt(){z.clear()}function ei(){return{size:z.size,maxSize:at}}function ti(a){if(typeof a=="number")return a;switch(a){case"fast":return 150;case"slow":return 500;default:return 200}}function ii(a){return["ease","ease-in","ease-out","ease-in-out","linear"].includes(a)?a:"ease"}function si(a){return new Promise(e=>setTimeout(e,a))}/**
 * Chessboard.js - A beautiful, customizable chessboard widget
 * Main entry point for the library
 * 
 * @version 2.2.1
 * @author alepot55
 * @license ISC
 */const ut="2.2.1",dt=process.env.BUILD_NUMBER||"dev",ft=process.env.BUILD_DATE||new Date().toISOString(),ni={name:"Chessboard.js",version:ut,build:dt,buildDate:ft,author:"alepot55",license:"ISC",repository:"https://github.com/alepot55/Chessboardjs",homepage:"https://chessboardjs.com"};exports.AnimationService=We;exports.BOARD_LETTERS=ae;exports.BOARD_SIZE=Ie;exports.BoardService=Qe;exports.Chess=tt;exports.Chessboard=O;exports.ChessboardConfig=Me;exports.ChessboardError=V;exports.ChessboardFactory=De;exports.ConfigurationError=q;exports.CoordinateService=Ye;exports.DEFAULT_STARTING_POSITION=He;exports.DOMError=Ue;exports.EventService=Je;exports.LOG_LEVELS=J;exports.Logger=de;exports.Move=H;exports.MoveError=Re;exports.MoveService=Xe;exports.PIECE_COLORS=ce;exports.PIECE_TYPES=le;exports.PROMOTION_PIECES=Ke;exports.PerformanceMonitor=qe;exports.Piece=he;exports.PieceError=ge;exports.PieceService=Ze;exports.PositionService=it;exports.STANDARD_POSITIONS=Te;exports.Square=_e;exports.ValidationError=k;exports.ValidationService=be;exports.algebraicToCoords=rt;exports.animationPromise=si;exports.batchDOMOperations=kt;exports.batchValidate=Xt;exports.build=dt;exports.buildDate=ft;exports.chessboardFactory=N;exports.clearValidationCache=Zt;exports.coordsToAlgebraic=jt;exports.createChessboard=st;exports.createChessboardFromTemplate=nt;exports.createLogger=At;exports.debounce=Pt;exports.default=O;exports.getMemoryUsage=It;exports.getSquareColor=zt;exports.getValidationCacheStats=ei;exports.info=ni;exports.isElementVisible=Tt;exports.isValidCoords=Ht;exports.isValidPiece=$e;exports.isValidPosition=Fe;exports.isValidSquare=Kt;exports.logger=v;exports.parseAnimation=ii;exports.parseTime=ti;exports.rafThrottle=Oe;exports.resetTransform=Et;exports.setTransform=wt;exports.throttle=Ct;exports.validateConfig=ht;exports.validateFen=Le;exports.validateFenFormat=lt;exports.validateMove=ct;exports.version=ut;
//# sourceMappingURL=chessboard.cjs.js.map
