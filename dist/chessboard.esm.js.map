{"version":3,"file":"chessboard.esm.js","sources":["../src/constants/positions.js","../src/errors/messages.js","../src/errors/ChessboardError.js","../src/services/ValidationService.js","../src/core/ChessboardConfig.js","../src/components/Piece.js","../src/components/Square.js","../src/components/Move.js","../src/services/AnimationService.js","../src/services/BoardService.js","../src/services/CoordinateService.js","../src/utils/performance.js","../src/utils/cross-browser.js","../src/utils/logger.js","../src/services/EventService.js","../src/services/MoveService.js","../src/services/PieceService.js","../src/utils/chess.js","../src/services/PositionService.js","../src/core/Chessboard.js","../src/core/ChessboardFactory.js","../src/core/index.js","../src/utils/coordinates.js","../src/utils/validation.js","../src/utils/animations.js","../src/index.js"],"sourcesContent":["/**\n * Standard chess positions and FEN constants\n * @module constants/positions\n * @since 2.0.0\n */\n\n/**\n * Standard chess positions used throughout the application\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const STANDARD_POSITIONS = {\n    'start': 'start',\n    'default': 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',\n    'empty': '8/8/8/8/8/8/8/8 w - - 0 1'\n};\n\n/**\n * Default starting position FEN string\n * @type {string}\n * @readonly\n */\nexport const DEFAULT_STARTING_POSITION = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';\n\n/**\n * Chess piece types\n * @type {string[]}\n * @readonly\n */\nexport const PIECE_TYPES = ['p', 'r', 'n', 'b', 'q', 'k'];\n\n/**\n * Chess piece colors\n * @type {string[]}\n * @readonly\n */\nexport const PIECE_COLORS = ['w', 'b'];\n\n/**\n * Valid promotion pieces\n * @type {string[]}\n * @readonly\n */\nexport const PROMOTION_PIECES = ['q', 'r', 'b', 'n'];\n\n/**\n * Board coordinates letters\n * @type {string}\n * @readonly\n */\nexport const BOARD_LETTERS = 'abcdefgh';\n\n/**\n * Board size constants\n * @type {Object}\n * @readonly\n */\nexport const BOARD_SIZE = {\n    ROWS: 8,\n    COLS: 8,\n    TOTAL_SQUARES: 64\n};\n","/**\n * Error messages and error handling utilities\n * @module errors/messages\n * @since 2.0.0\n */\n\n/**\n * Error codes for categorizing different types of errors\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const ERROR_CODES = Object.freeze({\n    VALIDATION_ERROR: 'VALIDATION_ERROR',\n    CONFIG_ERROR: 'CONFIG_ERROR',\n    MOVE_ERROR: 'MOVE_ERROR',\n    DOM_ERROR: 'DOM_ERROR',\n    ANIMATION_ERROR: 'ANIMATION_ERROR',\n    PIECE_ERROR: 'PIECE_ERROR',\n    INITIALIZATION_ERROR: 'INITIALIZATION_ERROR',\n    POSITION_ERROR: 'POSITION_ERROR',\n    FEN_ERROR: 'FEN_ERROR',\n    SQUARE_ERROR: 'SQUARE_ERROR',\n    THEME_ERROR: 'THEME_ERROR',\n    NETWORK_ERROR: 'NETWORK_ERROR'\n});\n\n/**\n * Standardized error messages for the chessboard application\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const ERROR_MESSAGES = Object.freeze({\n    // Position and FEN related\n    invalid_position: 'Invalid position: ',\n    invalid_fen: 'Invalid FEN string: ',\n    position_load_failed: 'Failed to load position: ',\n    \n    // DOM and UI related\n    invalid_id_div: 'Board container not found: ',\n    invalid_value: 'Invalid value: ',\n    dom_operation_failed: 'DOM operation failed: ',\n    element_not_found: 'Element not found: ',\n    \n    // Piece related\n    invalid_piece: 'Invalid piece notation: ',\n    invalid_square: 'Invalid square notation: ',\n    invalid_piecesPath: 'Invalid pieces path: ',\n    piece_operation_failed: 'Piece operation failed: ',\n    \n    // Board configuration\n    invalid_orientation: 'Invalid orientation: ',\n    invalid_color: 'Invalid color: ',\n    invalid_mode: 'Invalid mode: ',\n    invalid_dropOffBoard: 'Invalid dropOffBoard setting: ',\n    invalid_size: 'Invalid size: ',\n    invalid_movableColors: 'Invalid movableColors setting: ',\n    \n    // Animation related\n    invalid_snapbackTime: 'Invalid snapbackTime: ',\n    invalid_snapbackAnimation: 'Invalid snapbackAnimation: ',\n    invalid_fadeTime: 'Invalid fadeTime: ',\n    invalid_fadeAnimation: 'Invalid fadeAnimation: ',\n    invalid_ratio: 'Invalid ratio: ',\n    invalid_animationStyle: 'Invalid animationStyle: ',\n    animation_failed: 'Animation failed: ',\n    \n    // Event handlers\n    invalid_onMove: 'Invalid onMove callback: ',\n    invalid_onMoveEnd: 'Invalid onMoveEnd callback: ',\n    invalid_onChange: 'Invalid onChange callback: ',\n    invalid_onDragStart: 'Invalid onDragStart callback: ',\n    invalid_onDragMove: 'Invalid onDragMove callback: ',\n    invalid_onDrop: 'Invalid onDrop callback: ',\n    invalid_onSnapbackEnd: 'Invalid onSnapbackEnd callback: ',\n    callback_execution_failed: 'Callback execution failed: ',\n    \n    // Visual styling\n    invalid_whiteSquare: 'Invalid whiteSquare color: ',\n    invalid_blackSquare: 'Invalid blackSquare color: ',\n    invalid_highlight: 'Invalid highlight color: ',\n    invalid_selectedSquareWhite: 'Invalid selectedSquareWhite color: ',\n    invalid_selectedSquareBlack: 'Invalid selectedSquareBlack color: ',\n    invalid_movedSquareWhite: 'Invalid movedSquareWhite color: ',\n    invalid_movedSquareBlack: 'Invalid movedSquareBlack color: ',\n    invalid_choiceSquare: 'Invalid choiceSquare color: ',\n    invalid_coverSquare: 'Invalid coverSquare color: ',\n    invalid_hintColor: 'Invalid hintColor: ',\n    \n    // Move related\n    invalid_move: 'Invalid move: ',\n    invalid_move_format: 'Invalid move format: ',\n    move_execution_failed: 'Move execution failed: ',\n    illegal_move: 'Illegal move: ',\n    square_no_piece: 'No piece found on square: ',\n    move_validation_failed: 'Move validation failed: ',\n    \n    // Game state\n    game_over: 'Game is over',\n    invalid_turn: 'Invalid turn: ',\n    position_validation_failed: 'Position validation failed: ',\n    \n    // Theme and assets\n    theme_load_failed: 'Theme loading failed: ',\n    asset_load_failed: 'Asset loading failed: ',\n    invalid_theme: 'Invalid theme: ',\n    \n    // Network and resources\n    network_error: 'Network error: ',\n    resource_not_found: 'Resource not found: ',\n    timeout_error: 'Operation timed out: ',\n    \n    // General errors\n    initialization_failed: 'Initialization failed: ',\n    operation_failed: 'Operation failed: ',\n    invalid_state: 'Invalid state: ',\n    memory_limit_exceeded: 'Memory limit exceeded',\n    performance_degraded: 'Performance degraded: '\n});\n\n/**\n * Error severity levels\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const ERROR_SEVERITY = Object.freeze({\n    LOW: 'LOW',\n    MEDIUM: 'MEDIUM',\n    HIGH: 'HIGH',\n    CRITICAL: 'CRITICAL'\n});\n\n/**\n * Maps error codes to their severity levels\n * @type {Object.<string, string>}\n * @readonly\n */\nexport const ERROR_SEVERITY_MAP = Object.freeze({\n    [ERROR_CODES.VALIDATION_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.CONFIG_ERROR]: ERROR_SEVERITY.HIGH,\n    [ERROR_CODES.MOVE_ERROR]: ERROR_SEVERITY.LOW,\n    [ERROR_CODES.DOM_ERROR]: ERROR_SEVERITY.HIGH,\n    [ERROR_CODES.ANIMATION_ERROR]: ERROR_SEVERITY.LOW,\n    [ERROR_CODES.PIECE_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.INITIALIZATION_ERROR]: ERROR_SEVERITY.CRITICAL,\n    [ERROR_CODES.POSITION_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.FEN_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.SQUARE_ERROR]: ERROR_SEVERITY.MEDIUM,\n    [ERROR_CODES.THEME_ERROR]: ERROR_SEVERITY.LOW,\n    [ERROR_CODES.NETWORK_ERROR]: ERROR_SEVERITY.MEDIUM\n});\n\n/**\n * Utility function to get error severity\n * @param {string} errorCode - Error code\n * @returns {string} Error severity level\n */\nexport function getErrorSeverity(errorCode) {\n    return ERROR_SEVERITY_MAP[errorCode] || ERROR_SEVERITY.MEDIUM;\n}\n\n/**\n * Utility function to format error message\n * @param {string} messageKey - Message key from ERROR_MESSAGES\n * @param {string} [details] - Additional details\n * @returns {string} Formatted error message\n */\nexport function formatErrorMessage(messageKey, details = '') {\n    const message = ERROR_MESSAGES[messageKey];\n    if (!message) {\n        return `Unknown error: ${messageKey}${details ? ` - ${details}` : ''}`;\n    }\n    return `${message}${details}`;\n}\n\n/**\n * Utility function to create error context\n * @param {string} operation - Operation that failed\n * @param {Object} [data] - Additional context data\n * @returns {Object} Error context object\n */\nexport function createErrorContext(operation, data = {}) {\n    return {\n        operation,\n        timestamp: new Date().toISOString(),\n        userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'Unknown',\n        url: typeof window !== 'undefined' ? window.location.href : 'Unknown',\n        ...data\n    };\n}\n","/**\n * Custom error classes for better error handling\n * @module errors/ChessboardError\n * @since 2.0.0\n */\n\nimport { ERROR_CODES } from './messages.js';\n\n/**\n * Base error class for all chessboard-related errors\n * @class\n * @extends Error\n */\nexport class ChessboardError extends Error {\n    /**\n     * Creates a new ChessboardError instance\n     * @param {string} message - Error message\n     * @param {string} code - Error code from ERROR_CODES\n     * @param {Object} [context={}] - Additional context information\n     */\n    constructor(message, code, context = {}) {\n        super(message);\n        this.name = 'ChessboardError';\n        this.code = code;\n        this.context = context;\n        this.timestamp = new Date().toISOString();\n        \n        // Maintain stack trace for debugging\n        if (Error.captureStackTrace) {\n            Error.captureStackTrace(this, ChessboardError);\n        }\n    }\n}\n\n/**\n * Error thrown when validation fails\n * @class\n * @extends ChessboardError\n */\nexport class ValidationError extends ChessboardError {\n    /**\n     * Creates a new ValidationError instance\n     * @param {string} message - Error message\n     * @param {string} field - Field that failed validation\n     * @param {*} value - Value that failed validation\n     */\n    constructor(message, field, value) {\n        super(message, ERROR_CODES.VALIDATION_ERROR, { field, value });\n        this.name = 'ValidationError';\n        this.field = field;\n        this.value = value;\n    }\n}\n\n/**\n * Error thrown when configuration is invalid\n * @class\n * @extends ChessboardError\n */\nexport class ConfigurationError extends ChessboardError {\n    /**\n     * Creates a new ConfigurationError instance\n     * @param {string} message - Error message\n     * @param {string} configKey - Configuration key that is invalid\n     * @param {*} configValue - Configuration value that is invalid\n     */\n    constructor(message, configKey, configValue) {\n        super(message, ERROR_CODES.CONFIG_ERROR, { configKey, configValue });\n        this.name = 'ConfigurationError';\n        this.configKey = configKey;\n        this.configValue = configValue;\n    }\n}\n\n/**\n * Error thrown when a move is invalid or fails\n * @class\n * @extends ChessboardError\n */\nexport class MoveError extends ChessboardError {\n    /**\n     * Creates a new MoveError instance\n     * @param {string} message - Error message\n     * @param {string} from - Source square\n     * @param {string} to - Target square\n     * @param {string} [piece] - Piece being moved\n     */\n    constructor(message, from, to, piece) {\n        super(message, ERROR_CODES.MOVE_ERROR, { from, to, piece });\n        this.name = 'MoveError';\n        this.from = from;\n        this.to = to;\n        this.piece = piece;\n    }\n}\n\n/**\n * Error thrown when DOM operations fail\n * @class\n * @extends ChessboardError\n */\nexport class DOMError extends ChessboardError {\n    /**\n     * Creates a new DOMError instance\n     * @param {string} message - Error message\n     * @param {string} elementId - Element ID that caused the error\n     */\n    constructor(message, elementId) {\n        super(message, ERROR_CODES.DOM_ERROR, { elementId });\n        this.name = 'DOMError';\n        this.elementId = elementId;\n    }\n}\n\n/**\n * Error thrown when piece operations fail\n * @class\n * @extends ChessboardError\n */\nexport class PieceError extends ChessboardError {\n    /**\n     * Creates a new PieceError instance\n     * @param {string} message - Error message\n     * @param {string} pieceId - Piece ID that caused the error\n     * @param {string} [square] - Square where the error occurred\n     */\n    constructor(message, pieceId, square) {\n        super(message, ERROR_CODES.PIECE_ERROR, { pieceId, square });\n        this.name = 'PieceError';\n        this.pieceId = pieceId;\n        this.square = square;\n    }\n}\n","/**\n * Service for input validation and data sanitization\n * @module services/ValidationService\n * @since 2.0.0\n */\n\nimport { PIECE_TYPES, PIECE_COLORS, BOARD_LETTERS } from '../constants/positions.js';\nimport { ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES, ERROR_CODES } from '../errors/messages.js';\n\n/**\n * Validation patterns compiled for performance\n * @constant\n * @type {Object}\n */\nconst VALIDATION_PATTERNS = Object.freeze({\n    square: /^[a-h][1-8]$/,\n    piece: /^[prnbqkPRNBQK][wb]$/,\n    fen: /^([rnbqkpRNBQKP1-8]+\\/){7}[rnbqkpRNBQKP1-8]+\\s[wb]\\s[KQkq-]+\\s[a-h1-8-]+\\s\\d+\\s\\d+$/,\n    move: /^[a-h][1-8][a-h][1-8][qrnb]?$/,\n    color: /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/\n});\n\n/**\n * Valid values for various configuration options\n * @constant\n * @type {Object}\n */\nconst VALID_VALUES = Object.freeze({\n    orientations: ['w', 'b', 'white', 'black'],\n    colors: ['w', 'b', 'white', 'black'],\n    movableColors: ['w', 'b', 'white', 'black', 'both', 'none'],\n    dropOffBoard: ['snapback', 'trash'],\n    easingTypes: ['linear', 'ease', 'ease-in', 'ease-out', 'ease-in-out'],\n    animationStyles: ['sequential', 'simultaneous'],\n    modes: ['normal', 'creative', 'analysis'],\n    promotionPieces: ['q', 'r', 'b', 'n', 'Q', 'R', 'B', 'N']\n});\n\n/**\n * Size constraints for validation\n * @constant\n * @type {Object}\n */\nconst SIZE_CONSTRAINTS = Object.freeze({\n    min: 50,\n    max: 2000,\n    maxTime: 10000,\n    maxDelay: 5000\n});\n\n/**\n * Service responsible for validating inputs and data\n * Implements caching for performance optimization\n * @class\n */\nexport class ValidationService {\n    /**\n     * Creates a new ValidationService instance\n     */\n    constructor() {\n        // Cache for validation results to improve performance\n        this._validationCache = new Map();\n        this._cacheMaxSize = 1000;\n        \n        // Compile patterns for reuse\n        this._patterns = VALIDATION_PATTERNS;\n        this._validValues = VALID_VALUES;\n        this._constraints = SIZE_CONSTRAINTS;\n    }\n\n    /**\n     * Validates a square identifier with caching\n     * @param {string} square - Square to validate (e.g., 'e4')\n     * @returns {boolean} True if valid\n     */\n    isValidSquare(square) {\n        const cacheKey = `square:${square}`;\n        \n        if (this._validationCache.has(cacheKey)) {\n            return this._validationCache.get(cacheKey);\n        }\n        \n        const isValid = typeof square === 'string' && \n                        square.length === 2 && \n                        this._patterns.square.test(square);\n        \n        this._cacheValidationResult(cacheKey, isValid);\n        return isValid;\n    }\n\n    /**\n     * Validates a piece identifier with enhanced format support\n     * @param {string} piece - Piece to validate (e.g., 'wK', 'bp')\n     * @returns {boolean} True if valid\n     */\n    isValidPiece(piece) {\n        if (typeof piece !== 'string' || piece.length !== 2) {\n            return false;\n        }\n        \n        const cacheKey = `piece:${piece}`;\n        \n        if (this._validationCache.has(cacheKey)) {\n            return this._validationCache.get(cacheKey);\n        }\n        \n        const [first, second] = piece.split('');\n        \n        // Check both formats: [type][color] and [color][type]\n        const format1 = PIECE_TYPES.includes(first.toLowerCase()) && \n                       PIECE_COLORS.includes(second);\n        const format2 = PIECE_COLORS.includes(first) && \n                       PIECE_TYPES.includes(second.toLowerCase());\n        \n        const isValid = format1 || format2;\n        this._cacheValidationResult(cacheKey, isValid);\n        return isValid;\n    }\n\n    /**\n     * Validates a FEN string with comprehensive checks\n     * @param {string} fen - FEN string to validate\n     * @returns {boolean} True if valid\n     */\n    isValidFen(fen) {\n        if (typeof fen !== 'string') {\n            return false;\n        }\n        \n        const cacheKey = `fen:${fen}`;\n        \n        if (this._validationCache.has(cacheKey)) {\n            return this._validationCache.get(cacheKey);\n        }\n        \n        // Basic pattern check\n        if (!this._patterns.fen.test(fen)) {\n            this._cacheValidationResult(cacheKey, false);\n            return false;\n        }\n        \n        // Additional FEN validation\n        const isValid = this._validateFenStructure(fen);\n        this._cacheValidationResult(cacheKey, isValid);\n        return isValid;\n    }\n\n    /**\n     * Validates FEN structure in detail\n     * @private\n     * @param {string} fen - FEN string to validate\n     * @returns {boolean} True if valid\n     */\n    _validateFenStructure(fen) {\n        const parts = fen.split(' ');\n        \n        if (parts.length !== 6) {\n            return false;\n        }\n        \n        // Validate piece placement\n        const ranks = parts[0].split('/');\n        if (ranks.length !== 8) {\n            return false;\n        }\n        \n        // Validate each rank\n        for (const rank of ranks) {\n            if (!this._validateRank(rank)) {\n                return false;\n            }\n        }\n        \n        // Validate active color\n        if (!['w', 'b'].includes(parts[1])) {\n            return false;\n        }\n        \n        // Validate castling rights\n        if (!/^[KQkq-]*$/.test(parts[2])) {\n            return false;\n        }\n        \n        // Validate en passant target\n        if (parts[3] !== '-' && !this.isValidSquare(parts[3])) {\n            return false;\n        }\n        \n        // Validate halfmove clock and fullmove number\n        const halfmove = parseInt(parts[4], 10);\n        const fullmove = parseInt(parts[5], 10);\n        \n        return !isNaN(halfmove) && !isNaN(fullmove) && \n               halfmove >= 0 && fullmove >= 1;\n    }\n\n    /**\n     * Validates a single rank in FEN notation\n     * @private\n     * @param {string} rank - Rank to validate\n     * @returns {boolean} True if valid\n     */\n    _validateRank(rank) {\n        let squares = 0;\n        \n        for (let i = 0; i < rank.length; i++) {\n            const char = rank[i];\n            \n            if (/[1-8]/.test(char)) {\n                squares += parseInt(char, 10);\n            } else if (/[prnbqkPRNBQK]/.test(char)) {\n                squares += 1;\n            } else {\n                return false;\n            }\n        }\n        \n        return squares === 8;\n    }\n\n    /**\n     * Validates a move string with comprehensive format support\n     * @param {string} move - Move string to validate (e.g., 'e2e4', 'e7e8q')\n     * @returns {boolean} True if valid\n     */\n    isValidMove(move) {\n        if (typeof move !== 'string') {\n            return false;\n        }\n        \n        const cacheKey = `move:${move}`;\n        \n        if (this._validationCache.has(cacheKey)) {\n            return this._validationCache.get(cacheKey);\n        }\n        \n        const isValid = this._validateMoveFormat(move);\n        this._cacheValidationResult(cacheKey, isValid);\n        return isValid;\n    }\n\n    /**\n     * Validates move format in detail\n     * @private\n     * @param {string} move - Move string to validate\n     * @returns {boolean} True if valid\n     */\n    _validateMoveFormat(move) {\n        if (move.length < 4 || move.length > 5) {\n            return false;\n        }\n        \n        const from = move.slice(0, 2);\n        const to = move.slice(2, 4);\n        const promotion = move.slice(4, 5);\n        \n        if (!this.isValidSquare(from) || !this.isValidSquare(to)) {\n            return false;\n        }\n        \n        if (promotion && !this._validValues.promotionPieces.includes(promotion)) {\n            return false;\n        }\n        \n        // Additional move validation (e.g., source and target different)\n        return from !== to;\n    }\n\n    /**\n     * Validates board orientation\n     * @param {string} orientation - Orientation to validate\n     * @returns {boolean} True if valid\n     */\n    isValidOrientation(orientation) {\n        return this._validValues.orientations.includes(orientation);\n    }\n\n    /**\n     * Validates a color value\n     * @param {string} color - Color to validate\n     * @returns {boolean} True if valid\n     */\n    isValidColor(color) {\n        return this._validValues.colors.includes(color);\n    }\n\n    /**\n     * Validates a size value with constraints\n     * @param {number|string} size - Size to validate\n     * @returns {boolean} True if valid\n     */\n    isValidSize(size) {\n        if (size === 'auto') {\n            return true;\n        }\n        \n        if (typeof size === 'number') {\n            return size >= this._constraints.min && size <= this._constraints.max;\n        }\n        \n        return false;\n    }\n\n    /**\n     * Validates a time value with constraints\n     * @param {number} time - Time value to validate\n     * @returns {boolean} True if valid\n     */\n    isValidTime(time) {\n        return typeof time === 'number' && \n               time >= 0 && \n               time <= this._constraints.maxTime;\n    }\n\n    /**\n     * Validates a callback function\n     * @param {Function} callback - Callback to validate\n     * @returns {boolean} True if valid\n     */\n    isValidCallback(callback) {\n        return typeof callback === 'function';\n    }\n\n    /**\n     * Validates a DOM element ID\n     * @param {string} id - Element ID to validate\n     * @returns {boolean} True if valid\n     */\n    isValidElementId(id) {\n        return typeof id === 'string' && \n               id.length > 0 && \n               id.length <= 100 && // Reasonable length limit\n               /^[a-zA-Z][\\w:-]*$/.test(id); // Valid HTML ID format\n    }\n\n    /**\n     * Validates movable colors configuration\n     * @param {string} colors - Colors value to validate\n     * @returns {boolean} True if valid\n     */\n    isValidMovableColors(colors) {\n        return this._validValues.movableColors.includes(colors);\n    }\n\n    /**\n     * Validates drop off board configuration\n     * @param {string} dropOff - Drop off board value to validate\n     * @returns {boolean} True if valid\n     */\n    isValidDropOffBoard(dropOff) {\n        return this._validValues.dropOffBoard.includes(dropOff);\n    }\n\n    /**\n     * Validates animation easing type\n     * @param {string} easing - Easing type to validate\n     * @returns {boolean} True if valid\n     */\n    isValidEasing(easing) {\n        return this._validValues.easingTypes.includes(easing);\n    }\n\n    /**\n     * Validates animation style\n     * @param {string} style - Animation style to validate\n     * @returns {boolean} True if valid\n     */\n    isValidAnimationStyle(style) {\n        return this._validValues.animationStyles.includes(style);\n    }\n\n    /**\n     * Validates CSS color format\n     * @param {string} color - Color string to validate\n     * @returns {boolean} True if valid\n     */\n    isValidCSSColor(color) {\n        if (typeof color !== 'string') {\n            return false;\n        }\n        \n        // Check for hex colors\n        if (this._patterns.color.test(color)) {\n            return true;\n        }\n        \n        // Check for named colors (basic set)\n        const namedColors = ['white', 'black', 'red', 'green', 'blue', 'yellow', 'cyan', 'magenta'];\n        if (namedColors.includes(color.toLowerCase())) {\n            return true;\n        }\n        \n        // Check for rgb/rgba format\n        if (/^rgb\\(\\s*\\d+\\s*,\\s*\\d+\\s*,\\s*\\d+\\s*\\)$/.test(color) ||\n            /^rgba\\(\\s*\\d+\\s*,\\s*\\d+\\s*,\\s*\\d+\\s*,\\s*[0-1](\\.\\d+)?\\s*\\)$/.test(color)) {\n            return true;\n        }\n        \n        return false;\n    }\n\n    /**\n     * Validates and sanitizes a square identifier\n     * @param {string} square - Square to validate\n     * @returns {string} Sanitized square\n     * @throws {ValidationError} If square is invalid\n     */\n    validateSquare(square) {\n        if (!this.isValidSquare(square)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_square + square, \n                'square', \n                square\n            );\n        }\n        return square.toLowerCase();\n    }\n\n    /**\n     * Validates and sanitizes a piece identifier\n     * @param {string} piece - Piece to validate\n     * @returns {string} Sanitized piece\n     * @throws {ValidationError} If piece is invalid\n     */\n    validatePiece(piece) {\n        if (!this.isValidPiece(piece)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_piece + piece, \n                'piece', \n                piece\n            );\n        }\n        return piece.toLowerCase();\n    }\n\n    /**\n     * Validates and sanitizes a FEN string\n     * @param {string} fen - FEN to validate\n     * @returns {string} Sanitized FEN\n     * @throws {ValidationError} If FEN is invalid\n     */\n    validateFen(fen) {\n        if (!this.isValidFen(fen)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_fen + fen, \n                'fen', \n                fen\n            );\n        }\n        return fen.trim();\n    }\n\n    /**\n     * Validates and sanitizes a move string\n     * @param {string} move - Move to validate\n     * @returns {string} Sanitized move\n     * @throws {ValidationError} If move is invalid\n     */\n    validateMove(move) {\n        if (!this.isValidMove(move)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_move + move, \n                'move', \n                move\n            );\n        }\n        return move.toLowerCase();\n    }\n\n    /**\n     * Validates and sanitizes orientation\n     * @param {string} orientation - Orientation to validate\n     * @returns {string} Sanitized orientation ('w' or 'b')\n     * @throws {ValidationError} If orientation is invalid\n     */\n    validateOrientation(orientation) {\n        if (!this.isValidOrientation(orientation)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_orientation + orientation, \n                'orientation', \n                orientation\n            );\n        }\n        \n        // Normalize to 'w' or 'b'\n        return orientation === 'white' ? 'w' : \n               orientation === 'black' ? 'b' : \n               orientation;\n    }\n\n    /**\n     * Validates and sanitizes color\n     * @param {string} color - Color to validate\n     * @returns {string} Sanitized color ('w' or 'b')\n     * @throws {ValidationError} If color is invalid\n     */\n    validateColor(color) {\n        if (!this.isValidColor(color)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_color + color, \n                'color', \n                color\n            );\n        }\n        \n        // Normalize to 'w' or 'b'\n        return color === 'white' ? 'w' : \n               color === 'black' ? 'b' : \n               color;\n    }\n\n    /**\n     * Validates and sanitizes size\n     * @param {number|string} size - Size to validate\n     * @returns {number|string} Sanitized size\n     * @throws {ValidationError} If size is invalid\n     */\n    validateSize(size) {\n        if (!this.isValidSize(size)) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_size + size, \n                'size', \n                size\n            );\n        }\n        return size;\n    }\n\n    /**\n     * Validates configuration object with comprehensive checks\n     * @param {Object} config - Configuration to validate\n     * @returns {Object} Validated configuration\n     * @throws {ValidationError} If configuration is invalid\n     */\n    validateConfig(config) {\n        if (!config || typeof config !== 'object') {\n            throw new ValidationError(\n                'Configuration must be an object', \n                'config', \n                config\n            );\n        }\n        \n        const errors = [];\n        \n        // Validate required fields\n        if (!config.id && !config.id_div) {\n            errors.push('Configuration must include id or id_div');\n        }\n        \n        // Validate optional fields\n        if (config.orientation && !this.isValidOrientation(config.orientation)) {\n            errors.push(ERROR_MESSAGES.invalid_orientation + config.orientation);\n        }\n        \n        if (config.size && !this.isValidSize(config.size)) {\n            errors.push(ERROR_MESSAGES.invalid_size + config.size);\n        }\n        \n        if (config.movableColors && !this.isValidMovableColors(config.movableColors)) {\n            errors.push(ERROR_MESSAGES.invalid_color + config.movableColors);\n        }\n        \n        if (config.dropOffBoard && !this.isValidDropOffBoard(config.dropOffBoard)) {\n            errors.push(ERROR_MESSAGES.invalid_dropOffBoard + config.dropOffBoard);\n        }\n        \n        if (config.animationStyle && !this.isValidAnimationStyle(config.animationStyle)) {\n            errors.push(ERROR_MESSAGES.invalid_animationStyle + config.animationStyle);\n        }\n        \n        // Validate callbacks\n        const callbacks = ['onMove', 'onMoveEnd', 'onChange', 'onDragStart', 'onDragMove', 'onDrop', 'onSnapbackEnd'];\n        for (const callback of callbacks) {\n            if (config[callback] && !this.isValidCallback(config[callback])) {\n                errors.push(`Invalid ${callback} callback`);\n            }\n        }\n        \n        // Validate colors\n        const colorFields = ['whiteSquare', 'blackSquare', 'highlight', 'hintColor'];\n        for (const field of colorFields) {\n            if (config[field] && !this.isValidCSSColor(config[field])) {\n                errors.push(`Invalid ${field} color: ${config[field]}`);\n            }\n        }\n        \n        if (errors.length > 0) {\n            throw new ValidationError(\n                `Configuration validation failed: ${errors.join(', ')}`, \n                'config', \n                config\n            );\n        }\n        \n        return config;\n    }\n\n    /**\n     * Caches validation result for performance\n     * @private\n     * @param {string} key - Cache key\n     * @param {boolean} result - Validation result\n     */\n    _cacheValidationResult(key, result) {\n        if (this._validationCache.size >= this._cacheMaxSize) {\n            // Remove oldest entry\n            const firstKey = this._validationCache.keys().next().value;\n            this._validationCache.delete(firstKey);\n        }\n        \n        this._validationCache.set(key, result);\n    }\n\n    /**\n     * Clears the validation cache\n     */\n    clearCache() {\n        this._validationCache.clear();\n    }\n\n    /**\n     * Gets validation cache statistics\n     * @returns {Object} Cache statistics\n     */\n    getCacheStats() {\n        return {\n            size: this._validationCache.size,\n            maxSize: this._cacheMaxSize,\n            hitRate: this._cacheHits / (this._cacheHits + this._cacheMisses) || 0\n        };\n    }\n\n    /**\n     * Batch validates multiple values\n     * @param {Array} validations - Array of validation objects\n     * @returns {Array} Array of validation results\n     */\n    batchValidate(validations) {\n        return validations.map(validation => {\n            try {\n                const { type, value } = validation;\n                \n                switch (type) {\n                    case 'square':\n                        return { valid: this.isValidSquare(value), value };\n                    case 'piece':\n                        return { valid: this.isValidPiece(value), value };\n                    case 'fen':\n                        return { valid: this.isValidFen(value), value };\n                    case 'move':\n                        return { valid: this.isValidMove(value), value };\n                    default:\n                        return { valid: false, value, error: 'Unknown validation type' };\n                }\n            } catch (error) {\n                return { valid: false, value: validation.value, error: error.message };\n            }\n        });\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        this.clearCache();\n        this._validationCache = null;\n        this._patterns = null;\n        this._validValues = null;\n        this._constraints = null;\n    }\n}\n","/**\n * Configuration management for Chessboard.js\n * @module core/ChessboardConfig\n * @since 2.0.0\n */\n\nimport { ValidationService } from '../services/ValidationService.js';\nimport { ConfigurationError } from '../errors/ChessboardError.js';\n\n/**\n * Animation timing constants\n * @constant\n * @type {Object}\n */\nconst ANIMATION_TIMES = Object.freeze({\n    fast: 200,\n    slow: 600,\n    normal: 400,\n    verySlow: 1000,\n    veryFast: 100\n});\n\n/**\n * Boolean value mappings\n * @constant\n * @type {Object}\n */\nconst BOOLEAN_VALUES = Object.freeze({\n    true: true,\n    false: false,\n    none: false,\n    1: true,\n    0: false\n});\n\n/**\n * CSS transition functions\n * @constant\n * @type {Object}\n */\nconst TRANSITION_FUNCTIONS = Object.freeze({\n    ease: 'ease',\n    linear: 'linear',\n    'ease-in': 'ease-in',\n    'ease-out': 'ease-out',\n    'ease-in-out': 'ease-in-out',\n    none: null\n});\n\n/**\n * Default configuration values\n * @constant\n * @type {Object}\n */\nconst DEFAULT_CONFIG = Object.freeze({\n    id: 'board',\n    position: 'start',\n    orientation: 'w',\n    mode: 'normal',\n    size: 'auto',\n    draggable: true,\n    hints: true,\n    clickable: true,\n    movableColors: 'both',\n    moveHighlight: true,\n    overHighlight: true,\n    moveAnimation: 'ease',\n    moveTime: 'fast',\n    dropOffBoard: 'snapback',\n    snapbackTime: 'fast',\n    snapbackAnimation: 'ease',\n    dropCenterTime: 'veryFast',\n    dropCenterAnimation: 'ease',\n    fadeTime: 'fast',\n    fadeAnimation: 'ease',\n    ratio: 0.9,\n    piecesPath: '../assets/themes/default',\n    animationStyle: 'simultaneous',\n    simultaneousAnimationDelay: 100,\n    onMove: () => true,\n    onMoveEnd: () => true,\n    onChange: () => true,\n    onDragStart: () => true,\n    onDragMove: () => true,\n    onDrop: () => true,\n    onSnapbackEnd: () => true,\n    whiteSquare: '#f0d9b5',\n    blackSquare: '#b58863',\n    highlight: 'yellow',\n    selectedSquareWhite: '#ababaa',\n    selectedSquareBlack: '#ababaa',\n    movedSquareWhite: '#f1f1a0',\n    movedSquareBlack: '#e9e981',\n    choiceSquare: 'white',\n    coverSquare: 'black',\n    hintColor: '#ababaa'\n});\n\n/**\n * Configuration management class for Chessboard.js\n * Handles validation, normalization, and CSS property management\n * @class\n */\nclass ChessboardConfig {\n    /**\n     * Creates a new ChessboardConfig instance\n     * @param {Object} settings - User-provided configuration\n     * @throws {ConfigurationError} If configuration is invalid\n     */\n    constructor(settings = {}) {\n        // Initialize validation service\n        this._validationService = new ValidationService();\n\n        // Validate input\n        this._validateInput(settings);\n\n        // Merge with defaults\n        const config = this._mergeWithDefaults(settings);\n\n        // Process and validate configuration\n        this._processConfiguration(config);\n\n        // Set CSS properties\n        this._setCSSProperties(config);\n\n        // Configure mode-specific settings\n        this._configureModeSettings();\n    }\n\n    /**\n     * Validates input configuration\n     * @private\n     * @param {Object} settings - Input settings\n     * @throws {ConfigurationError} If input is invalid\n     */\n    _validateInput(settings) {\n        if (settings !== null && typeof settings !== 'object') {\n            throw new ConfigurationError('Settings must be an object', 'settings', settings);\n        }\n\n        // Validate using validation service\n        try {\n            this._validationService.validateConfig(settings);\n        } catch (error) {\n            throw new ConfigurationError(error.message, error.field, error.value);\n        }\n    }\n\n    /**\n     * Merges user settings with defaults\n     * @private\n     * @param {Object} settings - User settings\n     * @returns {Object} Merged configuration\n     */\n    _mergeWithDefaults(settings) {\n        return Object.assign({}, DEFAULT_CONFIG, settings);\n    }\n\n    /**\n     * Processes and validates configuration values\n     * @private\n     * @param {Object} config - Configuration object\n     */\n    _processConfiguration(config) {\n        // Basic properties\n        this.id_div = config.id;\n        this.position = config.position;\n        this.orientation = config.orientation;\n        this.mode = config.mode;\n        this.dropOffBoard = config.dropOffBoard;\n        this.size = config.size;\n        this.movableColors = config.movableColors;\n        this.piecesPath = config.piecesPath;\n\n        // Event handlers\n        this.onMove = this._validateCallback(config.onMove);\n        this.onMoveEnd = this._validateCallback(config.onMoveEnd);\n        this.onChange = this._validateCallback(config.onChange);\n        this.onDragStart = this._validateCallback(config.onDragStart);\n        this.onDragMove = this._validateCallback(config.onDragMove);\n        this.onDrop = this._validateCallback(config.onDrop);\n        this.onSnapbackEnd = this._validateCallback(config.onSnapbackEnd);\n\n        // Animation properties\n        this.moveAnimation = this._setTransitionFunction(config.moveAnimation);\n        this.snapbackAnimation = this._setTransitionFunction(config.snapbackAnimation);\n        this.dropCenterAnimation = this._setTransitionFunction(config.dropCenterAnimation);\n        this.fadeAnimation = this._setTransitionFunction(config.fadeAnimation);\n\n        // Boolean properties\n        this.hints = this._setBoolean(config.hints);\n        this.clickable = this._setBoolean(config.clickable);\n        this.draggable = this._setBoolean(config.draggable);\n        this.moveHighlight = this._setBoolean(config.moveHighlight);\n        this.overHighlight = this._setBoolean(config.overHighlight);\n\n        // Timing properties\n        this.moveTime = this._setTime(config.moveTime);\n        this.snapbackTime = this._setTime(config.snapbackTime);\n        this.dropCenterTime = this._setTime(config.dropCenterTime);\n        this.fadeTime = this._setTime(config.fadeTime);\n\n        // Animation style properties\n        this.animationStyle = this._validateAnimationStyle(config.animationStyle);\n        this.simultaneousAnimationDelay = this._validateDelay(config.simultaneousAnimationDelay);\n    }\n\n    /**\n     * Sets CSS custom properties\n     * @private\n     * @param {Object} config - Configuration object\n     */\n    _setCSSProperties(config) {\n        const cssProperties = {\n            pieceRatio: config.ratio,\n            whiteSquare: config.whiteSquare,\n            blackSquare: config.blackSquare,\n            highlightSquare: config.highlight,\n            selectedSquareWhite: config.selectedSquareWhite,\n            selectedSquareBlack: config.selectedSquareBlack,\n            movedSquareWhite: config.movedSquareWhite,\n            movedSquareBlack: config.movedSquareBlack,\n            choiceSquare: config.choiceSquare,\n            coverSquare: config.coverSquare,\n            hintColor: config.hintColor\n        };\n\n        Object.entries(cssProperties).forEach(([property, value]) => {\n            this._setCSSProperty(property, value);\n        });\n    }\n\n    /**\n     * Configures mode-specific settings\n     * @private\n     */\n    _configureModeSettings() {\n        switch (this.mode) {\n            case 'creative':\n                this.onlyLegalMoves = false;\n                this.hints = false;\n                break;\n            case 'normal':\n                this.onlyLegalMoves = true;\n                break;\n            default:\n                this.onlyLegalMoves = true;\n        }\n    }\n\n    /**\n     * Validates a callback function\n     * @private\n     * @param {Function} callback - Callback to validate\n     * @returns {Function} Validated callback\n     * @throws {ConfigurationError} If callback is invalid\n     */\n    _validateCallback(callback) {\n        if (!this._validationService.isValidCallback(callback)) {\n            throw new ConfigurationError('Callback must be a function', 'callback', callback);\n        }\n        return callback;\n    }\n\n    /**\n     * Validates animation style\n     * @private\n     * @param {string} style - Animation style\n     * @returns {string} Validated style\n     * @throws {ConfigurationError} If style is invalid\n     */\n    _validateAnimationStyle(style) {\n        if (!this._validationService.isValidAnimationStyle(style)) {\n            throw new ConfigurationError('Invalid animation style', 'animationStyle', style);\n        }\n        return style;\n    }\n\n    /**\n     * Validates animation delay\n     * @private\n     * @param {number} delay - Animation delay\n     * @returns {number} Validated delay\n     * @throws {ConfigurationError} If delay is invalid\n     */\n    _validateDelay(delay) {\n        if (typeof delay !== 'number' || delay < 0 || delay > 5000) {\n            throw new ConfigurationError('Invalid animation delay', 'simultaneousAnimationDelay', delay);\n        }\n        return delay;\n    }\n\n    /**\n     * Sets a CSS custom property\n     * @private\n     * @param {string} property - Property name\n     * @param {string} value - Property value\n     */\n    _setCSSProperty(property, value) {\n        try {\n            if (typeof document !== 'undefined' && document.documentElement) {\n                document.documentElement.style.setProperty(`--${property}`, value);\n            }\n        } catch (error) {\n            console.warn(`Failed to set CSS property ${property}:`, error.message);\n        }\n    }\n\n    /**\n     * Sets orientation with validation\n     * @param {string} orientation - Orientation value\n     * @returns {ChessboardConfig} This instance for chaining\n     * @throws {ConfigurationError} If orientation is invalid\n     */\n    setOrientation(orientation) {\n        const validatedOrientation = this._validationService.validateOrientation(orientation);\n        this.orientation = validatedOrientation;\n        return this;\n    }\n\n    /**\n     * Validates and sets time value\n     * @private\n     * @param {string|number} value - Time value\n     * @returns {number} Validated time value\n     * @throws {ConfigurationError} If time value is invalid\n     */\n    _setTime(value) {\n        if (typeof value === 'number') {\n            if (!this._validationService.isValidTime(value)) {\n                throw new ConfigurationError('Invalid time value', 'time', value);\n            }\n            return value;\n        }\n\n        if (typeof value === 'string' && value in ANIMATION_TIMES) {\n            return ANIMATION_TIMES[value];\n        }\n\n        throw new ConfigurationError('Invalid time value', 'time', value);\n    }\n\n    /**\n     * Validates and sets boolean value\n     * @private\n     * @param {*} value - Boolean value\n     * @returns {boolean} Validated boolean value\n     * @throws {ConfigurationError} If boolean value is invalid\n     */\n    _setBoolean(value) {\n        if (typeof value === 'boolean') {\n            return value;\n        }\n\n        if (value in BOOLEAN_VALUES) {\n            return BOOLEAN_VALUES[value];\n        }\n\n        throw new ConfigurationError('Invalid boolean value', 'boolean', value);\n    }\n\n    /**\n     * Validates and sets transition function\n     * @private\n     * @param {string|boolean|null} value - Transition function value\n     * @returns {string|null} Validated transition function\n     * @throws {ConfigurationError} If transition function is invalid\n     */\n    _setTransitionFunction(value) {\n        // Handle boolean values - true means use default 'ease', false/null means no animation\n        if (typeof value === 'boolean') {\n            return value ? TRANSITION_FUNCTIONS.ease : null;\n        }\n\n        // Handle string values\n        if (typeof value === 'string' && value in TRANSITION_FUNCTIONS) {\n            return TRANSITION_FUNCTIONS[value];\n        }\n\n        // Handle null/undefined\n        if (value === null || value === undefined) {\n            return null;\n        }\n\n        throw new ConfigurationError('Invalid transition function', 'transitionFunction', value);\n    }\n\n    /**\n     * Gets the current configuration as a plain object\n     * @returns {Object} Configuration object\n     */\n    toObject() {\n        return {\n            id_div: this.id_div,\n            position: this.position,\n            orientation: this.orientation,\n            mode: this.mode,\n            size: this.size,\n            draggable: this.draggable,\n            hints: this.hints,\n            clickable: this.clickable,\n            movableColors: this.movableColors,\n            moveHighlight: this.moveHighlight,\n            overHighlight: this.overHighlight,\n            moveAnimation: this.moveAnimation,\n            moveTime: this.moveTime,\n            dropOffBoard: this.dropOffBoard,\n            snapbackTime: this.snapbackTime,\n            snapbackAnimation: this.snapbackAnimation,\n            dropCenterTime: this.dropCenterTime,\n            dropCenterAnimation: this.dropCenterAnimation,\n            fadeTime: this.fadeTime,\n            fadeAnimation: this.fadeAnimation,\n            piecesPath: this.piecesPath,\n            animationStyle: this.animationStyle,\n            simultaneousAnimationDelay: this.simultaneousAnimationDelay,\n            onlyLegalMoves: this.onlyLegalMoves\n        };\n    }\n\n    /**\n     * Updates configuration with new values\n     * @param {Object} updates - Configuration updates\n     * @returns {ChessboardConfig} This instance for chaining\n     * @throws {ConfigurationError} If updates are invalid\n     */\n    update(updates) {\n        if (!updates || typeof updates !== 'object') {\n            throw new ConfigurationError('Updates must be an object', 'updates', updates);\n        }\n\n        // Validate updates\n        this._validationService.validateConfig(updates);\n\n        // Apply updates\n        const newConfig = Object.assign({}, this.toObject(), updates);\n\n        // Re-process configuration\n        this._processConfiguration(newConfig);\n        this._setCSSProperties(newConfig);\n        this._configureModeSettings();\n\n        return this;\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        if (this._validationService) {\n            this._validationService.destroy();\n            this._validationService = null;\n        }\n    }\n}\n\nexport { ChessboardConfig };\nexport default ChessboardConfig;","class Piece {\n    constructor(color, type, src, opacity = 1) {\n        this.color = color;\n        this.type = type;\n        this.id = this.getId();\n        this.src = src;\n        this.element = this.createElement(src, opacity);\n        console.debug(`[Piece] Constructed: ${this.id}`);\n        this.check();\n    }\n\n    getId() { return this.type + this.color }\n\n    createElement(src, opacity = 1) {\n        const element = document.createElement(\"img\");\n        element.classList.add(\"piece\");\n        element.id = this.id;\n        element.src = src || this.src;\n        element.style.opacity = opacity;\n\n        // Ensure the image loads properly\n        element.onerror = () => {\n            console.warn('Failed to load piece image:', element.src);\n        };\n\n        return element;\n    }\n\n    visible() { if (this.element) { this.element.style.opacity = 1; console.debug(`[Piece] visible: ${this.id}`); } }\n\n    invisible() { if (this.element) { this.element.style.opacity = 0; console.debug(`[Piece] invisible: ${this.id}`); } }\n\n    /**\n     * Updates the piece image source\n     * @param {string} newSrc - New image source\n     */\n    updateSrc(newSrc) {\n        this.src = newSrc;\n        if (this.element) {\n            this.element.src = newSrc;\n        }\n    }\n\n    /**\n     * Transforms the piece to a new type with smooth animation\n     * @param {string} newType - New piece type\n     * @param {string} newSrc - New image source\n     * @param {number} [duration=200] - Animation duration in milliseconds\n     * @param {Function} [callback] - Callback when transformation is complete\n     */\n    transformTo(newType, newSrc, duration = 200, callback = null) {\n        if (!this.element) { console.debug(`[Piece] transformTo: ${this.id} - element is null`); if (callback) callback(); return; }\n        const element = this.element;\n        const oldSrc = element.src;\n\n        // Add transformation class to disable all transitions temporarily\n        element.classList.add('transforming');\n\n        // Create a smooth scale animation for the transformation\n        const scaleDown = [\n            { transform: 'scale(1)', opacity: '1' },\n            { transform: 'scale(0.8)', opacity: '0.7' }\n        ];\n\n        const scaleUp = [\n            { transform: 'scale(0.8)', opacity: '0.7' },\n            { transform: 'scale(1)', opacity: '1' }\n        ];\n\n        const halfDuration = duration / 2;\n\n        // First animation: scale down\n        if (element.animate) {\n            const scaleDownAnimation = element.animate(scaleDown, {\n                duration: halfDuration,\n                easing: 'ease-in',\n                fill: 'forwards'\n            });\n\n            scaleDownAnimation.onfinish = () => {\n                if (!this.element) { console.debug(`[Piece] transformTo.scaleDown.onfinish: ${this.id} - element is null`); if (callback) callback(); return; }\n                // Change the piece type and source at the smallest scale\n                this.type = newType;\n                this.id = this.getId();\n                this.src = newSrc;\n                element.src = newSrc;\n                element.id = this.id;\n\n                // Second animation: scale back up\n                const scaleUpAnimation = element.animate(scaleUp, {\n                    duration: halfDuration,\n                    easing: 'ease-out',\n                    fill: 'forwards'\n                });\n\n                scaleUpAnimation.onfinish = () => {\n                    if (!this.element) { console.debug(`[Piece] transformTo.scaleUp.onfinish: ${this.id} - element is null`); if (callback) callback(); return; }\n                    // Reset transform and remove transformation class\n                    element.style.transform = '';\n                    element.style.opacity = '';\n                    element.classList.remove('transforming');\n\n                    // Add a subtle bounce effect\n                    element.classList.add('transform-complete');\n\n                    // Remove bounce class after animation\n                    setTimeout(() => {\n                        if (!this.element) return;\n                        element.classList.remove('transform-complete');\n                    }, 400);\n\n                    console.debug(`[Piece] transformTo complete: ${this.id}`);\n                    if (callback) callback();\n                };\n            };\n        } else {\n            // Fallback for browsers without Web Animations API\n            element.style.transition = `transform ${halfDuration}ms ease-in, opacity ${halfDuration}ms ease-in`;\n            element.style.transform = 'scale(0.8)';\n            element.style.opacity = '0.7';\n\n            setTimeout(() => {\n                if (!this.element) { console.debug(`[Piece] transformTo (fallback): ${this.id} - element is null`); if (callback) callback(); return; }\n                // Change the piece\n                this.type = newType;\n                this.id = this.getId();\n                this.src = newSrc;\n                element.src = newSrc;\n                element.id = this.id;\n\n                // Scale back up\n                element.style.transition = `transform ${halfDuration}ms ease-out, opacity ${halfDuration}ms ease-out`;\n                element.style.transform = 'scale(1)';\n                element.style.opacity = '1';\n\n                setTimeout(() => {\n                    if (!this.element) { console.debug(`[Piece] transformTo (fallback, cleanup): ${this.id} - element is null`); if (callback) callback(); return; }\n                    // Clean up\n                    element.style.transition = '';\n                    element.style.transform = '';\n                    element.style.opacity = '';\n                    element.classList.remove('transforming');\n\n                    // Add bounce effect\n                    element.classList.add('transform-complete');\n                    setTimeout(() => {\n                        if (!this.element) return;\n                        element.classList.remove('transform-complete');\n                    }, 400);\n\n                    console.debug(`[Piece] transformTo complete (fallback): ${this.id}`);\n                    if (callback) callback();\n                }, halfDuration);\n            }, halfDuration);\n        }\n    }\n\n    fadeIn(duration, speed, transition_f, callback) {\n        const start = performance.now();\n        let opacity = 0;\n        const piece = this;\n        const fade = function () {\n            if (!piece.element) { console.debug(`[Piece] fadeIn: ${piece.id} - element is null`); if (callback) callback(); return; }\n            const elapsed = performance.now() - start;\n            opacity = transition_f(elapsed, duration, speed);\n            piece.element.style.opacity = opacity;\n            if (elapsed < duration) {\n                requestAnimationFrame(fade);\n            } else {\n                if (!piece.element) { console.debug(`[Piece] fadeIn: ${piece.id} - element is null (end)`); if (callback) callback(); return; }\n                piece.element.style.opacity = 1;\n                console.debug(`[Piece] fadeIn complete: ${piece.id}`);\n                if (callback) callback();\n            }\n        }\n        fade();\n    }\n\n    fadeOut(duration, speed, transition_f, callback) {\n        const start = performance.now();\n        let opacity = 1;\n        const piece = this;\n        const fade = function () {\n            if (!piece.element) { console.debug(`[Piece] fadeOut: ${piece.id} - element is null`); if (callback) callback(); return; }\n            const elapsed = performance.now() - start;\n            opacity = 1 - transition_f(elapsed, duration, speed);\n            piece.element.style.opacity = opacity;\n            if (elapsed < duration) {\n                requestAnimationFrame(fade);\n            } else {\n                if (!piece.element) { console.debug(`[Piece] fadeOut: ${piece.id} - element is null (end)`); if (callback) callback(); return; }\n                piece.element.style.opacity = 0;\n                console.debug(`[Piece] fadeOut complete: ${piece.id}`);\n                if (callback) callback();\n            }\n        }\n        fade();\n    }\n\n    setDrag(f) {\n        if (!this.element) { console.debug(`[Piece] setDrag: ${this.id} - element is null`); return; }\n        \n        // Remove any existing drag handlers first\n        if (this._dragHandler) {\n            this.element.removeEventListener('mousedown', this._dragHandler);\n        }\n        \n        this.element.ondragstart = (e) => { e.preventDefault() };\n        \n        // Use the drag function directly without timeout\n        this._dragHandler = f;\n        this.element.addEventListener('mousedown', this._dragHandler);\n        console.debug(`[Piece] setDrag: ${this.id}`);\n    }\n\n    destroy() {\n        console.debug(`[Piece] Destroy: ${this.id}`);\n        \n        // Remove all event listeners\n        if (this.element) {\n            if (this._dragHandler) {\n                this.element.removeEventListener('mousedown', this._dragHandler);\n                this._dragHandler = null;\n            }\n            \n            this.element.onmousedown = null;\n            this.element.ondragstart = null;\n\n            // Remove from DOM\n            if (this.element.parentNode) {\n                this.element.parentNode.removeChild(this.element);\n            }\n\n            // Clear references\n            this.element = null;\n        }\n    }\n\n    translate(to, duration, transition_f, speed, callback = null) {\n        if (!this.element) { console.debug(`[Piece] translate: ${this.id} - element is null`); if (callback) callback(); return; }\n        const sourceRect = this.element.getBoundingClientRect();\n        const targetRect = to.getBoundingClientRect();\n        const x_start = sourceRect.left + sourceRect.width / 2;\n        const y_start = sourceRect.top + sourceRect.height / 2;\n        const x_end = targetRect.left + targetRect.width / 2;\n        const y_end = targetRect.top + targetRect.height / 2;\n        const dx = x_end - x_start;\n        const dy = y_end - y_start;\n\n        const keyframes = [\n            { transform: 'translate(0, 0)' },\n            { transform: `translate(${dx}px, ${dy}px)` }\n        ];\n\n        if (this.element.animate) {\n            const animation = this.element.animate(keyframes, {\n                duration,\n                easing: 'ease',\n                fill: 'none'\n            });\n\n            animation.onfinish = () => {\n                if (!this.element) { console.debug(`[Piece] translate.onfinish: ${this.id} - element is null`); if (callback) callback(); return; }\n                if (callback) callback();\n                if (this.element) this.element.style = '';\n                console.debug(`[Piece] translate complete: ${this.id}`);\n            };\n        } else {\n            this.element.style.transition = `transform ${duration}ms ease`;\n            this.element.style.transform = `translate(${dx}px, ${dy}px)`;\n            if (callback) callback();\n            if (this.element) this.element.style = '';\n            console.debug(`[Piece] translate complete (no animate): ${this.id}`);\n        }\n    }\n\n    check() {\n        if (['p', 'r', 'n', 'b', 'q', 'k'].indexOf(this.type) === -1) {\n            throw new Error(\"Invalid piece type\");\n        }\n\n        if (['w', 'b'].indexOf(this.color) === -1) {\n            throw new Error(\"Invalid piece color\");\n        }\n    }\n}\n\nexport default Piece;\n","import Piece from \"./Piece.js\";\n\nclass Square {\n\n    constructor(row, col) {\n        this.row = row;\n        this.col = col;\n        this.id = this.getId();\n        this.element = this.createElement();\n        this.piece = null;\n    }\n\n    getPiece() {\n        return this.piece;\n    }\n\n    opposite() {\n        this.row = 9 - this.row;\n        this.col = 9 - this.col;\n        this.id = this.getId();\n        this.element = this.resetElement();\n    }\n\n    isWhite() {\n        return (this.row + this.col) % 2 === 0;\n    }\n\n    getId() {\n        const letters = 'abcdefgh';\n        const letter = letters[this.col - 1];\n        return letter + this.row;\n    }\n\n    resetElement() {\n        this.element.id = this.id;\n        this.element.className = '';\n        this.element.classList.add('square');\n        this.element.classList.add(this.isWhite() ? 'whiteSquare' : 'blackSquare');\n    }\n\n    createElement() {\n        const element = document.createElement('div');\n        element.id = this.id;\n        element.classList.add('square');\n        element.classList.add(this.isWhite() ? 'whiteSquare' : 'blackSquare');\n        return element;\n    }\n\n    getElement() {\n        return this.element;\n    }\n\n    getBoundingClientRect() {\n        return this.element.getBoundingClientRect();\n    }\n\n    removePiece(preserve = false) {\n        if (!this.piece) {\n            return null;\n        }\n        // Only destroy the piece if not preserving (i.e., not moving)\n        if (!preserve && typeof this.piece.destroy === 'function') {\n            this.piece.destroy();\n        }\n        this.piece = null;\n        return null;\n    }\n\n    /**\n     * Forcefully removes all pieces from this square\n     */\n    forceRemoveAllPieces() {\n        // Best practice: destroy the piece object if present\n        if (this.piece && typeof this.piece.destroy === 'function') {\n            this.piece.destroy();\n            this.piece = null;\n        }\n        // Remove any orphaned img.piece elements from the DOM\n        const pieceElements = this.element.querySelectorAll('img.piece');\n        pieceElements.forEach(element => {\n            if (element.parentNode === this.element) {\n                this.element.removeChild(element);\n            }\n        });\n    }\n\n    /**\n     * Replaces the current piece with a new one efficiently\n     * @param {Piece} newPiece - The new piece to place\n     */\n    replacePiece(newPiece) {\n        // If there's an existing piece, remove it first\n        if (this.piece) {\n            this.removePiece();\n        }\n\n        // Add the new piece\n        this.putPiece(newPiece);\n\n        // Ensure the piece is properly displayed\n        newPiece.element.style.opacity = '1';\n    }\n\n    addEventListener(event, callback) {\n        this.element.addEventListener(event, callback);\n    }\n\n    putPiece(piece) {\n        // If there's already a piece, remove it first, but preserve if moving\n        if (this.piece) {\n            this.removePiece(true);\n        }\n        this.piece = piece;\n        if (piece && piece.element) {\n            this.element.appendChild(piece.element);\n        }\n    }\n\n    putHint(catchable) {\n        if (this.element.querySelector('.hint')) {\n            return;\n        }\n        const hint = document.createElement(\"div\");\n        hint.classList.add('hint');\n        this.element.appendChild(hint);\n        if (catchable) {\n            hint.classList.add('catchable');\n        }\n    }\n\n    removeHint() {\n        const hint = this.element.querySelector('.hint');\n        if (hint) {\n            this.element.removeChild(hint);\n        }\n    }\n\n    select() {\n        this.element.classList.add(this.isWhite() ? 'selectedSquareWhite' : 'selectedSquareBlack');\n    }\n\n    deselect() {\n        this.element.classList.remove('selectedSquareWhite');\n        this.element.classList.remove('selectedSquareBlack');\n    }\n\n    moved() {\n        this.element.classList.add(this.isWhite() ? 'movedSquareWhite' : 'movedSquareBlack');\n    }\n\n    unmoved() {\n        this.element.classList.remove('movedSquareWhite');\n        this.element.classList.remove('movedSquareBlack');\n    }\n\n    highlight() {\n        this.element.classList.add('highlighted');\n    }\n\n    dehighlight() {\n        this.element.classList.remove('highlighted');\n    }\n\n    putCover(callback) {\n        const cover = document.createElement(\"div\");\n        cover.classList.add('square');\n        cover.classList.add('cover');\n        this.element.appendChild(cover);\n        cover.addEventListener('click', (e) => {\n            e.stopPropagation();\n            callback();\n        });\n    }\n\n    removeCover() {\n        const cover = this.element.querySelector('.cover');\n        if (cover) {\n            this.element.removeChild(cover);\n        }\n    }\n\n    putPromotion(src, callback) {\n        const choice = document.createElement(\"div\");\n        choice.classList.add('square');\n        choice.classList.add('choice');\n        this.element.appendChild(choice);\n        const img = document.createElement(\"img\");\n        img.classList.add(\"piece\");\n        img.classList.add(\"choicable\");\n        img.src = src;\n        choice.appendChild(img);\n        choice.addEventListener('click', (e) => {\n            e.stopPropagation();\n            callback();\n        });\n\n    }\n\n    hasPromotion() {\n        return this.element.querySelector('.choice') !== null;\n    }\n\n    removePromotion() {\n        const choice = this.element.querySelector('.choice');\n        if (choice) {\n            choice.removeChild(choice.firstChild);\n            this.element.removeChild(choice);\n        }\n    }\n\n    destroy() {\n        // Remove all piece DOM nodes and clear reference\n        this.forceRemoveAllPieces();\n        this.element.remove();\n        this.piece = null;\n    }\n\n    hasPiece() {\n        return this.piece !== null;\n    }\n\n    getColor() {\n        return this.piece.getColor();\n    }\n\n    check() {\n        if (this.row < 1 || this.row > 8) {\n            throw new Error(\"Invalid square: row is out of bounds\");\n        }\n        if (this.col < 1 || this.col > 8) {\n            throw new Error(\"Invalid square: col is out of bounds\");\n        }\n\n    }\n}\n\nexport default Square;","import Piece from \"./Piece.js\";\nimport Square from \"./Square.js\";\n\nclass Move {\n\n    constructor(from, to, promotion = null, check = false) {\n        this.piece = from ? from.getPiece() : null;\n        this.from = from;\n        this.to = to;\n        this.promotion = promotion;\n\n        if (check) this.check();\n    }\n\n    hasPromotion() {\n        return this.promotion !== null;\n    }\n\n    setPromotion(promotion) {\n        this.promotion = promotion;\n    }\n\n    check() {\n        if (this.piece === null) return false;\n        if (!(this.piece instanceof Piece)) return false;\n        if (['q', 'r', 'b', 'n', null].indexOf(this.promotion) === -1) return false;\n        if (!(this.from instanceof Square)) return false;\n        if (!(this.to instanceof Square)) return false;\n        if (!this.to) return false;\n        if (!this.from) return false;\n        if (this.from === this.to) return false;\n        return true;\n    }\n\n    isLegal(game) {\n        const destinations = game.moves({ square: this.from.id, verbose: true }).map(move => move.to);\n        return destinations.indexOf(this.to.id) !== -1;\n    }\n\n\n}\n\nexport default Move;","/**\n * Service for managing animations and transitions\n * @module services/AnimationService\n * @since 2.0.0\n */\n\n/**\n * Service responsible for coordinating animations and transitions\n * @class\n */\nexport class AnimationService {\n    /**\n     * Creates a new AnimationService instance\n     * @param {ChessboardConfig} config - Board configuration\n     */\n    constructor(config) {\n        this.config = config;\n        this.activeAnimations = new Map();\n        this.animationId = 0;\n    }\n\n    /**\n     * Creates a timing function for animations\n     * @param {string} [type='ease'] - Animation type\n     * @returns {Function} Timing function\n     */\n    createTimingFunction(type = 'ease') {\n        return (elapsed, duration) => {\n            const x = elapsed / duration;\n\n            switch (type) {\n                case 'linear':\n                    return x;\n                case 'ease':\n                    return (x ** 2) * (3 - 2 * x);\n                case 'ease-in':\n                    return x ** 2;\n                case 'ease-out':\n                    return -1 * (x - 1) ** 2 + 1;\n                case 'ease-in-out':\n                    return (x < 0.5) ? 2 * x ** 2 : 4 * x - 2 * x ** 2 - 1;\n                default:\n                    return x;\n            }\n        };\n    }\n\n    /**\n     * Animates an element with given properties\n     * @param {HTMLElement} element - Element to animate\n     * @param {Object} properties - Properties to animate\n     * @param {number} duration - Animation duration in milliseconds\n     * @param {string} [easing='ease'] - Easing function\n     * @param {Function} [callback] - Callback when animation completes\n     * @returns {number} Animation ID\n     */\n    animate(element, properties, duration, easing = 'ease', callback) {\n        const animationId = ++this.animationId;\n        const timingFunction = this.createTimingFunction(easing);\n        const startTime = performance.now();\n        const startValues = {};\n\n        // Store initial values\n        Object.keys(properties).forEach(prop => {\n            startValues[prop] = this._getInitialValue(element, prop);\n        });\n\n        const animate = (currentTime) => {\n            const elapsed = currentTime - startTime;\n            const progress = Math.min(elapsed / duration, 1);\n            const easedProgress = timingFunction(elapsed, duration);\n\n            // Apply animated values\n            Object.keys(properties).forEach(prop => {\n                const startValue = startValues[prop];\n                const endValue = properties[prop];\n                const currentValue = this._interpolateValue(startValue, endValue, easedProgress);\n                this._applyValue(element, prop, currentValue);\n            });\n\n            if (progress < 1 && this.activeAnimations.has(animationId)) {\n                requestAnimationFrame(animate);\n            } else {\n                this.activeAnimations.delete(animationId);\n                if (callback) callback();\n            }\n        };\n\n        this.activeAnimations.set(animationId, { element, animate, callback });\n        requestAnimationFrame(animate);\n\n        return animationId;\n    }\n\n    /**\n     * Cancels an animation\n     * @param {number} animationId - Animation ID to cancel\n     */\n    cancel(animationId) {\n        if (this.activeAnimations.has(animationId)) {\n            this.activeAnimations.delete(animationId);\n        }\n    }\n\n    /**\n     * Cancels all animations\n     */\n    cancelAll() {\n        this.activeAnimations.clear();\n    }\n\n    /**\n     * Gets initial value for a property\n     * @private\n     * @param {HTMLElement} element - Element\n     * @param {string} property - Property name\n     * @returns {number} Initial value\n     */\n    _getInitialValue(element, property) {\n        if (!element || !element.style) return 0;\n        switch (property) {\n            case 'opacity':\n                return parseFloat(getComputedStyle(element).opacity) || 1;\n            case 'left':\n                return parseFloat(element.style.left) || 0;\n            case 'top':\n                return parseFloat(element.style.top) || 0;\n            case 'scale':\n                return 1;\n            default:\n                return 0;\n        }\n    }\n\n    /**\n     * Interpolates between two values\n     * @private\n     * @param {number} start - Start value\n     * @param {number} end - End value\n     * @param {number} progress - Progress (0-1)\n     * @returns {number} Interpolated value\n     */\n    _interpolateValue(start, end, progress) {\n        return start + (end - start) * progress;\n    }\n\n    /**\n     * Applies animated value to element\n     * @private\n     * @param {HTMLElement} element - Element\n     * @param {string} property - Property name\n     * @param {number} value - Value to apply\n     */\n    _applyValue(element, property, value) {\n        if (!element || !element.style) return;\n        switch (property) {\n            case 'opacity':\n                element.style.opacity = value;\n                break;\n            case 'left':\n                element.style.left = `${value  }px`;\n                break;\n            case 'top':\n                element.style.top = `${value  }px`;\n                break;\n            case 'scale':\n                element.style.transform = `scale(${value})`;\n                break;\n            default:\n                element.style[property] = value;\n        }\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        this.cancelAll();\n    }\n}\n","/**\n * Service for managing board setup and DOM operations\n * @module services/BoardService\n * @since 2.0.0\n */\n\nimport { BOARD_SIZE } from '../constants/positions.js';\nimport { DOMError, ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\nimport Square from '../components/Square.js';\n\n/**\n * Service responsible for board DOM manipulation and setup\n * @class\n */\nexport class BoardService {\n    /**\n     * Creates a new BoardService instance\n     * @param {ChessboardConfig} config - Board configuration\n     */\n    constructor(config) {\n        this.config = config;\n        this.element = null;\n        this.squares = {};\n    }\n\n    /**\n     * Builds the board DOM element and attaches it to the configured container\n     * @throws {DOMError} When the container element cannot be found\n     */\n    buildBoard() {\n        console.log('BoardService.buildBoard: Looking for element with ID:', this.config.id_div);\n\n        this.element = document.getElementById(this.config.id_div);\n        if (!this.element) {\n            throw new DOMError(ERROR_MESSAGES.invalid_id_div + this.config.id_div, this.config.id_div);\n        }\n\n        this.resize(this.config.size);\n        this.element.className = \"board\";\n    }\n\n    /**\n     * Creates all 64 squares and adds them to the board\n     * @param {Function} coordConverter - Function to convert row/col to real coordinates\n     */\n    buildSquares(coordConverter) {\n        for (let row = 0; row < BOARD_SIZE.ROWS; row++) {\n            for (let col = 0; col < BOARD_SIZE.COLS; col++) {\n                const [squareRow, squareCol] = coordConverter(row, col);\n                const square = new Square(squareRow, squareCol);\n\n                this.squares[square.getId()] = square;\n                this.element.appendChild(square.element);\n            }\n        }\n    }\n\n    /**\n     * Removes all squares from the board and cleans up their resources\n     * Best practice: always destroy JS objects and DOM nodes, and clear references.\n     */\n    removeSquares() {\n        for (const square of Object.values(this.squares)) {\n            // Always call destroy to remove DOM and clear piece reference\n            square.destroy();\n        }\n        this.squares = {};\n    }\n\n    /**\n     * Removes all content from the board element\n     * Best practice: clear DOM and force element to be re-fetched on next build.\n     */\n    removeBoard() {\n        if (this.element) {\n            this.element.innerHTML = '';\n            this.element = null;\n        }\n    }\n\n    /**\n     * Resizes the board to the specified size\n     * @param {number|string} value - Size in pixels or 'auto'\n     * @throws {ValidationError} When size value is invalid\n     */\n    resize(value) {\n        if (value === 'auto') {\n            const size = this._calculateAutoSize();\n            this.resize(size);\n        } else if (typeof value !== 'number') {\n            throw new ValidationError(ERROR_MESSAGES.invalid_value + value, 'size', value);\n        } else {\n            document.documentElement.style.setProperty('--dimBoard', `${value  }px`);\n        }\n    }\n\n    /**\n     * Calculates the optimal size when 'auto' is specified\n     * @private\n     * @returns {number} Calculated size in pixels\n     */\n    _calculateAutoSize() {\n        if (!this.element) return 400; // Default fallback\n\n        const { offsetWidth, offsetHeight } = this.element;\n\n        if (offsetWidth === 0) {\n            return offsetHeight || 400;\n        } else if (offsetHeight === 0) {\n            return offsetWidth;\n        } \n            return Math.min(offsetWidth, offsetHeight);\n        \n    }\n\n    /**\n     * Gets a square by its ID\n     * @param {string} squareId - Square identifier (e.g., 'e4')\n     * @returns {Square|null} The square or null if not found\n     */\n    getSquare(squareId) {\n        return this.squares[squareId] || null;\n    }\n\n    /**\n     * Gets all squares\n     * @returns {Object.<string, Square>} All squares indexed by ID\n     */\n    getAllSquares() {\n        return { ...this.squares };\n    }\n\n    /**\n     * Applies a method to all squares\n     * @param {string} methodName - Name of the method to call on each square\n     * @param {...*} args - Arguments to pass to the method\n     */\n    applyToAllSquares(methodName, ...args) {\n        for (const square of Object.values(this.squares)) {\n            if (typeof square[methodName] === 'function') {\n                square[methodName](...args);\n            }\n        }\n    }\n\n    /**\n     * Cleans up all resources\n     */\n    destroy() {\n        this.removeSquares();\n        this.removeBoard();\n        this.element = null;\n        this.squares = {};\n    }\n}\n","/**\n * Service for managing coordinate conversions and board orientation\n * @module services/CoordinateService\n * @since 2.0.0\n */\n\nimport { BOARD_LETTERS } from '../constants/positions.js';\nimport { ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\n\n/**\n * Service responsible for coordinate conversions and board orientation\n * @class\n */\nexport class CoordinateService {\n    /**\n     * Creates a new CoordinateService instance\n     * @param {ChessboardConfig} config - Board configuration\n     */\n    constructor(config) {\n        this.config = config;\n    }\n\n    /**\n     * Converts logical coordinates to real coordinates based on board orientation\n     * @param {number} row - Row index (0-7)\n     * @param {number} col - Column index (0-7)\n     * @returns {Array<number>} Real coordinates [row, col] (1-8)\n     */\n    realCoord(row, col) {\n        let realRow = row;\n        let realCol = col;\n        \n        if (this.isWhiteOriented()) {\n            realRow = 7 - row;\n        } else {\n            realCol = 7 - col;\n        }\n        \n        return [realRow + 1, realCol + 1];\n    }\n\n    /**\n     * Converts board coordinates to square ID\n     * @param {number} row - Row index (0-7)\n     * @param {number} col - Column index (0-7)\n     * @returns {string} Square ID (e.g., 'e4')\n     */\n    getSquareID(row, col) {\n        row = parseInt(row);\n        col = parseInt(col);\n        \n        if (this.isWhiteOriented()) {\n            row = 8 - row;\n            col = col + 1;\n        } else {\n            row = row + 1;\n            col = 8 - col;\n        }\n        \n        if (col < 1 || col > 8 || row < 1 || row > 8) {\n            throw new ValidationError(\n                `Invalid board coordinates: row=${row}, col=${col}`,\n                'coordinates',\n                { row, col }\n            );\n        }\n        \n        const letter = BOARD_LETTERS[col - 1];\n        return letter + row;\n    }\n\n    /**\n     * Converts square ID to board coordinates\n     * @param {string} squareId - Square ID (e.g., 'e4')\n     * @returns {Array<number>} Board coordinates [row, col] (0-7)\n     */\n    getCoordinatesFromSquareID(squareId) {\n        if (typeof squareId !== 'string' || squareId.length !== 2) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_square + squareId,\n                'squareId',\n                squareId\n            );\n        }\n        \n        const letter = squareId[0];\n        const number = parseInt(squareId[1]);\n        \n        const col = BOARD_LETTERS.indexOf(letter);\n        if (col === -1) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_square + squareId,\n                'squareId',\n                squareId\n            );\n        }\n        \n        if (number < 1 || number > 8) {\n            throw new ValidationError(\n                ERROR_MESSAGES.invalid_square + squareId,\n                'squareId',\n                squareId\n            );\n        }\n        \n        let row, boardCol;\n        \n        if (this.isWhiteOriented()) {\n            row = 8 - number;\n            boardCol = col;\n        } else {\n            row = number - 1;\n            boardCol = 7 - col;\n        }\n        \n        return [row, boardCol];\n    }\n\n    /**\n     * Converts pixel coordinates to square ID\n     * @param {number} x - X coordinate in pixels\n     * @param {number} y - Y coordinate in pixels\n     * @param {HTMLElement} boardElement - Board DOM element\n     * @returns {string|null} Square ID or null if outside board\n     */\n    pixelToSquareID(x, y, boardElement) {\n        if (!boardElement) return null;\n        \n        const rect = boardElement.getBoundingClientRect();\n        const { width, height } = rect;\n        \n        // Check if coordinates are within board bounds\n        if (x < 0 || x >= width || y < 0 || y >= height) {\n            return null;\n        }\n        \n        const squareWidth = width / 8;\n        const squareHeight = height / 8;\n        \n        const col = Math.floor(x / squareWidth);\n        const row = Math.floor(y / squareHeight);\n        \n        try {\n            return this.getSquareID(row, col);\n        } catch (error) {\n            return null;\n        }\n    }\n\n    /**\n     * Converts square ID to pixel coordinates\n     * @param {string} squareId - Square ID (e.g., 'e4')\n     * @param {HTMLElement} boardElement - Board DOM element\n     * @returns {Object|null} Pixel coordinates {x, y} or null if invalid\n     */\n    squareIDToPixel(squareId, boardElement) {\n        if (!boardElement) return null;\n        \n        try {\n            const [row, col] = this.getCoordinatesFromSquareID(squareId);\n            const rect = boardElement.getBoundingClientRect();\n            const { width, height } = rect;\n            \n            const squareWidth = width / 8;\n            const squareHeight = height / 8;\n            \n            const x = col * squareWidth;\n            const y = row * squareHeight;\n            \n            return { x, y };\n        } catch (error) {\n            return null;\n        }\n    }\n\n    /**\n     * Gets the center pixel coordinates of a square\n     * @param {string} squareId - Square ID (e.g., 'e4')\n     * @param {HTMLElement} boardElement - Board DOM element\n     * @returns {Object|null} Center coordinates {x, y} or null if invalid\n     */\n    getSquareCenter(squareId, boardElement) {\n        const coords = this.squareIDToPixel(squareId, boardElement);\n        if (!coords) return null;\n        \n        const rect = boardElement.getBoundingClientRect();\n        const squareWidth = rect.width / 8;\n        const squareHeight = rect.height / 8;\n        \n        return {\n            x: coords.x + squareWidth / 2,\n            y: coords.y + squareHeight / 2\n        };\n    }\n\n    /**\n     * Calculates the distance between two squares\n     * @param {string} fromSquare - Source square ID\n     * @param {string} toSquare - Target square ID\n     * @returns {number} Distance between squares\n     */\n    getSquareDistance(fromSquare, toSquare) {\n        try {\n            const [fromRow, fromCol] = this.getCoordinatesFromSquareID(fromSquare);\n            const [toRow, toCol] = this.getCoordinatesFromSquareID(toSquare);\n            \n            const rowDiff = Math.abs(toRow - fromRow);\n            const colDiff = Math.abs(toCol - fromCol);\n            \n            return Math.sqrt(rowDiff * rowDiff + colDiff * colDiff);\n        } catch (error) {\n            return 0;\n        }\n    }\n\n    /**\n     * Checks if the board is oriented from white's perspective\n     * @returns {boolean} True if white-oriented\n     */\n    isWhiteOriented() {\n        return this.config.orientation === 'w';\n    }\n\n    /**\n     * Checks if the board is oriented from black's perspective\n     * @returns {boolean} True if black-oriented\n     */\n    isBlackOriented() {\n        return this.config.orientation === 'b';\n    }\n\n    /**\n     * Gets the current orientation\n     * @returns {string} Current orientation ('w' or 'b')\n     */\n    getOrientation() {\n        return this.config.orientation;\n    }\n\n    /**\n     * Sets the orientation\n     * @param {string} orientation - New orientation ('w', 'b', 'white', 'black')\n     */\n    setOrientation(orientation) {\n        // Normalize orientation\n        const normalizedOrientation = orientation === 'white' ? 'w' :\n                                     orientation === 'black' ? 'b' : orientation;\n\n        if (normalizedOrientation !== 'w' && normalizedOrientation !== 'b') {\n            throw new ValidationError(\n                `${ERROR_MESSAGES.invalid_orientation}${orientation}`,\n                'orientation',\n                orientation\n            );\n        }\n\n        this.config.orientation = normalizedOrientation;\n    }\n\n    /**\n     * Flips the board orientation\n     */\n    flipOrientation() {\n        this.config.orientation = this.isWhiteOriented() ? 'b' : 'w';\n    }\n\n    /**\n     * Gets all square IDs in order\n     * @returns {Array<string>} Array of all square IDs\n     */\n    getAllSquareIDs() {\n        const squares = [];\n        \n        for (let row = 0; row < 8; row++) {\n            for (let col = 0; col < 8; col++) {\n                squares.push(this.getSquareID(row, col));\n            }\n        }\n        \n        return squares;\n    }\n\n    /**\n     * Gets squares in a specific rank (row)\n     * @param {number} rank - Rank number (1-8)\n     * @returns {Array<string>} Array of square IDs in the rank\n     */\n    getSquaresByRank(rank) {\n        if (rank < 1 || rank > 8) {\n            throw new ValidationError(\n                `Invalid rank: ${rank}`,\n                'rank',\n                rank\n            );\n        }\n        \n        const squares = [];\n        \n        for (let col = 0; col < 8; col++) {\n            const row = this.isWhiteOriented() ? 8 - rank : rank - 1;\n            squares.push(this.getSquareID(row, col));\n        }\n        \n        return squares;\n    }\n\n    /**\n     * Gets squares in a specific file (column)\n     * @param {string} file - File letter (a-h)\n     * @returns {Array<string>} Array of square IDs in the file\n     */\n    getSquaresByFile(file) {\n        const col = BOARD_LETTERS.indexOf(file);\n        if (col === -1) {\n            throw new ValidationError(\n                `Invalid file: ${file}`,\n                'file',\n                file\n            );\n        }\n        \n        const squares = [];\n        \n        for (let row = 0; row < 8; row++) {\n            squares.push(this.getSquareID(row, col));\n        }\n        \n        return squares;\n    }\n}\n","/**\n * Performance utilities for smooth interactions and monitoring\n * @module utils/performance\n * @since 2.0.0\n */\n\n/**\n * Performance monitoring class for measuring and tracking performance metrics\n * @class\n */\nexport class PerformanceMonitor {\n    /**\n     * Creates a new PerformanceMonitor instance\n     */\n    constructor() {\n        this.metrics = new Map();\n        this.observers = new Map();\n        this.isEnabled = typeof performance !== 'undefined' && performance.mark;\n        \n        if (this.isEnabled) {\n            this._setupObservers();\n        }\n    }\n    \n    /**\n     * Sets up performance observers for automatic metrics collection\n     * @private\n     */\n    _setupObservers() {\n        try {\n            // Performance Observer for paint metrics\n            if (typeof PerformanceObserver !== 'undefined') {\n                const paintObserver = new PerformanceObserver((list) => {\n                    for (const entry of list.getEntries()) {\n                        this.recordMetric(entry.name, entry.startTime);\n                    }\n                });\n                \n                paintObserver.observe({ entryTypes: ['paint'] });\n                this.observers.set('paint', paintObserver);\n            }\n        } catch (error) {\n            console.warn('Performance observers not available:', error.message);\n        }\n    }\n    \n    /**\n     * Starts measuring performance for a given operation\n     * @param {string} name - Name of the operation\n     */\n    startMeasure(name) {\n        if (!this.isEnabled) return;\n        \n        try {\n            performance.mark(`${name}-start`);\n        } catch (error) {\n            console.warn(`Failed to start performance measure for ${name}:`, error.message);\n        }\n    }\n    \n    /**\n     * Ends measuring performance for a given operation\n     * @param {string} name - Name of the operation\n     * @returns {number} Duration in milliseconds\n     */\n    endMeasure(name) {\n        if (!this.isEnabled) return 0;\n        \n        try {\n            performance.mark(`${name}-end`);\n            const measure = performance.measure(name, `${name}-start`, `${name}-end`);\n            \n            this.recordMetric(name, measure.duration);\n            \n            // Clean up marks\n            performance.clearMarks(`${name}-start`);\n            performance.clearMarks(`${name}-end`);\n            performance.clearMeasures(name);\n            \n            return measure.duration;\n        } catch (error) {\n            console.warn(`Failed to end performance measure for ${name}:`, error.message);\n            return 0;\n        }\n    }\n    \n    /**\n     * Records a metric value\n     * @param {string} name - Metric name\n     * @param {number} value - Metric value\n     */\n    recordMetric(name, value) {\n        if (!this.metrics.has(name)) {\n            this.metrics.set(name, {\n                count: 0,\n                total: 0,\n                min: Infinity,\n                max: -Infinity,\n                values: []\n            });\n        }\n        \n        const metric = this.metrics.get(name);\n        metric.count++;\n        metric.total += value;\n        metric.min = Math.min(metric.min, value);\n        metric.max = Math.max(metric.max, value);\n        metric.values.push(value);\n        \n        // Keep only last 100 values to prevent memory leaks\n        if (metric.values.length > 100) {\n            metric.values.shift();\n        }\n    }\n    \n    /**\n     * Gets metrics summary\n     * @returns {Object} Metrics summary\n     */\n    getMetrics() {\n        const summary = {};\n        \n        for (const [name, metric] of this.metrics) {\n            summary[name] = {\n                count: metric.count,\n                average: metric.total / metric.count,\n                min: metric.min,\n                max: metric.max,\n                total: metric.total,\n                p95: this._calculatePercentile(metric.values, 95),\n                p99: this._calculatePercentile(metric.values, 99)\n            };\n        }\n        \n        return summary;\n    }\n    \n    /**\n     * Calculates percentile for a set of values\n     * @private\n     * @param {Array<number>} values - Array of values\n     * @param {number} percentile - Percentile to calculate (0-100)\n     * @returns {number} Percentile value\n     */\n    _calculatePercentile(values, percentile) {\n        if (values.length === 0) return 0;\n        \n        const sorted = [...values].sort((a, b) => a - b);\n        const index = Math.ceil((percentile / 100) * sorted.length) - 1;\n        return sorted[Math.max(0, index)];\n    }\n    \n    /**\n     * Clears all metrics\n     */\n    clearMetrics() {\n        this.metrics.clear();\n    }\n    \n    /**\n     * Destroys the performance monitor and cleans up resources\n     */\n    destroy() {\n        // Disconnect observers\n        for (const observer of this.observers.values()) {\n            if (observer && typeof observer.disconnect === 'function') {\n                observer.disconnect();\n            }\n        }\n        \n        this.observers.clear();\n        this.metrics.clear();\n    }\n}\n\n/**\n * Throttle function to limit how often a function can be called\n * @param {Function} func - Function to throttle\n * @param {number} limit - Time limit in milliseconds\n * @returns {Function} Throttled function\n */\nexport function throttle(func, limit) {\n    let inThrottle;\n    return function(...args) {\n        const context = this;\n        if (!inThrottle) {\n            func.apply(context, args);\n            inThrottle = true;\n            setTimeout(() => inThrottle = false, limit);\n        }\n    };\n}\n\n/**\n * Debounce function to delay function execution\n * @param {Function} func - Function to debounce\n * @param {number} delay - Delay in milliseconds\n * @returns {Function} Debounced function\n */\nexport function debounce(func, delay) {\n    let timeoutId;\n    return function(...args) {\n        const context = this;\n        clearTimeout(timeoutId);\n        timeoutId = setTimeout(() => func.apply(context, args), delay);\n    };\n}\n\n/**\n * Request animation frame throttle for smooth animations\n * @param {Function} func - Function to throttle\n * @returns {Function} RAF throttled function\n */\nexport function rafThrottle(func) {\n    let isThrottled = false;\n    return function(...args) {\n        if (isThrottled) return;\n        \n        const context = this;\n        \n        isThrottled = true;\n        requestAnimationFrame(() => {\n            func.apply(context, args);\n            isThrottled = false;\n        });\n    };\n}\n\n/**\n * High performance transform utility with hardware acceleration\n * @param {HTMLElement} element - Element to transform\n * @param {number} x - X coordinate\n * @param {number} y - Y coordinate\n * @param {number} [scale=1] - Scale factor\n */\nexport function setTransform(element, x, y, scale = 1) {\n    if (!element || !element.style) return;\n    \n    // Use transform3d for hardware acceleration\n    element.style.transform = `translate3d(${x}px, ${y}px, 0) scale(${scale})`;\n    \n    // Promote to composite layer for better performance\n    element.style.willChange = 'transform';\n}\n\n/**\n * Reset element position efficiently\n * @param {HTMLElement} element - Element to reset\n */\nexport function resetTransform(element) {\n    if (!element || !element.style) return;\n    \n    element.style.transform = '';\n    element.style.left = '';\n    element.style.top = '';\n    element.style.willChange = '';\n}\n\n/**\n * Memory-efficient batch DOM operations\n * @param {Function} callback - Callback containing DOM operations\n * @returns {*} Result of the callback\n */\nexport function batchDOMOperations(callback) {\n    return new Promise((resolve) => {\n        requestAnimationFrame(() => {\n            const result = callback();\n            resolve(result);\n        });\n    });\n}\n\n/**\n * Optimized element visibility check\n * @param {HTMLElement} element - Element to check\n * @returns {boolean} True if element is visible\n */\nexport function isElementVisible(element) {\n    if (!element || !element.getBoundingClientRect) return false;\n    \n    const rect = element.getBoundingClientRect();\n    return (\n        rect.width > 0 &&\n        rect.height > 0 &&\n        rect.bottom > 0 &&\n        rect.right > 0 &&\n        rect.top < (window.innerHeight || document.documentElement.clientHeight) &&\n        rect.left < (window.innerWidth || document.documentElement.clientWidth)\n    );\n}\n\n/**\n * Memory usage tracking utility\n * @returns {Object} Memory usage information\n */\nexport function getMemoryUsage() {\n    if (typeof performance !== 'undefined' && performance.memory) {\n        return {\n            used: performance.memory.usedJSHeapSize,\n            total: performance.memory.totalJSHeapSize,\n            limit: performance.memory.jsHeapSizeLimit\n        };\n    }\n    \n    return {\n        used: 0,\n        total: 0,\n        limit: 0,\n        supported: false\n    };\n}\n","/**\n * Cross-browser utilities for consistent drag & drop behavior\n */\n\n/**\n * Detect browser type and version\n * @returns {Object} Browser information\n */\nexport function getBrowserInfo() {\n    const ua = navigator.userAgent;\n    const isChrome = ua.includes('Chrome') && !ua.includes('Edg');\n    const isFirefox = ua.includes('Firefox');\n    const isSafari = ua.includes('Safari') && !ua.includes('Chrome');\n    const isEdge = ua.includes('Edg');\n    \n    return {\n        isChrome,\n        isFirefox,\n        isSafari,\n        isEdge,\n        devicePixelRatio: window.devicePixelRatio || 1,\n        userAgent: ua\n    };\n}\n\n/**\n * Get accurate mouse coordinates accounting for browser differences\n * @param {MouseEvent} event - Mouse event\n * @returns {Object} Normalized coordinates\n */\nexport function getNormalizedCoordinates(event) {\n    const browserInfo = getBrowserInfo();\n    \n    // Base coordinates\n    let x = event.clientX;\n    let y = event.clientY;\n    \n    // Add scroll offset for absolute positioning\n    x += window.scrollX || window.pageXOffset || 0;\n    y += window.scrollY || window.pageYOffset || 0;\n    \n    // Chrome-specific adjustments if needed\n    if (browserInfo.isChrome) {\n        // Chrome sometimes has sub-pixel rendering differences\n        x = Math.round(x);\n        y = Math.round(y);\n    }\n    \n    return { x, y };\n}\n\n/**\n * Set element position using the most compatible method\n * @param {HTMLElement} element - Element to position\n * @param {number} x - X coordinate\n * @param {number} y - Y coordinate\n */\nexport function setElementPosition(element, x, y) {\n    // Ensure pixel-perfect positioning\n    element.style.left = `${Math.round(x)}px`;\n    element.style.top = `${Math.round(y)}px`;\n}\n\n/**\n * Calculate offset from center for drag positioning\n * @param {HTMLElement} element - Element being dragged\n * @param {number} mouseX - Mouse X coordinate\n * @param {number} mouseY - Mouse Y coordinate\n * @returns {Object} Position coordinates\n */\nexport function calculateDragPosition(element, mouseX, mouseY) {\n    const rect = element.getBoundingClientRect();\n    const halfWidth = rect.width / 2;\n    const halfHeight = rect.height / 2;\n    \n    return {\n        x: mouseX - halfWidth,\n        y: mouseY - halfHeight\n    };\n}\n\n/**\n * Enhanced mouse coordinate tracking for cross-browser compatibility\n */\nexport class MouseTracker {\n    constructor() {\n        this.lastKnownPosition = { x: 0, y: 0 };\n        this.browserInfo = getBrowserInfo();\n    }\n    \n    /**\n     * Update position from mouse event\n     * @param {MouseEvent} event - Mouse event\n     * @returns {Object} Normalized position\n     */\n    updatePosition(event) {\n        const coords = getNormalizedCoordinates(event);\n        this.lastKnownPosition = coords;\n        return coords;\n    }\n    \n    /**\n     * Get element position for dragging\n     * @param {HTMLElement} element - Element to position\n     * @param {MouseEvent} event - Mouse event\n     * @returns {Object} Position for the element\n     */\n    getDragPosition(element, event) {\n        const mousePos = this.updatePosition(event);\n        return calculateDragPosition(element, mousePos.x, mousePos.y);\n    }\n}\n\n/**\n * Browser-specific drag optimizations\n */\nexport const DragOptimizations = {\n    /**\n     * Apply browser-specific optimizations to an element\n     * @param {HTMLElement} element - Element to optimize\n     */\n    enableForDrag(element) {\n        const browserInfo = getBrowserInfo();\n        \n        // Base optimizations for all browsers\n        element.style.willChange = 'left, top';\n        element.style.pointerEvents = 'none'; // Prevent conflicts\n        \n        // Chrome-specific optimizations\n        if (browserInfo.isChrome) {\n            element.style.transform = 'translateZ(0)'; // Force hardware acceleration\n        }\n        \n        // Firefox-specific optimizations\n        if (browserInfo.isFirefox) {\n            element.style.backfaceVisibility = 'hidden';\n        }\n    },\n    \n    /**\n     * Clean up optimizations after drag\n     * @param {HTMLElement} element - Element to clean up\n     */\n    cleanupAfterDrag(element) {\n        element.style.willChange = 'auto';\n        element.style.pointerEvents = '';\n        element.style.transform = '';\n        element.style.backfaceVisibility = '';\n    }\n};\n","/**\n * Structured logging system for Chessboard.js\n * @module utils/logger\n * @since 2.0.0\n */\n\n/**\n * Log levels in order of severity\n * @constant\n * @type {Object}\n */\nconst LOG_LEVELS = Object.freeze({\n    DEBUG: 0,\n    INFO: 1,\n    WARN: 2,\n    ERROR: 3,\n    NONE: 4\n});\n\n/**\n * Default logger configuration\n * @constant\n * @type {Object}\n */\nconst DEFAULT_CONFIG = Object.freeze({\n    level: LOG_LEVELS.INFO,\n    enableColors: true,\n    enableTimestamp: true,\n    enableStackTrace: true,\n    maxLogSize: 1000,\n    enableConsole: true,\n    enableStorage: false,\n    storageKey: 'chessboard-logs'\n});\n\n/**\n * ANSI color codes for console output\n * @constant\n * @type {Object}\n */\nconst COLORS = Object.freeze({\n    DEBUG: '\\x1b[36m',    // Cyan\n    INFO: '\\x1b[32m',     // Green\n    WARN: '\\x1b[33m',     // Yellow\n    ERROR: '\\x1b[31m',    // Red\n    RESET: '\\x1b[0m'      // Reset\n});\n\n/**\n * Structured logger class with configurable output and filtering\n * @class\n */\nexport class Logger {\n    /**\n     * Creates a new Logger instance\n     * @param {Object} [config] - Logger configuration\n     * @param {string} [name] - Logger name/namespace\n     */\n    constructor(config = {}, name = 'Chessboard') {\n        this.config = { ...DEFAULT_CONFIG, ...config };\n        this.name = name;\n        this.logs = [];\n        this.startTime = Date.now();\n        \n        // Create bound methods for better performance\n        this.debug = this._createLogMethod('DEBUG');\n        this.info = this._createLogMethod('INFO');\n        this.warn = this._createLogMethod('WARN');\n        this.error = this._createLogMethod('ERROR');\n        \n        // Performance tracking\n        this.performances = new Map();\n        \n        // Initialize storage if enabled\n        if (this.config.enableStorage) {\n            this._initStorage();\n        }\n    }\n\n    /**\n     * Creates a log method for a specific level\n     * @private\n     * @param {string} level - Log level\n     * @returns {Function} Log method\n     */\n    _createLogMethod(level) {\n        return (message, data = {}, error = null) => {\n            this._log(level, message, data, error);\n        };\n    }\n\n    /**\n     * Core logging method\n     * @private\n     * @param {string} level - Log level\n     * @param {string} message - Log message\n     * @param {Object} data - Additional data\n     * @param {Error} error - Error object\n     */\n    _log(level, message, data, error) {\n        const levelNumber = LOG_LEVELS[level];\n        \n        // Filter by level\n        if (levelNumber < this.config.level) {\n            return;\n        }\n        \n        // Create log entry\n        const entry = this._createLogEntry(level, message, data, error);\n        \n        // Store log entry\n        this._storeLogEntry(entry);\n        \n        // Output to console\n        if (this.config.enableConsole) {\n            this._outputToConsole(entry);\n        }\n        \n        // Store in localStorage if enabled\n        if (this.config.enableStorage) {\n            this._storeInStorage(entry);\n        }\n    }\n\n    /**\n     * Creates a structured log entry\n     * @private\n     * @param {string} level - Log level\n     * @param {string} message - Log message\n     * @param {Object} data - Additional data\n     * @param {Error} error - Error object\n     * @returns {Object} Log entry\n     */\n    _createLogEntry(level, message, data, error) {\n        const entry = {\n            timestamp: new Date().toISOString(),\n            level,\n            logger: this.name,\n            message,\n            data: { ...data },\n            runtime: Date.now() - this.startTime\n        };\n        \n        // Add error details if provided\n        if (error) {\n            entry.error = {\n                name: error.name,\n                message: error.message,\n                stack: this.config.enableStackTrace ? error.stack : null\n            };\n        }\n        \n        // Add performance context if available\n        if (typeof performance !== 'undefined' && performance.memory) {\n            entry.memory = {\n                used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),\n                total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024)\n            };\n        }\n        \n        return entry;\n    }\n\n    /**\n     * Stores log entry in memory\n     * @private\n     * @param {Object} entry - Log entry\n     */\n    _storeLogEntry(entry) {\n        this.logs.push(entry);\n        \n        // Limit log size\n        if (this.logs.length > this.config.maxLogSize) {\n            this.logs.shift();\n        }\n    }\n\n    /**\n     * Outputs log entry to console\n     * @private\n     * @param {Object} entry - Log entry\n     */\n    _outputToConsole(entry) {\n        const color = this.config.enableColors ? COLORS[entry.level] : '';\n        const reset = this.config.enableColors ? COLORS.RESET : '';\n        const timestamp = this.config.enableTimestamp ? \n            `[${new Date(entry.timestamp).toLocaleTimeString()}] ` : '';\n        \n        const prefix = `${color}${timestamp}[${entry.logger}:${entry.level}]${reset}`;\n        const message = `${prefix} ${entry.message}`;\n        \n        // Choose console method based on level\n        const consoleMethod = this._getConsoleMethod(entry.level);\n        \n        if (Object.keys(entry.data).length > 0 || entry.error) {\n            consoleMethod(message, {\n                data: entry.data,\n                error: entry.error,\n                runtime: `${entry.runtime}ms`\n            });\n        } else {\n            consoleMethod(message);\n        }\n    }\n\n    /**\n     * Gets appropriate console method for log level\n     * @private\n     * @param {string} level - Log level\n     * @returns {Function} Console method\n     */\n    _getConsoleMethod(level) {\n        switch (level) {\n            case 'DEBUG':\n                return console.debug || console.log;\n            case 'INFO':\n                return console.info || console.log;\n            case 'WARN':\n                return console.warn || console.log;\n            case 'ERROR':\n                return console.error || console.log;\n            default:\n                return console.log;\n        }\n    }\n\n    /**\n     * Initializes localStorage for log storage\n     * @private\n     */\n    _initStorage() {\n        if (typeof localStorage === 'undefined') {\n            this.config.enableStorage = false;\n            return;\n        }\n        \n        try {\n            // Test localStorage availability\n            localStorage.setItem('test', 'test');\n            localStorage.removeItem('test');\n        } catch (error) {\n            this.config.enableStorage = false;\n            console.warn('localStorage not available, disabling log storage');\n        }\n    }\n\n    /**\n     * Stores log entry in localStorage\n     * @private\n     * @param {Object} entry - Log entry\n     */\n    _storeInStorage(entry) {\n        if (!this.config.enableStorage) {\n            return;\n        }\n        \n        try {\n            const stored = JSON.parse(localStorage.getItem(this.config.storageKey) || '[]');\n            stored.push(entry);\n            \n            // Limit stored logs\n            if (stored.length > this.config.maxLogSize) {\n                stored.shift();\n            }\n            \n            localStorage.setItem(this.config.storageKey, JSON.stringify(stored));\n        } catch (error) {\n            console.warn('Failed to store log entry:', error);\n        }\n    }\n\n    /**\n     * Starts performance measurement\n     * @param {string} name - Performance measurement name\n     */\n    startPerformance(name) {\n        this.performances.set(name, {\n            start: performance.now(),\n            measurements: []\n        });\n        \n        this.debug(`Started performance measurement: ${name}`);\n    }\n\n    /**\n     * Ends performance measurement\n     * @param {string} name - Performance measurement name\n     * @returns {number} Duration in milliseconds\n     */\n    endPerformance(name) {\n        const perf = this.performances.get(name);\n        if (!perf) {\n            this.warn(`Performance measurement not found: ${name}`);\n            return 0;\n        }\n        \n        const duration = performance.now() - perf.start;\n        perf.measurements.push(duration);\n        \n        this.debug(`Performance measurement completed: ${name}`, {\n            duration: `${duration.toFixed(2)}ms`,\n            measurements: perf.measurements.length\n        });\n        \n        return duration;\n    }\n\n    /**\n     * Gets performance statistics\n     * @param {string} name - Performance measurement name\n     * @returns {Object} Performance statistics\n     */\n    getPerformanceStats(name) {\n        const perf = this.performances.get(name);\n        if (!perf || perf.measurements.length === 0) {\n            return null;\n        }\n        \n        const measurements = perf.measurements;\n        const total = measurements.reduce((sum, m) => sum + m, 0);\n        const avg = total / measurements.length;\n        const min = Math.min(...measurements);\n        const max = Math.max(...measurements);\n        \n        return {\n            name,\n            count: measurements.length,\n            total: total.toFixed(2),\n            average: avg.toFixed(2),\n            min: min.toFixed(2),\n            max: max.toFixed(2)\n        };\n    }\n\n    /**\n     * Creates a child logger with a specific namespace\n     * @param {string} namespace - Child logger namespace\n     * @returns {Logger} Child logger instance\n     */\n    child(namespace) {\n        return new Logger(this.config, `${this.name}:${namespace}`);\n    }\n\n    /**\n     * Sets log level\n     * @param {string} level - Log level\n     */\n    setLevel(level) {\n        if (LOG_LEVELS[level] !== undefined) {\n            this.config.level = LOG_LEVELS[level];\n        }\n    }\n\n    /**\n     * Gets current log level\n     * @returns {string} Current log level\n     */\n    getLevel() {\n        return Object.keys(LOG_LEVELS).find(key => LOG_LEVELS[key] === this.config.level);\n    }\n\n    /**\n     * Gets all stored logs\n     * @returns {Array} Array of log entries\n     */\n    getLogs() {\n        return [...this.logs];\n    }\n\n    /**\n     * Clears all stored logs\n     */\n    clearLogs() {\n        this.logs = [];\n        \n        if (this.config.enableStorage) {\n            try {\n                localStorage.removeItem(this.config.storageKey);\n            } catch (error) {\n                console.warn('Failed to clear stored logs:', error);\n            }\n        }\n    }\n\n    /**\n     * Exports logs as JSON\n     * @returns {string} JSON string of logs\n     */\n    exportLogs() {\n        return JSON.stringify(this.logs, null, 2);\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        this.clearLogs();\n        this.performances.clear();\n    }\n}\n\n/**\n * Default logger instance\n * @type {Logger}\n */\nexport const logger = new Logger();\n\n/**\n * Creates a logger with specific configuration\n * @param {Object} config - Logger configuration\n * @param {string} name - Logger name\n * @returns {Logger} Logger instance\n */\nexport function createLogger(config, name) {\n    return new Logger(config, name);\n}\n\n/**\n * Log levels enumeration\n * @type {Object}\n */\nexport { LOG_LEVELS };\n","/**\n * Service for managing events and user interactions\n * @module services/EventService\n * @since 2.0.0\n */\n\nimport { rafThrottle } from '../utils/performance.js';\nimport { DragOptimizations } from '../utils/cross-browser.js';\nimport { ValidationError } from '../errors/ChessboardError.js';\nimport Move from '../components/Move.js';\nimport Piece from '../components/Piece.js';\nimport { logger } from '../utils/logger.js';\n\n/**\n * Service responsible for event handling and user interactions\n * @class\n */\nexport class EventService {\n    /**\n     * Creates a new EventService instance\n     * @param {ChessboardConfig} config - Board configuration\n     * @param {BoardService} boardService - Board service instance\n     * @param {MoveService} moveService - Move service instance\n     * @param {CoordinateService} coordinateService - Coordinate service instance\n     * @param {Chessboard} chessboard - Chessboard instance\n     */\n    constructor(config, boardService, moveService, coordinateService, chessboard) {\n        this.config = config;\n        this.boardService = boardService;\n        this.moveService = moveService;\n        this.coordinateService = coordinateService;\n        this.chessboard = chessboard;\n\n        this.clicked = null;\n        this.isDragging = false;\n        this.isAnimating = false;\n        this.promoting = false;\n        this._isProcessingDrop = false;\n\n        this.eventListeners = new Map();\n    }\n\n    /**\n     * Adds event listeners to all squares\n     * @param {Function} onSquareClick - Callback for square clicks\n     * @param {Function} onPieceHover - Callback for piece hover\n     * @param {Function} onPieceLeave - Callback for piece leave\n     */\n    addListeners(onSquareClick, onPieceHover, onPieceLeave) {\n        // Remove existing listeners to avoid duplicates\n        this.removeListeners();\n\n        const squares = this.boardService.getAllSquares();\n\n        Object.values(squares).forEach(square => {\n            this._addSquareListeners(square, onSquareClick, onPieceHover, onPieceLeave);\n        });\n    }\n\n    /**\n     * Adds event listeners to a specific square\n     * @private\n     * @param {Square} square - Square to add listeners to\n     * @param {Function} onSquareClick - Click callback\n     * @param {Function} onPieceHover - Hover callback\n     * @param {Function} onPieceLeave - Leave callback\n     */\n    _addSquareListeners(square, onSquareClick, onPieceHover, onPieceLeave) {\n        const listeners = [];\n\n        // Throttled hover handlers for performance\n        const throttledHover = rafThrottle((e) => {\n            if (!this.clicked && this.config.hints) {\n                onPieceHover(square);\n            }\n        });\n\n        const throttledLeave = rafThrottle((e) => {\n            if (!this.clicked && this.config.hints) {\n                onPieceLeave(square);\n            }\n        });\n\n        // Click handler\n        const handleClick = (e) => {\n            e.stopPropagation();\n            if (this.config.clickable && !this.isAnimating) {\n                // Cancel any pending drag operations on pieces in this square\n                if (square.piece && square.piece._dragTimeout) {\n                    clearTimeout(square.piece._dragTimeout);\n                    square.piece._dragTimeout = null;\n                }\n                onSquareClick(square);\n            }\n        };\n\n        // Add listeners\n        square.element.addEventListener('mouseover', throttledHover);\n        square.element.addEventListener('mouseout', throttledLeave);\n        square.element.addEventListener('click', handleClick);\n        square.element.addEventListener('touchstart', handleClick);\n\n        // Store listeners for cleanup\n        listeners.push(\n            { element: square.element, type: 'mouseover', handler: throttledHover },\n            { element: square.element, type: 'mouseout', handler: throttledLeave },\n            { element: square.element, type: 'click', handler: handleClick },\n            { element: square.element, type: 'touchstart', handler: handleClick }\n        );\n\n        this.eventListeners.set(square.id, listeners);\n    }\n\n    /**\n     * Creates a drag function for a piece\n     * @param {Square} square - Square containing the piece\n     * @param {Piece} piece - Piece to create drag function for\n     * @param {Function} onDragStart - Drag start callback\n     * @param {Function} onDragMove - Drag move callback\n     * @param {Function} onDrop - Drop callback\n     * @param {Function} onSnapback - Snapback callback\n     * @param {Function} onMove - Move execution callback\n     * @param {Function} onRemove - Remove piece callback\n     * @returns {Function} Drag event handler\n     */\n    createDragFunction(square, piece, onDragStart, onDragMove, onDrop, onSnapback, onMove, onRemove) {\n        console.log('Creating drag function for:', square.id, piece ? `${piece.color}${piece.type}` : 'null');\n        \n        return (event) => {\n            event.preventDefault();\n\n            if (!this.config.draggable || !piece || this.isAnimating || this.isDragging) {\n                return;\n            }\n\n            // Set dragging state immediately\n            this.isDragging = true;\n\n            const originalFrom = square;\n            let isDragging = false;\n            const from = originalFrom;\n            let to = square;\n            let previousHighlight = null;\n\n            const img = piece.element;\n\n            if (!this.moveService.canMove(from)) {\n                return;\n            }\n\n            // Track initial position for drag threshold\n            const startX = event.clientX || (event.touches && event.touches[0]?.clientX) || 0;\n            const startY = event.clientY || (event.touches && event.touches[0]?.clientY) || 0;\n\n            const moveAt = (event) => {\n                const boardElement = this.boardService.element;\n                const squareSize = boardElement.offsetWidth / 8;\n\n                // Get mouse coordinates\n                let clientX, clientY;\n                if (event.touches && event.touches[0]) {\n                    clientX = event.touches[0].clientX;\n                    clientY = event.touches[0].clientY;\n                } else {\n                    clientX = event.clientX;\n                    clientY = event.clientY;\n                }\n\n                // Calculate position relative to board\n                const boardRect = boardElement.getBoundingClientRect();\n                const x = clientX - boardRect.left - (squareSize / 2);\n                const y = clientY - boardRect.top - (squareSize / 2);\n\n                img.style.left = `${x  }px`;\n                img.style.top = `${y  }px`;\n\n                return true;\n            };\n\n            const onMouseMove = (event) => {\n                const currentX = event.clientX || 0;\n                const currentY = event.clientY || 0;\n                const deltaX = Math.abs(currentX - startX);\n                const deltaY = Math.abs(currentY - startY);\n\n                // Start dragging if mouse moved enough\n                if (!isDragging && (deltaX > 3 || deltaY > 3)) {\n                    isDragging = true;\n\n                    // During drag, we don't need to manage clicked state\n                    // The drag operation is independent of click state\n                    \n                    // Visual feedback\n                    if (this.config.clickable) {\n                        from.select();\n                        // Show hints would be handled by the main class\n                    }\n\n                    // Prepare piece for dragging\n                    // First, preserve the current computed dimensions\n                    const computedStyle = window.getComputedStyle(img);\n                    const currentWidth = computedStyle.width;\n                    const currentHeight = computedStyle.height;\n                    \n                    img.style.position = 'absolute';\n                    img.style.zIndex = '100';\n                    img.classList.add('dragging');\n                    \n                    // Explicitly set the dimensions to maintain size during drag\n                    img.style.width = currentWidth;\n                    img.style.height = currentHeight;\n\n                    DragOptimizations.enableForDrag(img);\n\n                    // Call drag start callback\n                    if (!onDragStart(square, piece)) {\n                        return;\n                    }\n                }\n\n                if (!isDragging) return;\n\n                if (!moveAt(event)) return;\n\n                // Update target square\n                const boardElement = this.boardService.element;\n                const boardRect = boardElement.getBoundingClientRect();\n                const x = event.clientX - boardRect.left;\n                const y = event.clientY - boardRect.top;\n\n                let newTo = null;\n                if (x >= 0 && x <= boardRect.width && y >= 0 && y <= boardRect.height) {\n                    const squareId = this.coordinateService.pixelToSquareID(x, y, boardElement);\n                    newTo = squareId ? this.boardService.getSquare(squareId) : null;\n                }\n\n                to = newTo;\n                onDragMove(from, to, piece);\n\n                // Update visual feedback\n                if (to !== previousHighlight) {\n                    to?.highlight();\n                    previousHighlight?.dehighlight();\n                    previousHighlight = to;\n                }\n            };\n\n            const onMouseUp = () => {\n                // Clean up visual feedback\n                previousHighlight?.dehighlight();\n                \n                // CRITICAL FIX: Remove ALL event listeners immediately to prevent interference\n                document.removeEventListener('mousemove', onMouseMove);\n                window.removeEventListener('mouseup', onMouseUp);\n                img.removeEventListener('mouseup', onMouseUp);\n\n                // If this was just a click, don't interfere\n                if (!isDragging) {\n                    return;\n                }\n\n                console.log('onMouseUp: Handling drag completion for piece at', originalFrom.id);\n\n                // Clean up drag state\n                img.style.zIndex = '20';\n                img.classList.remove('dragging');\n                img.style.willChange = 'auto';\n                \n                // Clean up drag optimizations that might interfere with click\n                DragOptimizations.cleanupAfterDrag(img);\n\n                // Reset drag state immediately to allow subsequent clicks\n                this.isDragging = false;\n\n                // Ensure clicked state is clean before handling drop\n                // This prevents drag operations from interfering with subsequent clicks\n                const previousClicked = this.clicked;\n                this.clicked = null;\n\n                // Handle drop\n                const dropResult = onDrop(originalFrom, to, piece);\n                const isTrashDrop = !to && (this.config.dropOffBoard === 'trash' || dropResult === 'trash');\n\n                if (isTrashDrop) {\n                    this._handleTrashDrop(originalFrom, onRemove);\n                } else if (!to) {\n                    // Reset piece position instantly for snapback\n                    img.style.position = '';\n                    img.style.left = '';\n                    img.style.top = '';\n                    img.style.transform = '';\n                    img.style.width = '';\n                    img.style.height = '';\n                    \n                    // Clean up drag optimizations\n                    DragOptimizations.cleanupAfterDrag(img);\n\n                    this._handleSnapback(originalFrom, piece, onSnapback);\n                    this._cleanupAfterFailedMove(originalFrom);\n                } else {\n                    // Handle drop like a click - simple and reliable\n                    this._handleDrop(originalFrom, to, piece, onMove, onSnapback);\n                }\n            };\n\n            // Attach event listeners\n            window.addEventListener('mouseup', onMouseUp, { once: true });\n            document.addEventListener('mousemove', onMouseMove);\n            img.addEventListener('mouseup', onMouseUp, { once: true });\n        };\n    }\n\n    /**\n     * Handles trash drop (piece removal)\n     * @private\n     * @param {Square} fromSquare - Source square\n     * @param {Function} onRemove - Callback to remove piece\n     */\n    _handleTrashDrop(fromSquare, onRemove) {\n        // Clear visual states\n        this.boardService.applyToAllSquares('unmoved');\n        this.boardService.applyToAllSquares('removeHint');\n        fromSquare.deselect();\n        \n        // Reset clicked state\n        this.clicked = null;\n\n        if (onRemove) {\n            onRemove(fromSquare.getId());\n        }\n        \n        logger.debug('EventService: Trash drop executed, state cleaned up');\n    }\n\n    /**\n     * Handles snapback animation\n     * @private\n     * @param {Square} fromSquare - Source square\n     * @param {Piece} piece - Piece to snapback\n     * @param {Function} onSnapback - Snapback callback\n     */\n    _handleSnapback(fromSquare, piece, onSnapback) {\n        if (fromSquare && fromSquare.piece) {\n            if (onSnapback) {\n                onSnapback(fromSquare, piece);\n            }\n        }\n        \n        // Always cleanup state after snapback\n        logger.debug('EventService: Snapback executed, cleaning up state');\n    }\n\n    /**\n     * Handles successful drop\n     * @private\n     * @param {Square} fromSquare - Source square\n     * @param {Square} toSquare - Target square\n     * @param {Piece} piece - Piece being dropped\n     * @param {Function} onMove - Move callback\n     * @param {Function} onSnapback - Snapback callback\n     */\n    _handleDrop(fromSquare, toSquare, piece, onMove, onSnapback) {\n        console.log('=== _handleDrop CALLED ===');\n        console.log('From:', fromSquare.id, 'To:', toSquare.id);\n        console.log('Piece:', piece ? `${piece.color}${piece.type}` : 'null');\n        console.log('Stack trace:', new Error().stack.split('\\n')[1]);\n        console.log('Caller:', new Error().stack.split('\\n')[2]);\n        \n        // CRITICAL FIX: Prevent multiple simultaneous drop operations\n        if (this.isAnimating || this._isProcessingDrop) {\n            console.log('Drop ignored - already processing or animating');\n            return;\n        }\n        \n        // Set processing flag to prevent interference\n        this._isProcessingDrop = true;\n        \n        const cleanup = () => {\n            this._isProcessingDrop = false;\n        };\n        \n        // The core issue is state management. A drop action should be atomic.\n        // It either succeeds or fails, and the state should be cleaned completely afterward.\n        // We should not be setting `this.clicked` here at all.\n\n        try {\n            // Check for promotion first, as it's a special case.\n            if (this.moveService.requiresPromotion(new Move(fromSquare, toSquare))) {\n            logger.debug('Drag move requires promotion:', fromSquare.id, '->', toSquare.id);\n\n            this.moveService.setupPromotion(\n                new Move(fromSquare, toSquare),\n                this.boardService.squares,\n                (selectedPromotion) => {\n                    logger.debug('Drag promotion selected:', selectedPromotion);\n                    this.boardService.applyToAllSquares('removePromotion');\n                    this.boardService.applyToAllSquares('removeCover');\n\n                    // Attempt the move with promotion.\n                    const moveResult = onMove(fromSquare, toSquare, selectedPromotion, true);\n                    if (moveResult) {\n                        this._schedulePromotionPieceReplacement(toSquare, selectedPromotion);\n                        this._cleanupAfterSuccessfulMove(fromSquare);\n                    } else {\n                        this._handleSnapback(fromSquare, piece, onSnapback);\n                        this._cleanupAfterFailedMove(fromSquare);\n                    }\n                    cleanup();\n                },\n                () => {\n                    logger.debug('Drag promotion cancelled');\n                    this.boardService.applyToAllSquares('removePromotion');\n                    this.boardService.applyToAllSquares('removeCover');\n                    this._handleSnapback(fromSquare, piece, onSnapback);\n                    this._cleanupAfterFailedMove(fromSquare);\n                    cleanup();\n                }\n            );\n        } else {\n            // Regular move.\n            const moveSuccess = onMove(fromSquare, toSquare, null, true);\n\n            if (moveSuccess) {\n                this._cleanupAfterSuccessfulMove(fromSquare);\n            } else {\n                this._handleSnapback(fromSquare, piece, onSnapback);\n                this._cleanupAfterFailedMove(fromSquare);\n            }\n            cleanup();\n        }\n        } catch (error) {\n            console.error('Error in _handleDrop:', error);\n            cleanup();\n        }\n    }\n\n    /**\n     * Cleans up visual state after a SUCCESSFUL move\n     * @private\n     * @param {Square} fromSquare - Source square\n     */\n    _cleanupAfterSuccessfulMove(fromSquare) {\n        // Always reset interaction state after any successful move (drag or click)\n        this.clicked = null;\n        this.isDragging = false;\n        \n        // Clear specific visual states related to the move\n        if (fromSquare) {\n            fromSquare.deselect();\n        }\n        \n        // Clean up ALL visual elements after a successful move\n        // This includes removing old move highlights to keep the board clean\n        this.boardService.applyToAllSquares('removeHint');\n        this.boardService.applyToAllSquares('dehighlight');\n        this.boardService.applyToAllSquares('removePromotion');\n        this.boardService.applyToAllSquares('removeCover');\n        \n        logger.debug('EventService: All visual state cleaned up after SUCCESSFUL move');\n    }\n\n    /**\n     * Cleans up visual state after a FAILED move (snapback, invalid move)\n     * @private\n     * @param {Square} fromSquare - Source square\n     */\n    _cleanupAfterFailedMove(fromSquare) {\n        // Reset interaction state but be more conservative with visual cleanup\n        this.clicked = null;\n        this.isDragging = false;\n        \n        // Clean specific visual elements related to failed operation\n        this.boardService.applyToAllSquares('removePromotion');\n        this.boardService.applyToAllSquares('removeCover');\n        this.boardService.applyToAllSquares('removeHint');\n        \n        // Only deselect the specific square that failed\n        if (fromSquare) {\n            fromSquare.deselect();\n        }\n        \n        // Don't aggressively clear all highlights - preserve move history\n        // this.boardService.applyToAllSquares('dehighlight');\n        \n        logger.debug('EventService: Conservative cleanup after FAILED move');\n    }\n\n    /**\n     * Animates piece to center of target square (visual only)\n     * @private\n     * @param {Piece} piece - Piece to animate\n     * @param {Square} targetSquare - Target square\n     * @param {Function} callback - Callback when animation completes\n     */\n    _animatePieceToCenter(piece, targetSquare, callback = null) {\n        if (!piece || !targetSquare) {\n            if (callback) callback();\n            return;\n        }\n\n        const duration = this.config.dropCenterTime;\n\n        // Get current position of piece element\n        const sourceRect = piece.element.getBoundingClientRect();\n        const targetRect = targetSquare.element.getBoundingClientRect();\n\n        const x_start = sourceRect.left + sourceRect.width / 2;\n        const y_start = sourceRect.top + sourceRect.height / 2;\n        const x_end = targetRect.left + targetRect.width / 2;\n        const y_end = targetRect.top + targetRect.height / 2;\n        const dx = x_end - x_start;\n        const dy = y_end - y_start;\n\n        if (Math.abs(dx) < 1 && Math.abs(dy) < 1) {\n            // Already centered, just reset styles\n            piece.element.style.position = '';\n            piece.element.style.left = '';\n            piece.element.style.top = '';\n            piece.element.style.transform = '';\n            piece.element.style.zIndex = '';\n            if (callback) callback();\n            return;\n        }\n\n        const keyframes = [\n            { transform: 'translate(0, 0)' },\n            { transform: `translate(${dx}px, ${dy}px)` }\n        ];\n\n        if (piece.element.animate) {\n            const animation = piece.element.animate(keyframes, {\n                duration,\n                easing: 'ease',\n                fill: 'none'  // Don't keep the final position\n            });\n\n            animation.onfinish = () => {\n                // Defensive: check if element still exists\n                if (!piece.element) {\n                    if (callback) callback();\n                    return;\n                }\n                // Reset all drag-related styles to let default CSS handle positioning\n                piece.element.style.position = '';\n                piece.element.style.left = '';\n                piece.element.style.top = '';\n                piece.element.style.transform = '';\n                piece.element.style.zIndex = '';\n                piece.element.style.transition = '';\n\n                if (callback) callback();\n            };\n        } else {\n            // Fallback for browsers without Web Animations API\n            piece.element.style.transition = `transform ${duration}ms ease`;\n            piece.element.style.transform = `translate(${dx}px, ${dy}px)`;\n\n            setTimeout(() => {\n                // Defensive: check if element still exists\n                if (!piece.element) {\n                    if (callback) callback();\n                    return;\n                }\n                // After animation, reset ALL positioning styles and let CSS handle centering\n                piece.element.style.position = 'relative';\n                piece.element.style.left = '0';\n                piece.element.style.top = '0';\n                piece.element.style.transform = 'translate(-50%, -50%)';\n                piece.element.style.zIndex = '20';\n                piece.element.style.transition = 'none';\n\n                if (callback) callback();\n            }, duration);\n        }\n    }\n\n    /**\n     * Handles square click events\n     * @param {Square} square - Clicked square\n     * @param {Function} onMove - Move callback\n     * @param {Function} onSelect - Select callback\n     * @param {Function} onDeselect - Deselect callback\n     * @param {boolean} [animate=true] - Whether to animate the move\n     * @param {boolean} [dragged=false] - Whether this was triggered by drag\n     * @returns {boolean} True if move was successful\n     */\n    onClick(square, onMove, onSelect, onDeselect, animate = true, dragged = false) {\n        // Always ensure we're not in dragging state during click operations\n        this.isDragging = false;\n        \n        // If we're animating, ignore the click to prevent state corruption\n        if (this.isAnimating) {\n            logger.debug('EventService.onClick: Ignoring click during animation');\n            return false;\n        }\n        \n        logger.debug('=== EventService.onClick START ===');\n        logger.debug('EventService.onClick: square =', square.id, 'clicked =', this.clicked?.id || 'none', 'isAnimating =', this.isAnimating);\n        logger.debug('EventService.onClick: Square piece =', square.piece ? `${square.piece.color}${square.piece.type}` : 'empty');\n        logger.debug('EventService.onClick: Clicked square piece =', this.clicked?.piece ? `${this.clicked.piece.color}${this.clicked.piece.type}` : (this.clicked ? 'empty' : 'none'));\n\n        let from = this.clicked;\n        let promotion = null;\n\n        // Handle promotion state\n        if (this.promoting) {\n            if (this.promoting === 'none') {\n                from = null;\n            } else {\n                promotion = this.promoting;\n            }\n\n            this.promoting = false;\n            this.boardService.applyToAllSquares('removePromotion');\n            this.boardService.applyToAllSquares('removeCover');\n        }\n\n        // No source square selected\n        if (!from) {\n            logger.debug('EventService.onClick: No source square, checking if can move:', square.id);\n            if (this.moveService.canMove(square)) {\n                logger.debug('EventService.onClick: Can move! Setting clicked to:', square.id);\n                this.clicked = square;\n                if (this.config.clickable) {\n                    // Ensure visual selection happens after state is set\n                    onSelect(square);\n                    logger.debug('EventService.onClick: Square selected visually:', square.id);\n                }\n                logger.debug('EventService.onClick: After setting, clicked =', this.clicked?.id || 'none');\n                return false;\n            } \n                logger.debug('EventService.onClick: Cannot move square:', square.id);\n                return false;\n            \n        }\n\n        logger.debug('EventService.onClick: We have a source square:', from.id, 'target:', square.id);\n\n        // Clicking same square - deselect\n        if (this.clicked === square) {\n            onDeselect(square);\n            this.clicked = null;\n            return false;\n        }\n\n        // Check if move requires promotion\n        if (!promotion && this.moveService.requiresPromotion(new Move(from, square))) {\n            logger.debug('Move requires promotion:', from.id, '->', square.id);\n\n            // Set up promotion UI\n            this.moveService.setupPromotion(\n                new Move(from, square),\n                this.boardService.squares,\n                (selectedPromotion) => {\n                    logger.debug('Promotion selected:', selectedPromotion);\n\n                    // Clear promotion UI first\n                    this.boardService.applyToAllSquares('removePromotion');\n                    this.boardService.applyToAllSquares('removeCover');\n\n                    // Execute the move with promotion\n                    const moveResult = onMove(from, square, selectedPromotion, animate);\n\n                    if (moveResult) {\n                        // After a successful promotion move, we need to replace the piece\n                        // after the drop animation completes\n                        this._schedulePromotionPieceReplacement(square, selectedPromotion);\n\n                        onDeselect(from);\n                        this.clicked = null;\n                    }\n                },\n                () => {\n                    logger.debug('Promotion cancelled');\n\n                    // Clear promotion UI on cancel\n                    this.boardService.applyToAllSquares('removePromotion');\n                    this.boardService.applyToAllSquares('removeCover');\n\n                    onDeselect(from);\n                    this.clicked = null;\n                }\n            );\n            return false;\n        }\n\n        // Attempt to make move\n        logger.debug('EventService.onClick: Attempting move from', from.id, 'to', square.id);\n        logger.debug('EventService.onClick: Current game state before move attempt');\n        const moveResult = onMove(from, square, promotion, animate);\n\n        if (moveResult) {\n            // Move successful\n            logger.debug('EventService.onClick: Move successful');\n            onDeselect(from);\n            this.clicked = null;\n            logger.debug('=== EventService.onClick END (move successful) ===');\n            return true;\n        } \n            // Move failed - deselect current and try to select new piece\n            logger.debug('EventService.onClick: Move failed from', from.id, 'to', square.id, '- resetting state');\n            \n            // Always deselect the current piece first\n            onDeselect(from);\n            this.clicked = null;\n            this.isDragging = false;\n            \n            // Clear move-related visual states but preserve highlights\n            this.boardService.applyToAllSquares('removeHint');\n            \n            // Now check if the target square has a piece we can move and select it\n            if (this.moveService.canMove(square)) {\n                logger.debug('EventService.onClick: Can select new piece at', square.id);\n                \n                this.clicked = square;\n                if (this.config.clickable) {\n                    onSelect(square);\n                    logger.debug('EventService.onClick: New piece selected visually:', square.id);\n                }\n                logger.debug('EventService.onClick: New piece selected at', square.id);\n            } else {\n                logger.debug('EventService.onClick: Cannot select piece at', square.id, '- staying deselected');\n            }\n            \n            logger.debug('=== EventService.onClick END (move failed) ===');\n            return false;\n        \n    }\n\n    /**\n     * Schedules piece replacement after promotion animation\n     * @private\n     * @param {Square} square - Target square\n     * @param {string} promotionPiece - Piece to promote to\n     */\n    _schedulePromotionPieceReplacement(square, promotionPiece) {\n        // Mark that we're doing a promotion to prevent interference\n        this.chessboard._isPromoting = true;\n\n        // Use a more robust approach: poll for the piece to be present\n        this._waitForPieceAndReplace(square, promotionPiece, 0);\n    }\n\n    /**\n     * Waits for piece to be present and then replaces it\n     * @private\n     * @param {Square} square - Target square\n     * @param {string} promotionPiece - Piece to promote to\n     * @param {number} attempt - Current attempt number\n     */\n    _waitForPieceAndReplace(square, promotionPiece, attempt) {\n        const maxAttempts = 20; // Maximum 1 second of waiting (20 * 50ms)\n        const targetSquare = this.boardService.getSquare(square.id);\n\n        if (!targetSquare) {\n            logger.warn('Target square not found:', square.id);\n            this.chessboard._isPromoting = false;\n            return;\n        }\n\n        // Check if piece is present and ready\n        if (targetSquare.piece && targetSquare.piece.element) {\n            logger.debug('Piece found on', square.id, 'after', attempt, 'attempts');\n            this._replacePromotionPiece(square, promotionPiece);\n\n            // Allow normal updates again after transformation\n            setTimeout(() => {\n                this.chessboard._isPromoting = false;\n                logger.debug('Promotion protection ended');\n                // Force a board update to ensure everything is correctly synchronized\n                this.chessboard._updateBoardPieces(false);\n            }, 400); // Wait for transformation animation to complete\n\n            return;\n        }\n\n        // If piece not found and we haven't exceeded max attempts, try again\n        if (attempt < maxAttempts) {\n            setTimeout(() => {\n                this._waitForPieceAndReplace(square, promotionPiece, attempt + 1);\n            }, 50);\n        } else {\n            logger.warn('Failed to find piece for promotion after', maxAttempts, 'attempts');\n            this.chessboard._isPromoting = false;\n\n            // Force a board update to recover from the failed promotion\n            this.chessboard._updateBoardPieces(false);\n        }\n    }\n\n    /**\n     * Replaces the piece on the square with the promotion piece\n     * @private\n     * @param {Square} square - Target square\n     * @param {string} promotionPiece - Piece to promote to\n     */\n    _replacePromotionPiece(square, promotionPiece) {\n        logger.debug('Replacing piece on', square.id, 'with', promotionPiece);\n\n        // Get the target square from the board service\n        const targetSquare = this.boardService.getSquare(square.id);\n        if (!targetSquare) {\n            logger.debug('Target square not found:', square.id);\n            return;\n        }\n\n        // Get the game state to determine the correct piece color\n        const gameState = this.chessboard.positionService.getGame();\n        const gamePiece = gameState.get(targetSquare.id);\n\n        if (!gamePiece) {\n            logger.debug('No piece found in game state for', targetSquare.id);\n            return;\n        }\n\n        // Get the current piece on the square\n        const currentPiece = targetSquare.piece;\n\n        if (!currentPiece) {\n            logger.warn('No piece found on target square for promotion');\n\n            // Try to recover by creating a new piece\n            const pieceId = promotionPiece + gamePiece.color;\n            const piecePath = this.chessboard.pieceService.getPiecePath(pieceId);\n\n            const newPiece = new Piece(\n                gamePiece.color,\n                promotionPiece,\n                piecePath\n            );\n\n            // Place the new piece on the square\n            targetSquare.putPiece(newPiece);\n\n            // Set up drag functionality\n            const dragFunction = this.chessboard._createDragFunction.bind(this.chessboard);\n            newPiece.setDrag(dragFunction(targetSquare, newPiece));\n\n            logger.debug('Created new promotion piece:', pieceId, 'on', targetSquare.id);\n            return;\n        }\n\n        // Create the piece ID and get the path\n        const pieceId = promotionPiece + gamePiece.color;\n        const piecePath = this.chessboard.pieceService.getPiecePath(pieceId);\n\n        logger.debug('Transforming piece to:', pieceId, 'with path:', piecePath);\n\n        // Use the new smooth transformation animation\n        currentPiece.transformTo(\n            promotionPiece,\n            piecePath,\n            300, // Duration of the transformation animation\n            () => {\n                // After transformation, set up drag functionality\n                const dragFunction = this.chessboard._createDragFunction.bind(this.chessboard);\n                currentPiece.setDrag(dragFunction(targetSquare, currentPiece));\n\n                // Ensure hints are properly updated after promotion\n                if (this.config.hints && this.chessboard.moveService) {\n                    setTimeout(() => {\n                        this.chessboard.moveService.clearCache();\n                    }, 100);\n                }\n\n                logger.debug('Successfully transformed piece on', targetSquare.id, 'to', pieceId);\n            }\n        );\n    }\n\n    /**\n     * Sets the clicked square\n     * @param {Square|null} square - Square to set as clicked\n     */\n    setClicked(square) {\n        this.clicked = square;\n    }\n\n    /**\n     * Gets the currently clicked square\n     * @returns {Square|null} Currently clicked square\n     */\n    getClicked() {\n        return this.clicked;\n    }\n\n    /**\n     * Sets the promotion state\n     * @param {string|boolean} promotion - Promotion piece type or false\n     */\n    setPromoting(promotion) {\n        this.promoting = promotion;\n    }\n\n    /**\n     * Gets the promotion state\n     * @returns {string|boolean} Current promotion state\n     */\n    getPromoting() {\n        return this.promoting;\n    }\n\n    /**\n     * Sets the animation state\n     * @param {boolean} isAnimating - Whether animations are in progress\n     */\n    setAnimating(isAnimating) {\n        this.isAnimating = isAnimating;\n    }\n\n    /**\n     * Gets the animation state\n     * @returns {boolean} Whether animations are in progress\n     */\n    getAnimating() {\n        return this.isAnimating;\n    }\n\n    /**\n     * Removes all existing event listeners\n     */\n    removeListeners() {\n        this.eventListeners.forEach((listeners, squareId) => {\n            listeners.forEach(({ element, type, handler }) => {\n                element.removeEventListener(type, handler);\n            });\n        });\n\n        this.eventListeners.clear();\n    }\n\n    /**\n     * Removes all event listeners\n     */\n    removeAllListeners() {\n        this.eventListeners.forEach((listeners, squareId) => {\n            listeners.forEach(({ element, type, handler }) => {\n                element.removeEventListener(type, handler);\n            });\n        });\n\n        this.eventListeners.clear();\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        this.removeAllListeners();\n        this.clicked = null;\n        this.promoting = false;\n        this.isAnimating = false;\n        this.isDragging = false;\n    }\n}\n","/**\n * Service for managing chess moves and move validation\n * @module services/MoveService\n * @since 2.0.0\n */\n\nimport Move from '../components/Move.js';\nimport { MoveError, ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\nimport { PROMOTION_PIECES } from '../constants/positions.js';\n\n/**\n * Service responsible for move management and validation\n * @class\n */\nexport class MoveService {\n    /**\n     * Creates a new MoveService instance\n     * @param {ChessboardConfig} config - Board configuration\n     * @param {PositionService} positionService - Position service instance\n     */\n    constructor(config, positionService) {\n        this.config = config;\n        this.positionService = positionService;\n        this._movesCache = new Map();\n        this._cacheTimeout = null;\n        \n        // Add debouncing for promotion checks to prevent duplicates\n        this._lastPromotionCheck = null;\n        this._lastPromotionResult = null;\n        this._promotionCheckTimeout = null;\n        \n        // Track recently processed moves to prevent duplicates\n        this._recentMoves = new Set();\n        this._recentMovesTimeout = null;\n    }\n\n    /**\n     * Checks if a piece on a square can move\n     * @param {Square} square - Square to check\n     * @returns {boolean} True if piece can move\n     */\n    canMove(square) {\n        if (!square.piece) return false;\n        \n        const { movableColors, onlyLegalMoves } = this.config;\n        \n        if (movableColors === 'none') return false;\n        if (movableColors === 'w' && square.piece.color === 'b') return false;\n        if (movableColors === 'b' && square.piece.color === 'w') return false;\n        \n        if (!onlyLegalMoves) return true;\n        \n        // Check if position service and game are available\n        if (!this.positionService || !this.positionService.getGame()) {\n            return false;\n        }\n        \n        const game = this.positionService.getGame();\n        return square.piece.color === game.turn();\n    }\n\n    /**\n     * Converts various move formats to a Move instance\n     * @param {string|Move} move - Move in various formats\n     * @param {Object} squares - All board squares\n     * @returns {Move} Move instance\n     * @throws {MoveError} When move format is invalid\n     */\n    convertMove(move, squares) {\n        if (move instanceof Move) {\n            return move;\n        }\n        \n        if (typeof move === 'string' && move.length >= 4) {\n            const fromId = move.slice(0, 2);\n            const toId = move.slice(2, 4);\n            const promotion = move.slice(4, 5) || null;\n            \n            if (!squares[fromId] || !squares[toId]) {\n                throw new MoveError(ERROR_MESSAGES.invalid_move_format, fromId, toId);\n            }\n            \n            return new Move(squares[fromId], squares[toId], promotion);\n        }\n        \n        throw new MoveError(ERROR_MESSAGES.invalid_move_format, 'unknown', 'unknown');\n    }\n\n    /**\n     * Checks if a move is legal\n     * @param {Move} move - Move to check\n     * @returns {boolean} True if move is legal\n     */\n    isLegalMove(move) {\n        const legalMoves = this.getLegalMoves(move.from.id);\n        \n        return legalMoves.some(legalMove => \n            legalMove.to === move.to.id && \n            move.promotion === legalMove.promotion\n        );\n    }\n\n    /**\n     * Gets all legal moves for a square or the entire position\n     * @param {string} [from] - Square to get moves from (optional)\n     * @param {boolean} [verbose=true] - Whether to return verbose move objects\n     * @returns {Array} Array of legal moves\n     */\n    getLegalMoves(from = null, verbose = true) {\n        // Check if position service and game are available\n        if (!this.positionService || !this.positionService.getGame()) {\n            return [];\n        }\n        \n        const game = this.positionService.getGame();\n        \n        if (!game) return [];\n        \n        const options = { verbose };\n        if (from) {\n            options.square = from;\n        }\n        \n        return game.moves(options);\n    }\n\n    /**\n     * Gets legal moves with caching for performance\n     * @param {Square} square - Square to get moves from\n     * @returns {Array} Array of legal moves\n     */\n    getCachedLegalMoves(square) {\n        // Check if position service and game are available\n        if (!this.positionService || !this.positionService.getGame()) {\n            return [];\n        }\n        \n        const game = this.positionService.getGame();\n        if (!game) return [];\n        \n        const cacheKey = `${square.id}-${game.fen()}`;\n        let moves = this._movesCache.get(cacheKey);\n        \n        if (!moves) {\n            moves = game.moves({ square: square.id, verbose: true });\n            this._movesCache.set(cacheKey, moves);\n            \n            // Clear cache after a short delay to prevent memory buildup\n            if (this._cacheTimeout) {\n                clearTimeout(this._cacheTimeout);\n            }\n            \n            this._cacheTimeout = setTimeout(() => {\n                this._movesCache.clear();\n            }, 1000);\n        }\n        \n        return moves;\n    }\n\n    /**\n     * Executes a move on the game\n     * @param {Move} move - Move to execute\n     * @returns {Object|null} Move result from chess.js or null if invalid\n     */\n    executeMove(move) {\n        // Check if position service and game are available\n        if (!this.positionService || !this.positionService.getGame()) {\n            return null;\n        }\n        \n        const game = this.positionService.getGame();\n        if (!game) return null;\n        \n        const moveOptions = {\n            from: move.from.id,\n            to: move.to.id\n        };\n        \n        console.log('executeMove - move.promotion:', move.promotion);\n        console.log('executeMove - move.hasPromotion():', move.hasPromotion());\n        \n        if (move.hasPromotion()) {\n            moveOptions.promotion = move.promotion;\n        }\n        \n        console.log('executeMove - moveOptions:', moveOptions);\n        \n        const result = game.move(moveOptions);\n        console.log('executeMove - result:', result);\n        \n        // Check what's actually on the board after the move\n        if (result) {\n            const pieceOnDestination = game.get(move.to.id);\n            console.log('executeMove - piece on destination after move:', pieceOnDestination);\n        }\n        \n        return result;\n    }\n\n    /**\n     * Checks if a move requires promotion\n     * @param {Move} move - Move to check\n     * @returns {boolean} True if promotion is required\n     */\n    requiresPromotion(move) {\n        const moveKey = `${move.from.id}->${move.to.id}`;\n        console.log('Checking if move requires promotion:', moveKey);\n        \n        // Get detailed stack trace\n        const stack = new Error().stack.split('\\n');\n        console.log('Call stack:', stack[1]);\n        console.log('Caller:', stack[2]);\n        console.log('Caller 2:', stack[3]);\n        console.log('Caller 3:', stack[4]);\n        \n        // Track recently processed moves to prevent processing the same move multiple times\n        const now = Date.now();\n        if (this._recentMoves.has(moveKey)) {\n            console.log('Move recently processed, skipping duplicate check');\n            return false; // Conservative: assume no promotion needed for duplicates\n        }\n        \n        // Debounce identical promotion checks within 100ms\n        if (this._lastPromotionCheck === moveKey && \n            this._lastPromotionResult !== null &&\n            now - this._lastPromotionTime < 100) {\n            console.log('Using cached promotion result:', this._lastPromotionResult);\n            return this._lastPromotionResult;\n        }\n        \n        // Add to recent moves set\n        this._recentMoves.add(moveKey);\n        \n        const result = this._doRequiresPromotion(move);\n        \n        // Cache the result\n        this._lastPromotionCheck = moveKey;\n        this._lastPromotionResult = result;\n        this._lastPromotionTime = now;\n        \n        // Clear caches after delays\n        if (this._promotionCheckTimeout) {\n            clearTimeout(this._promotionCheckTimeout);\n        }\n        this._promotionCheckTimeout = setTimeout(() => {\n            this._lastPromotionCheck = null;\n            this._lastPromotionResult = null;\n        }, 500);\n        \n        if (this._recentMovesTimeout) {\n            clearTimeout(this._recentMovesTimeout);\n        }\n        this._recentMovesTimeout = setTimeout(() => {\n            this._recentMoves.clear();\n        }, 1000); // Clear recent moves after 1 second\n        \n        return result;\n    }\n\n    /**\n     * Internal promotion check logic\n     * @private\n     * @param {Move} move - Move to check\n     * @returns {boolean} True if promotion is required\n     */\n    _doRequiresPromotion(move) {\n        if (!this.config.onlyLegalMoves) {\n            console.log('Not in legal moves mode, no promotion required');\n            return false;\n        }\n        \n        const game = this.positionService.getGame();\n        if (!game) {\n            console.log('No game instance available');\n            return false;\n        }\n        \n        const piece = game.get(move.from.id);\n        if (!piece || piece.type !== 'p') {\n            console.log('Not a pawn move, no promotion required');\n            return false;\n        }\n        \n        const targetRank = move.to.row;\n        if (targetRank !== 1 && targetRank !== 8) {\n            console.log('Not reaching promotion rank, no promotion required');\n            return false;\n        }\n        \n        console.log('Pawn reaching promotion rank - promotion required');\n        \n        // Additional validation: check if the pawn can actually reach this square\n        if (!this._isPawnMoveValid(move.from, move.to, piece.color)) {\n            console.log('Pawn move not valid, no promotion required');\n            return false;\n        }\n        \n        // If we get here, it's a pawn move to the promotion rank\n        // Check if it's a legal move by using the game's moves() method\n        const legalMoves = game.moves({ square: move.from.id, verbose: true });\n        const matchingMove = legalMoves.find(m => m.to === move.to.id);\n        \n        if (!matchingMove) {\n            console.log('Move not in legal moves list, no promotion required');\n            return false;\n        }\n        \n        // If the legal move has a promotion flag or is to a promotion rank, promotion is required\n        const requiresPromotion = matchingMove.flags.includes('p') || \n                                (piece.color === 'w' && targetRank === 8) || \n                                (piece.color === 'b' && targetRank === 1);\n        \n        console.log('Promotion required:', requiresPromotion);\n        return requiresPromotion;\n    }\n\n    /**\n     * Validates if a pawn move is theoretically possible\n     * @private\n     * @param {Square} from - Source square\n     * @param {Square} to - Target square\n     * @param {string} color - Pawn color ('w' or 'b')\n     * @returns {boolean} True if the move is valid for a pawn\n     */\n    _isPawnMoveValid(from, to, color) {\n        const fromRank = from.row;\n        const toRank = to.row;\n        const fromFile = from.col;\n        const toFile = to.col;\n        \n        console.log(`Validating pawn move: ${from.id} -> ${to.id} (${color})`);\n        console.log(`Ranks: ${fromRank} -> ${toRank}, Files: ${fromFile} -> ${toFile}`);\n        \n        // Direction of pawn movement\n        const direction = color === 'w' ? 1 : -1;\n        const rankDiff = toRank - fromRank;\n        const fileDiff = Math.abs(toFile - fromFile);\n        \n        // Pawn can only move forward\n        if (rankDiff * direction <= 0) {\n            console.log('Invalid: Pawn cannot move backward or stay in place');\n            return false;\n        }\n        \n        // Pawn can only move 1 rank at a time (except for double move from starting position)\n        if (Math.abs(rankDiff) > 2) {\n            console.log('Invalid: Pawn cannot move more than 2 ranks');\n            return false;\n        }\n        \n        // If moving 2 ranks, must be from starting position\n        if (Math.abs(rankDiff) === 2) {\n            const startingRank = color === 'w' ? 2 : 7;\n            if (fromRank !== startingRank) {\n                console.log(`Invalid: Pawn cannot move 2 ranks from rank ${fromRank}`);\n                return false;\n            }\n        }\n        \n        // Pawn can only move to adjacent files (diagonal capture) or same file (forward move)\n        if (fileDiff > 1) {\n            console.log('Invalid: Pawn cannot move more than 1 file');\n            return false;\n        }\n        \n        console.log('Pawn move validation passed');\n        return true;\n    }\n\n    /**\n     * Handles promotion UI setup\n     * @param {Move} move - Move requiring promotion\n     * @param {Object} squares - All board squares\n     * @param {Function} onPromotionSelect - Callback when promotion piece is selected\n     * @param {Function} onPromotionCancel - Callback when promotion is cancelled\n     * @returns {boolean} True if promotion UI was set up\n     */\n    setupPromotion(move, squares, onPromotionSelect, onPromotionCancel) {\n        if (!this.requiresPromotion(move)) return false;\n        \n        // Check if position service and game are available\n        if (!this.positionService || !this.positionService.getGame()) {\n            return false;\n        }\n        \n        const game = this.positionService.getGame();\n        const piece = game.get(move.from.id);\n        const targetSquare = move.to;\n        \n        // Clear any existing promotion UI\n        Object.values(squares).forEach(square => {\n            square.removePromotion();\n            square.removeCover();\n        });\n        \n        // Always show promotion choices in a column\n        this._showPromotionInColumn(targetSquare, piece, squares, onPromotionSelect, onPromotionCancel);\n        \n        return true;\n    }\n    \n    /**\n     * Shows promotion choices in a column\n     * @private\n     */\n    _showPromotionInColumn(targetSquare, piece, squares, onPromotionSelect, onPromotionCancel) {\n        console.log('Setting up promotion for', targetSquare.id, 'piece color:', piece.color);\n        \n        // Set up promotion choices starting from border row\n        PROMOTION_PIECES.forEach((pieceType, index) => {\n            const choiceSquare = this._findPromotionSquare(targetSquare, index, squares);\n            \n            if (choiceSquare) {\n                const pieceId = pieceType + piece.color;\n                const piecePath = this._getPiecePathForPromotion(pieceId);\n                \n                console.log('Setting up promotion choice:', pieceType, 'on square:', choiceSquare.id);\n                \n                choiceSquare.putPromotion(piecePath, () => {\n                    console.log('Promotion choice selected:', pieceType);\n                    onPromotionSelect(pieceType);\n                });\n            } else {\n                console.log('Could not find square for promotion choice:', pieceType, 'index:', index);\n            }\n        });\n        \n        // Set up cover squares (for cancellation)\n        Object.values(squares).forEach(square => {\n            if (!square.hasPromotion()) {\n                square.putCover(() => {\n                    onPromotionCancel();\n                });\n            }\n        });\n        \n        return true;\n    }\n\n    /**\n     * Finds the appropriate square for a promotion piece\n     * @private\n     * @param {Square} targetSquare - Target square of the promotion move\n     * @param {number} distance - Distance from target square\n     * @param {Object} squares - All board squares\n     * @returns {Square|null} Square for promotion piece or null\n     */\n    _findPromotionSquare(targetSquare, index, squares) {\n        const col = targetSquare.col;\n        const baseRow = targetSquare.row;\n        \n        console.log('Looking for promotion square - target:', targetSquare.id, 'index:', index, 'col:', col, 'baseRow:', baseRow);\n        \n        // Calculate row based on index and promotion direction\n        // Start from the border row (1 or 8) and go inward\n        let row;\n        if (baseRow === 8) {\n            // White promotion: start from row 8 and go down\n            row = 8 - index;\n        } else if (baseRow === 1) {\n            // Black promotion: start from row 1 and go up\n            row = 1 + index;\n        } else {\n            console.log('Invalid promotion row:', baseRow);\n            return null;\n        }\n        \n        console.log('Calculated row:', row);\n        \n        // Ensure row is within bounds\n        if (row < 1 || row > 8) {\n            console.log('Row out of bounds:', row);\n            return null;\n        }\n        \n        // Find square by row/col\n        for (const square of Object.values(squares)) {\n            if (square.col === col && square.row === row) {\n                console.log('Found promotion square:', square.id);\n                return square;\n            }\n        }\n        \n        console.log('No square found for col:', col, 'row:', row);\n        return null;\n    }\n\n    /**\n     * Gets piece path for promotion UI\n     * @private\n     * @param {string} pieceId - Piece identifier\n     * @returns {string} Path to piece asset\n     */\n    _getPiecePathForPromotion(pieceId) {\n        // This would typically use the PieceService\n        // For now, we'll use a simple implementation\n        const { piecesPath } = this.config;\n        \n        if (typeof piecesPath === 'string') {\n            return `${piecesPath}/${pieceId}.svg`;\n        }\n        \n        // Fallback for other path types\n        return `assets/pieces/${pieceId}.svg`;\n    }\n\n    /**\n     * Parses a move string into a move object\n     * @param {string} moveString - Move string (e.g., 'e2e4', 'e7e8q')\n     * @returns {Object|null} Move object or null if invalid\n     */\n    parseMove(moveString) {\n        if (typeof moveString !== 'string' || moveString.length < 4 || moveString.length > 5) {\n            return null;\n        }\n        \n        const from = moveString.slice(0, 2);\n        const to = moveString.slice(2, 4);\n        const promotion = moveString.slice(4, 5);\n        \n        // Basic validation\n        if (!/^[a-h][1-8]$/.test(from) || !/^[a-h][1-8]$/.test(to)) {\n            return null;\n        }\n        \n        if (promotion && !['q', 'r', 'b', 'n'].includes(promotion.toLowerCase())) {\n            return null;\n        }\n        \n        return {\n            from,\n            to,\n            promotion: promotion || null\n        };\n    }\n\n    /**\n     * Checks if a move is a castle move\n     * @param {Object} gameMove - Game move object from chess.js\n     * @returns {boolean} True if move is castle\n     */\n    isCastle(gameMove) {\n        return gameMove && (gameMove.isKingsideCastle() || gameMove.isQueensideCastle());\n    }\n\n    /**\n     * Gets the rook move for a castle move\n     * @param {Object} gameMove - Game move object from chess.js\n     * @returns {Object|null} Rook move object or null if not castle\n     */\n    getCastleRookMove(gameMove) {\n        if (!this.isCastle(gameMove)) {\n            return null;\n        }\n        \n        const isKingSide = gameMove.isKingsideCastle();\n        const isWhite = gameMove.color === 'w';\n        \n        if (isKingSide) {\n            // King side castle\n            if (isWhite) {\n                return { from: 'h1', to: 'f1' };\n            } \n                return { from: 'h8', to: 'f8' };\n            \n        } \n            // Queen side castle\n            if (isWhite) {\n                return { from: 'a1', to: 'd1' };\n            } \n                return { from: 'a8', to: 'd8' };\n            \n        \n    }\n\n    /**\n     * Checks if a move is en passant\n     * @param {Object} gameMove - Game move object from chess.js\n     * @returns {boolean} True if move is en passant\n     */\n    isEnPassant(gameMove) {\n        return gameMove && gameMove.isEnPassant();\n    }\n\n    /**\n     * Gets the captured pawn square for en passant\n     * @param {Object} gameMove - Game move object from chess.js\n     * @returns {string|null} Square of captured pawn or null if not en passant\n     */\n    getEnPassantCapturedSquare(gameMove) {\n        if (!this.isEnPassant(gameMove)) {\n            return null;\n        }\n        \n        const toSquare = gameMove.to;\n        const rank = parseInt(toSquare[1]);\n        const file = toSquare[0];\n        \n        // The captured pawn is on the same file but different rank\n        if (gameMove.color === 'w') {\n            // White captures black pawn one rank below\n            return file + (rank - 1);\n        } \n            // Black captures white pawn one rank above\n            return file + (rank + 1);\n        \n    }\n\n    /**\n     * Clears the moves cache\n     */\n    clearCache() {\n        this._movesCache.clear();\n        if (this._cacheTimeout) {\n            clearTimeout(this._cacheTimeout);\n            this._cacheTimeout = null;\n        }\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        this.clearCache();\n        this.positionService = null;\n    }\n}\n","/**\n * Service for managing chess pieces and their operations\n * @module services/PieceService\n * @since 2.0.0\n */\n\nimport Piece from '../components/Piece.js';\nimport { PieceError, ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\nimport { PIECE_TYPES, PIECE_COLORS } from '../constants/positions.js';\nimport { DragOptimizations } from '../utils/cross-browser.js';\n\n/**\n * Service responsible for piece management and operations\n * @class\n */\nexport class PieceService {\n    /**\n     * Creates a new PieceService instance\n     * @param {ChessboardConfig} config - Board configuration\n     */\n    constructor(config) {\n        this.config = config;\n    }\n\n    /**\n     * Gets the path to a piece asset\n     * @param {string} piece - Piece identifier (e.g., 'wK', 'bP')\n     * @returns {string} Path to piece asset\n     * @throws {ValidationError} When piecesPath configuration is invalid\n     */\n    getPiecePath(piece) {\n        const { piecesPath } = this.config;\n\n        if (typeof piecesPath === 'string') {\n            return `${piecesPath}/${piece}.svg`;\n        } else if (typeof piecesPath === 'object' && piecesPath !== null) {\n            return piecesPath[piece];\n        } else if (typeof piecesPath === 'function') {\n            return piecesPath(piece);\n        } \n            throw new ValidationError(ERROR_MESSAGES.invalid_piecesPath, 'piecesPath', piecesPath);\n        \n    }\n\n    /**\n     * Converts various piece formats to a Piece instance\n     * @param {string|Piece} piece - Piece in various formats\n     * @returns {Piece} Piece instance\n     * @throws {PieceError} When piece format is invalid\n     */\n    convertPiece(piece) {\n        if (piece instanceof Piece) {\n            return piece;\n        }\n\n        if (typeof piece === 'string' && piece.length === 2) {\n            const [first, second] = piece.split('');\n            let type, color;\n\n            // Check format: [type][color] (e.g., 'pw')\n            if (PIECE_TYPES.includes(first.toLowerCase()) && PIECE_COLORS.includes(second)) {\n                type = first.toLowerCase();\n                color = second;\n            }\n            // Check format: [color][type] (e.g., 'wP')\n            else if (PIECE_COLORS.includes(first) && PIECE_TYPES.includes(second.toLowerCase())) {\n                color = first;\n                type = second.toLowerCase();\n            } else {\n                throw new PieceError(ERROR_MESSAGES.invalid_piece + piece, piece);\n            }\n\n            const piecePath = this.getPiecePath(type + color);\n            return new Piece(color, type, piecePath);\n        }\n\n        throw new PieceError(ERROR_MESSAGES.invalid_piece + piece, piece);\n    }\n\n    /**\n     * Adds a piece to a square with optional fade-in animation\n     * @param {Square} square - Target square\n     * @param {Piece} piece - Piece to add\n     * @param {boolean} [fade=true] - Whether to fade in the piece\n     * @param {Function} dragFunction - Function to handle drag events\n     * @param {Function} [callback] - Callback when animation completes\n     */\n    addPieceOnSquare(square, piece, fade = true, dragFunction, callback) {\n        console.debug(`[PieceService] addPieceOnSquare: ${piece.id} to ${square.id}`);\n        square.putPiece(piece);\n\n        if (dragFunction) {\n            piece.setDrag(dragFunction(square, piece));\n        }\n\n        if (fade && this.config.fadeTime > 0) {\n            piece.fadeIn(\n                this.config.fadeTime,\n                this.config.fadeAnimation,\n                this._getTransitionTimingFunction(),\n                callback\n            );\n        } else {\n            if (callback) callback();\n        }\n\n        piece.visible();\n    }\n\n    /**\n     * Removes a piece from a square with optional fade-out animation\n     * @param {Square} square - Source square\n     * @param {boolean} [fade=true] - Whether to fade out the piece\n     * @param {Function} [callback] - Callback when animation completes\n     * @returns {Piece} The removed piece\n     * @throws {PieceError} When square has no piece to remove\n     */\n    removePieceFromSquare(square, fade = true, callback) {\n        console.debug(`[PieceService] removePieceFromSquare: ${square.id}`);\n        square.check();\n\n        const piece = square.piece;\n        if (!piece) {\n            if (callback) callback();\n            throw new PieceError(ERROR_MESSAGES.square_no_piece, null, square.getId());\n        }\n\n        if (fade && this.config.fadeTime > 0) {\n            piece.fadeOut(\n                this.config.fadeTime,\n                this.config.fadeAnimation,\n                this._getTransitionTimingFunction(),\n                callback\n            );\n        } else {\n            if (callback) callback();\n        }\n\n        square.removePiece();\n        return piece;\n    }\n\n    /**\n     * Moves a piece to a new position with animation\n     * @param {Piece} piece - Piece to move\n     * @param {Square} targetSquare - Target square\n     * @param {number} duration - Animation duration\n     * @param {Function} [callback] - Callback function when animation completes\n     */\n    movePiece(piece, targetSquare, duration, callback) {\n        console.debug(`[PieceService] movePiece: ${piece.id} to ${targetSquare.id}`);\n        if (!piece) {\n            console.warn('PieceService.movePiece: piece is null, skipping animation');\n            if (callback) callback();\n            return;\n        }\n\n        piece.translate(\n            targetSquare,\n            duration,\n            this._getTransitionTimingFunction(),\n            this.config.moveAnimation,\n            callback\n        );\n    }\n\n    /**\n     * Handles piece translation with optional capture\n     * @param {Move} move - Move object containing from/to squares and piece\n     * @param {boolean} removeTarget - Whether to remove piece from target square\n     * @param {boolean} animate - Whether to animate the move\n     * @param {Function} [dragFunction] - Function to create drag handlers\n     * @param {Function} [callback] - Callback function when complete\n     */\n    translatePiece(move, removeTarget, animate, dragFunction = null, callback = null) {\n        console.debug(`[PieceService] translatePiece: ${move.piece.id} from ${move.from.id} to ${move.to.id}`);\n        if (!move.piece) {\n            console.warn('PieceService.translatePiece: move.piece is null, skipping translation');\n            if (callback) callback();\n            return;\n        }\n\n        if (removeTarget) {\n            // Deselect the captured piece before removing it\n            move.to.deselect();\n            this.removePieceFromSquare(move.to, false);\n        }\n\n        const changeSquareCallback = () => {\n            // Check if piece still exists and is on the source square\n            if (move.from.piece === move.piece) {\n                move.from.removePiece(true); // Preserve the piece when moving\n            }\n\n            // Only put piece if destination square doesn't already have it\n            if (move.to.piece !== move.piece) {\n                move.to.putPiece(move.piece);\n\n                // Re-attach drag handler if provided\n                if (dragFunction && this.config.draggable && move.piece.element) {\n                    move.piece.setDrag(dragFunction(move.to, move.piece));\n                }\n            }\n\n            if (callback) callback();\n        };\n\n        // Check if piece is currently being dragged\n        const isDragging = move.piece.element.classList.contains('dragging');\n\n        if (isDragging) {\n            // If piece is being dragged, don't animate - just move it immediately\n            // The piece is already visually in the correct position from the drag\n            changeSquareCallback();\n        } else {\n            // Normal animation\n            const duration = animate ? this.config.moveTime : 0;\n            this.movePiece(move.piece, move.to, duration, changeSquareCallback);\n        }\n    }\n\n    /**\n     * Snaps a piece back to its original position\n     * @param {Square} square - Square containing the piece\n     * @param {boolean} [animate=true] - Whether to animate the snapback\n     */\n    snapbackPiece(square, animate = true) {\n        if (!square || !square.piece) {\n            return;\n        }\n        const piece = square.piece;\n        const duration = animate ? this.config.snapbackTime : 0;\n        console.debug(`[PieceService] snapbackPiece: ${piece.id} on ${square.id}`);\n        piece.translate(\n            square,\n            duration,\n            this._getTransitionTimingFunction(),\n            this.config.snapbackAnimation\n        );\n    }\n\n    /**\n     * Centers a piece in its square with animation (after successful drop)\n     * @param {Square} square - Square containing the piece to center\n     * @param {boolean} animate - Whether to animate the centering\n     */\n    centerPiece(square, animate = true) {\n        if (!square || !square.piece) {\n            return;\n        }\n        const piece = square.piece;\n        const duration = animate ? this.config.dropCenterTime : 0;\n        console.debug(`[PieceService] centerPiece: ${piece.id} on ${square.id}`);\n        piece.translate(\n            square,\n            duration,\n            this._getTransitionTimingFunction(),\n            this.config.dropCenterAnimation,\n            () => {\n                // After animation, reset all drag-related styles\n                if (!piece.element) return;\n                piece.element.style.position = '';\n                piece.element.style.left = '';\n                piece.element.style.top = '';\n                piece.element.style.transform = '';\n                piece.element.style.zIndex = '';\n                // Remove inline dimensions set during drag\n                piece.element.style.width = '';\n                piece.element.style.height = '';\n                // Remove dragging class\n                piece.element.classList.remove('dragging');\n                \n                // Clean up drag optimizations that might interfere with click\n                DragOptimizations.cleanupAfterDrag(piece.element);\n            }\n        );\n    }\n\n    /**\n     * Gets the transition timing function for animations\n     * @private\n     * @returns {Function} Timing function\n     */\n    _getTransitionTimingFunction() {\n        return (elapsed, duration, type = 'ease') => {\n            const x = elapsed / duration;\n\n            switch (type) {\n                case 'linear':\n                    return x;\n                case 'ease':\n                    return (x ** 2) * (3 - 2 * x);\n                case 'ease-in':\n                    return x ** 2;\n                case 'ease-out':\n                    return -1 * (x - 1) ** 2 + 1;\n                case 'ease-in-out':\n                    return (x < 0.5) ? 2 * x ** 2 : 4 * x - 2 * x ** 2 - 1;\n                default:\n                    return x;\n            }\n        };\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        // Cleanup any cached pieces or references\n    }\n}\n","/**\n * @license\n * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions are met:\n *\n * 1. Redistributions of source code must retain the above copyright notice,\n *    this list of conditions and the following disclaimer.\n * 2. Redistributions in binary form must reproduce the above copyright notice,\n *    this list of conditions and the following disclaimer in the documentation\n *    and/or other materials provided with the distribution.\n *\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\"\n * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\n * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE\n * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR\n * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF\n * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS\n * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\n * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n */\nexport const WHITE = 'w';\nexport const BLACK = 'b';\nexport const PAWN = 'p';\nexport const KNIGHT = 'n';\nexport const BISHOP = 'b';\nexport const ROOK = 'r';\nexport const QUEEN = 'q';\nexport const KING = 'k';\nexport const DEFAULT_POSITION = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';\nexport class Move {\n    color;\n    from;\n    to;\n    piece;\n    captured;\n    promotion;\n    /**\n     * @deprecated This field is deprecated and will be removed in version 2.0.0.\n     * Please use move descriptor functions instead: `isCapture`, `isPromotion`,\n     * `isEnPassant`, `isKingsideCastle`, `isQueensideCastle`, `isCastle`, and\n     * `isBigPawn`\n     */\n    flags;\n    san;\n    lan;\n    before;\n    after;\n    constructor(chess, internal) {\n        const { color, piece, from, to, flags, captured, promotion } = internal;\n        const fromAlgebraic = algebraic(from);\n        const toAlgebraic = algebraic(to);\n        this.color = color;\n        this.piece = piece;\n        this.from = fromAlgebraic;\n        this.to = toAlgebraic;\n        /*\n         * HACK: The chess['_method']() calls below invoke private methods in the\n         * Chess class to generate SAN and FEN. It's a bit of a hack, but makes the\n         * code cleaner elsewhere.\n         */\n        this.san = chess['_moveToSan'](internal, chess['_moves']({ legal: true }));\n        this.lan = fromAlgebraic + toAlgebraic;\n        this.before = chess.fen();\n        // Generate the FEN for the 'after' key\n        chess['_makeMove'](internal);\n        this.after = chess.fen();\n        chess['_undoMove']();\n        // Build the text representation of the move flags\n        this.flags = '';\n        for (const flag in BITS) {\n            if (BITS[flag] & flags) {\n                this.flags += FLAGS[flag];\n            }\n        }\n        if (captured) {\n            this.captured = captured;\n        }\n        if (promotion) {\n            this.promotion = promotion;\n            this.lan += promotion;\n        }\n    }\n    isCapture() {\n        return this.flags.indexOf(FLAGS['CAPTURE']) > -1;\n    }\n    isPromotion() {\n        return this.flags.indexOf(FLAGS['PROMOTION']) > -1;\n    }\n    isEnPassant() {\n        return this.flags.indexOf(FLAGS['EP_CAPTURE']) > -1;\n    }\n    isKingsideCastle() {\n        return this.flags.indexOf(FLAGS['KSIDE_CASTLE']) > -1;\n    }\n    isQueensideCastle() {\n        return this.flags.indexOf(FLAGS['QSIDE_CASTLE']) > -1;\n    }\n    isBigPawn() {\n        return this.flags.indexOf(FLAGS['BIG_PAWN']) > -1;\n    }\n}\nconst EMPTY = -1;\nconst FLAGS = {\n    NORMAL: 'n',\n    CAPTURE: 'c',\n    BIG_PAWN: 'b',\n    EP_CAPTURE: 'e',\n    PROMOTION: 'p',\n    KSIDE_CASTLE: 'k',\n    QSIDE_CASTLE: 'q',\n};\n// prettier-ignore\nexport const SQUARES = [\n    'a8', 'b8', 'c8', 'd8', 'e8', 'f8', 'g8', 'h8',\n    'a7', 'b7', 'c7', 'd7', 'e7', 'f7', 'g7', 'h7',\n    'a6', 'b6', 'c6', 'd6', 'e6', 'f6', 'g6', 'h6',\n    'a5', 'b5', 'c5', 'd5', 'e5', 'f5', 'g5', 'h5',\n    'a4', 'b4', 'c4', 'd4', 'e4', 'f4', 'g4', 'h4',\n    'a3', 'b3', 'c3', 'd3', 'e3', 'f3', 'g3', 'h3',\n    'a2', 'b2', 'c2', 'd2', 'e2', 'f2', 'g2', 'h2',\n    'a1', 'b1', 'c1', 'd1', 'e1', 'f1', 'g1', 'h1'\n];\nconst BITS = {\n    NORMAL: 1,\n    CAPTURE: 2,\n    BIG_PAWN: 4,\n    EP_CAPTURE: 8,\n    PROMOTION: 16,\n    KSIDE_CASTLE: 32,\n    QSIDE_CASTLE: 64,\n};\n/*\n * NOTES ABOUT 0x88 MOVE GENERATION ALGORITHM\n * ----------------------------------------------------------------------------\n * From https://github.com/jhlywa/chess.js/issues/230\n *\n * A lot of people are confused when they first see the internal representation\n * of chess.js. It uses the 0x88 Move Generation Algorithm which internally\n * stores the board as an 8x16 array. This is purely for efficiency but has a\n * couple of interesting benefits:\n *\n * 1. 0x88 offers a very inexpensive \"off the board\" check. Bitwise AND (&) any\n *    square with 0x88, if the result is non-zero then the square is off the\n *    board. For example, assuming a knight square A8 (0 in 0x88 notation),\n *    there are 8 possible directions in which the knight can move. These\n *    directions are relative to the 8x16 board and are stored in the\n *    PIECE_OFFSETS map. One possible move is A8 - 18 (up one square, and two\n *    squares to the left - which is off the board). 0 - 18 = -18 & 0x88 = 0x88\n *    (because of two-complement representation of -18). The non-zero result\n *    means the square is off the board and the move is illegal. Take the\n *    opposite move (from A8 to C7), 0 + 18 = 18 & 0x88 = 0. A result of zero\n *    means the square is on the board.\n *\n * 2. The relative distance (or difference) between two squares on a 8x16 board\n *    is unique and can be used to inexpensively determine if a piece on a\n *    square can attack any other arbitrary square. For example, let's see if a\n *    pawn on E7 can attack E2. The difference between E7 (20) - E2 (100) is\n *    -80. We add 119 to make the ATTACKS array index non-negative (because the\n *    worst case difference is A8 - H1 = -119). The ATTACKS array contains a\n *    bitmask of pieces that can attack from that distance and direction.\n *    ATTACKS[-80 + 119=39] gives us 24 or 0b11000 in binary. Look at the\n *    PIECE_MASKS map to determine the mask for a given piece type. In our pawn\n *    example, we would check to see if 24 & 0x1 is non-zero, which it is\n *    not. So, naturally, a pawn on E7 can't attack a piece on E2. However, a\n *    rook can since 24 & 0x8 is non-zero. The only thing left to check is that\n *    there are no blocking pieces between E7 and E2. That's where the RAYS\n *    array comes in. It provides an offset (in this case 16) to add to E7 (20)\n *    to check for blocking pieces. E7 (20) + 16 = E6 (36) + 16 = E5 (52) etc.\n */\n// prettier-ignore\n \nconst Ox88 = {\n    a8: 0, b8: 1, c8: 2, d8: 3, e8: 4, f8: 5, g8: 6, h8: 7,\n    a7: 16, b7: 17, c7: 18, d7: 19, e7: 20, f7: 21, g7: 22, h7: 23,\n    a6: 32, b6: 33, c6: 34, d6: 35, e6: 36, f6: 37, g6: 38, h6: 39,\n    a5: 48, b5: 49, c5: 50, d5: 51, e5: 52, f5: 53, g5: 54, h5: 55,\n    a4: 64, b4: 65, c4: 66, d4: 67, e4: 68, f4: 69, g4: 70, h4: 71,\n    a3: 80, b3: 81, c3: 82, d3: 83, e3: 84, f3: 85, g3: 86, h3: 87,\n    a2: 96, b2: 97, c2: 98, d2: 99, e2: 100, f2: 101, g2: 102, h2: 103,\n    a1: 112, b1: 113, c1: 114, d1: 115, e1: 116, f1: 117, g1: 118, h1: 119\n};\nconst PAWN_OFFSETS = {\n    b: [16, 32, 17, 15],\n    w: [-16, -32, -17, -15],\n};\nconst PIECE_OFFSETS = {\n    n: [-18, -33, -31, -14, 18, 33, 31, 14],\n    b: [-17, -15, 17, 15],\n    r: [-16, 1, 16, -1],\n    q: [-17, -16, -15, 1, 17, 16, 15, -1],\n    k: [-17, -16, -15, 1, 17, 16, 15, -1],\n};\n// prettier-ignore\nconst ATTACKS = [\n    20, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 20, 0,\n    0, 20, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 20, 0, 0,\n    0, 0, 20, 0, 0, 0, 0, 24, 0, 0, 0, 0, 20, 0, 0, 0,\n    0, 0, 0, 20, 0, 0, 0, 24, 0, 0, 0, 20, 0, 0, 0, 0,\n    0, 0, 0, 0, 20, 0, 0, 24, 0, 0, 20, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 20, 2, 24, 2, 20, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 2, 53, 56, 53, 2, 0, 0, 0, 0, 0, 0,\n    24, 24, 24, 24, 24, 24, 56, 0, 56, 24, 24, 24, 24, 24, 24, 0,\n    0, 0, 0, 0, 0, 2, 53, 56, 53, 2, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 20, 2, 24, 2, 20, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 20, 0, 0, 24, 0, 0, 20, 0, 0, 0, 0, 0,\n    0, 0, 0, 20, 0, 0, 0, 24, 0, 0, 0, 20, 0, 0, 0, 0,\n    0, 0, 20, 0, 0, 0, 0, 24, 0, 0, 0, 0, 20, 0, 0, 0,\n    0, 20, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 20, 0, 0,\n    20, 0, 0, 0, 0, 0, 0, 24, 0, 0, 0, 0, 0, 0, 20\n];\n// prettier-ignore\nconst RAYS = [\n    17, 0, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 0, 15, 0,\n    0, 17, 0, 0, 0, 0, 0, 16, 0, 0, 0, 0, 0, 15, 0, 0,\n    0, 0, 17, 0, 0, 0, 0, 16, 0, 0, 0, 0, 15, 0, 0, 0,\n    0, 0, 0, 17, 0, 0, 0, 16, 0, 0, 0, 15, 0, 0, 0, 0,\n    0, 0, 0, 0, 17, 0, 0, 16, 0, 0, 15, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 17, 0, 16, 0, 15, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, 0, 17, 16, 15, 0, 0, 0, 0, 0, 0, 0,\n    1, 1, 1, 1, 1, 1, 1, 0, -1, -1, -1, -1, -1, -1, -1, 0,\n    0, 0, 0, 0, 0, 0, -15, -16, -17, 0, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, 0, -15, 0, -16, 0, -17, 0, 0, 0, 0, 0, 0,\n    0, 0, 0, 0, -15, 0, 0, -16, 0, 0, -17, 0, 0, 0, 0, 0,\n    0, 0, 0, -15, 0, 0, 0, -16, 0, 0, 0, -17, 0, 0, 0, 0,\n    0, 0, -15, 0, 0, 0, 0, -16, 0, 0, 0, 0, -17, 0, 0, 0,\n    0, -15, 0, 0, 0, 0, 0, -16, 0, 0, 0, 0, 0, -17, 0, 0,\n    -15, 0, 0, 0, 0, 0, 0, -16, 0, 0, 0, 0, 0, 0, -17\n];\nconst PIECE_MASKS = { p: 0x1, n: 0x2, b: 0x4, r: 0x8, q: 0x10, k: 0x20 };\nconst SYMBOLS = 'pnbrqkPNBRQK';\nconst PROMOTIONS = [KNIGHT, BISHOP, ROOK, QUEEN];\nconst RANK_1 = 7;\nconst RANK_2 = 6;\n/*\n * const RANK_3 = 5\n * const RANK_4 = 4\n * const RANK_5 = 3\n * const RANK_6 = 2\n */\nconst RANK_7 = 1;\nconst RANK_8 = 0;\nconst SIDES = {\n    [KING]: BITS.KSIDE_CASTLE,\n    [QUEEN]: BITS.QSIDE_CASTLE,\n};\nconst ROOKS = {\n    w: [\n        { square: Ox88.a1, flag: BITS.QSIDE_CASTLE },\n        { square: Ox88.h1, flag: BITS.KSIDE_CASTLE },\n    ],\n    b: [\n        { square: Ox88.a8, flag: BITS.QSIDE_CASTLE },\n        { square: Ox88.h8, flag: BITS.KSIDE_CASTLE },\n    ],\n};\nconst SECOND_RANK = { b: RANK_7, w: RANK_2 };\nconst TERMINATION_MARKERS = ['1-0', '0-1', '1/2-1/2', '*'];\n// Extracts the zero-based rank of an 0x88 square.\nfunction rank(square) {\n    return square >> 4;\n}\n// Extracts the zero-based file of an 0x88 square.\nfunction file(square) {\n    return square & 0xf;\n}\nfunction isDigit(c) {\n    return '0123456789'.indexOf(c) !== -1;\n}\n// Converts a 0x88 square to algebraic notation.\nfunction algebraic(square) {\n    const f = file(square);\n    const r = rank(square);\n    return ('abcdefgh'.substring(f, f + 1) +\n        '87654321'.substring(r, r + 1));\n}\nfunction swapColor(color) {\n    return color === WHITE ? BLACK : WHITE;\n}\nexport function validateFen(fen) {\n    // 1st criterion: 6 space-seperated fields?\n    const tokens = fen.split(/\\s+/);\n    if (tokens.length !== 6) {\n        return {\n            ok: false,\n            error: 'Invalid FEN: must contain six space-delimited fields',\n        };\n    }\n    // 2nd criterion: move number field is a integer value > 0?\n    const moveNumber = parseInt(tokens[5], 10);\n    if (isNaN(moveNumber) || moveNumber <= 0) {\n        return {\n            ok: false,\n            error: 'Invalid FEN: move number must be a positive integer',\n        };\n    }\n    // 3rd criterion: half move counter is an integer >= 0?\n    const halfMoves = parseInt(tokens[4], 10);\n    if (isNaN(halfMoves) || halfMoves < 0) {\n        return {\n            ok: false,\n            error: 'Invalid FEN: half move counter number must be a non-negative integer',\n        };\n    }\n    // 4th criterion: 4th field is a valid e.p.-string?\n    if (!/^(-|[abcdefgh][36])$/.test(tokens[3])) {\n        return { ok: false, error: 'Invalid FEN: en-passant square is invalid' };\n    }\n    // 5th criterion: 3th field is a valid castle-string?\n    if (/[^kKqQ-]/.test(tokens[2])) {\n        return { ok: false, error: 'Invalid FEN: castling availability is invalid' };\n    }\n    // 6th criterion: 2nd field is \"w\" (white) or \"b\" (black)?\n    if (!/^(w|b)$/.test(tokens[1])) {\n        return { ok: false, error: 'Invalid FEN: side-to-move is invalid' };\n    }\n    // 7th criterion: 1st field contains 8 rows?\n    const rows = tokens[0].split('/');\n    if (rows.length !== 8) {\n        return {\n            ok: false,\n            error: \"Invalid FEN: piece data does not contain 8 '/'-delimited rows\",\n        };\n    }\n    // 8th criterion: every row is valid?\n    for (let i = 0; i < rows.length; i++) {\n        // check for right sum of fields AND not two numbers in succession\n        let sumFields = 0;\n        let previousWasNumber = false;\n        for (let k = 0; k < rows[i].length; k++) {\n            if (isDigit(rows[i][k])) {\n                if (previousWasNumber) {\n                    return {\n                        ok: false,\n                        error: 'Invalid FEN: piece data is invalid (consecutive number)',\n                    };\n                }\n                sumFields += parseInt(rows[i][k], 10);\n                previousWasNumber = true;\n            }\n            else {\n                if (!/^[prnbqkPRNBQK]$/.test(rows[i][k])) {\n                    return {\n                        ok: false,\n                        error: 'Invalid FEN: piece data is invalid (invalid piece)',\n                    };\n                }\n                sumFields += 1;\n                previousWasNumber = false;\n            }\n        }\n        if (sumFields !== 8) {\n            return {\n                ok: false,\n                error: 'Invalid FEN: piece data is invalid (too many squares in rank)',\n            };\n        }\n    }\n    // 9th criterion: is en-passant square legal?\n    if ((tokens[3][1] == '3' && tokens[1] == 'w') ||\n        (tokens[3][1] == '6' && tokens[1] == 'b')) {\n        return { ok: false, error: 'Invalid FEN: illegal en-passant square' };\n    }\n    // 10th criterion: does chess position contain exact two kings?\n    const kings = [\n        { color: 'white', regex: /K/g },\n        { color: 'black', regex: /k/g },\n    ];\n    for (const { color, regex } of kings) {\n        if (!regex.test(tokens[0])) {\n            return { ok: false, error: `Invalid FEN: missing ${color} king` };\n        }\n        if ((tokens[0].match(regex) || []).length > 1) {\n            return { ok: false, error: `Invalid FEN: too many ${color} kings` };\n        }\n    }\n    // 11th criterion: are any pawns on the first or eighth rows?\n    if (Array.from(rows[0] + rows[7]).some((char) => char.toUpperCase() === 'P')) {\n        return {\n            ok: false,\n            error: 'Invalid FEN: some pawns are on the edge rows',\n        };\n    }\n    return { ok: true };\n}\n// this function is used to uniquely identify ambiguous moves\nfunction getDisambiguator(move, moves) {\n    const from = move.from;\n    const to = move.to;\n    const piece = move.piece;\n    let ambiguities = 0;\n    let sameRank = 0;\n    let sameFile = 0;\n    for (let i = 0, len = moves.length; i < len; i++) {\n        const ambigFrom = moves[i].from;\n        const ambigTo = moves[i].to;\n        const ambigPiece = moves[i].piece;\n        /*\n         * if a move of the same piece type ends on the same to square, we'll need\n         * to add a disambiguator to the algebraic notation\n         */\n        if (piece === ambigPiece && from !== ambigFrom && to === ambigTo) {\n            ambiguities++;\n            if (rank(from) === rank(ambigFrom)) {\n                sameRank++;\n            }\n            if (file(from) === file(ambigFrom)) {\n                sameFile++;\n            }\n        }\n    }\n    if (ambiguities > 0) {\n        if (sameRank > 0 && sameFile > 0) {\n            /*\n             * if there exists a similar moving piece on the same rank and file as\n             * the move in question, use the square as the disambiguator\n             */\n            return algebraic(from);\n        }\n        else if (sameFile > 0) {\n            /*\n             * if the moving piece rests on the same file, use the rank symbol as the\n             * disambiguator\n             */\n            return algebraic(from).charAt(1);\n        }\n        \n            // else use the file symbol\n            return algebraic(from).charAt(0);\n        \n    }\n    return '';\n}\nfunction addMove(moves, color, from, to, piece, captured = undefined, flags = BITS.NORMAL) {\n    const r = rank(to);\n    if (piece === PAWN && (r === RANK_1 || r === RANK_8)) {\n        for (let i = 0; i < PROMOTIONS.length; i++) {\n            const promotion = PROMOTIONS[i];\n            moves.push({\n                color,\n                from,\n                to,\n                piece,\n                captured,\n                promotion,\n                flags: flags | BITS.PROMOTION,\n            });\n        }\n    }\n    else {\n        moves.push({\n            color,\n            from,\n            to,\n            piece,\n            captured,\n            flags,\n        });\n    }\n}\nfunction inferPieceType(san) {\n    let pieceType = san.charAt(0);\n    if (pieceType >= 'a' && pieceType <= 'h') {\n        const matches = san.match(/[a-h]\\d.*[a-h]\\d/);\n        if (matches) {\n            return undefined;\n        }\n        return PAWN;\n    }\n    pieceType = pieceType.toLowerCase();\n    if (pieceType === 'o') {\n        return KING;\n    }\n    return pieceType;\n}\n// parses all of the decorators out of a SAN string\nfunction strippedSan(move) {\n    return move.replace(/=/, '').replace(/[+#]?[?!]*$/, '');\n}\nfunction trimFen(fen) {\n    /*\n     * remove last two fields in FEN string as they're not needed when checking\n     * for repetition\n     */\n    return fen.split(' ').slice(0, 4).join(' ');\n}\nexport class Chess {\n    _board = new Array(128);\n    _turn = WHITE;\n    _header = {};\n    _kings = { w: EMPTY, b: EMPTY };\n    _epSquare = -1;\n    _halfMoves = 0;\n    _moveNumber = 0;\n    _history = [];\n    _comments = {};\n    _castling = { w: 0, b: 0 };\n    // tracks number of times a position has been seen for repetition checking\n    _positionCount = {};\n    constructor(fen = DEFAULT_POSITION) {\n        this.load(fen);\n    }\n    clear({ preserveHeaders = false } = {}) {\n        this._board = new Array(128);\n        this._kings = { w: EMPTY, b: EMPTY };\n        this._turn = WHITE;\n        this._castling = { w: 0, b: 0 };\n        this._epSquare = EMPTY;\n        this._halfMoves = 0;\n        this._moveNumber = 1;\n        this._history = [];\n        this._comments = {};\n        this._header = preserveHeaders ? this._header : {};\n        this._positionCount = {};\n        /*\n         * Delete the SetUp and FEN headers (if preserved), the board is empty and\n         * these headers don't make sense in this state. They'll get added later\n         * via .load() or .put()\n         */\n        delete this._header['SetUp'];\n        delete this._header['FEN'];\n    }\n    load(fen, { skipValidation = false, preserveHeaders = false } = {}) {\n        let tokens = fen.split(/\\s+/);\n        // append commonly omitted fen tokens\n        if (tokens.length >= 2 && tokens.length < 6) {\n            const adjustments = ['-', '-', '0', '1'];\n            fen = tokens.concat(adjustments.slice(-(6 - tokens.length))).join(' ');\n        }\n        tokens = fen.split(/\\s+/);\n        if (!skipValidation) {\n            const { ok, error } = validateFen(fen);\n            if (!ok) {\n                throw new Error(error);\n            }\n        }\n        const position = tokens[0];\n        let square = 0;\n        this.clear({ preserveHeaders });\n        for (let i = 0; i < position.length; i++) {\n            const piece = position.charAt(i);\n            if (piece === '/') {\n                square += 8;\n            }\n            else if (isDigit(piece)) {\n                square += parseInt(piece, 10);\n            }\n            else {\n                const color = piece < 'a' ? WHITE : BLACK;\n                this._put({ type: piece.toLowerCase(), color }, algebraic(square));\n                square++;\n            }\n        }\n        this._turn = tokens[1];\n        if (tokens[2].indexOf('K') > -1) {\n            this._castling.w |= BITS.KSIDE_CASTLE;\n        }\n        if (tokens[2].indexOf('Q') > -1) {\n            this._castling.w |= BITS.QSIDE_CASTLE;\n        }\n        if (tokens[2].indexOf('k') > -1) {\n            this._castling.b |= BITS.KSIDE_CASTLE;\n        }\n        if (tokens[2].indexOf('q') > -1) {\n            this._castling.b |= BITS.QSIDE_CASTLE;\n        }\n        this._epSquare = tokens[3] === '-' ? EMPTY : Ox88[tokens[3]];\n        this._halfMoves = parseInt(tokens[4], 10);\n        this._moveNumber = parseInt(tokens[5], 10);\n        this._updateSetup(fen);\n        this._incPositionCount(fen);\n    }\n    fen() {\n        let empty = 0;\n        let fen = '';\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            if (this._board[i]) {\n                if (empty > 0) {\n                    fen += empty;\n                    empty = 0;\n                }\n                const { color, type: piece } = this._board[i];\n                fen += color === WHITE ? piece.toUpperCase() : piece.toLowerCase();\n            }\n            else {\n                empty++;\n            }\n            if ((i + 1) & 0x88) {\n                if (empty > 0) {\n                    fen += empty;\n                }\n                if (i !== Ox88.h1) {\n                    fen += '/';\n                }\n                empty = 0;\n                i += 8;\n            }\n        }\n        let castling = '';\n        if (this._castling[WHITE] & BITS.KSIDE_CASTLE) {\n            castling += 'K';\n        }\n        if (this._castling[WHITE] & BITS.QSIDE_CASTLE) {\n            castling += 'Q';\n        }\n        if (this._castling[BLACK] & BITS.KSIDE_CASTLE) {\n            castling += 'k';\n        }\n        if (this._castling[BLACK] & BITS.QSIDE_CASTLE) {\n            castling += 'q';\n        }\n        // do we have an empty castling flag?\n        castling = castling || '-';\n        let epSquare = '-';\n        /*\n         * only print the ep square if en passant is a valid move (pawn is present\n         * and ep capture is not pinned)\n         */\n        if (this._epSquare !== EMPTY) {\n            const bigPawnSquare = this._epSquare + (this._turn === WHITE ? 16 : -16);\n            const squares = [bigPawnSquare + 1, bigPawnSquare - 1];\n            for (const square of squares) {\n                // is the square off the board?\n                if (square & 0x88) {\n                    continue;\n                }\n                const color = this._turn;\n                // is there a pawn that can capture the epSquare?\n                if (this._board[square]?.color === color &&\n                    this._board[square]?.type === PAWN) {\n                    // if the pawn makes an ep capture, does it leave it's king in check?\n                    this._makeMove({\n                        color,\n                        from: square,\n                        to: this._epSquare,\n                        piece: PAWN,\n                        captured: PAWN,\n                        flags: BITS.EP_CAPTURE,\n                    });\n                    const isLegal = !this._isKingAttacked(color);\n                    this._undoMove();\n                    // if ep is legal, break and set the ep square in the FEN output\n                    if (isLegal) {\n                        epSquare = algebraic(this._epSquare);\n                        break;\n                    }\n                }\n            }\n        }\n        return [\n            fen,\n            this._turn,\n            castling,\n            epSquare,\n            this._halfMoves,\n            this._moveNumber,\n        ].join(' ');\n    }\n    /*\n     * Called when the initial board setup is changed with put() or remove().\n     * modifies the SetUp and FEN properties of the header object. If the FEN\n     * is equal to the default position, the SetUp and FEN are deleted the setup\n     * is only updated if history.length is zero, ie moves haven't been made.\n     */\n    _updateSetup(fen) {\n        if (this._history.length > 0)\n            return;\n        if (fen !== DEFAULT_POSITION) {\n            this._header['SetUp'] = '1';\n            this._header['FEN'] = fen;\n        }\n        else {\n            delete this._header['SetUp'];\n            delete this._header['FEN'];\n        }\n    }\n    reset() {\n        this.load(DEFAULT_POSITION);\n    }\n    get(square) {\n        return this._board[Ox88[square]];\n    }\n    put({ type, color }, square) {\n        if (this._put({ type, color }, square)) {\n            this._updateCastlingRights();\n            this._updateEnPassantSquare();\n            this._updateSetup(this.fen());\n            return true;\n        }\n        return false;\n    }\n    _put({ type, color }, square) {\n        // check for piece\n        if (SYMBOLS.indexOf(type.toLowerCase()) === -1) {\n            return false;\n        }\n        // check for valid square\n        if (!(square in Ox88)) {\n            return false;\n        }\n        const sq = Ox88[square];\n        // don't let the user place more than one king\n        if (type == KING &&\n            !(this._kings[color] == EMPTY || this._kings[color] == sq)) {\n            return false;\n        }\n        const currentPieceOnSquare = this._board[sq];\n        // if one of the kings will be replaced by the piece from args, set the `_kings` respective entry to `EMPTY`\n        if (currentPieceOnSquare && currentPieceOnSquare.type === KING) {\n            this._kings[currentPieceOnSquare.color] = EMPTY;\n        }\n        this._board[sq] = { type, color };\n        if (type === KING) {\n            this._kings[color] = sq;\n        }\n        return true;\n    }\n    remove(square) {\n        const piece = this.get(square);\n        delete this._board[Ox88[square]];\n        if (piece && piece.type === KING) {\n            this._kings[piece.color] = EMPTY;\n        }\n        this._updateCastlingRights();\n        this._updateEnPassantSquare();\n        this._updateSetup(this.fen());\n        return piece;\n    }\n    _updateCastlingRights() {\n        const whiteKingInPlace = this._board[Ox88.e1]?.type === KING &&\n            this._board[Ox88.e1]?.color === WHITE;\n        const blackKingInPlace = this._board[Ox88.e8]?.type === KING &&\n            this._board[Ox88.e8]?.color === BLACK;\n        if (!whiteKingInPlace ||\n            this._board[Ox88.a1]?.type !== ROOK ||\n            this._board[Ox88.a1]?.color !== WHITE) {\n            this._castling.w &= ~BITS.QSIDE_CASTLE;\n        }\n        if (!whiteKingInPlace ||\n            this._board[Ox88.h1]?.type !== ROOK ||\n            this._board[Ox88.h1]?.color !== WHITE) {\n            this._castling.w &= ~BITS.KSIDE_CASTLE;\n        }\n        if (!blackKingInPlace ||\n            this._board[Ox88.a8]?.type !== ROOK ||\n            this._board[Ox88.a8]?.color !== BLACK) {\n            this._castling.b &= ~BITS.QSIDE_CASTLE;\n        }\n        if (!blackKingInPlace ||\n            this._board[Ox88.h8]?.type !== ROOK ||\n            this._board[Ox88.h8]?.color !== BLACK) {\n            this._castling.b &= ~BITS.KSIDE_CASTLE;\n        }\n    }\n    _updateEnPassantSquare() {\n        if (this._epSquare === EMPTY) {\n            return;\n        }\n        const startSquare = this._epSquare + (this._turn === WHITE ? -16 : 16);\n        const currentSquare = this._epSquare + (this._turn === WHITE ? 16 : -16);\n        const attackers = [currentSquare + 1, currentSquare - 1];\n        if (this._board[startSquare] !== null ||\n            this._board[this._epSquare] !== null ||\n            this._board[currentSquare]?.color !== swapColor(this._turn) ||\n            this._board[currentSquare]?.type !== PAWN) {\n            this._epSquare = EMPTY;\n            return;\n        }\n        const canCapture = (square) => !(square & 0x88) &&\n            this._board[square]?.color === this._turn &&\n            this._board[square]?.type === PAWN;\n        if (!attackers.some(canCapture)) {\n            this._epSquare = EMPTY;\n        }\n    }\n    _attacked(color, square, verbose) {\n        const attackers = [];\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            // did we run off the end of the board\n            if (i & 0x88) {\n                i += 7;\n                continue;\n            }\n            // if empty square or wrong color\n            if (this._board[i] === undefined || this._board[i].color !== color) {\n                continue;\n            }\n            const piece = this._board[i];\n            const difference = i - square;\n            // skip - to/from square are the same\n            if (difference === 0) {\n                continue;\n            }\n            const index = difference + 119;\n            if (ATTACKS[index] & PIECE_MASKS[piece.type]) {\n                if (piece.type === PAWN) {\n                    if ((difference > 0 && piece.color === WHITE) ||\n                        (difference <= 0 && piece.color === BLACK)) {\n                        if (!verbose) {\n                            return true;\n                        }\n                        \n                            attackers.push(algebraic(i));\n                        \n                    }\n                    continue;\n                }\n                // if the piece is a knight or a king\n                if (piece.type === 'n' || piece.type === 'k') {\n                    if (!verbose) {\n                        return true;\n                    }\n                    \n                        attackers.push(algebraic(i));\n                        continue;\n                    \n                }\n                const offset = RAYS[index];\n                let j = i + offset;\n                let blocked = false;\n                while (j !== square) {\n                    if (this._board[j] != null) {\n                        blocked = true;\n                        break;\n                    }\n                    j += offset;\n                }\n                if (!blocked) {\n                    if (!verbose) {\n                        return true;\n                    }\n                    \n                        attackers.push(algebraic(i));\n                        continue;\n                    \n                }\n            }\n        }\n        if (verbose) {\n            return attackers;\n        }\n        \n            return false;\n        \n    }\n    attackers(square, attackedBy) {\n        if (!attackedBy) {\n            return this._attacked(this._turn, Ox88[square], true);\n        }\n        \n            return this._attacked(attackedBy, Ox88[square], true);\n        \n    }\n    _isKingAttacked(color) {\n        const square = this._kings[color];\n        return square === -1 ? false : this._attacked(swapColor(color), square);\n    }\n    isAttacked(square, attackedBy) {\n        return this._attacked(attackedBy, Ox88[square]);\n    }\n    isCheck() {\n        return this._isKingAttacked(this._turn);\n    }\n    inCheck() {\n        return this.isCheck();\n    }\n    isCheckmate() {\n        return this.isCheck() && this._moves().length === 0;\n    }\n    isStalemate() {\n        return !this.isCheck() && this._moves().length === 0;\n    }\n    isInsufficientMaterial() {\n        /*\n         * k.b. vs k.b. (of opposite colors) with mate in 1:\n         * 8/8/8/8/1b6/8/B1k5/K7 b - - 0 1\n         *\n         * k.b. vs k.n. with mate in 1:\n         * 8/8/8/8/1n6/8/B7/K1k5 b - - 2 1\n         */\n        const pieces = {\n            b: 0,\n            n: 0,\n            r: 0,\n            q: 0,\n            k: 0,\n            p: 0,\n        };\n        const bishops = [];\n        let numPieces = 0;\n        let squareColor = 0;\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            squareColor = (squareColor + 1) % 2;\n            if (i & 0x88) {\n                i += 7;\n                continue;\n            }\n            const piece = this._board[i];\n            if (piece) {\n                pieces[piece.type] = piece.type in pieces ? pieces[piece.type] + 1 : 1;\n                if (piece.type === BISHOP) {\n                    bishops.push(squareColor);\n                }\n                numPieces++;\n            }\n        }\n        // k vs. k\n        if (numPieces === 2) {\n            return true;\n        }\n        else if (\n            // k vs. kn .... or .... k vs. kb\n            numPieces === 3 &&\n            (pieces[BISHOP] === 1 || pieces[KNIGHT] === 1)) {\n            return true;\n        }\n        else if (numPieces === pieces[BISHOP] + 2) {\n            // kb vs. kb where any number of bishops are all on the same color\n            let sum = 0;\n            const len = bishops.length;\n            for (let i = 0; i < len; i++) {\n                sum += bishops[i];\n            }\n            if (sum === 0 || sum === len) {\n                return true;\n            }\n        }\n        return false;\n    }\n    isThreefoldRepetition() {\n        return this._getPositionCount(this.fen()) >= 3;\n    }\n    isDrawByFiftyMoves() {\n        return this._halfMoves >= 100; // 50 moves per side = 100 half moves\n    }\n    isDraw() {\n        return (this.isDrawByFiftyMoves() ||\n            this.isStalemate() ||\n            this.isInsufficientMaterial() ||\n            this.isThreefoldRepetition());\n    }\n    isGameOver() {\n        return this.isCheckmate() || this.isStalemate() || this.isDraw();\n    }\n    moves({ verbose = false, square = undefined, piece = undefined, } = {}) {\n        const moves = this._moves({ square, piece });\n        if (verbose) {\n            return moves.map((move) => new Move(this, move));\n        }\n        \n            return moves.map((move) => this._moveToSan(move, moves));\n        \n    }\n    _moves({ legal = true, piece = undefined, square = undefined, } = {}) {\n        const forSquare = square ? square.toLowerCase() : undefined;\n        const forPiece = piece?.toLowerCase();\n        const moves = [];\n        const us = this._turn;\n        const them = swapColor(us);\n        let firstSquare = Ox88.a8;\n        let lastSquare = Ox88.h1;\n        let singleSquare = false;\n        // are we generating moves for a single square?\n        if (forSquare) {\n            // illegal square, return empty moves\n            if (!(forSquare in Ox88)) {\n                return [];\n            }\n            \n                firstSquare = lastSquare = Ox88[forSquare];\n                singleSquare = true;\n            \n        }\n        for (let from = firstSquare; from <= lastSquare; from++) {\n            // did we run off the end of the board\n            if (from & 0x88) {\n                from += 7;\n                continue;\n            }\n            // empty square or opponent, skip\n            if (!this._board[from] || this._board[from].color === them) {\n                continue;\n            }\n            const { type } = this._board[from];\n            let to;\n            if (type === PAWN) {\n                if (forPiece && forPiece !== type)\n                    continue;\n                // single square, non-capturing\n                to = from + PAWN_OFFSETS[us][0];\n                if (!this._board[to]) {\n                    addMove(moves, us, from, to, PAWN);\n                    // double square\n                    to = from + PAWN_OFFSETS[us][1];\n                    if (SECOND_RANK[us] === rank(from) && !this._board[to]) {\n                        addMove(moves, us, from, to, PAWN, undefined, BITS.BIG_PAWN);\n                    }\n                }\n                // pawn captures\n                for (let j = 2; j < 4; j++) {\n                    to = from + PAWN_OFFSETS[us][j];\n                    if (to & 0x88)\n                        continue;\n                    if (this._board[to]?.color === them) {\n                        addMove(moves, us, from, to, PAWN, this._board[to].type, BITS.CAPTURE);\n                    }\n                    else if (to === this._epSquare) {\n                        addMove(moves, us, from, to, PAWN, PAWN, BITS.EP_CAPTURE);\n                    }\n                }\n            }\n            else {\n                if (forPiece && forPiece !== type)\n                    continue;\n                for (let j = 0, len = PIECE_OFFSETS[type].length; j < len; j++) {\n                    const offset = PIECE_OFFSETS[type][j];\n                    to = from;\n                    while (true) {\n                        to += offset;\n                        if (to & 0x88)\n                            break;\n                        if (!this._board[to]) {\n                            addMove(moves, us, from, to, type);\n                        }\n                        else {\n                            // own color, stop loop\n                            if (this._board[to].color === us)\n                                break;\n                            addMove(moves, us, from, to, type, this._board[to].type, BITS.CAPTURE);\n                            break;\n                        }\n                        /* break, if knight or king */\n                        if (type === KNIGHT || type === KING)\n                            break;\n                    }\n                }\n            }\n        }\n        /*\n         * check for castling if we're:\n         *   a) generating all moves, or\n         *   b) doing single square move generation on the king's square\n         */\n        if (forPiece === undefined || forPiece === KING) {\n            if (!singleSquare || lastSquare === this._kings[us]) {\n                // king-side castling\n                if (this._castling[us] & BITS.KSIDE_CASTLE) {\n                    const castlingFrom = this._kings[us];\n                    const castlingTo = castlingFrom + 2;\n                    if (!this._board[castlingFrom + 1] &&\n                        !this._board[castlingTo] &&\n                        !this._attacked(them, this._kings[us]) &&\n                        !this._attacked(them, castlingFrom + 1) &&\n                        !this._attacked(them, castlingTo)) {\n                        addMove(moves, us, this._kings[us], castlingTo, KING, undefined, BITS.KSIDE_CASTLE);\n                    }\n                }\n                // queen-side castling\n                if (this._castling[us] & BITS.QSIDE_CASTLE) {\n                    const castlingFrom = this._kings[us];\n                    const castlingTo = castlingFrom - 2;\n                    if (!this._board[castlingFrom - 1] &&\n                        !this._board[castlingFrom - 2] &&\n                        !this._board[castlingFrom - 3] &&\n                        !this._attacked(them, this._kings[us]) &&\n                        !this._attacked(them, castlingFrom - 1) &&\n                        !this._attacked(them, castlingTo)) {\n                        addMove(moves, us, this._kings[us], castlingTo, KING, undefined, BITS.QSIDE_CASTLE);\n                    }\n                }\n            }\n        }\n        /*\n         * return all pseudo-legal moves (this includes moves that allow the king\n         * to be captured)\n         */\n        if (!legal || this._kings[us] === -1) {\n            return moves;\n        }\n        // filter out illegal moves\n        const legalMoves = [];\n        for (let i = 0, len = moves.length; i < len; i++) {\n            this._makeMove(moves[i]);\n            if (!this._isKingAttacked(us)) {\n                legalMoves.push(moves[i]);\n            }\n            this._undoMove();\n        }\n        return legalMoves;\n    }\n    move(move, { strict = false } = {}) {\n        /*\n         * The move function can be called with in the following parameters:\n         *\n         * .move('Nxb7')       <- argument is a case-sensitive SAN string\n         *\n         * .move({ from: 'h7', <- argument is a move object\n         *         to :'h8',\n         *         promotion: 'q' })\n         *\n         *\n         * An optional strict argument may be supplied to tell chess.js to\n         * strictly follow the SAN specification.\n         */\n        let moveObj = null;\n        if (typeof move === 'string') {\n            moveObj = this._moveFromSan(move, strict);\n        }\n        else if (typeof move === 'object') {\n            const moves = this._moves();\n            // convert the pretty move object to an ugly move object\n            for (let i = 0, len = moves.length; i < len; i++) {\n                if (move.from === algebraic(moves[i].from) &&\n                    move.to === algebraic(moves[i].to) &&\n                    (!('promotion' in moves[i]) || move.promotion === moves[i].promotion)) {\n                    moveObj = moves[i];\n                    break;\n                }\n            }\n        }\n        // failed to find move\n        if (!moveObj) {\n            if (typeof move === 'string') {\n                throw new Error(`Invalid move: ${move}`);\n            }\n            else {\n                throw new Error(`Invalid move: ${JSON.stringify(move)}`);\n            }\n        }\n        /*\n         * need to make a copy of move because we can't generate SAN after the move\n         * is made\n         */\n        const prettyMove = new Move(this, moveObj);\n        this._makeMove(moveObj);\n        this._incPositionCount(prettyMove.after);\n        return prettyMove;\n    }\n    _push(move) {\n        this._history.push({\n            move,\n            kings: { b: this._kings.b, w: this._kings.w },\n            turn: this._turn,\n            castling: { b: this._castling.b, w: this._castling.w },\n            epSquare: this._epSquare,\n            halfMoves: this._halfMoves,\n            moveNumber: this._moveNumber,\n        });\n    }\n    _makeMove(move) {\n        const us = this._turn;\n        const them = swapColor(us);\n        this._push(move);\n        this._board[move.to] = this._board[move.from];\n        delete this._board[move.from];\n        // if ep capture, remove the captured pawn\n        if (move.flags & BITS.EP_CAPTURE) {\n            if (this._turn === BLACK) {\n                delete this._board[move.to - 16];\n            }\n            else {\n                delete this._board[move.to + 16];\n            }\n        }\n        // if pawn promotion, replace with new piece\n        if (move.promotion) {\n            this._board[move.to] = { type: move.promotion, color: us };\n        }\n        // if we moved the king\n        if (this._board[move.to].type === KING) {\n            this._kings[us] = move.to;\n            // if we castled, move the rook next to the king\n            if (move.flags & BITS.KSIDE_CASTLE) {\n                const castlingTo = move.to - 1;\n                const castlingFrom = move.to + 1;\n                this._board[castlingTo] = this._board[castlingFrom];\n                delete this._board[castlingFrom];\n            }\n            else if (move.flags & BITS.QSIDE_CASTLE) {\n                const castlingTo = move.to + 1;\n                const castlingFrom = move.to - 2;\n                this._board[castlingTo] = this._board[castlingFrom];\n                delete this._board[castlingFrom];\n            }\n            // turn off castling\n            this._castling[us] = 0;\n        }\n        // turn off castling if we move a rook\n        if (this._castling[us]) {\n            for (let i = 0, len = ROOKS[us].length; i < len; i++) {\n                if (move.from === ROOKS[us][i].square &&\n                    this._castling[us] & ROOKS[us][i].flag) {\n                    this._castling[us] ^= ROOKS[us][i].flag;\n                    break;\n                }\n            }\n        }\n        // turn off castling if we capture a rook\n        if (this._castling[them]) {\n            for (let i = 0, len = ROOKS[them].length; i < len; i++) {\n                if (move.to === ROOKS[them][i].square &&\n                    this._castling[them] & ROOKS[them][i].flag) {\n                    this._castling[them] ^= ROOKS[them][i].flag;\n                    break;\n                }\n            }\n        }\n        // if big pawn move, update the en passant square\n        if (move.flags & BITS.BIG_PAWN) {\n            if (us === BLACK) {\n                this._epSquare = move.to - 16;\n            }\n            else {\n                this._epSquare = move.to + 16;\n            }\n        }\n        else {\n            this._epSquare = EMPTY;\n        }\n        // reset the 50 move counter if a pawn is moved or a piece is captured\n        if (move.piece === PAWN) {\n            this._halfMoves = 0;\n        }\n        else if (move.flags & (BITS.CAPTURE | BITS.EP_CAPTURE)) {\n            this._halfMoves = 0;\n        }\n        else {\n            this._halfMoves++;\n        }\n        if (us === BLACK) {\n            this._moveNumber++;\n        }\n        this._turn = them;\n    }\n    undo() {\n        const move = this._undoMove();\n        if (move) {\n            const prettyMove = new Move(this, move);\n            this._decPositionCount(prettyMove.after);\n            return prettyMove;\n        }\n        return null;\n    }\n    _undoMove() {\n        const old = this._history.pop();\n        if (old === undefined) {\n            return null;\n        }\n        const move = old.move;\n        this._kings = old.kings;\n        this._turn = old.turn;\n        this._castling = old.castling;\n        this._epSquare = old.epSquare;\n        this._halfMoves = old.halfMoves;\n        this._moveNumber = old.moveNumber;\n        const us = this._turn;\n        const them = swapColor(us);\n        this._board[move.from] = this._board[move.to];\n        this._board[move.from].type = move.piece; // to undo any promotions\n        delete this._board[move.to];\n        if (move.captured) {\n            if (move.flags & BITS.EP_CAPTURE) {\n                // en passant capture\n                let index;\n                if (us === BLACK) {\n                    index = move.to - 16;\n                }\n                else {\n                    index = move.to + 16;\n                }\n                this._board[index] = { type: PAWN, color: them };\n            }\n            else {\n                // regular capture\n                this._board[move.to] = { type: move.captured, color: them };\n            }\n        }\n        if (move.flags & (BITS.KSIDE_CASTLE | BITS.QSIDE_CASTLE)) {\n            let castlingTo, castlingFrom;\n            if (move.flags & BITS.KSIDE_CASTLE) {\n                castlingTo = move.to + 1;\n                castlingFrom = move.to - 1;\n            }\n            else {\n                castlingTo = move.to - 2;\n                castlingFrom = move.to + 1;\n            }\n            this._board[castlingTo] = this._board[castlingFrom];\n            delete this._board[castlingFrom];\n        }\n        return move;\n    }\n    pgn({ newline = '\\n', maxWidth = 0, } = {}) {\n        /*\n         * using the specification from http://www.chessclub.com/help/PGN-spec\n         * example for html usage: .pgn({ max_width: 72, newline_char: \"<br />\" })\n         */\n        const result = [];\n        let headerExists = false;\n        /* add the PGN header information */\n        for (const i in this._header) {\n            /*\n             * TODO: order of enumerated properties in header object is not\n             * guaranteed, see ECMA-262 spec (section 12.6.4)\n             */\n            result.push(`[${  i  } \"${  this._header[i]  }\"]${  newline}`);\n            headerExists = true;\n        }\n        if (headerExists && this._history.length) {\n            result.push(newline);\n        }\n        const appendComment = (moveString) => {\n            const comment = this._comments[this.fen()];\n            if (typeof comment !== 'undefined') {\n                const delimiter = moveString.length > 0 ? ' ' : '';\n                moveString = `${moveString}${delimiter}{${comment}}`;\n            }\n            return moveString;\n        };\n        // pop all of history onto reversed_history\n        const reversedHistory = [];\n        while (this._history.length > 0) {\n            reversedHistory.push(this._undoMove());\n        }\n        const moves = [];\n        let moveString = '';\n        // special case of a commented starting position with no moves\n        if (reversedHistory.length === 0) {\n            moves.push(appendComment(''));\n        }\n        // build the list of moves.  a move_string looks like: \"3. e3 e6\"\n        while (reversedHistory.length > 0) {\n            moveString = appendComment(moveString);\n            const move = reversedHistory.pop();\n            // make TypeScript stop complaining about move being undefined\n            if (!move) {\n                break;\n            }\n            // if the position started with black to move, start PGN with #. ...\n            if (!this._history.length && move.color === 'b') {\n                const prefix = `${this._moveNumber}. ...`;\n                // is there a comment preceding the first move?\n                moveString = moveString ? `${moveString} ${prefix}` : prefix;\n            }\n            else if (move.color === 'w') {\n                // store the previous generated move_string if we have one\n                if (moveString.length) {\n                    moves.push(moveString);\n                }\n                moveString = `${this._moveNumber  }.`;\n            }\n            moveString =\n                `${moveString  } ${  this._moveToSan(move, this._moves({ legal: true }))}`;\n            this._makeMove(move);\n        }\n        // are there any other leftover moves?\n        if (moveString.length) {\n            moves.push(appendComment(moveString));\n        }\n        // is there a result?\n        if (typeof this._header.Result !== 'undefined') {\n            moves.push(this._header.Result);\n        }\n        /*\n         * history should be back to what it was before we started generating PGN,\n         * so join together moves\n         */\n        if (maxWidth === 0) {\n            return result.join('') + moves.join(' ');\n        }\n        // TODO (jah): huh?\n        const strip = function () {\n            if (result.length > 0 && result[result.length - 1] === ' ') {\n                result.pop();\n                return true;\n            }\n            return false;\n        };\n        // NB: this does not preserve comment whitespace.\n        const wrapComment = function (width, move) {\n            for (const token of move.split(' ')) {\n                if (!token) {\n                    continue;\n                }\n                if (width + token.length > maxWidth) {\n                    while (strip()) {\n                        width--;\n                    }\n                    result.push(newline);\n                    width = 0;\n                }\n                result.push(token);\n                width += token.length;\n                result.push(' ');\n                width++;\n            }\n            if (strip()) {\n                width--;\n            }\n            return width;\n        };\n        // wrap the PGN output at max_width\n        let currentWidth = 0;\n        for (let i = 0; i < moves.length; i++) {\n            if (currentWidth + moves[i].length > maxWidth) {\n                if (moves[i].includes('{')) {\n                    currentWidth = wrapComment(currentWidth, moves[i]);\n                    continue;\n                }\n            }\n            // if the current move will push past max_width\n            if (currentWidth + moves[i].length > maxWidth && i !== 0) {\n                // don't end the line with whitespace\n                if (result[result.length - 1] === ' ') {\n                    result.pop();\n                }\n                result.push(newline);\n                currentWidth = 0;\n            }\n            else if (i !== 0) {\n                result.push(' ');\n                currentWidth++;\n            }\n            result.push(moves[i]);\n            currentWidth += moves[i].length;\n        }\n        return result.join('');\n    }\n    /*\n     * @deprecated Use `setHeader` and `getHeaders` instead.\n     */\n    header(...args) {\n        for (let i = 0; i < args.length; i += 2) {\n            if (typeof args[i] === 'string' && typeof args[i + 1] === 'string') {\n                this._header[args[i]] = args[i + 1];\n            }\n        }\n        return this._header;\n    }\n    setHeader(key, value) {\n        this._header[key] = value;\n        return this._header;\n    }\n    removeHeader(key) {\n        if (key in this._header) {\n            delete this._header[key];\n            return true;\n        }\n        return false;\n    }\n    getHeaders() {\n        return this._header;\n    }\n    loadPgn(pgn, { strict = false, newlineChar = '\\r?\\n', } = {}) {\n        function mask(str) {\n            return str.replace(/\\\\/g, '\\\\');\n        }\n        function parsePgnHeader(header) {\n            const headerObj = {};\n            const headers = header.split(new RegExp(mask(newlineChar)));\n            let key = '';\n            let value = '';\n            for (let i = 0; i < headers.length; i++) {\n                const regex = /^\\s*\\[\\s*([A-Za-z]+)\\s*\"(.*)\"\\s*\\]\\s*$/;\n                key = headers[i].replace(regex, '$1');\n                value = headers[i].replace(regex, '$2');\n                if (key.trim().length > 0) {\n                    headerObj[key] = value;\n                }\n            }\n            return headerObj;\n        }\n        // strip whitespace from head/tail of PGN block\n        pgn = pgn.trim();\n        /*\n         * RegExp to split header. Takes advantage of the fact that header and movetext\n         * will always have a blank line between them (ie, two newline_char's). Handles\n         * case where movetext is empty by matching newlineChar until end of string is\n         * matched - effectively trimming from the end extra newlineChar.\n         *\n         * With default newline_char, will equal:\n         * /^(\\[((?:\\r?\\n)|.)*\\])((?:\\s*\\r?\\n){2}|(?:\\s*\\r?\\n)*$)/\n         */\n        const headerRegex = new RegExp(`^(\\\\[((?:${ \n            mask(newlineChar) \n            })|.)*\\\\])` +\n            `((?:\\\\s*${ \n            mask(newlineChar) \n            }){2}|(?:\\\\s*${ \n            mask(newlineChar) \n            })*$)`);\n        // If no header given, begin with moves.\n        const headerRegexResults = headerRegex.exec(pgn);\n        const headerString = headerRegexResults\n            ? headerRegexResults.length >= 2\n                ? headerRegexResults[1]\n                : ''\n            : '';\n        // Put the board in the starting position\n        this.reset();\n        // parse PGN header\n        const headers = parsePgnHeader(headerString);\n        let fen = '';\n        for (const key in headers) {\n            // check to see user is including fen (possibly with wrong tag case)\n            if (key.toLowerCase() === 'fen') {\n                fen = headers[key];\n            }\n            this.header(key, headers[key]);\n        }\n        /*\n         * the permissive parser should attempt to load a fen tag, even if it's the\n         * wrong case and doesn't include a corresponding [SetUp \"1\"] tag\n         */\n        if (!strict) {\n            if (fen) {\n                this.load(fen, { preserveHeaders: true });\n            }\n        }\n        else {\n            /*\n             * strict parser - load the starting position indicated by [Setup '1']\n             * and [FEN position]\n             */\n            if (headers['SetUp'] === '1') {\n                if (!('FEN' in headers)) {\n                    throw new Error('Invalid PGN: FEN tag must be supplied with SetUp tag');\n                }\n                // don't clear the headers when loading\n                this.load(headers['FEN'], { preserveHeaders: true });\n            }\n        }\n        /*\n         * NB: the regexes below that delete move numbers, recursive annotations,\n         * and numeric annotation glyphs may also match text in comments. To\n         * prevent this, we transform comments by hex-encoding them in place and\n         * decoding them again after the other tokens have been deleted.\n         *\n         * While the spec states that PGN files should be ASCII encoded, we use\n         * {en,de}codeURIComponent here to support arbitrary UTF8 as a convenience\n         * for modern users\n         */\n        function toHex(s) {\n            return Array.from(s)\n                .map((c) => {\n                    /*\n                     * encodeURI doesn't transform most ASCII characters, so we handle\n                     * these ourselves\n                     */\n                    return c.charCodeAt(0) < 128\n                        ? c.charCodeAt(0).toString(16)\n                        : encodeURIComponent(c).replace(/%/g, '').toLowerCase();\n                })\n                .join('');\n        }\n        function fromHex(s) {\n            return s.length == 0\n                ? ''\n                : decodeURIComponent(`%${  (s.match(/.{1,2}/g) || []).join('%')}`);\n        }\n        const encodeComment = function (s) {\n            s = s.replace(new RegExp(mask(newlineChar), 'g'), ' ');\n            return `{${toHex(s.slice(1, s.length - 1))}}`;\n        };\n        const decodeComment = function (s) {\n            if (s.startsWith('{') && s.endsWith('}')) {\n                return fromHex(s.slice(1, s.length - 1));\n            }\n        };\n        // delete header to get the moves\n        let ms = pgn\n            .replace(headerString, '')\n            .replace(\n                // encode comments so they don't get deleted below\n                new RegExp(`({[^}]*})+?|;([^${mask(newlineChar)}]*)`, 'g'), (_match, bracket, semicolon) => {\n                    return bracket !== undefined\n                        ? encodeComment(bracket)\n                        : ` ${  encodeComment(`{${semicolon.slice(1)}}`)}`;\n                })\n            .replace(new RegExp(mask(newlineChar), 'g'), ' ');\n        // delete recursive annotation variations\n        const ravRegex = /(\\([^()]+\\))+?/g;\n        while (ravRegex.test(ms)) {\n            ms = ms.replace(ravRegex, '');\n        }\n        // delete move numbers\n        ms = ms.replace(/\\d+\\.(\\.\\.)?/g, '');\n        // delete ... indicating black to move\n        ms = ms.replace(/\\.\\.\\./g, '');\n        /* delete numeric annotation glyphs */\n        ms = ms.replace(/\\$\\d+/g, '');\n        // trim and get array of moves\n        let moves = ms.trim().split(new RegExp(/\\s+/));\n        // delete empty entries\n        moves = moves.filter((move) => move !== '');\n        let result = '';\n        for (let halfMove = 0; halfMove < moves.length; halfMove++) {\n            const comment = decodeComment(moves[halfMove]);\n            if (comment !== undefined) {\n                this._comments[this.fen()] = comment;\n                continue;\n            }\n            const move = this._moveFromSan(moves[halfMove], strict);\n            // invalid move\n            if (move == null) {\n                // was the move an end of game marker\n                if (TERMINATION_MARKERS.indexOf(moves[halfMove]) > -1) {\n                    result = moves[halfMove];\n                }\n                else {\n                    throw new Error(`Invalid move in PGN: ${moves[halfMove]}`);\n                }\n            }\n            else {\n                // reset the end of game marker if making a valid move\n                result = '';\n                this._makeMove(move);\n                this._incPositionCount(this.fen());\n            }\n        }\n        /*\n         * Per section 8.2.6 of the PGN spec, the Result tag pair must match match\n         * the termination marker. Only do this when headers are present, but the\n         * result tag is missing\n         */\n        if (result && Object.keys(this._header).length && !this._header['Result']) {\n            this.header('Result', result);\n        }\n    }\n    /*\n     * Convert a move from 0x88 coordinates to Standard Algebraic Notation\n     * (SAN)\n     *\n     * @param {boolean} strict Use the strict SAN parser. It will throw errors\n     * on overly disambiguated moves (see below):\n     *\n     * r1bqkbnr/ppp2ppp/2n5/1B1pP3/4P3/8/PPPP2PP/RNBQK1NR b KQkq - 2 4\n     * 4. ... Nge7 is overly disambiguated because the knight on c6 is pinned\n     * 4. ... Ne7 is technically the valid SAN\n     */\n    _moveToSan(move, moves) {\n        let output = '';\n        if (move.flags & BITS.KSIDE_CASTLE) {\n            output = 'O-O';\n        }\n        else if (move.flags & BITS.QSIDE_CASTLE) {\n            output = 'O-O-O';\n        }\n        else {\n            if (move.piece !== PAWN) {\n                const disambiguator = getDisambiguator(move, moves);\n                output += move.piece.toUpperCase() + disambiguator;\n            }\n            if (move.flags & (BITS.CAPTURE | BITS.EP_CAPTURE)) {\n                if (move.piece === PAWN) {\n                    output += algebraic(move.from)[0];\n                }\n                output += 'x';\n            }\n            output += algebraic(move.to);\n            if (move.promotion) {\n                output += `=${  move.promotion.toUpperCase()}`;\n            }\n        }\n        this._makeMove(move);\n        if (this.isCheck()) {\n            if (this.isCheckmate()) {\n                output += '#';\n            }\n            else {\n                output += '+';\n            }\n        }\n        this._undoMove();\n        return output;\n    }\n    // convert a move from Standard Algebraic Notation (SAN) to 0x88 coordinates\n    _moveFromSan(move, strict = false) {\n        // strip off any move decorations: e.g Nf3+?! becomes Nf3\n        const cleanMove = strippedSan(move);\n        let pieceType = inferPieceType(cleanMove);\n        let moves = this._moves({ legal: true, piece: pieceType });\n        // strict parser\n        for (let i = 0, len = moves.length; i < len; i++) {\n            if (cleanMove === strippedSan(this._moveToSan(moves[i], moves))) {\n                return moves[i];\n            }\n        }\n        // the strict parser failed\n        if (strict) {\n            return null;\n        }\n        let piece = undefined;\n        let matches = undefined;\n        let from = undefined;\n        let to = undefined;\n        let promotion = undefined;\n        /*\n         * The default permissive (non-strict) parser allows the user to parse\n         * non-standard chess notations. This parser is only run after the strict\n         * Standard Algebraic Notation (SAN) parser has failed.\n         *\n         * When running the permissive parser, we'll run a regex to grab the piece, the\n         * to/from square, and an optional promotion piece. This regex will\n         * parse common non-standard notation like: Pe2-e4, Rc1c4, Qf3xf7,\n         * f7f8q, b1c3\n         *\n         * NOTE: Some positions and moves may be ambiguous when using the permissive\n         * parser. For example, in this position: 6k1/8/8/B7/8/8/8/BN4K1 w - - 0 1,\n         * the move b1c3 may be interpreted as Nc3 or B1c3 (a disambiguated bishop\n         * move). In these cases, the permissive parser will default to the most\n         * basic interpretation (which is b1c3 parsing to Nc3).\n         */\n        let overlyDisambiguated = false;\n        matches = cleanMove.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);\n        if (matches) {\n            piece = matches[1];\n            from = matches[2];\n            to = matches[3];\n            promotion = matches[4];\n            if (from.length == 1) {\n                overlyDisambiguated = true;\n            }\n        }\n        else {\n            /*\n             * The [a-h]?[1-8]? portion of the regex below handles moves that may be\n             * overly disambiguated (e.g. Nge7 is unnecessary and non-standard when\n             * there is one legal knight move to e7). In this case, the value of\n             * 'from' variable will be a rank or file, not a square.\n             */\n            matches = cleanMove.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/);\n            if (matches) {\n                piece = matches[1];\n                from = matches[2];\n                to = matches[3];\n                promotion = matches[4];\n                if (from.length == 1) {\n                    overlyDisambiguated = true;\n                }\n            }\n        }\n        pieceType = inferPieceType(cleanMove);\n        moves = this._moves({\n            legal: true,\n            piece: piece ? piece : pieceType,\n        });\n        if (!to) {\n            return null;\n        }\n        for (let i = 0, len = moves.length; i < len; i++) {\n            if (!from) {\n                // if there is no from square, it could be just 'x' missing from a capture\n                if (cleanMove ===\n                    strippedSan(this._moveToSan(moves[i], moves)).replace('x', '')) {\n                    return moves[i];\n                }\n                // hand-compare move properties with the results from our permissive regex\n            }\n            else if ((!piece || piece.toLowerCase() == moves[i].piece) &&\n                Ox88[from] == moves[i].from &&\n                Ox88[to] == moves[i].to &&\n                (!promotion || promotion.toLowerCase() == moves[i].promotion)) {\n                return moves[i];\n            }\n            else if (overlyDisambiguated) {\n                /*\n                 * SPECIAL CASE: we parsed a move string that may have an unneeded\n                 * rank/file disambiguator (e.g. Nge7).  The 'from' variable will\n                 */\n                const square = algebraic(moves[i].from);\n                if ((!piece || piece.toLowerCase() == moves[i].piece) &&\n                    Ox88[to] == moves[i].to &&\n                    (from == square[0] || from == square[1]) &&\n                    (!promotion || promotion.toLowerCase() == moves[i].promotion)) {\n                    return moves[i];\n                }\n            }\n        }\n        return null;\n    }\n    ascii() {\n        let s = '   +------------------------+\\n';\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            // display the rank\n            if (file(i) === 0) {\n                s += ` ${  '87654321'[rank(i)]  } |`;\n            }\n            if (this._board[i]) {\n                const piece = this._board[i].type;\n                const color = this._board[i].color;\n                const symbol = color === WHITE ? piece.toUpperCase() : piece.toLowerCase();\n                s += ` ${  symbol  } `;\n            }\n            else {\n                s += ' . ';\n            }\n            if ((i + 1) & 0x88) {\n                s += '|\\n';\n                i += 8;\n            }\n        }\n        s += '   +------------------------+\\n';\n        s += '     a  b  c  d  e  f  g  h';\n        return s;\n    }\n    perft(depth) {\n        const moves = this._moves({ legal: false });\n        let nodes = 0;\n        const color = this._turn;\n        for (let i = 0, len = moves.length; i < len; i++) {\n            this._makeMove(moves[i]);\n            if (!this._isKingAttacked(color)) {\n                if (depth - 1 > 0) {\n                    nodes += this.perft(depth - 1);\n                }\n                else {\n                    nodes++;\n                }\n            }\n            this._undoMove();\n        }\n        return nodes;\n    }\n    turn() {\n        return this._turn;\n    }\n    board() {\n        const output = [];\n        let row = [];\n        for (let i = Ox88.a8; i <= Ox88.h1; i++) {\n            if (this._board[i] == null) {\n                row.push(null);\n            }\n            else {\n                row.push({\n                    square: algebraic(i),\n                    type: this._board[i].type,\n                    color: this._board[i].color,\n                });\n            }\n            if ((i + 1) & 0x88) {\n                output.push(row);\n                row = [];\n                i += 8;\n            }\n        }\n        return output;\n    }\n    squareColor(square) {\n        if (square in Ox88) {\n            const sq = Ox88[square];\n            return (rank(sq) + file(sq)) % 2 === 0 ? 'light' : 'dark';\n        }\n        return null;\n    }\n    history({ verbose = false } = {}) {\n        const reversedHistory = [];\n        const moveHistory = [];\n        while (this._history.length > 0) {\n            reversedHistory.push(this._undoMove());\n        }\n        while (true) {\n            const move = reversedHistory.pop();\n            if (!move) {\n                break;\n            }\n            if (verbose) {\n                moveHistory.push(new Move(this, move));\n            }\n            else {\n                moveHistory.push(this._moveToSan(move, this._moves()));\n            }\n            this._makeMove(move);\n        }\n        return moveHistory;\n    }\n    /*\n     * Keeps track of position occurrence counts for the purpose of repetition\n     * checking. All three methods (`_inc`, `_dec`, and `_get`) trim the\n     * irrelevent information from the fen, initialising new positions, and\n     * removing old positions from the record if their counts are reduced to 0.\n     */\n    _getPositionCount(fen) {\n        const trimmedFen = trimFen(fen);\n        return this._positionCount[trimmedFen] || 0;\n    }\n    _incPositionCount(fen) {\n        const trimmedFen = trimFen(fen);\n        if (this._positionCount[trimmedFen] === undefined) {\n            this._positionCount[trimmedFen] = 0;\n        }\n        this._positionCount[trimmedFen] += 1;\n    }\n    _decPositionCount(fen) {\n        const trimmedFen = trimFen(fen);\n        if (this._positionCount[trimmedFen] === 1) {\n            delete this._positionCount[trimmedFen];\n        }\n        else {\n            this._positionCount[trimmedFen] -= 1;\n        }\n    }\n    _pruneComments() {\n        const reversedHistory = [];\n        const currentComments = {};\n        const copyComment = (fen) => {\n            if (fen in this._comments) {\n                currentComments[fen] = this._comments[fen];\n            }\n        };\n        while (this._history.length > 0) {\n            reversedHistory.push(this._undoMove());\n        }\n        copyComment(this.fen());\n        while (true) {\n            const move = reversedHistory.pop();\n            if (!move) {\n                break;\n            }\n            this._makeMove(move);\n            copyComment(this.fen());\n        }\n        this._comments = currentComments;\n    }\n    getComment() {\n        return this._comments[this.fen()];\n    }\n    setComment(comment) {\n        this._comments[this.fen()] = comment.replace('{', '[').replace('}', ']');\n    }\n    /**\n     * @deprecated Renamed to `removeComment` for consistency\n     */\n    deleteComment() {\n        return this.removeComment();\n    }\n    removeComment() {\n        const comment = this._comments[this.fen()];\n        delete this._comments[this.fen()];\n        return comment;\n    }\n    getComments() {\n        this._pruneComments();\n        return Object.keys(this._comments).map((fen) => {\n            return { fen, comment: this._comments[fen] };\n        });\n    }\n    /**\n     * @deprecated Renamed to `removeComments` for consistency\n     */\n    deleteComments() {\n        return this.removeComments();\n    }\n    removeComments() {\n        this._pruneComments();\n        return Object.keys(this._comments).map((fen) => {\n            const comment = this._comments[fen];\n            delete this._comments[fen];\n            return { fen, comment };\n        });\n    }\n    setCastlingRights(color, rights) {\n        for (const side of [KING, QUEEN]) {\n            if (rights[side] !== undefined) {\n                if (rights[side]) {\n                    this._castling[color] |= SIDES[side];\n                }\n                else {\n                    this._castling[color] &= ~SIDES[side];\n                }\n            }\n        }\n        this._updateCastlingRights();\n        const result = this.getCastlingRights(color);\n        return ((rights[KING] === undefined || rights[KING] === result[KING]) &&\n            (rights[QUEEN] === undefined || rights[QUEEN] === result[QUEEN]));\n    }\n    getCastlingRights(color) {\n        return {\n            [KING]: (this._castling[color] & SIDES[KING]) !== 0,\n            [QUEEN]: (this._castling[color] & SIDES[QUEEN]) !== 0,\n        };\n    }\n    moveNumber() {\n        return this._moveNumber;\n    }\n}\n//# sourceMappingURL=chess.js.map","/**\n * Service for managing chess positions and FEN conversion\n * @module services/PositionService\n * @since 2.0.0\n */\n\nimport { Chess, validateFen } from '../utils/chess.js';\nimport { STANDARD_POSITIONS, DEFAULT_STARTING_POSITION, BOARD_LETTERS } from '../constants/positions.js';\nimport { ValidationError } from '../errors/ChessboardError.js';\nimport { ERROR_MESSAGES } from '../errors/messages.js';\n\n/**\n * Service responsible for position management and FEN operations\n * @class\n */\nexport class PositionService {\n    /**\n     * Creates a new PositionService instance\n     * @param {ChessboardConfig} config - Board configuration\n     */\n    constructor(config) {\n        this.config = config;\n        this.game = null;\n    }\n\n    /**\n     * Converts various position formats to FEN string\n     * @param {string|Object} position - Position in various formats\n     * @returns {string} FEN string representation\n     * @throws {ValidationError} When position format is invalid\n     */\n    convertFen(position) {\n        if (typeof position === 'string') {\n            return this._convertStringPosition(position);\n        } else if (typeof position === 'object' && position !== null) {\n            return this._convertObjectPosition(position);\n        } \n            throw new ValidationError(ERROR_MESSAGES.invalid_position + position, 'position', position);\n        \n    }\n\n    /**\n     * Converts string position to FEN\n     * @private\n     * @param {string} position - String position\n     * @returns {string} FEN string\n     */\n    _convertStringPosition(position) {\n        if (position === 'start') {\n            return DEFAULT_STARTING_POSITION;\n        }\n        \n        if (this.validateFen(position)) {\n            return position;\n        }\n        \n        if (STANDARD_POSITIONS[position]) {\n            return STANDARD_POSITIONS[position];\n        }\n        \n        throw new ValidationError(ERROR_MESSAGES.invalid_position + position, 'position', position);\n    }\n\n    /**\n     * Converts object position to FEN\n     * @private\n     * @param {Object} position - Object with square->piece mapping\n     * @returns {string} FEN string\n     */\n    _convertObjectPosition(position) {\n        const parts = [];\n        \n        for (let row = 0; row < 8; row++) {\n            const rowParts = [];\n            let empty = 0;\n            \n            for (let col = 0; col < 8; col++) {\n                const square = this._getSquareID(row, col);\n                const piece = position[square];\n                \n                if (piece) {\n                    if (empty > 0) {\n                        rowParts.push(empty);\n                        empty = 0;\n                    }\n                    // Convert piece notation: white pieces become uppercase, black remain lowercase\n                    const fenPiece = piece[1] === 'w' ? piece[0].toUpperCase() : piece[0].toLowerCase();\n                    rowParts.push(fenPiece);\n                } else {\n                    empty++;\n                }\n            }\n            \n            if (empty > 0) {\n                rowParts.push(empty);\n            }\n            \n            parts.push(rowParts.join(''));\n        }\n        \n        return `${parts.join('/')  } w KQkq - 0 1`;\n    }\n\n    /**\n     * Sets up the game with the given position\n     * @param {string|Object} position - Position to set\n     * @param {Object} [options] - Additional options for game setup\n     */\n    setGame(position, options = {}) {\n        const fen = this.convertFen(position);\n        \n        if (this.game) {\n            this.game.load(fen, options);\n        } else {\n            this.game = new Chess(fen);\n        }\n    }\n\n    /**\n     * Gets the current game instance\n     * @returns {Chess} Current chess.js game instance\n     */\n    getGame() {\n        return this.game;\n    }\n\n    /**\n     * Validates a FEN string\n     * @param {string} fen - FEN string to validate\n     * @returns {boolean} True if valid, false otherwise\n     */\n    validateFen(fen) {\n        return validateFen(fen);\n    }\n\n    /**\n     * Gets piece information for a specific square\n     * @param {string} squareId - Square identifier\n     * @returns {string|null} Piece ID or null if no piece\n     */\n    getGamePieceId(squareId) {\n        if (!this.game) return null;\n        const piece = this.game.get(squareId);\n        return piece ? piece.color + piece.type : null;\n    }\n\n    /**\n     * Checks if a specific piece is on a specific square\n     * @param {string} piece - Piece ID to check\n     * @param {string} square - Square to check\n     * @returns {boolean} True if piece is on square\n     */\n    isPiece(piece, square) {\n        return this.getGamePieceId(square) === piece;\n    }\n\n    /**\n     * Converts board coordinates to square ID\n     * @private\n     * @param {number} row - Row index (0-7)\n     * @param {number} col - Column index (0-7)\n     * @returns {string} Square ID (e.g., 'e4')\n     */\n    _getSquareID(row, col) {\n        row = parseInt(row);\n        col = parseInt(col);\n        \n        if (this.config.orientation === 'w') {\n            row = 8 - row;\n            col = col + 1;\n        } else {\n            row = row + 1;\n            col = 8 - col;\n        }\n        \n        const letter = BOARD_LETTERS[col - 1];\n        return letter + row;\n    }\n\n    /**\n     * Changes the turn in a FEN string\n     * @param {string} fen - Original FEN string\n     * @param {string} color - New turn color ('w' or 'b')\n     * @returns {string} Modified FEN string\n     */\n    changeFenTurn(fen, color) {\n        const parts = fen.split(' ');\n        parts[1] = color;\n        return parts.join(' ');\n    }\n\n    /**\n     * Gets the current position as an object\n     * @returns {Object} Position object with piece placements\n     */\n    getPosition() {\n        const position = {};\n        const game = this.getGame();\n        \n        // Convert chess.js board to position object\n        const squares = ['a1', 'b1', 'c1', 'd1', 'e1', 'f1', 'g1', 'h1',\n                        'a2', 'b2', 'c2', 'd2', 'e2', 'f2', 'g2', 'h2',\n                        'a3', 'b3', 'c3', 'd3', 'e3', 'f3', 'g3', 'h3',\n                        'a4', 'b4', 'c4', 'd4', 'e4', 'f4', 'g4', 'h4',\n                        'a5', 'b5', 'c5', 'd5', 'e5', 'f5', 'g5', 'h5',\n                        'a6', 'b6', 'c6', 'd6', 'e6', 'f6', 'g6', 'h6',\n                        'a7', 'b7', 'c7', 'd7', 'e7', 'f7', 'g7', 'h7',\n                        'a8', 'b8', 'c8', 'd8', 'e8', 'f8', 'g8', 'h8'];\n        \n        for (const square of squares) {\n            const piece = game.get(square);\n            if (piece) {\n                position[square] = piece.type + piece.color;\n            }\n        }\n        \n        return position;\n    }\n\n    /**\n     * Toggles the turn in a FEN string\n     * @param {string} fen - Original FEN string\n     * @returns {string} Modified FEN string\n     */\n    changeFenColor(fen) {\n        const parts = fen.split(' ');\n        parts[1] = parts[1] === 'w' ? 'b' : 'w';\n        return parts.join(' ');\n    }\n\n    /**\n     * Cleans up resources\n     */\n    destroy() {\n        this.game = null;\n    }\n}\n","/**\n * Main Chessboard class - Orchestrates all services and components\n * @module core/Chessboard\n * @since 2.0.0\n */\n\nimport ChessboardConfig from './ChessboardConfig.js';\nimport Move from '../components/Move.js';\nimport {\n    AnimationService,\n    BoardService,\n    CoordinateService,\n    EventService,\n    MoveService,\n    PieceService,\n    PositionService,\n    ValidationService\n} from '../services/index.js';\nimport { ERROR_MESSAGES } from '../errors/index.js';\nimport { ChessboardError, ValidationError, ConfigurationError } from '../errors/ChessboardError.js';\nimport { PerformanceMonitor } from '../utils/performance.js';\n\n/**\n * Main Chessboard class responsible for coordinating all services\n * Implements the Facade pattern to provide a unified interface\n * @class\n */\nclass Chessboard {\n    /**\n     * Creates a new Chessboard instance\n     * @param {Object} config - Configuration object\n     * @throws {ConfigurationError} If configuration is invalid\n     */\n    constructor(config) {\n        try {\n            // Initialize performance monitoring\n            this._performanceMonitor = new PerformanceMonitor();\n            this._performanceMonitor.startMeasure('chessboard-initialization');\n\n            // Validate and initialize configuration\n            this._validateAndInitializeConfig(config);\n\n            // Initialize services\n            this._initializeServices();\n\n            // Initialize the board\n            this._initialize();\n\n            this._performanceMonitor.endMeasure('chessboard-initialization');\n        } catch (error) {\n            this._handleConstructorError(error);\n        }\n        this._undoneMoves = [];\n        this._updateBoardPieces(true, true); // Forza popolamento DOM subito\n    }\n\n    /**\n     * Validates and initializes configuration\n     * @private\n     * @param {Object} config - Raw configuration object\n     * @throws {ConfigurationError} If configuration is invalid\n     */\n    _validateAndInitializeConfig(config) {\n        if (!config || typeof config !== 'object') {\n            throw new ConfigurationError('Configuration must be an object', 'config', config);\n        }\n\n        this.config = new ChessboardConfig(config);\n\n        // Validate required configuration\n        if (!this.config.id_div) {\n            throw new ConfigurationError('Configuration must include id_div', 'id_div', this.config.id_div);\n        }\n    }\n\n    /**\n     * Handles constructor errors gracefully\n     * @private\n     * @param {Error} error - Error that occurred during construction\n     */\n    _handleConstructorError(error) {\n        console.error('Chessboard initialization failed:', error);\n\n        // Clean up any partially initialized resources\n        this._cleanup();\n\n        // Re-throw with additional context\n        if (error instanceof ChessboardError) {\n            throw error;\n        } else {\n            throw new ChessboardError('Failed to initialize chessboard', 'INITIALIZATION_ERROR', {\n                originalError: error.message,\n                stack: error.stack\n            });\n        }\n    }\n\n    /**\n     * Cleans up any partially initialized resources (safe to call multiple times)\n     * @private\n     */\n    _cleanup() {\n        // Remove event listeners if present\n        if (this.eventService && typeof this.eventService.removeListeners === 'function') {\n            this.eventService.removeListeners();\n        }\n        // Clear timeouts\n        if (this._updateTimeout) {\n            clearTimeout(this._updateTimeout);\n            this._updateTimeout = null;\n        }\n        // Null all services\n        this.validationService = null;\n        this.coordinateService = null;\n        this.positionService = null;\n        this.boardService = null;\n        this.pieceService = null;\n        this.animationService = null;\n        this.moveService = null;\n        this.eventService = null;\n    }\n\n    /**\n     * Initializes all services\n     * @private\n     */\n    _initializeServices() {\n        // Core services\n        this.validationService = new ValidationService();\n        this.coordinateService = new CoordinateService(this.config);\n        this.positionService = new PositionService(this.config);\n        this.boardService = new BoardService(this.config);\n        this.pieceService = new PieceService(this.config);\n        this.animationService = new AnimationService(this.config);\n        this.moveService = new MoveService(this.config, this.positionService);\n        this.eventService = new EventService(\n            this.config,\n            this.boardService,\n            this.moveService,\n            this.coordinateService,\n            this\n        );\n\n        // State management\n        this._updateTimeout = null;\n        this._isAnimating = false;\n\n        // Bind methods to preserve context\n        this._boundUpdateBoardPieces = this._updateBoardPieces.bind(this);\n        this._boundOnSquareClick = this._onSquareClick.bind(this);\n        this._boundOnPieceHover = this._onPieceHover.bind(this);\n        this._boundOnPieceLeave = this._onPieceLeave.bind(this);\n    }\n\n    /**\n     * Initializes the board\n     * @private\n     */\n    _initialize() {\n        this._initParams();\n        this._setGame(this.config.position);\n        this._buildBoard();\n        this._buildSquares();\n        this._addListeners();\n        this._updateBoardPieces(true, true); // Initial position load\n    }\n\n    /**\n     * Initializes parameters and state\n     * @private\n     */\n    _initParams() {\n        // Reset state\n        this.eventService.setClicked(null);\n        this.eventService.setPromoting(false);\n        this.eventService.setAnimating(false);\n    }\n\n    /**\n     * Sets up the game with initial position\n     * @private\n     * @param {string|Object} position - Initial position\n     */\n    _setGame(position) {\n        this.positionService.setGame(position);\n    }\n\n    /**\n     * Builds the board DOM structure\n     * @private\n     * Best practice: always remove squares (destroy JS/DOM) before clearing the board container.\n     */\n    _buildBoard() {\n        // Debug: _buildBoard called\n        if (this._isUndoRedo) {\n            // Skip _buildBoard for undo/redo\n            return;\n        }\n        // Forza la pulizia completa del contenitore board (DOM)\n        const boardContainer = document.getElementById(this.config.id_div);\n        if (boardContainer) boardContainer.innerHTML = '';\n        // Force remove all pieces from all squares (no animation, best practice)\n        if (this.boardService && this.boardService.squares) {\n            Object.values(this.boardService.squares).forEach(sq => sq && sq.forceRemoveAllPieces && sq.forceRemoveAllPieces());\n        }\n        if (this.boardService && this.boardService.removeSquares) this.boardService.removeSquares();\n        if (this.boardService && this.boardService.removeBoard) this.boardService.removeBoard();\n        this.boardService.buildBoard();\n    }\n\n    /**\n     * Builds all squares on the board\n     * @private\n     */\n    _buildSquares() {\n        // Debug: _buildSquares called\n        if (this._isUndoRedo) {\n            // Skip _buildSquares for undo/redo\n            return;\n        }\n        if (this.boardService && this.boardService.removeSquares) {\n            this.boardService.removeSquares();\n        }\n        this.boardService.buildSquares((row, col) => {\n            return this.coordinateService.realCoord(row, col);\n        });\n    }\n\n    /**\n     * Adds event listeners to squares\n     * @private\n     */\n    _addListeners() {\n        this.eventService.addListeners(\n            this._boundOnSquareClick,\n            this._boundOnPieceHover,\n            this._boundOnPieceLeave\n        );\n    }\n\n    /**\n     * Handles square click events\n     * @private\n     * @param {Square} square - Clicked square\n     * @param {boolean} [animate=true] - Whether to animate\n     * @param {boolean} [dragged=false] - Whether triggered by drag\n     * @returns {boolean} True if successful\n     */\n    _onSquareClick(square, animate = true, dragged = false) {\n        return this.eventService.onClick(\n            square,\n            this._onMove.bind(this),\n            this._onSelect.bind(this),\n            this._onDeselect.bind(this),\n            animate,\n            dragged\n        );\n    }\n\n    /**\n     * Handles piece hover events\n     * @private\n     * @param {Square} square - Hovered square\n     */\n    _onPieceHover(square) {\n        if (this.config.hints && !this.eventService.getClicked()) {\n            // Only show hints if no square is selected\n            this._hintMoves(square);\n        }\n    }\n\n    /**\n     * Handles piece leave events\n     * @private\n     * @param {Square} square - Left square\n     */\n    _onPieceLeave(square) {\n        if (this.config.hints && !this.eventService.getClicked()) {\n            // Only remove hints if no square is selected\n            this._dehintMoves(square);\n        }\n    }\n\n    /**\n     * Handles move execution\n     * @private\n     * @param {Square} fromSquare - Source square\n     * @param {Square} toSquare - Target square\n     * @param {string} [promotion] - Promotion piece\n     * @param {boolean} [animate=true] - Whether to animate\n     * @returns {boolean} True if move was successful\n     */\n    _onMove(fromSquare, toSquare, promotion = null, animate = true) {\n        const move = new Move(fromSquare, toSquare, promotion);\n\n        // 1. Validate the move\n        if (!move.check() || (this.config.onlyLegalMoves && !move.isLegal(this.positionService.getGame()))) {\n            this._clearVisualState(); // Always clear state on invalid move\n            return false;\n        }\n\n        // 2. Check for promotion (if not already provided)\n        if (!move.hasPromotion() && this._requiresPromotion(move)) {\n            // Promotion is required but not provided, let the promotion handler take over.\n            // Do not execute the move here.\n            return false;\n        }\n\n        // 3. Execute the move\n        // The onMove callback is for the user to approve the move, not to execute it.\n        if (this.config.onMove(move)) {\n            this._executeMove(move, animate);\n            return true;\n        }\n\n        // 4. If user rejects the move, clear state\n        this._clearVisualState();\n        return false;\n    }\n\n    /**\n     * Handles square selection\n     * @private\n     * @param {Square} square - Selected square\n     */\n    _onSelect(square) {\n        if (this.config.clickable) {\n            square.select();\n            this._hintMoves(square);\n        }\n    }\n\n    /**\n     * Handles square deselection\n     * @private\n     * @param {Square} square - Deselected square\n     */\n    _onDeselect(square) {\n        this._clearVisualState();\n    }\n\n    /**\n     * Shows legal move hints for a square\n     * @private\n     * @param {Square} square - Square to show hints for\n     */\n    _hintMoves(square) {\n        if (!this.moveService.canMove(square)) return;\n\n        // Clear existing hints first\n        this.boardService.applyToAllSquares('removeHint');\n\n        const moves = this.moveService.getCachedLegalMoves(square);\n\n        for (const move of moves) {\n            if (move.to && move.to.length === 2) {\n                const targetSquare = this.boardService.getSquare(move.to);\n                if (targetSquare) {\n                    const hasEnemyPiece = targetSquare.piece &&\n                        targetSquare.piece.color !== this.positionService.getGame().turn();\n                    targetSquare.putHint(hasEnemyPiece);\n                }\n            }\n        }\n    }\n\n    /**\n     * Removes legal move hints for a square\n     * @private\n     * @param {Square} square - Square to remove hints for\n     */\n    _dehintMoves(square) {\n        const moves = this.moveService.getCachedLegalMoves(square);\n\n        for (const move of moves) {\n            if (move.to && move.to.length === 2) {\n                const targetSquare = this.boardService.getSquare(move.to);\n                if (targetSquare) {\n                    targetSquare.removeHint();\n                }\n            }\n        }\n    }\n\n    /**\n     * Checks if a move requires promotion\n     * @private\n     * @param {Move} move - Move to check\n     * @returns {boolean} True if promotion is required\n     */\n    _requiresPromotion(move) {\n        return this.moveService.requiresPromotion(move);\n    }\n\n    /**\n     * Executes a move\n     * @private\n     * @param {Move} move - Move to execute\n     * @param {boolean} [animate=true] - Whether to animate\n     */\n    _executeMove(move, animate = true) {\n        // Always clear visual state before executing a move to prevent artifacts\n        this._clearVisualState();\n\n        const game = this.positionService.getGame();\n        if (!game) {\n            throw new ChessboardError('Game not initialized', 'GAME_ERROR');\n        }\n\n        // Execute the move on the game engine\n        const gameMove = this.moveService.executeMove(move);\n        if (!gameMove) {\n            // This should not happen if validation passed, but as a safeguard:\n            console.error('Move execution failed unexpectedly for move:', move);\n            this._updateBoardPieces(false); // Sync board with game state\n            return;\n        }\n\n        // Clear previous move highlights\n        this.boardService.applyToAllSquares('unmoved');\n        \n        // Mark squares as moved for styling\n        move.from.moved();\n        move.to.moved();\n\n        // Handle animations and special moves (castle, en-passant)\n        const isCastle = this.moveService.isCastle(gameMove);\n        const isEnPassant = this.moveService.isEnPassant(gameMove);\n\n        if (animate && move.from.piece) {\n            this.pieceService.translatePiece(\n                move,\n                !!move.to.piece, // was there a capture?\n                animate,\n                this._createDragFunction.bind(this),\n                () => {\n                    // After the main piece animation completes...\n                    if (isCastle) {\n                        this._handleSpecialMoveAnimation(gameMove);\n                    } else if (isEnPassant) {\n                        this._handleSpecialMoveAnimation(gameMove);\n                    }\n                    // Notify user that the move is fully complete\n                    this.config.onMoveEnd(gameMove);\n                    // A final sync to ensure board is perfect\n                    this._updateBoardPieces(false);\n                }\n            );\n\n            // For simultaneous castle, animate the rook alongside the king\n            if (isCastle && this.config.animationStyle === 'simultaneous') {\n                setTimeout(() => {\n                    this._handleCastleMove(gameMove, true);\n                }, this.config.simultaneousAnimationDelay);\n            }\n        } else {\n            // If not animating, handle special moves immediately and update the board\n            if (isCastle) {\n                this._handleSpecialMove(gameMove);\n            } else if (isEnPassant) {\n                this._handleSpecialMove(gameMove);\n            }\n            this._updateBoardPieces(false);\n            this.config.onMoveEnd(gameMove);\n        }\n    }\n\n    /**\n     * Handles special moves (castle, en passant) without animation\n     * @private\n     * @param {Object} gameMove - Game move object\n     */\n    _handleSpecialMove(gameMove) {\n        if (this.moveService.isCastle(gameMove)) {\n            this._handleCastleMove(gameMove, false);\n        } else if (this.moveService.isEnPassant(gameMove)) {\n            this._handleEnPassantMove(gameMove, false);\n        }\n    }\n\n    /**\n     * Handles special moves (castle, en passant) with animation\n     * @private\n     * @param {Object} gameMove - Game move object\n     */\n    _handleSpecialMoveAnimation(gameMove) {\n        if (this.moveService.isCastle(gameMove)) {\n            this._handleCastleMove(gameMove, true);\n        } else if (this.moveService.isEnPassant(gameMove)) {\n            this._handleEnPassantMove(gameMove, true);\n        }\n    }\n\n    /**\n     * Handles castle move by moving the rook\n     * @private\n     * @param {Object} gameMove - Game move object\n     * @param {boolean} animate - Whether to animate\n     */\n    _handleCastleMove(gameMove, animate) {\n        const rookMove = this.moveService.getCastleRookMove(gameMove);\n        if (!rookMove) return;\n\n        const rookFromSquare = this.boardService.getSquare(rookMove.from);\n        const rookToSquare = this.boardService.getSquare(rookMove.to);\n\n        if (!rookFromSquare || !rookToSquare || !rookFromSquare.piece) {\n            console.warn('Castle rook move failed - squares or piece not found');\n            return;\n        }\n\n        if (animate) {\n            // Always use translatePiece for smooth sliding animation\n            const rookPiece = rookFromSquare.piece;\n            this.pieceService.translatePiece(\n                { from: rookFromSquare, to: rookToSquare, piece: rookPiece },\n                false, // No capture for rook in castle\n                animate,\n                this._createDragFunction.bind(this),\n                () => {\n                    // After rook animation, update board state\n                    this._updateBoardPieces(false);\n                }\n            );\n        } else {\n            // Just update the board state\n            this._updateBoardPieces(false);\n        }\n    }\n\n    /**\n     * Handles en passant move by removing the captured pawn\n     * @private\n     * @param {Object} gameMove - Game move object\n     * @param {boolean} animate - Whether to animate\n     */\n    _handleEnPassantMove(gameMove, animate) {\n        const capturedSquare = this.moveService.getEnPassantCapturedSquare(gameMove);\n        if (!capturedSquare) return;\n\n        const capturedSquareObj = this.boardService.getSquare(capturedSquare);\n        if (!capturedSquareObj || !capturedSquareObj.piece) {\n            console.warn('En passant captured square not found or empty');\n            return;\n        }\n\n        if (animate) {\n            // Animate the captured pawn removal\n            this.pieceService.removePieceFromSquare(capturedSquareObj, true);\n            // Update board state after animation\n            setTimeout(() => {\n                this._updateBoardPieces(false);\n            }, this.config.moveTime);\n        } else {\n            // Just update the board state\n            this._updateBoardPieces(false);\n        }\n    }\n\n    /**\n     * Updates board pieces to match game state\n     * @private\n     * @param {boolean} [animation=false] - Whether to animate\n     * @param {boolean} [isPositionLoad=false] - Whether this is a position load\n     */\n    _updateBoardPieces(animation = false, isPositionLoad = false) {\n        // Check if services are available\n        if (!this.positionService || !this.moveService || !this.eventService) {\n            return;\n        }\n\n        // Clear any pending update\n        if (this._updateTimeout) {\n            clearTimeout(this._updateTimeout);\n            this._updateTimeout = null;\n        }\n\n        // Clear moves cache\n        this.moveService.clearCache();\n\n        // Add small delay for click-to-move to avoid lag\n        if (animation && !this.eventService.getClicked()) {\n            this._updateTimeout = setTimeout(() => {\n                this._doUpdateBoardPieces(animation, isPositionLoad);\n                this._updateTimeout = null;\n\n                // Ensure hints are available for the next turn\n                this._ensureHintsAvailable();\n            }, 10);\n        } else {\n            this._doUpdateBoardPieces(animation, isPositionLoad);\n\n            // Ensure hints are available for the next turn\n            this._ensureHintsAvailable();\n        }\n    }\n\n    /**\n     * Ensures hints are available for the current turn\n     * @private\n     */\n    _ensureHintsAvailable() {\n        if (!this.config.hints) return;\n\n        // Small delay to ensure the board state is fully updated\n        setTimeout(() => {\n            // Clear any existing hints\n            this.boardService.applyToAllSquares('removeHint');\n\n            // The hints will be shown when the user hovers over pieces\n            // This just ensures the cache is ready\n            this.moveService.clearCache();\n        }, 50);\n    }\n\n    /**\n     * Updates board pieces after a delayed move\n     * @private\n     */\n    _updateBoardPiecesDelayed() {\n        this._updateBoardPieces(false);\n    }\n\n    /**\n     * Performs the actual board update\n     * @private\n     * @param {boolean} [animation=false] - Whether to animate\n     * @param {boolean} [isPositionLoad=false] - Whether this is a position load (affects delay)\n     */\n    _doUpdateBoardPieces(animation = false, isPositionLoad = false) {\n        // Skip update if we're in the middle of a promotion\n        if (this._isPromoting) {\n            return;\n        }\n\n        // Check if services are available\n        if (!this.positionService || !this.positionService.getGame()) {\n            return;\n        }\n\n        const squares = this.boardService.getAllSquares();\n        const gameStateBefore = this.positionService.getGame().fen();\n\n        // Determine which animation style to use\n        const useSimultaneous = this.config.animationStyle === 'simultaneous';\n\n        if (useSimultaneous) {\n            this._doSimultaneousUpdate(squares, gameStateBefore, isPositionLoad);\n        } else {\n            this._doSequentialUpdate(squares, gameStateBefore, animation);\n        }\n    }\n\n    /**\n     * Performs sequential piece updates (original behavior)\n     * @private\n     * @param {Object} squares - All squares\n     * @param {string} gameStateBefore - Game state before update\n     * @param {boolean} animation - Whether to animate\n     */\n    _doSequentialUpdate(squares, gameStateBefore, animation) {\n        // Mappa: squareId -> expectedPieceId\n        const expectedMap = {};\n        Object.values(squares).forEach(square => {\n            expectedMap[square.id] = this.positionService.getGamePieceId(square.id);\n        });\n\n        Object.values(squares).forEach(square => {\n            const expectedPieceId = expectedMap[square.id];\n            const currentPiece = square.piece;\n            const currentPieceId = currentPiece ? currentPiece.getId() : null;\n\n            // Se il pezzo attuale e quello atteso sono identici, non fare nulla\n            if (currentPieceId === expectedPieceId) {\n                return;\n            }\n\n            // Se c' un pezzo attuale ma non  quello atteso, rimuovilo\n            if (currentPiece && currentPieceId !== expectedPieceId) {\n                this.pieceService.removePieceFromSquare(square, animation);\n            }\n\n            // Se c' un pezzo atteso ma non  quello attuale, aggiungilo\n            if (expectedPieceId && currentPieceId !== expectedPieceId) {\n                const newPiece = this.pieceService.convertPiece(expectedPieceId);\n                this.pieceService.addPieceOnSquare(\n                    square,\n                    newPiece,\n                    animation,\n                    this._createDragFunction.bind(this)\n                );\n            }\n        });\n\n        this._addListeners();\n        const gameStateAfter = this.positionService.getGame().fen();\n        if (gameStateBefore !== gameStateAfter) {\n            this.config.onChange(gameStateAfter);\n        }\n    }\n\n    /**\n     * Performs simultaneous piece updates\n     * @private\n     * @param {Object} squares - All squares\n     * @param {string} gameStateBefore - Game state before update\n     * @param {boolean} [isPositionLoad=false] - Whether this is a position load\n     */\n    _doSimultaneousUpdate(squares, gameStateBefore, isPositionLoad = false) {\n        // Matching greedy per distanza minima, robusto\n        const currentMap = {};\n        const expectedMap = {};\n\n        Object.values(squares).forEach(square => {\n            const currentPiece = square.piece;\n            const expectedPieceId = this.positionService.getGamePieceId(square.id);\n            if (currentPiece) {\n                // Normalizza la chiave come 'color+type' lowercase\n                const key = (currentPiece.color + currentPiece.type).toLowerCase();\n                if (!currentMap[key]) currentMap[key] = [];\n                currentMap[key].push({ square, id: square.id });\n            }\n            if (expectedPieceId) {\n                // Normalizza la chiave come 'color+type' lowercase\n                const key = expectedPieceId.toLowerCase();\n                if (!expectedMap[key]) expectedMap[key] = [];\n                expectedMap[key].push({ square, id: square.id });\n            }\n        });\n\n        let animationsCompleted = 0;\n        let totalAnimations = 0;\n        const animationDelay = isPositionLoad ? 0 : this.config.simultaneousAnimationDelay;\n        let animationIndex = 0;\n\n        Object.keys(expectedMap).forEach(key => {\n            totalAnimations += Math.max((currentMap[key] || []).length, expectedMap[key].length);\n        });\n\n        if (totalAnimations === 0) {\n            this._addListeners();\n            const gameStateAfter = this.positionService.getGame().fen();\n            if (gameStateBefore !== gameStateAfter) {\n                this.config.onChange(gameStateAfter);\n            }\n            return;\n        }\n\n        const onAnimationComplete = () => {\n            animationsCompleted++;\n            if (animationsCompleted === totalAnimations) {\n                this._addListeners();\n                const gameStateAfter = this.positionService.getGame().fen();\n                if (gameStateBefore !== gameStateAfter) {\n                    this.config.onChange(gameStateAfter);\n                }\n            }\n        };\n\n        Object.keys(expectedMap).forEach(key => {\n            const fromList = (currentMap[key] || []).slice();\n            const toList = expectedMap[key].slice();\n\n            // 1. Costruisci matrice delle distanze\n            const distances = [];\n            for (let i = 0; i < fromList.length; i++) {\n                distances[i] = [];\n                for (let j = 0; j < toList.length; j++) {\n                    distances[i][j] = Math.abs(fromList[i].square.row - toList[j].square.row) +\n                        Math.abs(fromList[i].square.col - toList[j].square.col);\n                }\n            }\n\n            // 2. Matching greedy: abbina i pi vicini\n            const fromMatched = new Array(fromList.length).fill(false);\n            const toMatched = new Array(toList.length).fill(false);\n            const moves = [];\n\n            while (true) {\n                let minDist = Infinity, minI = -1, minJ = -1;\n                for (let i = 0; i < fromList.length; i++) {\n                    if (fromMatched[i]) continue;\n                    for (let j = 0; j < toList.length; j++) {\n                        if (toMatched[j]) continue;\n                        if (distances[i][j] < minDist) {\n                            minDist = distances[i][j];\n                            minI = i;\n                            minJ = j;\n                        }\n                    }\n                }\n                if (minI === -1 || minJ === -1) break;\n                // Se la posizione  la stessa, non fare nulla (pezzo unchanged)\n                if (fromList[minI].square === toList[minJ].square) {\n                    fromMatched[minI] = true;\n                    toMatched[minJ] = true;\n                    continue;\n                }\n                // Altrimenti, sposta il pezzo\n                moves.push({ from: fromList[minI].square, to: toList[minJ].square, piece: fromList[minI].square.piece });\n                fromMatched[minI] = true;\n                toMatched[minJ] = true;\n            }\n\n            // 3. Rimuovi i pezzi non abbinati (presenti solo in fromList)\n            for (let i = 0; i < fromList.length; i++) {\n                if (!fromMatched[i]) {\n                    setTimeout(() => {\n                        this.pieceService.removePieceFromSquare(fromList[i].square, true, onAnimationComplete);\n                    }, animationIndex * animationDelay);\n                    animationIndex++;\n                }\n            }\n\n            // 4. Aggiungi i pezzi non abbinati (presenti solo in toList)\n            for (let j = 0; j < toList.length; j++) {\n                if (!toMatched[j]) {\n                    setTimeout(() => {\n                        const newPiece = this.pieceService.convertPiece(key);\n                        this.pieceService.addPieceOnSquare(\n                            toList[j].square,\n                            newPiece,\n                            true,\n                            this._createDragFunction.bind(this),\n                            onAnimationComplete\n                        );\n                    }, animationIndex * animationDelay);\n                    animationIndex++;\n                }\n            }\n\n            // 5. Anima i movimenti\n            moves.forEach(move => {\n                setTimeout(() => {\n                    this.pieceService.translatePiece(\n                        move,\n                        false,\n                        true,\n                        this._createDragFunction.bind(this),\n                        onAnimationComplete\n                    );\n                }, animationIndex * animationDelay);\n                animationIndex++;\n            });\n        });\n    }\n\n    /**\n     * Analyzes position changes to determine optimal animation strategy\n     * @private\n     * @param {Object} squares - All squares\n     * @returns {Object} Analysis of changes\n     */\n    _analyzePositionChanges(squares) {\n        const currentPieces = new Map();\n        const expectedPieces = new Map();\n\n        // Map current and expected piece positions\n        Object.values(squares).forEach(square => {\n            const currentPiece = square.piece;\n            const expectedPieceId = this.positionService.getGamePieceId(square.id);\n\n            if (currentPiece) {\n                currentPieces.set(square.id, currentPiece.getId());\n            }\n\n            if (expectedPieceId) {\n                expectedPieces.set(square.id, expectedPieceId);\n            }\n        });\n\n        // Identify different types of changes\n        const moves = []; // Pieces that can slide to new positions\n        const removes = []; // Pieces that need to be removed\n        const adds = []; // Pieces that need to be added\n        const unchanged = []; // Pieces that stay in place\n\n        // First pass: identify pieces that don't need to move (same piece type on same square)\n        const processedSquares = new Set();\n\n        currentPieces.forEach((currentPieceId, square) => {\n            const expectedPieceId = expectedPieces.get(square);\n\n            if (currentPieceId === expectedPieceId) {\n                // Same piece type on same square - no movement needed\n                unchanged.push({\n                    piece: currentPieceId,\n                    square\n                });\n                processedSquares.add(square);\n            }\n        });\n\n        // Second pass: handle pieces that need to move or be removed\n        currentPieces.forEach((currentPieceId, fromSquare) => {\n            if (processedSquares.has(fromSquare)) {\n                return; // Already processed as unchanged\n            }\n\n            // Try to find a destination for this piece\n            const availableDestination = Array.from(expectedPieces.entries()).find(([toSquare, expectedId]) =>\n                expectedId === currentPieceId && !processedSquares.has(toSquare)\n            );\n\n            if (availableDestination) {\n                const [toSquare, expectedId] = availableDestination;\n                moves.push({\n                    piece: currentPieceId,\n                    from: fromSquare,\n                    to: toSquare,\n                    fromSquare: squares[fromSquare],\n                    toSquare: squares[toSquare]\n                });\n                processedSquares.add(toSquare);\n            } else {\n                // This piece needs to be removed\n                removes.push({\n                    piece: currentPieceId,\n                    square: fromSquare,\n                    squareObj: squares[fromSquare]\n                });\n            }\n        });\n\n        // Third pass: handle pieces that need to be added\n        expectedPieces.forEach((expectedPieceId, toSquare) => {\n            if (!processedSquares.has(toSquare)) {\n                adds.push({\n                    piece: expectedPieceId,\n                    square: toSquare,\n                    squareObj: squares[toSquare]\n                });\n            }\n        });\n\n        return {\n            moves,\n            removes,\n            adds,\n            unchanged,\n            totalChanges: moves.length + removes.length + adds.length\n        };\n    }\n\n    /**\n     * Executes simultaneous changes based on analysis\n     * @private\n     * @param {Object} changeAnalysis - Analysis of changes\n     * @param {string} gameStateBefore - Game state before update\n     * @param {boolean} [isPositionLoad=false] - Whether this is a position load\n     */\n    _executeSimultaneousChanges(changeAnalysis, gameStateBefore, isPositionLoad = false) {\n        const { moves, removes, adds } = changeAnalysis;\n\n        let animationsCompleted = 0;\n        const totalAnimations = moves.length + removes.length + adds.length;\n\n        // If no animations are needed, complete immediately\n        if (totalAnimations === 0) {\n            this._addListeners();\n\n            // Trigger change event if position changed\n            const gameStateAfter = this.positionService.getGame().fen();\n            if (gameStateBefore !== gameStateAfter) {\n                this.config.onChange(gameStateAfter);\n            }\n            return;\n        }\n\n        const onAnimationComplete = () => {\n            animationsCompleted++;\n            if (animationsCompleted === totalAnimations) {\n                this._addListeners();\n\n                // Trigger change event if position changed\n                const gameStateAfter = this.positionService.getGame().fen();\n                if (gameStateBefore !== gameStateAfter) {\n                    this.config.onChange(gameStateAfter);\n                }\n            }\n        };\n\n        // Determine delay: 0 for position loads, configured delay for normal moves\n        const animationDelay = isPositionLoad ? 0 : this.config.simultaneousAnimationDelay;\n\n        let animationIndex = 0;\n\n        // Process moves (pieces sliding to new positions)\n        moves.forEach(move => {\n            const delay = animationIndex * animationDelay;\n\n            setTimeout(() => {\n                this._animatePieceMove(move, onAnimationComplete);\n            }, delay);\n\n            animationIndex++;\n        });\n\n        // Process removes (pieces disappearing)\n        removes.forEach(remove => {\n            const delay = animationIndex * animationDelay;\n\n            setTimeout(() => {\n                this._animatePieceRemoval(remove, onAnimationComplete);\n            }, delay);\n\n            animationIndex++;\n        });\n\n        // Process adds (pieces appearing)\n        adds.forEach(add => {\n            const delay = animationIndex * animationDelay;\n\n            setTimeout(() => {\n                this._animatePieceAddition(add, onAnimationComplete);\n            }, delay);\n\n            animationIndex++;\n        });\n    }\n\n    /**\n     * Animates a piece moving from one square to another\n     * @private\n     * @param {Object} move - Move information\n     * @param {Function} onComplete - Callback when animation completes\n     */\n    _animatePieceMove(move, onComplete) {\n        const { fromSquare, toSquare } = move;\n        const piece = fromSquare.piece;\n\n        if (!piece) {\n            console.warn(`No piece found on ${move.from} for move animation`);\n            onComplete();\n            return;\n        }\n\n        // Use translatePiece for smooth sliding animation\n        this.pieceService.translatePiece(\n            { from: fromSquare, to: toSquare, piece },\n            false, // Assume no capture for now\n            true, // Always animate\n            this._createDragFunction.bind(this),\n            onComplete\n        );\n    }\n\n    /**\n     * Animates a piece being removed\n     * @private\n     * @param {Object} remove - Remove information\n     * @param {Function} onComplete - Callback when animation completes\n     */\n    _animatePieceRemoval(remove, onComplete) {\n        this.pieceService.removePieceFromSquare(remove.squareObj, true, onComplete);\n    }\n\n    /**\n     * Animates a piece being added\n     * @private\n     * @param {Object} add - Add information\n     * @param {Function} onComplete - Callback when animation completes\n     */\n    _animatePieceAddition(add, onComplete) {\n        const newPiece = this.pieceService.convertPiece(add.piece);\n        this.pieceService.addPieceOnSquare(\n            add.squareObj,\n            newPiece,\n            true,\n            this._createDragFunction.bind(this),\n            onComplete\n        );\n    }\n\n    /**\n     * Creates a drag function for a piece\n     * @private\n     * @param {Square} square - Square containing the piece\n     * @param {Piece} piece - Piece to create drag function for\n     * @returns {Function} Drag function\n     */\n    _createDragFunction(square, piece) {\n        return this.eventService.createDragFunction(\n            square,\n            piece,\n            this.config.onDragStart,\n            this.config.onDragMove,\n            this.config.onDrop,\n            this._onSnapback.bind(this),\n            this._onMove.bind(this),\n            this._onRemove.bind(this)\n        );\n    }\n\n    /**\n     * Handles snapback animation\n     * @private\n     * @param {Square} square - Square containing the piece\n     * @param {Piece} piece - Piece to snapback\n     */\n    _onSnapback(square, piece) {\n        this.pieceService.snapbackPiece(square, this.config.snapbackAnimation);\n        this.config.onSnapbackEnd(square, piece);\n    }\n\n    /**\n     * Handles piece removal\n     * @private\n     * @param {Square} square - Square containing the piece to remove\n     */\n    _onRemove(square) {\n        this.pieceService.removePieceFromSquare(square, true);\n        this.positionService.getGame().remove(square.id);\n        this._updateBoardPieces(true);\n    }\n\n    /**\n     * Clears all visual state (selections, hints, highlights)\n     * @private\n     */\n    _clearVisualState() {\n        this.boardService.applyToAllSquares('deselect');\n        this.boardService.applyToAllSquares('removeHint');\n        this.boardService.applyToAllSquares('dehighlight');\n        this.eventService.setClicked(null);\n    }\n\n    // -------------------\n    // Public API Methods (Refactored)\n    // -------------------\n\n    // --- POSITION & STATE ---\n    /**\n     * Get the current position as FEN\n     * @returns {string}\n     */\n    getPosition() { return this.fen(); }\n    /**\n     * Set the board position (FEN or object)\n     * @param {string|Object} position\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     * @returns {boolean}\n     */\n    setPosition(position, opts = {}) {\n        const animate = opts.animate !== undefined ? opts.animate : true;\n        // Remove highlights and selections\n        if (this.boardService && this.boardService.applyToAllSquares) {\n            this.boardService.applyToAllSquares('removeHint');\n            this.boardService.applyToAllSquares('deselect');\n            this.boardService.applyToAllSquares('unmoved');\n        }\n        if (this.positionService && this.positionService.setGame) {\n            this.positionService.setGame(position);\n        }\n        if (this._updateBoardPieces) {\n            this._updateBoardPieces(animate, true);\n        }\n        return true;\n    }\n    /**\n     * Reset the board to the starting position\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     * @returns {boolean}\n     */\n    reset(opts = {}) {\n        const animate = opts.animate !== undefined ? opts.animate : true;\n        // Use the default starting position from config or fallback\n        const startPosition = this.config && this.config.position ? this.config.position : 'start';\n        this._updateBoardPieces(animate);\n        return this.setPosition(startPosition, { animate });\n    }\n    /**\n     * Clear the board\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     * @returns {boolean}\n     */\n    clear(opts = {}) {\n        const animate = opts.animate !== undefined ? opts.animate : true;\n        if (!this.positionService || !this.positionService.getGame()) {\n            return false;\n        }\n        if (this._clearVisualState) this._clearVisualState();\n        this.positionService.getGame().clear();\n        if (this._updateBoardPieces) {\n            this._updateBoardPieces(animate, true);\n        }\n        return true;\n    }\n\n    // --- MOVE MANAGEMENT ---\n    /**\n     * Undo last move\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     * @returns {boolean}\n     */\n    undoMove(opts = {}) {\n        const undone = this.positionService.getGame().undo();\n        if (undone) {\n            this._undoneMoves.push(undone);\n            this._updateBoardPieces(opts.animate !== false);\n            return undone;\n        }\n        return null;\n    }\n    /**\n     * Redo last undone move\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     * @returns {boolean}\n     */\n    redoMove(opts = {}) {\n        if (this._undoneMoves && this._undoneMoves.length > 0) {\n            const move = this._undoneMoves.pop();\n            const moveObj = { from: move.from, to: move.to };\n            if (move.promotion) moveObj.promotion = move.promotion;\n            const result = this.positionService.getGame().move(moveObj);\n            this._updateBoardPieces(opts.animate !== false);\n            return result;\n        }\n        return false;\n    }\n    /**\n     * Get legal moves for a square\n     * @param {string} square\n     * @returns {Array}\n     */\n    getLegalMoves(square) { return this.legalMoves(square); }\n\n    // --- PIECE MANAGEMENT ---\n    /**\n     * Get the piece at a square\n     * @param {string} square\n     * @returns {string|null}\n     */\n    getPiece(square) {\n        // Restituisce sempre 'wq' (colore prima, tipo dopo, lowercase) o null\n        const sq = this.boardService.getSquare(square);\n        if (!sq) return null;\n        const piece = sq.piece;\n        if (!piece) return null;\n        return (piece.color + piece.type).toLowerCase();\n    }\n    /**\n     * Put a piece on a square\n     * @param {string} piece\n     * @param {string} square\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     * @returns {boolean}\n     */\n    putPiece(piece, square, opts = {}) {\n        const animate = opts.animate !== undefined ? opts.animate : true;\n        let pieceStr = piece;\n        if (typeof piece === 'object' && piece.type && piece.color) {\n            pieceStr = (piece.color + piece.type).toLowerCase();\n        } else if (typeof piece === 'string' && piece.length === 2) {\n            // Accetta sia 'wq' che 'qw', normalizza a 'wq'\n            const a = piece[0].toLowerCase();\n            const b = piece[1].toLowerCase();\n            const types = 'kqrbnp';\n            const colors = 'wb';\n            if (types.includes(a) && colors.includes(b)) {\n                pieceStr = b + a;\n            } else if (colors.includes(a) && types.includes(b)) {\n                pieceStr = a + b;\n            } else {\n                throw new Error(`[putPiece] Invalid piece: ${piece}`);\n            }\n        }\n        const validSquare = this.validationService.isValidSquare(square);\n        const validPiece = this.validationService.isValidPiece(pieceStr);\n        if (!validSquare) throw new Error(`[putPiece] Invalid square: ${square}`);\n        if (!validPiece) throw new Error(`[putPiece] Invalid piece: ${pieceStr}`);\n        if (!this.positionService || !this.positionService.getGame()) {\n            throw new Error('[putPiece] No positionService or game');\n        }\n        const pieceObj = this.pieceService.convertPiece(pieceStr);\n        const squareObj = this.boardService.getSquare(square);\n        if (!squareObj) throw new Error(`[putPiece] Square not found: ${square}`);\n        squareObj.piece = pieceObj;\n        const chessJsPiece = { type: pieceObj.type, color: pieceObj.color };\n        const game = this.positionService.getGame();\n        const result = game.put(chessJsPiece, square);\n        if (!result) throw new Error(`[putPiece] Game.put failed for ${pieceStr} on ${square}`);\n        this._updateBoardPieces(animate);\n        return true;\n    }\n    /**\n     * Remove a piece from a square\n     * @param {string} square\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     * @returns {string|null}\n     */\n    removePiece(square, opts = {}) {\n        const animate = opts.animate !== undefined ? opts.animate : true;\n        if (!this.validationService.isValidSquare(square)) {\n            throw new Error(`[removePiece] Invalid square: ${square}`);\n        }\n        const squareObj = this.boardService.getSquare(square);\n        if (!squareObj) return true;\n        if (!squareObj.piece) return true;\n        squareObj.piece = null;\n        const game = this.positionService.getGame();\n        game.remove(square);\n        this._updateBoardPieces(animate);\n        return true;\n    }\n\n    // --- BOARD CONTROL ---\n    /**\n     * Flip the board orientation\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     */\n    flipBoard(opts = {}) {\n        if (this.coordinateService && this.coordinateService.flipOrientation) {\n            this.coordinateService.flipOrientation();\n        }\n        if (this._buildBoard) this._buildBoard();\n        if (this._buildSquares) this._buildSquares();\n        if (this._addListeners) this._addListeners();\n        if (this._updateBoardPieces) this._updateBoardPieces(opts.animate !== false);\n    }\n    /**\n     * Set the board orientation\n     * @param {'w'|'b'} color\n     * @param {Object} [opts]\n     * @param {boolean} [opts.animate=true]\n     */\n    setOrientation(color, opts = {}) {\n        if (this.validationService.isValidOrientation(color)) {\n            this.coordinateService.setOrientation(color);\n            if (this._buildBoard) this._buildBoard();\n            if (this._buildSquares) this._buildSquares();\n            if (this._addListeners) this._addListeners();\n            if (this._updateBoardPieces) this._updateBoardPieces(opts.animate !== false);\n        }\n        return this.coordinateService.getOrientation();\n    }\n    /**\n     * Get the current orientation\n     * @returns {'w'|'b'}\n     */\n    getOrientation() { return this.orientation(); }\n    /**\n     * Resize the board\n     * @param {number|string} size\n     */\n    resizeBoard(size) {\n        if (size === 'auto') {\n            this.config.size = 'auto';\n            document.documentElement.style.setProperty('--dimBoard', 'auto');\n            this._updateBoardPieces(false);\n            return true;\n        }\n        if (typeof size !== 'number' || size < 50 || size > 3000) {\n            throw new Error(`[resizeBoard] Invalid size: ${size}`);\n        }\n        this.config.size = size;\n        document.documentElement.style.setProperty('--dimBoard', `${size}px`);\n        this._updateBoardPieces(false);\n        return true;\n    }\n\n    // --- HIGHLIGHTING & UI ---\n    /**\n     * Highlight a square\n     * @param {string} square\n     * @param {Object} [opts]\n     */\n    highlight(square, opts = {}) {\n        if (!this.validationService.isValidSquare(square)) return;\n        if (this.boardService && this.boardService.highlightSquare) {\n            this.boardService.highlightSquare(square, opts);\n        } else if (this.eventService && this.eventService.highlightSquare) {\n            this.eventService.highlightSquare(square, opts);\n        }\n    }\n    /**\n     * Remove highlight from a square\n     * @param {string} square\n     * @param {Object} [opts]\n     */\n    dehighlight(square, opts = {}) {\n        if (!this.validationService.isValidSquare(square)) return;\n        if (this.boardService && this.boardService.dehighlightSquare) {\n            this.boardService.dehighlightSquare(square, opts);\n        } else if (this.eventService && this.eventService.dehighlightSquare) {\n            this.eventService.dehighlightSquare(square, opts);\n        }\n    }\n\n    // --- GAME INFO ---\n    /**\n     * Get FEN string\n     * @returns {string}\n     */\n    fen() {\n        // Avoid recursion: call the underlying game object's fen()\n        const game = this.positionService.getGame();\n        if (!game || typeof game.fen !== 'function') return '';\n        return game.fen();\n    }\n    /**\n     * Get current turn\n     * @returns {'w'|'b'}\n     */\n    turn() { return this.positionService.getGame().turn(); }\n    /**\n     * Is the game over?\n     * @returns {boolean}\n     */\n    isGameOver() {\n        const game = this.positionService.getGame();\n        if (!game) return false;\n        if (game.isGameOver) return game.isGameOver();\n        // Fallback: checkmate or draw\n        if (game.isCheckmate && game.isCheckmate()) return true;\n        if (game.isDraw && game.isDraw()) return true;\n        return false;\n    }\n    /**\n     * Is it checkmate?\n     * @returns {boolean}\n     */\n    isCheckmate() {\n        const game = this.positionService.getGame();\n        if (!game) return false;\n        return game.isCheckmate ? game.isCheckmate() : false;\n    }\n    /**\n     * Is it draw?\n     * @returns {boolean}\n     */\n    isDraw() {\n        const game = this.positionService.getGame();\n        if (!game) return false;\n        return game.isDraw ? game.isDraw() : false;\n    }\n    /**\n     * Get move history\n     * @returns {Array}\n     */\n    getHistory() {\n        const game = this.positionService.getGame();\n        if (!game) return [];\n        return game.history ? game.history() : [];\n    }\n\n    // --- LIFECYCLE ---\n    /**\n     * Destroy the board and cleanup all resources\n     */\n    destroyBoard() {\n        // Remove all event listeners\n        if (this.eventService && typeof this.eventService.removeListeners === 'function') {\n            this.eventService.removeListeners();\n        }\n\n        // Clear all timeouts\n        if (this._updateTimeout) {\n            clearTimeout(this._updateTimeout);\n            this._updateTimeout = null;\n        }\n\n        // Clear the DOM\n        const boardContainer = document.getElementById(this.config.id_div);\n        if (boardContainer) {\n            boardContainer.innerHTML = '';\n        }\n\n        // Remove all pieces from squares\n        if (this.boardService && this.boardService.squares) {\n            Object.values(this.boardService.squares).forEach(sq => {\n                if (sq && sq.forceRemoveAllPieces) {\n                    sq.forceRemoveAllPieces();\n                }\n            });\n        }\n\n        // Clean up board service\n        if (this.boardService) {\n            if (this.boardService.removeSquares) this.boardService.removeSquares();\n            if (this.boardService.removeBoard) this.boardService.removeBoard();\n        }\n\n        // Null all services for garbage collection\n        this.validationService = null;\n        this.coordinateService = null;\n        this.positionService = null;\n        this.boardService = null;\n        this.pieceService = null;\n        this.animationService = null;\n        this.moveService = null;\n        this.eventService = null;\n\n        // Clear performance monitor\n        this._performanceMonitor = null;\n\n        // Clear state\n        this._undoneMoves = null;\n        this._boundUpdateBoardPieces = null;\n        this._boundOnSquareClick = null;\n        this._boundOnPieceHover = null;\n        this._boundOnPieceLeave = null;\n    }\n    /**\n     * Rebuild the board\n     */\n    rebuild() { this._initialize(); }\n\n    // --- CONFIGURATION ---\n    /**\n     * Get current config\n     * @returns {Object}\n     */\n    getConfig() { return this.config; }\n    /**\n     * Set new config\n     * @param {Object} newConfig\n     */\n    updateConfig(newConfig) {\n        if (this.config && typeof this.config.update === 'function') {\n            this.config.update(newConfig);\n        }\n        if (newConfig.size !== undefined) {\n            this.resizeBoard(newConfig.size);\n        }\n        if (newConfig.orientation !== undefined) {\n            this.setOrientation(newConfig.orientation);\n        }\n    }\n\n    // --- ALIASES/DEPRECATED ---\n    /**\n     * Alias for move (deprecated)\n     */\n    move(move, animate = true) {\n        // On any new move, clear the redo stack\n        this._undoneMoves = [];\n        return this.movePiece(move, { animate });\n    }\n    /**\n     * Alias for clear (deprecated)\n     */\n    clearBoard(animate = true) {\n        this._updateBoardPieces(animate);\n        return this.clear({ animate });\n    }\n    /**\n     * Alias for reset (deprecated)\n     */\n    start(animate = true) {\n        this._updateBoardPieces(animate);\n        return this.reset({ animate });\n    }\n\n    /**\n     * Alias for flipBoard (for backward compatibility)\n     */\n    flip(opts = {}) {\n        this._updateBoardPieces(opts.animate !== false);\n        return this.flipBoard(opts);\n    }\n\n    /**\n     * Gets or sets the current position\n     * @param {string|Object} [newPosition] - New position (optional)\n     * @param {boolean} [animate=true] - Whether to animate\n     * @returns {Object|void} Position object if getter, void if setter\n     */\n    getOrSetPosition(newPosition, animate = true) {\n        if (newPosition === undefined) {\n            return this.positionService.getPosition();\n        }\n        this.load(newPosition, {}, animate);\n    }\n\n    /**\n     * Undoes the last move\n     * @param {boolean} [animate=true] - Whether to animate\n     * @returns {boolean} True if undo was successful\n     */\n    undo(animate = true) {\n        const undone = this.positionService.getGame().undo();\n        if (undone) {\n            this._undoneMoves.push(undone);\n            this._updateBoardPieces(animate);\n            return undone;\n        }\n        return null;\n    }\n\n    /**\n     * Redoes the last undone move\n     * @param {boolean} [animate=true] - Whether to animate\n     * @returns {boolean} True if redo was successful\n     */\n    redo(animate = true) {\n        if (this._undoneMoves && this._undoneMoves.length > 0) {\n            const move = this._undoneMoves.pop();\n            const moveObj = { from: move.from, to: move.to };\n            if (move.promotion) moveObj.promotion = move.promotion;\n            const result = this.positionService.getGame().move(moveObj);\n            this._updateBoardPieces(animate);\n            return result;\n        }\n        return false;\n    }\n\n    /**\n     * Gets the game history\n     * @returns {Array} Array of moves\n     */\n    history() {\n        return this.positionService.getGame().history();\n    }\n\n    /**\n     * Gets the current game state\n     * @returns {Object} Game state object\n     */\n    game() {\n        return this.positionService.getGame();\n    }\n\n    /**\n     * Gets or sets the orientation\n     * @param {string} [orientation] - New orientation\n     * @returns {string} Current orientation\n     */\n    orientation(orientation) {\n        if (orientation === undefined) {\n            return this.coordinateService.getOrientation();\n        }\n\n        if (this.validationService.isValidOrientation(orientation)) {\n            this.coordinateService.setOrientation(orientation);\n            this.flip();\n        }\n\n        return this.coordinateService.getOrientation();\n    }\n\n    /**\n     * Gets or sets the size\n     * @param {number|string} [size] - New size\n     * @returns {number|string} Current size\n     */\n    size(size) {\n        if (size === undefined) {\n            return this.config.size;\n        }\n\n        if (this.validationService.isValidSize(size)) {\n            this.config.size = size;\n            this.resize(size);\n        }\n\n        return this.config.size;\n    }\n\n    /**\n     * Gets legal moves for a square\n     * @param {string} square - Square to get moves for\n     * @returns {Array} Array of legal moves\n     */\n    legalMoves(square) {\n        const squareObj = this.boardService.getSquare(square);\n        if (!squareObj) return [];\n\n        return this.moveService.getCachedLegalMoves(squareObj);\n    }\n\n    /**\n     * Checks if a move is legal\n     * @param {string|Object} move - Move to check\n     * @returns {boolean} True if move is legal\n     */\n    isLegal(move) {\n        const moveObj = typeof move === 'string' ? this.moveService.parseMove(move) : move;\n        if (!moveObj) return false;\n\n        const fromSquare = this.boardService.getSquare(moveObj.from);\n        const toSquare = this.boardService.getSquare(moveObj.to);\n\n        if (!fromSquare || !toSquare) return false;\n\n        const moveInstance = new Move(fromSquare, toSquare, moveObj.promotion);\n        return moveInstance.isLegal(this.positionService.getGame());\n    }\n\n    /**\n     * Checks if the current player is in check\n     * @returns {boolean} True if in check\n     */\n    inCheck() {\n        return this.positionService.getGame().inCheck();\n    }\n\n    /**\n     * Checks if the current player is in checkmate\n     * @returns {boolean} True if in checkmate\n     */\n    inCheckmate() {\n        return this.positionService.getGame().isCheckmate();\n    }\n\n    /**\n     * Checks if the game is in stalemate\n     * @returns {boolean} True if in stalemate\n     */\n    inStalemate() {\n        return this.positionService.getGame().isStalemate();\n    }\n\n    /**\n     * Checks if the game is drawn\n     * @returns {boolean} True if drawn\n     */\n    inDraw() {\n        return this.positionService.getGame().isDraw();\n    }\n\n    /**\n     * Checks if position is threefold repetition\n     * @returns {boolean} True if threefold repetition\n     */\n    inThreefoldRepetition() {\n        return this.positionService.getGame().isThreefoldRepetition();\n    }\n\n    /**\n     * Gets the PGN representation of the game\n     * @returns {string} PGN string\n     */\n    pgn() {\n        return this.positionService.getGame().pgn();\n    }\n\n    /**\n     * Loads a PGN string\n     * @param {string} pgn - PGN string to load\n     * @param {boolean} [animate=true] - Whether to animate\n     * @returns {boolean} True if loaded successfully\n     */\n    loadPgn(pgn, animate = true) {\n        try {\n            const success = this.positionService.getGame().loadPgn(pgn);\n            if (success) {\n                this._updateBoardPieces(animate, true); // Position load\n            }\n            return success;\n        } catch (error) {\n            console.error('Error loading PGN:', error);\n            return false;\n        }\n    }\n\n    /**\n     * Gets configuration options (alias for getConfig)\n     * @returns {Object} Configuration object\n     */\n    getConfigOptions() {\n        return this.config && typeof this.config.getConfig === 'function'\n            ? this.config.getConfig()\n            : this.config;\n    }\n\n    /**\n     * Updates configuration options (alias for updateConfig)\n     * @param {Object} newConfig - New configuration options\n     */\n    setConfigOptions(newConfig) {\n        this.updateConfig(newConfig);\n    }\n\n    /**\n     * Gets or sets the animation style\n     * @param {string} [style] - New animation style ('sequential' or 'simultaneous')\n     * @returns {string} Current animation style\n     */\n    animationStyle(style) {\n        if (style === undefined) {\n            return this.config.animationStyle;\n        }\n\n        if (this.validationService.isValidAnimationStyle(style)) {\n            this.config.animationStyle = style;\n        }\n\n        return this.config.animationStyle;\n    }\n\n    /**\n     * Gets or sets the simultaneous animation delay\n     * @param {number} [delay] - New delay in milliseconds\n     * @returns {number} Current delay\n     */\n    simultaneousAnimationDelay(delay) {\n        if (delay === undefined) {\n            return this.config.simultaneousAnimationDelay;\n        }\n\n        if (typeof delay === 'number' && delay >= 0) {\n            this.config.simultaneousAnimationDelay = delay;\n        }\n\n        return this.config.simultaneousAnimationDelay;\n    }\n\n    // Additional API methods would be added here following the same pattern\n    // This is a good starting point for the refactored architecture\n\n    // Ensure all public API methods from README are present and routed\n    insert(square, piece) { return this.putPiece(piece, square); }\n    get(square) { return this.getPiece(square); }\n    /**\n     * Legacy position method - use getPosition/setPosition instead\n     * @deprecated\n     */\n    position(positionArg, colorOrAnimate) {\n        if (positionArg === undefined) {\n            return this.positionService.getPosition();\n        }\n        if (typeof colorOrAnimate === 'string' && (colorOrAnimate === 'w' || colorOrAnimate === 'b')) {\n            this.setOrientation(colorOrAnimate);\n        }\n        return this.setPosition(positionArg, { animate: colorOrAnimate !== false });\n    }\n    // Legacy aliases (using arrow functions to avoid duplicate method names)\n    destroy() { return this.destroyBoard(); }\n    build() { return this._initialize(); }\n    resize(value) { return this.resizeBoard(value); }\n    piece(square) { return this.getPiece(square); }\n    ascii() { return this.positionService.getGame().ascii(); }\n    board() { return this.positionService.getGame().board(); }\n    getCastlingRights(color) { return this.positionService.getGame().getCastlingRights(color); }\n    getComment() { return this.positionService.getGame().getComment(); }\n    getComments() { return this.positionService.getGame().getComments(); }\n    lastMove() { return this.positionService.getGame().lastMove(); }\n    moveNumber() { return this.positionService.getGame().moveNumber(); }\n    moves(options = {}) { return this.positionService.getGame().moves(options); }\n    squareColor(squareId) { return this.boardService.getSquare(squareId).isWhite() ? 'light' : 'dark'; }\n    isDrawByFiftyMoves() { return this.positionService.getGame().isDrawByFiftyMoves(); }\n    isInsufficientMaterial() { return this.positionService.getGame().isInsufficientMaterial(); }\n    isStalemate() { return this.positionService.getGame().isStalemate(); }\n    isThreefoldRepetition() { return this.positionService.getGame().isThreefoldRepetition(); }\n    load(fen, options = {}, animation = true) { return this.setPosition(fen, { ...options, animate: animation }); }\n    put(pieceId, squareId, animation = true) {\n        console.debug('[put] called with:', { pieceId, squareId, animation });\n        let pieceObj = null;\n        // Helper to normalize string like 'wQ', 'Qw', 'Wq', 'qw', etc.\n        function parsePieceString(str) {\n            if (typeof str !== 'string' || str.length !== 2) return null;\n            const a = str[0].toLowerCase();\n            const b = str[1].toLowerCase();\n            const types = 'kqrbnp';\n            const colors = 'wb';\n            if (types.includes(a) && colors.includes(b)) {\n                return { type: a, color: b };\n            } else if (colors.includes(a) && types.includes(b)) {\n                return { type: b, color: a };\n            }\n            return null;\n        }\n        if (typeof pieceId === 'string') {\n            pieceObj = parsePieceString(pieceId);\n            console.debug('[put] parsed piece string:', pieceObj);\n            if (!pieceObj) {\n                console.error(`[put] Invalid piece string: '${pieceId}'. Use e.g. 'wQ', 'Qw', 'bK', 'kb'`);\n                return false;\n            }\n        } else if (typeof pieceId === 'object' && pieceId.type && pieceId.color) {\n            const type = String(pieceId.type).toLowerCase();\n            const color = String(pieceId.color).toLowerCase();\n            if ('kqrbnp'.includes(type) && 'wb'.includes(color)) {\n                pieceObj = { type, color };\n                console.debug('[put] normalized piece object:', pieceObj);\n            } else {\n                console.error(`[put] Invalid piece object: {type: '${pieceId.type}', color: '${pieceId.color}'}`);\n                return false;\n            }\n        } else {\n            console.error('[put] Invalid pieceId:', pieceId);\n            return false;\n        }\n        if (typeof squareId !== 'string' || squareId.length !== 2) {\n            console.error('[put] Invalid squareId:', squareId);\n            return false;\n        }\n        // Call the internal putPiece method\n        const result = this.putPiece(pieceObj, squareId, { animate: animation });\n        console.debug('[put] putPiece result:', result);\n        return result;\n    }\n    remove(squareId, animation = true) { return this.removePiece(squareId, { animate: animation }); }\n    removeComment() { return this.positionService.getGame().removeComment(); }\n    removeComments() { return this.positionService.getGame().removeComments(); }\n    removeHeader(field) { return this.positionService.getGame().removeHeader(field); }\n    setCastlingRights(color, rights) { return this.positionService.getGame().setCastlingRights(color, rights); }\n    setComment(comment) { return this.positionService.getGame().setComment(comment); }\n    setHeader(key, value) { return this.positionService.getGame().setHeader(key, value); }\n    validateFen(fen) { return this.positionService.getGame().validateFen(fen); }\n\n    // Implementazioni reali per highlight/dehighlight\n    highlightSquare(square) {\n        return this.boardService.highlight(square);\n    }\n    dehighlightSquare(square) {\n        return this.boardService.dehighlight(square);\n    }\n    forceSync() { this._updateBoardPieces(true, true); }\n}\n\nexport { Chessboard };\nexport default Chessboard;\n","/**\n * Chessboard factory for creating and managing chessboard instances\n * @module core/ChessboardFactory\n * @since 2.0.0\n */\n\nimport { Chessboard } from './Chessboard.js';\nimport { ChessboardConfig } from './ChessboardConfig.js';\nimport { ValidationService } from '../services/ValidationService.js';\nimport { ConfigurationError } from '../errors/ChessboardError.js';\nimport { logger } from '../utils/logger.js';\nimport { PerformanceMonitor } from '../utils/performance.js';\n\n/**\n * Factory class for creating and managing chessboard instances\n * Implements the Factory pattern with instance management\n * @class\n */\nexport class ChessboardFactory {\n    /**\n     * Creates a new ChessboardFactory instance\n     */\n    constructor() {\n        this.instances = new Map();\n        this.validationService = new ValidationService();\n        this.performanceMonitor = new PerformanceMonitor();\n        this.logger = logger.child('ChessboardFactory');\n        \n        // Default configuration templates\n        this.templates = new Map();\n        this._initializeDefaultTemplates();\n    }\n\n    /**\n     * Initializes default configuration templates\n     * @private\n     */\n    _initializeDefaultTemplates() {\n        // Basic template\n        this.templates.set('basic', {\n            size: 400,\n            draggable: true,\n            hints: true,\n            clickable: true,\n            moveHighlight: true,\n            animationStyle: 'simultaneous'\n        });\n\n        // Tournament template\n        this.templates.set('tournament', {\n            size: 500,\n            draggable: false,\n            hints: false,\n            clickable: true,\n            moveHighlight: true,\n            onlyLegalMoves: true,\n            animationStyle: 'sequential'\n        });\n\n        // Analysis template\n        this.templates.set('analysis', {\n            size: 600,\n            draggable: true,\n            hints: true,\n            clickable: true,\n            moveHighlight: true,\n            mode: 'analysis',\n            animationStyle: 'simultaneous'\n        });\n\n        // Puzzle template\n        this.templates.set('puzzle', {\n            size: 450,\n            draggable: true,\n            hints: true,\n            clickable: true,\n            moveHighlight: true,\n            onlyLegalMoves: true,\n            animationStyle: 'sequential'\n        });\n\n        // Demo template\n        this.templates.set('demo', {\n            size: 'auto',\n            draggable: false,\n            hints: false,\n            clickable: false,\n            moveHighlight: true,\n            animationStyle: 'simultaneous'\n        });\n    }\n\n    /**\n     * Creates a new chessboard instance\n     * @param {string} containerId - Container element ID\n     * @param {Object} [config={}] - Configuration options\n     * @param {string} [template] - Template name to use\n     * @returns {Chessboard} Chessboard instance\n     * @throws {ConfigurationError} If configuration is invalid\n     */\n    create(containerId, config = {}, template = null) {\n        this.performanceMonitor.startMeasure('chessboard-creation');\n        \n        try {\n            // Validate container ID\n            if (!containerId || typeof containerId !== 'string') {\n                throw new ConfigurationError('Container ID must be a non-empty string', 'containerId', containerId);\n            }\n\n            // Check if container exists\n            const container = document.getElementById(containerId);\n            if (!container) {\n                throw new ConfigurationError(`Container element not found: ${containerId}`, 'containerId', containerId);\n            }\n\n            // Merge configuration with template if specified\n            let finalConfig = { ...config };\n            if (template) {\n                const templateConfig = this.templates.get(template);\n                if (!templateConfig) {\n                    this.logger.warn(`Template \"${template}\" not found, using default configuration`);\n                } else {\n                    finalConfig = { ...templateConfig, ...config };\n                    this.logger.info(`Using template \"${template}\" for chessboard creation`);\n                }\n            }\n\n            // Set container ID\n            finalConfig.id = containerId;\n\n            // Validate configuration\n            this.validationService.validateConfig(finalConfig);\n\n            // Create chessboard instance\n            const chessboard = new Chessboard(finalConfig);\n\n            // Store instance for management\n            this.instances.set(containerId, {\n                instance: chessboard,\n                config: finalConfig,\n                template,\n                createdAt: new Date(),\n                container\n            });\n\n            this.performanceMonitor.endMeasure('chessboard-creation');\n            this.logger.info(`Created chessboard instance for container: ${containerId}`, {\n                template,\n                configKeys: Object.keys(finalConfig)\n            });\n\n            return chessboard;\n        } catch (error) {\n            this.performanceMonitor.endMeasure('chessboard-creation');\n            this.logger.error('Failed to create chessboard instance', { containerId, error });\n            throw error;\n        }\n    }\n\n    /**\n     * Creates a chessboard using a predefined template\n     * @param {string} containerId - Container element ID\n     * @param {string} templateName - Template name\n     * @param {Object} [overrides={}] - Configuration overrides\n     * @returns {Chessboard} Chessboard instance\n     */\n    createFromTemplate(containerId, templateName, overrides = {}) {\n        return this.create(containerId, overrides, templateName);\n    }\n\n    /**\n     * Gets an existing chessboard instance\n     * @param {string} containerId - Container element ID\n     * @returns {Chessboard|null} Chessboard instance or null if not found\n     */\n    getInstance(containerId) {\n        const instance = this.instances.get(containerId);\n        return instance ? instance.instance : null;\n    }\n\n    /**\n     * Gets information about an instance\n     * @param {string} containerId - Container element ID\n     * @returns {Object|null} Instance information or null if not found\n     */\n    getInstanceInfo(containerId) {\n        const instance = this.instances.get(containerId);\n        if (!instance) {\n            return null;\n        }\n\n        return {\n            containerId,\n            template: instance.template,\n            createdAt: instance.createdAt,\n            config: { ...instance.config }\n        };\n    }\n\n    /**\n     * Destroys a chessboard instance\n     * @param {string} containerId - Container element ID\n     * @returns {boolean} True if instance was destroyed, false if not found\n     */\n    destroy(containerId) {\n        const instance = this.instances.get(containerId);\n        if (!instance) {\n            this.logger.warn(`Instance not found for destruction: ${containerId}`);\n            return false;\n        }\n\n        try {\n            // Destroy the chessboard instance\n            instance.instance.destroy();\n            \n            // Remove from instances map\n            this.instances.delete(containerId);\n            \n            this.logger.info(`Destroyed chessboard instance: ${containerId}`);\n            return true;\n        } catch (error) {\n            this.logger.error(`Failed to destroy chessboard instance: ${containerId}`, { error });\n            return false;\n        }\n    }\n\n    /**\n     * Destroys all chessboard instances\n     */\n    destroyAll() {\n        const containerIds = Array.from(this.instances.keys());\n        let destroyed = 0;\n\n        for (const containerId of containerIds) {\n            if (this.destroy(containerId)) {\n                destroyed++;\n            }\n        }\n\n        this.logger.info(`Destroyed ${destroyed} chessboard instances`);\n    }\n\n    /**\n     * Lists all active chessboard instances\n     * @returns {Array} Array of instance information\n     */\n    listInstances() {\n        return Array.from(this.instances.keys()).map(containerId => \n            this.getInstanceInfo(containerId)\n        );\n    }\n\n    /**\n     * Registers a new configuration template\n     * @param {string} name - Template name\n     * @param {Object} config - Template configuration\n     * @throws {ConfigurationError} If template name or config is invalid\n     */\n    registerTemplate(name, config) {\n        if (!name || typeof name !== 'string') {\n            throw new ConfigurationError('Template name must be a non-empty string', 'name', name);\n        }\n\n        if (!config || typeof config !== 'object') {\n            throw new ConfigurationError('Template configuration must be an object', 'config', config);\n        }\n\n        // Validate template configuration\n        this.validationService.validateConfig(config);\n\n        this.templates.set(name, { ...config });\n        this.logger.info(`Registered template: ${name}`, { configKeys: Object.keys(config) });\n    }\n\n    /**\n     * Removes a configuration template\n     * @param {string} name - Template name\n     * @returns {boolean} True if template was removed, false if not found\n     */\n    removeTemplate(name) {\n        const removed = this.templates.delete(name);\n        if (removed) {\n            this.logger.info(`Removed template: ${name}`);\n        }\n        return removed;\n    }\n\n    /**\n     * Gets a configuration template\n     * @param {string} name - Template name\n     * @returns {Object|null} Template configuration or null if not found\n     */\n    getTemplate(name) {\n        const template = this.templates.get(name);\n        return template ? { ...template } : null;\n    }\n\n    /**\n     * Lists all available templates\n     * @returns {Array} Array of template names\n     */\n    listTemplates() {\n        return Array.from(this.templates.keys());\n    }\n\n    /**\n     * Creates multiple chessboard instances from a configuration array\n     * @param {Array} configurations - Array of configuration objects\n     * @returns {Array} Array of created chessboard instances\n     */\n    createMultiple(configurations) {\n        const instances = [];\n        const errors = [];\n\n        for (const config of configurations) {\n            try {\n                const { containerId, template, ...options } = config;\n                const instance = this.create(containerId, options, template);\n                instances.push({ containerId, instance, success: true });\n            } catch (error) {\n                errors.push({ containerId: config.containerId, error, success: false });\n                this.logger.error(`Failed to create instance for ${config.containerId}`, { error });\n            }\n        }\n\n        if (errors.length > 0) {\n            this.logger.warn(`Failed to create ${errors.length} out of ${configurations.length} instances`);\n        }\n\n        return { instances, errors };\n    }\n\n    /**\n     * Gets factory statistics\n     * @returns {Object} Factory statistics\n     */\n    getStats() {\n        const stats = {\n            activeInstances: this.instances.size,\n            availableTemplates: this.templates.size,\n            performance: this.performanceMonitor.getMetrics(),\n            validation: this.validationService.getCacheStats()\n        };\n\n        return stats;\n    }\n\n    /**\n     * Cleans up factory resources\n     */\n    cleanup() {\n        this.destroyAll();\n        this.validationService.destroy();\n        this.performanceMonitor.destroy();\n        this.templates.clear();\n    }\n}\n\n/**\n * Default factory instance\n * @type {ChessboardFactory}\n */\nexport const chessboardFactory = new ChessboardFactory();\n\n/**\n * Convenience method to create a chessboard instance\n * @param {string} containerId - Container element ID\n * @param {Object} [config={}] - Configuration options\n * @param {string} [template] - Template name to use\n * @returns {Chessboard} Chessboard instance\n */\nexport function createChessboard(containerId, config = {}, template = null) {\n    return chessboardFactory.create(containerId, config, template);\n}\n\n/**\n * Convenience method to create a chessboard from template\n * @param {string} containerId - Container element ID\n * @param {string} templateName - Template name\n * @param {Object} [overrides={}] - Configuration overrides\n * @returns {Chessboard} Chessboard instance\n */\nexport function createChessboardFromTemplate(containerId, templateName, overrides = {}) {\n    return chessboardFactory.createFromTemplate(containerId, templateName, overrides);\n}\n","/**\n * Chessboard.js - A beautiful, customizable chessboard widget\n * Entry point for the core library\n * @module core\n * @since 2.0.0\n */\n\nimport ChessboardClass from './Chessboard.js';\nimport ChessboardConfig from './ChessboardConfig.js';\nimport {\n    ChessboardFactory,\n    chessboardFactory,\n    createChessboard,\n    createChessboardFromTemplate\n} from './ChessboardFactory.js';\nimport { logger } from '../utils/logger.js';\n\n/**\n * Main Chessboard factory function for backward compatibility\n * Supports both legacy and modern calling conventions\n * @param {string|Object} containerElm - Container element ID or configuration object\n * @param {Object} [config={}] - Configuration options (when first param is string)\n * @returns {ChessboardClass} Chessboard instance\n */\nfunction Chessboard(containerElm, config = {}) {\n    const factoryLogger = logger.child('ChessboardFactory');\n\n    try {\n        // If first parameter is an object, treat it as config\n        if (typeof containerElm === 'object' && containerElm !== null) {\n            factoryLogger.debug('Creating chessboard with config object');\n            return new ChessboardClass(containerElm);\n        }\n\n        // Otherwise, treat first parameter as element ID\n        if (typeof containerElm === 'string') {\n            factoryLogger.debug('Creating chessboard with element ID', { elementId: containerElm });\n            const fullConfig = { ...config, id: containerElm };\n            return new ChessboardClass(fullConfig);\n        }\n\n        throw new Error('Invalid parameters: first parameter must be string or object');\n    } catch (error) {\n        factoryLogger.error('Failed to create chessboard instance', { error });\n        throw error;\n    }\n}\n\n/**\n * Wrapper class that handles both calling conventions\n * Provides enhanced error handling and logging\n * @class\n * @extends ChessboardClass\n */\nclass ChessboardWrapper extends ChessboardClass {\n    /**\n     * Creates a new ChessboardWrapper instance\n     * @param {string|Object} containerElm - Container element ID or configuration object\n     * @param {Object} [config={}] - Configuration options\n     */\n    constructor(containerElm, config = {}) {\n        const instanceLogger = logger.child('ChessboardWrapper');\n\n        try {\n            // If first parameter is an object, treat it as config\n            if (typeof containerElm === 'object' && containerElm !== null) {\n                instanceLogger.debug('Initializing with config object');\n                super(containerElm);\n            } else if (typeof containerElm === 'string') {\n                // Otherwise, treat first parameter as element ID\n                instanceLogger.debug('Initializing with element ID', { elementId: containerElm });\n                const fullConfig = { ...config, id: containerElm };\n                super(fullConfig);\n            } else {\n                throw new Error('Invalid constructor parameters');\n            }\n        } catch (error) {\n            instanceLogger.error('Failed to initialize ChessboardWrapper', { error });\n            throw error;\n        }\n    }\n}\n\n/**\n * Refactored Chessboard API - see Chessboard.js for full method docs\n * @typedef {import('./Chessboard.js').Chessboard} Chessboard\n */\n\n// --- STATIC/FACTORY METHODS ---\n/**\n * Create a new Chessboard instance\n * @param {string|Object} containerElm\n * @param {Object} [config]\n * @returns {Chessboard}\n */\nChessboard.create = createChessboard;\n/**\n * Create a Chessboard from a template\n * @param {string|Object} containerElm\n * @param {string} templateName\n * @param {Object} [config]\n * @returns {Chessboard}\n */\nChessboard.fromTemplate = createChessboardFromTemplate;\nChessboard.factory = chessboardFactory;\n\n// --- INSTANCE MANAGEMENT ---\nChessboard.getInstance = (containerId) => chessboardFactory.getInstance(containerId);\nChessboard.destroyInstance = (containerId) => chessboardFactory.destroy(containerId);\nChessboard.destroyAll = () => chessboardFactory.destroyAll();\nChessboard.listInstances = () => chessboardFactory.listInstances();\n\n// --- TEMPLATE MANAGEMENT ---\nChessboard.registerTemplate = (name, config) => chessboardFactory.registerTemplate(name, config);\nChessboard.removeTemplate = (name) => chessboardFactory.removeTemplate(name);\nChessboard.getTemplate = (name) => chessboardFactory.getTemplate(name);\nChessboard.listTemplates = () => chessboardFactory.listTemplates();\n\n// --- STATS & DEBUG ---\nChessboard.getStats = () => chessboardFactory.getStats();\n\n// --- DEPRECATED/LEGACY ALIASES ---\n/**\n * @deprecated Use Chessboard.create instead\n */\nChessboard.Class = ChessboardWrapper;\nChessboard.Chessboard = ChessboardWrapper;\nChessboard.Config = ChessboardConfig;\nChessboard.Factory = ChessboardFactory;\n\n// --- EXPORTS ---\nexport {\n    Chessboard,\n    ChessboardConfig,\n    ChessboardFactory,\n    chessboardFactory,\n    createChessboard,\n    createChessboardFromTemplate\n};\n\nexport default Chessboard;\n","/**\n * Coordinate utilities for Chessboard.js\n */\n\n/**\n * Convert algebraic notation to array coordinates\n * @param {string} square - Square in algebraic notation (e.g., 'a1', 'h8')\n * @returns {Object} Object with row and col properties\n */\nexport function algebraicToCoords(square) {\n  const file = square.charCodeAt(0) - 97; // 'a' = 0, 'b' = 1, etc.\n  const rank = parseInt(square[1]) - 1;    // '1' = 0, '2' = 1, etc.\n  \n  return { row: 7 - rank, col: file };\n}\n\n/**\n * Convert array coordinates to algebraic notation\n * @param {number} row - Row index (0-7)\n * @param {number} col - Column index (0-7)\n * @returns {string} Square in algebraic notation\n */\nexport function coordsToAlgebraic(row, col) {\n  const file = String.fromCharCode(97 + col); // 0 = 'a', 1 = 'b', etc.\n  const rank = (8 - row).toString();          // 0 = '8', 1 = '7', etc.\n  \n  return file + rank;\n}\n\n/**\n * Get the color of a square\n * @param {string} square - Square in algebraic notation\n * @returns {string} 'light' or 'dark'\n */\nexport function getSquareColor(square) {\n  const { row, col } = algebraicToCoords(square);\n  return (row + col) % 2 === 0 ? 'dark' : 'light';\n}\n\n/**\n * Check if coordinates are valid\n * @param {number} row - Row index\n * @param {number} col - Column index\n * @returns {boolean} True if coordinates are valid\n */\nexport function isValidCoords(row, col) {\n  return row >= 0 && row <= 7 && col >= 0 && col <= 7;\n}\n\n/**\n * Check if algebraic notation is valid\n * @param {string} square - Square in algebraic notation\n * @returns {boolean} True if square notation is valid\n */\nexport function isValidSquare(square) {\n  if (typeof square !== 'string' || square.length !== 2) return false;\n  \n  const file = square[0];\n  const rank = square[1];\n  \n  return file >= 'a' && file <= 'h' && rank >= '1' && rank <= '8';\n}\n","/**\n * Validation utilities for Chessboard.js\n * @module utils/validation\n * @since 2.0.0\n */\n\n// Re-export from coordinates utility\nexport { isValidSquare } from './coordinates.js';\n\n/**\n * Validation cache for performance optimization\n * @type {Map}\n */\nconst validationCache = new Map();\nconst CACHE_MAX_SIZE = 1000;\n\n/**\n * Caches validation result\n * @param {string} key - Cache key\n * @param {boolean} result - Validation result\n */\nfunction cacheResult(key, result) {\n    if (validationCache.size >= CACHE_MAX_SIZE) {\n        const firstKey = validationCache.keys().next().value;\n        validationCache.delete(firstKey);\n    }\n    validationCache.set(key, result);\n}\n\n/**\n * Validate piece notation with caching\n * @param {string} piece - Piece notation (e.g., 'wP', 'bK')\n * @returns {boolean} True if piece notation is valid\n */\nexport function isValidPiece(piece) {\n    if (typeof piece !== 'string' || piece.length !== 2) {\n        return false;\n    }\n    \n    const cacheKey = `piece:${piece}`;\n    if (validationCache.has(cacheKey)) {\n        return validationCache.get(cacheKey);\n    }\n    \n    const color = piece[0];\n    const type = piece[1];\n    \n    const isValid = ['w', 'b'].includes(color) && \n                   ['P', 'R', 'N', 'B', 'Q', 'K'].includes(type);\n    \n    cacheResult(cacheKey, isValid);\n    return isValid;\n}\n\n/**\n * Validate position object with comprehensive checks\n * @param {Object} position - Position object with square-piece mappings\n * @returns {boolean} True if position is valid\n */\nexport function isValidPosition(position) {\n    if (typeof position !== 'object' || position === null) {\n        return false;\n    }\n    \n    // Check for circular references\n    try {\n        JSON.stringify(position);\n    } catch (error) {\n        return false;\n    }\n    \n    // Validate each square-piece mapping\n    for (const [square, piece] of Object.entries(position)) {\n        if (!isValidSquare(square) || !isValidPiece(piece)) {\n            return false;\n        }\n    }\n    \n    // Optional: Check for chess-specific rules\n    return isValidChessPosition(position);\n}\n\n/**\n * Validates chess-specific position rules\n * @param {Object} position - Position object\n * @returns {boolean} True if position follows chess rules\n */\nfunction isValidChessPosition(position) {\n    const pieces = Object.values(position);\n    \n    // Count kings\n    const whiteKings = pieces.filter(p => p === 'wK').length;\n    const blackKings = pieces.filter(p => p === 'bK').length;\n    \n    // Must have exactly one king of each color\n    if (whiteKings !== 1 || blackKings !== 1) {\n        return false;\n    }\n    \n    // Count pawns (max 8 per side)\n    const whitePawns = pieces.filter(p => p === 'wP').length;\n    const blackPawns = pieces.filter(p => p === 'bP').length;\n    \n    if (whitePawns > 8 || blackPawns > 8) {\n        return false;\n    }\n    \n    // Check pawn placement (not on first or last rank)\n    for (const [square, piece] of Object.entries(position)) {\n        if (piece === 'wP' || piece === 'bP') {\n            const rank = square[1];\n            if (rank === '1' || rank === '8') {\n                return false;\n            }\n        }\n    }\n    \n    return true;\n}\n\n/**\n * Validate FEN string format with comprehensive checks\n * @param {string} fen - FEN string\n * @returns {Object} Validation result with success and error properties\n */\nexport function validateFenFormat(fen) {\n    if (typeof fen !== 'string') {\n        return { success: false, error: 'FEN must be a string' };\n    }\n    \n    const cacheKey = `fen:${fen}`;\n    if (validationCache.has(cacheKey)) {\n        return validationCache.get(cacheKey);\n    }\n    \n    const parts = fen.trim().split(' ');\n    if (parts.length !== 6) {\n        const result = { success: false, error: 'FEN must have 6 parts separated by spaces' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate piece placement\n    const ranks = parts[0].split('/');\n    if (ranks.length !== 8) {\n        const result = { success: false, error: 'Piece placement must have 8 ranks' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate each rank\n    for (let i = 0; i < ranks.length; i++) {\n        const rankResult = validateRank(ranks[i]);\n        if (!rankResult.success) {\n            const result = { success: false, error: `Invalid rank ${i + 1}: ${rankResult.error}` };\n            cacheResult(cacheKey, result);\n            return result;\n        }\n    }\n    \n    // Validate active color\n    if (!['w', 'b'].includes(parts[1])) {\n        const result = { success: false, error: 'Active color must be \"w\" or \"b\"' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate castling availability\n    if (!/^[KQkq-]*$/.test(parts[2])) {\n        const result = { success: false, error: 'Invalid castling availability' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate en passant target square\n    if (parts[3] !== '-' && !isValidSquare(parts[3])) {\n        const result = { success: false, error: 'Invalid en passant target square' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate halfmove clock\n    const halfmove = parseInt(parts[4], 10);\n    if (isNaN(halfmove) || halfmove < 0) {\n        const result = { success: false, error: 'Invalid halfmove clock' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    // Validate fullmove number\n    const fullmove = parseInt(parts[5], 10);\n    if (isNaN(fullmove) || fullmove < 1) {\n        const result = { success: false, error: 'Invalid fullmove number' };\n        cacheResult(cacheKey, result);\n        return result;\n    }\n    \n    const result = { success: true };\n    cacheResult(cacheKey, result);\n    return result;\n}\n\n/**\n * Validates a single rank in FEN notation\n * @param {string} rank - Rank string\n * @returns {Object} Validation result\n */\nfunction validateRank(rank) {\n    if (typeof rank !== 'string') {\n        return { success: false, error: 'Rank must be a string' };\n    }\n    \n    let squareCount = 0;\n    \n    for (let i = 0; i < rank.length; i++) {\n        const char = rank[i];\n        \n        if (/[1-8]/.test(char)) {\n            squareCount += parseInt(char, 10);\n        } else if (/[prnbqkPRNBQK]/.test(char)) {\n            squareCount += 1;\n        } else {\n            return { success: false, error: `Invalid character \"${char}\" in rank` };\n        }\n    }\n    \n    if (squareCount !== 8) {\n        return { success: false, error: `Rank must represent exactly 8 squares, got ${squareCount}` };\n    }\n    \n    return { success: true };\n}\n\n/**\n * Validate move notation in various formats\n * @param {string} move - Move string (e.g., 'e2e4', 'Nf3', 'O-O')\n * @returns {Object} Validation result\n */\nexport function validateMove(move) {\n    if (typeof move !== 'string') {\n        return { success: false, error: 'Move must be a string' };\n    }\n    \n    const trimmed = move.trim();\n    if (trimmed.length === 0) {\n        return { success: false, error: 'Move cannot be empty' };\n    }\n    \n    // Check for castling\n    if (trimmed === 'O-O' || trimmed === 'O-O-O') {\n        return { success: true, type: 'castling' };\n    }\n    \n    // Check for coordinate notation (e.g., e2e4, e7e8q)\n    if (/^[a-h][1-8][a-h][1-8][qrnbQRNB]?$/.test(trimmed)) {\n        return { success: true, type: 'coordinate' };\n    }\n    \n    // Check for algebraic notation (e.g., Nf3, Qxd5, e4)\n    if (/^[PRNBQK]?[a-h]?[1-8]?x?[a-h][1-8](\\+|#)?$/.test(trimmed)) {\n        return { success: true, type: 'algebraic' };\n    }\n    \n    return { success: false, error: 'Invalid move format' };\n}\n\n/**\n * Validate configuration object with detailed error reporting\n * @param {Object} config - Configuration object\n * @returns {Object} Validation result with success and errors array\n */\nexport function validateConfig(config) {\n    const errors = [];\n    \n    if (!config || typeof config !== 'object') {\n        return { success: false, errors: ['Configuration must be an object'] };\n    }\n    \n    // Required fields\n    if (!config.id && !config.id_div) {\n        errors.push('Configuration must include \"id\" or \"id_div\"');\n    }\n    \n    // Optional field validation\n    if (config.orientation && !['white', 'black', 'w', 'b'].includes(config.orientation)) {\n        errors.push('Invalid orientation. Must be \"white\", \"black\", \"w\", or \"b\"');\n    }\n    \n    if (config.position && config.position !== 'start' && typeof config.position !== 'object') {\n        errors.push('Invalid position. Must be \"start\" or a position object');\n    }\n    \n    if (config.position && typeof config.position === 'object' && !isValidPosition(config.position)) {\n        errors.push('Invalid position object format');\n    }\n    \n    if (config.size && !isValidSize(config.size)) {\n        errors.push('Invalid size. Must be \"auto\", a positive number, or a valid CSS size');\n    }\n    \n    if (config.movableColors && !['white', 'black', 'w', 'b', 'both', 'none'].includes(config.movableColors)) {\n        errors.push('Invalid movableColors. Must be \"white\", \"black\", \"w\", \"b\", \"both\", or \"none\"');\n    }\n    \n    if (config.dropOffBoard && !['snapback', 'trash'].includes(config.dropOffBoard)) {\n        errors.push('Invalid dropOffBoard. Must be \"snapback\" or \"trash\"');\n    }\n    \n    // Validate callback functions\n    const callbacks = ['onMove', 'onMoveEnd', 'onChange', 'onDragStart', 'onDragMove', 'onDrop', 'onSnapbackEnd'];\n    for (const callback of callbacks) {\n        if (config[callback] && typeof config[callback] !== 'function') {\n            errors.push(`Invalid ${callback}. Must be a function`);\n        }\n    }\n    \n    // Validate color values\n    const colorFields = ['whiteSquare', 'blackSquare', 'highlight', 'hintColor'];\n    for (const field of colorFields) {\n        if (config[field] && !isValidColor(config[field])) {\n            errors.push(`Invalid ${field}. Must be a valid CSS color`);\n        }\n    }\n    \n    // Validate animation settings\n    if (config.moveAnimation && !isValidEasing(config.moveAnimation)) {\n        errors.push('Invalid moveAnimation. Must be a valid easing function');\n    }\n    \n    if (config.animationStyle && !['sequential', 'simultaneous'].includes(config.animationStyle)) {\n        errors.push('Invalid animationStyle. Must be \"sequential\" or \"simultaneous\"');\n    }\n    \n    return {\n        success: errors.length === 0,\n        errors\n    };\n}\n\n/**\n * Validates size value\n * @param {number|string} size - Size value\n * @returns {boolean} True if valid\n */\nfunction isValidSize(size) {\n    if (size === 'auto') {\n        return true;\n    }\n    \n    if (typeof size === 'number') {\n        return size > 0 && size <= 5000; // Reasonable upper limit\n    }\n    \n    if (typeof size === 'string') {\n        // Check for CSS size values\n        return /^\\d+(px|em|rem|%|vh|vw)$/.test(size);\n    }\n    \n    return false;\n}\n\n/**\n * Validates CSS color value\n * @param {string} color - Color value\n * @returns {boolean} True if valid\n */\nfunction isValidColor(color) {\n    if (typeof color !== 'string') {\n        return false;\n    }\n    \n    // Hex colors\n    if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color)) {\n        return true;\n    }\n    \n    // RGB/RGBA\n    if (/^rgba?\\(\\s*\\d+\\s*,\\s*\\d+\\s*,\\s*\\d+\\s*(,\\s*[0-1](\\.\\d+)?)?\\s*\\)$/.test(color)) {\n        return true;\n    }\n    \n    // HSL/HSLA\n    if (/^hsla?\\(\\s*\\d+\\s*,\\s*\\d+%\\s*,\\s*\\d+%\\s*(,\\s*[0-1](\\.\\d+)?)?\\s*\\)$/.test(color)) {\n        return true;\n    }\n    \n    // Named colors (basic set)\n    const namedColors = [\n        'white', 'black', 'red', 'green', 'blue', 'yellow', 'cyan', 'magenta',\n        'transparent', 'gray', 'grey', 'brown', 'orange', 'purple', 'pink'\n    ];\n    \n    return namedColors.includes(color.toLowerCase());\n}\n\n/**\n * Validates easing function\n * @param {string} easing - Easing function name\n * @returns {boolean} True if valid\n */\nfunction isValidEasing(easing) {\n    const validEasing = [\n        'linear', 'ease', 'ease-in', 'ease-out', 'ease-in-out',\n        'cubic-bezier'\n    ];\n    \n    return validEasing.includes(easing) || \n           /^cubic-bezier\\(\\s*[\\d.-]+\\s*,\\s*[\\d.-]+\\s*,\\s*[\\d.-]+\\s*,\\s*[\\d.-]+\\s*\\)$/.test(easing);\n}\n\n/**\n * Batch validates multiple items\n * @param {Array} items - Array of validation items\n * @returns {Array} Array of validation results\n */\nexport function batchValidate(items) {\n    return items.map(item => {\n        const { type, value } = item;\n        \n        switch (type) {\n            case 'piece':\n                return { ...item, valid: isValidPiece(value) };\n            case 'square':\n                return { ...item, valid: isValidSquare(value) };\n            case 'position':\n                return { ...item, valid: isValidPosition(value) };\n            case 'fen':\n                const fenResult = validateFenFormat(value);\n                return { ...item, valid: fenResult.success, error: fenResult.error };\n            case 'move':\n                const moveResult = validateMove(value);\n                return { ...item, valid: moveResult.success, error: moveResult.error };\n            case 'config':\n                const configResult = validateConfig(value);\n                return { ...item, valid: configResult.success, errors: configResult.errors };\n            default:\n                return { ...item, valid: false, error: 'Unknown validation type' };\n        }\n    });\n}\n\n/**\n * Clears validation cache\n */\nexport function clearValidationCache() {\n    validationCache.clear();\n}\n\n/**\n * Gets validation cache statistics\n * @returns {Object} Cache statistics\n */\nexport function getValidationCacheStats() {\n    return {\n        size: validationCache.size,\n        maxSize: CACHE_MAX_SIZE\n    };\n}\n","/**\n * Animation utilities for Chessboard.js\n */\n\n/**\n * Get the CSS transition duration in milliseconds\n * @param {string|number} time - Time value ('fast', 'slow', or number in ms)\n * @returns {number} Duration in milliseconds\n */\nexport function parseTime(time) {\n  if (typeof time === 'number') return time;\n  \n  switch (time) {\n    case 'fast': return 150;\n    case 'slow': return 500;\n    default: return 200;\n  }\n}\n\n/**\n * Get the CSS transition function\n * @param {string} animation - Animation type ('ease', 'linear', etc.)\n * @returns {string} CSS transition function\n */\nexport function parseAnimation(animation) {\n  const validAnimations = ['ease', 'ease-in', 'ease-out', 'ease-in-out', 'linear'];\n  return validAnimations.includes(animation) ? animation : 'ease';\n}\n\n/**\n * Create a promise that resolves after animation completion\n * @param {number} duration - Duration in milliseconds\n * @returns {Promise} Promise that resolves after the duration\n */\nexport function animationPromise(duration) {\n  return new Promise(resolve => setTimeout(resolve, duration));\n}\n","/**\n * Chessboard.js - A beautiful, customizable chessboard widget\n * Main entry point for the library\n * \n * @version 2.2.1\n * @author alepot55\n * @license ISC\n */\n\n// Core components\nexport { \n    Chessboard, \n    ChessboardConfig, \n    ChessboardFactory,\n    chessboardFactory,\n    createChessboard,\n    createChessboardFromTemplate \n} from './core/index.js';\n\n// Component exports\nexport { default as Square } from './components/Square.js';\nexport { default as Piece } from './components/Piece.js';\nexport { default as Move } from './components/Move.js';\n\n// Service exports for advanced usage\nexport { \n    AnimationService,\n    BoardService,\n    CoordinateService,\n    EventService,\n    MoveService,\n    PieceService,\n    PositionService,\n    ValidationService\n} from './services/index.js';\n\n// Constants exports\nexport * from './constants/index.js';\n\n// Error handling exports\nexport { \n    ChessboardError, \n    ValidationError, \n    ConfigurationError,\n    MoveError,\n    DOMError,\n    PieceError\n} from './errors/index.js';\n\n// Utility exports\nexport { Chess, validateFen } from './utils/chess.js';\nexport { \n    PerformanceMonitor,\n    throttle,\n    debounce,\n    rafThrottle,\n    setTransform,\n    resetTransform,\n    batchDOMOperations,\n    isElementVisible,\n    getMemoryUsage\n} from './utils/performance.js';\nexport * from './utils/coordinates.js';\nexport { \n    isValidPiece,\n    isValidPosition,\n    validateFenFormat,\n    validateMove,\n    validateConfig,\n    batchValidate,\n    clearValidationCache,\n    getValidationCacheStats\n} from './utils/validation.js';\nexport * from './utils/animations.js';\n\n// Logging system exports\nexport { \n    Logger,\n    logger,\n    createLogger,\n    LOG_LEVELS\n} from './utils/logger.js';\n\n// Default export for IIFE compatibility\nimport { Chessboard as ChessboardClass } from './core/index.js';\nexport default ChessboardClass;\n\n// Version information\nexport const version = '2.2.1';\nexport const build = process.env.BUILD_NUMBER || 'dev';\nexport const buildDate = process.env.BUILD_DATE || new Date().toISOString();\n\n// Library information\nexport const info = {\n    name: 'Chessboard.js',\n    version,\n    build,\n    buildDate,\n    author: 'alepot55',\n    license: 'ISC',\n    repository: 'https://github.com/alepot55/Chessboardjs',\n    homepage: 'https://chessboardjs.com'\n};\n"],"names":["STANDARD_POSITIONS","DEFAULT_STARTING_POSITION","PIECE_TYPES","PIECE_COLORS","PROMOTION_PIECES","BOARD_LETTERS","BOARD_SIZE","ERROR_CODES","ERROR_MESSAGES","ERROR_SEVERITY","ChessboardError","message","code","context","ValidationError","field","value","ConfigurationError","configKey","configValue","MoveError","from","to","piece","DOMError","elementId","PieceError","pieceId","square","VALIDATION_PATTERNS","VALID_VALUES","SIZE_CONSTRAINTS","ValidationService","cacheKey","isValid","first","second","format1","format2","fen","parts","ranks","rank","halfmove","fullmove","squares","char","move","promotion","orientation","color","size","time","callback","id","colors","dropOff","easing","style","config","errors","callbacks","colorFields","key","result","firstKey","validations","validation","type","error","ANIMATION_TIMES","BOOLEAN_VALUES","TRANSITION_FUNCTIONS","DEFAULT_CONFIG","ChessboardConfig","settings","cssProperties","property","delay","validatedOrientation","updates","newConfig","Piece","src","opacity","element","newSrc","newType","duration","scaleDown","scaleUp","halfDuration","scaleDownAnimation","scaleUpAnimation","speed","transition_f","start","fade","elapsed","f","e","sourceRect","targetRect","x_start","y_start","x_end","y_end","dx","dy","keyframes","animation","Square","row","col","preserve","newPiece","event","catchable","hint","cover","choice","img","Move$1","check","game","AnimationService","x","properties","animationId","timingFunction","startTime","startValues","prop","animate","currentTime","progress","easedProgress","startValue","endValue","currentValue","end","BoardService","coordConverter","squareRow","squareCol","offsetWidth","offsetHeight","squareId","methodName","args","CoordinateService","realRow","realCol","letter","number","boardCol","y","boardElement","rect","width","height","squareWidth","squareHeight","coords","fromSquare","toSquare","fromRow","fromCol","toRow","toCol","rowDiff","colDiff","normalizedOrientation","file","PerformanceMonitor","paintObserver","list","entry","name","measure","metric","summary","values","percentile","sorted","a","b","index","observer","throttle","func","limit","inThrottle","debounce","timeoutId","rafThrottle","isThrottled","setTransform","scale","resetTransform","batchDOMOperations","resolve","isElementVisible","getMemoryUsage","getBrowserInfo","ua","isChrome","isFirefox","isSafari","isEdge","DragOptimizations","browserInfo","LOG_LEVELS","COLORS","Logger","level","data","reset","timestamp","consoleMethod","stored","perf","measurements","total","sum","m","avg","min","max","namespace","logger","createLogger","EventService","boardService","moveService","coordinateService","chessboard","onSquareClick","onPieceHover","onPieceLeave","listeners","throttledHover","throttledLeave","handleClick","onDragStart","onDragMove","onDrop","onSnapback","onMove","onRemove","_a","_b","originalFrom","isDragging","previousHighlight","startX","startY","moveAt","squareSize","clientX","clientY","boardRect","onMouseMove","currentX","currentY","deltaX","deltaY","computedStyle","currentWidth","currentHeight","newTo","onMouseUp","dropResult","cleanup","Move","selectedPromotion","targetSquare","onSelect","onDeselect","dragged","_c","promotionPiece","attempt","gamePiece","currentPiece","piecePath","dragFunction","isAnimating","handler","MoveService","positionService","movableColors","onlyLegalMoves","fromId","toId","legalMove","verbose","options","moves","moveOptions","pieceOnDestination","moveKey","stack","now","targetRank","matchingMove","requiresPromotion","fromRank","toRank","fromFile","toFile","direction","rankDiff","fileDiff","onPromotionSelect","onPromotionCancel","pieceType","choiceSquare","baseRow","piecesPath","moveString","gameMove","isKingSide","isWhite","PieceService","removeTarget","changeSquareCallback","WHITE","BLACK","PAWN","KNIGHT","BISHOP","ROOK","QUEEN","KING","DEFAULT_POSITION","chess","internal","__publicField","flags","captured","fromAlgebraic","algebraic","toAlgebraic","flag","BITS","FLAGS","EMPTY","Ox88","PAWN_OFFSETS","PIECE_OFFSETS","ATTACKS","RAYS","PIECE_MASKS","SYMBOLS","PROMOTIONS","RANK_1","RANK_2","RANK_7","RANK_8","SIDES","ROOKS","SECOND_RANK","TERMINATION_MARKERS","isDigit","c","r","swapColor","validateFen","tokens","moveNumber","halfMoves","rows","i","sumFields","previousWasNumber","k","kings","regex","getDisambiguator","ambiguities","sameRank","sameFile","len","ambigFrom","ambigTo","ambigPiece","addMove","inferPieceType","san","strippedSan","trimFen","Chess","preserveHeaders","skipValidation","adjustments","ok","position","empty","castling","epSquare","bigPawnSquare","isLegal","sq","currentPieceOnSquare","_d","_e","_f","_g","_h","_i","_j","_k","_l","whiteKingInPlace","blackKingInPlace","startSquare","currentSquare","attackers","canCapture","difference","offset","j","blocked","attackedBy","pieces","bishops","numPieces","squareColor","legal","forSquare","forPiece","us","them","firstSquare","lastSquare","singleSquare","castlingFrom","castlingTo","legalMoves","strict","moveObj","prettyMove","old","newline","maxWidth","headerExists","appendComment","comment","delimiter","reversedHistory","prefix","strip","wrapComment","token","pgn","newlineChar","mask","str","parsePgnHeader","header","headerObj","headers","headerRegexResults","headerString","toHex","s","fromHex","encodeComment","decodeComment","ms","_match","bracket","semicolon","ravRegex","halfMove","output","disambiguator","cleanMove","matches","overlyDisambiguated","symbol","depth","nodes","moveHistory","trimmedFen","currentComments","copyComment","rights","side","PositionService","rowParts","fenPiece","Chessboard$1","boardContainer","hasEnemyPiece","isCastle","isEnPassant","rookMove","rookFromSquare","rookToSquare","rookPiece","capturedSquare","capturedSquareObj","isPositionLoad","gameStateBefore","expectedMap","expectedPieceId","currentPieceId","gameStateAfter","currentMap","animationsCompleted","totalAnimations","animationDelay","animationIndex","onAnimationComplete","fromList","toList","distances","fromMatched","toMatched","minDist","minI","minJ","currentPieces","expectedPieces","removes","adds","unchanged","processedSquares","availableDestination","expectedId","changeAnalysis","remove","add","onComplete","opts","startPosition","undone","pieceStr","types","validSquare","validPiece","pieceObj","squareObj","chessJsPiece","newPosition","success","positionArg","colorOrAnimate","parsePieceString","ChessboardFactory","containerId","template","container","finalConfig","templateConfig","Chessboard","templateName","overrides","instance","containerIds","destroyed","removed","configurations","instances","chessboardFactory","createChessboard","createChessboardFromTemplate","containerElm","factoryLogger","ChessboardClass","fullConfig","ChessboardWrapper","instanceLogger","algebraicToCoords","coordsToAlgebraic","getSquareColor","isValidCoords","isValidSquare","validationCache","CACHE_MAX_SIZE","cacheResult","isValidPiece","isValidPosition","isValidChessPosition","whiteKings","p","blackKings","whitePawns","blackPawns","validateFenFormat","rankResult","validateRank","squareCount","validateMove","trimmed","validateConfig","isValidSize","isValidColor","isValidEasing","batchValidate","items","item","fenResult","moveResult","configResult","clearValidationCache","getValidationCacheStats","parseTime","parseAnimation","animationPromise","version","build","buildDate","info"],"mappings":"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AG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAC3D;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAChD;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAChD,GAEMC,KAAO;AAAA,EACT;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAChD;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAChD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EAAI;AAAA,EACpD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAK;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EACnD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EACnD;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAK;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG;AAAA,EAAG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"}